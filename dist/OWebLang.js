import Utils from "./utils/Utils";
import OWebEvent from "./OWebEvent";
const LANG_PORTION_COPY_REG = /{{\s*([A-Z][A-Z0-9_]+)\s*}}/g, // for {{LANG_KEY}}
LANG_REPLACE_REG = /{\s*(?:([a-zA-Z_]+):)?([a-zA-Z0-9_]+)\s*}/g, // for {variable} and {fn:variable}
LANG_VALUE_TAG_REG = /(INPUT|TEXTAREA)/i;
let LANG_OBJECT = {}, LANG_PLUGINS = {}, LANG_FORMATS_FN_LIST = {
    "file_size": function (o) {
        return Utils.fileSizeFormat(Number(o.args[0]));
    }
};
const runPlugins = (app_context, plugins, data, langCode) => {
    let len = plugins.length;
    for (let i = 0; i < len; i++) {
        let plugin = plugins[i], fn = LANG_PLUGINS[plugin];
        if (fn) {
            data = fn({
                context: app_context,
                data,
                langCode
            });
        }
        else {
            console.error(`[OWebLang] undefined plugins "${plugin}".`);
        }
    }
    return data;
}, runReplace = (app_context, text, data, langCode) => {
    let fnExec = function (name, value, langCode) {
        let fn = LANG_FORMATS_FN_LIST[name];
        if (typeof fn === "function") {
            return fn({
                context: app_context,
                args: [value],
                langCode
            });
        }
        return value;
    };
    text = text.replace(LANG_REPLACE_REG, (text, fn, variable) => {
        let value = (data || {})[variable];
        if (fn) {
            value = fnExec(fn, value, langCode);
        }
        return value;
    });
    return text;
}, translate = function (app_context, langKey, langData, langCode) {
    if (!LANG_OBJECT[langKey]) {
        throw new Error(`[OWebLang] undefined language data for: ${langCode}`);
    }
    let data = langData || {}, text = OWebLang.getLangText(langKey, langCode);
    if (data["olangPlugins"]) {
        let plugins = data["olangPlugins"].split("|");
        data = runPlugins(app_context, plugins, data, langCode);
    }
    if (text !== undefined) {
        if (LANG_REPLACE_REG.test(text)) {
            text = runReplace(app_context, text, data, langCode);
        }
        return text;
    }
    return langKey;
}, portionReplacer = function (text, langCode) {
    if (LANG_PORTION_COPY_REG.test(text)) {
        text = text.replace(LANG_PORTION_COPY_REG, function (text, p) {
            return OWebLang.getLangText(p, langCode);
        });
    }
    return text;
};
export default class OWebLang extends OWebEvent {
    /**
     * @param app_context The app context.
     */
    constructor(app_context) {
        super();
        this.app_context = app_context;
        this.defaultLangCode = "en";
    }
    /**
     * Set default i18n lang code.
     *
     * @param langCode The i18n lang code.
     */
    setDefaultLang(langCode) {
        if (!LANG_OBJECT[langCode]) {
            throw new Error(`[OWebLang] can't set default language, undefined language data for: ${langCode}.`);
        }
        if (this.defaultLangCode !== langCode) {
            this.defaultLangCode = langCode;
        }
        return this;
    }
    /**
     * Returns i18n translation.
     *
     * @param langKey The i18n string key.
     * @param langData The data to inject in translation process.
     * @param langCode The i18n lang code to use.
     */
    toHuman(langKey, langData = {}, langCode = this.defaultLangCode) {
        return translate(this.app_context, langKey, langData, langCode);
    }
    /**
     * Update an element content/placeholder/title.
     *
     * @param el The element to update.
     * @param data The data to inject in i18n translation process.
     */
    updateElement(el, data) {
        let translatedText = null, contentKey = data.olang, contentData = data.olangData || data, titleKey = data.olangTitle, titleData = data.olangTitleData || data.olangData || data, placeholderKey = data.olangPlaceholder, placeholderData = data.olangPlaceholderData || data.olangData || data, langCode = data.olangCode || this.defaultLangCode, tag = el.nodeName;
        if (contentKey !== undefined) {
            translatedText = translate(this.app_context, contentKey, contentData, langCode);
            if (!LANG_VALUE_TAG_REG.test(tag)) {
                el.innerHTML = translatedText;
            }
            else {
                el.setAttribute("value", translatedText);
            }
        }
        if (titleKey !== undefined) {
            el.setAttribute("title", translate(this.app_context, titleKey, titleData, langCode));
        }
        if (placeholderKey !== undefined) {
            el.setAttribute("placeholder", translate(this.app_context, placeholderKey, placeholderData, langCode));
        }
        return this;
    }
    /**
     * Sets the i18n lang data.
     *
     * @param langCode The i18n lang code
     * @param data The i18n lang data.
     */
    static setLangData(langCode, data) {
        if (!Utils.isString(langCode)) {
            throw new TypeError("[OWebLang] your lang name should be a valid string.");
        }
        if (!Utils.isPlainObject(data)) {
            throw new TypeError("[OWebLang] your lang data should be a valid plain object.");
        }
        LANG_OBJECT[langCode] = Utils.assign(LANG_OBJECT[langCode] || {}, data);
        return this;
    }
    /**
     * Returns the i18n string.
     *
     * @param textKey The i18n text key.
     * @param langCode The i18n lang code
     */
    static getLangText(textKey, langCode) {
        if (LANG_OBJECT[langCode]) {
            return portionReplacer(LANG_OBJECT[langCode][textKey], langCode);
        }
        else {
            return undefined;
        }
    }
    /**
     * Adds plugin.
     *
     * @param name The plugin name.
     * @param fn The plugin function.
     */
    static addPlugin(name, fn) {
        if (LANG_PLUGINS[name]) {
            throw new Error(`[OWebLang] plugin '${name}' already defined.`);
        }
        LANG_PLUGINS[name] = fn;
        return this;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkxhbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYkxhbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLE1BQU0sZUFBZSxDQUFDO0FBQ2xDLE9BQU8sU0FBUyxNQUFNLGFBQWEsQ0FBQztBQVVwQyxNQUNDLHFCQUFxQixHQUFHLDhCQUE4QixFQUFFLG1CQUFtQjtBQUMzRSxnQkFBZ0IsR0FBUSw0Q0FBNEMsRUFBQyxtQ0FBbUM7QUFDeEcsa0JBQWtCLEdBQU0sbUJBQW1CLENBQUM7QUFFN0MsSUFBSSxXQUFXLEdBQWlELEVBQUUsRUFDakUsWUFBWSxHQUFnRCxFQUFFLEVBQzlELG9CQUFvQixHQUF3QztJQUMzRCxXQUFXLEVBQUUsVUFBVSxDQUFDO1FBQ3ZCLE9BQU8sS0FBSyxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDaEQsQ0FBQztDQUNELENBQUM7QUFFSCxNQUFNLFVBQVUsR0FBUSxDQUFDLFdBQW9CLEVBQUUsT0FBZSxFQUFFLElBQXFCLEVBQUUsUUFBZ0IsRUFBTyxFQUFFO0lBQzVHLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7SUFDekIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUM3QixJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQ3RCLEVBQUUsR0FBTyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFL0IsSUFBSSxFQUFFLEVBQUU7WUFDUCxJQUFJLEdBQUcsRUFBRSxDQUFDO2dCQUNULE9BQU8sRUFBRSxXQUFXO2dCQUNwQixJQUFJO2dCQUNKLFFBQVE7YUFDUixDQUFDLENBQUM7U0FDSDthQUFNO1lBQ04sT0FBTyxDQUFDLEtBQUssQ0FBQyxpQ0FBaUMsTUFBTSxJQUFJ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TSxDQUFDLFdBQVcsQ0FBQyxPQUFlLEVBQUUsUUFBZ0I7UUFDbkQsSUFBSSxXQUFXLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDMUIsT0FBTyxlQUFlLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1NBQ2pFO2FBQU07WUFDTixPQUFPLFNBQVMsQ0FBQztTQUNqQjtJQUNGLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBWSxFQUFFLEVBQWlCO1FBQy9DLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3ZCLE1BQU0sSUFBSSxLQUFLLENBQUMsc0JBQXNCLElBQUksb0JBQW9CLENBQUMsQ0FBQztTQUNoRTtRQUVELFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFeEIsT0FBTyxJQUFJLENBQUM7SUFDYixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgVXRpbHMgZnJvbSBcIi4vdXRpbHMvVXRpbHNcIjtcbmltcG9ydCBPV2ViRXZlbnQgZnJvbSBcIi4vT1dlYkV2ZW50XCI7XG5pbXBvcnQgT1dlYkFwcCBmcm9tIFwiLi9PV2ViQXBwXCI7XG5cbmV4cG9ydCB0eXBlIHRMYW5nSW5qZWN0RGF0YSA9IHsgW2tleTogc3RyaW5nXTogYW55IH07XG5leHBvcnQgdHlwZSB0TGFuZ0RlZmluaXRpb24gPSB7IFtrZXk6IHN0cmluZ106IGFueSB9O1xuZXhwb3J0IHR5cGUgdExhbmdQbHVnaW5BcmdzID0geyBjb250ZXh0OiBPV2ViQXBwLCBkYXRhOiB0TGFuZ0luamVjdERhdGEsIGxhbmdDb2RlOiBzdHJpbmcgfTtcbmV4cG9ydCB0eXBlIHRMYW5nUGx1Z2luRm4gPSAobzogdExhbmdQbHVnaW5BcmdzKSA9PiB0TGFuZ0luamVjdERhdGE7XG5leHBvcnQgdHlwZSB0TGFuZ0Zvcm1hdHRlckFyZ3MgPSB7IGNvbnRleHQ6IE9XZWJBcHAsIGFyZ3M6IHN0cmluZ1tdLCBsYW5nQ29kZTogc3RyaW5nIH07XG5leHBvcnQgdHlwZSB0TGFuZ0Zvcm1hdHRlckZuID0gKG86IHRMYW5nRm9ybWF0dGVyQXJncykgPT4gc3RyaW5nO1xuXG5jb25zdFxuXHRMQU5HX1BPUlRJT05fQ09QWV9SRUcgPSAve3tcXHMqKFtBLVpdW0EtWjAtOV9dKylcXHMqfX0vZywgLy8gZm9yIHt7TEFOR19LRVl9fVxuXHRMQU5HX1JFUExBQ0VfUkVHICAgICAgPSAve1xccyooPzooW2EtekEtWl9dKyk6KT8oW2EtekEtWjAtOV9dKylcXHMqfS9nLC8vIGZvciB7dmFyaWFibGV9IGFuZCB7Zm46dmFyaWFibGV9XG5cdExBTkdfVkFMVUVfVEFHX1JFRyAgICA9IC8oSU5QVVR8VEVYVEFSRUEpL2k7XG5cbmxldCBMQU5HX09CSkVDVDogeyBba2V5OiBzdHJpbmddOiB0TGFuZ0RlZmluaXRpb24gfSAgICAgICAgICAgPSB7fSxcblx0TEFOR19QTFVHSU5TOiB7IFtrZXk6IHN0cmluZ106IHRMYW5nUGx1Z2luRm4gfSAgICAgICAgICAgID0ge30sXG5cdExBTkdfRk9STUFUU19GTl9MSVNUOiB7IFtrZXk6IHN0cmluZ106IHRMYW5nRm9ybWF0dGVyRm4gfSA9IHtcblx0XHRcImZpbGVfc2l6ZVwiOiBmdW5jdGlvbiAobykge1xuXHRcdFx0cmV0dXJuIFV0aWxzLmZpbGVTaXplRm9ybWF0KE51bWJlcihvLmFyZ3NbMF0pKTtcblx0XHR9XG5cdH07XG5cbmNvbnN0IHJ1blBsdWdpbnMgICAgICA9IChhcHBfY29udGV4dDogT1dlYkFwcCwgcGx1Z2luczogc3RyaW5nLCBkYXRhOiB0TGFuZ0luamVjdERhdGEsIGxhbmdDb2RlOiBzdHJpbmcpOiBhbnkgPT4ge1xuXHRcdCAgbGV0IGxlbiA9IHBsdWdpbnMubGVuZ3RoO1xuXHRcdCAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykge1xuXHRcdFx0ICBsZXQgcGx1Z2luID0gcGx1Z2luc1tpXSxcblx0XHRcdFx0ICBmbiAgICAgPSBMQU5HX1BMVUdJTlNbcGx1Z2luXTtcblxuXHRcdFx0ICBpZiAoZm4pIHtcblx0XHRcdFx0ICBkYXRhID0gZm4oe1xuXHRcdFx0XHRcdCAgY29udGV4dDogYXBwX2NvbnRleHQsXG5cdFx0XHRcdFx0ICBkYXRhLFxuXHRcdFx0XHRcdCAgbGFuZ0NvZGVcblx0XHRcdFx0ICB9KTtcblx0XHRcdCAgfSBlbHNlIHtcblx0XHRcdFx0ICBjb25zb2xlLmVycm9yKGBbT1dlYkxhbmddIHVuZGVmaW5lZCBwbHVnaW5zIFwiJHtwbHVnaW59XCIuYCk7XG5cdFx0XHQgIH1cblx0XHQgIH1cblxuXHRcdCAgcmV0dXJuIGRhdGE7XG5cdCAgfSxcblx0ICBydW5SZXBsYWNlICAgICAgPSAoYXBwX2NvbnRleHQ6IE9XZWJBcHAsIHRleHQ6IHN0cmluZywgZGF0YTogYW55LCBsYW5nQ29kZTogc3RyaW5nKTogc3RyaW5nID0+IHtcblxuXHRcdCAgbGV0IGZuRXhlYyA9IGZ1bmN0aW9uIChuYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnksIGxhbmdDb2RlOiBzdHJpbmcpIHtcblx0XHRcdCAgbGV0IGZuID0gTEFOR19GT1JNQVRTX0ZOX0xJU1RbbmFtZV07XG5cblx0XHRcdCAgaWYgKHR5cGVvZiBmbiA9PT0gXCJmdW5jdGlvblwiKSB7XG5cdFx0XHRcdCAgcmV0dXJuIGZuKHtcblx0XHRcdFx0XHQgIGNvbnRleHQ6IGFwcF9jb250ZXh0LFxuXHRcdFx0XHRcdCAgYXJncyAgIDogW3ZhbHVlXSxcblx0XHRcdFx0XHQgIGxhbmdDb2RlXG5cdFx0XHRcdCAgfSk7XG5cdFx0XHQgIH1cblxuXHRcdFx0ICByZXR1cm4gdmFsdWU7XG5cdFx0ICB9O1xuXG5cdFx0ICB0ZXh0ID0gdGV4dC5yZXBsYWNlKExBTkdfUkVQTEFDRV9SRUcsICh0ZXh0LCBmbiwgdmFyaWFibGUpID0+IHtcblx0XHRcdCAgbGV0IHZhbHVlID0gKGRhdGEgfHwge30pW3ZhcmlhYmxlXTtcblxuXHRcdFx0ICBpZiAoZm4pIHtcblx0XHRcdFx0ICB2YWx1ZSA9IGZuRXhlYyhmbiwgdmFsdWUsIGxhbmdDb2RlKTtcblx0XHRcdCAgfVxuXG5cdFx0XHQgIHJldHVybiB2YWx1ZTtcblx0XHQgIH0pO1xuXG5cdFx0ICByZXR1cm4gdGV4dDtcblx0ICB9LFxuXHQgIHRyYW5zbGF0ZSAgICAgICA9IGZ1bmN0aW9uIChhcHBfY29udGV4dDogT1dlYkFwcCwgbGFuZ0tleTogc3RyaW5nLCBsYW5nRGF0YTogdExhbmdJbmplY3REYXRhLCBsYW5nQ29kZTogc3RyaW5nKTogc3RyaW5nIHtcblxuXHRcdCAgaWYgKCFMQU5HX09CSkVDVFtsYW5nS2V5XSkge1xuXHRcdFx0ICB0aHJvdyBuZXcgRXJyb3IoYFtPV2ViTGFuZ10gdW5kZWZpbmVkIGxhbmd1YWdlIGRhdGEgZm9yOiAke2xhbmdDb2RlfWApO1xuXHRcdCAgfVxuXG5cdFx0ICBsZXQgZGF0YSA9IGxhbmdEYXRhIHx8IHt9LFxuXHRcdFx0ICB0ZXh0ID0gT1dlYkxhbmcuZ2V0TGFuZ1RleHQobGFuZ0tleSwgbGFuZ0NvZGUpO1xuXG5cdFx0ICBpZiAoZGF0YVtcIm9sYW5nUGx1Z2luc1wiXSkge1xuXHRcdFx0ICBsZXQgcGx1Z2lucyA9IGRhdGFbXCJvbGFuZ1BsdWdpbnNcIl0uc3BsaXQoXCJ8XCIpO1xuXHRcdFx0ICBkYXRhICAgICAgICA9IHJ1blBsdWdpbnMoYXBwX2NvbnRleHQsIHBsdWdpbnMsIGRhdGEsIGxhbmdDb2RlKTtcblx0XHQgIH1cblxuXHRcdCAgaWYgKHRleHQgIT09IHVuZGVmaW5lZCkge1xuXG5cdFx0XHQgIGlmIChMQU5HX1JFUExBQ0VfUkVHLnRlc3QodGV4dCkpIHtcblx0XHRcdFx0ICB0ZXh0ID0gcnVuUmVwbGFjZShhcHBfY29udGV4dCwgdGV4dCwgZGF0YSwgbGFuZ0NvZGUpO1xuXHRcdFx0ICB9XG5cblx0XHRcdCAgcmV0dXJuIHRleHQ7XG5cdFx0ICB9XG5cblx0XHQgIHJldHVybiBsYW5nS2V5O1xuXHQgIH0sXG5cdCAgcG9ydGlvblJlcGxhY2VyID0gZnVuY3Rpb24gKHRleHQ6IHN0cmluZywgbGFuZ0NvZGU6IHN0cmluZyk6IHN0cmluZyB7XG5cdFx0ICBpZiAoTEFOR19QT1JUSU9OX0NPUFlfUkVHLnRlc3QodGV4dCkpIHtcblx0XHRcdCAgdGV4dCA9IHRleHQucmVwbGFjZShMQU5HX1BPUlRJT05fQ09QWV9SRUcsIGZ1bmN0aW9uICh0ZXh0LCBwKSB7XG5cdFx0XHRcdCAgcmV0dXJuIE9XZWJMYW5nLmdldExhbmdUZXh0KHAsIGxhbmdDb2RlKTtcblx0XHRcdCAgfSk7XG5cdFx0ICB9XG5cblx0XHQgIHJldHVybiB0ZXh0O1xuXHQgIH07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJMYW5nIGV4dGVuZHMgT1dlYkV2ZW50IHtcblx0ZGVmYXVsdExhbmdDb2RlOiBzdHJpbmcgPSBcImVuXCI7XG5cblx0LyoqXG5cdCAqIEBwYXJhbSBhcHBfY29udGV4dCBUaGUgYXBwIGNvbnRleHQuXG5cdCAqL1xuXHRjb25zdHJ1Y3Rvcihwcml2YXRlIGFwcF9jb250ZXh0OiBPV2ViQXBwKSB7XG5cdFx0c3VwZXIoKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBTZXQgZGVmYXVsdCBpMThuIGxhbmcgY29kZS5cblx0ICpcblx0ICogQHBhcmFtIGxhbmdDb2RlIFRoZSBpMThuIGxhbmcgY29kZS5cblx0ICovXG5cdHNldERlZmF1bHRMYW5nKGxhbmdDb2RlOiBzdHJpbmcpIHtcblxuXHRcdGlmICghTEFOR19PQkpFQ1RbbGFuZ0NvZGVdKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYFtPV2ViTGFuZ10gY2FuJ3Qgc2V0IGRlZmF1bHQgbGFuZ3VhZ2UsIHVuZGVmaW5lZCBsYW5ndWFnZSBkYXRhIGZvcjogJHtsYW5nQ29kZX0uYClcblx0XHR9XG5cblx0XHRpZiAodGhpcy5kZWZhdWx0TGFuZ0NvZGUgIT09IGxhbmdDb2RlKSB7XG5cdFx0XHR0aGlzLmRlZmF1bHRMYW5nQ29kZSA9IGxhbmdDb2RlO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgaTE4biB0cmFuc2xhdGlvbi5cblx0ICpcblx0ICogQHBhcmFtIGxhbmdLZXkgVGhlIGkxOG4gc3RyaW5nIGtleS5cblx0ICogQHBhcmFtIGxhbmdEYXRhIFRoZSBkYXRhIHRvIGluamVjdCBpbiB0cmFuc2xhdGlvbiBwcm9jZXNzLlxuXHQgKiBAcGFyYW0gbGFuZ0NvZGUgVGhlIGkxOG4gbGFuZyBjb2RlIHRvIHVzZS5cblx0ICovXG5cdHRvSHVtYW4obGFuZ0tleTogc3RyaW5nLCBsYW5nRGF0YTogdExhbmdJbmplY3REYXRhID0ge30sIGxhbmdDb2RlOiBzdHJpbmcgPSB0aGlzLmRlZmF1bHRMYW5nQ29kZSk6IHN0cmluZyB7XG5cdFx0cmV0dXJuIHRyYW5zbGF0ZSh0aGlzLmFwcF9jb250ZXh0LCBsYW5nS2V5LCBsYW5nRGF0YSwgbGFuZ0NvZGUpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFVwZGF0ZSBhbiBlbGVtZW50IGNvbnRlbnQvcGxhY2Vob2xkZXIvdGl0bGUuXG5cdCAqXG5cdCAqIEBwYXJhbSBlbCBUaGUgZWxlbWVudCB0byB1cGRhdGUuXG5cdCAqIEBwYXJhbSBkYXRhIFRoZSBkYXRhIHRvIGluamVjdCBpbiBpMThuIHRyYW5zbGF0aW9uIHByb2Nlc3MuXG5cdCAqL1xuXHR1cGRhdGVFbGVtZW50KGVsOiBIVE1MRWxlbWVudCwgZGF0YTogdExhbmdJbmplY3REYXRhKTogdGhpcyB7XG5cdFx0bGV0IHRyYW5zbGF0ZWRUZXh0ICA9IG51bGwsXG5cdFx0XHRjb250ZW50S2V5ICAgICAgPSBkYXRhLm9sYW5nLFxuXHRcdFx0Y29udGVudERhdGEgICAgID0gZGF0YS5vbGFuZ0RhdGEgfHwgZGF0YSxcblx0XHRcdHRpdGxlS2V5ICAgICAgICA9IGRhdGEub2xhbmdUaXRsZSxcblx0XHRcdHRpdGxlRGF0YSAgICAgICA9IGRhdGEub2xhbmdUaXRsZURhdGEgfHwgZGF0YS5vbGFuZ0RhdGEgfHwgZGF0YSxcblx0XHRcdHBsYWNlaG9sZGVyS2V5ICA9IGRhdGEub2xhbmdQbGFjZWhvbGRlcixcblx0XHRcdHBsYWNlaG9sZGVyRGF0YSA9IGRhdGEub2xhbmdQbGFjZWhvbGRlckRhdGEgfHwgZGF0YS5vbGFuZ0RhdGEgfHwgZGF0YSxcblx0XHRcdGxhbmdDb2RlICAgICAgICA9IGRhdGEub2xhbmdDb2RlIHx8IHRoaXMuZGVmYXVsdExhbmdDb2RlLFxuXHRcdFx0dGFnICAgICAgICAgICAgID0gZWwubm9kZU5hbWU7XG5cblx0XHRpZiAoY29udGVudEtleSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHR0cmFuc2xhdGVkVGV4dCA9IHRyYW5zbGF0ZSh0aGlzLmFwcF9jb250ZXh0LCBjb250ZW50S2V5LCBjb250ZW50RGF0YSwgbGFuZ0NvZGUpO1xuXG5cdFx0XHRpZiAoIUxBTkdfVkFMVUVfVEFHX1JFRy50ZXN0KHRhZykpIHtcblx0XHRcdFx0ZWwuaW5uZXJIVE1MID0gdHJhbnNsYXRlZFRleHQ7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRlbC5zZXRBdHRyaWJ1dGUoXCJ2YWx1ZVwiLCB0cmFuc2xhdGVkVGV4dCk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0aWYgKHRpdGxlS2V5ICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdGVsLnNldEF0dHJpYnV0ZShcInRpdGxlXCIsIHRyYW5zbGF0ZSh0aGlzLmFwcF9jb250ZXh0LCB0aXRsZUtleSwgdGl0bGVEYXRhLCBsYW5nQ29kZSkpO1xuXHRcdH1cblxuXHRcdGlmIChwbGFjZWhvbGRlcktleSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRlbC5zZXRBdHRyaWJ1dGUoXCJwbGFjZWhvbGRlclwiLCB0cmFuc2xhdGUodGhpcy5hcHBfY29udGV4dCwgcGxhY2Vob2xkZXJLZXksIHBsYWNlaG9sZGVyRGF0YSwgbGFuZ0NvZGUpKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdC8qKlxuXHQgKiBTZXRzIHRoZSBpMThuIGxhbmcgZGF0YS5cblx0ICpcblx0ICogQHBhcmFtIGxhbmdDb2RlIFRoZSBpMThuIGxhbmcgY29kZVxuXHQgKiBAcGFyYW0gZGF0YSBUaGUgaTE4biBsYW5nIGRhdGEuXG5cdCAqL1xuXHRzdGF0aWMgc2V0TGFuZ0RhdGEobGFuZ0NvZGU6IHN0cmluZywgZGF0YTogdExhbmdEZWZpbml0aW9uKSB7XG5cblx0XHRpZiAoIVV0aWxzLmlzU3RyaW5nKGxhbmdDb2RlKSkge1xuXHRcdFx0dGhyb3cgbmV3IFR5cGVFcnJvcihcIltPV2ViTGFuZ10geW91ciBsYW5nIG5hbWUgc2hvdWxkIGJlIGEgdmFsaWQgc3RyaW5nLlwiKTtcblx0XHR9XG5cblx0XHRpZiAoIVV0aWxzLmlzUGxhaW5PYmplY3QoZGF0YSkpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoXCJbT1dlYkxhbmddIHlvdXIgbGFuZyBkYXRhIHNob3VsZCBiZSBhIHZhbGlkIHBsYWluIG9iamVjdC5cIik7XG5cdFx0fVxuXG5cdFx0TEFOR19PQkpFQ1RbbGFuZ0NvZGVdID0gVXRpbHMuYXNzaWduKExBTkdfT0JKRUNUW2xhbmdDb2RlXSB8fCB7fSwgZGF0YSk7XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHRoZSBpMThuIHN0cmluZy5cblx0ICpcblx0ICogQHBhcmFtIHRleHRLZXkgVGhlIGkxOG4gdGV4dCBrZXkuXG5cdCAqIEBwYXJhbSBsYW5nQ29kZSBUaGUgaTE4biBsYW5nIGNvZGVcblx0ICovXG5cdHN0YXRpYyBnZXRMYW5nVGV4dCh0ZXh0S2V5OiBzdHJpbmcsIGxhbmdDb2RlOiBzdHJpbmcpOiBhbnkge1xuXHRcdGlmIChMQU5HX09CSkVDVFtsYW5nQ29kZV0pIHtcblx0XHRcdHJldHVybiBwb3J0aW9uUmVwbGFjZXIoTEFOR19PQkpFQ1RbbGFuZ0NvZGVdW3RleHRLZXldLCBsYW5nQ29kZSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHJldHVybiB1bmRlZmluZWQ7XG5cdFx0fVxuXHR9XG5cblx0LyoqXG5cdCAqIEFkZHMgcGx1Z2luLlxuXHQgKlxuXHQgKiBAcGFyYW0gbmFtZSBUaGUgcGx1Z2luIG5hbWUuXG5cdCAqIEBwYXJhbSBmbiBUaGUgcGx1Z2luIGZ1bmN0aW9uLlxuXHQgKi9cblx0c3RhdGljIGFkZFBsdWdpbihuYW1lOiBzdHJpbmcsIGZuOiB0TGFuZ1BsdWdpbkZuKSB7XG5cdFx0aWYgKExBTkdfUExVR0lOU1tuYW1lXSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBbT1dlYkxhbmddIHBsdWdpbiAnJHtuYW1lfScgYWxyZWFkeSBkZWZpbmVkLmApO1xuXHRcdH1cblxuXHRcdExBTkdfUExVR0lOU1tuYW1lXSA9IGZuO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cbn0iXX0=