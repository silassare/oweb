"use strict";
import Utils from "./utils/Utils";
import scriptLoader from "./utils/scriptLoader";
const LANG_PORTION_COPY_REG = /{{\s*([A-Z][A-Z0-9_]+)\s*}}/g, // for {{LANG_KEY}}
LANG_REPLACE_REG = /{\s*(?:([a-zA-Z_]+):)?([a-zA-Z0-9_]+)\s*}/g, // for {variable} and {fn:variable}
LANG_VALUE_TAG_REG = /(INPUT|TEXTAREA)/i;
let LANG_OBJECT = {}, LANG_DEFAULT, LANG_DIRECTORIES = {}, LANG_PLUGINS = {}, LANG_FORMATS_FN_LIST = {
    "file_size": function (size, langCode) {
        let units = OWebLang.getLangText("FILE_SIZE_UNITS", langCode) || ["Kb"], decimal_point = OWebLang.getLangText("NUMBER_DECIMAL_SYMBOL", langCode) || ".", // ',' for french
        sep = OWebLang.getLangText("NUMBER_DIGIT_SEP", langCode) || " ", i_max = units.length, i = 0, ko = 1024, result = 0;
        size = parseFloat(size);
        while (size >= 1 && i < i_max) {
            result = size;
            size /= ko;
            i++;
        }
        if (!i) {
            i = 1;
        }
        let parts = String(result).split(".");
        let head = (parseInt(parts[0]) === result) ? result : Utils.math.numberFormat(result, 2, decimal_point, sep);
        return head + " " + units[i - 1];
    }
};
let runPlugins = (plugins, data, langCode) => {
    let len = plugins.length;
    for (let i = 0; i < len; i++) {
        let plugin = plugins[i], fn = LANG_PLUGINS[plugin];
        if (fn) {
            data = fn(data, langCode);
        }
        else {
            console.error(`[OWebLang] undefined plugins "${plugin}".`);
        }
    }
    return data;
};
let runReplace = (text, data, langCode) => {
    let fnExec = function (name, value, langCode) {
        let fn = LANG_FORMATS_FN_LIST[name];
        if (typeof fn === "function") {
            return fn(value, langCode);
        }
        return value;
    };
    text = text.replace(LANG_REPLACE_REG, (text, fn, variable) => {
        let value = (data || {})[variable];
        if (fn) {
            value = fnExec(fn, value, langCode);
        }
        return value;
    });
    return text;
};
let translate = function (langKey, langData, langCode) {
    let data = langData || {};
    let text = OWebLang.getLangText(langKey, langCode);
    if (data["olangPlugins"]) {
        let plugins = data["olangPlugins"].split("|");
        data = runPlugins(plugins, data, langCode);
    }
    if (text !== undefined) {
        if (LANG_REPLACE_REG.test(text)) {
            text = runReplace(text, data, langCode);
        }
        return text;
    }
    return langKey;
};
let portionReplacer = function (text, langCode) {
    if (LANG_PORTION_COPY_REG.test(text)) {
        text = text.replace(LANG_PORTION_COPY_REG, function (text, p) {
            return OWebLang.getLangText(p, langCode);
        });
    }
    return text;
};
let loadLangFiles = function () {
    let lang_codes = Object.keys(LANG_OBJECT);
    let sources = Object.keys(LANG_DIRECTORIES);
    let sources_bundle = [];
    lang_codes.forEach(function (langCode) {
        sources.forEach(function (path) {
            sources_bundle.push([path + langCode + ".js"]);
        });
    });
    if (sources_bundle.length) {
        scriptLoader.batchLoad(sources_bundle, (success, done, failed) => {
            // at least one should be loaded
            if (done.length) {
                OWebLang.updateAll();
            }
            if (failed.length) {
                console.warn("[OWebLang] fail to load lang files ->", failed);
            }
        });
    }
};
export default class OWebLang {
    static update(ele, handler, context) {
        let $ele = $(ele), translatedText = null, langKey = $ele.data("olang"), langCode = $ele.data("olangCode") || LANG_DEFAULT, titleKey = $ele.data("olangTitle"), placeholderKey = $ele.data("olangPlaceholder"), langData = $ele.data("olangData") || $ele.data();
        if (LANG_OBJECT[langCode]) {
            if (langKey !== undefined) {
                translatedText = translate(langKey, langData, langCode);
                if (Utils.isFunction(handler)) {
                    handler.call(context, translatedText);
                }
                else {
                    let tag = ele.nodeName;
                    if (!LANG_VALUE_TAG_REG.test(tag)) {
                        ele.innerHTML = translatedText;
                    }
                    else {
                        ele.setAttribute("value", translatedText);
                    }
                }
            }
            if (titleKey !== undefined) {
                ele.setAttribute("title", translate(titleKey, langData, langCode));
            }
            if (placeholderKey !== undefined) {
                ele.setAttribute("placeholder", translate(placeholderKey, langData, langCode));
            }
        }
        else {
            console.warn(`[OWebLang] please wait while the lang "${langCode}" is loaded...`);
        }
    }
    static setLangData(langCode, data) {
        if (!Utils.isString(langCode)) {
            throw new TypeError("[OWebLang] your lang name should be a valid string.");
        }
        if (!Utils.isPlainObject(data)) {
            throw new TypeError("[OWebLang] your lang data should be a valid plain object.");
        }
        LANG_OBJECT[langCode] = Utils.assign(LANG_OBJECT[langCode] || {}, data);
        return this;
    }
    static getLangText(textKey, langCode) {
        if (LANG_OBJECT[langCode]) {
            return portionReplacer(LANG_OBJECT[langCode][textKey], langCode);
        }
        else {
            return undefined;
        }
    }
    static setDefaultLang(langCode) {
        if (LANG_DEFAULT !== langCode) {
            LANG_DEFAULT = langCode;
            if (!LANG_OBJECT[langCode]) {
                LANG_OBJECT[langCode] = {};
            }
            loadLangFiles();
        }
        return this;
    }
    static addLangDirectories(path) {
        let list = Utils.isArray(path) ? path : [path];
        for (let i = 0; i < list.length; i++) {
            if (LANG_DIRECTORIES[list[i]] === undefined) {
                LANG_DIRECTORIES[list[i]] = true;
            }
        }
        loadLangFiles();
        return this;
    }
    static updateAll() {
        $(document.body).oLangUpdateTree();
        return this;
    }
    static addPlugin(name, fn) {
        if (LANG_PLUGINS[name]) {
            throw new Error(`[OWebLang] plugin '${name}' already defined.`);
        }
        LANG_PLUGINS[name] = fn;
        return this;
    }
    static toHuman(langKey, langData = {}, langCode = LANG_DEFAULT) {
        return translate(langKey, langData, langCode);
    }
}
$.extend($.fn, {
    oLangAble: function () {
        return $(this).data("olang") !== undefined
            || $(this).data("olangTitle") !== undefined
            || $(this).data("olangPlaceholder") !== undefined
            || $(this).data("olangHidden") !== undefined;
    },
    oLangDataObject: function () {
        let $ele = $(this);
        if (!$ele.oLangAble()) {
            throw new Error("[OWebLang] there is no olang data object.");
        }
        return {
            "olang": $ele.data("olang"),
            "olangTitle": $ele.data("olangTitle"),
            "olangPlaceholder": $ele.data("olangPlaceholder"),
            "olangHidden": $ele.data("olangHidden"),
            "olangData": $ele.data("olangData") || $ele.data()
        };
    },
    oLang: function () {
        return $(this).each(function () {
            OWebLang.update(this);
        });
    },
    oLangUpdateTree: function () {
        return $(this).find("*").each(function () {
            let $ele = $(this);
            if ($ele.oLangAble()) {
                $ele.oLang();
            }
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkxhbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYkxhbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDO0FBRWIsT0FBTyxLQUFLLE1BQU0sZUFBZSxDQUFDO0FBQ2xDLE9BQU8sWUFBMkIsTUFBTSxzQkFBc0IsQ0FBQztBQUkvRCxNQUNDLHFCQUFxQixHQUFHLDhCQUE4QixFQUFFLG1CQUFtQjtBQUMzRSxnQkFBZ0IsR0FBUSw0Q0FBNEMsRUFBQyxtQ0FBbUM7QUFDeEcsa0JBQWtCLEdBQU0sbUJBQW1CLENBQUM7QUFFN0MsSUFBSSxXQUFXLEdBQXlDLEVBQUUsRUFDekQsWUFBb0IsRUFDcEIsZ0JBQWdCLEdBQW9DLEVBQUUsRUFDdEQsWUFBWSxHQUF3QyxFQUFFLEVBQ3RELG9CQUFvQixHQUFnQztJQUNuRCxXQUFXLEVBQUUsVUFBVSxJQUFTLEVBQUUsUUFBZ0I7UUFDakQsSUFBSSxLQUFLLEdBQVcsUUFBUSxDQUFDLFdBQVcsQ0FBQyxpQkFBaUIsRUFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUM5RSxhQUFhLEdBQUcsUUFBUSxDQUFDLFdBQVcsQ0FBQyx1QkFBdUIsRUFBRSxRQUFRLENBQUMsSUFBSSxHQUFHLEVBQUMsaUJBQWlCO1FBQ2hHLEdBQUcsR0FBYSxRQUFRLENBQUMsV0FBVyxDQUFDLGtCQUFrQixFQUFFLFFBQVEsQ0FBQyxJQUFJLEdBQUcsRUFDekUsS0FBSyxHQUFXLEtBQUssQ0FBQyxNQUFNLEVBQzVCLENBQUMsR0FBZSxDQUFDLEVBQ2pCLEVBQUUsR0FBYyxJQUFJLEVBQ3BCLE1BQU0sR0FBVSxDQUFDLENBQUM7UUFFbkIsSUFBSSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUV4QixPQUFPLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssRUFBRTtZQUM5QixNQUFNLEdBQUcsSUFBSSxDQUFDO1lBQ2QsSUFBSSxJQUFJLEVB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QUFDLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDdEMsWUFBWSxFQUFRLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDO1lBQzNDLGtCQUFrQixFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUM7WUFDakQsYUFBYSxFQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDO1lBQzVDLFdBQVcsRUFBUyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUU7U0FDekQsQ0FBQztJQUNILENBQUM7SUFDRCxLQUFLLEVBQVk7UUFDaEIsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ25CLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBVyxDQUFDLENBQUM7UUFDOUIsQ0FBQyxDQUFDLENBQUM7SUFDSixDQUFDO0lBQ0QsZUFBZSxFQUFFO1FBQ2hCLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDN0IsSUFBSSxJQUFJLEdBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3hCLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRSxFQUFFO2dCQUNyQixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7YUFDYjtRQUNGLENBQUMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztDQUNELENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgVXRpbHMgZnJvbSBcIi4vdXRpbHMvVXRpbHNcIjtcbmltcG9ydCBzY3JpcHRMb2FkZXIsIHt0U2NyaXB0RmlsZX0gZnJvbSBcIi4vdXRpbHMvc2NyaXB0TG9hZGVyXCI7XG5cbmV4cG9ydCB0eXBlIHRMYW5nRGVmaW5pdGlvbiA9IHsgW2tleTogc3RyaW5nXTogYW55IH07XG5cbmNvbnN0XG5cdExBTkdfUE9SVElPTl9DT1BZX1JFRyA9IC97e1xccyooW0EtWl1bQS1aMC05X10rKVxccyp9fS9nLCAvLyBmb3Ige3tMQU5HX0tFWX19XG5cdExBTkdfUkVQTEFDRV9SRUcgICAgICA9IC97XFxzKig/OihbYS16QS1aX10rKTopPyhbYS16QS1aMC05X10rKVxccyp9L2csLy8gZm9yIHt2YXJpYWJsZX0gYW5kIHtmbjp2YXJpYWJsZX1cblx0TEFOR19WQUxVRV9UQUdfUkVHICAgID0gLyhJTlBVVHxURVhUQVJFQSkvaTtcblxubGV0IExBTkdfT0JKRUNUOiB7IFtrZXk6IHN0cmluZ106IHRMYW5nRGVmaW5pdGlvbiB9ICAgPSB7fSxcblx0TEFOR19ERUZBVUxUOiBzdHJpbmcsXG5cdExBTkdfRElSRUNUT1JJRVM6IHsgW2tleTogc3RyaW5nXTogYm9vbGVhbiB9ICAgICAgPSB7fSxcblx0TEFOR19QTFVHSU5TOiB7IFtrZXk6IHN0cmluZ106IEZ1bmN0aW9uIH0gICAgICAgICA9IHt9LFxuXHRMQU5HX0ZPUk1BVFNfRk5fTElTVDogeyBba2V5OiBzdHJpbmddOiBGdW5jdGlvbiB9ID0ge1xuXHRcdFwiZmlsZV9zaXplXCI6IGZ1bmN0aW9uIChzaXplOiBhbnksIGxhbmdDb2RlOiBzdHJpbmcpIHtcblx0XHRcdGxldCB1bml0cyAgICAgICAgID0gT1dlYkxhbmcuZ2V0TGFuZ1RleHQoXCJGSUxFX1NJWkVfVU5JVFNcIiwgbGFuZ0NvZGUpIHx8IFtcIktiXCJdLFxuXHRcdFx0XHRkZWNpbWFsX3BvaW50ID0gT1dlYkxhbmcuZ2V0TGFuZ1RleHQoXCJOVU1CRVJfREVDSU1BTF9TWU1CT0xcIiwgbGFuZ0NvZGUpIHx8IFwiLlwiLC8vICcsJyBmb3IgZnJlbmNoXG5cdFx0XHRcdHNlcCAgICAgICAgICAgPSBPV2ViTGFuZy5nZXRMYW5nVGV4dChcIk5VTUJFUl9ESUdJVF9TRVBcIiwgbGFuZ0NvZGUpIHx8IFwiIFwiLFxuXHRcdFx0XHRpX21heCAgICAgICAgID0gdW5pdHMubGVuZ3RoLFxuXHRcdFx0XHRpICAgICAgICAgICAgID0gMCxcblx0XHRcdFx0a28gICAgICAgICAgICA9IDEwMjQsXG5cdFx0XHRcdHJlc3VsdCAgICAgICAgPSAwO1xuXG5cdFx0XHRzaXplID0gcGFyc2VGbG9hdChzaXplKTtcblxuXHRcdFx0d2hpbGUgKHNpemUgPj0gMSAmJiBpIDwgaV9tYXgpIHtcblx0XHRcdFx0cmVzdWx0ID0gc2l6ZTtcblx0XHRcdFx0c2l6ZSAvPSBrbztcblx0XHRcdFx0aSsrO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoIWkpIHtcblx0XHRcdFx0aSA9IDE7XG5cdFx0XHR9XG5cblx0XHRcdGxldCBwYXJ0cyA9IFN0cmluZyhyZXN1bHQpLnNwbGl0KFwiLlwiKTtcblx0XHRcdGxldCBoZWFkICA9IChwYXJzZUludChwYXJ0c1swXSkgPT09IHJlc3VsdCkgPyByZXN1bHQgOiBVdGlscy5tYXRoLm51bWJlckZvcm1hdChyZXN1bHQsIDIsIGRlY2ltYWxfcG9pbnQsIHNlcCk7XG5cblx0XHRcdHJldHVybiBoZWFkICsgXCIgXCIgKyB1bml0c1tpIC0gMV07XG5cdFx0fVxuXHR9O1xuXG5sZXQgcnVuUGx1Z2lucyA9IChwbHVnaW5zOiBzdHJpbmcsIGRhdGE6IGFueSwgbGFuZ0NvZGU6IHN0cmluZyk6IGFueSA9PiB7XG5cdGxldCBsZW4gPSBwbHVnaW5zLmxlbmd0aDtcblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykge1xuXHRcdGxldCBwbHVnaW4gPSBwbHVnaW5zW2ldLFxuXHRcdFx0Zm4gICAgID0gTEFOR19QTFVHSU5TW3BsdWdpbl07XG5cblx0XHRpZiAoZm4pIHtcblx0XHRcdGRhdGEgPSBmbihkYXRhLCBsYW5nQ29kZSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGNvbnNvbGUuZXJyb3IoYFtPV2ViTGFuZ10gdW5kZWZpbmVkIHBsdWdpbnMgXCIke3BsdWdpbn1cIi5gKTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gZGF0YTtcbn07XG5cbmxldCBydW5SZXBsYWNlID0gKHRleHQ6IHN0cmluZywgZGF0YTogYW55LCBsYW5nQ29kZTogc3RyaW5nKTogc3RyaW5nID0+IHtcblxuXHRsZXQgZm5FeGVjID0gZnVuY3Rpb24gKG5hbWU6IHN0cmluZywgdmFsdWU6IGFueSwgbGFuZ0NvZGU6IHN0cmluZykge1xuXHRcdGxldCBmbiA9IExBTkdfRk9STUFUU19GTl9MSVNUW25hbWVdO1xuXG5cdFx0aWYgKHR5cGVvZiBmbiA9PT0gXCJmdW5jdGlvblwiKSB7XG5cdFx0XHRyZXR1cm4gZm4odmFsdWUsIGxhbmdDb2RlKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdmFsdWU7XG5cdH07XG5cblx0dGV4dCA9IHRleHQucmVwbGFjZShMQU5HX1JFUExBQ0VfUkVHLCAodGV4dCwgZm4sIHZhcmlhYmxlKSA9PiB7XG5cdFx0bGV0IHZhbHVlID0gKGRhdGEgfHwge30pW3ZhcmlhYmxlXTtcblxuXHRcdGlmIChmbikge1xuXHRcdFx0dmFsdWUgPSBmbkV4ZWMoZm4sIHZhbHVlLCBsYW5nQ29kZSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHZhbHVlO1xuXHR9KTtcblxuXHRyZXR1cm4gdGV4dDtcbn07XG5cbmxldCB0cmFuc2xhdGUgPSBmdW5jdGlvbiAobGFuZ0tleTogc3RyaW5nLCBsYW5nRGF0YTogYW55LCBsYW5nQ29kZTogc3RyaW5nKTogc3RyaW5nIHtcblx0bGV0IGRhdGEgPSBsYW5nRGF0YSB8fCB7fTtcblx0bGV0IHRleHQgPSBPV2ViTGFuZy5nZXRMYW5nVGV4dChsYW5nS2V5LCBsYW5nQ29kZSk7XG5cblx0aWYgKGRhdGFbXCJvbGFuZ1BsdWdpbnNcIl0pIHtcblx0XHRsZXQgcGx1Z2lucyA9IGRhdGFbXCJvbGFuZ1BsdWdpbnNcIl0uc3BsaXQoXCJ8XCIpO1xuXHRcdGRhdGEgICAgICAgID0gcnVuUGx1Z2lucyhwbHVnaW5zLCBkYXRhLCBsYW5nQ29kZSk7XG5cdH1cblxuXHRpZiAodGV4dCAhPT0gdW5kZWZpbmVkKSB7XG5cblx0XHRpZiAoTEFOR19SRVBMQUNFX1JFRy50ZXN0KHRleHQpKSB7XG5cdFx0XHR0ZXh0ID0gcnVuUmVwbGFjZSh0ZXh0LCBkYXRhLCBsYW5nQ29kZSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRleHQ7XG5cdH1cblxuXHRyZXR1cm4gbGFuZ0tleTtcbn07XG5cbmxldCBwb3J0aW9uUmVwbGFjZXIgPSBmdW5jdGlvbiAodGV4dDogc3RyaW5nLCBsYW5nQ29kZTogc3RyaW5nKTogc3RyaW5nIHtcblx0aWYgKExBTkdfUE9SVElPTl9DT1BZX1JFRy50ZXN0KHRleHQpKSB7XG5cdFx0dGV4dCA9IHRleHQucmVwbGFjZShMQU5HX1BPUlRJT05fQ09QWV9SRUcsIGZ1bmN0aW9uICh0ZXh0LCBwKSB7XG5cdFx0XHRyZXR1cm4gT1dlYkxhbmcuZ2V0TGFuZ1RleHQocCwgbGFuZ0NvZGUpO1xuXHRcdH0pO1xuXHR9XG5cblx0cmV0dXJuIHRleHQ7XG59O1xuXG5sZXQgbG9hZExhbmdGaWxlcyA9IGZ1bmN0aW9uICgpIHtcblx0bGV0IGxhbmdfY29kZXMgICAgICAgICAgICAgICAgICAgICAgICAgPSBPYmplY3Qua2V5cyhMQU5HX09CSkVDVCk7XG5cdGxldCBzb3VyY2VzICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gT2JqZWN0LmtleXMoTEFOR19ESVJFQ1RPUklFUyk7XG5cdGxldCBzb3VyY2VzX2J1bmRsZTogQXJyYXk8dFNjcmlwdEZpbGU+ID0gW107XG5cblx0bGFuZ19jb2Rlcy5mb3JFYWNoKGZ1bmN0aW9uIChsYW5nQ29kZSkge1xuXHRcdHNvdXJjZXMuZm9yRWFjaChmdW5jdGlvbiAocGF0aCkge1xuXHRcdFx0c291cmNlc19idW5kbGUucHVzaChbcGF0aCArIGxhbmdDb2RlICsgXCIuanNcIl0pO1xuXHRcdH0pO1xuXHR9KTtcblxuXHRpZiAoc291cmNlc19idW5kbGUubGVuZ3RoKSB7XG5cdFx0c2NyaXB0TG9hZGVyLmJhdGNoTG9hZChzb3VyY2VzX2J1bmRsZSwgKHN1Y2Nlc3M6IGJvb2xlYW4sIGRvbmUsIGZhaWxlZCkgPT4ge1xuXHRcdFx0Ly8gYXQgbGVhc3Qgb25lIHNob3VsZCBiZSBsb2FkZWRcblx0XHRcdGlmIChkb25lLmxlbmd0aCkge1xuXHRcdFx0XHRPV2ViTGFuZy51cGRhdGVBbGwoKTtcblx0XHRcdH1cblx0XHRcdGlmIChmYWlsZWQubGVuZ3RoKSB7XG5cdFx0XHRcdGNvbnNvbGUud2FybihcIltPV2ViTGFuZ10gZmFpbCB0byBsb2FkIGxhbmcgZmlsZXMgLT5cIiwgZmFpbGVkKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fVxufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT1dlYkxhbmcge1xuXG5cdHN0YXRpYyB1cGRhdGUoZWxlOiBIVE1MRWxlbWVudCwgaGFuZGxlcj86IEZ1bmN0aW9uLCBjb250ZXh0PzogYW55KSB7XG5cdFx0bGV0ICRlbGUgICAgICAgICAgID0gJChlbGUpLFxuXHRcdFx0dHJhbnNsYXRlZFRleHQgPSBudWxsLFxuXHRcdFx0bGFuZ0tleSAgICAgICAgPSAkZWxlLmRhdGEoXCJvbGFuZ1wiKSxcblx0XHRcdGxhbmdDb2RlICAgICAgID0gJGVsZS5kYXRhKFwib2xhbmdDb2RlXCIpIHx8IExBTkdfREVGQVVMVCxcblx0XHRcdHRpdGxlS2V5ICAgICAgID0gJGVsZS5kYXRhKFwib2xhbmdUaXRsZVwiKSxcblx0XHRcdHBsYWNlaG9sZGVyS2V5ID0gJGVsZS5kYXRhKFwib2xhbmdQbGFjZWhvbGRlclwiKSxcblx0XHRcdGxhbmdEYXRhICAgICAgID0gJGVsZS5kYXRhKFwib2xhbmdEYXRhXCIpIHx8ICRlbGUuZGF0YSgpO1xuXG5cdFx0aWYgKExBTkdfT0JKRUNUW2xhbmdDb2RlXSkge1xuXHRcdFx0aWYgKGxhbmdLZXkgIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHR0cmFuc2xhdGVkVGV4dCA9IHRyYW5zbGF0ZShsYW5nS2V5LCBsYW5nRGF0YSwgbGFuZ0NvZGUpO1xuXG5cdFx0XHRcdGlmIChVdGlscy5pc0Z1bmN0aW9uKGhhbmRsZXIpKSB7XG5cdFx0XHRcdFx0aGFuZGxlci5jYWxsKGNvbnRleHQsIHRyYW5zbGF0ZWRUZXh0KTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRsZXQgdGFnID0gZWxlLm5vZGVOYW1lO1xuXG5cdFx0XHRcdFx0aWYgKCFMQU5HX1ZBTFVFX1RBR19SRUcudGVzdCh0YWcpKSB7XG5cdFx0XHRcdFx0XHRlbGUuaW5uZXJIVE1MID0gdHJhbnNsYXRlZFRleHQ7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdGVsZS5zZXRBdHRyaWJ1dGUoXCJ2YWx1ZVwiLCB0cmFuc2xhdGVkVGV4dCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdGlmICh0aXRsZUtleSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdGVsZS5zZXRBdHRyaWJ1dGUoXCJ0aXRsZVwiLCB0cmFuc2xhdGUodGl0bGVLZXksIGxhbmdEYXRhLCBsYW5nQ29kZSkpO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAocGxhY2Vob2xkZXJLZXkgIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHRlbGUuc2V0QXR0cmlidXRlKFwicGxhY2Vob2xkZXJcIiwgdHJhbnNsYXRlKHBsYWNlaG9sZGVyS2V5LCBsYW5nRGF0YSwgbGFuZ0NvZGUpKTtcblx0XHRcdH1cblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc29sZS53YXJuKGBbT1dlYkxhbmddIHBsZWFzZSB3YWl0IHdoaWxlIHRoZSBsYW5nIFwiJHtsYW5nQ29kZX1cIiBpcyBsb2FkZWQuLi5gKTtcblx0XHR9XG5cdH1cblxuXHRzdGF0aWMgc2V0TGFuZ0RhdGEobGFuZ0NvZGU6IHN0cmluZywgZGF0YTogdExhbmdEZWZpbml0aW9uKSB7XG5cblx0XHRpZiAoIVV0aWxzLmlzU3RyaW5nKGxhbmdDb2RlKSkge1xuXHRcdFx0dGhyb3cgbmV3IFR5cGVFcnJvcihcIltPV2ViTGFuZ10geW91ciBsYW5nIG5hbWUgc2hvdWxkIGJlIGEgdmFsaWQgc3RyaW5nLlwiKTtcblx0XHR9XG5cblx0XHRpZiAoIVV0aWxzLmlzUGxhaW5PYmplY3QoZGF0YSkpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoXCJbT1dlYkxhbmddIHlvdXIgbGFuZyBkYXRhIHNob3VsZCBiZSBhIHZhbGlkIHBsYWluIG9iamVjdC5cIik7XG5cdFx0fVxuXG5cdFx0TEFOR19PQkpFQ1RbbGFuZ0NvZGVdID0gVXRpbHMuYXNzaWduKExBTkdfT0JKRUNUW2xhbmdDb2RlXSB8fCB7fSwgZGF0YSk7XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHN0YXRpYyBnZXRMYW5nVGV4dCh0ZXh0S2V5OiBzdHJpbmcsIGxhbmdDb2RlOiBzdHJpbmcpOiBhbnkge1xuXHRcdGlmIChMQU5HX09CSkVDVFtsYW5nQ29kZV0pIHtcblx0XHRcdHJldHVybiBwb3J0aW9uUmVwbGFjZXIoTEFOR19PQkpFQ1RbbGFuZ0NvZGVdW3RleHRLZXldLCBsYW5nQ29kZSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHJldHVybiB1bmRlZmluZWQ7XG5cdFx0fVxuXHR9XG5cblx0c3RhdGljIHNldERlZmF1bHRMYW5nKGxhbmdDb2RlOiBzdHJpbmcpIHtcblx0XHRpZiAoTEFOR19ERUZBVUxUICE9PSBsYW5nQ29kZSkge1xuXG5cdFx0XHRMQU5HX0RFRkFVTFQgPSBsYW5nQ29kZTtcblxuXHRcdFx0aWYgKCFMQU5HX09CSkVDVFtsYW5nQ29kZV0pIHtcblx0XHRcdFx0TEFOR19PQkpFQ1RbbGFuZ0NvZGVdID0ge307XG5cdFx0XHR9XG5cblx0XHRcdGxvYWRMYW5nRmlsZXMoKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHN0YXRpYyBhZGRMYW5nRGlyZWN0b3JpZXMocGF0aDogc3RyaW5nKSB7XG5cdFx0bGV0IGxpc3QgPSBVdGlscy5pc0FycmF5KHBhdGgpID8gcGF0aCA6IFtwYXRoXTtcblxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykge1xuXHRcdFx0aWYgKExBTkdfRElSRUNUT1JJRVNbbGlzdFtpXV0gPT09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHRMQU5HX0RJUkVDVE9SSUVTW2xpc3RbaV1dID0gdHJ1ZTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRsb2FkTGFuZ0ZpbGVzKCk7XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHN0YXRpYyB1cGRhdGVBbGwoKSB7XG5cdFx0KCQoZG9jdW1lbnQuYm9keSkgYXMgYW55KS5vTGFuZ1VwZGF0ZVRyZWUoKTtcblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHN0YXRpYyBhZGRQbHVnaW4obmFtZTogc3RyaW5nLCBmbjogRnVuY3Rpb24pIHtcblx0XHRpZiAoTEFOR19QTFVHSU5TW25hbWVdKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYFtPV2ViTGFuZ10gcGx1Z2luICcke25hbWV9JyBhbHJlYWR5IGRlZmluZWQuYCk7XG5cdFx0fVxuXG5cdFx0TEFOR19QTFVHSU5TW25hbWVdID0gZm47XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHN0YXRpYyB0b0h1bWFuKGxhbmdLZXk6IHN0cmluZywgbGFuZ0RhdGE6IGFueSA9IHt9LCBsYW5nQ29kZTogc3RyaW5nID0gTEFOR19ERUZBVUxUKTogc3RyaW5nIHtcblx0XHRyZXR1cm4gdHJhbnNsYXRlKGxhbmdLZXksIGxhbmdEYXRhLCBsYW5nQ29kZSk7XG5cdH1cbn1cblxuJC5leHRlbmQoJC5mbiwge1xuXHRvTGFuZ0FibGUgICAgICA6IGZ1bmN0aW9uICgpIHtcblx0XHRyZXR1cm4gJCh0aGlzKS5kYXRhKFwib2xhbmdcIikgIT09IHVuZGVmaW5lZFxuXHRcdFx0fHwgJCh0aGlzKS5kYXRhKFwib2xhbmdUaXRsZVwiKSAhPT0gdW5kZWZpbmVkXG5cdFx0XHR8fCAkKHRoaXMpLmRhdGEoXCJvbGFuZ1BsYWNlaG9sZGVyXCIpICE9PSB1bmRlZmluZWRcblx0XHRcdHx8ICQodGhpcykuZGF0YShcIm9sYW5nSGlkZGVuXCIpICE9PSB1bmRlZmluZWQ7XG5cdH0sXG5cdG9MYW5nRGF0YU9iamVjdDogZnVuY3Rpb24gKCkge1xuXHRcdGxldCAkZWxlOiBhbnkgPSAkKHRoaXMpO1xuXG5cdFx0aWYgKCEkZWxlLm9MYW5nQWJsZSgpKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoXCJbT1dlYkxhbmddIHRoZXJlIGlzIG5vIG9sYW5nIGRhdGEgb2JqZWN0LlwiKTtcblx0XHR9XG5cblx0XHRyZXR1cm4ge1xuXHRcdFx0XCJvbGFuZ1wiICAgICAgICAgICA6ICRlbGUuZGF0YShcIm9sYW5nXCIpLFxuXHRcdFx0XCJvbGFuZ1RpdGxlXCIgICAgICA6ICRlbGUuZGF0YShcIm9sYW5nVGl0bGVcIiksXG5cdFx0XHRcIm9sYW5nUGxhY2Vob2xkZXJcIjogJGVsZS5kYXRhKFwib2xhbmdQbGFjZWhvbGRlclwiKSxcblx0XHRcdFwib2xhbmdIaWRkZW5cIiAgICAgOiAkZWxlLmRhdGEoXCJvbGFuZ0hpZGRlblwiKSxcblx0XHRcdFwib2xhbmdEYXRhXCIgICAgICAgOiAkZWxlLmRhdGEoXCJvbGFuZ0RhdGFcIikgfHwgJGVsZS5kYXRhKClcblx0XHR9O1xuXHR9LFxuXHRvTGFuZyAgICAgICAgICA6IGZ1bmN0aW9uICgpIHtcblx0XHRyZXR1cm4gJCh0aGlzKS5lYWNoKGZ1bmN0aW9uICgpIHtcblx0XHRcdE9XZWJMYW5nLnVwZGF0ZSh0aGlzIGFzIGFueSk7XG5cdFx0fSk7XG5cdH0sXG5cdG9MYW5nVXBkYXRlVHJlZTogZnVuY3Rpb24gKCkge1xuXHRcdHJldHVybiAkKHRoaXMpLmZpbmQoXCIqXCIpLmVhY2goZnVuY3Rpb24gKCkge1xuXHRcdFx0bGV0ICRlbGU6IGFueSA9ICQodGhpcyk7XG5cdFx0XHRpZiAoJGVsZS5vTGFuZ0FibGUoKSkge1xuXHRcdFx0XHQkZWxlLm9MYW5nKCk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cbn0pOyJdfQ==