import { scriptLoader, Utils } from "./oweb";
const LANG_PORTION_COPY_REG = /{{\s*([A-Z][A-Z0-9_]+)\s*}}/g, // for {{LANG_KEY}}
LANG_REPLACE_REG = /{\s*(?:([a-zA-Z_]+):)?([a-zA-Z0-9_]+)\s*}/g, // for {variable} and {fn:variable}
LANG_VALUE_TAG_REG = /(INPUT|TEXTAREA)/i;
let LANG_OBJECT = {}, LANG_DEFAULT, LANG_DIRECTORIES = {}, LANG_PLUGINS = {}, LANG_FORMATS_FN_LIST = {
    "file_size": function (size, langCode) {
        let units = OWebLang.getLangText("FILE_SIZE_UNITS", langCode) || ["Kb"], decimal_point = OWebLang.getLangText("NUMBER_DECIMAL_SYMBOL", langCode) || ".", // ',' for french
        sep = OWebLang.getLangText("NUMBER_DIGIT_SEP", langCode) || " ", i_max = units.length, i = 0, ko = 1024, result = 0;
        size = parseFloat(size);
        while (size >= 1 && i < i_max) {
            result = size;
            size /= ko;
            i++;
        }
        if (!i) {
            i = 1;
        }
        let parts = String(result).split(".");
        let head = (parseInt(parts[0]) === result) ? result : Utils.math.numberFormat(result, 2, decimal_point, sep);
        return head + " " + units[i - 1];
    }
};
let runPlugins = (plugins, data, langCode) => {
    let len = plugins.length;
    for (let i = 0; i < len; i++) {
        let plugin = plugins[i], fn = LANG_PLUGINS[plugin];
        if (fn) {
            data = fn(data, langCode);
        }
        else {
            console.error(`[OWebLang] undefined plugins "${plugin}".`);
        }
    }
    return data;
};
let runReplace = (text, data, langCode) => {
    let fnExec = function (name, value, langCode) {
        let fn = LANG_FORMATS_FN_LIST[name];
        if (typeof fn === "function") {
            return fn(value, langCode);
        }
        return value;
    };
    text = text.replace(LANG_REPLACE_REG, (text, fn, variable) => {
        let value = (data || {})[variable];
        if (fn) {
            value = fnExec(fn, value, langCode);
        }
        return value;
    });
    return text;
};
let translate = function (langKey, langData, langCode) {
    let data = langData || {};
    let text = OWebLang.getLangText(langKey, langCode);
    if (data["olangPlugins"]) {
        let plugins = data["olangPlugins"].split("|");
        data = runPlugins(plugins, data, langCode);
    }
    if (text !== undefined) {
        if (LANG_REPLACE_REG.test(text)) {
            text = runReplace(text, data, langCode);
        }
        return text;
    }
    return langKey;
};
let portionReplacer = function (text, langCode) {
    if (LANG_PORTION_COPY_REG.test(text)) {
        text = text.replace(LANG_PORTION_COPY_REG, function (text, p) {
            return OWebLang.getLangText(p, langCode);
        });
    }
    return text;
};
let loadLangFiles = function () {
    let lang_codes = Object.keys(LANG_OBJECT);
    let sources = Object.keys(LANG_DIRECTORIES);
    let sources_bundle = [];
    lang_codes.forEach(function (langCode) {
        sources.forEach(function (path) {
            sources_bundle.push([path + langCode + ".js"]);
        });
    });
    if (sources_bundle.length) {
        scriptLoader.batchLoad(sources_bundle, (success, done, failed) => {
            // at least one should be loaded
            if (done.length) {
                OWebLang.updateAll();
            }
            if (failed.length) {
                console.warn("[OWebLang] fail to load lang files ->", failed);
            }
        });
    }
};
export default class OWebLang {
    static update(ele, handler, context) {
        let $ele = $(ele), translatedText = null, langKey = $ele.data("olang"), langCode = $ele.data("olangCode") || LANG_DEFAULT, titleKey = $ele.data("olangTitle"), placeholderKey = $ele.data("olangPlaceholder"), langData = $ele.data("olangData") || $ele.data();
        if (LANG_OBJECT[langCode]) {
            if (langKey !== undefined) {
                translatedText = translate(langKey, langData, langCode);
                if (Utils.isFunction(handler)) {
                    handler.call(context, translatedText);
                }
                else {
                    let tag = ele.nodeName;
                    if (!LANG_VALUE_TAG_REG.test(tag)) {
                        ele.innerHTML = translatedText;
                    }
                    else {
                        ele.setAttribute("value", translatedText);
                    }
                }
            }
            if (titleKey !== undefined) {
                ele.setAttribute("title", translate(titleKey, langData, langCode));
            }
            if (placeholderKey !== undefined) {
                ele.setAttribute("placeholder", translate(placeholderKey, langData, langCode));
            }
        }
        else {
            console.warn(`[OWebLang] please wait while the lang "${langCode}" is loaded...`);
        }
    }
    static setLangData(langCode, data) {
        if (!Utils.isString(langCode)) {
            throw new TypeError("[OWebLang] your lang name should be a valid string.");
        }
        if (!Utils.isPlainObject(data)) {
            throw new TypeError("[OWebLang] your lang data should be a valid plain object.");
        }
        LANG_OBJECT[langCode] = Utils.assign(LANG_OBJECT[langCode] || {}, data);
        return this;
    }
    static getLangText(textKey, langCode) {
        if (LANG_OBJECT[langCode]) {
            return portionReplacer(LANG_OBJECT[langCode][textKey], langCode);
        }
        else {
            return undefined;
        }
    }
    static setDefaultLang(langCode) {
        if (LANG_DEFAULT !== langCode) {
            LANG_DEFAULT = langCode;
            if (!LANG_OBJECT[langCode]) {
                LANG_OBJECT[langCode] = {};
            }
            loadLangFiles();
        }
        return this;
    }
    static addLangDirectories(path) {
        let list = Utils.isArray(path) ? path : [path];
        for (let i = 0; i < list.length; i++) {
            if (LANG_DIRECTORIES[list[i]] === undefined) {
                LANG_DIRECTORIES[list[i]] = true;
            }
        }
        loadLangFiles();
        return this;
    }
    static updateAll() {
        $(document.body).oLangUpdateTree();
        return this;
    }
    static addPlugin(name, fn) {
        if (LANG_PLUGINS[name]) {
            throw new Error(`[OWebLang] plugin '${name}' already defined.`);
        }
        LANG_PLUGINS[name] = fn;
        return this;
    }
    static toHuman(langKey, langData = {}, langCode = LANG_DEFAULT) {
        return translate(langKey, langData, langCode);
    }
}
$.extend($.fn, {
    oLangAble: function () {
        return $(this).data("olang") !== undefined
            || $(this).data("olangTitle") !== undefined
            || $(this).data("olangPlaceholder") !== undefined
            || $(this).data("olangHidden") !== undefined;
    },
    oLangDataObject: function () {
        let $ele = $(this);
        if (!$ele.oLangAble()) {
            throw new Error("[OWebLang] there is no olang data object.");
        }
        return {
            "olang": $ele.data("olang"),
            "olangTitle": $ele.data("olangTitle"),
            "olangPlaceholder": $ele.data("olangPlaceholder"),
            "olangHidden": $ele.data("olangHidden"),
            "olangData": $ele.data("olangData") || $ele.data()
        };
    },
    oLang: function () {
        return $(this).each(function () {
            OWebLang.update(this);
        });
    },
    oLangUpdateTree: function () {
        return $(this).find("*").each(function () {
            let $ele = $(this);
            if ($ele.oLangAble()) {
                $ele.oLang();
            }
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkxhbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYkxhbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLFlBQVksRUFBZSxLQUFLLEVBQUMsTUFBTSxRQUFRLENBQUM7QUFJeEQsTUFDQyxxQkFBcUIsR0FBRyw4QkFBOEIsRUFBRSxtQkFBbUI7QUFDM0UsZ0JBQWdCLEdBQVEsNENBQTRDLEVBQUMsbUNBQW1DO0FBQ3hHLGtCQUFrQixHQUFNLG1CQUFtQixDQUFDO0FBRTdDLElBQUksV0FBVyxHQUF5QyxFQUFFLEVBQ3pELFlBQW9CLEVBQ3BCLGdCQUFnQixHQUFvQyxFQUFFLEVBQ3RELFlBQVksR0FBd0MsRUFBRSxFQUN0RCxvQkFBb0IsR0FBZ0M7SUFDbkQsV0FBVyxFQUFFLFVBQVUsSUFBUyxFQUFFLFFBQWdCO1FBQ2pELElBQUksS0FBSyxHQUFXLFFBQVEsQ0FBQyxXQUFXLENBQUMsaUJBQWlCLEVBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFDOUUsYUFBYSxHQUFHLFFBQVEsQ0FBQyxXQUFXLENBQUMsdUJBQXVCLEVBQUUsUUFBUSxDQUFDLElBQUksR0FBRyxFQUFDLGlCQUFpQjtRQUNoRyxHQUFHLEdBQWEsUUFBUSxDQUFDLFdBQVcsQ0FBQyxrQkFBa0IsRUFBRSxRQUFRLENBQUMsSUFBSSxHQUFHLEVBQ3pFLEtBQUssR0FBVyxLQUFLLENBQUMsTUFBTSxFQUM1QixDQUFDLEdBQWUsQ0FBQyxFQUNqQixFQUFFLEdBQWMsSUFBSSxFQUNwQixNQUFNLEdBQVUsQ0FBQyxDQUFDO1FBRW5CLElBQUksR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFeEIsT0FBTyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLEVBQUU7WUFDOUIsTUFBTSxHQUFHLElBQUksQ0FBQztZQUNkLElBQUksSUFBSSxFQUFFLENBQUM7WUFDWCxDQUFDLEVBQUUsQ0FBQztT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LFlBQVksRUFBUSxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQztZQUMzQyxrQkFBa0IsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDO1lBQ2pELGFBQWEsRUFBTyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQztZQUM1QyxXQUFXLEVBQVMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFO1NBQ3pELENBQUM7SUFDSCxDQUFDO0lBQ0QsS0FBSyxFQUFZO1FBQ2hCLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNuQixRQUFRLENBQUMsTUFBTSxDQUFDLElBQVcsQ0FBQyxDQUFDO1FBQzlCLENBQUMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUNELGVBQWUsRUFBRTtRQUNoQixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzdCLElBQUksSUFBSSxHQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN4QixJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUUsRUFBRTtnQkFDckIsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO2FBQ2I7UUFDRixDQUFDLENBQUMsQ0FBQztJQUNKLENBQUM7Q0FDRCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge3NjcmlwdExvYWRlciwgdFNjcmlwdEZpbGUsIFV0aWxzfSBmcm9tIFwiLi9vd2ViXCI7XG5cbmV4cG9ydCB0eXBlIHRMYW5nRGVmaW5pdGlvbiA9IHsgW2tleTogc3RyaW5nXTogYW55IH07XG5cbmNvbnN0XG5cdExBTkdfUE9SVElPTl9DT1BZX1JFRyA9IC97e1xccyooW0EtWl1bQS1aMC05X10rKVxccyp9fS9nLCAvLyBmb3Ige3tMQU5HX0tFWX19XG5cdExBTkdfUkVQTEFDRV9SRUcgICAgICA9IC97XFxzKig/OihbYS16QS1aX10rKTopPyhbYS16QS1aMC05X10rKVxccyp9L2csLy8gZm9yIHt2YXJpYWJsZX0gYW5kIHtmbjp2YXJpYWJsZX1cblx0TEFOR19WQUxVRV9UQUdfUkVHICAgID0gLyhJTlBVVHxURVhUQVJFQSkvaTtcblxubGV0IExBTkdfT0JKRUNUOiB7IFtrZXk6IHN0cmluZ106IHRMYW5nRGVmaW5pdGlvbiB9ICAgPSB7fSxcblx0TEFOR19ERUZBVUxUOiBzdHJpbmcsXG5cdExBTkdfRElSRUNUT1JJRVM6IHsgW2tleTogc3RyaW5nXTogYm9vbGVhbiB9ICAgICAgPSB7fSxcblx0TEFOR19QTFVHSU5TOiB7IFtrZXk6IHN0cmluZ106IEZ1bmN0aW9uIH0gICAgICAgICA9IHt9LFxuXHRMQU5HX0ZPUk1BVFNfRk5fTElTVDogeyBba2V5OiBzdHJpbmddOiBGdW5jdGlvbiB9ID0ge1xuXHRcdFwiZmlsZV9zaXplXCI6IGZ1bmN0aW9uIChzaXplOiBhbnksIGxhbmdDb2RlOiBzdHJpbmcpIHtcblx0XHRcdGxldCB1bml0cyAgICAgICAgID0gT1dlYkxhbmcuZ2V0TGFuZ1RleHQoXCJGSUxFX1NJWkVfVU5JVFNcIiwgbGFuZ0NvZGUpIHx8IFtcIktiXCJdLFxuXHRcdFx0XHRkZWNpbWFsX3BvaW50ID0gT1dlYkxhbmcuZ2V0TGFuZ1RleHQoXCJOVU1CRVJfREVDSU1BTF9TWU1CT0xcIiwgbGFuZ0NvZGUpIHx8IFwiLlwiLC8vICcsJyBmb3IgZnJlbmNoXG5cdFx0XHRcdHNlcCAgICAgICAgICAgPSBPV2ViTGFuZy5nZXRMYW5nVGV4dChcIk5VTUJFUl9ESUdJVF9TRVBcIiwgbGFuZ0NvZGUpIHx8IFwiIFwiLFxuXHRcdFx0XHRpX21heCAgICAgICAgID0gdW5pdHMubGVuZ3RoLFxuXHRcdFx0XHRpICAgICAgICAgICAgID0gMCxcblx0XHRcdFx0a28gICAgICAgICAgICA9IDEwMjQsXG5cdFx0XHRcdHJlc3VsdCAgICAgICAgPSAwO1xuXG5cdFx0XHRzaXplID0gcGFyc2VGbG9hdChzaXplKTtcblxuXHRcdFx0d2hpbGUgKHNpemUgPj0gMSAmJiBpIDwgaV9tYXgpIHtcblx0XHRcdFx0cmVzdWx0ID0gc2l6ZTtcblx0XHRcdFx0c2l6ZSAvPSBrbztcblx0XHRcdFx0aSsrO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoIWkpIHtcblx0XHRcdFx0aSA9IDE7XG5cdFx0XHR9XG5cblx0XHRcdGxldCBwYXJ0cyA9IFN0cmluZyhyZXN1bHQpLnNwbGl0KFwiLlwiKTtcblx0XHRcdGxldCBoZWFkICA9IChwYXJzZUludChwYXJ0c1swXSkgPT09IHJlc3VsdCkgPyByZXN1bHQgOiBVdGlscy5tYXRoLm51bWJlckZvcm1hdChyZXN1bHQsIDIsIGRlY2ltYWxfcG9pbnQsIHNlcCk7XG5cblx0XHRcdHJldHVybiBoZWFkICsgXCIgXCIgKyB1bml0c1tpIC0gMV07XG5cdFx0fVxuXHR9O1xuXG5sZXQgcnVuUGx1Z2lucyA9IChwbHVnaW5zOiBzdHJpbmcsIGRhdGE6IGFueSwgbGFuZ0NvZGU6IHN0cmluZyk6IGFueSA9PiB7XG5cdGxldCBsZW4gPSBwbHVnaW5zLmxlbmd0aDtcblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykge1xuXHRcdGxldCBwbHVnaW4gPSBwbHVnaW5zW2ldLFxuXHRcdFx0Zm4gICAgID0gTEFOR19QTFVHSU5TW3BsdWdpbl07XG5cblx0XHRpZiAoZm4pIHtcblx0XHRcdGRhdGEgPSBmbihkYXRhLCBsYW5nQ29kZSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGNvbnNvbGUuZXJyb3IoYFtPV2ViTGFuZ10gdW5kZWZpbmVkIHBsdWdpbnMgXCIke3BsdWdpbn1cIi5gKTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gZGF0YTtcbn07XG5cbmxldCBydW5SZXBsYWNlID0gKHRleHQ6IHN0cmluZywgZGF0YTogYW55LCBsYW5nQ29kZTogc3RyaW5nKTogc3RyaW5nID0+IHtcblxuXHRsZXQgZm5FeGVjID0gZnVuY3Rpb24gKG5hbWU6IHN0cmluZywgdmFsdWU6IGFueSwgbGFuZ0NvZGU6IHN0cmluZykge1xuXHRcdGxldCBmbiA9IExBTkdfRk9STUFUU19GTl9MSVNUW25hbWVdO1xuXG5cdFx0aWYgKHR5cGVvZiBmbiA9PT0gXCJmdW5jdGlvblwiKSB7XG5cdFx0XHRyZXR1cm4gZm4odmFsdWUsIGxhbmdDb2RlKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdmFsdWU7XG5cdH07XG5cblx0dGV4dCA9IHRleHQucmVwbGFjZShMQU5HX1JFUExBQ0VfUkVHLCAodGV4dCwgZm4sIHZhcmlhYmxlKSA9PiB7XG5cdFx0bGV0IHZhbHVlID0gKGRhdGEgfHwge30pW3ZhcmlhYmxlXTtcblxuXHRcdGlmIChmbikge1xuXHRcdFx0dmFsdWUgPSBmbkV4ZWMoZm4sIHZhbHVlLCBsYW5nQ29kZSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHZhbHVlO1xuXHR9KTtcblxuXHRyZXR1cm4gdGV4dDtcbn07XG5cbmxldCB0cmFuc2xhdGUgPSBmdW5jdGlvbiAobGFuZ0tleTogc3RyaW5nLCBsYW5nRGF0YTogYW55LCBsYW5nQ29kZTogc3RyaW5nKTogc3RyaW5nIHtcblx0bGV0IGRhdGEgPSBsYW5nRGF0YSB8fCB7fTtcblx0bGV0IHRleHQgPSBPV2ViTGFuZy5nZXRMYW5nVGV4dChsYW5nS2V5LCBsYW5nQ29kZSk7XG5cblx0aWYgKGRhdGFbXCJvbGFuZ1BsdWdpbnNcIl0pIHtcblx0XHRsZXQgcGx1Z2lucyA9IGRhdGFbXCJvbGFuZ1BsdWdpbnNcIl0uc3BsaXQoXCJ8XCIpO1xuXHRcdGRhdGEgICAgICAgID0gcnVuUGx1Z2lucyhwbHVnaW5zLCBkYXRhLCBsYW5nQ29kZSk7XG5cdH1cblxuXHRpZiAodGV4dCAhPT0gdW5kZWZpbmVkKSB7XG5cblx0XHRpZiAoTEFOR19SRVBMQUNFX1JFRy50ZXN0KHRleHQpKSB7XG5cdFx0XHR0ZXh0ID0gcnVuUmVwbGFjZSh0ZXh0LCBkYXRhLCBsYW5nQ29kZSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRleHQ7XG5cdH1cblxuXHRyZXR1cm4gbGFuZ0tleTtcbn07XG5cbmxldCBwb3J0aW9uUmVwbGFjZXIgPSBmdW5jdGlvbiAodGV4dDogc3RyaW5nLCBsYW5nQ29kZTogc3RyaW5nKTogc3RyaW5nIHtcblx0aWYgKExBTkdfUE9SVElPTl9DT1BZX1JFRy50ZXN0KHRleHQpKSB7XG5cdFx0dGV4dCA9IHRleHQucmVwbGFjZShMQU5HX1BPUlRJT05fQ09QWV9SRUcsIGZ1bmN0aW9uICh0ZXh0LCBwKSB7XG5cdFx0XHRyZXR1cm4gT1dlYkxhbmcuZ2V0TGFuZ1RleHQocCwgbGFuZ0NvZGUpO1xuXHRcdH0pO1xuXHR9XG5cblx0cmV0dXJuIHRleHQ7XG59O1xuXG5sZXQgbG9hZExhbmdGaWxlcyA9IGZ1bmN0aW9uICgpIHtcblx0bGV0IGxhbmdfY29kZXMgICAgICAgICAgICAgICAgICAgICAgICAgPSBPYmplY3Qua2V5cyhMQU5HX09CSkVDVCk7XG5cdGxldCBzb3VyY2VzICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gT2JqZWN0LmtleXMoTEFOR19ESVJFQ1RPUklFUyk7XG5cdGxldCBzb3VyY2VzX2J1bmRsZTogQXJyYXk8dFNjcmlwdEZpbGU+ID0gW107XG5cblx0bGFuZ19jb2Rlcy5mb3JFYWNoKGZ1bmN0aW9uIChsYW5nQ29kZSkge1xuXHRcdHNvdXJjZXMuZm9yRWFjaChmdW5jdGlvbiAocGF0aCkge1xuXHRcdFx0c291cmNlc19idW5kbGUucHVzaChbcGF0aCArIGxhbmdDb2RlICsgXCIuanNcIl0pO1xuXHRcdH0pO1xuXHR9KTtcblxuXHRpZiAoc291cmNlc19idW5kbGUubGVuZ3RoKSB7XG5cdFx0c2NyaXB0TG9hZGVyLmJhdGNoTG9hZChzb3VyY2VzX2J1bmRsZSwgKHN1Y2Nlc3M6IGJvb2xlYW4sIGRvbmUsIGZhaWxlZCkgPT4ge1xuXHRcdFx0Ly8gYXQgbGVhc3Qgb25lIHNob3VsZCBiZSBsb2FkZWRcblx0XHRcdGlmIChkb25lLmxlbmd0aCkge1xuXHRcdFx0XHRPV2ViTGFuZy51cGRhdGVBbGwoKTtcblx0XHRcdH1cblx0XHRcdGlmIChmYWlsZWQubGVuZ3RoKSB7XG5cdFx0XHRcdGNvbnNvbGUud2FybihcIltPV2ViTGFuZ10gZmFpbCB0byBsb2FkIGxhbmcgZmlsZXMgLT5cIiwgZmFpbGVkKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fVxufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT1dlYkxhbmcge1xuXG5cdHN0YXRpYyB1cGRhdGUoZWxlOiBIVE1MRWxlbWVudCwgaGFuZGxlcj86IEZ1bmN0aW9uLCBjb250ZXh0PzogYW55KSB7XG5cdFx0bGV0ICRlbGUgICAgICAgICAgID0gJChlbGUpLFxuXHRcdFx0dHJhbnNsYXRlZFRleHQgPSBudWxsLFxuXHRcdFx0bGFuZ0tleSAgICAgICAgPSAkZWxlLmRhdGEoXCJvbGFuZ1wiKSxcblx0XHRcdGxhbmdDb2RlICAgICAgID0gJGVsZS5kYXRhKFwib2xhbmdDb2RlXCIpIHx8IExBTkdfREVGQVVMVCxcblx0XHRcdHRpdGxlS2V5ICAgICAgID0gJGVsZS5kYXRhKFwib2xhbmdUaXRsZVwiKSxcblx0XHRcdHBsYWNlaG9sZGVyS2V5ID0gJGVsZS5kYXRhKFwib2xhbmdQbGFjZWhvbGRlclwiKSxcblx0XHRcdGxhbmdEYXRhICAgICAgID0gJGVsZS5kYXRhKFwib2xhbmdEYXRhXCIpIHx8ICRlbGUuZGF0YSgpO1xuXG5cdFx0aWYgKExBTkdfT0JKRUNUW2xhbmdDb2RlXSkge1xuXHRcdFx0aWYgKGxhbmdLZXkgIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHR0cmFuc2xhdGVkVGV4dCA9IHRyYW5zbGF0ZShsYW5nS2V5LCBsYW5nRGF0YSwgbGFuZ0NvZGUpO1xuXG5cdFx0XHRcdGlmIChVdGlscy5pc0Z1bmN0aW9uKGhhbmRsZXIpKSB7XG5cdFx0XHRcdFx0aGFuZGxlci5jYWxsKGNvbnRleHQsIHRyYW5zbGF0ZWRUZXh0KTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRsZXQgdGFnID0gZWxlLm5vZGVOYW1lO1xuXG5cdFx0XHRcdFx0aWYgKCFMQU5HX1ZBTFVFX1RBR19SRUcudGVzdCh0YWcpKSB7XG5cdFx0XHRcdFx0XHRlbGUuaW5uZXJIVE1MID0gdHJhbnNsYXRlZFRleHQ7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdGVsZS5zZXRBdHRyaWJ1dGUoXCJ2YWx1ZVwiLCB0cmFuc2xhdGVkVGV4dCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdGlmICh0aXRsZUtleSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdGVsZS5zZXRBdHRyaWJ1dGUoXCJ0aXRsZVwiLCB0cmFuc2xhdGUodGl0bGVLZXksIGxhbmdEYXRhLCBsYW5nQ29kZSkpO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAocGxhY2Vob2xkZXJLZXkgIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHRlbGUuc2V0QXR0cmlidXRlKFwicGxhY2Vob2xkZXJcIiwgdHJhbnNsYXRlKHBsYWNlaG9sZGVyS2V5LCBsYW5nRGF0YSwgbGFuZ0NvZGUpKTtcblx0XHRcdH1cblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc29sZS53YXJuKGBbT1dlYkxhbmddIHBsZWFzZSB3YWl0IHdoaWxlIHRoZSBsYW5nIFwiJHtsYW5nQ29kZX1cIiBpcyBsb2FkZWQuLi5gKTtcblx0XHR9XG5cdH1cblxuXHRzdGF0aWMgc2V0TGFuZ0RhdGEobGFuZ0NvZGU6IHN0cmluZywgZGF0YTogdExhbmdEZWZpbml0aW9uKSB7XG5cblx0XHRpZiAoIVV0aWxzLmlzU3RyaW5nKGxhbmdDb2RlKSkge1xuXHRcdFx0dGhyb3cgbmV3IFR5cGVFcnJvcihcIltPV2ViTGFuZ10geW91ciBsYW5nIG5hbWUgc2hvdWxkIGJlIGEgdmFsaWQgc3RyaW5nLlwiKTtcblx0XHR9XG5cblx0XHRpZiAoIVV0aWxzLmlzUGxhaW5PYmplY3QoZGF0YSkpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoXCJbT1dlYkxhbmddIHlvdXIgbGFuZyBkYXRhIHNob3VsZCBiZSBhIHZhbGlkIHBsYWluIG9iamVjdC5cIik7XG5cdFx0fVxuXG5cdFx0TEFOR19PQkpFQ1RbbGFuZ0NvZGVdID0gVXRpbHMuYXNzaWduKExBTkdfT0JKRUNUW2xhbmdDb2RlXSB8fCB7fSwgZGF0YSk7XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHN0YXRpYyBnZXRMYW5nVGV4dCh0ZXh0S2V5OiBzdHJpbmcsIGxhbmdDb2RlOiBzdHJpbmcpOiBhbnkge1xuXHRcdGlmIChMQU5HX09CSkVDVFtsYW5nQ29kZV0pIHtcblx0XHRcdHJldHVybiBwb3J0aW9uUmVwbGFjZXIoTEFOR19PQkpFQ1RbbGFuZ0NvZGVdW3RleHRLZXldLCBsYW5nQ29kZSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHJldHVybiB1bmRlZmluZWQ7XG5cdFx0fVxuXHR9XG5cblx0c3RhdGljIHNldERlZmF1bHRMYW5nKGxhbmdDb2RlOiBzdHJpbmcpIHtcblx0XHRpZiAoTEFOR19ERUZBVUxUICE9PSBsYW5nQ29kZSkge1xuXG5cdFx0XHRMQU5HX0RFRkFVTFQgPSBsYW5nQ29kZTtcblxuXHRcdFx0aWYgKCFMQU5HX09CSkVDVFtsYW5nQ29kZV0pIHtcblx0XHRcdFx0TEFOR19PQkpFQ1RbbGFuZ0NvZGVdID0ge307XG5cdFx0XHR9XG5cblx0XHRcdGxvYWRMYW5nRmlsZXMoKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHN0YXRpYyBhZGRMYW5nRGlyZWN0b3JpZXMocGF0aDogc3RyaW5nKSB7XG5cdFx0bGV0IGxpc3QgPSBVdGlscy5pc0FycmF5KHBhdGgpID8gcGF0aCA6IFtwYXRoXTtcblxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykge1xuXHRcdFx0aWYgKExBTkdfRElSRUNUT1JJRVNbbGlzdFtpXV0gPT09IHVuZGVmaW5lZCkge1xuXHRcdFx0XHRMQU5HX0RJUkVDVE9SSUVTW2xpc3RbaV1dID0gdHJ1ZTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRsb2FkTGFuZ0ZpbGVzKCk7XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHN0YXRpYyB1cGRhdGVBbGwoKSB7XG5cdFx0KCQoZG9jdW1lbnQuYm9keSkgYXMgYW55KS5vTGFuZ1VwZGF0ZVRyZWUoKTtcblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHN0YXRpYyBhZGRQbHVnaW4obmFtZTogc3RyaW5nLCBmbjogRnVuY3Rpb24pIHtcblx0XHRpZiAoTEFOR19QTFVHSU5TW25hbWVdKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYFtPV2ViTGFuZ10gcGx1Z2luICcke25hbWV9JyBhbHJlYWR5IGRlZmluZWQuYCk7XG5cdFx0fVxuXG5cdFx0TEFOR19QTFVHSU5TW25hbWVdID0gZm47XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHN0YXRpYyB0b0h1bWFuKGxhbmdLZXk6IHN0cmluZywgbGFuZ0RhdGE6IGFueSA9IHt9LCBsYW5nQ29kZTogc3RyaW5nID0gTEFOR19ERUZBVUxUKTogc3RyaW5nIHtcblx0XHRyZXR1cm4gdHJhbnNsYXRlKGxhbmdLZXksIGxhbmdEYXRhLCBsYW5nQ29kZSk7XG5cdH1cbn1cblxuJC5leHRlbmQoJC5mbiwge1xuXHRvTGFuZ0FibGUgICAgICA6IGZ1bmN0aW9uICgpIHtcblx0XHRyZXR1cm4gJCh0aGlzKS5kYXRhKFwib2xhbmdcIikgIT09IHVuZGVmaW5lZFxuXHRcdFx0fHwgJCh0aGlzKS5kYXRhKFwib2xhbmdUaXRsZVwiKSAhPT0gdW5kZWZpbmVkXG5cdFx0XHR8fCAkKHRoaXMpLmRhdGEoXCJvbGFuZ1BsYWNlaG9sZGVyXCIpICE9PSB1bmRlZmluZWRcblx0XHRcdHx8ICQodGhpcykuZGF0YShcIm9sYW5nSGlkZGVuXCIpICE9PSB1bmRlZmluZWQ7XG5cdH0sXG5cdG9MYW5nRGF0YU9iamVjdDogZnVuY3Rpb24gKCkge1xuXHRcdGxldCAkZWxlOiBhbnkgPSAkKHRoaXMpO1xuXG5cdFx0aWYgKCEkZWxlLm9MYW5nQWJsZSgpKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoXCJbT1dlYkxhbmddIHRoZXJlIGlzIG5vIG9sYW5nIGRhdGEgb2JqZWN0LlwiKTtcblx0XHR9XG5cblx0XHRyZXR1cm4ge1xuXHRcdFx0XCJvbGFuZ1wiICAgICAgICAgICA6ICRlbGUuZGF0YShcIm9sYW5nXCIpLFxuXHRcdFx0XCJvbGFuZ1RpdGxlXCIgICAgICA6ICRlbGUuZGF0YShcIm9sYW5nVGl0bGVcIiksXG5cdFx0XHRcIm9sYW5nUGxhY2Vob2xkZXJcIjogJGVsZS5kYXRhKFwib2xhbmdQbGFjZWhvbGRlclwiKSxcblx0XHRcdFwib2xhbmdIaWRkZW5cIiAgICAgOiAkZWxlLmRhdGEoXCJvbGFuZ0hpZGRlblwiKSxcblx0XHRcdFwib2xhbmdEYXRhXCIgICAgICAgOiAkZWxlLmRhdGEoXCJvbGFuZ0RhdGFcIikgfHwgJGVsZS5kYXRhKClcblx0XHR9O1xuXHR9LFxuXHRvTGFuZyAgICAgICAgICA6IGZ1bmN0aW9uICgpIHtcblx0XHRyZXR1cm4gJCh0aGlzKS5lYWNoKGZ1bmN0aW9uICgpIHtcblx0XHRcdE9XZWJMYW5nLnVwZGF0ZSh0aGlzIGFzIGFueSk7XG5cdFx0fSk7XG5cdH0sXG5cdG9MYW5nVXBkYXRlVHJlZTogZnVuY3Rpb24gKCkge1xuXHRcdHJldHVybiAkKHRoaXMpLmZpbmQoXCIqXCIpLmVhY2goZnVuY3Rpb24gKCkge1xuXHRcdFx0bGV0ICRlbGU6IGFueSA9ICQodGhpcyk7XG5cdFx0XHRpZiAoJGVsZS5vTGFuZ0FibGUoKSkge1xuXHRcdFx0XHQkZWxlLm9MYW5nKCk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cbn0pOyJdfQ==