import scriptLoader from "./utils/scriptLoader";
import Utils from "./utils/Utils";
const LANG_PORTION_COPY_REG = /{{\s*([A-Z][A-Z0-9_]+)\s*}}/g, // for {{LANG_KEY}}
LANG_REPLACE_REG = /{\s*(?:([a-zA-Z_]+):)?([a-zA-Z0-9_]+)\s*}/g, // for {variable} and {fn:variable}
LANG_VALUE_TAG_REG = /(INPUT|TEXTAREA)/i;
let LANG_OBJECT = {}, LANG_DEFAULT, LANG_DIRECTORIES = {}, LANG_PLUGINS = {}, LANG_FORMATS_FN_LIST = {
    "file_size": function (size, langCode) {
        let units = OWebLang.getLangText("FILE_SIZE_UNITS", langCode) || ["Kb"], decimal_point = OWebLang.getLangText("NUMBER_DECIMAL_SYMBOL", langCode) || ".", // ',' for french
        sep = OWebLang.getLangText("NUMBER_DIGIT_SEP", langCode) || " ", i_max = units.length, i = 0, ko = 1024, result = 0;
        size = parseFloat(size);
        while (size >= 1 && i < i_max) {
            result = size;
            size /= ko;
            i++;
        }
        if (!i) {
            i = 1;
        }
        let parts = String(result).split(".");
        let head = (parseInt(parts[0]) === result) ? result : Utils.math.numberFormat(result, 2, decimal_point, sep);
        return head + " " + units[i - 1];
    }
};
let runPlugins = (plugins, data, langCode) => {
    let len = plugins.length;
    for (let i = 0; i < len; i++) {
        let plugin = plugins[i], fn = LANG_PLUGINS[plugin];
        if (fn) {
            data = fn(data, langCode);
        }
        else {
            console.error(`[OWebLang] undefined plugins "${plugin}".`);
        }
    }
    return data;
};
let runReplace = (text, data, langCode) => {
    let fnExec = function (name, value, langCode) {
        let fn = LANG_FORMATS_FN_LIST[name];
        if (typeof fn === "function") {
            return fn(value, langCode);
        }
        return value;
    };
    text = text.replace(LANG_REPLACE_REG, (text, fn, variable) => {
        let value = (data || {})[variable];
        if (fn) {
            value = fnExec(fn, value, langCode);
        }
        return value;
    });
    return text;
};
let translate = function (langKey, langData, langCode) {
    let data = langData || {};
    let text = OWebLang.getLangText(langKey, langCode);
    if (data["olangPlugins"]) {
        let plugins = data["olangPlugins"].split("|");
        data = runPlugins(plugins, data, langCode);
    }
    if (text !== undefined) {
        if (LANG_REPLACE_REG.test(text)) {
            text = runReplace(text, data, langCode);
        }
        return text;
    }
    return langKey;
};
let portionReplacer = function (text, langCode) {
    if (LANG_PORTION_COPY_REG.test(text)) {
        text = text.replace(LANG_PORTION_COPY_REG, function (text, p) {
            return OWebLang.getLangText(p, langCode);
        });
    }
    return text;
};
let loadLangFiles = function () {
    let lang_codes = Object.keys(LANG_OBJECT);
    let sources = Object.keys(LANG_DIRECTORIES);
    let sources_bundle = [];
    lang_codes.forEach(function (langCode) {
        sources.forEach(function (path) {
            sources_bundle.push([path + langCode + ".js"]);
        });
    });
    if (sources_bundle.length) {
        scriptLoader.batchLoad(sources_bundle, (success, done, failed) => {
            // at least one should be loaded
            if (done.length) {
                OWebLang.updateAll();
            }
            if (failed.length) {
                console.warn("[OWebLang] fail to load lang files ->", failed);
            }
        });
    }
};
export default class OWebLang {
    static update(ele, handler, context) {
        let $ele = $(ele), translatedText = null, langKey = $ele.data("olang"), langCode = $ele.data("olangCode") || LANG_DEFAULT, titleKey = $ele.data("olangTitle"), placeholderKey = $ele.data("olangPlaceholder"), langData = $ele.data("olangData") || $ele.data();
        if (LANG_OBJECT[langCode]) {
            if (langKey !== undefined) {
                translatedText = translate(langKey, langData, langCode);
                if (Utils.isFunction(handler)) {
                    handler.call(context, translatedText);
                }
                else {
                    let tag = ele.nodeName;
                    if (!LANG_VALUE_TAG_REG.test(tag)) {
                        ele.innerHTML = translatedText;
                    }
                    else {
                        ele.setAttribute("value", translatedText);
                    }
                }
            }
            if (titleKey !== undefined) {
                ele.setAttribute("title", translate(titleKey, langData, langCode));
            }
            if (placeholderKey !== undefined) {
                ele.setAttribute("placeholder", translate(placeholderKey, langData, langCode));
            }
        }
        else {
            console.warn(`[OWebLang] please wait while the lang "${langCode}" is loaded...`);
        }
    }
    static setLangData(langCode, data) {
        if (!Utils.isString(langCode)) {
            throw new TypeError("[OWebLang] your lang name should be a valid string.");
        }
        if (!Utils.isPlainObject(data)) {
            throw new TypeError("[OWebLang] your lang data should be a valid plain object.");
        }
        LANG_OBJECT[langCode] = Utils.assign(LANG_OBJECT[langCode] || {}, data);
        return this;
    }
    static getLangText(textKey, langCode) {
        if (LANG_OBJECT[langCode]) {
            return portionReplacer(LANG_OBJECT[langCode][textKey], langCode);
        }
        else {
            return undefined;
        }
    }
    static setDefaultLang(langCode) {
        if (LANG_DEFAULT !== langCode) {
            LANG_DEFAULT = langCode;
            if (!LANG_OBJECT[langCode]) {
                LANG_OBJECT[langCode] = {};
            }
            loadLangFiles();
        }
        return this;
    }
    static addLangDirectories(path) {
        let list = Utils.isArray(path) ? path : [path];
        for (let i = 0; i < list.length; i++) {
            if (LANG_DIRECTORIES[list[i]] === undefined) {
                LANG_DIRECTORIES[list[i]] = true;
            }
        }
        loadLangFiles();
        return this;
    }
    static updateAll() {
        $(document.body).oLangUpdateTree();
        return this;
    }
    static addPlugin(name, fn) {
        if (LANG_PLUGINS[name]) {
            throw new Error(`[OWebLang] plugin '${name}' already defined.`);
        }
        LANG_PLUGINS[name] = fn;
        return this;
    }
    static toHuman(langKey, langData = {}, langCode = LANG_DEFAULT) {
        return translate(langKey, langData, langCode);
    }
}
$.extend($.fn, {
    oLangAble: function () {
        return $(this).data("olang") !== undefined
            || $(this).data("olangTitle") !== undefined
            || $(this).data("olangPlaceholder") !== undefined
            || $(this).data("olangHidden") !== undefined;
    },
    oLangDataObject: function () {
        let $ele = $(this);
        if (!$ele.oLangAble()) {
            throw new Error("[OWebLang] there is no olang data object.");
        }
        return {
            "olang": $ele.data("olang"),
            "olangTitle": $ele.data("olangTitle"),
            "olangPlaceholder": $ele.data("olangPlaceholder"),
            "olangHidden": $ele.data("olangHidden"),
            "olangData": $ele.data("olangData") || $ele.data()
        };
    },
    oLang: function () {
        return $(this).each(function () {
            OWebLang.update(this);
        });
    },
    oLangUpdateTree: function () {
        return $(this).find("*").each(function () {
            let $ele = $(this);
            if ($ele.oLangAble()) {
                $ele.oLang();
            }
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkxhbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYkxhbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxZQUEyQixNQUFNLHNCQUFzQixDQUFDO0FBQy9ELE9BQU8sS0FBSyxNQUFNLGVBQWUsQ0FBQztBQUlsQyxNQUNDLHFCQUFxQixHQUFHLDhCQUE4QixFQUFFLG1CQUFtQjtBQUMzRSxnQkFBZ0IsR0FBUSw0Q0FBNEMsRUFBQyxtQ0FBbUM7QUFDeEcsa0JBQWtCLEdBQU0sbUJBQW1CLENBQUM7QUFFN0MsSUFBSSxXQUFXLEdBQXlDLEVBQUUsRUFDekQsWUFBb0IsRUFDcEIsZ0JBQWdCLEdBQW9DLEVBQUUsRUFDdEQsWUFBWSxHQUF3QyxFQUFFLEVBQ3RELG9CQUFvQixHQUFnQztJQUNuRCxXQUFXLEVBQUUsVUFBVSxJQUFTLEVBQUUsUUFBZ0I7UUFDakQsSUFBSSxLQUFLLEdBQVcsUUFBUSxDQUFDLFdBQVcsQ0FBQyxpQkFBaUIsRUFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUM5RSxhQUFhLEdBQUcsUUFBUSxDQUFDLFdBQVcsQ0FBQyx1QkFBdUIsRUFBRSxRQUFRLENBQUMsSUFBSSxHQUFHLEVBQUMsaUJBQWlCO1FBQ2hHLEdBQUcsR0FBYSxRQUFRLENBQUMsV0FBVyxDQUFDLGtCQUFrQixFQUFFLFFBQVEsQ0FBQyxJQUFJLEdBQUcsRUFDekUsS0FBSyxHQUFXLEtBQUssQ0FBQyxNQUFNLEVBQzVCLENBQUMsR0FBZSxDQUFDLEVBQ2pCLEVBQUUsR0FBYyxJQUFJLEVBQ3BCLE1BQU0sR0FBVSxDQUFDLENBQUM7UUFFbkIsSUFBSSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUV4QixPQUFPLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssRUFBRTtZQUM5QixNQUFNLEdBQUcsSUFBSSxDQUFDO1lBQ2QsSUFBSSxJQUFJLEVBQUUsQ0FBQztZQUNYLENB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QUFPLENBQUM7WUFDdEMsWUFBWSxFQUFRLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDO1lBQzNDLGtCQUFrQixFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUM7WUFDakQsYUFBYSxFQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDO1lBQzVDLFdBQVcsRUFBUyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUU7U0FDekQsQ0FBQztJQUNILENBQUM7SUFDRCxLQUFLLEVBQVk7UUFDaEIsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ25CLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBVyxDQUFDLENBQUM7UUFDOUIsQ0FBQyxDQUFDLENBQUM7SUFDSixDQUFDO0lBQ0QsZUFBZSxFQUFFO1FBQ2hCLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDN0IsSUFBSSxJQUFJLEdBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3hCLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRSxFQUFFO2dCQUNyQixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7YUFDYjtRQUNGLENBQUMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztDQUNELENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBzY3JpcHRMb2FkZXIsIHt0U2NyaXB0RmlsZX0gZnJvbSBcIi4vdXRpbHMvc2NyaXB0TG9hZGVyXCI7XG5pbXBvcnQgVXRpbHMgZnJvbSBcIi4vdXRpbHMvVXRpbHNcIjtcblxuZXhwb3J0IHR5cGUgdExhbmdEZWZpbml0aW9uID0geyBba2V5OiBzdHJpbmddOiBhbnkgfTtcblxuY29uc3Rcblx0TEFOR19QT1JUSU9OX0NPUFlfUkVHID0gL3t7XFxzKihbQS1aXVtBLVowLTlfXSspXFxzKn19L2csIC8vIGZvciB7e0xBTkdfS0VZfX1cblx0TEFOR19SRVBMQUNFX1JFRyAgICAgID0gL3tcXHMqKD86KFthLXpBLVpfXSspOik/KFthLXpBLVowLTlfXSspXFxzKn0vZywvLyBmb3Ige3ZhcmlhYmxlfSBhbmQge2ZuOnZhcmlhYmxlfVxuXHRMQU5HX1ZBTFVFX1RBR19SRUcgICAgPSAvKElOUFVUfFRFWFRBUkVBKS9pO1xuXG5sZXQgTEFOR19PQkpFQ1Q6IHsgW2tleTogc3RyaW5nXTogdExhbmdEZWZpbml0aW9uIH0gICA9IHt9LFxuXHRMQU5HX0RFRkFVTFQ6IHN0cmluZyxcblx0TEFOR19ESVJFQ1RPUklFUzogeyBba2V5OiBzdHJpbmddOiBib29sZWFuIH0gICAgICA9IHt9LFxuXHRMQU5HX1BMVUdJTlM6IHsgW2tleTogc3RyaW5nXTogRnVuY3Rpb24gfSAgICAgICAgID0ge30sXG5cdExBTkdfRk9STUFUU19GTl9MSVNUOiB7IFtrZXk6IHN0cmluZ106IEZ1bmN0aW9uIH0gPSB7XG5cdFx0XCJmaWxlX3NpemVcIjogZnVuY3Rpb24gKHNpemU6IGFueSwgbGFuZ0NvZGU6IHN0cmluZykge1xuXHRcdFx0bGV0IHVuaXRzICAgICAgICAgPSBPV2ViTGFuZy5nZXRMYW5nVGV4dChcIkZJTEVfU0laRV9VTklUU1wiLCBsYW5nQ29kZSkgfHwgW1wiS2JcIl0sXG5cdFx0XHRcdGRlY2ltYWxfcG9pbnQgPSBPV2ViTGFuZy5nZXRMYW5nVGV4dChcIk5VTUJFUl9ERUNJTUFMX1NZTUJPTFwiLCBsYW5nQ29kZSkgfHwgXCIuXCIsLy8gJywnIGZvciBmcmVuY2hcblx0XHRcdFx0c2VwICAgICAgICAgICA9IE9XZWJMYW5nLmdldExhbmdUZXh0KFwiTlVNQkVSX0RJR0lUX1NFUFwiLCBsYW5nQ29kZSkgfHwgXCIgXCIsXG5cdFx0XHRcdGlfbWF4ICAgICAgICAgPSB1bml0cy5sZW5ndGgsXG5cdFx0XHRcdGkgICAgICAgICAgICAgPSAwLFxuXHRcdFx0XHRrbyAgICAgICAgICAgID0gMTAyNCxcblx0XHRcdFx0cmVzdWx0ICAgICAgICA9IDA7XG5cblx0XHRcdHNpemUgPSBwYXJzZUZsb2F0KHNpemUpO1xuXG5cdFx0XHR3aGlsZSAoc2l6ZSA+PSAxICYmIGkgPCBpX21heCkge1xuXHRcdFx0XHRyZXN1bHQgPSBzaXplO1xuXHRcdFx0XHRzaXplIC89IGtvO1xuXHRcdFx0XHRpKys7XG5cdFx0XHR9XG5cblx0XHRcdGlmICghaSkge1xuXHRcdFx0XHRpID0gMTtcblx0XHRcdH1cblxuXHRcdFx0bGV0IHBhcnRzID0gU3RyaW5nKHJlc3VsdCkuc3BsaXQoXCIuXCIpO1xuXHRcdFx0bGV0IGhlYWQgID0gKHBhcnNlSW50KHBhcnRzWzBdKSA9PT0gcmVzdWx0KSA/IHJlc3VsdCA6IFV0aWxzLm1hdGgubnVtYmVyRm9ybWF0KHJlc3VsdCwgMiwgZGVjaW1hbF9wb2ludCwgc2VwKTtcblxuXHRcdFx0cmV0dXJuIGhlYWQgKyBcIiBcIiArIHVuaXRzW2kgLSAxXTtcblx0XHR9XG5cdH07XG5cbmxldCBydW5QbHVnaW5zID0gKHBsdWdpbnM6IHN0cmluZywgZGF0YTogYW55LCBsYW5nQ29kZTogc3RyaW5nKTogYW55ID0+IHtcblx0bGV0IGxlbiA9IHBsdWdpbnMubGVuZ3RoO1xuXHRmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7XG5cdFx0bGV0IHBsdWdpbiA9IHBsdWdpbnNbaV0sXG5cdFx0XHRmbiAgICAgPSBMQU5HX1BMVUdJTlNbcGx1Z2luXTtcblxuXHRcdGlmIChmbikge1xuXHRcdFx0ZGF0YSA9IGZuKGRhdGEsIGxhbmdDb2RlKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc29sZS5lcnJvcihgW09XZWJMYW5nXSB1bmRlZmluZWQgcGx1Z2lucyBcIiR7cGx1Z2lufVwiLmApO1xuXHRcdH1cblx0fVxuXG5cdHJldHVybiBkYXRhO1xufTtcblxubGV0IHJ1blJlcGxhY2UgPSAodGV4dDogc3RyaW5nLCBkYXRhOiBhbnksIGxhbmdDb2RlOiBzdHJpbmcpOiBzdHJpbmcgPT4ge1xuXG5cdGxldCBmbkV4ZWMgPSBmdW5jdGlvbiAobmFtZTogc3RyaW5nLCB2YWx1ZTogYW55LCBsYW5nQ29kZTogc3RyaW5nKSB7XG5cdFx0bGV0IGZuID0gTEFOR19GT1JNQVRTX0ZOX0xJU1RbbmFtZV07XG5cblx0XHRpZiAodHlwZW9mIGZuID09PSBcImZ1bmN0aW9uXCIpIHtcblx0XHRcdHJldHVybiBmbih2YWx1ZSwgbGFuZ0NvZGUpO1xuXHRcdH1cblxuXHRcdHJldHVybiB2YWx1ZTtcblx0fTtcblxuXHR0ZXh0ID0gdGV4dC5yZXBsYWNlKExBTkdfUkVQTEFDRV9SRUcsICh0ZXh0LCBmbiwgdmFyaWFibGUpID0+IHtcblx0XHRsZXQgdmFsdWUgPSAoZGF0YSB8fCB7fSlbdmFyaWFibGVdO1xuXG5cdFx0aWYgKGZuKSB7XG5cdFx0XHR2YWx1ZSA9IGZuRXhlYyhmbiwgdmFsdWUsIGxhbmdDb2RlKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdmFsdWU7XG5cdH0pO1xuXG5cdHJldHVybiB0ZXh0O1xufTtcblxubGV0IHRyYW5zbGF0ZSA9IGZ1bmN0aW9uIChsYW5nS2V5OiBzdHJpbmcsIGxhbmdEYXRhOiBhbnksIGxhbmdDb2RlOiBzdHJpbmcpOiBzdHJpbmcge1xuXHRsZXQgZGF0YSA9IGxhbmdEYXRhIHx8IHt9O1xuXHRsZXQgdGV4dCA9IE9XZWJMYW5nLmdldExhbmdUZXh0KGxhbmdLZXksIGxhbmdDb2RlKTtcblxuXHRpZiAoZGF0YVtcIm9sYW5nUGx1Z2luc1wiXSkge1xuXHRcdGxldCBwbHVnaW5zID0gZGF0YVtcIm9sYW5nUGx1Z2luc1wiXS5zcGxpdChcInxcIik7XG5cdFx0ZGF0YSAgICAgICAgPSBydW5QbHVnaW5zKHBsdWdpbnMsIGRhdGEsIGxhbmdDb2RlKTtcblx0fVxuXG5cdGlmICh0ZXh0ICE9PSB1bmRlZmluZWQpIHtcblxuXHRcdGlmIChMQU5HX1JFUExBQ0VfUkVHLnRlc3QodGV4dCkpIHtcblx0XHRcdHRleHQgPSBydW5SZXBsYWNlKHRleHQsIGRhdGEsIGxhbmdDb2RlKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGV4dDtcblx0fVxuXG5cdHJldHVybiBsYW5nS2V5O1xufTtcblxubGV0IHBvcnRpb25SZXBsYWNlciA9IGZ1bmN0aW9uICh0ZXh0OiBzdHJpbmcsIGxhbmdDb2RlOiBzdHJpbmcpOiBzdHJpbmcge1xuXHRpZiAoTEFOR19QT1JUSU9OX0NPUFlfUkVHLnRlc3QodGV4dCkpIHtcblx0XHR0ZXh0ID0gdGV4dC5yZXBsYWNlKExBTkdfUE9SVElPTl9DT1BZX1JFRywgZnVuY3Rpb24gKHRleHQsIHApIHtcblx0XHRcdHJldHVybiBPV2ViTGFuZy5nZXRMYW5nVGV4dChwLCBsYW5nQ29kZSk7XG5cdFx0fSk7XG5cdH1cblxuXHRyZXR1cm4gdGV4dDtcbn07XG5cbmxldCBsb2FkTGFuZ0ZpbGVzID0gZnVuY3Rpb24gKCkge1xuXHRsZXQgbGFuZ19jb2RlcyAgICAgICAgICAgICAgICAgICAgICAgICA9IE9iamVjdC5rZXlzKExBTkdfT0JKRUNUKTtcblx0bGV0IHNvdXJjZXMgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBPYmplY3Qua2V5cyhMQU5HX0RJUkVDVE9SSUVTKTtcblx0bGV0IHNvdXJjZXNfYnVuZGxlOiBBcnJheTx0U2NyaXB0RmlsZT4gPSBbXTtcblxuXHRsYW5nX2NvZGVzLmZvckVhY2goZnVuY3Rpb24gKGxhbmdDb2RlKSB7XG5cdFx0c291cmNlcy5mb3JFYWNoKGZ1bmN0aW9uIChwYXRoKSB7XG5cdFx0XHRzb3VyY2VzX2J1bmRsZS5wdXNoKFtwYXRoICsgbGFuZ0NvZGUgKyBcIi5qc1wiXSk7XG5cdFx0fSk7XG5cdH0pO1xuXG5cdGlmIChzb3VyY2VzX2J1bmRsZS5sZW5ndGgpIHtcblx0XHRzY3JpcHRMb2FkZXIuYmF0Y2hMb2FkKHNvdXJjZXNfYnVuZGxlLCAoc3VjY2VzczogYm9vbGVhbiwgZG9uZSwgZmFpbGVkKSA9PiB7XG5cdFx0XHQvLyBhdCBsZWFzdCBvbmUgc2hvdWxkIGJlIGxvYWRlZFxuXHRcdFx0aWYgKGRvbmUubGVuZ3RoKSB7XG5cdFx0XHRcdE9XZWJMYW5nLnVwZGF0ZUFsbCgpO1xuXHRcdFx0fVxuXHRcdFx0aWYgKGZhaWxlZC5sZW5ndGgpIHtcblx0XHRcdFx0Y29uc29sZS53YXJuKFwiW09XZWJMYW5nXSBmYWlsIHRvIGxvYWQgbGFuZyBmaWxlcyAtPlwiLCBmYWlsZWQpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViTGFuZyB7XG5cblx0c3RhdGljIHVwZGF0ZShlbGU6IEhUTUxFbGVtZW50LCBoYW5kbGVyPzogRnVuY3Rpb24sIGNvbnRleHQ/OiBhbnkpIHtcblx0XHRsZXQgJGVsZSAgICAgICAgICAgPSAkKGVsZSksXG5cdFx0XHR0cmFuc2xhdGVkVGV4dCA9IG51bGwsXG5cdFx0XHRsYW5nS2V5ICAgICAgICA9ICRlbGUuZGF0YShcIm9sYW5nXCIpLFxuXHRcdFx0bGFuZ0NvZGUgICAgICAgPSAkZWxlLmRhdGEoXCJvbGFuZ0NvZGVcIikgfHwgTEFOR19ERUZBVUxULFxuXHRcdFx0dGl0bGVLZXkgICAgICAgPSAkZWxlLmRhdGEoXCJvbGFuZ1RpdGxlXCIpLFxuXHRcdFx0cGxhY2Vob2xkZXJLZXkgPSAkZWxlLmRhdGEoXCJvbGFuZ1BsYWNlaG9sZGVyXCIpLFxuXHRcdFx0bGFuZ0RhdGEgICAgICAgPSAkZWxlLmRhdGEoXCJvbGFuZ0RhdGFcIikgfHwgJGVsZS5kYXRhKCk7XG5cblx0XHRpZiAoTEFOR19PQkpFQ1RbbGFuZ0NvZGVdKSB7XG5cdFx0XHRpZiAobGFuZ0tleSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdHRyYW5zbGF0ZWRUZXh0ID0gdHJhbnNsYXRlKGxhbmdLZXksIGxhbmdEYXRhLCBsYW5nQ29kZSk7XG5cblx0XHRcdFx0aWYgKFV0aWxzLmlzRnVuY3Rpb24oaGFuZGxlcikpIHtcblx0XHRcdFx0XHRoYW5kbGVyLmNhbGwoY29udGV4dCwgdHJhbnNsYXRlZFRleHQpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdGxldCB0YWcgPSBlbGUubm9kZU5hbWU7XG5cblx0XHRcdFx0XHRpZiAoIUxBTkdfVkFMVUVfVEFHX1JFRy50ZXN0KHRhZykpIHtcblx0XHRcdFx0XHRcdGVsZS5pbm5lckhUTUwgPSB0cmFuc2xhdGVkVGV4dDtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0ZWxlLnNldEF0dHJpYnV0ZShcInZhbHVlXCIsIHRyYW5zbGF0ZWRUZXh0KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0aWYgKHRpdGxlS2V5ICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0ZWxlLnNldEF0dHJpYnV0ZShcInRpdGxlXCIsIHRyYW5zbGF0ZSh0aXRsZUtleSwgbGFuZ0RhdGEsIGxhbmdDb2RlKSk7XG5cdFx0XHR9XG5cblx0XHRcdGlmIChwbGFjZWhvbGRlcktleSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdGVsZS5zZXRBdHRyaWJ1dGUoXCJwbGFjZWhvbGRlclwiLCB0cmFuc2xhdGUocGxhY2Vob2xkZXJLZXksIGxhbmdEYXRhLCBsYW5nQ29kZSkpO1xuXHRcdFx0fVxuXHRcdH0gZWxzZSB7XG5cdFx0XHRjb25zb2xlLndhcm4oYFtPV2ViTGFuZ10gcGxlYXNlIHdhaXQgd2hpbGUgdGhlIGxhbmcgXCIke2xhbmdDb2RlfVwiIGlzIGxvYWRlZC4uLmApO1xuXHRcdH1cblx0fVxuXG5cdHN0YXRpYyBzZXRMYW5nRGF0YShsYW5nQ29kZTogc3RyaW5nLCBkYXRhOiB0TGFuZ0RlZmluaXRpb24pIHtcblxuXHRcdGlmICghVXRpbHMuaXNTdHJpbmcobGFuZ0NvZGUpKSB7XG5cdFx0XHR0aHJvdyBuZXcgVHlwZUVycm9yKFwiW09XZWJMYW5nXSB5b3VyIGxhbmcgbmFtZSBzaG91bGQgYmUgYSB2YWxpZCBzdHJpbmcuXCIpO1xuXHRcdH1cblxuXHRcdGlmICghVXRpbHMuaXNQbGFpbk9iamVjdChkYXRhKSkge1xuXHRcdFx0dGhyb3cgbmV3IFR5cGVFcnJvcihcIltPV2ViTGFuZ10geW91ciBsYW5nIGRhdGEgc2hvdWxkIGJlIGEgdmFsaWQgcGxhaW4gb2JqZWN0LlwiKTtcblx0XHR9XG5cblx0XHRMQU5HX09CSkVDVFtsYW5nQ29kZV0gPSBVdGlscy5hc3NpZ24oTEFOR19PQkpFQ1RbbGFuZ0NvZGVdIHx8IHt9LCBkYXRhKTtcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0c3RhdGljIGdldExhbmdUZXh0KHRleHRLZXk6IHN0cmluZywgbGFuZ0NvZGU6IHN0cmluZyk6IGFueSB7XG5cdFx0aWYgKExBTkdfT0JKRUNUW2xhbmdDb2RlXSkge1xuXHRcdFx0cmV0dXJuIHBvcnRpb25SZXBsYWNlcihMQU5HX09CSkVDVFtsYW5nQ29kZV1bdGV4dEtleV0sIGxhbmdDb2RlKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0cmV0dXJuIHVuZGVmaW5lZDtcblx0XHR9XG5cdH1cblxuXHRzdGF0aWMgc2V0RGVmYXVsdExhbmcobGFuZ0NvZGU6IHN0cmluZykge1xuXHRcdGlmIChMQU5HX0RFRkFVTFQgIT09IGxhbmdDb2RlKSB7XG5cblx0XHRcdExBTkdfREVGQVVMVCA9IGxhbmdDb2RlO1xuXG5cdFx0XHRpZiAoIUxBTkdfT0JKRUNUW2xhbmdDb2RlXSkge1xuXHRcdFx0XHRMQU5HX09CSkVDVFtsYW5nQ29kZV0gPSB7fTtcblx0XHRcdH1cblxuXHRcdFx0bG9hZExhbmdGaWxlcygpO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0c3RhdGljIGFkZExhbmdEaXJlY3RvcmllcyhwYXRoOiBzdHJpbmcpIHtcblx0XHRsZXQgbGlzdCA9IFV0aWxzLmlzQXJyYXkocGF0aCkgPyBwYXRoIDogW3BhdGhdO1xuXG5cdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRpZiAoTEFOR19ESVJFQ1RPUklFU1tsaXN0W2ldXSA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdExBTkdfRElSRUNUT1JJRVNbbGlzdFtpXV0gPSB0cnVlO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGxvYWRMYW5nRmlsZXMoKTtcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0c3RhdGljIHVwZGF0ZUFsbCgpIHtcblx0XHQoJChkb2N1bWVudC5ib2R5KSBhcyBhbnkpLm9MYW5nVXBkYXRlVHJlZSgpO1xuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0c3RhdGljIGFkZFBsdWdpbihuYW1lOiBzdHJpbmcsIGZuOiBGdW5jdGlvbikge1xuXHRcdGlmIChMQU5HX1BMVUdJTlNbbmFtZV0pIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihgW09XZWJMYW5nXSBwbHVnaW4gJyR7bmFtZX0nIGFscmVhZHkgZGVmaW5lZC5gKTtcblx0XHR9XG5cblx0XHRMQU5HX1BMVUdJTlNbbmFtZV0gPSBmbjtcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0c3RhdGljIHRvSHVtYW4obGFuZ0tleTogc3RyaW5nLCBsYW5nRGF0YTogYW55ID0ge30sIGxhbmdDb2RlOiBzdHJpbmcgPSBMQU5HX0RFRkFVTFQpOiBzdHJpbmcge1xuXHRcdHJldHVybiB0cmFuc2xhdGUobGFuZ0tleSwgbGFuZ0RhdGEsIGxhbmdDb2RlKTtcblx0fVxufVxuXG4kLmV4dGVuZCgkLmZuLCB7XG5cdG9MYW5nQWJsZSAgICAgIDogZnVuY3Rpb24gKCkge1xuXHRcdHJldHVybiAkKHRoaXMpLmRhdGEoXCJvbGFuZ1wiKSAhPT0gdW5kZWZpbmVkXG5cdFx0XHR8fCAkKHRoaXMpLmRhdGEoXCJvbGFuZ1RpdGxlXCIpICE9PSB1bmRlZmluZWRcblx0XHRcdHx8ICQodGhpcykuZGF0YShcIm9sYW5nUGxhY2Vob2xkZXJcIikgIT09IHVuZGVmaW5lZFxuXHRcdFx0fHwgJCh0aGlzKS5kYXRhKFwib2xhbmdIaWRkZW5cIikgIT09IHVuZGVmaW5lZDtcblx0fSxcblx0b0xhbmdEYXRhT2JqZWN0OiBmdW5jdGlvbiAoKSB7XG5cdFx0bGV0ICRlbGU6IGFueSA9ICQodGhpcyk7XG5cblx0XHRpZiAoISRlbGUub0xhbmdBYmxlKCkpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihcIltPV2ViTGFuZ10gdGhlcmUgaXMgbm8gb2xhbmcgZGF0YSBvYmplY3QuXCIpO1xuXHRcdH1cblxuXHRcdHJldHVybiB7XG5cdFx0XHRcIm9sYW5nXCIgICAgICAgICAgIDogJGVsZS5kYXRhKFwib2xhbmdcIiksXG5cdFx0XHRcIm9sYW5nVGl0bGVcIiAgICAgIDogJGVsZS5kYXRhKFwib2xhbmdUaXRsZVwiKSxcblx0XHRcdFwib2xhbmdQbGFjZWhvbGRlclwiOiAkZWxlLmRhdGEoXCJvbGFuZ1BsYWNlaG9sZGVyXCIpLFxuXHRcdFx0XCJvbGFuZ0hpZGRlblwiICAgICA6ICRlbGUuZGF0YShcIm9sYW5nSGlkZGVuXCIpLFxuXHRcdFx0XCJvbGFuZ0RhdGFcIiAgICAgICA6ICRlbGUuZGF0YShcIm9sYW5nRGF0YVwiKSB8fCAkZWxlLmRhdGEoKVxuXHRcdH07XG5cdH0sXG5cdG9MYW5nICAgICAgICAgIDogZnVuY3Rpb24gKCkge1xuXHRcdHJldHVybiAkKHRoaXMpLmVhY2goZnVuY3Rpb24gKCkge1xuXHRcdFx0T1dlYkxhbmcudXBkYXRlKHRoaXMgYXMgYW55KTtcblx0XHR9KTtcblx0fSxcblx0b0xhbmdVcGRhdGVUcmVlOiBmdW5jdGlvbiAoKSB7XG5cdFx0cmV0dXJuICQodGhpcykuZmluZChcIipcIikuZWFjaChmdW5jdGlvbiAoKSB7XG5cdFx0XHRsZXQgJGVsZTogYW55ID0gJCh0aGlzKTtcblx0XHRcdGlmICgkZWxlLm9MYW5nQWJsZSgpKSB7XG5cdFx0XHRcdCRlbGUub0xhbmcoKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fVxufSk7Il19