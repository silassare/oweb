import { extractFieldLabelText, forEach, isArray, isPlainObject, toArray, } from './utils';
import OWebForm from './OWebForm';
export class OWebFormAdapter {
    validators = Object.create({});
    getFieldValidators(fieldName) {
        return this.validators[fieldName] || [];
    }
    pushFieldValidator(fieldName, validator) {
        if (typeof validator === 'string') {
            const fn = OWebForm.getDeclaredValidator(validator);
            if (!fn) {
                throw new Error(`[OWebFormValidator][OWebFormAdapter] validator "${validator}" is not defined can't set for field "${fieldName}".`);
            }
            validator = fn;
        }
        if (!this.validators[fieldName]) {
            this.validators[fieldName] = [];
        }
        this.validators[fieldName].push(validator);
        return this;
    }
}
export class OFormDOMFormAdapter extends OWebFormAdapter {
    form;
    labels = Object.create({});
    formData;
    constructor(form) {
        super();
        this.form = form;
        if (!form || form.nodeName !== 'FORM') {
            throw new Error('[OWebFormValidator][DOMFormAdapter] a valid form element is required.');
        }
        this.form = form;
        this.formData = new FormData(this.form);
        const fo = this.form.querySelectorAll('[data-oweb-form-v]');
        (isArray(fo) ? fo : toArray(fo)).forEach((field) => {
            const name = field.getAttribute('name'), validator = field.getAttribute('data-oweb-form-v');
            if (name && validator) {
                this.pushFieldValidator(name, validator);
            }
        });
    }
    toFormData(fields = []) {
        const fd = new FormData();
        this.formData.forEach(function (value, name) {
            if (!fields.length || fields.indexOf(name) >= 0) {
                fd.append(name, value);
            }
        });
        return fd;
    }
    getFieldValue(name) {
        return this.formData.get(name);
    }
    setFieldValue(name, value) {
        this.formData.set(name, value);
        return this;
    }
    getFieldsNames() {
        const fieldNames = [];
        toArray(this.form.elements).forEach(function formElementsIterator(el) {
            const entry = el;
            if (entry.name !== undefined && fieldNames.indexOf(entry.name) < 0) {
                fieldNames.push(entry.name);
            }
        });
        return fieldNames;
    }
    getFieldLabel(name) {
        if (!this.labels[name]) {
            this.labels[name] = extractFieldLabelText(this.form, name);
        }
        return this.labels[name];
    }
}
export class OFormObjectAdapter extends OWebFormAdapter {
    labels = Object.create({});
    formObj = Object.create({});
    constructor(form) {
        super();
        if (!isPlainObject(form)) {
            throw new Error('[OWebFormValidator][ObjectFormAdapter] a valid form plain object is required.');
        }
        forEach(form, (field, fieldName) => {
            this.formObj[fieldName] = field.value;
            if (field.validator) {
                this.pushFieldValidator(fieldName, field.validator);
            }
            if (field.label) {
                this.labels[fieldName] = field.label;
            }
        });
    }
    toFormData(fields = []) {
        const fd = new FormData();
        forEach(this.formObj, function (value, name) {
            if (!fields.length || fields.indexOf(name) >= 0) {
                if (isArray(value) || value instanceof FileList) {
                    forEach(value, function (val) {
                        fd.append(name, val);
                    });
                }
                else {
                    fd.append(name, value);
                }
            }
        });
        return fd;
    }
    getFieldValue(name) {
        return this.formObj[name];
    }
    setFieldValue(name, value) {
        this.formObj[name] = value;
        return this;
    }
    getFieldsNames() {
        return Object.keys(this.formObj);
    }
    getFieldLabel(name) {
        if (this.labels[name]) {
            return this.labels[name];
        }
        return name;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkZvcm1BZGFwdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL09XZWJGb3JtQWRhcHRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ04scUJBQXFCLEVBQ3JCLE9BQU8sRUFDUCxPQUFPLEVBQ1AsYUFBYSxFQUNiLE9BQU8sR0FDUCxNQUFNLFNBQVMsQ0FBQztBQUNqQixPQUFPLFFBQXFELE1BQU0sWUFBWSxDQUFDO0FBRy9FLE1BQU0sT0FBZ0IsZUFBZTtJQUMxQixVQUFVLEdBQ25CLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7SUFLbkIsa0JBQWtCLENBQUMsU0FBaUI7UUFDbkMsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUN6QyxDQUFDO0lBUUQsa0JBQWtCLENBQ2pCLFNBQWlCLEVBQ2pCLFNBQW1EO1FBRW5ELElBQUksT0FBTyxTQUFTLEtBQUssUUFBUSxFQUFFO1lBQ2xDLE1BQU0sRUFBRSxHQUFHLFFBQVEsQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNwRCxJQUFJLENBQUMsRUFBRSxFQUFFO2dCQUNSLE1BQU0sSUFBSSxLQUFLLENBQ2QsbURBQW1ELFNBQVMseUNBQXlDLFNBQVMsSUFBSSxDQUNsSCxDQUFDO2FBQ0Y7WUFFRCxTQUFTLEdBQUcsRUFBRSxDQUFDO1NBQ2Y7UUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUNoQyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztTQUNoQztRQUVELElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRTNDLE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztDQXlDRDtBQUVELE1BQU0sT0FBTyxtQkFBb0IsU0FBUSxlQUFlO0lB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QUFPLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxZQUFZLFFBQVEsRUFBRTtvQkFDaEQsT0FBTyxDQUFDLEtBQUssRUFBRSxVQUFVLEdBQUc7d0JBQzNCLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO29CQUN0QixDQUFDLENBQUMsQ0FBQztpQkFDSDtxQkFBTTtvQkFDTixFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztpQkFDdkI7YUFDRDtRQUNGLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxFQUFFLENBQUM7SUFDWCxDQUFDO0lBRUQsYUFBYSxDQUFvQyxJQUFZO1FBQzVELE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQWlCLENBQUM7SUFDM0MsQ0FBQztJQUVELGFBQWEsQ0FBQyxJQUFZLEVBQUUsS0FBNkI7UUFDeEQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUM7UUFDM0IsT0FBTyxJQUFJLENBQUM7SUFDYixDQUFDO0lBRUQsY0FBYztRQUNiLE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELGFBQWEsQ0FBQyxJQUFZO1FBQ3pCLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUN0QixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDekI7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG5cdGV4dHJhY3RGaWVsZExhYmVsVGV4dCxcblx0Zm9yRWFjaCxcblx0aXNBcnJheSxcblx0aXNQbGFpbk9iamVjdCxcblx0dG9BcnJheSxcbn0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgT1dlYkZvcm0sIHsgT1dlYkZvcm1GaWVsZFZhbGlkYXRvciwgT1dlYkZvcm1PcHRpb25zIH0gZnJvbSAnLi9PV2ViRm9ybSc7XG5cbmV4cG9ydCB0eXBlIE9XZWJGb3JtRGF0YUVudHJ5VmFsdWUgPSBGaWxlIHwgc3RyaW5nO1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIE9XZWJGb3JtQWRhcHRlciB7XG5cdHByb3RlY3RlZCB2YWxpZGF0b3JzOiB7IFtrZXk6IHN0cmluZ106IE9XZWJGb3JtRmllbGRWYWxpZGF0b3JbXSB9ID1cblx0XHRPYmplY3QuY3JlYXRlKHt9KTtcblxuXHQvKipcblx0ICogR2V0cyB2YWxpZGF0b3JzIGZvciB0aGUgZmllbGQgd2l0aCB0aGUgZ2l2ZW4gbmFtZS5cblx0ICovXG5cdGdldEZpZWxkVmFsaWRhdG9ycyhmaWVsZE5hbWU6IHN0cmluZyk6IE9XZWJGb3JtRmllbGRWYWxpZGF0b3JbXSB7XG5cdFx0cmV0dXJuIHRoaXMudmFsaWRhdG9yc1tmaWVsZE5hbWVdIHx8IFtdO1xuXHR9XG5cblx0LyoqXG5cdCAqIEFkZHMgdmFsaWRhdG9yIGZvciB0aGUgZmllbGQgd2l0aCB0aGUgZ2l2ZW4gbmFtZS5cblx0ICpcblx0ICogQHBhcmFtIGZpZWxkTmFtZVxuXHQgKiBAcGFyYW0gdmFsaWRhdG9yXG5cdCAqL1xuXHRwdXNoRmllbGRWYWxpZGF0b3IoXG5cdFx0ZmllbGROYW1lOiBzdHJpbmcsXG5cdFx0dmFsaWRhdG9yOiBzdHJpbmcgfCBPV2ViRm9ybUZpZWxkVmFsaWRhdG9yPHVua25vd24+XG5cdCk6IHRoaXMge1xuXHRcdGlmICh0eXBlb2YgdmFsaWRhdG9yID09PSAnc3RyaW5nJykge1xuXHRcdFx0Y29uc3QgZm4gPSBPV2ViRm9ybS5nZXREZWNsYXJlZFZhbGlkYXRvcih2YWxpZGF0b3IpO1xuXHRcdFx0aWYgKCFmbikge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoXG5cdFx0XHRcdFx0YFtPV2ViRm9ybVZhbGlkYXRvcl1bT1dlYkZvcm1BZGFwdGVyXSB2YWxpZGF0b3IgXCIke3ZhbGlkYXRvcn1cIiBpcyBub3QgZGVmaW5lZCBjYW4ndCBzZXQgZm9yIGZpZWxkIFwiJHtmaWVsZE5hbWV9XCIuYFxuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXG5cdFx0XHR2YWxpZGF0b3IgPSBmbjtcblx0XHR9XG5cblx0XHRpZiAoIXRoaXMudmFsaWRhdG9yc1tmaWVsZE5hbWVdKSB7XG5cdFx0XHR0aGlzLnZhbGlkYXRvcnNbZmllbGROYW1lXSA9IFtdO1xuXHRcdH1cblxuXHRcdHRoaXMudmFsaWRhdG9yc1tmaWVsZE5hbWVdLnB1c2godmFsaWRhdG9yKTtcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgZm9ybSBkYXRhLlxuXHQgKiBAcGFyYW0gZmllbGRzIFRoZSBmaWVsZHMgbmFtZSBsaXN0LlxuXHQgKi9cblx0YWJzdHJhY3QgdG9Gb3JtRGF0YShmaWVsZHM6IHN0cmluZ1tdKTogRm9ybURhdGE7XG5cblx0LyoqXG5cdCAqIEdldHMgYSBnaXZlbiBmaWVsZCBuYW1lIHZhbHVlLlxuXHQgKlxuXHQgKiBAcGFyYW0gZmllbGROYW1lXG5cdCAqL1xuXHRhYnN0cmFjdCBnZXRGaWVsZFZhbHVlPFQgPSBudWxsIHwgT1dlYkZvcm1EYXRhRW50cnlWYWx1ZT4oXG5cdFx0ZmllbGROYW1lOiBzdHJpbmdcblx0KTogVDtcblxuXHQvKipcblx0ICogU2V0cyBhIGdpdmVuIGZpZWxkIHZhbHVlLlxuXHQgKlxuXHQgKiBAcGFyYW0gZmllbGROYW1lXG5cdCAqIEBwYXJhbSB2YWx1ZVxuXHQgKi9cblx0YWJzdHJhY3Qgc2V0RmllbGRWYWx1ZShcblx0XHRmaWVsZE5hbWU6IHN0cmluZyxcblx0XHR2YWx1ZTogT1dlYkZvcm1EYXRhRW50cnlWYWx1ZVxuXHQpOiB0aGlzO1xuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIGFsbCBmaWVsZHMgbmFtZXMgbGlzdC5cblx0ICovXG5cdGFic3RyYWN0IGdldEZpZWxkc05hbWVzKCk6IHN0cmluZ1tdO1xuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIGZpZWxkIGxhYmVsLlxuXHQgKlxuXHQgKiBXZSBzZWFyY2ggdGhlIGZpZWxkIGxhYmVsLCBwbGFjZWhvbGRlciBvciB0aXRsZS5cblx0ICpcblx0ICogQHBhcmFtIGZpZWxkTmFtZVxuXHQgKi9cblx0YWJzdHJhY3QgZ2V0RmllbGRMYWJlbChmaWVsZE5hbWU6IHN0cmluZyk6IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIE9Gb3JtRE9NRm9ybUFkYXB0ZXIgZXh0ZW5kcyBPV2ViRm9ybUFkYXB0ZXIge1xuXHRwcml2YXRlIGxhYmVsczogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSA9IE9iamVjdC5jcmVhdGUoe30pO1xuXHRwcml2YXRlIHJlYWRvbmx5IGZvcm1EYXRhOiBGb3JtRGF0YTtcblxuXHRjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGZvcm06IEhUTUxGb3JtRWxlbWVudCkge1xuXHRcdHN1cGVyKCk7XG5cdFx0aWYgKCFmb3JtIHx8IGZvcm0ubm9kZU5hbWUgIT09ICdGT1JNJykge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFxuXHRcdFx0XHQnW09XZWJGb3JtVmFsaWRhdG9yXVtET01Gb3JtQWRhcHRlcl0gYSB2YWxpZCBmb3JtIGVsZW1lbnQgaXMgcmVxdWlyZWQuJ1xuXHRcdFx0KTtcblx0XHR9XG5cdFx0dGhpcy5mb3JtID0gZm9ybTtcblx0XHR0aGlzLmZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKHRoaXMuZm9ybSk7XG5cdFx0Y29uc3QgZm8gPSB0aGlzLmZvcm0ucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtb3dlYi1mb3JtLXZdJyk7IC8vIHJldHVybnMgTm9kZUxpc3Qgbm90IEFycmF5IG9mIG5vZGUgKGV4OiBpbiBGaXJlZm94KVxuXG5cdFx0KGlzQXJyYXkoZm8pID8gZm8gOiB0b0FycmF5KGZvKSkuZm9yRWFjaCgoZmllbGQpID0+IHtcblx0XHRcdGNvbnN0IG5hbWUgPSBmaWVsZC5nZXRBdHRyaWJ1dGUoJ25hbWUnKSxcblx0XHRcdFx0dmFsaWRhdG9yID0gZmllbGQuZ2V0QXR0cmlidXRlKCdkYXRhLW93ZWItZm9ybS12Jyk7XG5cblx0XHRcdGlmIChuYW1lICYmIHZhbGlkYXRvcikge1xuXHRcdFx0XHR0aGlzLnB1c2hGaWVsZFZhbGlkYXRvcihuYW1lLCB2YWxpZGF0b3IpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG5cblx0dG9Gb3JtRGF0YShmaWVsZHM6IHN0cmluZ1tdID0gW10pOiBGb3JtRGF0YSB7XG5cdFx0Y29uc3QgZmQgPSBuZXcgRm9ybURhdGEoKTtcblxuXHRcdHRoaXMuZm9ybURhdGEuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIG5hbWUpIHtcblx0XHRcdGlmICghZmllbGRzLmxlbmd0aCB8fCBmaWVsZHMuaW5kZXhPZihuYW1lKSA+PSAwKSB7XG5cdFx0XHRcdGZkLmFwcGVuZChuYW1lLCB2YWx1ZSk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cblx0XHRyZXR1cm4gZmQ7XG5cdH1cblxuXHRnZXRGaWVsZFZhbHVlPFQgPSBudWxsIHwgT1dlYkZvcm1EYXRhRW50cnlWYWx1ZT4obmFtZTogc3RyaW5nKTogVCB7XG5cdFx0cmV0dXJuIHRoaXMuZm9ybURhdGEuZ2V0KG5hbWUpIGFzIHVua25vd24gYXMgVDtcblx0fVxuXG5cdHNldEZpZWxkVmFsdWUobmFtZTogc3RyaW5nLCB2YWx1ZTogT1dlYkZvcm1EYXRhRW50cnlWYWx1ZSk6IHRoaXMge1xuXHRcdHRoaXMuZm9ybURhdGEuc2V0KG5hbWUsIHZhbHVlKTtcblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdGdldEZpZWxkc05hbWVzKCk6IHN0cmluZ1tdIHtcblx0XHRjb25zdCBmaWVsZE5hbWVzOiBzdHJpbmdbXSA9IFtdO1xuXG5cdFx0dG9BcnJheSh0aGlzLmZvcm0uZWxlbWVudHMpLmZvckVhY2goZnVuY3Rpb24gZm9ybUVsZW1lbnRzSXRlcmF0b3IoZWwpIHtcblx0XHRcdGNvbnN0IGVudHJ5OiBhbnkgPSBlbCBhcyB1bmtub3duO1xuXHRcdFx0aWYgKGVudHJ5Lm5hbWUgIT09IHVuZGVmaW5lZCAmJiBmaWVsZE5hbWVzLmluZGV4T2YoZW50cnkubmFtZSkgPCAwKSB7XG5cdFx0XHRcdGZpZWxkTmFtZXMucHVzaChlbnRyeS5uYW1lKTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdHJldHVybiBmaWVsZE5hbWVzO1xuXHR9XG5cblx0Z2V0RmllbGRMYWJlbChuYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuXHRcdGlmICghdGhpcy5sYWJlbHNbbmFtZV0pIHtcblx0XHRcdHRoaXMubGFiZWxzW25hbWVdID0gZXh0cmFjdEZpZWxkTGFiZWxUZXh0KHRoaXMuZm9ybSwgbmFtZSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMubGFiZWxzW25hbWVdO1xuXHR9XG59XG5cbmV4cG9ydCBjbGFzcyBPRm9ybU9iamVjdEFkYXB0ZXIgZXh0ZW5kcyBPV2ViRm9ybUFkYXB0ZXIge1xuXHRwcml2YXRlIGxhYmVsczogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSA9IE9iamVjdC5jcmVhdGUoe30pO1xuXHRwcml2YXRlIHJlYWRvbmx5IGZvcm1PYmo6IHsgW2tleTogc3RyaW5nXTogT1dlYkZvcm1EYXRhRW50cnlWYWx1ZSB9ID1cblx0XHRPYmplY3QuY3JlYXRlKHt9KTtcblxuXHRjb25zdHJ1Y3Rvcihmb3JtOiBPV2ViRm9ybU9wdGlvbnMpIHtcblx0XHRzdXBlcigpO1xuXHRcdGlmICghaXNQbGFpbk9iamVjdChmb3JtKSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFxuXHRcdFx0XHQnW09XZWJGb3JtVmFsaWRhdG9yXVtPYmplY3RGb3JtQWRhcHRlcl0gYSB2YWxpZCBmb3JtIHBsYWluIG9iamVjdCBpcyByZXF1aXJlZC4nXG5cdFx0XHQpO1xuXHRcdH1cblxuXHRcdGZvckVhY2g8T1dlYkZvcm1PcHRpb25zPihmb3JtLCAoZmllbGQsIGZpZWxkTmFtZSkgPT4ge1xuXHRcdFx0dGhpcy5mb3JtT2JqW2ZpZWxkTmFtZV0gPSBmaWVsZC52YWx1ZTtcblxuXHRcdFx0aWYgKGZpZWxkLnZhbGlkYXRvcikge1xuXHRcdFx0XHR0aGlzLnB1c2hGaWVsZFZhbGlkYXRvcihmaWVsZE5hbWUsIGZpZWxkLnZhbGlkYXRvcik7XG5cdFx0XHR9XG5cblx0XHRcdGlmIChmaWVsZC5sYWJlbCkge1xuXHRcdFx0XHR0aGlzLmxhYmVsc1tmaWVsZE5hbWVdID0gZmllbGQubGFiZWw7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblxuXHR0b0Zvcm1EYXRhKGZpZWxkczogc3RyaW5nW10gPSBbXSk6IEZvcm1EYXRhIHtcblx0XHRjb25zdCBmZCA9IG5ldyBGb3JtRGF0YSgpO1xuXG5cdFx0Zm9yRWFjaCh0aGlzLmZvcm1PYmosIGZ1bmN0aW9uICh2YWx1ZSwgbmFtZSkge1xuXHRcdFx0aWYgKCFmaWVsZHMubGVuZ3RoIHx8IGZpZWxkcy5pbmRleE9mKG5hbWUpID49IDApIHtcblx0XHRcdFx0aWYgKGlzQXJyYXkodmFsdWUpIHx8IHZhbHVlIGluc3RhbmNlb2YgRmlsZUxpc3QpIHtcblx0XHRcdFx0XHRmb3JFYWNoKHZhbHVlLCBmdW5jdGlvbiAodmFsKSB7XG5cdFx0XHRcdFx0XHRmZC5hcHBlbmQobmFtZSwgdmFsKTtcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRmZC5hcHBlbmQobmFtZSwgdmFsdWUpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fSk7XG5cblx0XHRyZXR1cm4gZmQ7XG5cdH1cblxuXHRnZXRGaWVsZFZhbHVlPFQgPSBudWxsIHwgT1dlYkZvcm1EYXRhRW50cnlWYWx1ZT4obmFtZTogc3RyaW5nKTogVCB7XG5cdFx0cmV0dXJuIHRoaXMuZm9ybU9ialtuYW1lXSBhcyB1bmtub3duIGFzIFQ7XG5cdH1cblxuXHRzZXRGaWVsZFZhbHVlKG5hbWU6IHN0cmluZywgdmFsdWU6IE9XZWJGb3JtRGF0YUVudHJ5VmFsdWUpOiB0aGlzIHtcblx0XHR0aGlzLmZvcm1PYmpbbmFtZV0gPSB2YWx1ZTtcblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdGdldEZpZWxkc05hbWVzKCk6IHN0cmluZ1tdIHtcblx0XHRyZXR1cm4gT2JqZWN0LmtleXModGhpcy5mb3JtT2JqKTtcblx0fVxuXG5cdGdldEZpZWxkTGFiZWwobmFtZTogc3RyaW5nKTogc3RyaW5nIHtcblx0XHRpZiAodGhpcy5sYWJlbHNbbmFtZV0pIHtcblx0XHRcdHJldHVybiB0aGlzLmxhYmVsc1tuYW1lXTtcblx0XHR9XG5cblx0XHRyZXR1cm4gbmFtZTtcblx0fVxufVxuIl19