import OWebEvent from './OWebEvent';
import Utils from './utils/Utils';
const ajaxTransport = {
    // FOR GOBL JSON HELPER: WE DO NOT TRUST JQUERY JSON.parse
    converters: {
        'text json': function (a) {
            return JSON.parse(a);
        },
    },
};
const replace_methods = ['PATCH', 'PUT', 'DELETE'];
export default class OWebCom extends OWebEvent {
    constructor(app_context, options) {
        super();
        this.app_context = app_context;
        this._busy = false;
        if (options && !Utils.isPlainObject(options)) {
            throw new TypeError(`[OWebCom] require an 'object' as options not:  ${typeof options}.`);
        }
        this._options = {
            method: 'GET',
            dataType: 'json',
            data: {},
            crossDomain: true,
            badNewsShow: false,
            // increase request timeout for mobile device
            timeout: app_context.isMobileApp() ? 10000 : undefined,
            ...(options || {}),
        };
    }
    /**
     * Prepare the request before sending.
     *
     * @private
     */
    _prepare() {
        let m = this, real_method = m._options.method, api_key_header = this.app_context.configs.get('OZ_API_KEY_HEADER_NAME'), real_method_header = this.app_context.configs.get('OZ_API_REAL_METHOD_HEADER_NAME');
        let headers = (this._options.headers =
            this._options.headers || {});
        headers[api_key_header] = this.app_context.configs.get('OZ_API_KEY');
        // we update request method
        if (~replace_methods.indexOf(real_method)) {
            headers[real_method_header] = real_method;
            this._options.method = 'POST';
        }
        if (this._options.data instanceof FormData) {
            this._options.processData = false;
            this._options.contentType = false;
        }
        // workaround because jqXHR does not expose upload property
        this._options.xhr = function () {
            let xhr = $.ajaxSetup(ajaxTransport).xhr();
            // allow CORS
            xhr.withCredentials = true;
            if (xhr.upload) {
                xhr.upload.addEventListener('progress', (e) => {
                    let percent = 0;
                    let position = e.loaded || e.position; // e.position
                    let total = e.total;
                    if (e.lengthComputable) {
                        percent = Math.floor((position / total) * 100);
                    }
                    m.trigger(OWebCom.EVT_COM_UPLOAD_PROGRESS, [
                        e,
                        position,
                        total,
                        percent,
                    ]);
                }, false);
            }
            return xhr;
        };
    }
    /**
     * Handle server response.
     *
     * > Called only when the connection to the server was successfully established.
     *
     * @param response The server response.
     * @private
     */
    _handleResponse(response) {
        let m = this;
        if (response.stime) {
            m.app_context.user.setSessionExpire(response.stime);
        }
        if (response.error === 0) {
            m.trigger(OWebCom.EVT_COM_REQUEST_SUCCESS, [response, m]);
            m.trigger(OWebCom.EVT_COM_FINISH, [response, m]);
        }
        else {
            if (response.msg === 'OZ_ERROR_YOU_MUST_LOGIN') {
                m.trigger(OWebCom.EVT_COM_REQUEST_ERROR, [response, m]);
                m.app_context.forceLogin();
            }
            else {
                if (m._options.badNewsShow) {
                    m.app_context.view.dialog({
                        type: 'error',
                        text: response.msg,
                        data: response.data,
                    });
                }
                m.trigger(OWebCom.EVT_COM_REQUEST_ERROR, [response, m]);
                m.trigger(OWebCom.EVT_COM_FINISH, [response, m]);
            }
        }
    }
    /**
     * Send request.
     */
    send() {
        let m = this;
        this._prepare();
        if (this._busy) {
            console.warn('[OWebCom] instance is busy ->', m);
            return;
        }
        if (this._options) {
            this._busy = true;
            this._request = $.ajax(m._options)
                .done((response) => {
                m._handleResponse(response);
            })
                .fail((request) => {
                let network_error = !Utils.isPlainObject(request['responseJSON']);
                if (network_error) {
                    console.error('[OWebCom] request network error ->', request);
                    m.trigger(OWebCom.EVT_COM_NETWORK_ERROR, [request, m]);
                }
                else {
                    console.error('[OWebCom] request server error ->', request);
                    m._handleResponse(request['responseJSON']);
                }
            });
        }
    }
    /**
     * Try to abort the current request.
     */
    abort() {
        this._busy = false;
        if (this._request) {
            this._request.abort();
        }
    }
}
OWebCom.SELF = Utils.id();
OWebCom.EVT_COM_REQUEST_SUCCESS = Utils.id();
OWebCom.EVT_COM_REQUEST_ERROR = Utils.id();
OWebCom.EVT_COM_NETWORK_ERROR = Utils.id();
OWebCom.EVT_COM_UPLOAD_PROGRESS = Utils.id();
OWebCom.EVT_COM_FINISH = Utils.id();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkNvbU5ldy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViQ29tTmV3LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sU0FBUyxNQUFNLGFBQWEsQ0FBQztBQUNwQyxPQUFPLEtBQUssTUFBTSxlQUFlLENBQUM7QUEwQmxDLE1BQU0sYUFBYSxHQUFHO0lBQ3JCLDBEQUEwRDtJQUMxRCxVQUFVLEVBQUU7UUFDWCxXQUFXLEVBQUUsVUFBUyxDQUFTO1lBQzlCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN0QixDQUFDO0tBQ0Q7Q0FDRCxDQUFDO0FBRUYsTUFBTSxlQUFlLEdBQUcsQ0FBQyxPQUFPLEVBQUUsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBRW5ELE1BQU0sQ0FBQyxPQUFPLE9BQU8sT0FBUSxTQUFRLFNBQVM7SUFZN0MsWUFBNkIsV0FBb0IsRUFBRSxPQUFvQjtRQUN0RSxLQUFLLEVBQUUsQ0FBQztRQURvQixnQkFBVyxHQUFYLFdBQVcsQ0FBUztRQUh6QyxVQUFLLEdBQVksS0FBSyxDQUFDO1FBTTlCLElBQUksT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUM3QyxNQUFNLElBQUksU0FBUyxDQUNsQixrREFBa0QsT0FBTyxPQUFPLEdBQUcsQ0FDbkUsQ0FBQztTQUNGO1FBRUQsSUFBSSxDQUFDLFFBQVEsR0FBRztZQUNmLE1BQU0sRUFBRSxLQUFLO1lBQ2IsUUFBUSxFQUFFLE1BQU07WUFDaEIsSUFBSSxFQUFFLEVBQUU7WUFDUixXQUFXLEVBQUUsSUFBSTtZQUNqQixXQUFXLEVBQUUsS0FBSztZQUNsQiw2Q0FBNkM7WUFDN0MsT0FBTyxFQUFFLFdBQVcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxTQUFTO1lBQ3RELEdBQUcsQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFD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LEdBQUcsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQ3JDLHNCQUFjLEdBQUcsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IE9XZWJBcHAgZnJvbSAnLi9PV2ViQXBwJztcbmltcG9ydCBPV2ViRXZlbnQgZnJvbSAnLi9PV2ViRXZlbnQnO1xuaW1wb3J0IFV0aWxzIGZyb20gJy4vdXRpbHMvVXRpbHMnO1xuaW1wb3J0IGpxWEhSID0gSlF1ZXJ5LmpxWEhSO1xuXG5leHBvcnQgaW50ZXJmYWNlIGlDb21SZXNwb25zZSB7XG5cdGVycm9yOiBudW1iZXI7XG5cdG1zZzogc3RyaW5nO1xuXHRkYXRhPzogYW55O1xuXHR1dGltZTogbnVtYmVyO1xuXHRzdGltZT86IG51bWJlcjtcblx0bmV0ZXJyb3I/OiBib29sZWFuO1xufVxuXG5leHBvcnQgdHlwZSB0Q29tT3B0aW9ucyA9IHtcblx0dXJsOiBzdHJpbmc7XG5cdG1ldGhvZDogc3RyaW5nO1xuXHR4aHI/OiBhbnk7XG5cdGhlYWRlcnM/OiB7fTtcblx0ZGF0YT86IHt9O1xuXHRkYXRhVHlwZT86IHN0cmluZztcblx0Y3Jvc3NEb21haW4/OiBib29sZWFuO1xuXHRwcm9jZXNzRGF0YT86IGJvb2xlYW47XG5cdGNvbnRlbnRUeXBlPzogYW55O1xuXHRiYWROZXdzU2hvdz86IGJvb2xlYW47XG5cdHRpbWVvdXQ/OiBudW1iZXI7XG59O1xuXG5jb25zdCBhamF4VHJhbnNwb3J0ID0ge1xuXHQvLyBGT1IgR09CTCBKU09OIEhFTFBFUjogV0UgRE8gTk9UIFRSVVNUIEpRVUVSWSBKU09OLnBhcnNlXG5cdGNvbnZlcnRlcnM6IHtcblx0XHQndGV4dCBqc29uJzogZnVuY3Rpb24oYTogc3RyaW5nKSB7XG5cdFx0XHRyZXR1cm4gSlNPTi5wYXJzZShhKTtcblx0XHR9LFxuXHR9LFxufTtcblxuY29uc3QgcmVwbGFjZV9tZXRob2RzID0gWydQQVRDSCcsICdQVVQnLCAnREVMRVRFJ107XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJDb20gZXh0ZW5kcyBPV2ViRXZlbnQge1xuXHRzdGF0aWMgcmVhZG9ubHkgU0VMRiA9IFV0aWxzLmlkKCk7XG5cdHN0YXRpYyByZWFkb25seSBFVlRfQ09NX1JFUVVFU1RfU1VDQ0VTUyA9IFV0aWxzLmlkKCk7XG5cdHN0YXRpYyByZWFkb25seSBFVlRfQ09NX1JFUVVFU1RfRVJST1IgPSBVdGlscy5pZCgpO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9ORVRXT1JLX0VSUk9SID0gVXRpbHMuaWQoKTtcblx0c3RhdGljIHJlYWRvbmx5IEVWVF9DT01fVVBMT0FEX1BST0dSRVNTID0gVXRpbHMuaWQoKTtcblx0c3RhdGljIHJlYWRvbmx5IEVWVF9DT01fRklOSVNIID0gVXRpbHMuaWQoKTtcblxuXHRwcml2YXRlIHJlYWRvbmx5IF9vcHRpb25zOiB0Q29tT3B0aW9ucztcblx0cHJpdmF0ZSBfYnVzeTogYm9vbGVhbiA9IGZhbHNlO1xuXHRwcml2YXRlIF9yZXF1ZXN0PzoganFYSFI7XG5cblx0Y29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhcHBfY29udGV4dDogT1dlYkFwcCwgb3B0aW9uczogdENvbU9wdGlvbnMpIHtcblx0XHRzdXBlcigpO1xuXG5cdFx0aWYgKG9wdGlvbnMgJiYgIVV0aWxzLmlzUGxhaW5PYmplY3Qob3B0aW9ucykpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoXG5cdFx0XHRcdGBbT1dlYkNvbV0gcmVxdWlyZSBhbiAnb2JqZWN0JyBhcyBvcHRpb25zIG5vdDogICR7dHlwZW9mIG9wdGlvbnN9LmBcblx0XHRcdCk7XG5cdFx0fVxuXG5cdFx0dGhpcy5fb3B0aW9ucyA9IHtcblx0XHRcdG1ldGhvZDogJ0dFVCcsXG5cdFx0XHRkYXRhVHlwZTogJ2pzb24nLFxuXHRcdFx0ZGF0YToge30sXG5cdFx0XHRjcm9zc0RvbWFpbjogdHJ1ZSxcblx0XHRcdGJhZE5ld3NTaG93OiBmYWxzZSxcblx0XHRcdC8vIGluY3JlYXNlIHJlcXVlc3QgdGltZW91dCBmb3IgbW9iaWxlIGRldmljZVxuXHRcdFx0dGltZW91dDogYXBwX2NvbnRleHQuaXNNb2JpbGVBcHAoKSA/IDEwMDAwIDogdW5kZWZpbmVkLFxuXHRcdFx0Li4uKG9wdGlvbnMgfHwge30pLFxuXHRcdH07XG5cdH1cblxuXHQvKipcblx0ICogUHJlcGFyZSB0aGUgcmVxdWVzdCBiZWZvcmUgc2VuZGluZy5cblx0ICpcblx0ICogQHByaXZhdGVcblx0ICovXG5cdHByaXZhdGUgX3ByZXBhcmUoKSB7XG5cdFx0bGV0IG0gPSB0aGlzLFxuXHRcdFx0cmVhbF9tZXRob2QgPSBtLl9vcHRpb25zLm1ldGhvZCxcblx0XHRcdGFwaV9rZXlfaGVhZGVyID0gdGhpcy5hcHBfY29udGV4dC5jb25maWdzLmdldChcblx0XHRcdFx0J09aX0FQSV9LRVlfSEVBREVSX05BTUUnXG5cdFx0XHQpLFxuXHRcdFx0cmVhbF9tZXRob2RfaGVhZGVyID0gdGhpcy5hcHBfY29udGV4dC5jb25maWdzLmdldChcblx0XHRcdFx0J09aX0FQSV9SRUFMX01FVEhPRF9IRUFERVJfTkFNRSdcblx0XHRcdCk7XG5cblx0XHRsZXQgaGVhZGVyczogYW55ID0gKHRoaXMuX29wdGlvbnMuaGVhZGVycyA9XG5cdFx0XHR0aGlzLl9vcHRpb25zLmhlYWRlcnMgfHwge30pO1xuXHRcdGhlYWRlcnNbYXBpX2tleV9oZWFkZXJdID0gdGhpcy5hcHBfY29udGV4dC5jb25maWdzLmdldCgnT1pfQVBJX0tFWScpO1xuXG5cdFx0Ly8gd2UgdXBkYXRlIHJlcXVlc3QgbWV0aG9kXG5cdFx0aWYgKH5yZXBsYWNlX21ldGhvZHMuaW5kZXhPZihyZWFsX21ldGhvZCkpIHtcblx0XHRcdGhlYWRlcnNbcmVhbF9tZXRob2RfaGVhZGVyXSA9IHJlYWxfbWV0aG9kO1xuXHRcdFx0dGhpcy5fb3B0aW9ucy5tZXRob2QgPSAnUE9TVCc7XG5cdFx0fVxuXG5cdFx0aWYgKHRoaXMuX29wdGlvbnMuZGF0YSBpbnN0YW5jZW9mIEZvcm1EYXRhKSB7XG5cdFx0XHR0aGlzLl9vcHRpb25zLnByb2Nlc3NEYXRhID0gZmFsc2U7XG5cdFx0XHR0aGlzLl9vcHRpb25zLmNvbnRlbnRUeXBlID0gZmFsc2U7XG5cdFx0fVxuXG5cdFx0Ly8gd29ya2Fyb3VuZCBiZWNhdXNlIGpxWEhSIGRvZXMgbm90IGV4cG9zZSB1cGxvYWQgcHJvcGVydHlcblx0XHR0aGlzLl9vcHRpb25zLnhociA9IGZ1bmN0aW9uKCkge1xuXHRcdFx0bGV0IHhociA9ICQuYWpheFNldHVwKGFqYXhUcmFuc3BvcnQpLnhociEoKTtcblxuXHRcdFx0Ly8gYWxsb3cgQ09SU1xuXHRcdFx0eGhyLndpdGhDcmVkZW50aWFscyA9IHRydWU7XG5cblx0XHRcdGlmICh4aHIudXBsb2FkKSB7XG5cdFx0XHRcdHhoci51cGxvYWQuYWRkRXZlbnRMaXN0ZW5lcihcblx0XHRcdFx0XHQncHJvZ3Jlc3MnLFxuXHRcdFx0XHRcdChlOiBhbnkpID0+IHtcblx0XHRcdFx0XHRcdGxldCBwZXJjZW50ID0gMDtcblx0XHRcdFx0XHRcdGxldCBwb3NpdGlvbiA9IGUubG9hZGVkIHx8IGUucG9zaXRpb247IC8vIGUucG9zaXRpb25cblx0XHRcdFx0XHRcdGxldCB0b3RhbCA9IGUudG90YWw7XG5cblx0XHRcdFx0XHRcdGlmIChlLmxlbmd0aENvbXB1dGFibGUpIHtcblx0XHRcdFx0XHRcdFx0cGVyY2VudCA9IE1hdGguZmxvb3IoKHBvc2l0aW9uIC8gdG90YWwpICogMTAwKTtcblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0bS50cmlnZ2VyKE9XZWJDb20uRVZUX0NPTV9VUExPQURfUFJPR1JFU1MsIFtcblx0XHRcdFx0XHRcdFx0ZSxcblx0XHRcdFx0XHRcdFx0cG9zaXRpb24sXG5cdFx0XHRcdFx0XHRcdHRvdGFsLFxuXHRcdFx0XHRcdFx0XHRwZXJjZW50LFxuXHRcdFx0XHRcdFx0XSk7XG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRmYWxzZVxuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4geGhyO1xuXHRcdH07XG5cdH1cblxuXHQvKipcblx0ICogSGFuZGxlIHNlcnZlciByZXNwb25zZS5cblx0ICpcblx0ICogPiBDYWxsZWQgb25seSB3aGVuIHRoZSBjb25uZWN0aW9uIHRvIHRoZSBzZXJ2ZXIgd2FzIHN1Y2Nlc3NmdWxseSBlc3RhYmxpc2hlZC5cblx0ICpcblx0ICogQHBhcmFtIHJlc3BvbnNlIFRoZSBzZXJ2ZXIgcmVzcG9uc2UuXG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIF9oYW5kbGVSZXNwb25zZShyZXNwb25zZTogaUNvbVJlc3BvbnNlKSB7XG5cdFx0bGV0IG0gPSB0aGlzO1xuXG5cdFx0aWYgKHJlc3BvbnNlLnN0aW1lKSB7XG5cdFx0XHRtLmFwcF9jb250ZXh0LnVzZXIuc2V0U2Vzc2lvbkV4cGlyZShyZXNwb25zZS5zdGltZSk7XG5cdFx0fVxuXG5cdFx0aWYgKHJlc3BvbnNlLmVycm9yID09PSAwKSB7XG5cdFx0XHRtLnRyaWdnZXIoT1dlYkNvbS5FVlRfQ09NX1JFUVVFU1RfU1VDQ0VTUywgW3Jlc3BvbnNlLCBtXSk7XG5cdFx0XHRtLnRyaWdnZXIoT1dlYkNvbS5FVlRfQ09NX0ZJTklTSCwgW3Jlc3BvbnNlLCBtXSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGlmIChyZXNwb25zZS5tc2cgPT09ICdPWl9FUlJPUl9ZT1VfTVVTVF9MT0dJTicpIHtcblx0XHRcdFx0bS50cmlnZ2VyKE9XZWJDb20uRVZUX0NPTV9SRVFVRVNUX0VSUk9SLCBbcmVzcG9uc2UsIG1dKTtcblx0XHRcdFx0bS5hcHBfY29udGV4dC5mb3JjZUxvZ2luKCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRpZiAobS5fb3B0aW9ucy5iYWROZXdzU2hvdykge1xuXHRcdFx0XHRcdG0uYXBwX2NvbnRleHQudmlldy5kaWFsb2coe1xuXHRcdFx0XHRcdFx0dHlwZTogJ2Vycm9yJyxcblx0XHRcdFx0XHRcdHRleHQ6IHJlc3BvbnNlLm1zZyxcblx0XHRcdFx0XHRcdGRhdGE6IHJlc3BvbnNlLmRhdGEsXG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRtLnRyaWdnZXIoT1dlYkNvbS5FVlRfQ09NX1JFUVVFU1RfRVJST1IsIFtyZXNwb25zZSwgbV0pO1xuXHRcdFx0XHRtLnRyaWdnZXIoT1dlYkNvbS5FVlRfQ09NX0ZJTklTSCwgW3Jlc3BvbnNlLCBtXSk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG5cblx0LyoqXG5cdCAqIFNlbmQgcmVxdWVzdC5cblx0ICovXG5cdHNlbmQoKSB7XG5cdFx0bGV0IG0gPSB0aGlzO1xuXHRcdHRoaXMuX3ByZXBhcmUoKTtcblxuXHRcdGlmICh0aGlzLl9idXN5KSB7XG5cdFx0XHRjb25zb2xlLndhcm4oJ1tPV2ViQ29tXSBpbnN0YW5jZSBpcyBidXN5IC0+JywgbSk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0aWYgKHRoaXMuX29wdGlvbnMpIHtcblx0XHRcdHRoaXMuX2J1c3kgPSB0cnVlO1xuXHRcdFx0dGhpcy5fcmVxdWVzdCA9ICQuYWpheChtLl9vcHRpb25zKVxuXHRcdFx0XHQuZG9uZSgocmVzcG9uc2U6IGFueSkgPT4ge1xuXHRcdFx0XHRcdG0uX2hhbmRsZVJlc3BvbnNlKHJlc3BvbnNlKTtcblx0XHRcdFx0fSlcblx0XHRcdFx0LmZhaWwoKHJlcXVlc3Q6IGFueSkgPT4ge1xuXHRcdFx0XHRcdGxldCBuZXR3b3JrX2Vycm9yID0gIVV0aWxzLmlzUGxhaW5PYmplY3QoXG5cdFx0XHRcdFx0XHRyZXF1ZXN0WydyZXNwb25zZUpTT04nXVxuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0aWYgKG5ldHdvcmtfZXJyb3IpIHtcblx0XHRcdFx0XHRcdGNvbnNvbGUuZXJyb3IoXG5cdFx0XHRcdFx0XHRcdCdbT1dlYkNvbV0gcmVxdWVzdCBuZXR3b3JrIGVycm9yIC0+Jyxcblx0XHRcdFx0XHRcdFx0cmVxdWVzdFxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdG0udHJpZ2dlcihPV2ViQ29tLkVWVF9DT01fTkVUV09SS19FUlJPUiwgW3JlcXVlc3QsIG1dKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0Y29uc29sZS5lcnJvcihcblx0XHRcdFx0XHRcdFx0J1tPV2ViQ29tXSByZXF1ZXN0IHNlcnZlciBlcnJvciAtPicsXG5cdFx0XHRcdFx0XHRcdHJlcXVlc3Rcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHRtLl9oYW5kbGVSZXNwb25zZShyZXF1ZXN0WydyZXNwb25zZUpTT04nXSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblx0XHR9XG5cdH1cblxuXHQvKipcblx0ICogVHJ5IHRvIGFib3J0IHRoZSBjdXJyZW50IHJlcXVlc3QuXG5cdCAqL1xuXHRhYm9ydCgpIHtcblx0XHR0aGlzLl9idXN5ID0gZmFsc2U7XG5cdFx0aWYgKHRoaXMuX3JlcXVlc3QpIHtcblx0XHRcdHRoaXMuX3JlcXVlc3QuYWJvcnQoKTtcblx0XHR9XG5cdH1cbn1cbiJdfQ==