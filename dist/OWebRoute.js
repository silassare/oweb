import { escapeRegExp, isArray, isPlainObject, isString } from './utils';
const tokenTypesRegMap = {
    'num': /\d+/.source,
    'alpha': /[a-zA-Z]+/.source,
    'alpha-num': /[a-zA-Z0-9]+/.source,
    'any': /[^/]+/.source,
}, tokenReg = /:([a-z][a-z0-9_]*)/i, stringReg = (str) => new RegExp(escapeRegExp(str)), wrapReg = (str, capture = false) => capture ? '(' + str + ')' : '(?:' + str + ')';
export default class OWebRoute {
    path;
    reg;
    tokens;
    action;
    constructor(path, options, action) {
        if (path instanceof RegExp) {
            this.path = path.toString();
            this.reg = path;
            this.tokens = isArray(options) ? options : [];
        }
        else if (isString(path) && path.length) {
            options = (isPlainObject(options) ? options : {});
            const p = OWebRoute.parseDynamicPath(path, options);
            this.path = path;
            this.reg = p.reg;
            this.tokens = p.tokens;
        }
        else {
            throw new TypeError('[OWebRoute] invalid route path, string or RegExp required.');
        }
        if ('function' !== typeof action) {
            throw new TypeError(`[OWebRoute] invalid action type, got "${typeof action}" instead of "function".`);
        }
        this.action = action;
    }
    isDynamic() {
        return this.reg != null;
    }
    getAction() {
        return this.action;
    }
    is(pathname) {
        return this.reg ? this.reg.test(pathname) : this.path === pathname;
    }
    parse(pathname) {
        if (this.isDynamic()) {
            const founds = String(pathname).match(this.reg);
            if (founds) {
                return this.tokens.reduce((acc, key, index) => {
                    acc[key] = founds[index + 1];
                    return acc;
                }, {});
            }
        }
        return {};
    }
    static parseDynamicPath(path, options) {
        const tokens = [];
        let reg = '', _path = path, match;
        while ((match = tokenReg.exec(_path)) != null) {
            const found = match[0], token = match[1], rule = options[token] || 'any', head = _path.slice(0, match.index);
            if (head.length) {
                reg += wrapReg(stringReg(head).source);
            }
            if (typeof rule === 'string' && rule in tokenTypesRegMap) {
                reg += wrapReg(tokenTypesRegMap[rule], true);
            }
            else if (rule instanceof RegExp) {
                reg += wrapReg(rule.source, true);
            }
            else {
                throw new Error(`Invalid rule for token ':${token}' in path '${path}'`);
            }
            tokens.push(token);
            _path = _path.slice(match.index + found.length);
        }
        if (!reg.length) {
            return {
                reg: null,
                tokens,
            };
        }
        if (_path.length) {
            reg += wrapReg(stringReg(_path).source);
        }
        return {
            reg: new RegExp('^' + reg + '$'),
            tokens,
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlJvdXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL09XZWJSb3V0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsUUFBUSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBR3pFLE1BQU0sZ0JBQWdCLEdBQUc7SUFDdkIsS0FBSyxFQUFFLEtBQUssQ0FBQyxNQUFNO0lBQ25CLE9BQU8sRUFBRSxXQUFXLENBQUMsTUFBTTtJQUMzQixXQUFXLEVBQUUsY0FBYyxDQUFDLE1BQU07SUFDbEMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxNQUFNO0NBQ3JCLEVBQ0QsUUFBUSxHQUFHLHFCQUFxQixFQUNoQyxTQUFTLEdBQUcsQ0FBQyxHQUFXLEVBQUUsRUFBRSxDQUFDLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUMxRCxPQUFPLEdBQUcsQ0FBQyxHQUFXLEVBQUUsT0FBTyxHQUFHLEtBQUssRUFBRSxFQUFFLENBQzFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDO0FBVWhELE1BQU0sQ0FBQyxPQUFPLE9BQU8sU0FBUztJQUNaLElBQUksQ0FBUztJQUNiLEdBQUcsQ0FBZ0I7SUFDNUIsTUFBTSxDQUFXO0lBQ1IsTUFBTSxDQUFlO0lBU3RDLFlBQ0MsSUFBcUIsRUFDckIsT0FBcUMsRUFDckMsTUFBb0I7UUFFcEIsSUFBSSxJQUFJLFlBQVksTUFBTSxFQUFFO1lBQzNCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQzVCLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDO1lBQ2hCLElBQUksQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxP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QUFJLElBQUksSUFBSSxnQkFBZ0IsRUFBRTtnQkFDekQsR0FBRyxJQUFJLE9BQU8sQ0FBRSxnQkFBd0IsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQzthQUN0RDtpQkFBTSxJQUFJLElBQUksWUFBWSxNQUFNLEVBQUU7Z0JBQ2xDLEdBQUcsSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQzthQUNsQztpQkFBTTtnQkFDTixNQUFNLElBQUksS0FBSyxDQUFDLDRCQUE0QixLQUFLLGNBQWMsSUFBSSxHQUFHLENBQUMsQ0FBQzthQUN4RTtZQUVELE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFbkIsS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDaEQ7UUFFRCxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRTtZQUNoQixPQUFPO2dCQUNOLEdBQUcsRUFBRSxJQUFJO2dCQUNULE1BQU07YUFDTixDQUFDO1NBQ0Y7UUFFRCxJQUFJLEtBQUssQ0FBQyxNQUFNLEVBQUU7WUFDakIsR0FBRyxJQUFJLE9BQU8sQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDeEM7UUFFRCxPQUFPO1lBQ04sR0FBRyxFQUFFLElBQUksTUFBTSxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDO1lBQ2hDLE1BQU07U0FDTixDQUFDO0lBQ0gsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXNjYXBlUmVnRXhwLCBpc0FycmF5LCBpc1BsYWluT2JqZWN0LCBpc1N0cmluZyB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IE9XZWJSb3V0ZUNvbnRleHQgZnJvbSAnLi9PV2ViUm91dGVDb250ZXh0JztcblxuY29uc3QgdG9rZW5UeXBlc1JlZ01hcCA9IHtcblx0XHQnbnVtJzogL1xcZCsvLnNvdXJjZSxcblx0XHQnYWxwaGEnOiAvW2EtekEtWl0rLy5zb3VyY2UsXG5cdFx0J2FscGhhLW51bSc6IC9bYS16QS1aMC05XSsvLnNvdXJjZSxcblx0XHQnYW55JzogL1teL10rLy5zb3VyY2UsXG5cdH0sXG5cdHRva2VuUmVnID0gLzooW2Etel1bYS16MC05X10qKS9pLFxuXHRzdHJpbmdSZWcgPSAoc3RyOiBzdHJpbmcpID0+IG5ldyBSZWdFeHAoZXNjYXBlUmVnRXhwKHN0cikpLFxuXHR3cmFwUmVnID0gKHN0cjogc3RyaW5nLCBjYXB0dXJlID0gZmFsc2UpID0+XG5cdFx0Y2FwdHVyZSA/ICcoJyArIHN0ciArICcpJyA6ICcoPzonICsgc3RyICsgJyknO1xuXG5leHBvcnQgdHlwZSBPUm91dGVQYXRoID0gc3RyaW5nIHwgUmVnRXhwO1xuZXhwb3J0IHR5cGUgT1JvdXRlUGF0aE9wdGlvbnMgPSB7XG5cdFtrZXk6IHN0cmluZ106IFJlZ0V4cCB8IGtleW9mIHR5cGVvZiB0b2tlblR5cGVzUmVnTWFwO1xufTtcbmV4cG9ydCB0eXBlIE9Sb3V0ZVRva2VucyA9IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG5leHBvcnQgdHlwZSBPUm91dGVBY3Rpb24gPSAoY3R4OiBPV2ViUm91dGVDb250ZXh0KSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgT1JvdXRlSW5mbyA9IHsgcmVnOiBSZWdFeHAgfCBudWxsOyB0b2tlbnM6IHN0cmluZ1tdIH07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJSb3V0ZSB7XG5cdHByaXZhdGUgcmVhZG9ubHkgcGF0aDogc3RyaW5nO1xuXHRwcml2YXRlIHJlYWRvbmx5IHJlZzogUmVnRXhwIHwgbnVsbDtcblx0cHJpdmF0ZSB0b2tlbnM6IHN0cmluZ1tdO1xuXHRwcml2YXRlIHJlYWRvbmx5IGFjdGlvbjogT1JvdXRlQWN0aW9uO1xuXG5cdC8qKlxuXHQgKiBPV2ViUm91dGUgQ29uc3RydWN0b3IuXG5cdCAqXG5cdCAqIEBwYXJhbSBwYXRoIFRoZSByb3V0ZSBwYXRoIHN0cmluZyBvciByZWdleHAuXG5cdCAqIEBwYXJhbSBvcHRpb25zIFRoZSByb3V0ZSBvcHRpb25zLlxuXHQgKiBAcGFyYW0gYWN0aW9uIFRoZSByb3V0ZSBhY3Rpb24gZnVuY3Rpb24uXG5cdCAqL1xuXHRjb25zdHJ1Y3Rvcihcblx0XHRwYXRoOiBzdHJpbmcgfCBSZWdFeHAsXG5cdFx0b3B0aW9uczogT1JvdXRlUGF0aE9wdGlvbnMgfCBzdHJpbmdbXSxcblx0XHRhY3Rpb246IE9Sb3V0ZUFjdGlvblxuXHQpIHtcblx0XHRpZiAocGF0aCBpbnN0YW5jZW9mIFJlZ0V4cCkge1xuXHRcdFx0dGhpcy5wYXRoID0gcGF0aC50b1N0cmluZygpO1xuXHRcdFx0dGhpcy5yZWcgPSBwYXRoO1xuXHRcdFx0dGhpcy50b2tlbnMgPSBpc0FycmF5KG9wdGlvbnMpID8gb3B0aW9ucyA6IFtdO1xuXHRcdH0gZWxzZSBpZiAoaXNTdHJpbmcocGF0aCkgJiYgcGF0aC5sZW5ndGgpIHtcblx0XHRcdG9wdGlvbnMgPSAoaXNQbGFpbk9iamVjdChvcHRpb25zKSA/IG9wdGlvbnMgOiB7fSkgYXMgT1JvdXRlUGF0aE9wdGlvbnM7XG5cdFx0XHRjb25zdCBwID0gT1dlYlJvdXRlLnBhcnNlRHluYW1pY1BhdGgocGF0aCwgb3B0aW9ucyk7XG5cdFx0XHR0aGlzLnBhdGggPSBwYXRoO1xuXHRcdFx0dGhpcy5yZWcgPSBwLnJlZztcblx0XHRcdHRoaXMudG9rZW5zID0gcC50b2tlbnM7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoXG5cdFx0XHRcdCdbT1dlYlJvdXRlXSBpbnZhbGlkIHJvdXRlIHBhdGgsIHN0cmluZyBvciBSZWdFeHAgcmVxdWlyZWQuJ1xuXHRcdFx0KTtcblx0XHR9XG5cblx0XHRpZiAoJ2Z1bmN0aW9uJyAhPT0gdHlwZW9mIGFjdGlvbikge1xuXHRcdFx0dGhyb3cgbmV3IFR5cGVFcnJvcihcblx0XHRcdFx0YFtPV2ViUm91dGVdIGludmFsaWQgYWN0aW9uIHR5cGUsIGdvdCBcIiR7dHlwZW9mIGFjdGlvbn1cIiBpbnN0ZWFkIG9mIFwiZnVuY3Rpb25cIi5gXG5cdFx0XHQpO1xuXHRcdH1cblxuXHRcdHRoaXMuYWN0aW9uID0gYWN0aW9uO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgdHJ1ZSBpZiB0aGlzIHJvdXRlIGlzIGR5bmFtaWMgZmFsc2Ugb3RoZXJ3aXNlLlxuXHQgKi9cblx0aXNEeW5hbWljKCk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiB0aGlzLnJlZyAhPSBudWxsO1xuXHR9XG5cblx0LyoqXG5cdCAqIEdldHMgcm91dGUgYWN0aW9uLlxuXHQgKi9cblx0Z2V0QWN0aW9uKCk6IE9Sb3V0ZUFjdGlvbiB7XG5cdFx0cmV0dXJuIHRoaXMuYWN0aW9uO1xuXHR9XG5cblx0LyoqXG5cdCAqIENoZWNrcyBpZiBhIGdpdmVuIHBhdGhuYW1lIG1hdGNoIHRoaXMgcm91dGUuXG5cdCAqXG5cdCAqIEBwYXJhbSBwYXRobmFtZVxuXHQgKi9cblx0aXMocGF0aG5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiB0aGlzLnJlZyA/IHRoaXMucmVnLnRlc3QocGF0aG5hbWUpIDogdGhpcy5wYXRoID09PSBwYXRobmFtZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBQYXJzZSBhIGdpdmVuIHBhdGhuYW1lLlxuXHQgKlxuXHQgKiBAcGFyYW0gcGF0aG5hbWVcblx0ICovXG5cdHBhcnNlKHBhdGhuYW1lOiBzdHJpbmcpOiBPUm91dGVUb2tlbnMge1xuXHRcdGlmICh0aGlzLmlzRHluYW1pYygpKSB7XG5cdFx0XHRjb25zdCBmb3VuZHM6IGFueSA9IFN0cmluZyhwYXRobmFtZSkubWF0Y2godGhpcy5yZWcgYXMgUmVnRXhwKTtcblxuXHRcdFx0aWYgKGZvdW5kcykge1xuXHRcdFx0XHRyZXR1cm4gdGhpcy50b2tlbnMucmVkdWNlKChhY2M6IGFueSwga2V5OiBzdHJpbmcsIGluZGV4OiBudW1iZXIpID0+IHtcblx0XHRcdFx0XHRhY2Nba2V5XSA9IGZvdW5kc1tpbmRleCArIDFdO1xuXHRcdFx0XHRcdHJldHVybiBhY2M7XG5cdFx0XHRcdH0sIHt9KTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4ge307XG5cdH1cblxuXHQvKipcblx0ICogUGFyc2UgZHluYW1pYyBwYXRoIGFuZCByZXR1cm5zIGFwcHJvcHJpYXRlIHJlZ2V4cCBhbmQgdG9rZW5zIGxpc3QuXG5cdCAqXG5cdCAqIGBgYGpzXG5cdCAqIGxldCBmb3JtYXQgPSBcInBhdGgvdG8vOmlkL2ZpbGUvOmluZGV4L25hbWUuOmZvcm1hdFwiO1xuXHQgKiBsZXQgb3B0aW9ucyA9IHtcblx0ICogXHRcdGlkOiBcIm51bVwiLFxuXHQgKiBcdFx0aW5kZXg6IFwiYWxwaGFcIixcblx0ICogXHRcdGZvcm1hdDpcdFwiYWxwaGEtbnVtXCJcblx0ICogfTtcblx0ICogbGV0IGluZm8gPSBwYXJzZUR5bmFtaWNQYXRoKGZvcm1hdCxvcHRpb25zKTtcblx0ICpcblx0ICogaW5mbyA9PT0ge1xuXHQgKiAgICAgcmVnOiBSZWdFeHAsXG5cdCAqICAgICB0b2tlbnM6IFtcImlkXCIsXCJpbmRleFwiLFwiZm9ybWF0XCJdXG5cdCAqIH07XG5cdCAqIGBgYFxuXHQgKiBAcGFyYW0gcGF0aCBUaGUgcGF0aCBmb3JtYXQgc3RyaW5nLlxuXHQgKiBAcGFyYW0gb3B0aW9ucyBUaGUgcGF0aCBvcHRpb25zLlxuXHQgKi9cblx0c3RhdGljIHBhcnNlRHluYW1pY1BhdGgoXG5cdFx0cGF0aDogc3RyaW5nLFxuXHRcdG9wdGlvbnM6IE9Sb3V0ZVBhdGhPcHRpb25zXG5cdCk6IE9Sb3V0ZUluZm8ge1xuXHRcdGNvbnN0IHRva2Vuczogc3RyaW5nW10gPSBbXTtcblx0XHRsZXQgcmVnID0gJycsXG5cdFx0XHRfcGF0aDogc3RyaW5nID0gcGF0aCxcblx0XHRcdG1hdGNoOiBSZWdFeHBFeGVjQXJyYXkgfCBudWxsO1xuXG5cdFx0d2hpbGUgKChtYXRjaCA9IHRva2VuUmVnLmV4ZWMoX3BhdGgpKSAhPSBudWxsKSB7XG5cdFx0XHRjb25zdCBmb3VuZDogYW55ID0gbWF0Y2hbMF0sXG5cdFx0XHRcdHRva2VuOiBhbnkgPSBtYXRjaFsxXSxcblx0XHRcdFx0cnVsZTogYW55ID0gb3B0aW9uc1t0b2tlbl0gfHwgJ2FueScsXG5cdFx0XHRcdGhlYWQ6IHN0cmluZyA9IF9wYXRoLnNsaWNlKDAsIG1hdGNoLmluZGV4KTtcblxuXHRcdFx0aWYgKGhlYWQubGVuZ3RoKSB7XG5cdFx0XHRcdHJlZyArPSB3cmFwUmVnKHN0cmluZ1JlZyhoZWFkKS5zb3VyY2UpO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAodHlwZW9mIHJ1bGUgPT09ICdzdHJpbmcnICYmIHJ1bGUgaW4gdG9rZW5UeXBlc1JlZ01hcCkge1xuXHRcdFx0XHRyZWcgKz0gd3JhcFJlZygodG9rZW5UeXBlc1JlZ01hcCBhcyBhbnkpW3J1bGVdLCB0cnVlKTtcblx0XHRcdH0gZWxzZSBpZiAocnVsZSBpbnN0YW5jZW9mIFJlZ0V4cCkge1xuXHRcdFx0XHRyZWcgKz0gd3JhcFJlZyhydWxlLnNvdXJjZSwgdHJ1ZSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcnVsZSBmb3IgdG9rZW4gJzoke3Rva2VufScgaW4gcGF0aCAnJHtwYXRofSdgKTtcblx0XHRcdH1cblxuXHRcdFx0dG9rZW5zLnB1c2godG9rZW4pO1xuXG5cdFx0XHRfcGF0aCA9IF9wYXRoLnNsaWNlKG1hdGNoLmluZGV4ICsgZm91bmQubGVuZ3RoKTtcblx0XHR9XG5cblx0XHRpZiAoIXJlZy5sZW5ndGgpIHtcblx0XHRcdHJldHVybiB7XG5cdFx0XHRcdHJlZzogbnVsbCxcblx0XHRcdFx0dG9rZW5zLFxuXHRcdFx0fTtcblx0XHR9XG5cblx0XHRpZiAoX3BhdGgubGVuZ3RoKSB7XG5cdFx0XHRyZWcgKz0gd3JhcFJlZyhzdHJpbmdSZWcoX3BhdGgpLnNvdXJjZSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHtcblx0XHRcdHJlZzogbmV3IFJlZ0V4cCgnXicgKyByZWcgKyAnJCcpLFxuXHRcdFx0dG9rZW5zLFxuXHRcdH07XG5cdH1cbn1cbiJdfQ==