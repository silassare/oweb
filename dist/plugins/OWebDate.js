const FORMAT_REG = /(?<!\\)(?:\\\\)*(ms|ss|ii|hh|mm|ll|A|a|s|i|H|h|y|Y|m|F|M|d|l|L|D)/g;
/*
const I18N = {
    OW_TIME_DEFAULT_FORMAT: 'd F Y, hh:ii a',
};
*/
export default class OWebDate {
    _appContext;
    date;
    constructor(_appContext, date = new Date()) {
        this._appContext = _appContext;
        this.date = date;
    }
    /**
     * Format date with a given format.
     *
     * @param format
     */
    format(format = 'OW_TIME_DEFAULT_FORMAT') {
        format = this._appContext.i18n.toHuman(format);
        const o = this.describe();
        return format.replace(FORMAT_REG, function stringChunkReplacer(...args) {
            return o[args[1]];
        });
    }
    fromNow() {
        return this.format(this.compare(this.date, Date.now()).format);
    }
    compare(_startDate, _endDate) {
        const startDate = new Date(_startDate);
        const endDate = new Date(_endDate);
        let format;
        const start = {
            time: startDate.getTime(),
            year: startDate.getFullYear(),
            month: startDate.getMonth(),
            date: startDate.getDate(),
            hour: startDate.getHours(),
            minute: startDate.getMinutes(),
        };
        const end = {
            time: endDate.getTime(),
            year: endDate.getFullYear(),
            month: endDate.getMonth(),
            date: endDate.getDate(),
            hour: endDate.getHours(),
            minute: endDate.getMinutes(),
        };
        const aSecond = 1000;
        const aMinute = 60 * aSecond;
        const anHour = 60 * aMinute;
        const aDay = 24 * anHour;
        const aWeek = 7 * aDay;
        const inPast = start.time > end.time;
        const msCount = Math.abs(start.time - end.time);
        const secondsCount = Math.floor(msCount / aSecond);
        const minutesCount = Math.floor(msCount / aMinute);
        const hoursCount = Math.floor(msCount / anHour);
        const daysCount = Math.floor(msCount / aDay);
        const weeksCount = Math.floor(msCount / aWeek);
        const monthsCount = Math.abs(end.year - start.year) * 12 + (end.month - start.month);
        /*
        const yearsCount  = Math.floor(monthsCount / 12);

         let nSeconds = 0, nMinutes = 0, nHours = 0,
         nYears = yearsCount,
         nMonths = (monthsCount -  (nYears*12));
         */
        if (secondsCount < 5) {
            format = inPast ? 'OW_TIME_JUST_NOW' : 'OW_TIME_IN_FEW_SECONDS';
        }
        else if (secondsCount < 10) {
            format = inPast
                ? 'OW_TIME_FEW_SECONDS_AGO'
                : 'OW_TIME_IN_FEW_SECONDS';
        }
        else if (secondsCount < 55) {
            format = inPast ? 'OW_TIME_N_SECONDS_AGO' : 'OW_TIME_IN_N_SECONDS';
        }
        else if (secondsCount < 60) {
            format = inPast
                ? 'OW_TIME_LESS_THAN_A_MINUTE_AGO'
                : 'OW_TIME_IN_LESS_THAN_A_MINUTE';
        }
        else if (secondsCount < 70) {
            format = inPast
                ? 'OW_TIME_ABOUT_A_MINUTE_AGO'
                : 'OW_TIME_IN_ABOUT_A_MINUTE';
        }
        else if (minutesCount < 55) {
            format = inPast ? 'OW_TIME_N_MINUTES_AGO' : 'OW_TIME_IN_N_MINUTES';
        }
        else if (minutesCount < 70) {
            format = inPast
                ? 'OW_TIME_ABOUT_AN_HOUR_AGO'
                : 'OW_TIME_IN_ABOUT_AN_HOUR';
        }
        else if (hoursCount < 24) {
            format = inPast ? 'OW_TIME_N_HOURS_AGO' : 'OW_TIME_IN_N_HOURS';
        }
        else if (daysCount < 7) {
            format = inPast ? 'OW_TIME_N_DAYS_AGO' : 'OW_TIME_IN_N_DAYS';
        }
        else if (weeksCount < 4) {
            format = inPast ? 'OW_TIME_N_WEEKS_AGO' : 'OW_TIME_IN_N_WEEKS';
        }
        else if (monthsCount < 12) {
            format = inPast ? 'OW_TIME_N_MONTHS_AGO' : 'OW_TIME_IN_N_MONTHS';
        }
        else {
            format = inPast ? 'OW_TIME_N_YEARS_AGO' : 'OW_TIME_IN_N_YEARS';
        }
        return {
            format,
            /*nSeconds,
             nMinutes,
             nHours,
             nDays,
             nYears*/
        };
    }
    /**
     * Returns date description object.
     */
    describe() {
        const i18n = this._appContext.i18n, dayNamesShort = i18n.toHuman('OW_TIME_DAY_NAMES_SHORT').split(','), dayNamesFull = i18n.toHuman('OW_TIME_DAY_NAMES_FULL').split(','), monthNamesShort = i18n
            .toHuman('OW_TIME_MONTH_NAMES_SHORT')
            .split(','), monthNamesFull = i18n
            .toHuman('OW_TIME_MONTH_NAMES_FULL')
            .split(','), date = new Date(this.date), y = date.getYear(), Y = date.getFullYear(), m = date.getMonth(), mm = String(m < 9 ? '0' + (m + 1) : m + 1), d = date.getDate(), l = date.getDay(), ll = l + 1, // l? l : 7,
        L = dayNamesFull[l], D = dayNamesShort[l], M = monthNamesShort[m], F = monthNamesFull[m], H = date.getHours(), h = H === 12 ? 12 : H % 12, hh = String(m <= 9 ? '0' + m : m), i = date.getMinutes(), ii = String(i < 10 ? '0' + i : i), s = date.getSeconds(), ss = String(s < 10 ? '0' + s : s), ms = date.getMilliseconds(), a = H < 12 ? 'am' : 'pm', A = a.toUpperCase();
        return {
            D,
            L,
            l,
            ll,
            d,
            M,
            F,
            m,
            mm,
            Y,
            y,
            h,
            hh,
            H,
            i,
            ii,
            s,
            ss,
            ms,
            a,
            A,
        };
    }
    /**
     * Date setter.
     *
     * @param date
     */
    setDate(date) {
        this.date = new Date(date);
        return this;
    }
    /**
     * Date getter.
     */
    getDate() {
        return this.date;
    }
    /**
     * Returns unix like timestamp.
     */
    static timestamp() {
        return Number(String(Date.now()).slice(0, -3));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkRhdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcGx1Z2lucy9PV2ViRGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFrREEsTUFBTSxVQUFVLEdBQUcsb0VBQW9FLENBQUM7QUFFeEY7Ozs7RUFJRTtBQUNGLE1BQU0sQ0FBQyxPQUFPLE9BQU8sUUFBUTtJQUVuQjtJQUNBO0lBRlQsWUFDUyxXQUFvQixFQUNwQixPQUFtQixJQUFJLElBQUksRUFBRTtRQUQ3QixnQkFBVyxHQUFYLFdBQVcsQ0FBUztRQUNwQixTQUFJLEdBQUosSUFBSSxDQUF5QjtJQUNuQyxDQUFDO0lBRUo7Ozs7T0FJRztJQUNILE1BQU0sQ0FBQyxNQUFNLEdBQUcsd0JBQXdCO1FBQ3ZDLE1BQU0sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFL0MsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBUyxDQUFDO1FBQ2pDLE9BQU8sTUFBTSxDQUFDLE9BQU8sQ0FDcEIsVUFBVSxFQUNWLFNBQVMsbUJBQW1CLENBQUMsR0FBRyxJQUFJO1lBQ25DLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25CLENBQUMsQ0FDRCxDQUFDO0lBQ0gsQ0FBQztJQUVELE9BQU87UUFDTixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2hFLENBQUM7SUFFRCxPQUFPLENBQUMsVUFBc0IsRUFBRSxRQUFvQjtRQUNuRCxNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN2QyxNQUFNLE9BQU8sR0FBRyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNu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QUFJLENBQUMsQ0FBQztRQUMzQixPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7SUFFRDs7T0FFRztJQUNILE9BQU87UUFDTixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDbEIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLFNBQVM7UUFDZixPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDaEQsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBEIFRoZSBkYXkgb2YgdGhlIHdlZWsgc2hvcnQgbmFtZVxuICogTCAgVGhlIGRheSBvZiB0aGUgd2VlayBmdWxsIG5hbWVcbiAqIGwgVGhlIGRheSBvZiB0aGUgd2VlayAwIHRvIDZcbiAqIGxsIFRoZSBkYXkgb2YgdGhlIHdlZWsgMSB0byA3XG4gKiBkIFRoZSBkYXkgb2YgdGhlIG1vbnRoXG4gKiBNIFRoZSBuYW1lIG9mIHRoZSBtb250aCBpbiB0aHJlZSBvciBmb3VyIGxldHRlcnNcbiAqIEYgVGhlIGZ1bGwgbmFtZSBvZiB0aGUgbW9udGhcbiAqIG0gVGhlIG51bWJlciBvZiB0aGUgbW9udGggMCB0byAxMVxuICogbW0gVGhlIG51bWJlciBvZiB0aGUgbW9udGggMDEgdG8gMTJcbiAqIFkgVGhlIHllYXIgaW4gZm91ciBkaWdpdHNcbiAqIHkgVGhlIHllYXIgaW4gdHdvIGRpZ2l0c1xuICogaCBUaGUgaG91ciB1c2luZyAwIHRvIDEyXG4gKiBIIFRoZSBob3VyIHVzaW5nIDAgdG8gMjNcbiAqIGkgVGhlIG1pbnV0ZXMgMCB0byA1OVxuICogcyBUaGUgc2Vjb25kcyAwIHRvIDU5XG4gKiBhIGFtIC8gcG0gRGlzcGxheVxuICogQSBBTSAvIFBNIGRpc3BsYXlcbiAqXG4gKiBpaSBUaGUgbWludXRlcyAwMCwgMDEsLi4uLCA1OVxuICogc3MgVGhlIHNlY29uZHMgMDAsIDAxLC4uLiwgNTlcbiAqIGhoIFRoZSBob3VyIDAxLC4uLiwgMTJcbiAqL1xuaW1wb3J0IE9XZWJBcHAgZnJvbSAnLi4vT1dlYkFwcCc7XG5cbmV4cG9ydCB0eXBlIE9EYXRlVmFsdWUgPSBEYXRlIHwgbnVtYmVyIHwgc3RyaW5nO1xuZXhwb3J0IHR5cGUgT0RhdGVEZXNjID0ge1xuXHREOiBzdHJpbmc7XG5cdEw6IHN0cmluZztcblx0bDogbnVtYmVyO1xuXHRsbDogbnVtYmVyO1xuXHRkOiBudW1iZXI7XG5cdE06IHN0cmluZztcblx0Rjogc3RyaW5nO1xuXHRtOiBudW1iZXI7XG5cdG1tOiBzdHJpbmc7XG5cdFk6IG51bWJlcjtcblx0eTogbnVtYmVyO1xuXHRoOiBudW1iZXI7XG5cdGhoOiBzdHJpbmc7XG5cdEg6IG51bWJlcjtcblx0aTogbnVtYmVyO1xuXHRpaTogc3RyaW5nO1xuXHRzOiBudW1iZXI7XG5cdHNzOiBzdHJpbmc7XG5cdG1zOiBudW1iZXI7XG5cdGE6IHN0cmluZztcblx0QTogc3RyaW5nO1xufTtcblxuY29uc3QgRk9STUFUX1JFRyA9IC8oPzwhXFxcXCkoPzpcXFxcXFxcXCkqKG1zfHNzfGlpfGhofG1tfGxsfEF8YXxzfGl8SHxofHl8WXxtfEZ8TXxkfGx8THxEKS9nO1xuXG4vKlxuY29uc3QgSTE4TiA9IHtcblx0T1dfVElNRV9ERUZBVUxUX0ZPUk1BVDogJ2QgRiBZLCBoaDppaSBhJyxcbn07XG4qL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT1dlYkRhdGUge1xuXHRjb25zdHJ1Y3Rvcihcblx0XHRwcml2YXRlIF9hcHBDb250ZXh0OiBPV2ViQXBwLFxuXHRcdHByaXZhdGUgZGF0ZTogT0RhdGVWYWx1ZSA9IG5ldyBEYXRlKClcblx0KSB7fVxuXG5cdC8qKlxuXHQgKiBGb3JtYXQgZGF0ZSB3aXRoIGEgZ2l2ZW4gZm9ybWF0LlxuXHQgKlxuXHQgKiBAcGFyYW0gZm9ybWF0XG5cdCAqL1xuXHRmb3JtYXQoZm9ybWF0ID0gJ09XX1RJTUVfREVGQVVMVF9GT1JNQVQnKTogc3RyaW5nIHtcblx0XHRmb3JtYXQgPSB0aGlzLl9hcHBDb250ZXh0LmkxOG4udG9IdW1hbihmb3JtYXQpO1xuXG5cdFx0Y29uc3QgbyA9IHRoaXMuZGVzY3JpYmUoKSBhcyBhbnk7XG5cdFx0cmV0dXJuIGZvcm1hdC5yZXBsYWNlKFxuXHRcdFx0Rk9STUFUX1JFRyxcblx0XHRcdGZ1bmN0aW9uIHN0cmluZ0NodW5rUmVwbGFjZXIoLi4uYXJncykge1xuXHRcdFx0XHRyZXR1cm4gb1thcmdzWzFdXTtcblx0XHRcdH1cblx0XHQpO1xuXHR9XG5cblx0ZnJvbU5vdygpOnN0cmluZyB7XG5cdFx0cmV0dXJuIHRoaXMuZm9ybWF0KHRoaXMuY29tcGFyZSh0aGlzLmRhdGUsIERhdGUubm93KCkpLmZvcm1hdCk7XG5cdH1cblxuXHRjb21wYXJlKF9zdGFydERhdGU6IE9EYXRlVmFsdWUsIF9lbmREYXRlOiBPRGF0ZVZhbHVlKTogeyBmb3JtYXQ6IHN0cmluZyB9IHtcblx0XHRjb25zdCBzdGFydERhdGUgPSBuZXcgRGF0ZShfc3RhcnREYXRlKTtcblx0XHRjb25zdCBlbmREYXRlID0gbmV3IERhdGUoX2VuZERhdGUpO1xuXHRcdGxldCBmb3JtYXQ6c3RyaW5nO1xuXG5cdFx0Y29uc3Qgc3RhcnQgPSB7XG5cdFx0XHR0aW1lOiBzdGFydERhdGUuZ2V0VGltZSgpLFxuXHRcdFx0eWVhcjogc3RhcnREYXRlLmdldEZ1bGxZZWFyKCksXG5cdFx0XHRtb250aDogc3RhcnREYXRlLmdldE1vbnRoKCksXG5cdFx0XHRkYXRlOiBzdGFydERhdGUuZ2V0RGF0ZSgpLFxuXHRcdFx0aG91cjogc3RhcnREYXRlLmdldEhvdXJzKCksXG5cdFx0XHRtaW51dGU6IHN0YXJ0RGF0ZS5nZXRNaW51dGVzKCksXG5cdFx0fTtcblx0XHRjb25zdCBlbmQgPSB7XG5cdFx0XHR0aW1lOiBlbmREYXRlLmdldFRpbWUoKSxcblx0XHRcdHllYXI6IGVuZERhdGUuZ2V0RnVsbFllYXIoKSxcblx0XHRcdG1vbnRoOiBlbmREYXRlLmdldE1vbnRoKCksXG5cdFx0XHRkYXRlOiBlbmREYXRlLmdldERhdGUoKSxcblx0XHRcdGhvdXI6IGVuZERhdGUuZ2V0SG91cnMoKSxcblx0XHRcdG1pbnV0ZTogZW5kRGF0ZS5nZXRNaW51dGVzKCksXG5cdFx0fTtcblxuXHRcdGNvbnN0IGFTZWNvbmQgPSAxMDAwO1xuXHRcdGNvbnN0IGFNaW51dGUgPSA2MCAqIGFTZWNvbmQ7XG5cdFx0Y29uc3QgYW5Ib3VyID0gNjAgKiBhTWludXRlO1xuXHRcdGNvbnN0IGFEYXkgPSAyNCAqIGFuSG91cjtcblx0XHRjb25zdCBhV2VlayA9IDcgKiBhRGF5O1xuXG5cdFx0Y29uc3QgaW5QYXN0ID0gc3RhcnQudGltZSA+IGVuZC50aW1lO1xuXHRcdGNvbnN0IG1zQ291bnQgPSBNYXRoLmFicyhzdGFydC50aW1lIC0gZW5kLnRpbWUpO1xuXHRcdGNvbnN0IHNlY29uZHNDb3VudCA9IE1hdGguZmxvb3IobXNDb3VudCAvIGFTZWNvbmQpO1xuXHRcdGNvbnN0IG1pbnV0ZXNDb3VudCA9IE1hdGguZmxvb3IobXNDb3VudCAvIGFNaW51dGUpO1xuXHRcdGNvbnN0IGhvdXJzQ291bnQgPSBNYXRoLmZsb29yKG1zQ291bnQgLyBhbkhvdXIpO1xuXHRcdGNvbnN0IGRheXNDb3VudCA9IE1hdGguZmxvb3IobXNDb3VudCAvIGFEYXkpO1xuXHRcdGNvbnN0IHdlZWtzQ291bnQgPSBNYXRoLmZsb29yKG1zQ291bnQgLyBhV2Vlayk7XG5cblx0XHRjb25zdCBtb250aHNDb3VudCA9XG5cdFx0XHRNYXRoLmFicyhlbmQueWVhciAtIHN0YXJ0LnllYXIpICogMTIgKyAoZW5kLm1vbnRoIC0gc3RhcnQubW9udGgpO1xuXHRcdC8qXG5cdFx0Y29uc3QgeWVhcnNDb3VudCAgPSBNYXRoLmZsb29yKG1vbnRoc0NvdW50IC8gMTIpO1xuXG5cdFx0IGxldCBuU2Vjb25kcyA9IDAsIG5NaW51dGVzID0gMCwgbkhvdXJzID0gMCxcblx0XHQgblllYXJzID0geWVhcnNDb3VudCxcblx0XHQgbk1vbnRocyA9IChtb250aHNDb3VudCAtICAoblllYXJzKjEyKSk7XG5cdFx0ICovXG5cdFx0aWYgKHNlY29uZHNDb3VudCA8IDUpIHtcblx0XHRcdGZvcm1hdCA9IGluUGFzdCA/ICdPV19USU1FX0pVU1RfTk9XJyA6ICdPV19USU1FX0lOX0ZFV19TRUNPTkRTJztcblx0XHR9IGVsc2UgaWYgKHNlY29uZHNDb3VudCA8IDEwKSB7XG5cdFx0XHRmb3JtYXQgPSBpblBhc3Rcblx0XHRcdFx0PyAnT1dfVElNRV9GRVdfU0VDT05EU19BR08nXG5cdFx0XHRcdDogJ09XX1RJTUVfSU5fRkVXX1NFQ09ORFMnO1xuXHRcdH0gZWxzZSBpZiAoc2Vjb25kc0NvdW50IDwgNTUpIHtcblx0XHRcdGZvcm1hdCA9IGluUGFzdCA/ICdPV19USU1FX05fU0VDT05EU19BR08nIDogJ09XX1RJTUVfSU5fTl9TRUNPTkRTJztcblx0XHR9IGVsc2UgaWYgKHNlY29uZHNDb3VudCA8IDYwKSB7XG5cdFx0XHRmb3JtYXQgPSBpblBhc3Rcblx0XHRcdFx0PyAnT1dfVElNRV9MRVNTX1RIQU5fQV9NSU5VVEVfQUdPJ1xuXHRcdFx0XHQ6ICdPV19USU1FX0lOX0xFU1NfVEhBTl9BX01JTlVURSc7XG5cdFx0fSBlbHNlIGlmIChzZWNvbmRzQ291bnQgPCA3MCkge1xuXHRcdFx0Zm9ybWF0ID0gaW5QYXN0XG5cdFx0XHRcdD8gJ09XX1RJTUVfQUJPVVRfQV9NSU5VVEVfQUdPJ1xuXHRcdFx0XHQ6ICdPV19USU1FX0lOX0FCT1VUX0FfTUlOVVRFJztcblx0XHR9IGVsc2UgaWYgKG1pbnV0ZXNDb3VudCA8IDU1KSB7XG5cdFx0XHRmb3JtYXQgPSBpblBhc3QgPyAnT1dfVElNRV9OX01JTlVURVNfQUdPJyA6ICdPV19USU1FX0lOX05fTUlOVVRFUyc7XG5cdFx0fSBlbHNlIGlmIChtaW51dGVzQ291bnQgPCA3MCkge1xuXHRcdFx0Zm9ybWF0ID0gaW5QYXN0XG5cdFx0XHRcdD8gJ09XX1RJTUVfQUJPVVRfQU5fSE9VUl9BR08nXG5cdFx0XHRcdDogJ09XX1RJTUVfSU5fQUJPVVRfQU5fSE9VUic7XG5cdFx0fSBlbHNlIGlmIChob3Vyc0NvdW50IDwgMjQpIHtcblx0XHRcdGZvcm1hdCA9IGluUGFzdCA/ICdPV19USU1FX05fSE9VUlNfQUdPJyA6ICdPV19USU1FX0lOX05fSE9VUlMnO1xuXHRcdH0gZWxzZSBpZiAoZGF5c0NvdW50IDwgNykge1xuXHRcdFx0Zm9ybWF0ID0gaW5QYXN0ID8gJ09XX1RJTUVfTl9EQVlTX0FHTycgOiAnT1dfVElNRV9JTl9OX0RBWVMnO1xuXHRcdH0gZWxzZSBpZiAod2Vla3NDb3VudCA8IDQpIHtcblx0XHRcdGZvcm1hdCA9IGluUGFzdCA/ICdPV19USU1FX05fV0VFS1NfQUdPJyA6ICdPV19USU1FX0lOX05fV0VFS1MnO1xuXHRcdH0gZWxzZSBpZiAobW9udGhzQ291bnQgPCAxMikge1xuXHRcdFx0Zm9ybWF0ID0gaW5QYXN0ID8gJ09XX1RJTUVfTl9NT05USFNfQUdPJyA6ICdPV19USU1FX0lOX05fTU9OVEhTJztcblx0XHR9IGVsc2Uge1xuXHRcdFx0Zm9ybWF0ID0gaW5QYXN0ID8gJ09XX1RJTUVfTl9ZRUFSU19BR08nIDogJ09XX1RJTUVfSU5fTl9ZRUFSUyc7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHtcblx0XHRcdGZvcm1hdCxcblx0XHRcdC8qblNlY29uZHMsXG5cdFx0XHQgbk1pbnV0ZXMsXG5cdFx0XHQgbkhvdXJzLFxuXHRcdFx0IG5EYXlzLFxuXHRcdFx0IG5ZZWFycyovXG5cdFx0fTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIGRhdGUgZGVzY3JpcHRpb24gb2JqZWN0LlxuXHQgKi9cblx0ZGVzY3JpYmUoKTogT0RhdGVEZXNjIHtcblx0XHRjb25zdCBpMThuID0gdGhpcy5fYXBwQ29udGV4dC5pMThuLFxuXHRcdFx0ZGF5TmFtZXNTaG9ydCA9IGkxOG4udG9IdW1hbignT1dfVElNRV9EQVlfTkFNRVNfU0hPUlQnKS5zcGxpdCgnLCcpLFxuXHRcdFx0ZGF5TmFtZXNGdWxsID0gaTE4bi50b0h1bWFuKCdPV19USU1FX0RBWV9OQU1FU19GVUxMJykuc3BsaXQoJywnKSxcblx0XHRcdG1vbnRoTmFtZXNTaG9ydCA9IGkxOG5cblx0XHRcdFx0LnRvSHVtYW4oJ09XX1RJTUVfTU9OVEhfTkFNRVNfU0hPUlQnKVxuXHRcdFx0XHQuc3BsaXQoJywnKSxcblx0XHRcdG1vbnRoTmFtZXNGdWxsID0gaTE4blxuXHRcdFx0XHQudG9IdW1hbignT1dfVElNRV9NT05USF9OQU1FU19GVUxMJylcblx0XHRcdFx0LnNwbGl0KCcsJyksXG5cdFx0XHRkYXRlID0gbmV3IERhdGUodGhpcy5kYXRlKSxcblx0XHRcdHk6IG51bWJlciA9IChkYXRlIGFzIGFueSkuZ2V0WWVhcigpLFxuXHRcdFx0WTogbnVtYmVyID0gZGF0ZS5nZXRGdWxsWWVhcigpLFxuXHRcdFx0bTogbnVtYmVyID0gZGF0ZS5nZXRNb250aCgpLFxuXHRcdFx0bW0gPSBTdHJpbmcobSA8IDkgPyAnMCcgKyAobSArIDEpIDogbSArIDEpLFxuXHRcdFx0ZDogbnVtYmVyID0gZGF0ZS5nZXREYXRlKCksXG5cdFx0XHRsOiBudW1iZXIgPSBkYXRlLmdldERheSgpLFxuXHRcdFx0bGw6IG51bWJlciA9IGwgKyAxLCAvLyBsPyBsIDogNyxcblx0XHRcdEw6IHN0cmluZyA9IGRheU5hbWVzRnVsbFtsXSxcblx0XHRcdEQ6IHN0cmluZyA9IGRheU5hbWVzU2hvcnRbbF0sXG5cdFx0XHRNOiBzdHJpbmcgPSBtb250aE5hbWVzU2hvcnRbbV0sXG5cdFx0XHRGOiBzdHJpbmcgPSBtb250aE5hbWVzRnVsbFttXSxcblx0XHRcdEg6IG51bWJlciA9IGRhdGUuZ2V0SG91cnMoKSxcblx0XHRcdGg6IG51bWJlciA9IEggPT09IDEyID8gMTIgOiBIICUgMTIsXG5cdFx0XHRoaCA9IFN0cmluZyhtIDw9IDkgPyAnMCcgKyBtIDogbSksXG5cdFx0XHRpOiBudW1iZXIgPSBkYXRlLmdldE1pbnV0ZXMoKSxcblx0XHRcdGlpID0gU3RyaW5nKGkgPCAxMCA/ICcwJyArIGkgOiBpKSxcblx0XHRcdHM6IG51bWJlciA9IGRhdGUuZ2V0U2Vjb25kcygpLFxuXHRcdFx0c3MgPSBTdHJpbmcocyA8IDEwID8gJzAnICsgcyA6IHMpLFxuXHRcdFx0bXM6IG51bWJlciA9IGRhdGUuZ2V0TWlsbGlzZWNvbmRzKCksXG5cdFx0XHRhOiBzdHJpbmcgPSBIIDwgMTIgPyAnYW0nIDogJ3BtJyxcblx0XHRcdEE6IHN0cmluZyA9IGEudG9VcHBlckNhc2UoKTtcblxuXHRcdHJldHVybiB7XG5cdFx0XHRELFxuXHRcdFx0TCxcblx0XHRcdGwsXG5cdFx0XHRsbCxcblx0XHRcdGQsXG5cdFx0XHRNLFxuXHRcdFx0Rixcblx0XHRcdG0sXG5cdFx0XHRtbSxcblx0XHRcdFksXG5cdFx0XHR5LFxuXHRcdFx0aCxcblx0XHRcdGhoLFxuXHRcdFx0SCxcblx0XHRcdGksXG5cdFx0XHRpaSxcblx0XHRcdHMsXG5cdFx0XHRzcyxcblx0XHRcdG1zLFxuXHRcdFx0YSxcblx0XHRcdEEsXG5cdFx0fTtcblx0fVxuXG5cdC8qKlxuXHQgKiBEYXRlIHNldHRlci5cblx0ICpcblx0ICogQHBhcmFtIGRhdGVcblx0ICovXG5cdHNldERhdGUoZGF0ZTogT0RhdGVWYWx1ZSk6IHRoaXMge1xuXHRcdHRoaXMuZGF0ZSA9IG5ldyBEYXRlKGRhdGUpO1xuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0LyoqXG5cdCAqIERhdGUgZ2V0dGVyLlxuXHQgKi9cblx0Z2V0RGF0ZSgpOiBPRGF0ZVZhbHVlIHtcblx0XHRyZXR1cm4gdGhpcy5kYXRlO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgdW5peCBsaWtlIHRpbWVzdGFtcC5cblx0ICovXG5cdHN0YXRpYyB0aW1lc3RhbXAoKTogbnVtYmVyIHtcblx0XHRyZXR1cm4gTnVtYmVyKFN0cmluZyhEYXRlLm5vdygpKS5zbGljZSgwLCAtMykpO1xuXHR9XG59XG4iXX0=