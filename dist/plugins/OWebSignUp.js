import OWebEvent from "../OWebEvent";
import Utils from "../utils/Utils";
export default class OWebSignUp extends OWebEvent {
    constructor(app_context) {
        super();
        this.app_context = app_context;
    }
    stepStart(form) {
        let ofv = this.app_context.getFormValidator(form, ["phone"]);
        if (ofv.validate()) {
            let form_data = ofv.getFormData(["phone", "cc2"]);
            form_data.set("step", String(OWebSignUp.SIGN_UP_STEP_START));
            this._sendForm(form, form_data, OWebSignUp.SIGN_UP_STEP_VALIDATE);
        }
    }
    stepValidate(form) {
        let ofv = this.app_context.getFormValidator(form, ["code"]);
        if (ofv.validate()) {
            let code = ofv.getField("code");
            this._sendForm(form, {
                "step": OWebSignUp.SIGN_UP_STEP_VALIDATE,
                "code": code
            }, OWebSignUp.SIGN_UP_STEP_END);
        }
    }
    stepEnd(form) {
        let required = ["uname", "pass", "vpass", "birth_date", "gender"], excluded = [], mailInput, agreeChk;
        if (mailInput = form.querySelector("input[name=email]")) {
            if (!mailInput.value.trim().length) {
                excluded.push("email");
            }
            else {
                required.push("email");
            }
        }
        let ofv = this.app_context.getFormValidator(form, required, excluded), formData;
        if (ofv.validate()) {
            if ((agreeChk = form.querySelector("input[name=oweb_signup_cgu_agree_checkbox]")) && !agreeChk.checked) {
                let error = {
                    error: 1,
                    msg: "OZ_ERROR_SHOULD_ACCEPT_CGU",
                    utime: 0
                };
                this.trigger(OWebSignUp.EVT_SIGN_UP_ERROR, [error]);
                return false;
            }
            formData = ofv.getFormData(required);
            formData.set("step", String(OWebSignUp.SIGN_UP_STEP_END));
            this._sendForm(form, formData);
        }
    }
    onError(handler) {
        return this.on(OWebSignUp.EVT_SIGN_UP_ERROR, handler);
    }
    onNextStep(handler) {
        return this.on(OWebSignUp.EVT_SIGN_UP_NEXT_STEP, handler);
    }
    onSuccess(handler) {
        return this.on(OWebSignUp.EVT_SIGN_UP_SUCCESS, handler);
    }
    _sendForm(form, data, next_step) {
        let m = this, url = this.app_context.url.get("OZ_SERVER_SIGNUP_SERVICE");
        this.app_context.request("POST", url, data, function (response) {
            if (next_step) {
                m.trigger(OWebSignUp.EVT_SIGN_UP_NEXT_STEP, [response, next_step]);
            }
            else {
                m.trigger(OWebSignUp.EVT_SIGN_UP_SUCCESS, [response]);
            }
        }, function (response) {
            m.trigger(OWebSignUp.EVT_SIGN_UP_ERROR, [response]);
        }, true);
    }
}
OWebSignUp.SELF = Utils.id();
OWebSignUp.EVT_SIGN_UP_NEXT_STEP = Utils.id();
OWebSignUp.EVT_SIGN_UP_SUCCESS = Utils.id();
OWebSignUp.EVT_SIGN_UP_ERROR = Utils.id();
OWebSignUp.SIGN_UP_STEP_START = 1;
OWebSignUp.SIGN_UP_STEP_VALIDATE = 2;
OWebSignUp.SIGN_UP_STEP_END = 3;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlNpZ25VcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wbHVnaW5zL09XZWJTaWduVXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxTQUFTLE1BQU0sY0FBYyxDQUFDO0FBQ3JDLE9BQU8sS0FBSyxNQUFNLGdCQUFnQixDQUFDO0FBRW5DLE1BQU0sQ0FBQyxPQUFPLGlCQUFrQixTQUFRLFNBQVM7SUFXaEQsWUFBNkIsV0FBb0I7UUFDaEQsS0FBSyxFQUFFLENBQUE7UUFEcUIsZ0JBQVcsR0FBWCxXQUFXLENBQVM7SUFFakQsQ0FBQztJQUVELFNBQVMsQ0FBQyxJQUFxQjtRQUM5QixJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFFN0QsSUFBSSxHQUFHLENBQUMsUUFBUSxFQUFFLEVBQUU7WUFDbkIsSUFBSSxTQUFTLEdBQUcsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ2xELFNBQVMsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO1lBQzdELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRSxVQUFVLENBQUMscUJBQXFCLENBQUMsQ0FBQztTQUNsRTtJQUNGLENBQUM7SUFFRCxZQUFZLENBQUMsSUFBcUI7UUFDakMsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBRTVELElBQUksR0FBRyxDQUFDLFFBQVEsRUFBRSxFQUFFO1lBRW5CLElBQUksSUFBSSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFaEMsSUFBSSxD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LEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO2FBQ3REO1FBQ0YsQ0FBQyxFQUFFLFVBQVUsUUFBYTtZQUN6QixDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDckQsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ1YsQ0FBQzs7QUFyR2UsZUFBSSxHQUFvQixLQUFLLENBQUMsRUFBRSxFQUFFLENBQUM7QUFDbkMsZ0NBQXFCLEdBQUcsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQ25DLDhCQUFtQixHQUFLLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUNuQyw0QkFBaUIsR0FBTyxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUM7QUFFbkMsNkJBQWtCLEdBQU0sQ0FBQyxDQUFDO0FBQzFCLGdDQUFxQixHQUFHLENBQUMsQ0FBQztBQUMxQiwyQkFBZ0IsR0FBUSxDQUFDLENBQUM7QUErRjFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT1dlYkFwcCBmcm9tIFwiLi4vT1dlYkFwcFwiO1xyXG5pbXBvcnQge2lDb21SZXNwb25zZX0gZnJvbSBcIi4uL09XZWJDb21cIjtcclxuaW1wb3J0IE9XZWJFdmVudCBmcm9tIFwiLi4vT1dlYkV2ZW50XCI7XHJcbmltcG9ydCBVdGlscyBmcm9tIFwiLi4vdXRpbHMvVXRpbHNcIjtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJTaWduVXAgZXh0ZW5kcyBPV2ViRXZlbnQge1xyXG5cclxuXHRzdGF0aWMgcmVhZG9ubHkgU0VMRiAgICAgICAgICAgICAgICAgID0gVXRpbHMuaWQoKTtcclxuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX1NJR05fVVBfTkVYVF9TVEVQID0gVXRpbHMuaWQoKTtcclxuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX1NJR05fVVBfU1VDQ0VTUyAgID0gVXRpbHMuaWQoKTtcclxuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX1NJR05fVVBfRVJST1IgICAgID0gVXRpbHMuaWQoKTtcclxuXHJcblx0c3RhdGljIHJlYWRvbmx5IFNJR05fVVBfU1RFUF9TVEFSVCAgICA9IDE7XHJcblx0c3RhdGljIHJlYWRvbmx5IFNJR05fVVBfU1RFUF9WQUxJREFURSA9IDI7XHJcblx0c3RhdGljIHJlYWRvbmx5IFNJR05fVVBfU1RFUF9FTkQgICAgICA9IDM7XHJcblxyXG5cdGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgYXBwX2NvbnRleHQ6IE9XZWJBcHApIHtcclxuXHRcdHN1cGVyKClcclxuXHR9XHJcblxyXG5cdHN0ZXBTdGFydChmb3JtOiBIVE1MRm9ybUVsZW1lbnQpIHtcclxuXHRcdGxldCBvZnYgPSB0aGlzLmFwcF9jb250ZXh0LmdldEZvcm1WYWxpZGF0b3IoZm9ybSwgW1wicGhvbmVcIl0pO1xyXG5cclxuXHRcdGlmIChvZnYudmFsaWRhdGUoKSkge1xyXG5cdFx0XHRsZXQgZm9ybV9kYXRhID0gb2Z2LmdldEZvcm1EYXRhKFtcInBob25lXCIsIFwiY2MyXCJdKTtcclxuXHRcdFx0Zm9ybV9kYXRhLnNldChcInN0ZXBcIiwgU3RyaW5nKE9XZWJTaWduVXAuU0lHTl9VUF9TVEVQX1NUQVJUKSk7XHJcblx0XHRcdHRoaXMuX3NlbmRGb3JtKGZvcm0sIGZvcm1fZGF0YSwgT1dlYlNpZ25VcC5TSUdOX1VQX1NURVBfVkFMSURBVEUpO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0c3RlcFZhbGlkYXRlKGZvcm06IEhUTUxGb3JtRWxlbWVudCkge1xyXG5cdFx0bGV0IG9mdiA9IHRoaXMuYXBwX2NvbnRleHQuZ2V0Rm9ybVZhbGlkYXRvcihmb3JtLCBbXCJjb2RlXCJdKTtcclxuXHJcblx0XHRpZiAob2Z2LnZhbGlkYXRlKCkpIHtcclxuXHJcblx0XHRcdGxldCBjb2RlID0gb2Z2LmdldEZpZWxkKFwiY29kZVwiKTtcclxuXHJcblx0XHRcdHRoaXMuX3NlbmRGb3JtKGZvcm0sIHtcclxuXHRcdFx0XHRcInN0ZXBcIjogT1dlYlNpZ25VcC5TSUdOX1VQX1NURVBfVkFMSURBVEUsXHJcblx0XHRcdFx0XCJjb2RlXCI6IGNvZGVcclxuXHRcdFx0fSwgT1dlYlNpZ25VcC5TSUdOX1VQX1NURVBfRU5EKTtcclxuXHRcdH1cclxuXHJcblx0fVxyXG5cclxuXHRzdGVwRW5kKGZvcm06IEhUTUxGb3JtRWxlbWVudCkge1xyXG5cclxuXHRcdGxldCByZXF1aXJlZCA9IFtcInVuYW1lXCIsIFwicGFzc1wiLCBcInZwYXNzXCIsIFwiYmlydGhfZGF0ZVwiLCBcImdlbmRlclwiXSxcclxuXHRcdFx0ZXhjbHVkZWQgPSBbXSxcclxuXHRcdFx0bWFpbElucHV0OiBIVE1MSW5wdXRFbGVtZW50IHwgbnVsbCxcclxuXHRcdFx0YWdyZWVDaGs6IEhUTUxJbnB1dEVsZW1lbnQgfCBudWxsO1xyXG5cclxuXHRcdGlmIChtYWlsSW5wdXQgPSBmb3JtLnF1ZXJ5U2VsZWN0b3IoXCJpbnB1dFtuYW1lPWVtYWlsXVwiKSkge1xyXG5cdFx0XHRpZiAoIW1haWxJbnB1dC52YWx1ZS50cmltKCkubGVuZ3RoKSB7XHJcblx0XHRcdFx0ZXhjbHVkZWQucHVzaChcImVtYWlsXCIpO1xyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdHJlcXVpcmVkLnB1c2goXCJlbWFpbFwiKTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cclxuXHRcdGxldCBvZnYgPSB0aGlzLmFwcF9jb250ZXh0LmdldEZvcm1WYWxpZGF0b3IoZm9ybSwgcmVxdWlyZWQsIGV4Y2x1ZGVkKSxcclxuXHRcdFx0Zm9ybURhdGE7XHJcblxyXG5cdFx0aWYgKG9mdi52YWxpZGF0ZSgpKSB7XHJcblxyXG5cdFx0XHRpZiAoKGFncmVlQ2hrID0gZm9ybS5xdWVyeVNlbGVjdG9yKFwiaW5wdXRbbmFtZT1vd2ViX3NpZ251cF9jZ3VfYWdyZWVfY2hlY2tib3hdXCIpKSAmJiAhYWdyZWVDaGsuY2hlY2tlZCkge1xyXG5cdFx0XHRcdGxldCBlcnJvcjogaUNvbVJlc3BvbnNlID0ge1xyXG5cdFx0XHRcdFx0ZXJyb3I6IDEsXHJcblx0XHRcdFx0XHRtc2cgIDogXCJPWl9FUlJPUl9TSE9VTERfQUNDRVBUX0NHVVwiLFxyXG5cdFx0XHRcdFx0dXRpbWU6IDBcclxuXHRcdFx0XHR9O1xyXG5cdFx0XHRcdHRoaXMudHJpZ2dlcihPV2ViU2lnblVwLkVWVF9TSUdOX1VQX0VSUk9SLCBbZXJyb3JdKTtcclxuXHRcdFx0XHRyZXR1cm4gZmFsc2U7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdGZvcm1EYXRhID0gb2Z2LmdldEZvcm1EYXRhKHJlcXVpcmVkKTtcclxuXHRcdFx0Zm9ybURhdGEuc2V0KFwic3RlcFwiLCBTdHJpbmcoT1dlYlNpZ25VcC5TSUdOX1VQX1NURVBfRU5EKSk7XHJcblxyXG5cdFx0XHR0aGlzLl9zZW5kRm9ybShmb3JtLCBmb3JtRGF0YSk7XHJcblx0XHR9XHJcblxyXG5cdH1cclxuXHJcblx0b25FcnJvcihoYW5kbGVyOiAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4gdm9pZCk6IHRoaXMge1xyXG5cdFx0cmV0dXJuIHRoaXMub24oT1dlYlNpZ25VcC5FVlRfU0lHTl9VUF9FUlJPUiwgaGFuZGxlcik7XHJcblx0fVxyXG5cclxuXHRvbk5leHRTdGVwKGhhbmRsZXI6IChyZXNwb25zZTogaUNvbVJlc3BvbnNlLCBzdGVwOiBudW1iZXIpID0+IHZvaWQpOiB0aGlzIHtcclxuXHRcdHJldHVybiB0aGlzLm9uKE9XZWJTaWduVXAuRVZUX1NJR05fVVBfTkVYVF9TVEVQLCBoYW5kbGVyKTtcclxuXHR9XHJcblxyXG5cdG9uU3VjY2VzcyhoYW5kbGVyOiAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4gdm9pZCk6IHRoaXMge1xyXG5cdFx0cmV0dXJuIHRoaXMub24oT1dlYlNpZ25VcC5FVlRfU0lHTl9VUF9TVUNDRVNTLCBoYW5kbGVyKTtcclxuXHR9XHJcblxyXG5cdF9zZW5kRm9ybShmb3JtOiBIVE1MRm9ybUVsZW1lbnQsIGRhdGE6IGFueSwgbmV4dF9zdGVwPzogbnVtYmVyKSB7XHJcblx0XHRsZXQgbSAgID0gdGhpcyxcclxuXHRcdFx0dXJsID0gdGhpcy5hcHBfY29udGV4dC51cmwuZ2V0KFwiT1pfU0VSVkVSX1NJR05VUF9TRVJWSUNFXCIpO1xyXG5cclxuXHRcdHRoaXMuYXBwX2NvbnRleHQucmVxdWVzdChcIlBPU1RcIiwgdXJsLCBkYXRhLCBmdW5jdGlvbiAocmVzcG9uc2U6IGFueSkge1xyXG5cdFx0XHRpZiAobmV4dF9zdGVwKSB7XHJcblx0XHRcdFx0bS50cmlnZ2VyKE9XZWJTaWduVXAuRVZUX1NJR05fVVBfTkVYVF9TVEVQLCBbcmVzcG9uc2UsIG5leHRfc3RlcF0pO1xyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdG0udHJpZ2dlcihPV2ViU2lnblVwLkVWVF9TSUdOX1VQX1NVQ0NFU1MsIFtyZXNwb25zZV0pO1xyXG5cdFx0XHR9XHJcblx0XHR9LCBmdW5jdGlvbiAocmVzcG9uc2U6IGFueSkge1xyXG5cdFx0XHRtLnRyaWdnZXIoT1dlYlNpZ25VcC5FVlRfU0lHTl9VUF9FUlJPUiwgW3Jlc3BvbnNlXSk7XHJcblx0XHR9LCB0cnVlKTtcclxuXHR9XHJcbn07XHJcbiJdfQ==