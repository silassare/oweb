"use strict";
import OWebEvent from "../OWebEvent";
export default class OWebSignUp extends OWebEvent {
    constructor(app_context) {
        super();
        this.app_context = app_context;
    }
    stepStart(form) {
        let ofv = this.app_context.getFormValidator(form, ["phone"]);
        if (ofv.validate()) {
            let form_data = ofv.getFormData(["phone", "cc2"]);
            form_data.set("step", String(OWebSignUp.SIGN_UP_STEP_START));
            this._sendForm(form, form_data, OWebSignUp.SIGN_UP_STEP_VALIDATE);
        }
    }
    stepValidate(form) {
        let ofv = this.app_context.getFormValidator(form, ["code"]);
        if (ofv.validate()) {
            let code = ofv.getField("code");
            this._sendForm(form, {
                "step": OWebSignUp.SIGN_UP_STEP_VALIDATE,
                "code": code
            }, OWebSignUp.SIGN_UP_STEP_END);
        }
    }
    stepEnd(form) {
        let required = ["uname", "pass", "vpass", "birth_date", "gender"], excluded = [], mailInput, agreeChk;
        if (mailInput = form.querySelector("input[name=email]")) {
            if (!mailInput.value.trim().length) {
                excluded.push("email");
            }
            else {
                required.push("email");
            }
        }
        let ofv = this.app_context.getFormValidator(form, required, excluded), formData;
        if (ofv.validate()) {
            if ((agreeChk = form.querySelector("input[name=oweb_cgu_agree_checkbox]")) && !agreeChk.checked) {
                this.trigger(OWebSignUp.EVT_SIGN_UP_ERROR, ["OZ_ERROR_SHOULD_ACCEPT_CGU", form]);
                return false;
            }
            formData = ofv.getFormData(required);
            formData.set("step", String(OWebSignUp.SIGN_UP_STEP_END));
            this._sendForm(form, formData);
        }
    }
    _sendForm(form, data, next_step) {
        let m = this, url = this.app_context.url.get("OZ_SERVER_SIGNUP_SERVICE");
        this.app_context.request("POST", url, data, function (response) {
            if (next_step) {
                m.trigger(OWebSignUp.EVT_NEXT_STEP, [{ "response": response, "step": next_step, }]);
            }
            else {
                m.trigger(OWebSignUp.EVT_SIGN_UP_SUCCESS, [{ "response": response }]);
            }
        }, function (response) {
            m.trigger(OWebSignUp.EVT_SIGN_UP_ERROR, [{ "step": next_step, "response": response }]);
        }, true);
    }
}
OWebSignUp.SIGN_UP_STEP_START = 1;
OWebSignUp.SIGN_UP_STEP_VALIDATE = 2;
OWebSignUp.SIGN_UP_STEP_END = 3;
OWebSignUp.EVT_NEXT_STEP = "OWebSignUp:next_step";
OWebSignUp.EVT_SIGN_UP_SUCCESS = "OWebSignUp:success";
OWebSignUp.EVT_SIGN_UP_ERROR = "OWebSignUp:error";
OWebSignUp.SELF = "OWebSignUp";
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlNpZ25VcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wbHVnaW5zL09XZWJTaWduVXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDO0FBR2IsT0FBTyxTQUFTLE1BQU0sY0FBYyxDQUFDO0FBRXJDLE1BQU0sQ0FBQyxPQUFPLGlCQUFrQixTQUFRLFNBQVM7SUFXaEQsWUFBNkIsV0FBb0I7UUFDaEQsS0FBSyxFQUFFLENBQUE7UUFEcUIsZ0JBQVcsR0FBWCxXQUFXLENBQVM7SUFFakQsQ0FBQztJQUVELFNBQVMsQ0FBQyxJQUFxQjtRQUM5QixJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFFN0QsSUFBSSxHQUFHLENBQUMsUUFBUSxFQUFFLEVBQUU7WUFDbkIsSUFBSSxTQUFTLEdBQUcsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ2xELFNBQVMsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO1lBQzdELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRSxVQUFVLENBQUMscUJBQXFCLENBQUMsQ0FBQztTQUNsRTtJQUNGLENBQUM7SUFFRCxZQUFZLENBQUMsSUFBcUI7UUFDakMsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBRTVELElBQUksR0FBRyxDQUFDLFFBQVEsRUFBRSxFQUFFO1lBRW5CLElBQUksSUFBSSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFaEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUU7Z0JBQ3BCLE1BQU0sRUFBRSxVQUFVLENBQUMscUJBQXFCO2dCQUN4QyxNQUFNLEVBQUUsSUFBSTthQUNaLEVBQUUsVUFBVSxDQUFDLGdCQUFnQixDQUFDLENBQUM7U0FDaEM7SUFFRixDQUFDO0lBRUQsT0FBTyxDQUFDLElBQXFCO1FBRTVCLElBQUksUUFBUSxHQUFHLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLFFBQVEsQ0FBQyxFQUNoRSxRQUFRLEdBQUcsRUFBRSxFQUNiLFNBQWtDLEVBQ2xDLFFBQWlDLENBQUM7UUFFbkMsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFO1lBQ3hELElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRTtnQkFDbkMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUN2QjtpQkFBTTtnQkFDTixRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ3ZCO1NBQ0Q7UUFFRCxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsUUFBUSxDQUFDLEVBQ3BFLFFBQVEsQ0FBQztRQUVWLElBQUksR0FBRyxDQUFDLFFBQVEsRUFBRSxFQUFFO1lBRW5CLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFO2dCQUNoRyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLDRCQUE0QixFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7Z0JBQ2pGLE9BQU8sS0FBSyxDQUFDO2FBQ2I7WUFFRCxRQUFRLEdBQUcsR0FBRyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNyQyxRQUFRLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQztZQUUxRCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztTQUMvQjtJQUVGLENBQUM7SUFFRCxTQUFTLENBQUMsSUFBcUIsRUFBRSxJQUFTLEVBQUUsU0FBa0I7UUFDN0QsSUFBSSxDQUFDLEdBQUssSUFBSSxFQUNiLEdBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsMEJBQTBCLENBQUMsQ0FBQztRQUU1RCxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxVQUFVLFFBQWE7WUFDbEUsSUFBSSxTQUFTLEVBQUU7Z0JBQ2QsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsYUFBYSxFQUFFLENBQUMsRUFBQyxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxTQUFTLEdBQUUsQ0FBQyxDQUFDLENBQUM7YUFDbEY7aUJBQU07Z0JBQ04sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxFQUFDLFVBQVUsRUFBRSxRQUFRLEVBQUMsQ0FBQyxDQUFDLENBQUM7YUFDcEU7UUFDRixDQUFDLEVBQUUsVUFBVSxRQUFhO1lBQ3pCLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLGlCQUFpQixFQUFFLENBQUMsRUFBQyxNQUFNLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdEYsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ1YsQ0FBQzs7QUFwRmUsNkJBQWtCLEdBQU0sQ0FBQyxDQUFDO0FBQzFCLGdDQUFxQixHQUFHLENBQUMsQ0FBQztBQUMxQiwyQkFBZ0IsR0FBUSxDQUFDLENBQUM7QUFFMUIsd0JBQWEsR0FBUyxzQkFBc0IsQ0FBQztBQUM3Qyw4QkFBbUIsR0FBRyxvQkFBb0IsQ0FBQztBQUMzQyw0QkFBaUIsR0FBSyxrQkFBa0IsQ0FBQztBQUN6QyxlQUFJLEdBQWtCLFlBQVksQ0FBQztBQThFbkQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG5cclxuaW1wb3J0IE9XZWJBcHAgZnJvbSBcIi4uL09XZWJBcHBcIjtcclxuaW1wb3J0IE9XZWJFdmVudCBmcm9tIFwiLi4vT1dlYkV2ZW50XCI7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViU2lnblVwIGV4dGVuZHMgT1dlYkV2ZW50IHtcclxuXHJcblx0c3RhdGljIHJlYWRvbmx5IFNJR05fVVBfU1RFUF9TVEFSVCAgICA9IDE7XHJcblx0c3RhdGljIHJlYWRvbmx5IFNJR05fVVBfU1RFUF9WQUxJREFURSA9IDI7XHJcblx0c3RhdGljIHJlYWRvbmx5IFNJR05fVVBfU1RFUF9FTkQgICAgICA9IDM7XHJcblxyXG5cdHN0YXRpYyByZWFkb25seSBFVlRfTkVYVF9TVEVQICAgICAgID0gXCJPV2ViU2lnblVwOm5leHRfc3RlcFwiO1xyXG5cdHN0YXRpYyByZWFkb25seSBFVlRfU0lHTl9VUF9TVUNDRVNTID0gXCJPV2ViU2lnblVwOnN1Y2Nlc3NcIjtcclxuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX1NJR05fVVBfRVJST1IgICA9IFwiT1dlYlNpZ25VcDplcnJvclwiO1xyXG5cdHN0YXRpYyByZWFkb25seSBTRUxGICAgICAgICAgICAgICAgID0gXCJPV2ViU2lnblVwXCI7XHJcblxyXG5cdGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgYXBwX2NvbnRleHQ6IE9XZWJBcHApIHtcclxuXHRcdHN1cGVyKClcclxuXHR9XHJcblxyXG5cdHN0ZXBTdGFydChmb3JtOiBIVE1MRm9ybUVsZW1lbnQpIHtcclxuXHRcdGxldCBvZnYgPSB0aGlzLmFwcF9jb250ZXh0LmdldEZvcm1WYWxpZGF0b3IoZm9ybSwgW1wicGhvbmVcIl0pO1xyXG5cclxuXHRcdGlmIChvZnYudmFsaWRhdGUoKSkge1xyXG5cdFx0XHRsZXQgZm9ybV9kYXRhID0gb2Z2LmdldEZvcm1EYXRhKFtcInBob25lXCIsIFwiY2MyXCJdKTtcclxuXHRcdFx0Zm9ybV9kYXRhLnNldChcInN0ZXBcIiwgU3RyaW5nKE9XZWJTaWduVXAuU0lHTl9VUF9TVEVQX1NUQVJUKSk7XHJcblx0XHRcdHRoaXMuX3NlbmRGb3JtKGZvcm0sIGZvcm1fZGF0YSwgT1dlYlNpZ25VcC5TSUdOX1VQX1NURVBfVkFMSURBVEUpO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0c3RlcFZhbGlkYXRlKGZvcm06IEhUTUxGb3JtRWxlbWVudCkge1xyXG5cdFx0bGV0IG9mdiA9IHRoaXMuYXBwX2NvbnRleHQuZ2V0Rm9ybVZhbGlkYXRvcihmb3JtLCBbXCJjb2RlXCJdKTtcclxuXHJcblx0XHRpZiAob2Z2LnZhbGlkYXRlKCkpIHtcclxuXHJcblx0XHRcdGxldCBjb2RlID0gb2Z2LmdldEZpZWxkKFwiY29kZVwiKTtcclxuXHJcblx0XHRcdHRoaXMuX3NlbmRGb3JtKGZvcm0sIHtcclxuXHRcdFx0XHRcInN0ZXBcIjogT1dlYlNpZ25VcC5TSUdOX1VQX1NURVBfVkFMSURBVEUsXHJcblx0XHRcdFx0XCJjb2RlXCI6IGNvZGVcclxuXHRcdFx0fSwgT1dlYlNpZ25VcC5TSUdOX1VQX1NURVBfRU5EKTtcclxuXHRcdH1cclxuXHJcblx0fVxyXG5cclxuXHRzdGVwRW5kKGZvcm06IEhUTUxGb3JtRWxlbWVudCkge1xyXG5cclxuXHRcdGxldCByZXF1aXJlZCA9IFtcInVuYW1lXCIsIFwicGFzc1wiLCBcInZwYXNzXCIsIFwiYmlydGhfZGF0ZVwiLCBcImdlbmRlclwiXSxcclxuXHRcdFx0ZXhjbHVkZWQgPSBbXSxcclxuXHRcdFx0bWFpbElucHV0OiBIVE1MSW5wdXRFbGVtZW50IHwgbnVsbCxcclxuXHRcdFx0YWdyZWVDaGs6IEhUTUxJbnB1dEVsZW1lbnQgfCBudWxsO1xyXG5cclxuXHRcdGlmIChtYWlsSW5wdXQgPSBmb3JtLnF1ZXJ5U2VsZWN0b3IoXCJpbnB1dFtuYW1lPWVtYWlsXVwiKSkge1xyXG5cdFx0XHRpZiAoIW1haWxJbnB1dC52YWx1ZS50cmltKCkubGVuZ3RoKSB7XHJcblx0XHRcdFx0ZXhjbHVkZWQucHVzaChcImVtYWlsXCIpO1xyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdHJlcXVpcmVkLnB1c2goXCJlbWFpbFwiKTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cclxuXHRcdGxldCBvZnYgPSB0aGlzLmFwcF9jb250ZXh0LmdldEZvcm1WYWxpZGF0b3IoZm9ybSwgcmVxdWlyZWQsIGV4Y2x1ZGVkKSxcclxuXHRcdFx0Zm9ybURhdGE7XHJcblxyXG5cdFx0aWYgKG9mdi52YWxpZGF0ZSgpKSB7XHJcblxyXG5cdFx0XHRpZiAoKGFncmVlQ2hrID0gZm9ybS5xdWVyeVNlbGVjdG9yKFwiaW5wdXRbbmFtZT1vd2ViX2NndV9hZ3JlZV9jaGVja2JveF1cIikpICYmICFhZ3JlZUNoay5jaGVja2VkKSB7XHJcblx0XHRcdFx0dGhpcy50cmlnZ2VyKE9XZWJTaWduVXAuRVZUX1NJR05fVVBfRVJST1IsIFtcIk9aX0VSUk9SX1NIT1VMRF9BQ0NFUFRfQ0dVXCIsIGZvcm1dKTtcclxuXHRcdFx0XHRyZXR1cm4gZmFsc2U7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdGZvcm1EYXRhID0gb2Z2LmdldEZvcm1EYXRhKHJlcXVpcmVkKTtcclxuXHRcdFx0Zm9ybURhdGEuc2V0KFwic3RlcFwiLCBTdHJpbmcoT1dlYlNpZ25VcC5TSUdOX1VQX1NURVBfRU5EKSk7XHJcblxyXG5cdFx0XHR0aGlzLl9zZW5kRm9ybShmb3JtLCBmb3JtRGF0YSk7XHJcblx0XHR9XHJcblxyXG5cdH1cclxuXHJcblx0X3NlbmRGb3JtKGZvcm06IEhUTUxGb3JtRWxlbWVudCwgZGF0YTogYW55LCBuZXh0X3N0ZXA/OiBudW1iZXIpIHtcclxuXHRcdGxldCBtICAgPSB0aGlzLFxyXG5cdFx0XHR1cmwgPSB0aGlzLmFwcF9jb250ZXh0LnVybC5nZXQoXCJPWl9TRVJWRVJfU0lHTlVQX1NFUlZJQ0VcIik7XHJcblxyXG5cdFx0dGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiUE9TVFwiLCB1cmwsIGRhdGEsIGZ1bmN0aW9uIChyZXNwb25zZTogYW55KSB7XHJcblx0XHRcdGlmIChuZXh0X3N0ZXApIHtcclxuXHRcdFx0XHRtLnRyaWdnZXIoT1dlYlNpZ25VcC5FVlRfTkVYVF9TVEVQLCBbe1wicmVzcG9uc2VcIjogcmVzcG9uc2UsIFwic3RlcFwiOiBuZXh0X3N0ZXAsfV0pO1xyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdG0udHJpZ2dlcihPV2ViU2lnblVwLkVWVF9TSUdOX1VQX1NVQ0NFU1MsIFt7XCJyZXNwb25zZVwiOiByZXNwb25zZX1dKTtcclxuXHRcdFx0fVxyXG5cdFx0fSwgZnVuY3Rpb24gKHJlc3BvbnNlOiBhbnkpIHtcclxuXHRcdFx0bS50cmlnZ2VyKE9XZWJTaWduVXAuRVZUX1NJR05fVVBfRVJST1IsIFt7XCJzdGVwXCI6IG5leHRfc3RlcCwgXCJyZXNwb25zZVwiOiByZXNwb25zZX1dKTtcclxuXHRcdH0sIHRydWUpO1xyXG5cdH1cclxufTtcclxuIl19