import { OWebEvent } from "../oweb";
const wDoc = window.document;
let linkId = 0;
let _isParentOf = (parent, link) => {
    let p;
    while (p = link.parent) {
        if (p === parent) {
            return true;
        }
        link = p;
    }
    return false;
};
export default class OWebPager extends OWebEvent {
    constructor(app_context) {
        super();
        this.app_context = app_context;
        this._pages = {};
        this._links = [];
        this._links_flattened = [];
        console.log("[OWebPager] ready!");
    }
    getLinks() {
        return this._links;
    }
    getPage(name) {
        let page = this._pages[name];
        if (undefined === page) {
            throw new Error(`[OWebPager] the page "${name}" is not defined.`);
        }
        return page;
    }
    getActivePage() {
        if (!this._active_page) {
            console.warn("[OWebPager] no active page");
        }
        return this._active_page;
    }
    getPageList() {
        return Object.create(this._pages);
    }
    registerPage(page) {
        let name = page.getName();
        if (name in this._pages) {
            console.warn(`[OWebPager] page "${name}" will be redefined.`);
        }
        this._pages[name] = page;
        let links = page.getLinks();
        Array.prototype.push.apply(this._links, links);
        return this._registerLinks(links, page);
    }
    _registerLinks(links, page, parent) {
        let router = this.app_context.router;
        for (let i = 0; i < links.length; i++) {
            let link = links[i];
            link.id = ++linkId;
            link.parent = parent;
            link.href = router.pathToURL(typeof link.path === "string" ? link.path : "/").href;
            link.active = false;
            link.active_child = false;
            if (!("show" in link)) {
                link.show = function () {
                    return true;
                };
            }
            this._links_flattened.push(link);
            this._addRoute(link, page);
            let sub = link.sub ? link.sub() : [];
            if (sub.length) {
                this._registerLinks(sub, page, link);
            }
        }
        return this;
    }
    _addRoute(link, page) {
        let ctx = this;
        this.app_context.router.on(link.path, link.pathOptions || {}, (routeContext) => {
            console.log("[OWebPager] page link match ->", link, page, routeContext);
            if (link.requireLogin && link.requireLogin() && !ctx.app_context.userVerified()) {
                return routeContext.stop() && ctx.app_context.showLoginPage();
            }
            let al = ctx._active_link;
            al && al.onClose && al.onClose();
            link.onOpen && link.onOpen(routeContext);
            ctx._setActivePage(page)
                ._setActiveLink(link);
        });
        return this;
    }
    _setActiveLink(link) {
        let links = this._links_flattened;
        for (let i = 0; i < links.length; i++) {
            let c = links[i];
            c.active = link.id === c.id;
            c.active_child = !c.active && _isParentOf(c, link);
        }
        if (link.title.length) {
            wDoc.title = link.title;
        }
        this._active_link = link;
        console.log(`[OWebPager] active link ->`, this._active_link);
        return this;
    }
    _setActivePage(newPage) {
        let oldPage = this._active_page;
        if (oldPage !== newPage) {
            console.log(`[OWebPager] page changing ->`, newPage, oldPage);
            this._active_page = newPage;
            this.trigger(OWebPager.EVT_PAGE_CHANGE, [oldPage, newPage]);
        }
        else {
            console.log(`[OWebPager] same page ->`, oldPage, newPage);
        }
        return this;
    }
}
OWebPager.SELF = "OWebPager";
OWebPager.EVT_PAGE_CHANGE = "OWebPager:page_change";
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlBhZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3BsdWdpbnMvT1dlYlBhZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBQyxTQUFTLEVBQStELE1BQU0sU0FBUyxDQUFDO0FBa0NoRyxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDO0FBRTdCLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQztBQUVmLElBQUksV0FBVyxHQUFHLENBQUMsTUFBcUIsRUFBRSxJQUFtQixFQUFXLEVBQUU7SUFDekUsSUFBSSxDQUFDLENBQUM7SUFDTixPQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFO1FBQ3ZCLElBQUksQ0FBQyxLQUFLLE1BQU0sRUFBRTtZQUNqQixPQUFPLElBQUksQ0FBQztTQUNaO1FBRUQsSUFBSSxHQUFHLENBQUMsQ0FBQztLQUNUO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDZCxDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsT0FBTyxnQkFBaUIsU0FBUSxTQUFTO0lBVS9DLFlBQTZCLFdBQW9CO1FBQ2hELEtBQUssRUFBRSxDQUFDO1FBRG9CLGdCQUFXLEdBQVgsV0FBVyxDQUFTO1FBTmhDLFdBQU0sR0FBNkIsRUFBRSxDQUFDO1FBRS9DLFdBQU0sR0FBc0MsRUFBRSxDQUFDO1FBQy9DLHFCQUFnQixHQUE0QixFQUFFLENBQUM7UUFLdEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFRCxRQUFRO1FBQ1AsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3BCLENBQUM7SUFFRCxPQUFPLENBQUMsSUFBWTtRQUNuQixJQUFJLElBQUksR0FBVSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BDLElBQUksU0FBUyxLQUFLLElBQUksRUFBRTtZQUN2QixNQUFNLElBQUksS0FBSyxDQUFDLHlCQUF5QixJ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UUFFRCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO1lBQ3RCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztTQUN4QjtRQUVELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO1FBRXpCLE9BQU8sQ0FBQyxHQUFHLENBQUMsNEJBQTRCLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBRTdELE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztJQUVPLGNBQWMsQ0FBQyxPQUFjO1FBQ3BDLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUM7UUFFaEMsSUFBSSxPQUFPLEtBQUssT0FBTyxFQUFFO1lBQ3hCLE9BQU8sQ0FBQyxHQUFHLENBQUMsOEJBQThCLEVBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQzlELElBQUksQ0FBQyxZQUFZLEdBQUcsT0FBTyxDQUFDO1lBQzVCLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLGVBQWUsRUFBRSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO1NBQzVEO2FBQU07WUFDTixPQUFPLENBQUMsR0FBRyxDQUFDLDBCQUEwQixFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztTQUMxRDtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQzs7QUE1SWUsY0FBSSxHQUFjLFdBQVcsQ0FBQztBQUM5Qix5QkFBZSxHQUFHLHVCQUF1QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtWdWUsIFZ1ZUNvbnN0cnVjdG9yfSBmcm9tIFwidnVlL3R5cGVzL3Z1ZVwiO1xuaW1wb3J0IHtPV2ViRXZlbnQsIE9XZWJBcHAsIE9XZWJSb3V0ZUNvbnRleHQsIHRSb3V0ZSwgdFJvdXRlT3B0aW9ucywgT1dlYlJvdXRlcn0gZnJvbSBcIi4uL293ZWJcIjtcblxuZXhwb3J0IGludGVyZmFjZSBpUGFnZSB7XG5cdGdldE5hbWUoKTogc3RyaW5nO1xuXG5cdGdldExpbmtzKCk6IHRQYWdlTGlua1tdO1xuXG5cdGNvbXBvbmVudCgpOiBWdWUgfCBWdWVDb25zdHJ1Y3RvciB8IHVuZGVmaW5lZFxufVxuXG5leHBvcnQgdHlwZSB0UGFnZUxpbmsgPSB7XG5cdHJlYWRvbmx5IHRpdGxlOiBzdHJpbmcsXG5cdHJlYWRvbmx5IGRlc2NyaXB0aW9uPzogc3RyaW5nLFxuXHRyZWFkb25seSBwYXRoOiB0Um91dGUsXG5cdHJlYWRvbmx5IHBhdGhPcHRpb25zPzogdFJvdXRlT3B0aW9ucyxcblx0cmVhZG9ubHkgc2x1Zz86IHN0cmluZyxcblx0cmVhZG9ubHkgaWNvbj86IHN0cmluZyxcblx0c2hvdz8oKTogYm9vbGVhbixcblx0c3ViPygpOiB0UGFnZUxpbmtbXSxcblx0cmVxdWlyZUxvZ2luPygpOiBib29sZWFuLFxuXHRvbk9wZW4/KGN0eDogT1dlYlJvdXRlQ29udGV4dCk6IHZvaWQsXG5cdG9uQ2xvc2U/KCk6IHZvaWRcbn07XG5cbmV4cG9ydCB0eXBlIHRQYWdlTGlua0Z1bGwgPSB0UGFnZUxpbmsgJiB7XG5cdGlkOiBudW1iZXIsXG5cdGhyZWY6IHN0cmluZyxcblx0YWN0aXZlOiBib29sZWFuLFxuXHRhY3RpdmVfY2hpbGQ6IGJvb2xlYW4sXG5cdHBhcmVudD86IHRQYWdlTGlua0Z1bGwsXG5cdHNob3coKTogYm9vbGVhblxuXG59O1xuXG5jb25zdCB3RG9jID0gd2luZG93LmRvY3VtZW50O1xuXG5sZXQgbGlua0lkID0gMDtcblxubGV0IF9pc1BhcmVudE9mID0gKHBhcmVudDogdFBhZ2VMaW5rRnVsbCwgbGluazogdFBhZ2VMaW5rRnVsbCk6IGJvb2xlYW4gPT4ge1xuXHRsZXQgcDtcblx0d2hpbGUgKHAgPSBsaW5rLnBhcmVudCkge1xuXHRcdGlmIChwID09PSBwYXJlbnQpIHtcblx0XHRcdHJldHVybiB0cnVlO1xuXHRcdH1cblxuXHRcdGxpbmsgPSBwO1xuXHR9XG5cdHJldHVybiBmYWxzZTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJQYWdlciBleHRlbmRzIE9XZWJFdmVudCB7XG5cdHN0YXRpYyByZWFkb25seSBTRUxGICAgICAgICAgICAgPSBcIk9XZWJQYWdlclwiO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX1BBR0VfQ0hBTkdFID0gXCJPV2ViUGFnZXI6cGFnZV9jaGFuZ2VcIjtcblxuXHRwcml2YXRlIHJlYWRvbmx5IF9wYWdlczogeyBba2V5OiBzdHJpbmddOiBpUGFnZSB9ID0ge307XG5cdHByaXZhdGUgX2FjdGl2ZV9wYWdlOiBpUGFnZSB8IHVuZGVmaW5lZDtcblx0cHJpdmF0ZSBfbGlua3M6IHRQYWdlTGlua0Z1bGxbXSAgICAgICAgICAgICAgICAgICA9IFtdO1xuXHRwcml2YXRlIF9saW5rc19mbGF0dGVuZWQ6IHRQYWdlTGlua0Z1bGxbXSAgICAgICAgID0gW107XG5cdHByaXZhdGUgX2FjdGl2ZV9saW5rPzogdFBhZ2VMaW5rRnVsbDtcblxuXHRjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGFwcF9jb250ZXh0OiBPV2ViQXBwKSB7XG5cdFx0c3VwZXIoKTtcblx0XHRjb25zb2xlLmxvZyhcIltPV2ViUGFnZXJdIHJlYWR5IVwiKTtcblx0fVxuXG5cdGdldExpbmtzKCk6IHRQYWdlTGlua0Z1bGxbXSB7XG5cdFx0cmV0dXJuIHRoaXMuX2xpbmtzO1xuXHR9XG5cblx0Z2V0UGFnZShuYW1lOiBzdHJpbmcpOiBpUGFnZSB7XG5cdFx0bGV0IHBhZ2U6IGlQYWdlID0gdGhpcy5fcGFnZXNbbmFtZV07XG5cdFx0aWYgKHVuZGVmaW5lZCA9PT0gcGFnZSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBbT1dlYlBhZ2VyXSB0aGUgcGFnZSBcIiR7bmFtZX1cIiBpcyBub3QgZGVmaW5lZC5gKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gcGFnZTtcblx0fVxuXG5cdGdldEFjdGl2ZVBhZ2UoKTogaVBhZ2UgfCB1bmRlZmluZWQge1xuXHRcdGlmICghdGhpcy5fYWN0aXZlX3BhZ2UpIHtcblx0XHRcdGNvbnNvbGUud2FybihcIltPV2ViUGFnZXJdIG5vIGFjdGl2ZSBwYWdlXCIpO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcy5fYWN0aXZlX3BhZ2U7XG5cdH1cblxuXHRnZXRQYWdlTGlzdCgpIHtcblx0XHRyZXR1cm4gT2JqZWN0LmNyZWF0ZSh0aGlzLl9wYWdlcyk7XG5cdH1cblxuXHRyZWdpc3RlclBhZ2UocGFnZTogaVBhZ2UpOiB0aGlzIHtcblx0XHRsZXQgbmFtZSA9IHBhZ2UuZ2V0TmFtZSgpO1xuXHRcdGlmIChuYW1lIGluIHRoaXMuX3BhZ2VzKSB7XG5cdFx0XHRjb25zb2xlLndhcm4oYFtPV2ViUGFnZXJdIHBhZ2UgXCIke25hbWV9XCIgd2lsbCBiZSByZWRlZmluZWQuYCk7XG5cdFx0fVxuXG5cdFx0dGhpcy5fcGFnZXNbbmFtZV0gPSBwYWdlO1xuXG5cdFx0bGV0IGxpbmtzID0gcGFnZS5nZXRMaW5rcygpO1xuXG5cdFx0QXJyYXkucHJvdG90eXBlLnB1c2guYXBwbHkodGhpcy5fbGlua3MsIGxpbmtzKTtcblxuXHRcdHJldHVybiB0aGlzLl9yZWdpc3RlckxpbmtzKGxpbmtzLCBwYWdlKTtcblx0fVxuXG5cdHByaXZhdGUgX3JlZ2lzdGVyTGlua3MobGlua3M6IHRQYWdlTGlua1tdLCBwYWdlOiBpUGFnZSwgcGFyZW50PzogdFBhZ2VMaW5rRnVsbCk6IHRoaXMge1xuXG5cdFx0bGV0IHJvdXRlcjogT1dlYlJvdXRlciA9IHRoaXMuYXBwX2NvbnRleHQucm91dGVyO1xuXG5cdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBsaW5rcy5sZW5ndGg7IGkrKykge1xuXHRcdFx0bGV0IGxpbms6IHRQYWdlTGlua0Z1bGwgPSA8YW55PmxpbmtzW2ldO1xuXHRcdFx0bGluay5pZCAgICAgICAgICAgICAgICAgPSArK2xpbmtJZDtcblx0XHRcdGxpbmsucGFyZW50ICAgICAgICAgICAgID0gcGFyZW50O1xuXHRcdFx0bGluay5ocmVmICAgICAgICAgICAgICAgPSByb3V0ZXIucGF0aFRvVVJMKHR5cGVvZiBsaW5rLnBhdGggPT09IFwic3RyaW5nXCI/IGxpbmsucGF0aCA6IFwiL1wiKS5ocmVmO1xuXHRcdFx0bGluay5hY3RpdmUgICAgICAgICAgICAgPSBmYWxzZTtcblx0XHRcdGxpbmsuYWN0aXZlX2NoaWxkICAgICAgID0gZmFsc2U7XG5cblx0XHRcdGlmICghKFwic2hvd1wiIGluIGxpbmspKSB7XG5cdFx0XHRcdGxpbmsuc2hvdyA9IGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHRcdFx0fTtcblx0XHRcdH1cblxuXHRcdFx0dGhpcy5fbGlua3NfZmxhdHRlbmVkLnB1c2gobGluayk7XG5cblx0XHRcdHRoaXMuX2FkZFJvdXRlKGxpbmssIHBhZ2UpO1xuXG5cdFx0XHRsZXQgc3ViID0gbGluay5zdWIgPyBsaW5rLnN1YigpIDogW107XG5cblx0XHRcdGlmIChzdWIubGVuZ3RoKSB7XG5cdFx0XHRcdHRoaXMuX3JlZ2lzdGVyTGlua3Moc3ViLCBwYWdlLCBsaW5rKTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHByaXZhdGUgX2FkZFJvdXRlKGxpbms6IHRQYWdlTGlua0Z1bGwsIHBhZ2U6IGlQYWdlKTogdGhpcyB7XG5cdFx0bGV0IGN0eCA9IHRoaXM7XG5cdFx0dGhpcy5hcHBfY29udGV4dC5yb3V0ZXIub24obGluay5wYXRoLCBsaW5rLnBhdGhPcHRpb25zIHx8IHt9LCAocm91dGVDb250ZXh0OiBPV2ViUm91dGVDb250ZXh0KSA9PiB7XG5cdFx0XHRjb25zb2xlLmxvZyhcIltPV2ViUGFnZXJdIHBhZ2UgbGluayBtYXRjaCAtPlwiLCBsaW5rLCBwYWdlLCByb3V0ZUNvbnRleHQpO1xuXG5cdFx0XHRpZiAobGluay5yZXF1aXJlTG9naW4gJiYgbGluay5yZXF1aXJlTG9naW4oKSAmJiAhY3R4LmFwcF9jb250ZXh0LnVzZXJWZXJpZmllZCgpKSB7XG5cdFx0XHRcdHJldHVybiByb3V0ZUNvbnRleHQuc3RvcCgpICYmIGN0eC5hcHBfY29udGV4dC5zaG93TG9naW5QYWdlKCk7XG5cdFx0XHR9XG5cblx0XHRcdGxldCBhbCA9IGN0eC5fYWN0aXZlX2xpbms7XG5cblx0XHRcdGFsICYmIGFsLm9uQ2xvc2UgJiYgYWwub25DbG9zZSgpO1xuXG5cdFx0XHRsaW5rLm9uT3BlbiAmJiBsaW5rLm9uT3Blbihyb3V0ZUNvbnRleHQpO1xuXG5cdFx0XHRjdHguX3NldEFjdGl2ZVBhZ2UocGFnZSlcblx0XHRcdFx0Ll9zZXRBY3RpdmVMaW5rKGxpbmspO1xuXHRcdH0pO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRwcml2YXRlIF9zZXRBY3RpdmVMaW5rKGxpbms6IHRQYWdlTGlua0Z1bGwpOiB0aGlzIHtcblx0XHRsZXQgbGlua3MgPSB0aGlzLl9saW5rc19mbGF0dGVuZWQ7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGxpbmtzLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRsZXQgYyA9IGxpbmtzW2ldO1xuXG5cdFx0XHRjLmFjdGl2ZSAgICAgICA9IGxpbmsuaWQgPT09IGMuaWQ7XG5cdFx0XHRjLmFjdGl2ZV9jaGlsZCA9ICFjLmFjdGl2ZSAmJiBfaXNQYXJlbnRPZihjLCBsaW5rKTtcblx0XHR9XG5cblx0XHRpZiAobGluay50aXRsZS5sZW5ndGgpIHtcblx0XHRcdHdEb2MudGl0bGUgPSBsaW5rLnRpdGxlO1xuXHRcdH1cblxuXHRcdHRoaXMuX2FjdGl2ZV9saW5rID0gbGluaztcblxuXHRcdGNvbnNvbGUubG9nKGBbT1dlYlBhZ2VyXSBhY3RpdmUgbGluayAtPmAsIHRoaXMuX2FjdGl2ZV9saW5rKTtcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0cHJpdmF0ZSBfc2V0QWN0aXZlUGFnZShuZXdQYWdlOiBpUGFnZSk6IHRoaXMge1xuXHRcdGxldCBvbGRQYWdlID0gdGhpcy5fYWN0aXZlX3BhZ2U7XG5cblx0XHRpZiAob2xkUGFnZSAhPT0gbmV3UGFnZSkge1xuXHRcdFx0Y29uc29sZS5sb2coYFtPV2ViUGFnZXJdIHBhZ2UgY2hhbmdpbmcgLT5gLCBuZXdQYWdlLCBvbGRQYWdlKTtcblx0XHRcdHRoaXMuX2FjdGl2ZV9wYWdlID0gbmV3UGFnZTtcblx0XHRcdHRoaXMudHJpZ2dlcihPV2ViUGFnZXIuRVZUX1BBR0VfQ0hBTkdFLCBbb2xkUGFnZSwgbmV3UGFnZV0pO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRjb25zb2xlLmxvZyhgW09XZWJQYWdlcl0gc2FtZSBwYWdlIC0+YCwgb2xkUGFnZSwgbmV3UGFnZSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cbn0iXX0=