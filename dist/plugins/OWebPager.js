"use strict";
import OWebEvent from "../OWebEvent";
let linkId = 0;
let _isParentOf = (parent, link) => {
    let p;
    while (p = link.parent) {
        if (p === parent) {
            return true;
        }
        link = p;
    }
    return false;
};
export default class OWebPager extends OWebEvent {
    constructor(app_context) {
        super();
        this.app_context = app_context;
        this._pages = {};
        this._links = [];
        this._links_flattened = [];
        console.log("[OWebPager] ready!");
    }
    getLinks() {
        return this._links;
    }
    getPage(name) {
        let page = this._pages[name];
        if (undefined === page) {
            throw new Error(`[OWebPager] the page "${name}" is not defined.`);
        }
        return page;
    }
    getActivePage() {
        if (!this._active_page) {
            console.warn("[OWebPager] no active page");
        }
        return this._active_page;
    }
    getPageList() {
        return Object.create(this._pages);
    }
    registerPage(page) {
        let name = page.name;
        if (name in this._pages) {
            console.warn(`[OWebPager] page "${name}" will be redefined.`);
        }
        this._pages[name] = page;
        let links = page.getLinks();
        Array.prototype.push.apply(this._links, links);
        return this._registerLinks(links, page);
    }
    _registerLinks(links, page, parent) {
        let router = this.app_context.router;
        for (let i = 0; i < links.length; i++) {
            let link = links[i];
            link.id = ++linkId;
            link.parent = parent;
            link.href = router.pathToURL(link.path).href;
            link.active = false;
            link.active_child = false;
            link.require_login = link.require_login || false;
            link.show = link.show !== false;
            this._links_flattened.push(link);
            this._addRoute(link, page);
            if (link.sub && link.sub.length) {
                this._registerLinks(link.sub, page, link);
            }
        }
        return this;
    }
    _addRoute(link, page) {
        let ctx = this;
        this.app_context.router.on(link.path, link.options || {}, (routeContext) => {
            console.log("[OWebPager] page link match ->", link, page, routeContext);
            if (link.require_login && !ctx.app_context.userVerified()) {
                return routeContext.stop() && ctx.app_context.showLoginPage();
            }
            let p = ctx._active_page;
            p && p.onPageClose && p.onPageClose(routeContext);
            page.onPageOpen && page.onPageOpen(routeContext);
            ctx._setActivePage(page)
                ._setActiveLink(link);
        });
        return this;
    }
    _setActiveLink(link) {
        let links = this._links_flattened;
        this._active_link = link;
        for (let i = 0; i < links.length; i++) {
            let c = links[i];
            c.active = link.id === c.id;
            c.active_child = !c.active && _isParentOf(c, link);
        }
        return this;
    }
    _setActivePage(newPage) {
        let oldPage = this._active_page;
        if (oldPage !== newPage) {
            console.log(`[OWebPager] page changing ->`, newPage, oldPage);
            this._active_page = newPage;
            this.trigger(OWebPager.EVT_PAGE_CHANGE, [oldPage, newPage]);
        }
        else {
            console.log(`[OWebPager] same page ->`, oldPage, newPage);
        }
        return this;
    }
}
OWebPager.SELF = "OWebPager";
OWebPager.EVT_PAGE_CHANGE = "OWebPager:page_change";
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlBhZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3BsdWdpbnMvT1dlYlBhZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQztBQUViLE9BQU8sU0FBUyxNQUFNLGNBQWMsQ0FBQztBQWtDckMsSUFBSSxNQUFNLEdBQVEsQ0FBQyxDQUFDO0FBQ3BCLElBQUksV0FBVyxHQUFHLENBQUMsTUFBcUIsRUFBRSxJQUFtQixFQUFXLEVBQUU7SUFDekUsSUFBSSxDQUFDLENBQUM7SUFDTixPQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFO1FBQ3ZCLElBQUksQ0FBQyxLQUFLLE1BQU0sRUFBRTtZQUNqQixPQUFPLElBQUksQ0FBQztTQUNaO1FBRUQsSUFBSSxHQUFHLENBQUMsQ0FBQztLQUNUO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDZCxDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsT0FBTyxnQkFBaUIsU0FBUSxTQUFTO0lBVS9DLFlBQTZCLFdBQW9CO1FBQ2hELEtBQUssRUFBRSxDQUFDO1FBRG9CLGdCQUFXLEdBQVgsV0FBVyxDQUFTO1FBTmhDLFdBQU0sR0FBNkIsRUFBRSxDQUFDO1FBRS9DLFdBQU0sR0FBc0MsRUFBRSxDQUFDO1FBQy9DLHFCQUFnQixHQUE0QixFQUFFLENBQUM7UUFLdEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFRCxRQUFRO1FBQ1AsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3BCLENBQUM7SUFFRCxPQUFPLENBQUMsSUFBWTtRQUNuQixJQUFJLElBQUksR0FBVSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BDLElBQUksU0FBUyxLQUFLLElBQUksRUFBRTtZQUN2QixNQUFNLElBQUksS0FBSyxDQUFDLHlCQUF5QixJQUFJLG1CQUFtQixDQUFDLENBQUM7U0FDbEU7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7SUFFRCxhQUFhO1FBQ1osSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDdkIsT0FBTyxDQUFDLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO1NBQzNDO1FBQ0QsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDO0lBQzFCLENBQUM7SUFFRCxXQUFXO1FBQ1YsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBRUQsWUFBWSxDQUFDLElBQVc7UUFDdkIsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUNyQixJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ3hCLE9BQU8sQ0FBQyxJQUFJLENBQUMscUJBQXFCLElBQUksc0JBQXNCLENBQUMsQ0FBQztTQUM5RDtRQUVELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBRXpCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUU1QixLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztRQUUvQyxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUFFTyxjQUFjLENBQUMsS0FBa0IsRUFBRSxJQUFXLEVBQUUsTUFBc0I7UUFFN0UsSUFBSSxNQUFNLEdBQWUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUM7UUFFakQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDdEMsSUFBSSxJQUFJLEdBQXVCLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN4QyxJQUFJLENBQUMsRUFBRSxHQUFtQixFQUFFLE1BQU0sQ0FBQztZQUNuQyxJQUFJLENBQUMsTUFBTSxHQUFlLE1BQU0sQ0FBQztZQUNqQyxJQUFJLENBQUMsSUFBSSxHQUFpQixNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDM0QsSUFBSSxDQUFDLE1BQU0sR0FBZSxLQUFLLENBQUM7WUFDaEMsSUFBSSxDQUFDLFlBQVksR0FBUyxLQUFLLENBQUM7WUFDaEMsSUFBSSxDQUFDLGFBQWEsR0FBUSxJQUFJLENBQUMsYUFBYSxJQUFJLEtBQUssQ0FBQztZQUN0RCxJQUFJLENBQUMsSUFBSSxHQUFpQixJQUFJLENBQUMsSUFBSSxLQUFLLEtBQUssQ0FBQztZQUU5QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRWpDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBRTNCLElBQUksSUFBSSxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRTtnQkFDaEMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQzthQUMxQztTQUNEO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDYixDQUFDO0lBRU8sU0FBUyxDQUFDLElBQW1CLEVBQUUsSUFBVztRQUNqRCxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUM7UUFFZixJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsT0FBTyxJQUFJLEVBQUUsRUFBRSxDQUFDLFlBQWlDLEVBQUUsRUFBRTtZQUMvRixPQUFPLENBQUMsR0FBRyxDQUFDLGdDQUFnQyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFFeEUsSUFBSSxJQUFJLENBQUMsYUFBYSxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsRUFBRTtnQkFDMUQsT0FBTyxZQUFZLENBQUMsSUFBSSxFQUFFLElBQUksR0FBRyxDQUFDLFdBQVcsQ0FBQyxhQUFhLEVBQUUsQ0FBQzthQUM5RDtZQUVELElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxZQUFZLENBQUM7WUFFekIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxXQUFXLElBQUksQ0FBQyxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUVsRCxJQUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUM7WUFFakQsR0FBRyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUM7aUJBQ3RCLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4QixDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sSUFBSSxDQUFDO0lBRWIsQ0FBQztJQUVPLGNBQWMsQ0FBQyxJQUFtQjtRQUN6QyxJQUFJLEtBQUssR0FBVyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7UUFDMUMsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7UUFFekIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDdEMsSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRWpCLENBQUMsQ0FBQyxNQUFNLEdBQVMsSUFBSSxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQ2xDLENBQUMsQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxJQUFJLFdBQVcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDbkQ7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7SUFFTyxjQUFjLENBQUMsT0FBYztRQUNwQyxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDO1FBRWhDLElBQUksT0FBTyxLQUFLLE9BQU8sRUFBRTtZQUN4QixPQUFPLENBQUMsR0FBRyxDQUFDLDhCQUE4QixFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztZQUM5RCxJQUFJLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQztZQUM1QixJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztTQUM1RDthQUFNO1lBQ04sT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsRUFBRSxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDMUQ7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7O0FBakllLGNBQUksR0FBYyxXQUFXLENBQUM7QUFDOUIseUJBQWUsR0FBRyx1QkFBdUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgT1dlYkV2ZW50IGZyb20gXCIuLi9PV2ViRXZlbnRcIjtcbmltcG9ydCBPV2ViUm91dGVyLCB7T1dlYkRpc3BhdGNoQ29udGV4dCwgdFJvdXRlQWN0aW9uLCB0Um91dGVPcHRpb25zfSBmcm9tIFwiLi4vT1dlYlJvdXRlclwiO1xuaW1wb3J0IE9XZWJBcHAgZnJvbSBcIi4uL09XZWJBcHBcIjtcblxuZXhwb3J0IGludGVyZmFjZSBpUGFnZSB7XG5cdG5hbWU6IHN0cmluZztcblx0Z2V0TGlua3M6ICgpID0+IHRQYWdlTGlua1tdO1xuXHRvblBhZ2VPcGVuPzogdFJvdXRlQWN0aW9uO1xuXHRvblBhZ2VDbG9zZT86IHRSb3V0ZUFjdGlvbjtcbn1cblxuZXhwb3J0IHR5cGUgdFBhZ2VMaW5rID0ge1xuXHR0aXRsZTogc3RyaW5nLFxuXHRwYXRoOiBzdHJpbmcsXG5cdHJlcXVpcmVfbG9naW4/OiBib29sZWFuLFxuXHRkZXNjcmlwdGlvbj86IHN0cmluZyxcblx0b3B0aW9ucz86IHRSb3V0ZU9wdGlvbnMsXG5cdHNob3c/OiBib29sZWFuLFxuXHRzbHVnPzogc3RyaW5nLFxuXHRpY29uPzogc3RyaW5nLFxuXHRzdWI/OiB0UGFnZUxpbmtbXVxufTtcblxuZXhwb3J0IHR5cGUgdFBhZ2VMaW5rRnVsbCA9IHRQYWdlTGluayAmIHtcblx0aWQ6IG51bWJlcixcblx0aHJlZjogc3RyaW5nLFxuXHRhY3RpdmU6IGJvb2xlYW4sXG5cdGFjdGl2ZV9jaGlsZDogYm9vbGVhbixcblx0cmVxdWlyZV9sb2dpbjogYm9vbGVhbixcblx0c2hvdzogYm9vbGVhbixcblx0cGFyZW50PzogdFBhZ2VMaW5rRnVsbCxcblx0c3ViPzogdFBhZ2VMaW5rRnVsbFtdXG59O1xuXG5sZXQgbGlua0lkICAgICAgPSAwO1xubGV0IF9pc1BhcmVudE9mID0gKHBhcmVudDogdFBhZ2VMaW5rRnVsbCwgbGluazogdFBhZ2VMaW5rRnVsbCk6IGJvb2xlYW4gPT4ge1xuXHRsZXQgcDtcblx0d2hpbGUgKHAgPSBsaW5rLnBhcmVudCkge1xuXHRcdGlmIChwID09PSBwYXJlbnQpIHtcblx0XHRcdHJldHVybiB0cnVlO1xuXHRcdH1cblxuXHRcdGxpbmsgPSBwO1xuXHR9XG5cdHJldHVybiBmYWxzZTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJQYWdlciBleHRlbmRzIE9XZWJFdmVudCB7XG5cdHN0YXRpYyByZWFkb25seSBTRUxGICAgICAgICAgICAgPSBcIk9XZWJQYWdlclwiO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX1BBR0VfQ0hBTkdFID0gXCJPV2ViUGFnZXI6cGFnZV9jaGFuZ2VcIjtcblxuXHRwcml2YXRlIHJlYWRvbmx5IF9wYWdlczogeyBba2V5OiBzdHJpbmddOiBpUGFnZSB9ID0ge307XG5cdHByaXZhdGUgX2FjdGl2ZV9wYWdlOiBpUGFnZSB8IHVuZGVmaW5lZDtcblx0cHJpdmF0ZSBfbGlua3M6IHRQYWdlTGlua0Z1bGxbXSAgICAgICAgICAgICAgICAgICA9IFtdO1xuXHRwcml2YXRlIF9saW5rc19mbGF0dGVuZWQ6IHRQYWdlTGlua0Z1bGxbXSAgICAgICAgID0gW107XG5cdHByaXZhdGUgX2FjdGl2ZV9saW5rPzogdFBhZ2VMaW5rRnVsbDtcblxuXHRjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGFwcF9jb250ZXh0OiBPV2ViQXBwKSB7XG5cdFx0c3VwZXIoKTtcblx0XHRjb25zb2xlLmxvZyhcIltPV2ViUGFnZXJdIHJlYWR5IVwiKTtcblx0fVxuXG5cdGdldExpbmtzKCk6IHRQYWdlTGlua0Z1bGxbXSB7XG5cdFx0cmV0dXJuIHRoaXMuX2xpbmtzO1xuXHR9XG5cblx0Z2V0UGFnZShuYW1lOiBzdHJpbmcpOiBpUGFnZSB7XG5cdFx0bGV0IHBhZ2U6IGlQYWdlID0gdGhpcy5fcGFnZXNbbmFtZV07XG5cdFx0aWYgKHVuZGVmaW5lZCA9PT0gcGFnZSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBbT1dlYlBhZ2VyXSB0aGUgcGFnZSBcIiR7bmFtZX1cIiBpcyBub3QgZGVmaW5lZC5gKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gcGFnZTtcblx0fVxuXG5cdGdldEFjdGl2ZVBhZ2UoKTogaVBhZ2UgfCB1bmRlZmluZWQge1xuXHRcdGlmICghdGhpcy5fYWN0aXZlX3BhZ2UpIHtcblx0XHRcdGNvbnNvbGUud2FybihcIltPV2ViUGFnZXJdIG5vIGFjdGl2ZSBwYWdlXCIpO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcy5fYWN0aXZlX3BhZ2U7XG5cdH1cblxuXHRnZXRQYWdlTGlzdCgpIHtcblx0XHRyZXR1cm4gT2JqZWN0LmNyZWF0ZSh0aGlzLl9wYWdlcyk7XG5cdH1cblxuXHRyZWdpc3RlclBhZ2UocGFnZTogaVBhZ2UpOiB0aGlzIHtcblx0XHRsZXQgbmFtZSA9IHBhZ2UubmFtZTtcblx0XHRpZiAobmFtZSBpbiB0aGlzLl9wYWdlcykge1xuXHRcdFx0Y29uc29sZS53YXJuKGBbT1dlYlBhZ2VyXSBwYWdlIFwiJHtuYW1lfVwiIHdpbGwgYmUgcmVkZWZpbmVkLmApO1xuXHRcdH1cblxuXHRcdHRoaXMuX3BhZ2VzW25hbWVdID0gcGFnZTtcblxuXHRcdGxldCBsaW5rcyA9IHBhZ2UuZ2V0TGlua3MoKTtcblxuXHRcdEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KHRoaXMuX2xpbmtzLCBsaW5rcyk7XG5cblx0XHRyZXR1cm4gdGhpcy5fcmVnaXN0ZXJMaW5rcyhsaW5rcywgcGFnZSk7XG5cdH1cblxuXHRwcml2YXRlIF9yZWdpc3RlckxpbmtzKGxpbmtzOiB0UGFnZUxpbmtbXSwgcGFnZTogaVBhZ2UsIHBhcmVudD86IHRQYWdlTGlua0Z1bGwpOiB0aGlzIHtcblxuXHRcdGxldCByb3V0ZXI6IE9XZWJSb3V0ZXIgPSB0aGlzLmFwcF9jb250ZXh0LnJvdXRlcjtcblxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgbGlua3MubGVuZ3RoOyBpKyspIHtcblx0XHRcdGxldCBsaW5rOiB0UGFnZUxpbmtGdWxsID0gPGFueT5saW5rc1tpXTtcblx0XHRcdGxpbmsuaWQgICAgICAgICAgICAgICAgID0gKytsaW5rSWQ7XG5cdFx0XHRsaW5rLnBhcmVudCAgICAgICAgICAgICA9IHBhcmVudDtcblx0XHRcdGxpbmsuaHJlZiAgICAgICAgICAgICAgID0gcm91dGVyLnBhdGhUb1VSTChsaW5rLnBhdGgpLmhyZWY7XG5cdFx0XHRsaW5rLmFjdGl2ZSAgICAgICAgICAgICA9IGZhbHNlO1xuXHRcdFx0bGluay5hY3RpdmVfY2hpbGQgICAgICAgPSBmYWxzZTtcblx0XHRcdGxpbmsucmVxdWlyZV9sb2dpbiAgICAgID0gbGluay5yZXF1aXJlX2xvZ2luIHx8IGZhbHNlO1xuXHRcdFx0bGluay5zaG93ICAgICAgICAgICAgICAgPSBsaW5rLnNob3cgIT09IGZhbHNlO1xuXG5cdFx0XHR0aGlzLl9saW5rc19mbGF0dGVuZWQucHVzaChsaW5rKTtcblxuXHRcdFx0dGhpcy5fYWRkUm91dGUobGluaywgcGFnZSk7XG5cblx0XHRcdGlmIChsaW5rLnN1YiAmJiBsaW5rLnN1Yi5sZW5ndGgpIHtcblx0XHRcdFx0dGhpcy5fcmVnaXN0ZXJMaW5rcyhsaW5rLnN1YiwgcGFnZSwgbGluayk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRwcml2YXRlIF9hZGRSb3V0ZShsaW5rOiB0UGFnZUxpbmtGdWxsLCBwYWdlOiBpUGFnZSk6IHRoaXMge1xuXHRcdGxldCBjdHggPSB0aGlzO1xuXG5cdFx0dGhpcy5hcHBfY29udGV4dC5yb3V0ZXIub24obGluay5wYXRoLCBsaW5rLm9wdGlvbnMgfHwge30sIChyb3V0ZUNvbnRleHQ6IE9XZWJEaXNwYXRjaENvbnRleHQpID0+IHtcblx0XHRcdGNvbnNvbGUubG9nKFwiW09XZWJQYWdlcl0gcGFnZSBsaW5rIG1hdGNoIC0+XCIsIGxpbmssIHBhZ2UsIHJvdXRlQ29udGV4dCk7XG5cblx0XHRcdGlmIChsaW5rLnJlcXVpcmVfbG9naW4gJiYgIWN0eC5hcHBfY29udGV4dC51c2VyVmVyaWZpZWQoKSkge1xuXHRcdFx0XHRyZXR1cm4gcm91dGVDb250ZXh0LnN0b3AoKSAmJiBjdHguYXBwX2NvbnRleHQuc2hvd0xvZ2luUGFnZSgpO1xuXHRcdFx0fVxuXG5cdFx0XHRsZXQgcCA9IGN0eC5fYWN0aXZlX3BhZ2U7XG5cblx0XHRcdHAgJiYgcC5vblBhZ2VDbG9zZSAmJiBwLm9uUGFnZUNsb3NlKHJvdXRlQ29udGV4dCk7XG5cblx0XHRcdHBhZ2Uub25QYWdlT3BlbiAmJiBwYWdlLm9uUGFnZU9wZW4ocm91dGVDb250ZXh0KTtcblxuXHRcdFx0Y3R4Ll9zZXRBY3RpdmVQYWdlKHBhZ2UpXG5cdFx0XHRcdC5fc2V0QWN0aXZlTGluayhsaW5rKTtcblx0XHR9KTtcblxuXHRcdHJldHVybiB0aGlzO1xuXG5cdH1cblxuXHRwcml2YXRlIF9zZXRBY3RpdmVMaW5rKGxpbms6IHRQYWdlTGlua0Z1bGwpOiB0aGlzIHtcblx0XHRsZXQgbGlua3MgICAgICAgICA9IHRoaXMuX2xpbmtzX2ZsYXR0ZW5lZDtcblx0XHR0aGlzLl9hY3RpdmVfbGluayA9IGxpbms7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGxpbmtzLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRsZXQgYyA9IGxpbmtzW2ldO1xuXG5cdFx0XHRjLmFjdGl2ZSAgICAgICA9IGxpbmsuaWQgPT09IGMuaWQ7XG5cdFx0XHRjLmFjdGl2ZV9jaGlsZCA9ICFjLmFjdGl2ZSAmJiBfaXNQYXJlbnRPZihjLCBsaW5rKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHByaXZhdGUgX3NldEFjdGl2ZVBhZ2UobmV3UGFnZTogaVBhZ2UpOiB0aGlzIHtcblx0XHRsZXQgb2xkUGFnZSA9IHRoaXMuX2FjdGl2ZV9wYWdlO1xuXG5cdFx0aWYgKG9sZFBhZ2UgIT09IG5ld1BhZ2UpIHtcblx0XHRcdGNvbnNvbGUubG9nKGBbT1dlYlBhZ2VyXSBwYWdlIGNoYW5naW5nIC0+YCwgbmV3UGFnZSwgb2xkUGFnZSk7XG5cdFx0XHR0aGlzLl9hY3RpdmVfcGFnZSA9IG5ld1BhZ2U7XG5cdFx0XHR0aGlzLnRyaWdnZXIoT1dlYlBhZ2VyLkVWVF9QQUdFX0NIQU5HRSwgW29sZFBhZ2UsIG5ld1BhZ2VdKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc29sZS5sb2coYFtPV2ViUGFnZXJdIHNhbWUgcGFnZSAtPmAsIG9sZFBhZ2UsIG5ld1BhZ2UpO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG59Il19