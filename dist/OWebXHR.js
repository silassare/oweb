import OWebNet from './OWebNet';
import { buildURL, forEach, isPlainObject } from './utils';
const setOrIgnoreIfExists = function setOrIgnoreIfExists(target, key, value, caseSensitive = false) {
    if (!target[key] && (!caseSensitive || !target[key.toUpperCase()])) {
        target[key] = value;
    }
};
export default class OWebXHR extends OWebNet {
    _abort;
    _sent = false;
    /**
     * OWebXHR constructor.
     *
     * @param url
     * @param options
     */
    constructor(url, options) {
        super(url, {
            method: 'get',
            timeout: 0,
            withCredentials: false,
            responseType: 'json',
            headers: {},
            isSuccessStatus: (status) => status >= 200 && status < 300,
            isGoodNews: () => {
                return true;
            },
            errorResponseToDialog: () => {
                return { text: 'OW_ERROR_REQUEST_FAILED' };
            },
            ...options,
        });
    }
    /**
     * @inheritDoc
     */
    isSent() {
        return this._sent;
    }
    /**
     * @inheritDoc
     */
    send() {
        this.assertNotSent('[OWebXHR] request is already sent.');
        let x = this, xhr = new XMLHttpRequest();
        const opt = x.options, always = () => {
            x.trigger(OWebNet.EVT_FINISH);
            xhr = x = null;
        }, onerror = (err) => {
            x.trigger(OWebNet.EVT_ERROR, [err]);
            x.trigger(OWebNet.EVT_FAIL, [err]);
            always();
        }, body = this.requestBody(opt.body);
        xhr.timeout = opt.timeout;
        setOrIgnoreIfExists(opt.headers, 'Accept', 'application/json, text/plain, */*');
        xhr.withCredentials = opt.withCredentials;
        xhr.onreadystatechange = function onReadyStateChange() {
            if (!xhr || xhr.readyState !== 4) {
                return;
            }
            // The request errored out and we didn't get a response, this will be
            // handled by onerror instead
            // With one exception: request that using file: protocol, most browsers
            // will return status as 0 even though it's a successful request
            if (xhr.status === 0 &&
                !(xhr.responseURL && xhr.responseURL.indexOf('file:') === 0)) {
                return;
            }
            const responseRaw = xhr[(xhr.responseType || 'text') === 'text' ? 'responseText' : 'response'];
            let json = null;
            if (typeof responseRaw === 'string') {
                try {
                    json = JSON.parse(responseRaw);
                    // eslint-disable-next-line no-empty
                }
                catch (e) { }
            }
            const response = {
                isSuccessStatus: opt.isSuccessStatus(xhr.status),
                isGoodNews: opt.isGoodNews(json),
                raw: responseRaw,
                json,
                status: xhr.status,
                statusText: xhr.statusText,
            };
            x.trigger(OWebNet.EVT_RESPONSE, [response]);
            if (response.isSuccessStatus) {
                x.trigger(OWebNet.EVT_HTTP_SUCCESS, [response]);
                if (response.isGoodNews) {
                    x.trigger(OWebNet.EVT_GOOD_NEWS, [response]);
                }
                else {
                    x.trigger(OWebNet.EVT_BAD_NEWS, [response]);
                    const err = {
                        type: 'error',
                        errType: 'bad_news',
                        ...x.options.errorResponseToDialog(response),
                    };
                    x.trigger(OWebNet.EVT_FAIL, [err]);
                }
            }
            else {
                x.trigger(OWebNet.EVT_HTTP_ERROR, [response]);
                const err = {
                    type: 'error',
                    errType: 'http',
                    ...x.options.errorResponseToDialog(response),
                };
                x.trigger(OWebNet.EVT_FAIL, [err]);
            }
            always();
        };
        xhr.addEventListener('progress', function onDownloadProgress(event) {
            // report download progress
            x.trigger(OWebNet.EVT_DOWNLOAD_PROGRESS, [event]);
        });
        xhr.upload.addEventListener('progress', function onUploadProgress(event) {
            // report upload progress
            x.trigger(OWebNet.EVT_UPLOAD_PROGRESS, [event]);
        });
        xhr.onabort = function onAbort(event) {
            onerror({
                type: 'error',
                errType: 'abort',
                text: 'OW_ERROR_REQUEST_ABORTED',
                data: { event },
            });
        };
        xhr.ontimeout = function onTimeout(event) {
            onerror({
                type: 'error',
                errType: 'timeout',
                text: 'OW_ERROR_REQUEST_TIMED_OUT',
                data: { event },
            });
        };
        xhr.onerror = function onError(event) {
            // handle non-HTTP error (e.g. network down)
            onerror({
                type: 'error',
                errType: 'network',
                text: 'OZ_ERROR_NETWORK',
                data: { event },
            });
        };
        this._abort = () => {
            xhr && xhr.abort();
        };
        const url = this.options.params
            ? buildURL(this.url, this.options.params)
            : this.url;
        xhr.open(opt.method.toUpperCase(), url, true);
        forEach(opt.headers, function requestHeaderIterator(value, header) {
            xhr.setRequestHeader(header, value);
        });
        return new Promise(function xhrPromiseExecutor(resolve, reject) {
            x.onGoodNews((response) => resolve(response)).onFail((err) => reject(err));
            x._sent = true;
            xhr.send(body);
        });
    }
    /**
     * @inheritDoc
     */
    abort() {
        this._abort && this._abort();
        return this;
    }
    /**
     * Builds the request body.
     *
     * @param body
     * @private
     */
    requestBody(body) {
        if (body === null || typeof body === 'undefined') {
            return null;
        }
        if (body instanceof URLSearchParams) {
            setOrIgnoreIfExists(this.options.headers, 'Content-Type', 'application/x-www-form-urlencoded;charset=utf-8');
            return body.toString();
        }
        if (isPlainObject(body)) {
            setOrIgnoreIfExists(this.options.headers, 'Content-Type', 'application/json;charset=utf-8');
            return JSON.stringify(body);
        }
        return body;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlhIUi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViWEhSLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sT0FLTixNQUFNLFdBQVcsQ0FBQztBQUNuQixPQUFPLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFM0QsTUFBTSxtQkFBbUIsR0FBRyxTQUFTLG1CQUFtQixDQUN2RCxNQUFXLEVBQ1gsR0FBVyxFQUNYLEtBQVUsRUFDVixhQUFhLEdBQUcsS0FBSztJQUVyQixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxhQUFhLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsRUFBRTtRQUNuRSxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO0tBQ3BCO0FBQ0YsQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLE9BQU8sT0FBTyxPQUFXLFNBQVEsT0FBVTtJQUN6QyxNQUFNLENBQWM7SUFDcEIsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUV0Qjs7Ozs7T0FLRztJQUNILFlBQVksR0FBVyxFQUFFLE9BQXVDO1FBQy9ELEtBQUssQ0FBQyxHQUFHLEVBQUU7WUFDVixNQUFNLEVBQUUsS0FBSztZQUNiLE9BQU8sRUFBRSxDQUFDO1lBQ1YsZUFBZSxFQUFFLEtBQUs7WUFDdEIsWUFBWSxFQUFFLE1BQU07WUFDcEIsT0FBTyxFQUFFLEVBQUU7WUFDWCxlQUFlLEVBQUUsQ0FBQyxNQUFjLEVBQUUsRUFBRSxDQUFDLE1BQU0sSUFBSSxHQUFHLElBQUksTUFBTSxHQUFHLEdBQUc7WUFDbEUsVUFBVSxFQUFFLEdBQUcsRUFBRTtnQkFDaEIsT0FBTyxJQUFJLENBQUM7WUFDYixDQUFDO1lBQ0QscUJBQXFCLEVBQUUsR0FBRyxFQUFFO2dCQUMzQixPQUFPLEVBQUUsSUFBSSxFQUFFLHlCQUF5QixF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QUFJLENBQUM7U0FDWjtRQUVELElBQUksSUFBSSxZQUFZLGVBQWUsRUFBRTtZQUNwQyxtQkFBbUIsQ0FDbEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQ3BCLGNBQWMsRUFDZCxpREFBaUQsQ0FDakQsQ0FBQztZQUVGLE9BQU8sSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1NBQ3ZCO1FBRUQsSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDeEIsbUJBQW1CLENBQ2xCLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUNwQixjQUFjLEVBQ2QsZ0NBQWdDLENBQ2hDLENBQUM7WUFFRixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDNUI7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBPV2ViTmV0LCB7XG5cdE9OZXRFcnJvcixcblx0T05ldFJlcXVlc3RPcHRpb25zLFxuXHRPTmV0UmVzcG9uc2UsXG5cdE9OZXRSZXF1ZXN0Qm9keSxcbn0gZnJvbSAnLi9PV2ViTmV0JztcbmltcG9ydCB7IGJ1aWxkVVJMLCBmb3JFYWNoLCBpc1BsYWluT2JqZWN0IH0gZnJvbSAnLi91dGlscyc7XG5cbmNvbnN0IHNldE9ySWdub3JlSWZFeGlzdHMgPSBmdW5jdGlvbiBzZXRPcklnbm9yZUlmRXhpc3RzKFxuXHR0YXJnZXQ6IGFueSxcblx0a2V5OiBzdHJpbmcsXG5cdHZhbHVlOiBhbnksXG5cdGNhc2VTZW5zaXRpdmUgPSBmYWxzZVxuKSB7XG5cdGlmICghdGFyZ2V0W2tleV0gJiYgKCFjYXNlU2Vuc2l0aXZlIHx8ICF0YXJnZXRba2V5LnRvVXBwZXJDYXNlKCldKSkge1xuXHRcdHRhcmdldFtrZXldID0gdmFsdWU7XG5cdH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJYSFI8VD4gZXh0ZW5kcyBPV2ViTmV0PFQ+IHtcblx0cHJpdmF0ZSBfYWJvcnQ/OiAoKSA9PiB2b2lkO1xuXHRwcml2YXRlIF9zZW50ID0gZmFsc2U7XG5cblx0LyoqXG5cdCAqIE9XZWJYSFIgY29uc3RydWN0b3IuXG5cdCAqXG5cdCAqIEBwYXJhbSB1cmxcblx0ICogQHBhcmFtIG9wdGlvbnNcblx0ICovXG5cdGNvbnN0cnVjdG9yKHVybDogc3RyaW5nLCBvcHRpb25zOiBQYXJ0aWFsPE9OZXRSZXF1ZXN0T3B0aW9uczxUPj4pIHtcblx0XHRzdXBlcih1cmwsIHtcblx0XHRcdG1ldGhvZDogJ2dldCcsXG5cdFx0XHR0aW1lb3V0OiAwLFxuXHRcdFx0d2l0aENyZWRlbnRpYWxzOiBmYWxzZSxcblx0XHRcdHJlc3BvbnNlVHlwZTogJ2pzb24nLFxuXHRcdFx0aGVhZGVyczoge30sXG5cdFx0XHRpc1N1Y2Nlc3NTdGF0dXM6IChzdGF0dXM6IG51bWJlcikgPT4gc3RhdHVzID49IDIwMCAmJiBzdGF0dXMgPCAzMDAsXG5cdFx0XHRpc0dvb2ROZXdzOiAoKSA9PiB7XG5cdFx0XHRcdHJldHVybiB0cnVlO1xuXHRcdFx0fSxcblx0XHRcdGVycm9yUmVzcG9uc2VUb0RpYWxvZzogKCkgPT4ge1xuXHRcdFx0XHRyZXR1cm4geyB0ZXh0OiAnT1dfRVJST1JfUkVRVUVTVF9GQUlMRUQnIH07XG5cdFx0XHR9LFxuXHRcdFx0Li4ub3B0aW9ucyxcblx0XHR9KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0aXNTZW50KCk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiB0aGlzLl9zZW50O1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRzZW5kKCk6IFByb21pc2U8T05ldFJlc3BvbnNlPFQ+PiB7XG5cdFx0dGhpcy5hc3NlcnROb3RTZW50KCdbT1dlYlhIUl0gcmVxdWVzdCBpcyBhbHJlYWR5IHNlbnQuJyk7XG5cblx0XHRsZXQgeCA9IHRoaXMsXG5cdFx0XHR4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcblx0XHRjb25zdCBvcHQgPSB4Lm9wdGlvbnMsXG5cdFx0XHRhbHdheXMgPSAoKSA9PiB7XG5cdFx0XHRcdHgudHJpZ2dlcihPV2ViTmV0LkVWVF9GSU5JU0gpO1xuXHRcdFx0XHR4aHIgPSB4ID0gbnVsbCBhcyBhbnk7XG5cdFx0XHR9LFxuXHRcdFx0b25lcnJvciA9IChlcnI6IE9OZXRFcnJvcikgPT4ge1xuXHRcdFx0XHR4LnRyaWdnZXIoT1dlYk5ldC5FVlRfRVJST1IsIFtlcnJdKTtcblx0XHRcdFx0eC50cmlnZ2VyKE9XZWJOZXQuRVZUX0ZBSUwsIFtlcnJdKTtcblx0XHRcdFx0YWx3YXlzKCk7XG5cdFx0XHR9LFxuXHRcdFx0Ym9keSA9IHRoaXMucmVxdWVzdEJvZHkob3B0LmJvZHkpO1xuXG5cdFx0eGhyLnRpbWVvdXQgPSBvcHQudGltZW91dDtcblxuXHRcdHNldE9ySWdub3JlSWZFeGlzdHMoXG5cdFx0XHRvcHQuaGVhZGVycyxcblx0XHRcdCdBY2NlcHQnLFxuXHRcdFx0J2FwcGxpY2F0aW9uL2pzb24sIHRleHQvcGxhaW4sICovKidcblx0XHQpO1xuXG5cdFx0eGhyLndpdGhDcmVkZW50aWFscyA9IG9wdC53aXRoQ3JlZGVudGlhbHM7XG5cblx0XHR4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gb25SZWFkeVN0YXRlQ2hhbmdlKCkge1xuXHRcdFx0aWYgKCF4aHIgfHwgeGhyLnJlYWR5U3RhdGUgIT09IDQpIHtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXG5cdFx0XHQvLyBUaGUgcmVxdWVzdCBlcnJvcmVkIG91dCBhbmQgd2UgZGlkbid0IGdldCBhIHJlc3BvbnNlLCB0aGlzIHdpbGwgYmVcblx0XHRcdC8vIGhhbmRsZWQgYnkgb25lcnJvciBpbnN0ZWFkXG5cdFx0XHQvLyBXaXRoIG9uZSBleGNlcHRpb246IHJlcXVlc3QgdGhhdCB1c2luZyBmaWxlOiBwcm90b2NvbCwgbW9zdCBicm93c2Vyc1xuXHRcdFx0Ly8gd2lsbCByZXR1cm4gc3RhdHVzIGFzIDAgZXZlbiB0aG91Z2ggaXQncyBhIHN1Y2Nlc3NmdWwgcmVxdWVzdFxuXHRcdFx0aWYgKFxuXHRcdFx0XHR4aHIuc3RhdHVzID09PSAwICYmXG5cdFx0XHRcdCEoeGhyLnJlc3BvbnNlVVJMICYmIHhoci5yZXNwb25zZVVSTC5pbmRleE9mKCdmaWxlOicpID09PSAwKVxuXHRcdFx0KSB7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgcmVzcG9uc2VSYXcgPVxuXHRcdFx0XHR4aHJbXG5cdFx0XHRcdFx0KHhoci5yZXNwb25zZVR5cGUgfHwgJ3RleHQnKSA9PT0gJ3RleHQnID8gJ3Jlc3BvbnNlVGV4dCcgOiAncmVzcG9uc2UnXG5cdFx0XHRcdF07XG5cblx0XHRcdGxldCBqc29uID0gbnVsbCBhcyBhbnk7XG5cblx0XHRcdGlmICh0eXBlb2YgcmVzcG9uc2VSYXcgPT09ICdzdHJpbmcnKSB7XG5cdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0anNvbiA9IEpTT04ucGFyc2UocmVzcG9uc2VSYXcpO1xuXHRcdFx0XHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1lbXB0eVxuXHRcdFx0XHR9IGNhdGNoIChlKSB7fVxuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCByZXNwb25zZTogT05ldFJlc3BvbnNlPFQ+ID0ge1xuXHRcdFx0XHRpc1N1Y2Nlc3NTdGF0dXM6IG9wdC5pc1N1Y2Nlc3NTdGF0dXMoeGhyLnN0YXR1cyksXG5cdFx0XHRcdGlzR29vZE5ld3M6IG9wdC5pc0dvb2ROZXdzKGpzb24pLFxuXHRcdFx0XHRyYXc6IHJlc3BvbnNlUmF3LFxuXHRcdFx0XHRqc29uLFxuXHRcdFx0XHRzdGF0dXM6IHhoci5zdGF0dXMsXG5cdFx0XHRcdHN0YXR1c1RleHQ6IHhoci5zdGF0dXNUZXh0LFxuXHRcdFx0fTtcblxuXHRcdFx0eC50cmlnZ2VyKE9XZWJOZXQuRVZUX1JFU1BPTlNFLCBbcmVzcG9uc2VdKTtcblxuXHRcdFx0aWYgKHJlc3BvbnNlLmlzU3VjY2Vzc1N0YXR1cykge1xuXHRcdFx0XHR4LnRyaWdnZXIoT1dlYk5ldC5FVlRfSFRUUF9TVUNDRVNTLCBbcmVzcG9uc2VdKTtcblxuXHRcdFx0XHRpZiAocmVzcG9uc2UuaXNHb29kTmV3cykge1xuXHRcdFx0XHRcdHgudHJpZ2dlcihPV2ViTmV0LkVWVF9HT09EX05FV1MsIFtyZXNwb25zZV0pO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHgudHJpZ2dlcihPV2ViTmV0LkVWVF9CQURfTkVXUywgW3Jlc3BvbnNlXSk7XG5cdFx0XHRcdFx0Y29uc3QgZXJyOiBPTmV0RXJyb3IgPSB7XG5cdFx0XHRcdFx0XHR0eXBlOiAnZXJyb3InLFxuXHRcdFx0XHRcdFx0ZXJyVHlwZTogJ2JhZF9uZXdzJyxcblx0XHRcdFx0XHRcdC4uLngub3B0aW9ucy5lcnJvclJlc3BvbnNlVG9EaWFsb2cocmVzcG9uc2UpLFxuXHRcdFx0XHRcdH07XG5cdFx0XHRcdFx0eC50cmlnZ2VyKE9XZWJOZXQuRVZUX0ZBSUwsIFtlcnJdKTtcblx0XHRcdFx0fVxuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0eC50cmlnZ2VyKE9XZWJOZXQuRVZUX0hUVFBfRVJST1IsIFtyZXNwb25zZV0pO1xuXHRcdFx0XHRjb25zdCBlcnI6IE9OZXRFcnJvciA9IHtcblx0XHRcdFx0XHR0eXBlOiAnZXJyb3InLFxuXHRcdFx0XHRcdGVyclR5cGU6ICdodHRwJyxcblx0XHRcdFx0XHQuLi54Lm9wdGlvbnMuZXJyb3JSZXNwb25zZVRvRGlhbG9nKHJlc3BvbnNlKSxcblx0XHRcdFx0fTtcblx0XHRcdFx0eC50cmlnZ2VyKE9XZWJOZXQuRVZUX0ZBSUwsIFtlcnJdKTtcblx0XHRcdH1cblxuXHRcdFx0YWx3YXlzKCk7XG5cdFx0fTtcblxuXHRcdHhoci5hZGRFdmVudExpc3RlbmVyKCdwcm9ncmVzcycsIGZ1bmN0aW9uIG9uRG93bmxvYWRQcm9ncmVzcyhldmVudCkge1xuXHRcdFx0Ly8gcmVwb3J0IGRvd25sb2FkIHByb2dyZXNzXG5cdFx0XHR4LnRyaWdnZXIoT1dlYk5ldC5FVlRfRE9XTkxPQURfUFJPR1JFU1MsIFtldmVudF0pO1xuXHRcdH0pO1xuXG5cdFx0eGhyLnVwbG9hZC5hZGRFdmVudExpc3RlbmVyKCdwcm9ncmVzcycsIGZ1bmN0aW9uIG9uVXBsb2FkUHJvZ3Jlc3MoZXZlbnQpIHtcblx0XHRcdC8vIHJlcG9ydCB1cGxvYWQgcHJvZ3Jlc3Ncblx0XHRcdHgudHJpZ2dlcihPV2ViTmV0LkVWVF9VUExPQURfUFJPR1JFU1MsIFtldmVudF0pO1xuXHRcdH0pO1xuXG5cdFx0eGhyLm9uYWJvcnQgPSBmdW5jdGlvbiBvbkFib3J0KGV2ZW50KSB7XG5cdFx0XHRvbmVycm9yKHtcblx0XHRcdFx0dHlwZTogJ2Vycm9yJyxcblx0XHRcdFx0ZXJyVHlwZTogJ2Fib3J0Jyxcblx0XHRcdFx0dGV4dDogJ09XX0VSUk9SX1JFUVVFU1RfQUJPUlRFRCcsXG5cdFx0XHRcdGRhdGE6IHsgZXZlbnQgfSxcblx0XHRcdH0pO1xuXHRcdH07XG5cblx0XHR4aHIub250aW1lb3V0ID0gZnVuY3Rpb24gb25UaW1lb3V0KGV2ZW50KSB7XG5cdFx0XHRvbmVycm9yKHtcblx0XHRcdFx0dHlwZTogJ2Vycm9yJyxcblx0XHRcdFx0ZXJyVHlwZTogJ3RpbWVvdXQnLFxuXHRcdFx0XHR0ZXh0OiAnT1dfRVJST1JfUkVRVUVTVF9USU1FRF9PVVQnLFxuXHRcdFx0XHRkYXRhOiB7IGV2ZW50IH0sXG5cdFx0XHR9KTtcblx0XHR9O1xuXG5cdFx0eGhyLm9uZXJyb3IgPSBmdW5jdGlvbiBvbkVycm9yKGV2ZW50KSB7XG5cdFx0XHQvLyBoYW5kbGUgbm9uLUhUVFAgZXJyb3IgKGUuZy4gbmV0d29yayBkb3duKVxuXHRcdFx0b25lcnJvcih7XG5cdFx0XHRcdHR5cGU6ICdlcnJvcicsXG5cdFx0XHRcdGVyclR5cGU6ICduZXR3b3JrJyxcblx0XHRcdFx0dGV4dDogJ09aX0VSUk9SX05FVFdPUksnLFxuXHRcdFx0XHRkYXRhOiB7IGV2ZW50IH0sXG5cdFx0XHR9KTtcblx0XHR9O1xuXG5cdFx0dGhpcy5fYWJvcnQgPSAoKSA9PiB7XG5cdFx0XHR4aHIgJiYgeGhyLmFib3J0KCk7XG5cdFx0fTtcblxuXHRcdGNvbnN0IHVybCA9IHRoaXMub3B0aW9ucy5wYXJhbXNcblx0XHRcdD8gYnVpbGRVUkwodGhpcy51cmwsIHRoaXMub3B0aW9ucy5wYXJhbXMpXG5cdFx0XHQ6IHRoaXMudXJsO1xuXG5cdFx0eGhyLm9wZW4ob3B0Lm1ldGhvZC50b1VwcGVyQ2FzZSgpLCB1cmwsIHRydWUpO1xuXG5cdFx0Zm9yRWFjaChvcHQuaGVhZGVycywgZnVuY3Rpb24gcmVxdWVzdEhlYWRlckl0ZXJhdG9yKHZhbHVlLCBoZWFkZXIpIHtcblx0XHRcdHhoci5zZXRSZXF1ZXN0SGVhZGVyKGhlYWRlciwgdmFsdWUpO1xuXHRcdH0pO1xuXG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlPE9OZXRSZXNwb25zZTxUPj4oZnVuY3Rpb24geGhyUHJvbWlzZUV4ZWN1dG9yKFxuXHRcdFx0cmVzb2x2ZTogKHJlc3BvbnNlOiBPTmV0UmVzcG9uc2U8VD4pID0+IHZvaWQsXG5cdFx0XHRyZWplY3Q6IChlcnJvcjogT05ldEVycm9yKSA9PiB2b2lkXG5cdFx0KSB7XG5cdFx0XHR4Lm9uR29vZE5ld3MoKHJlc3BvbnNlKSA9PiByZXNvbHZlKHJlc3BvbnNlKSkub25GYWlsKChlcnIpID0+XG5cdFx0XHRcdHJlamVjdChlcnIpXG5cdFx0XHQpO1xuXG5cdFx0XHR4Ll9zZW50ID0gdHJ1ZTtcblx0XHRcdHhoci5zZW5kKGJvZHkpO1xuXHRcdH0pO1xuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRhYm9ydCgpOiB0aGlzIHtcblx0XHR0aGlzLl9hYm9ydCAmJiB0aGlzLl9hYm9ydCgpO1xuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0LyoqXG5cdCAqIEJ1aWxkcyB0aGUgcmVxdWVzdCBib2R5LlxuXHQgKlxuXHQgKiBAcGFyYW0gYm9keVxuXHQgKiBAcHJpdmF0ZVxuXHQgKi9cblx0cHJpdmF0ZSByZXF1ZXN0Qm9keShib2R5OiBPTmV0UmVxdWVzdEJvZHkpOiBhbnkge1xuXHRcdGlmIChib2R5ID09PSBudWxsIHx8IHR5cGVvZiBib2R5ID09PSAndW5kZWZpbmVkJykge1xuXHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0fVxuXG5cdFx0aWYgKGJvZHkgaW5zdGFuY2VvZiBVUkxTZWFyY2hQYXJhbXMpIHtcblx0XHRcdHNldE9ySWdub3JlSWZFeGlzdHMoXG5cdFx0XHRcdHRoaXMub3B0aW9ucy5oZWFkZXJzLFxuXHRcdFx0XHQnQ29udGVudC1UeXBlJyxcblx0XHRcdFx0J2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZDtjaGFyc2V0PXV0Zi04J1xuXHRcdFx0KTtcblxuXHRcdFx0cmV0dXJuIGJvZHkudG9TdHJpbmcoKTtcblx0XHR9XG5cblx0XHRpZiAoaXNQbGFpbk9iamVjdChib2R5KSkge1xuXHRcdFx0c2V0T3JJZ25vcmVJZkV4aXN0cyhcblx0XHRcdFx0dGhpcy5vcHRpb25zLmhlYWRlcnMsXG5cdFx0XHRcdCdDb250ZW50LVR5cGUnLFxuXHRcdFx0XHQnYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PXV0Zi04J1xuXHRcdFx0KTtcblxuXHRcdFx0cmV0dXJuIEpTT04uc3RyaW5naWZ5KGJvZHkpO1xuXHRcdH1cblxuXHRcdHJldHVybiBib2R5O1xuXHR9XG59XG4iXX0=