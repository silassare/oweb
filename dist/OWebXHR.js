import OWebNet from './OWebNet';
import { forEach } from './utils';
const setOrIgnoreIfExists = function (target, key, value, caseSensitive = false) {
    if (!target[key] && (!caseSensitive || !target[key.toUpperCase()])) {
        target[key] = value;
    }
};
export default class OWebXHR extends OWebNet {
    constructor(url, options) {
        super(url, {
            method: 'get',
            timeout: 0,
            withCredentials: false,
            responseType: 'json',
            headers: {},
            isSuccessStatus: (status) => status >= 200 && status < 300,
            isGoodNews: (response) => {
                return true;
            },
            ...options,
        });
        this._sent = false;
    }
    _assertNotSent() {
        if (this._sent) {
            throw Error('[OWebXHR] request is already sent.');
        }
    }
    promise() {
        this._assertNotSent();
        const x = this;
        return new Promise(function (resolve, reject) {
            x.onResponse((response) => resolve(response))
                .onError((err) => reject(err))
                .send();
        });
    }
    send() {
        this._assertNotSent();
        this._sent = true;
        let x = this, xhr = new XMLHttpRequest();
        const opt = x.options, always = () => {
            x.trigger(OWebNet.EVT_FINISHED);
            xhr = x = null;
        }, onerror = (err) => {
            x.trigger(OWebNet.EVT_ERROR, [err]);
            always();
        }, body = this.requestBody(opt.body);
        xhr.timeout = opt.timeout;
        setOrIgnoreIfExists(opt.headers, 'Accept', 'application/json, text/plain, */*');
        xhr.withCredentials = opt.withCredentials;
        xhr.onreadystatechange = function () {
            if (!xhr || xhr.readyState !== 4) {
                return;
            }
            // The request errored out and we didn't get a response, this will be
            // handled by onerror instead
            // With one exception: request that using file: protocol, most browsers
            // will return status as 0 even though it's a successful request
            if (xhr.status === 0 &&
                !(xhr.responseURL && xhr.responseURL.indexOf('file:') === 0)) {
                return;
            }
            const responseRaw = xhr[(xhr.responseType || 'text') === 'text'
                ? 'responseText'
                : 'response'];
            const response = {
                raw: responseRaw,
                json: null,
                status: xhr.status,
                statusText: xhr.statusText,
            };
            if (typeof responseRaw === 'string') {
                try {
                    response.json = JSON.parse(responseRaw);
                    // tslint:disable-next-line: no-empty
                }
                catch (e) { }
            }
            x.trigger(OWebNet.EVT_RESPONSE, [response]);
            if (opt.isSuccessStatus(xhr.status)) {
                x.trigger(OWebNet.EVT_HTTP_SUCCESS, [response]);
                if (opt.isGoodNews(response)) {
                    x.trigger(OWebNet.EVT_GOOD_NEWS, [response]);
                }
                else {
                    x.trigger(OWebNet.EVT_BAD_NEWS, [response]);
                }
            }
            else {
                x.trigger(OWebNet.EVT_HTTP_ERROR, [response]);
            }
            always();
        };
        xhr.addEventListener('progress', function (event) {
            // report download progress
            x.trigger(OWebNet.EVT_DOWNLOAD_PROGRESS, [event]);
        });
        xhr.upload.addEventListener('progress', function (event) {
            // report upload progress
            x.trigger(OWebNet.EVT_UPLOAD_PROGRESS, [event]);
        });
        xhr.onabort = function (event) {
            onerror({ type: 'abort', event });
        };
        xhr.ontimeout = function (event) {
            onerror({ type: 'timeout', event });
        };
        xhr.onerror = function (event) {
            // handle non-HTTP error (e.g. network down)
            onerror({ type: 'network', event });
        };
        this._abort = () => {
            xhr && xhr.abort();
        };
        xhr.open(opt.method.toUpperCase(), this.url, true);
        forEach(opt.headers, function (value, header) {
            xhr.setRequestHeader(header, value);
        });
        xhr.send(body);
        return this;
    }
    abort() {
        this._abort && this._abort();
        return this;
    }
    requestBody(body) {
        let type;
        // tslint:disable-next-line: no-conditional-assignment
        if (body === null || (type = typeof body) === 'undefined') {
            return null;
        }
        if (type === 'object') {
            setOrIgnoreIfExists(this.options.headers, 'Content-Type', 'application/json;charset=utf-8');
            return JSON.stringify(body);
        }
        if (body instanceof URLSearchParams) {
            setOrIgnoreIfExists(this.options.headers, 'Content-Type', 'application/x-www-form-urlencoded;charset=utf-8');
            return body.toString();
        }
        return body;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlhIUi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViWEhSLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sT0FLTixNQUFNLFdBQVcsQ0FBQztBQUNuQixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRWxDLE1BQU0sbUJBQW1CLEdBQUcsVUFDM0IsTUFBVyxFQUNYLEdBQVcsRUFDWCxLQUFVLEVBQ1YsZ0JBQXlCLEtBQUs7SUFFOUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsYUFBYSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLEVBQUU7UUFDbkUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQztLQUNwQjtBQUNGLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxPQUFPLE9BQU8sT0FBVyxTQUFRLE9BQVU7SUFJakQsWUFBWSxHQUFXLEVBQUUsT0FBdUM7UUFDL0QsS0FBSyxDQUFDLEdBQUcsRUFBRTtZQUNWLE1BQU0sRUFBRSxLQUFLO1lBQ2IsT0FBTyxFQUFFLENBQUM7WUFDVixlQUFlLEVBQUUsS0FBSztZQUN0QixZQUFZLEVBQUUsTUFBTTtZQUNwQixPQUFPLEVBQUUsRUFBRTtZQUNYLGVBQWUsRUFBRSxDQUFDLE1BQWMsRUFBRSxFQUFFLENBQUMsTUFBTSxJQUFJLEdBQUcsSUFBSSxNQUFNLEdBQUcsR0FBRztZQUNsRSxVQUFVLEVBQUUsQ0FBQyxRQUF5QixFQUFFLEVBQUU7Z0JBQ3pDLE9BQU8sSUFBSSxDQUFDO1lBQ2IsQ0FBQztZQUNELEdBQUcsT0FBTztTQUNWLENBQUMsQ0FBQztRQWRJLFVBQUssR0FBWSxLQUFLLENBQUM7SUFlL0IsQ0FBQztJQUVPLGNBQWM7UUFDckIsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ2YsTUFBTSxLQUFLLENBQUMsb0NBQW9DLENBQUMsQ0FB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SUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQ3BCLGNBQWMsRUFDZCxnQ0FBZ0MsQ0FDaEMsQ0FBQztZQUVGLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM1QjtRQUVELElBQUksSUFBSSxZQUFZLGVBQWUsRUFBRTtZQUNwQyxtQkFBbUIsQ0FDbEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQ3BCLGNBQWMsRUFDZCxpREFBaUQsQ0FDakQsQ0FBQztZQUVGLE9BQU8sSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1NBQ3ZCO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDYixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT1dlYk5ldCwge1xuXHRJTmV0RXJyb3IsXG5cdElOZXRSZXF1ZXN0T3B0aW9ucyxcblx0SU5ldFJlc3BvbnNlLFxuXHR0TmV0UmVxdWVzdEJvZHksXG59IGZyb20gJy4vT1dlYk5ldCc7XG5pbXBvcnQgeyBmb3JFYWNoIH0gZnJvbSAnLi91dGlscyc7XG5cbmNvbnN0IHNldE9ySWdub3JlSWZFeGlzdHMgPSBmdW5jdGlvbiAoXG5cdHRhcmdldDogYW55LFxuXHRrZXk6IHN0cmluZyxcblx0dmFsdWU6IGFueSxcblx0Y2FzZVNlbnNpdGl2ZTogYm9vbGVhbiA9IGZhbHNlLFxuKSB7XG5cdGlmICghdGFyZ2V0W2tleV0gJiYgKCFjYXNlU2Vuc2l0aXZlIHx8ICF0YXJnZXRba2V5LnRvVXBwZXJDYXNlKCldKSkge1xuXHRcdHRhcmdldFtrZXldID0gdmFsdWU7XG5cdH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJYSFI8VD4gZXh0ZW5kcyBPV2ViTmV0PFQ+IHtcblx0cHJpdmF0ZSBfYWJvcnQ/OiAoKSA9PiB2b2lkO1xuXHRwcml2YXRlIF9zZW50OiBib29sZWFuID0gZmFsc2U7XG5cblx0Y29uc3RydWN0b3IodXJsOiBzdHJpbmcsIG9wdGlvbnM6IFBhcnRpYWw8SU5ldFJlcXVlc3RPcHRpb25zPFQ+Pikge1xuXHRcdHN1cGVyKHVybCwge1xuXHRcdFx0bWV0aG9kOiAnZ2V0Jyxcblx0XHRcdHRpbWVvdXQ6IDAsXG5cdFx0XHR3aXRoQ3JlZGVudGlhbHM6IGZhbHNlLFxuXHRcdFx0cmVzcG9uc2VUeXBlOiAnanNvbicsXG5cdFx0XHRoZWFkZXJzOiB7fSxcblx0XHRcdGlzU3VjY2Vzc1N0YXR1czogKHN0YXR1czogbnVtYmVyKSA9PiBzdGF0dXMgPj0gMjAwICYmIHN0YXR1cyA8IDMwMCxcblx0XHRcdGlzR29vZE5ld3M6IChyZXNwb25zZTogSU5ldFJlc3BvbnNlPFQ+KSA9PiB7XG5cdFx0XHRcdHJldHVybiB0cnVlO1xuXHRcdFx0fSxcblx0XHRcdC4uLm9wdGlvbnMsXG5cdFx0fSk7XG5cdH1cblxuXHRwcml2YXRlIF9hc3NlcnROb3RTZW50KCkge1xuXHRcdGlmICh0aGlzLl9zZW50KSB7XG5cdFx0XHR0aHJvdyBFcnJvcignW09XZWJYSFJdIHJlcXVlc3QgaXMgYWxyZWFkeSBzZW50LicpO1xuXHRcdH1cblx0fVxuXG5cdHByb21pc2UoKTogUHJvbWlzZTxJTmV0UmVzcG9uc2U8VD4+IHtcblx0XHR0aGlzLl9hc3NlcnROb3RTZW50KCk7XG5cblx0XHRjb25zdCB4ID0gdGhpcztcblxuXHRcdHJldHVybiBuZXcgUHJvbWlzZTxJTmV0UmVzcG9uc2U8VD4+KGZ1bmN0aW9uIChcblx0XHRcdHJlc29sdmU6IChyZXNwb25zZTogSU5ldFJlc3BvbnNlPFQ+KSA9PiB2b2lkLFxuXHRcdFx0cmVqZWN0OiAoZXJyb3I6IElOZXRFcnJvcikgPT4gdm9pZCxcblx0XHQpIHtcblx0XHRcdHgub25SZXNwb25zZSgocmVzcG9uc2UpID0+IHJlc29sdmUocmVzcG9uc2UpKVxuXHRcdFx0XHQub25FcnJvcigoZXJyKSA9PiByZWplY3QoZXJyKSlcblx0XHRcdFx0LnNlbmQoKTtcblx0XHR9KTtcblx0fVxuXG5cdHNlbmQoKSB7XG5cdFx0dGhpcy5fYXNzZXJ0Tm90U2VudCgpO1xuXG5cdFx0dGhpcy5fc2VudCA9IHRydWU7XG5cblx0XHRsZXQgeCA9IHRoaXMsXG5cdFx0XHR4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcblx0XHRjb25zdCBvcHQgPSB4Lm9wdGlvbnMsXG5cdFx0XHRhbHdheXMgPSAoKSA9PiB7XG5cdFx0XHRcdHgudHJpZ2dlcihPV2ViTmV0LkVWVF9GSU5JU0hFRCk7XG5cdFx0XHRcdHhociA9IHggPSBudWxsIGFzIGFueTtcblx0XHRcdH0sXG5cdFx0XHRvbmVycm9yID0gKGVycjogSU5ldEVycm9yKSA9PiB7XG5cdFx0XHRcdHgudHJpZ2dlcihPV2ViTmV0LkVWVF9FUlJPUiwgW2Vycl0pO1xuXHRcdFx0XHRhbHdheXMoKTtcblx0XHRcdH0sXG5cdFx0XHRib2R5ID0gdGhpcy5yZXF1ZXN0Qm9keShvcHQuYm9keSk7XG5cblx0XHR4aHIudGltZW91dCA9IG9wdC50aW1lb3V0O1xuXG5cdFx0c2V0T3JJZ25vcmVJZkV4aXN0cyhcblx0XHRcdG9wdC5oZWFkZXJzLFxuXHRcdFx0J0FjY2VwdCcsXG5cdFx0XHQnYXBwbGljYXRpb24vanNvbiwgdGV4dC9wbGFpbiwgKi8qJyxcblx0XHQpO1xuXG5cdFx0eGhyLndpdGhDcmVkZW50aWFscyA9IG9wdC53aXRoQ3JlZGVudGlhbHM7XG5cblx0XHR4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkge1xuXHRcdFx0aWYgKCF4aHIgfHwgeGhyLnJlYWR5U3RhdGUgIT09IDQpIHtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXG5cdFx0XHQvLyBUaGUgcmVxdWVzdCBlcnJvcmVkIG91dCBhbmQgd2UgZGlkbid0IGdldCBhIHJlc3BvbnNlLCB0aGlzIHdpbGwgYmVcblx0XHRcdC8vIGhhbmRsZWQgYnkgb25lcnJvciBpbnN0ZWFkXG5cdFx0XHQvLyBXaXRoIG9uZSBleGNlcHRpb246IHJlcXVlc3QgdGhhdCB1c2luZyBmaWxlOiBwcm90b2NvbCwgbW9zdCBicm93c2Vyc1xuXHRcdFx0Ly8gd2lsbCByZXR1cm4gc3RhdHVzIGFzIDAgZXZlbiB0aG91Z2ggaXQncyBhIHN1Y2Nlc3NmdWwgcmVxdWVzdFxuXHRcdFx0aWYgKFxuXHRcdFx0XHR4aHIuc3RhdHVzID09PSAwICYmXG5cdFx0XHRcdCEoeGhyLnJlc3BvbnNlVVJMICYmIHhoci5yZXNwb25zZVVSTC5pbmRleE9mKCdmaWxlOicpID09PSAwKVxuXHRcdFx0KSB7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgcmVzcG9uc2VSYXcgPVxuXHRcdFx0XHR4aHJbXG5cdFx0XHRcdFx0KHhoci5yZXNwb25zZVR5cGUgfHwgJ3RleHQnKSA9PT0gJ3RleHQnXG5cdFx0XHRcdFx0XHQ/ICdyZXNwb25zZVRleHQnXG5cdFx0XHRcdFx0XHQ6ICdyZXNwb25zZSdcblx0XHRcdFx0XTtcblx0XHRcdGNvbnN0IHJlc3BvbnNlOiBJTmV0UmVzcG9uc2U8VD4gPSB7XG5cdFx0XHRcdHJhdzogcmVzcG9uc2VSYXcsXG5cdFx0XHRcdGpzb246IG51bGwgYXMgYW55LFxuXHRcdFx0XHRzdGF0dXM6IHhoci5zdGF0dXMsXG5cdFx0XHRcdHN0YXR1c1RleHQ6IHhoci5zdGF0dXNUZXh0LFxuXHRcdFx0fTtcblxuXHRcdFx0aWYgKHR5cGVvZiByZXNwb25zZVJhdyA9PT0gJ3N0cmluZycpIHtcblx0XHRcdFx0dHJ5IHtcblx0XHRcdFx0XHRyZXNwb25zZS5qc29uID0gSlNPTi5wYXJzZShyZXNwb25zZVJhdyk7XG5cdFx0XHRcdFx0Ly8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1lbXB0eVxuXHRcdFx0XHR9IGNhdGNoIChlKSB7fVxuXHRcdFx0fVxuXG5cdFx0XHR4LnRyaWdnZXIoT1dlYk5ldC5FVlRfUkVTUE9OU0UsIFtyZXNwb25zZV0pO1xuXG5cdFx0XHRpZiAob3B0LmlzU3VjY2Vzc1N0YXR1cyh4aHIuc3RhdHVzKSkge1xuXHRcdFx0XHR4LnRyaWdnZXIoT1dlYk5ldC5FVlRfSFRUUF9TVUNDRVNTLCBbcmVzcG9uc2VdKTtcblxuXHRcdFx0XHRpZiAob3B0LmlzR29vZE5ld3MocmVzcG9uc2UpKSB7XG5cdFx0XHRcdFx0eC50cmlnZ2VyKE9XZWJOZXQuRVZUX0dPT0RfTkVXUywgW3Jlc3BvbnNlXSk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0eC50cmlnZ2VyKE9XZWJOZXQuRVZUX0JBRF9ORVdTLCBbcmVzcG9uc2VdKTtcblx0XHRcdFx0fVxuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0eC50cmlnZ2VyKE9XZWJOZXQuRVZUX0hUVFBfRVJST1IsIFtyZXNwb25zZV0pO1xuXHRcdFx0fVxuXG5cdFx0XHRhbHdheXMoKTtcblx0XHR9O1xuXG5cdFx0eGhyLmFkZEV2ZW50TGlzdGVuZXIoJ3Byb2dyZXNzJywgZnVuY3Rpb24gKGV2ZW50KSB7XG5cdFx0XHQvLyByZXBvcnQgZG93bmxvYWQgcHJvZ3Jlc3Ncblx0XHRcdHgudHJpZ2dlcihPV2ViTmV0LkVWVF9ET1dOTE9BRF9QUk9HUkVTUywgW2V2ZW50XSk7XG5cdFx0fSk7XG5cblx0XHR4aHIudXBsb2FkLmFkZEV2ZW50TGlzdGVuZXIoJ3Byb2dyZXNzJywgZnVuY3Rpb24gKGV2ZW50KSB7XG5cdFx0XHQvLyByZXBvcnQgdXBsb2FkIHByb2dyZXNzXG5cdFx0XHR4LnRyaWdnZXIoT1dlYk5ldC5FVlRfVVBMT0FEX1BST0dSRVNTLCBbZXZlbnRdKTtcblx0XHR9KTtcblxuXHRcdHhoci5vbmFib3J0ID0gZnVuY3Rpb24gKGV2ZW50KSB7XG5cdFx0XHRvbmVycm9yKHsgdHlwZTogJ2Fib3J0JywgZXZlbnQgfSk7XG5cdFx0fTtcblxuXHRcdHhoci5vbnRpbWVvdXQgPSBmdW5jdGlvbiAoZXZlbnQpIHtcblx0XHRcdG9uZXJyb3IoeyB0eXBlOiAndGltZW91dCcsIGV2ZW50IH0pO1xuXHRcdH07XG5cblx0XHR4aHIub25lcnJvciA9IGZ1bmN0aW9uIChldmVudCkge1xuXHRcdFx0Ly8gaGFuZGxlIG5vbi1IVFRQIGVycm9yIChlLmcuIG5ldHdvcmsgZG93bilcblx0XHRcdG9uZXJyb3IoeyB0eXBlOiAnbmV0d29yaycsIGV2ZW50IH0pO1xuXHRcdH07XG5cblx0XHR0aGlzLl9hYm9ydCA9ICgpID0+IHtcblx0XHRcdHhociAmJiB4aHIuYWJvcnQoKTtcblx0XHR9O1xuXG5cdFx0eGhyLm9wZW4ob3B0Lm1ldGhvZC50b1VwcGVyQ2FzZSgpLCB0aGlzLnVybCwgdHJ1ZSk7XG5cblx0XHRmb3JFYWNoKG9wdC5oZWFkZXJzLCBmdW5jdGlvbiAodmFsdWUsIGhlYWRlcikge1xuXHRcdFx0eGhyLnNldFJlcXVlc3RIZWFkZXIoaGVhZGVyLCB2YWx1ZSk7XG5cdFx0fSk7XG5cblx0XHR4aHIuc2VuZChib2R5KTtcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0YWJvcnQoKSB7XG5cdFx0dGhpcy5fYWJvcnQgJiYgdGhpcy5fYWJvcnQoKTtcblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHByaXZhdGUgcmVxdWVzdEJvZHkoYm9keTogdE5ldFJlcXVlc3RCb2R5KTogYW55IHtcblx0XHRsZXQgdHlwZTtcblx0XHQvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLWNvbmRpdGlvbmFsLWFzc2lnbm1lbnRcblx0XHRpZiAoYm9keSA9PT0gbnVsbCB8fCAodHlwZSA9IHR5cGVvZiBib2R5KSA9PT0gJ3VuZGVmaW5lZCcpIHtcblx0XHRcdHJldHVybiBudWxsO1xuXHRcdH1cblxuXHRcdGlmICh0eXBlID09PSAnb2JqZWN0Jykge1xuXHRcdFx0c2V0T3JJZ25vcmVJZkV4aXN0cyhcblx0XHRcdFx0dGhpcy5vcHRpb25zLmhlYWRlcnMsXG5cdFx0XHRcdCdDb250ZW50LVR5cGUnLFxuXHRcdFx0XHQnYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PXV0Zi04Jyxcblx0XHRcdCk7XG5cblx0XHRcdHJldHVybiBKU09OLnN0cmluZ2lmeShib2R5KTtcblx0XHR9XG5cblx0XHRpZiAoYm9keSBpbnN0YW5jZW9mIFVSTFNlYXJjaFBhcmFtcykge1xuXHRcdFx0c2V0T3JJZ25vcmVJZkV4aXN0cyhcblx0XHRcdFx0dGhpcy5vcHRpb25zLmhlYWRlcnMsXG5cdFx0XHRcdCdDb250ZW50LVR5cGUnLFxuXHRcdFx0XHQnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkO2NoYXJzZXQ9dXRmLTgnLFxuXHRcdFx0KTtcblxuXHRcdFx0cmV0dXJuIGJvZHkudG9TdHJpbmcoKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gYm9keTtcblx0fVxufVxuIl19