import OWebNet from './OWebNet';
import { forEach } from './utils/Utils';
const setOrIgnoreIfExists = function (target, key, value, caseSensitive = false) {
    if (!target[key] && (!caseSensitive || !target[key.toUpperCase()])) {
        target[key] = value;
    }
};
export default class OWebXHR extends OWebNet {
    constructor(url, options) {
        super(url, {
            method: 'get',
            timeout: 0,
            withCredentials: false,
            responseType: 'json',
            headers: {},
            isSuccessStatus: (status) => status >= 200 && status < 300,
            isGoodNews: (response) => {
                return true;
            },
            ...options,
        });
        this._sent = false;
    }
    _assertNotSent() {
        if (this._sent) {
            throw Error('[OWebXHR] request is already sent.');
        }
    }
    promise() {
        this._assertNotSent();
        const x = this;
        return new Promise(function (resolve, reject) {
            x.onResponse((response) => resolve(response))
                .onError((err) => reject(err))
                .send();
        });
    }
    send() {
        this._assertNotSent();
        this._sent = true;
        let x = this, xhr = new XMLHttpRequest();
        const opt = x.options, always = () => {
            x.trigger(OWebNet.EVT_FINISHED);
            xhr = x = null;
        }, onerror = (err) => {
            x.trigger(OWebNet.EVT_ERROR, [err]);
            always();
        }, body = this.requestBody(opt.body);
        xhr.timeout = opt.timeout;
        setOrIgnoreIfExists(opt.headers, 'Accept', 'application/json, text/plain, */*');
        forEach(opt.headers, function (value, header) {
            xhr.setRequestHeader(header, value);
        });
        xhr.withCredentials = opt.withCredentials;
        xhr.open(opt.method.toUpperCase(), this.url, true);
        xhr.onreadystatechange = function () {
            if (!xhr || xhr.readyState !== 4) {
                return;
            }
            // The request errored out and we didn't get a response, this will be
            // handled by onerror instead
            // With one exception: request that using file: protocol, most browsers
            // will return status as 0 even though it's a successful request
            if (xhr.status === 0 &&
                !(xhr.responseURL && xhr.responseURL.indexOf('file:') === 0)) {
                return;
            }
            const responseRaw = xhr[(xhr.responseType || 'text') === 'text'
                ? 'responseText'
                : 'response'];
            const response = {
                raw: responseRaw,
                json: null,
                status: xhr.status,
                statusText: xhr.statusText,
            };
            if (typeof responseRaw === 'string') {
                try {
                    response.json = JSON.parse(responseRaw);
                    // tslint:disable-next-line: no-empty
                }
                catch (e) { }
            }
            x.trigger(OWebNet.EVT_RESPONSE, [response]);
            if (opt.isSuccessStatus(xhr.status)) {
                x.trigger(OWebNet.EVT_HTTP_SUCCESS, [response]);
                if (opt.isGoodNews(response)) {
                    x.trigger(OWebNet.EVT_GOOD_NEWS, [response]);
                }
                else {
                    x.trigger(OWebNet.EVT_BAD_NEWS, [response]);
                }
            }
            else {
                x.trigger(OWebNet.EVT_HTTP_ERROR, [response]);
            }
            always();
        };
        xhr.addEventListener('progress', function (event) {
            // report download progress
            x.trigger(OWebNet.EVT_DOWNLOAD_PROGRESS, [event]);
        });
        xhr.upload.addEventListener('progress', function (event) {
            // report upload progress
            x.trigger(OWebNet.EVT_UPLOAD_PROGRESS, [event]);
        });
        xhr.onabort = function (event) {
            onerror({ type: 'abort', event });
        };
        xhr.ontimeout = function (event) {
            onerror({ type: 'timeout', event });
        };
        xhr.onerror = function (event) {
            // handle non-HTTP error (e.g. network down)
            onerror({ type: 'network', event });
        };
        this._abort = () => {
            xhr && xhr.abort();
        };
        xhr.send(body);
        return this;
    }
    abort() {
        this._abort && this._abort();
        return this;
    }
    requestBody(body) {
        let type;
        // tslint:disable-next-line: no-conditional-assignment
        if (body === null || (type = typeof body) === 'undefined') {
            return null;
        }
        if (type === 'object') {
            setOrIgnoreIfExists(this.options.headers, 'Content-Type', 'application/json;charset=utf-8');
            return JSON.stringify(body);
        }
        if (body instanceof URLSearchParams) {
            setOrIgnoreIfExists(this.options.headers, 'Content-Type', 'application/x-www-form-urlencoded;charset=utf-8');
            return body.toString();
        }
        return body;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlhIUi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViWEhSLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sT0FLTixNQUFNLFdBQVcsQ0FBQztBQUNuQixPQUFPLEVBQUUsT0FBTyxFQUFVLE1BQU0sZUFBZSxDQUFDO0FBRWhELE1BQU0sbUJBQW1CLEdBQUcsVUFDM0IsTUFBVyxFQUNYLEdBQVcsRUFDWCxLQUFVLEVBQ1YsZ0JBQXlCLEtBQUs7SUFFOUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsYUFBYSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLEVBQUU7UUFDbkUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQztLQUNwQjtBQUNGLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxPQUFPLE9BQU8sT0FBVyxTQUFRLE9BQVU7SUFJakQsWUFBWSxHQUFXLEVBQUUsT0FBdUM7UUFDL0QsS0FBSyxDQUFDLEdBQUcsRUFBRTtZQUNWLE1BQU0sRUFBRSxLQUFLO1lBQ2IsT0FBTyxFQUFFLENBQUM7WUFDVixlQUFlLEVBQUUsS0FBSztZQUN0QixZQUFZLEVBQUUsTUFBTTtZQUNwQixPQUFPLEVBQUUsRUFBRTtZQUNYLGVBQWUsRUFBRSxDQUFDLE1BQWMsRUFBRSxFQUFFLENBQUMsTUFBTSxJQUFJLEdBQUcsSUFBSSxNQUFNLEdBQUcsR0FBRztZQUNsRSxVQUFVLEVBQUUsQ0FBQyxRQUF5QixFQUFFLEVBQUU7Z0JBQ3pDLE9BQU8sSUFBSSxDQUFDO1lBQ2IsQ0FBQztZQUNELEdBQUcsT0FBTztTQUNWLENBQUMsQ0FBQztRQWRJLFVBQUssR0FBWSxLQUFLLENBQUM7SUFlL0IsQ0FBQztJQUVPLGNBQWM7UUFDckIsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ2YsTUFBTSxLQUFLLENBQUMsb0NBQW9DLENBQUMsQ0FB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SUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQ3BCLGNBQWMsRUFDZCxnQ0FBZ0MsQ0FDaEMsQ0FBQztZQUVGLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM1QjtRQUVELElBQUksSUFBSSxZQUFZLGVBQWUsRUFBRTtZQUNwQyxtQkFBbUIsQ0FDbEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQ3BCLGNBQWMsRUFDZCxpREFBaUQsQ0FDakQsQ0FBQztZQUVGLE9BQU8sSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1NBQ3ZCO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDYixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT1dlYk5ldCwge1xuXHRJTmV0RXJyb3IsXG5cdElOZXRSZXNwb25zZSxcblx0SU5ldFJlcXVlc3RPcHRpb25zLFxuXHR0TmV0UmVxdWVzdEJvZHksXG59IGZyb20gJy4vT1dlYk5ldCc7XG5pbXBvcnQgeyBmb3JFYWNoLCBfZGVidWcgfSBmcm9tICcuL3V0aWxzL1V0aWxzJztcblxuY29uc3Qgc2V0T3JJZ25vcmVJZkV4aXN0cyA9IGZ1bmN0aW9uIChcblx0dGFyZ2V0OiBhbnksXG5cdGtleTogc3RyaW5nLFxuXHR2YWx1ZTogYW55LFxuXHRjYXNlU2Vuc2l0aXZlOiBib29sZWFuID0gZmFsc2UsXG4pIHtcblx0aWYgKCF0YXJnZXRba2V5XSAmJiAoIWNhc2VTZW5zaXRpdmUgfHwgIXRhcmdldFtrZXkudG9VcHBlckNhc2UoKV0pKSB7XG5cdFx0dGFyZ2V0W2tleV0gPSB2YWx1ZTtcblx0fVxufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT1dlYlhIUjxUPiBleHRlbmRzIE9XZWJOZXQ8VD4ge1xuXHRwcml2YXRlIF9hYm9ydD86ICgpID0+IHZvaWQ7XG5cdHByaXZhdGUgX3NlbnQ6IGJvb2xlYW4gPSBmYWxzZTtcblxuXHRjb25zdHJ1Y3Rvcih1cmw6IHN0cmluZywgb3B0aW9uczogUGFydGlhbDxJTmV0UmVxdWVzdE9wdGlvbnM8VD4+KSB7XG5cdFx0c3VwZXIodXJsLCB7XG5cdFx0XHRtZXRob2Q6ICdnZXQnLFxuXHRcdFx0dGltZW91dDogMCxcblx0XHRcdHdpdGhDcmVkZW50aWFsczogZmFsc2UsXG5cdFx0XHRyZXNwb25zZVR5cGU6ICdqc29uJyxcblx0XHRcdGhlYWRlcnM6IHt9LFxuXHRcdFx0aXNTdWNjZXNzU3RhdHVzOiAoc3RhdHVzOiBudW1iZXIpID0+IHN0YXR1cyA+PSAyMDAgJiYgc3RhdHVzIDwgMzAwLFxuXHRcdFx0aXNHb29kTmV3czogKHJlc3BvbnNlOiBJTmV0UmVzcG9uc2U8VD4pID0+IHtcblx0XHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0XHR9LFxuXHRcdFx0Li4ub3B0aW9ucyxcblx0XHR9KTtcblx0fVxuXG5cdHByaXZhdGUgX2Fzc2VydE5vdFNlbnQoKSB7XG5cdFx0aWYgKHRoaXMuX3NlbnQpIHtcblx0XHRcdHRocm93IEVycm9yKCdbT1dlYlhIUl0gcmVxdWVzdCBpcyBhbHJlYWR5IHNlbnQuJyk7XG5cdFx0fVxuXHR9XG5cblx0cHJvbWlzZSgpOiBQcm9taXNlPElOZXRSZXNwb25zZTxUPj4ge1xuXHRcdHRoaXMuX2Fzc2VydE5vdFNlbnQoKTtcblxuXHRcdGNvbnN0IHggPSB0aGlzO1xuXG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlPElOZXRSZXNwb25zZTxUPj4oZnVuY3Rpb24gKFxuXHRcdFx0cmVzb2x2ZTogKHJlc3BvbnNlOiBJTmV0UmVzcG9uc2U8VD4pID0+IHZvaWQsXG5cdFx0XHRyZWplY3Q6IChlcnJvcjogSU5ldEVycm9yKSA9PiB2b2lkLFxuXHRcdCkge1xuXHRcdFx0eC5vblJlc3BvbnNlKChyZXNwb25zZSkgPT4gcmVzb2x2ZShyZXNwb25zZSkpXG5cdFx0XHRcdC5vbkVycm9yKChlcnIpID0+IHJlamVjdChlcnIpKVxuXHRcdFx0XHQuc2VuZCgpO1xuXHRcdH0pO1xuXHR9XG5cblx0c2VuZCgpIHtcblx0XHR0aGlzLl9hc3NlcnROb3RTZW50KCk7XG5cblx0XHR0aGlzLl9zZW50ID0gdHJ1ZTtcblxuXHRcdGxldCB4ID0gdGhpcyxcblx0XHRcdHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuXHRcdGNvbnN0IG9wdCA9IHgub3B0aW9ucyxcblx0XHRcdGFsd2F5cyA9ICgpID0+IHtcblx0XHRcdFx0eC50cmlnZ2VyKE9XZWJOZXQuRVZUX0ZJTklTSEVEKTtcblx0XHRcdFx0eGhyID0geCA9IG51bGwgYXMgYW55O1xuXHRcdFx0fSxcblx0XHRcdG9uZXJyb3IgPSAoZXJyOiBJTmV0RXJyb3IpID0+IHtcblx0XHRcdFx0eC50cmlnZ2VyKE9XZWJOZXQuRVZUX0VSUk9SLCBbZXJyXSk7XG5cdFx0XHRcdGFsd2F5cygpO1xuXHRcdFx0fSxcblx0XHRcdGJvZHkgPSB0aGlzLnJlcXVlc3RCb2R5KG9wdC5ib2R5KTtcblxuXHRcdHhoci50aW1lb3V0ID0gb3B0LnRpbWVvdXQ7XG5cblx0XHRzZXRPcklnbm9yZUlmRXhpc3RzKFxuXHRcdFx0b3B0LmhlYWRlcnMsXG5cdFx0XHQnQWNjZXB0Jyxcblx0XHRcdCdhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L3BsYWluLCAqLyonLFxuXHRcdCk7XG5cblx0XHRmb3JFYWNoKG9wdC5oZWFkZXJzLCBmdW5jdGlvbiAodmFsdWUsIGhlYWRlcikge1xuXHRcdFx0eGhyLnNldFJlcXVlc3RIZWFkZXIoaGVhZGVyLCB2YWx1ZSk7XG5cdFx0fSk7XG5cblx0XHR4aHIud2l0aENyZWRlbnRpYWxzID0gb3B0LndpdGhDcmVkZW50aWFscztcblxuXHRcdHhoci5vcGVuKG9wdC5tZXRob2QudG9VcHBlckNhc2UoKSwgdGhpcy51cmwsIHRydWUpO1xuXG5cdFx0eGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHtcblx0XHRcdGlmICgheGhyIHx8IHhoci5yZWFkeVN0YXRlICE9PSA0KSB7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblxuXHRcdFx0Ly8gVGhlIHJlcXVlc3QgZXJyb3JlZCBvdXQgYW5kIHdlIGRpZG4ndCBnZXQgYSByZXNwb25zZSwgdGhpcyB3aWxsIGJlXG5cdFx0XHQvLyBoYW5kbGVkIGJ5IG9uZXJyb3IgaW5zdGVhZFxuXHRcdFx0Ly8gV2l0aCBvbmUgZXhjZXB0aW9uOiByZXF1ZXN0IHRoYXQgdXNpbmcgZmlsZTogcHJvdG9jb2wsIG1vc3QgYnJvd3NlcnNcblx0XHRcdC8vIHdpbGwgcmV0dXJuIHN0YXR1cyBhcyAwIGV2ZW4gdGhvdWdoIGl0J3MgYSBzdWNjZXNzZnVsIHJlcXVlc3Rcblx0XHRcdGlmIChcblx0XHRcdFx0eGhyLnN0YXR1cyA9PT0gMCAmJlxuXHRcdFx0XHQhKHhoci5yZXNwb25zZVVSTCAmJiB4aHIucmVzcG9uc2VVUkwuaW5kZXhPZignZmlsZTonKSA9PT0gMClcblx0XHRcdCkge1xuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IHJlc3BvbnNlUmF3ID1cblx0XHRcdFx0eGhyW1xuXHRcdFx0XHRcdCh4aHIucmVzcG9uc2VUeXBlIHx8ICd0ZXh0JykgPT09ICd0ZXh0J1xuXHRcdFx0XHRcdFx0PyAncmVzcG9uc2VUZXh0J1xuXHRcdFx0XHRcdFx0OiAncmVzcG9uc2UnXG5cdFx0XHRcdF07XG5cdFx0XHRjb25zdCByZXNwb25zZTogSU5ldFJlc3BvbnNlPFQ+ID0ge1xuXHRcdFx0XHRyYXc6IHJlc3BvbnNlUmF3LFxuXHRcdFx0XHRqc29uOiBudWxsIGFzIGFueSxcblx0XHRcdFx0c3RhdHVzOiB4aHIuc3RhdHVzLFxuXHRcdFx0XHRzdGF0dXNUZXh0OiB4aHIuc3RhdHVzVGV4dCxcblx0XHRcdH07XG5cblx0XHRcdGlmICh0eXBlb2YgcmVzcG9uc2VSYXcgPT09ICdzdHJpbmcnKSB7XG5cdFx0XHRcdHRyeSB7XG5cdFx0XHRcdFx0cmVzcG9uc2UuanNvbiA9IEpTT04ucGFyc2UocmVzcG9uc2VSYXcpO1xuXHRcdFx0XHRcdC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tZW1wdHlcblx0XHRcdFx0fSBjYXRjaCAoZSkge31cblx0XHRcdH1cblxuXHRcdFx0eC50cmlnZ2VyKE9XZWJOZXQuRVZUX1JFU1BPTlNFLCBbcmVzcG9uc2VdKTtcblxuXHRcdFx0aWYgKG9wdC5pc1N1Y2Nlc3NTdGF0dXMoeGhyLnN0YXR1cykpIHtcblx0XHRcdFx0eC50cmlnZ2VyKE9XZWJOZXQuRVZUX0hUVFBfU1VDQ0VTUywgW3Jlc3BvbnNlXSk7XG5cblx0XHRcdFx0aWYgKG9wdC5pc0dvb2ROZXdzKHJlc3BvbnNlKSkge1xuXHRcdFx0XHRcdHgudHJpZ2dlcihPV2ViTmV0LkVWVF9HT09EX05FV1MsIFtyZXNwb25zZV0pO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHgudHJpZ2dlcihPV2ViTmV0LkVWVF9CQURfTkVXUywgW3Jlc3BvbnNlXSk7XG5cdFx0XHRcdH1cblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHgudHJpZ2dlcihPV2ViTmV0LkVWVF9IVFRQX0VSUk9SLCBbcmVzcG9uc2VdKTtcblx0XHRcdH1cblxuXHRcdFx0YWx3YXlzKCk7XG5cdFx0fTtcblxuXHRcdHhoci5hZGRFdmVudExpc3RlbmVyKCdwcm9ncmVzcycsIGZ1bmN0aW9uIChldmVudCkge1xuXHRcdFx0Ly8gcmVwb3J0IGRvd25sb2FkIHByb2dyZXNzXG5cdFx0XHR4LnRyaWdnZXIoT1dlYk5ldC5FVlRfRE9XTkxPQURfUFJPR1JFU1MsIFtldmVudF0pO1xuXHRcdH0pO1xuXG5cdFx0eGhyLnVwbG9hZC5hZGRFdmVudExpc3RlbmVyKCdwcm9ncmVzcycsIGZ1bmN0aW9uIChldmVudCkge1xuXHRcdFx0Ly8gcmVwb3J0IHVwbG9hZCBwcm9ncmVzc1xuXHRcdFx0eC50cmlnZ2VyKE9XZWJOZXQuRVZUX1VQTE9BRF9QUk9HUkVTUywgW2V2ZW50XSk7XG5cdFx0fSk7XG5cblx0XHR4aHIub25hYm9ydCA9IGZ1bmN0aW9uIChldmVudCkge1xuXHRcdFx0b25lcnJvcih7IHR5cGU6ICdhYm9ydCcsIGV2ZW50IH0pO1xuXHRcdH07XG5cblx0XHR4aHIub250aW1lb3V0ID0gZnVuY3Rpb24gKGV2ZW50KSB7XG5cdFx0XHRvbmVycm9yKHsgdHlwZTogJ3RpbWVvdXQnLCBldmVudCB9KTtcblx0XHR9O1xuXG5cdFx0eGhyLm9uZXJyb3IgPSBmdW5jdGlvbiAoZXZlbnQpIHtcblx0XHRcdC8vIGhhbmRsZSBub24tSFRUUCBlcnJvciAoZS5nLiBuZXR3b3JrIGRvd24pXG5cdFx0XHRvbmVycm9yKHsgdHlwZTogJ25ldHdvcmsnLCBldmVudCB9KTtcblx0XHR9O1xuXG5cdFx0dGhpcy5fYWJvcnQgPSAoKSA9PiB7XG5cdFx0XHR4aHIgJiYgeGhyLmFib3J0KCk7XG5cdFx0fTtcblxuXHRcdHhoci5zZW5kKGJvZHkpO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRhYm9ydCgpIHtcblx0XHR0aGlzLl9hYm9ydCAmJiB0aGlzLl9hYm9ydCgpO1xuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0cHJpdmF0ZSByZXF1ZXN0Qm9keShib2R5OiB0TmV0UmVxdWVzdEJvZHkpOiBhbnkge1xuXHRcdGxldCB0eXBlO1xuXHRcdC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tY29uZGl0aW9uYWwtYXNzaWdubWVudFxuXHRcdGlmIChib2R5ID09PSBudWxsIHx8ICh0eXBlID0gdHlwZW9mIGJvZHkpID09PSAndW5kZWZpbmVkJykge1xuXHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0fVxuXG5cdFx0aWYgKHR5cGUgPT09ICdvYmplY3QnKSB7XG5cdFx0XHRzZXRPcklnbm9yZUlmRXhpc3RzKFxuXHRcdFx0XHR0aGlzLm9wdGlvbnMuaGVhZGVycyxcblx0XHRcdFx0J0NvbnRlbnQtVHlwZScsXG5cdFx0XHRcdCdhcHBsaWNhdGlvbi9qc29uO2NoYXJzZXQ9dXRmLTgnLFxuXHRcdFx0KTtcblxuXHRcdFx0cmV0dXJuIEpTT04uc3RyaW5naWZ5KGJvZHkpO1xuXHRcdH1cblxuXHRcdGlmIChib2R5IGluc3RhbmNlb2YgVVJMU2VhcmNoUGFyYW1zKSB7XG5cdFx0XHRzZXRPcklnbm9yZUlmRXhpc3RzKFxuXHRcdFx0XHR0aGlzLm9wdGlvbnMuaGVhZGVycyxcblx0XHRcdFx0J0NvbnRlbnQtVHlwZScsXG5cdFx0XHRcdCdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7Y2hhcnNldD11dGYtOCcsXG5cdFx0XHQpO1xuXG5cdFx0XHRyZXR1cm4gYm9keS50b1N0cmluZygpO1xuXHRcdH1cblxuXHRcdHJldHVybiBib2R5O1xuXHR9XG59XG4iXX0=