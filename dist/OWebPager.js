import OWebEvent from './OWebEvent';
import { id, _debug, _info } from './utils/Utils';
const wDoc = window.document;
let routeId = 0;
const _isParentOf = (parent, route) => {
    let p;
    // tslint:disable-next-line: no-conditional-assignment
    while ((p = route.parent)) {
        if (p === parent) {
            return true;
        }
        route = p;
    }
    return false;
};
let OWebPager = /** @class */ (() => {
    class OWebPager extends OWebEvent {
        /**
         * @param appContext The app context.
         */
        constructor(appContext) {
            super();
            this.appContext = appContext;
            this._pages = {};
            this._routesCache = [];
            this._routesFlattened = [];
            _info('[OWebPager] ready!');
        }
        /**
         * Returns registered pages routes.
         */
        getRoutes() {
            return [...this._routesCache];
        }
        /**
         * Returns the page with the given name.
         * @param name
         */
        getPage(name) {
            const page = this._pages[name];
            if (undefined === page) {
                throw new Error(`[OWebPager] the page "${name}" is not defined.`);
            }
            return page;
        }
        /**
         * Returns the active page.
         */
        getActivePage() {
            if (!this._activePage) {
                throw new Error('[OWebPager] no active page.');
            }
            return this._activePage;
        }
        /**
         * Returns the active page route.
         */
        getActivePageRoute() {
            if (!this._activeRoute) {
                throw new Error('[OWebPager] no active route.');
            }
            return this._activeRoute;
        }
        /**
         * Returns all pages list.
         */
        getPageList() {
            return { ...this._pages };
        }
        /**
         * Register a given page.
         *
         * @param page
         */
        registerPage(page) {
            const name = page.getName();
            if (name in this._pages) {
                throw new Error(`[OWebPager] page "${name}" already registered.`);
            }
            this._pages[name] = page.install(this);
            const routes = page.getRoutes();
            this._routesCache.push(...routes);
            return this._registerPageRoutes(page, routes);
        }
        /**
         * Helpers to register page routes.
         *
         * @param page The page.
         * @param routes The page routes list.
         * @param parent The page routes parent.
         * @private
         */
        _registerPageRoutes(page, routes, parent) {
            const router = this.appContext.router;
            for (let i = 0; i < routes.length; i++) {
                const route = routes[i];
                route.id = ++routeId;
                route.parent = parent;
                route.href = router.pathToURL(typeof route.path === 'string' ? route.path : '/').href;
                route.active = false;
                route.activeChild = false;
                route.show =
                    route.show ||
                        function () {
                            return true;
                        };
                this._routesFlattened.push(route);
                this._addRoute(route, page);
                if (route.sub && route.sub.length) {
                    this._registerPageRoutes(page, route.sub, route);
                }
            }
            return this;
        }
        /**
         * Helper to add route.
         *
         * @param route The route object.
         * @param page The page to which that route belongs to.
         * @private
         */
        _addRoute(route, page) {
            const ctx = this;
            this.appContext.router.on(route.path, route.pathOptions, (routeContext) => {
                _debug('[OWebPager] page route match', route, page, routeContext);
                if (page.requireLogin(routeContext, route) &&
                    !ctx.appContext.userVerified()) {
                    return (routeContext.stop() &&
                        ctx.appContext.showLoginPage({
                            next: routeContext.getPath(),
                        }));
                }
                const ar = ctx._activeRoute, ap = ctx._activePage;
                ap && ar && ap.onClose(ar, route);
                page.onOpen(routeContext, route);
                !routeContext.stopped() && ctx._setActive(page, route);
            });
            return this;
        }
        /**
         * Helper to set the active route.
         *
         * @param page
         * @param route
         * @private
         */
        _setActive(page, route) {
            const oldPage = this._activePage, oldRoute = this._activeRoute, app = this.appContext;
            for (let i = 0; i < this._routesFlattened.length; i++) {
                const c = this._routesFlattened[i];
                c.active = route.id === c.id;
                c.activeChild = !c.active && _isParentOf(c, route);
            }
            this._activePage = page;
            this._activeRoute = route;
            wDoc.title = app.i18n.toHuman(route.title ? route.title : app.getAppName());
            const info = {
                page,
                oldPage,
                route,
                oldRoute,
                samePage: oldPage === page,
            };
            _debug('[OWebPager] location info', info);
            this.trigger(OWebPager.EVT_PAGE_LOCATION_CHANGE, [route, page]);
            return this;
        }
        onLocationChange(handler) {
            return this.on(OWebPager.EVT_PAGE_LOCATION_CHANGE, handler);
        }
    }
    OWebPager.SELF = id();
    OWebPager.EVT_PAGE_LOCATION_CHANGE = id();
    return OWebPager;
})();
export default OWebPager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlBhZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL09XZWJQYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLFNBQVMsTUFBTSxhQUFhLENBQUM7QUFFcEMsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBcUZsRCxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDO0FBQzdCLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQztBQUNoQixNQUFNLFdBQVcsR0FBRyxDQUNuQixNQUFzQixFQUN0QixLQUFxQixFQUNYLEVBQUU7SUFDWixJQUFJLENBQUMsQ0FBQztJQUNOLHNEQUFzRDtJQUN0RCxPQUFPLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFPLENBQUMsRUFBRTtRQUMzQixJQUFJLENBQUMsS0FBSyxNQUFNLEVBQUU7WUFDakIsT0FBTyxJQUFJLENBQUM7U0FDWjtRQUVELEtBQUssR0FBRyxDQUFDLENBQUM7S0FDVjtJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2QsQ0FBQyxDQUFDO0FBRUY7SUFBQSxNQUFxQixTQUFxQixTQUFRLFNBQVM7UUFVMUQ7O1dBRUc7UUFDSCxZQUE2QixVQUFtQjtZQUMvQyxLQUFLLEVBQUUsQ0FBQztZQURvQixlQUFVLEdBQVYsVUFBVSxDQUFTO1lBVC9CLFdBQU0sR0FBd0MsRUFBRSxDQUFDO1lBQzFELGlCQUFZLEdBQWlCLEVBQUUsQ0FBQztZQUNoQyxxQkFBZ0IsR0FBcUIsRUFBRSxDQUFDO1lBUy9DLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1FBQzdCLENBQUM7UUFFRDs7V0FFRztRQUNILFNBQVM7WUFDUixPQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDL0IsQ0FBQztRQUVEOzs7V0FHRztRQUNILE9BQU8sQ0FBQyxJQUFZO1lBQ25CLE1BQU0sSUFBSSxHQUFxQixJ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QUFDO1lBRWhFLE9BQU8sSUFBSSxDQUFDO1FBQ2IsQ0FBQztRQUVELGdCQUFnQixDQUNmLE9BQWdFO1lBRWhFLE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsd0JBQXdCLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDN0QsQ0FBQzs7SUExTmUsY0FBSSxHQUFHLEVBQUUsRUFBRSxDQUFDO0lBQ1osa0NBQXdCLEdBQUcsRUFBRSxFQUFFLENBQUM7SUEwTmpELGdCQUFDO0tBQUE7ZUE1Tm9CLFNBQVMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT1dlYkFwcCBmcm9tICcuL09XZWJBcHAnO1xuaW1wb3J0IE9XZWJFdmVudCBmcm9tICcuL09XZWJFdmVudCc7XG5pbXBvcnQgT1dlYlJvdXRlciBmcm9tICcuL09XZWJSb3V0ZXInO1xuaW1wb3J0IHsgaWQsIF9kZWJ1ZywgX2luZm8gfSBmcm9tICcuL3V0aWxzL1V0aWxzJztcbmltcG9ydCBPV2ViUm91dGVDb250ZXh0IGZyb20gJy4vT1dlYlJvdXRlQ29udGV4dCc7XG5pbXBvcnQgeyB0Um91dGVQYXRoLCB0Um91dGVQYXRoT3B0aW9ucyB9IGZyb20gJy4vT1dlYlJvdXRlJztcbmltcG9ydCB7IHRJMThuIH0gZnJvbSAnLi9PV2ViSTE4bic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVBhZ2VSb3V0ZSB7XG5cdHNsdWc/OiBzdHJpbmc7XG5cdHRpdGxlOiB0STE4bjtcblx0ZGVzY3JpcHRpb24/OiB0STE4bjtcblx0cGF0aDogdFJvdXRlUGF0aDtcblx0cGF0aE9wdGlvbnM/OiB0Um91dGVQYXRoT3B0aW9ucztcblx0c3ViPzogSVBhZ2VSb3V0ZVtdO1xuXHRzaG93U3ViPzogYm9vbGVhbjtcblx0ZGlzYWJsZWQ/OiBib29sZWFuO1xuXG5cdHNob3c/KCk6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVBhZ2VSb3V0ZUZ1bGwge1xuXHRzbHVnPzogc3RyaW5nO1xuXHR0aXRsZTogdEkxOG47XG5cdGRlc2NyaXB0aW9uPzogdEkxOG47XG5cdHBhdGg6IHRSb3V0ZVBhdGg7XG5cdHBhdGhPcHRpb25zPzogdFJvdXRlUGF0aE9wdGlvbnM7XG5cdHN1Yj86IElQYWdlUm91dGVGdWxsW107XG5cdHNob3dTdWI/OiBib29sZWFuO1xuXHRkaXNhYmxlZD86IGJvb2xlYW47XG5cblx0c2hvdygpOiBib29sZWFuO1xuXG5cdHJlYWRvbmx5IGlkOiBudW1iZXI7XG5cdHJlYWRvbmx5IGhyZWY6IHN0cmluZztcblx0cmVhZG9ubHkgcGFyZW50PzogSVBhZ2VSb3V0ZUZ1bGw7XG5cdGFjdGl2ZTogYm9vbGVhbjtcblx0YWN0aXZlQ2hpbGQ6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVBhZ2U8Q29tcG9uZW50PiB7XG5cdC8qKlxuXHQgKiBUaGUgcGFnZSBuYW1lIGdldHRlci5cblx0ICovXG5cdGdldE5hbWUoKTogc3RyaW5nO1xuXG5cdC8qKlxuXHQgKiBUaGUgcGFnZSByb3V0ZXMgZ2V0dGVyLlxuXHQgKi9cblx0Z2V0Um91dGVzKCk6IElQYWdlUm91dGVbXTtcblxuXHQvKipcblx0ICogVGhlIHBhZ2UgY29tcG9uZW50IGdldHRlci5cblx0ICovXG5cdGdldENvbXBvbmVudCgpOiBDb21wb25lbnQ7XG5cblx0LyoqXG5cdCAqIENhbGxlZCBvbmNlIHdoZW4gcmVnaXN0ZXJpbmcgdGhlIHBhZ2UuXG5cdCAqXG5cdCAqIEBwYXJhbSBwYWdlclxuXHQgKi9cblx0aW5zdGFsbChwYWdlcjogT1dlYlBhZ2VyPENvbXBvbmVudD4pOiB0aGlzO1xuXG5cdC8qKlxuXHQgKiBEb2VzIHRoaXMgcGFnZSByZXF1aXJlIGEgdmVyaWZpZWQgdXNlciBmb3IgdGhlIHJlcXVlc3RlZCBwYWdlIHJvdXRlLlxuXHQgKlxuXHQgKiBAcGFyYW0gY29udGV4dCBUaGUgYXBwIGNvbnRleHQuXG5cdCAqIEBwYXJhbSByb3V0ZSBUaGUgcmVxdWVzdCBwYWdlIHJvdXRlLlxuXHQgKi9cblx0cmVxdWlyZUxvZ2luKGNvbnRleHQ6IE9XZWJSb3V0ZUNvbnRleHQsIHJvdXRlOiBJUGFnZVJvdXRlRnVsbCk6IGJvb2xlYW47XG5cblx0LyoqXG5cdCAqIENhbGxlZCBiZWZvcmUgcGFnZSBvcGVuLlxuXHQgKlxuXHQgKiBAcGFyYW0gY29udGV4dFxuXHQgKiBAcGFyYW0gcm91dGVcblx0ICovXG5cdG9uT3Blbihjb250ZXh0OiBPV2ViUm91dGVDb250ZXh0LCByb3V0ZTogSVBhZ2VSb3V0ZUZ1bGwpOiB2b2lkO1xuXG5cdC8qKlxuXHQgKiBDYWxsZWQgYmVmb3JlIHBhZ2UgY2xvc2UuXG5cdCAqXG5cdCAqIEBwYXJhbSBvbGRSb3V0ZVxuXHQgKiBAcGFyYW0gbmV3Um91dGVcblx0ICovXG5cdG9uQ2xvc2Uob2xkUm91dGU6IElQYWdlUm91dGVGdWxsLCBuZXdSb3V0ZTogSVBhZ2VSb3V0ZUZ1bGwpOiB2b2lkO1xufVxuXG5jb25zdCB3RG9jID0gd2luZG93LmRvY3VtZW50O1xubGV0IHJvdXRlSWQgPSAwO1xuY29uc3QgX2lzUGFyZW50T2YgPSAoXG5cdHBhcmVudDogSVBhZ2VSb3V0ZUZ1bGwsXG5cdHJvdXRlOiBJUGFnZVJvdXRlRnVsbCxcbik6IGJvb2xlYW4gPT4ge1xuXHRsZXQgcDtcblx0Ly8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1jb25kaXRpb25hbC1hc3NpZ25tZW50XG5cdHdoaWxlICgocCA9IHJvdXRlLnBhcmVudCEpKSB7XG5cdFx0aWYgKHAgPT09IHBhcmVudCkge1xuXHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0fVxuXG5cdFx0cm91dGUgPSBwO1xuXHR9XG5cdHJldHVybiBmYWxzZTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJQYWdlcjxDb21wb25lbnQ+IGV4dGVuZHMgT1dlYkV2ZW50IHtcblx0c3RhdGljIHJlYWRvbmx5IFNFTEYgPSBpZCgpO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX1BBR0VfTE9DQVRJT05fQ0hBTkdFID0gaWQoKTtcblxuXHRwcml2YXRlIHJlYWRvbmx5IF9wYWdlczogeyBba2V5OiBzdHJpbmddOiBJUGFnZTxDb21wb25lbnQ+IH0gPSB7fTtcblx0cHJpdmF0ZSBfcm91dGVzQ2FjaGU6IElQYWdlUm91dGVbXSA9IFtdO1xuXHRwcml2YXRlIF9yb3V0ZXNGbGF0dGVuZWQ6IElQYWdlUm91dGVGdWxsW10gPSBbXTtcblx0cHJpdmF0ZSBfYWN0aXZlUGFnZTogSVBhZ2U8Q29tcG9uZW50PiB8IHVuZGVmaW5lZDtcblx0cHJpdmF0ZSBfYWN0aXZlUm91dGU/OiBJUGFnZVJvdXRlRnVsbDtcblxuXHQvKipcblx0ICogQHBhcmFtIGFwcENvbnRleHQgVGhlIGFwcCBjb250ZXh0LlxuXHQgKi9cblx0Y29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhcHBDb250ZXh0OiBPV2ViQXBwKSB7XG5cdFx0c3VwZXIoKTtcblx0XHRfaW5mbygnW09XZWJQYWdlcl0gcmVhZHkhJyk7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyByZWdpc3RlcmVkIHBhZ2VzIHJvdXRlcy5cblx0ICovXG5cdGdldFJvdXRlcygpOiBJUGFnZVJvdXRlW10ge1xuXHRcdHJldHVybiBbLi4udGhpcy5fcm91dGVzQ2FjaGVdO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgdGhlIHBhZ2Ugd2l0aCB0aGUgZ2l2ZW4gbmFtZS5cblx0ICogQHBhcmFtIG5hbWVcblx0ICovXG5cdGdldFBhZ2UobmFtZTogc3RyaW5nKTogSVBhZ2U8Q29tcG9uZW50PiB7XG5cdFx0Y29uc3QgcGFnZTogSVBhZ2U8Q29tcG9uZW50PiA9IHRoaXMuX3BhZ2VzW25hbWVdO1xuXHRcdGlmICh1bmRlZmluZWQgPT09IHBhZ2UpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihgW09XZWJQYWdlcl0gdGhlIHBhZ2UgXCIke25hbWV9XCIgaXMgbm90IGRlZmluZWQuYCk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHBhZ2U7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgYWN0aXZlIHBhZ2UuXG5cdCAqL1xuXHRnZXRBY3RpdmVQYWdlKCk6IElQYWdlPENvbXBvbmVudD4ge1xuXHRcdGlmICghdGhpcy5fYWN0aXZlUGFnZSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdbT1dlYlBhZ2VyXSBubyBhY3RpdmUgcGFnZS4nKTtcblx0XHR9XG5cdFx0cmV0dXJuIHRoaXMuX2FjdGl2ZVBhZ2U7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgYWN0aXZlIHBhZ2Ugcm91dGUuXG5cdCAqL1xuXHRnZXRBY3RpdmVQYWdlUm91dGUoKTogSVBhZ2VSb3V0ZUZ1bGwge1xuXHRcdGlmICghdGhpcy5fYWN0aXZlUm91dGUpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcignW09XZWJQYWdlcl0gbm8gYWN0aXZlIHJvdXRlLicpO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcy5fYWN0aXZlUm91dGU7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyBhbGwgcGFnZXMgbGlzdC5cblx0ICovXG5cdGdldFBhZ2VMaXN0KCkge1xuXHRcdHJldHVybiB7IC4uLnRoaXMuX3BhZ2VzIH07XG5cdH1cblxuXHQvKipcblx0ICogUmVnaXN0ZXIgYSBnaXZlbiBwYWdlLlxuXHQgKlxuXHQgKiBAcGFyYW0gcGFnZVxuXHQgKi9cblx0cmVnaXN0ZXJQYWdlKHBhZ2U6IElQYWdlPENvbXBvbmVudD4pOiB0aGlzIHtcblx0XHRjb25zdCBuYW1lID0gcGFnZS5nZXROYW1lKCk7XG5cblx0XHRpZiAobmFtZSBpbiB0aGlzLl9wYWdlcykge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBbT1dlYlBhZ2VyXSBwYWdlIFwiJHtuYW1lfVwiIGFscmVhZHkgcmVnaXN0ZXJlZC5gKTtcblx0XHR9XG5cblx0XHR0aGlzLl9wYWdlc1tuYW1lXSA9IHBhZ2UuaW5zdGFsbCh0aGlzKTtcblx0XHRjb25zdCByb3V0ZXMgPSBwYWdlLmdldFJvdXRlcygpO1xuXG5cdFx0dGhpcy5fcm91dGVzQ2FjaGUucHVzaCguLi5yb3V0ZXMpO1xuXG5cdFx0cmV0dXJuIHRoaXMuX3JlZ2lzdGVyUGFnZVJvdXRlcyhwYWdlLCByb3V0ZXMpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEhlbHBlcnMgdG8gcmVnaXN0ZXIgcGFnZSByb3V0ZXMuXG5cdCAqXG5cdCAqIEBwYXJhbSBwYWdlIFRoZSBwYWdlLlxuXHQgKiBAcGFyYW0gcm91dGVzIFRoZSBwYWdlIHJvdXRlcyBsaXN0LlxuXHQgKiBAcGFyYW0gcGFyZW50IFRoZSBwYWdlIHJvdXRlcyBwYXJlbnQuXG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIF9yZWdpc3RlclBhZ2VSb3V0ZXMoXG5cdFx0cGFnZTogSVBhZ2U8Q29tcG9uZW50Pixcblx0XHRyb3V0ZXM6IElQYWdlUm91dGVbXSxcblx0XHRwYXJlbnQ/OiBJUGFnZVJvdXRlRnVsbCxcblx0KTogdGhpcyB7XG5cdFx0Y29uc3Qgcm91dGVyOiBPV2ViUm91dGVyID0gdGhpcy5hcHBDb250ZXh0LnJvdXRlcjtcblxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgcm91dGVzLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRjb25zdCByb3V0ZTogYW55ID0gcm91dGVzW2ldO1xuXG5cdFx0XHRyb3V0ZS5pZCA9ICsrcm91dGVJZDtcblx0XHRcdHJvdXRlLnBhcmVudCA9IHBhcmVudDtcblx0XHRcdHJvdXRlLmhyZWYgPSByb3V0ZXIucGF0aFRvVVJMKFxuXHRcdFx0XHR0eXBlb2Ygcm91dGUucGF0aCA9PT0gJ3N0cmluZycgPyByb3V0ZS5wYXRoIDogJy8nLFxuXHRcdFx0KS5ocmVmO1xuXHRcdFx0cm91dGUuYWN0aXZlID0gZmFsc2U7XG5cdFx0XHRyb3V0ZS5hY3RpdmVDaGlsZCA9IGZhbHNlO1xuXG5cdFx0XHRyb3V0ZS5zaG93ID1cblx0XHRcdFx0cm91dGUuc2hvdyB8fFxuXHRcdFx0XHRmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0XHRcdH07XG5cblx0XHRcdHRoaXMuX3JvdXRlc0ZsYXR0ZW5lZC5wdXNoKHJvdXRlKTtcblxuXHRcdFx0dGhpcy5fYWRkUm91dGUocm91dGUsIHBhZ2UpO1xuXG5cdFx0XHRpZiAocm91dGUuc3ViICYmIHJvdXRlLnN1Yi5sZW5ndGgpIHtcblx0XHRcdFx0dGhpcy5fcmVnaXN0ZXJQYWdlUm91dGVzKHBhZ2UsIHJvdXRlLnN1Yiwgcm91dGUpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0LyoqXG5cdCAqIEhlbHBlciB0byBhZGQgcm91dGUuXG5cdCAqXG5cdCAqIEBwYXJhbSByb3V0ZSBUaGUgcm91dGUgb2JqZWN0LlxuXHQgKiBAcGFyYW0gcGFnZSBUaGUgcGFnZSB0byB3aGljaCB0aGF0IHJvdXRlIGJlbG9uZ3MgdG8uXG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIF9hZGRSb3V0ZShyb3V0ZTogSVBhZ2VSb3V0ZUZ1bGwsIHBhZ2U6IElQYWdlPENvbXBvbmVudD4pOiB0aGlzIHtcblx0XHRjb25zdCBjdHggPSB0aGlzO1xuXHRcdHRoaXMuYXBwQ29udGV4dC5yb3V0ZXIub24oXG5cdFx0XHRyb3V0ZS5wYXRoLFxuXHRcdFx0cm91dGUucGF0aE9wdGlvbnMsXG5cdFx0XHQocm91dGVDb250ZXh0OiBPV2ViUm91dGVDb250ZXh0KSA9PiB7XG5cdFx0XHRcdF9kZWJ1Zyhcblx0XHRcdFx0XHQnW09XZWJQYWdlcl0gcGFnZSByb3V0ZSBtYXRjaCcsXG5cdFx0XHRcdFx0cm91dGUsXG5cdFx0XHRcdFx0cGFnZSxcblx0XHRcdFx0XHRyb3V0ZUNvbnRleHQsXG5cdFx0XHRcdCk7XG5cblx0XHRcdFx0aWYgKFxuXHRcdFx0XHRcdHBhZ2UucmVxdWlyZUxvZ2luKHJvdXRlQ29udGV4dCwgcm91dGUpICYmXG5cdFx0XHRcdFx0IWN0eC5hcHBDb250ZXh0LnVzZXJWZXJpZmllZCgpXG5cdFx0XHRcdCkge1xuXHRcdFx0XHRcdHJldHVybiAoXG5cdFx0XHRcdFx0XHRyb3V0ZUNvbnRleHQuc3RvcCgpICYmXG5cdFx0XHRcdFx0XHRjdHguYXBwQ29udGV4dC5zaG93TG9naW5QYWdlKHtcblx0XHRcdFx0XHRcdFx0bmV4dDogcm91dGVDb250ZXh0LmdldFBhdGgoKSxcblx0XHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGNvbnN0IGFyID0gY3R4Ll9hY3RpdmVSb3V0ZSxcblx0XHRcdFx0XHRhcCA9IGN0eC5fYWN0aXZlUGFnZTtcblxuXHRcdFx0XHRhcCAmJiBhciAmJiBhcC5vbkNsb3NlKGFyLCByb3V0ZSk7XG5cblx0XHRcdFx0cGFnZS5vbk9wZW4ocm91dGVDb250ZXh0LCByb3V0ZSk7XG5cblx0XHRcdFx0IXJvdXRlQ29udGV4dC5zdG9wcGVkKCkgJiYgY3R4Ll9zZXRBY3RpdmUocGFnZSwgcm91dGUpO1xuXHRcdFx0fSxcblx0XHQpO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogSGVscGVyIHRvIHNldCB0aGUgYWN0aXZlIHJvdXRlLlxuXHQgKlxuXHQgKiBAcGFyYW0gcGFnZVxuXHQgKiBAcGFyYW0gcm91dGVcblx0ICogQHByaXZhdGVcblx0ICovXG5cdHByaXZhdGUgX3NldEFjdGl2ZShwYWdlOiBJUGFnZTxDb21wb25lbnQ+LCByb3V0ZTogSVBhZ2VSb3V0ZUZ1bGwpOiB0aGlzIHtcblx0XHRjb25zdCBvbGRQYWdlID0gdGhpcy5fYWN0aXZlUGFnZSxcblx0XHRcdG9sZFJvdXRlID0gdGhpcy5fYWN0aXZlUm91dGUsXG5cdFx0XHRhcHAgPSB0aGlzLmFwcENvbnRleHQ7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX3JvdXRlc0ZsYXR0ZW5lZC5sZW5ndGg7IGkrKykge1xuXHRcdFx0Y29uc3QgYyA9IHRoaXMuX3JvdXRlc0ZsYXR0ZW5lZFtpXTtcblxuXHRcdFx0Yy5hY3RpdmUgPSByb3V0ZS5pZCA9PT0gYy5pZDtcblx0XHRcdGMuYWN0aXZlQ2hpbGQgPSAhYy5hY3RpdmUgJiYgX2lzUGFyZW50T2YoYywgcm91dGUpO1xuXHRcdH1cblxuXHRcdHRoaXMuX2FjdGl2ZVBhZ2UgPSBwYWdlO1xuXHRcdHRoaXMuX2FjdGl2ZVJvdXRlID0gcm91dGU7XG5cdFx0d0RvYy50aXRsZSA9IGFwcC5pMThuLnRvSHVtYW4oXG5cdFx0XHRyb3V0ZS50aXRsZSA/IHJvdXRlLnRpdGxlIDogYXBwLmdldEFwcE5hbWUoKSxcblx0XHQpO1xuXG5cdFx0Y29uc3QgaW5mbzogYW55ID0ge1xuXHRcdFx0cGFnZSxcblx0XHRcdG9sZFBhZ2UsXG5cdFx0XHRyb3V0ZSxcblx0XHRcdG9sZFJvdXRlLFxuXHRcdFx0c2FtZVBhZ2U6IG9sZFBhZ2UgPT09IHBhZ2UsXG5cdFx0fTtcblxuXHRcdF9kZWJ1ZygnW09XZWJQYWdlcl0gbG9jYXRpb24gaW5mbycsIGluZm8pO1xuXG5cdFx0dGhpcy50cmlnZ2VyKE9XZWJQYWdlci5FVlRfUEFHRV9MT0NBVElPTl9DSEFOR0UsIFtyb3V0ZSwgcGFnZV0pO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRvbkxvY2F0aW9uQ2hhbmdlKFxuXHRcdGhhbmRsZXI6IChyb3V0ZTogSVBhZ2VSb3V0ZUZ1bGwsIHBhZ2U6IElQYWdlPENvbXBvbmVudD4pID0+IHZvaWQsXG5cdCkge1xuXHRcdHJldHVybiB0aGlzLm9uKE9XZWJQYWdlci5FVlRfUEFHRV9MT0NBVElPTl9DSEFOR0UsIGhhbmRsZXIpO1xuXHR9XG59XG4iXX0=