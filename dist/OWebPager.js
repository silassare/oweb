import OWebEvent from './OWebEvent';
import { id, logger } from './utils';
import OWebRoute from './OWebRoute';
const wDoc = window.document;
let routeId = 0;
const _isParentOf = (parent, route) => {
    let p;
    while ((p = route.parent)) {
        if (p === parent) {
            return true;
        }
        route = p;
    }
    return false;
};
export default class OWebPager extends OWebEvent {
    _appContext;
    static SELF = id();
    static EVT_PAGE_LOCATION_CHANGE = id();
    _pages = {};
    _routesCache = [];
    _routesFlattened = [];
    _activePage;
    _activeRoute;
    constructor(_appContext) {
        super();
        this._appContext = _appContext;
        logger.info('[OWebPager] ready!');
    }
    getRoutes() {
        return [...this._routesCache];
    }
    getPage(name) {
        const page = this._pages[name];
        if (undefined === page) {
            throw new Error(`[OWebPager] the page "${name}" is not defined.`);
        }
        return page;
    }
    getActivePage() {
        if (!this._activePage) {
            throw new Error('[OWebPager] no active page.');
        }
        return this._activePage;
    }
    getActivePageRoute() {
        if (!this._activeRoute) {
            throw new Error('[OWebPager] no active route.');
        }
        return this._activeRoute;
    }
    getPageList() {
        return { ...this._pages };
    }
    registerPage(page) {
        const name = page.name;
        if (name in this._pages) {
            throw new Error(`[OWebPager] page "${name}" already registered.`);
        }
        page.install && page.install(this);
        this._pages[name] = page;
        const routes = page.routes;
        this._routesCache.push(...routes);
        return this._registerPageRoutes(page, routes);
    }
    _registerPageRoutes(page, routes, parent) {
        const router = this._appContext.router;
        for (let i = 0; i < routes.length; i++) {
            const route = routes[i];
            route.id = ++routeId;
            route.parent = parent;
            route.pathOptions = route.pathOptions || {};
            route.children = route.children || [];
            route.active = false;
            route.activeChild = false;
            const webRoute = (route.webRoute = this._addRoute(route, page));
            if (!webRoute.isDynamic()) {
                route.href = router.pathToURL(route.path).href;
            }
            if (!('show' in route)) {
                route.show = true;
            }
            if (!('showChildren' in route)) {
                route.showChildren = true;
            }
            if (!('disabled' in route)) {
                route.disabled = false;
            }
            this._routesFlattened.push(route);
            if (route.children.length) {
                this._registerPageRoutes(page, route.children, route);
            }
        }
        return this;
    }
    _addRoute(route, page) {
        const webRoute = new OWebRoute(route.path, route.pathOptions, (routeContext) => {
            logger.debug('[OWebPager] page route match', route, page, routeContext);
            if (page.requireLogin &&
                page.requireLogin(routeContext, route) &&
                !this._appContext.user.userVerified()) {
                return (routeContext.stop() &&
                    this._appContext.showLoginPage({
                        next: routeContext.getPath(),
                    }));
            }
            if (route.disabled) {
                return routeContext.stop() && this._appContext.showHomePage();
            }
            const ar = this._activeRoute, ap = this._activePage;
            ap && ar && ap.onClose && ap.onClose(ar, route);
            page.onOpen && page.onOpen(routeContext, route);
            !routeContext.stopped() && this._setActive(page, route);
        });
        this._appContext.router.addRoute(webRoute);
        return webRoute;
    }
    _setActive(page, route) {
        const oldPage = this._activePage, oldRoute = this._activeRoute, app = this._appContext;
        for (let i = 0; i < this._routesFlattened.length; i++) {
            const c = this._routesFlattened[i];
            c.active = route.id === c.id;
            c.activeChild = !c.active && _isParentOf(c, route);
        }
        this._activePage = page;
        this._activeRoute = route;
        wDoc.title = app.i18n.toHuman(route.title ? route.title : app.getAppName());
        const info = {
            page,
            oldPage,
            route,
            oldRoute,
            samePage: oldPage === page,
        };
        logger.debug('[OWebPager] location info', info);
        this.trigger(OWebPager.EVT_PAGE_LOCATION_CHANGE, [route, page]);
        return this;
    }
    onLocationChange(handler) {
        return this.on(OWebPager.EVT_PAGE_LOCATION_CHANGE, handler);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlBhZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL09XZWJQYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLFNBQVMsTUFBTSxhQUFhLENBQUM7QUFFcEMsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFckMsT0FBTyxTQUE0QyxNQUFNLGFBQWEsQ0FBQztBQStFdkUsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQztBQUM3QixJQUFJLE9BQU8sR0FBRyxDQUFDLENBQUM7QUFDaEIsTUFBTSxXQUFXLEdBQUcsQ0FDbkIsTUFBc0IsRUFDdEIsS0FBcUIsRUFDWCxFQUFFO0lBQ1osSUFBSSxDQUFDLENBQUM7SUFDTixPQUFPLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRTtRQUMxQixJQUFJLENBQUMsS0FBSyxNQUFNLEVBQUU7WUFDakIsT0FBTyxJQUFJLENBQUM7U0FDWjtRQUVELEtBQUssR0FBRyxDQUFDLENBQUM7S0FDVjtJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2QsQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLE9BQU8sT0FBTyxTQUEyQixTQUFRLFNBQVM7SUFhbkM7SUFaN0IsTUFBTSxDQUFVLElBQUksR0FBRyxFQUFFLEVBQUUsQ0FBQztJQUM1QixNQUFNLENBQVUsd0JBQXdCLEdBQUcsRUFBRSxFQUFFLENBQUM7SUFFL0IsTUFBTSxHQUFzQixFQUFFLENBQUM7SUFDeEMsWUFBWSxHQUFxQixFQUFFLENBQUM7SUFDcEMsZ0JBQWdCLEdBQXFCLEVBQUUsQ0FBQztJQUN4QyxXQUFXLENBQUs7SUFDaEIsWUFBWSxDQUFrQjtJQUt0QyxZQUE2QixXQUFvQjtRQUNoRCxLQUFLLEVBQUUsQ0FBQztRQURvQixnQkFBVyxHQUFYLFdBQVcsQ0FBUztRQUVoRCxNQUFNLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUtELFNBQVM7UUFDUixPQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQU1ELE9BQU8sQ0FBQyxJQUFZO1FBQ25CLE1BQU0sSUFBSSxHQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbEMsSUFBSSxTQUFTLEtBQUssSUFBSSxFQUFFO1lBQ3ZCLE1BQU0sSUFBSSxLQUFLLENBQUMseUJBQXlCLElBQUksbUJBQW1CLENBQUMsQ0FBQztTQUNsRTtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztJQUtELGFBQWE7UUFDWixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUN0QixNQUFNLElBQUksS0FBSyxDQUFDLDZCQUE2QixDQUFDLENBQUM7U0FDL0M7UUFDRCxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7SUFDekIsQ0FBQztJQUtELGtCQUFrQjtRQUNqQixJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUN2QixNQUFNLElBQUksS0FBSyxDQUFDLDhCQUE4QixDQUFDLENBQUM7U0FDaEQ7UUFDRCxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7SUFDMUIsQ0FBQztJQUtELFdBQVc7UUFDVixPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDM0IsQ0FBQztJQU9ELFlBQVksQ0FBQyxJQUFPO1FBQ25CLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFFdkIsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUN4QixNQUFNLElBQUksS0FBSyxDQUFDLHFCQUFxQixJQUFJLHVCQUF1QixDQUFDLENBQUM7U0FDbEU7UUFFRCxJQUFJLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFbkMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDekIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUUzQixJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxHQUFJLE1BQWdCLENBQUMsQ0FBQztRQUU3QyxPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQVVPLG1CQUFtQixDQUMxQixJQUFPLEVBQ1AsTUFBb0IsRUFDcEIsTUFBdUI7UUFFdkIsTUFBTSxNQUFNLEdBQWUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUM7UUFFbkQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDdkMsTUFBTSxLQUFLLEdBQVEsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRTdCLEtBQUssQ0FBQyxFQUFFLEdBQUcsRUFBRSxPQUFPLENBQUM7WUFDckIsS0FBSyxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7WUFDdEIsS0FBSyxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsV0FBVyxJQUFJLEVBQUUsQ0FBQztZQUM1QyxLQUFLLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQyxRQUFRLElBQUksRUFBRSxDQUFDO1lBQ3RDLEtBQUssQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO1lBQ3JCLEtBQUssQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO1lBRTFCLE1BQU0sUUFBUSxHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2hFLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLEVBQUU7Z0JBQzFCLEtBQUssQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDO2FBQy9DO1lBRUQsSUFBSSxDQUFDLENBQUMsTUFBTSxJQUFJLEtBQUssQ0FBQyxFQUFFO2dCQUN2QixLQUFLLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQzthQUNsQjtZQUNELElBQUksQ0FBQyxDQUFDLGNBQWMsSUFBSSxLQUFLLENBQUMsRUFBRTtnQkFDL0IsS0FBSyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7YUFDMUI7WUFDRCxJQUFJLENBQUMsQ0FBQyxVQUFVLElBQUksS0FBSyxDQUFDLEVBQUU7Z0JBQzNCLEtBQUssQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO2FBQ3ZCO1lBRUQsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUVsQyxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFO2dCQUMxQixJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7YUFDdEQ7U0FDRDtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztJQVNPLFNBQVMsQ0FBQyxLQUFxQixFQUFFLElBQU87UUFDL0MsTUFBTSxRQUFRLEdBQUcsSUFBSSxTQUFTLENBQzdCLEtBQUssQ0FBQyxJQUFJLEVBQ1YsS0FBSyxDQUFDLFdBQVcsRUFDakIsQ0FBQyxZQUE4QixFQUFFLEVBQUU7WUFDbEMsTUFBTSxDQUFDLEtBQUssQ0FBQyw4QkFBOEIsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLFlBQVksQ0FBQyxDQUFDO1lBRXhFLElBQ0MsSUFBSSxDQUFDLFlBQVk7Z0JBQ2pCLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLEtBQUssQ0FBQztnQkFDdEMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsRUFDcEM7Z0JBQ0QsT0FBTyxDQUNOLFlBQVksQ0FBQyxJQUFJLEVBQUU7b0JBQ25CLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDO3dCQUM5QixJQUFJLEVBQUUsWUFBWSxDQUFDLE9BQU8sRUFBRTtxQkFDNUIsQ0FBQyxDQUNGLENBQUM7YUFDRjtZQUVELElBQUksS0FBSyxDQUFDLFFBQVEsRUFBRTtnQkFDbkIsT0FBTyxZQUFZLENBQUMsSUFBSSxFQUFFLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsQ0FBQzthQUM5RDtZQUVELE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQzNCLEVBQUUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDO1lBRXZCLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUVoRCxJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBRWhELENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3pELENBQUMsQ0FDRCxDQUFDO1FBRUYsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRTNDLE9BQU8sUUFBUSxDQUFDO0lBQ2pCLENBQUM7SUFTTyxVQUFVLENBQUMsSUFBTyxFQUFFLEtBQXFCO1FBQ2hELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLEVBQy9CLFFBQVEsR0FBRyxJQUFJLENBQUMsWUFBWSxFQUM1QixHQUFHLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUV4QixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN0RCxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFbkMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDN0IsQ0FBQyxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLElBQUksV0FBVyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUNuRDtRQUVELElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDO1FBQzFCLElBQUksQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7UUFFNUUsTUFBTSxJQUFJLEdBQVE7WUFDakIsSUFBSTtZQUNKLE9BQU87WUFDUCxLQUFLO1lBQ0wsUUFBUTtZQUNSLFFBQVEsRUFBRSxPQUFPLEtBQUssSUFBSTtTQUMxQixDQUFDO1FBRUYsTUFBTSxDQUFDLEtBQUssQ0FBQywyQkFBMkIsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVoRCxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyx3QkFBd0IsRUFBRSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRWhFLE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztJQUVELGdCQUFnQixDQUFDLE9BQWlEO1FBQ2pFLE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsd0JBQXdCLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDN0QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBPV2ViQXBwIGZyb20gJy4vT1dlYkFwcCc7XG5pbXBvcnQgT1dlYkV2ZW50IGZyb20gJy4vT1dlYkV2ZW50JztcbmltcG9ydCBPV2ViUm91dGVyIGZyb20gJy4vT1dlYlJvdXRlcic7XG5pbXBvcnQgeyBpZCwgbG9nZ2VyIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgT1dlYlJvdXRlQ29udGV4dCBmcm9tICcuL09XZWJSb3V0ZUNvbnRleHQnO1xuaW1wb3J0IE9XZWJSb3V0ZSwgeyBPUm91dGVQYXRoLCBPUm91dGVQYXRoT3B0aW9ucyB9IGZyb20gJy4vT1dlYlJvdXRlJztcbmltcG9ydCB7IE9JMThuIH0gZnJvbSAnLi9PV2ViSTE4bic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgT1BhZ2VSb3V0ZSB7XG5cdHNsdWc/OiBzdHJpbmc7XG5cdGljb24/OiBzdHJpbmc7XG5cdHRpdGxlOiBPSTE4bjtcblx0ZGVzY3JpcHRpb24/OiBPSTE4bjtcblx0cGF0aDogT1JvdXRlUGF0aDtcblx0cGF0aE9wdGlvbnM/OiBPUm91dGVQYXRoT3B0aW9ucztcblx0Y2hpbGRyZW4/OiBPUGFnZVJvdXRlW107XG5cdHNob3dDaGlsZHJlbj86IGJvb2xlYW47XG5cdGRpc2FibGVkPzogYm9vbGVhbjtcblx0c2hvdz86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgT1BhZ2VSb3V0ZUZ1bGwge1xuXHRzbHVnPzogc3RyaW5nO1xuXHRpY29uPzogc3RyaW5nO1xuXHR0aXRsZTogT0kxOG47XG5cdGRlc2NyaXB0aW9uPzogT0kxOG47XG5cdHBhdGg6IE9Sb3V0ZVBhdGg7XG5cdHBhdGhPcHRpb25zOiBPUm91dGVQYXRoT3B0aW9ucztcblx0Y2hpbGRyZW46IE9QYWdlUm91dGVGdWxsW107XG5cdHNob3dDaGlsZHJlbjogYm9vbGVhbjtcblx0ZGlzYWJsZWQ6IGJvb2xlYW47XG5cdHNob3c6IGJvb2xlYW47XG5cblx0cmVhZG9ubHkgaWQ6IG51bWJlcjtcblx0cmVhZG9ubHkgaHJlZj86IHN0cmluZztcblx0cmVhZG9ubHkgcGFyZW50PzogT1BhZ2VSb3V0ZUZ1bGw7XG5cdGFjdGl2ZTogYm9vbGVhbjtcblx0YWN0aXZlQ2hpbGQ6IGJvb2xlYW47XG5cdHdlYlJvdXRlOiBPV2ViUm91dGU7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgT1BhZ2Uge1xuXHQvKipcblx0ICogVGhlIHBhZ2UgbmFtZSBnZXR0ZXIuXG5cdCAqL1xuXHRuYW1lOiBzdHJpbmc7XG5cblx0LyoqXG5cdCAqIFRoZSBwYWdlIHJvdXRlcyBnZXR0ZXIuXG5cdCAqL1xuXHRyb3V0ZXM6IE9QYWdlUm91dGVbXTtcblxuXHQvKipcblx0ICogQ2FsbGVkIG9uY2Ugd2hlbiByZWdpc3RlcmluZyB0aGUgcGFnZS5cblx0ICpcblx0ICogQHBhcmFtIHBhZ2VyXG5cdCAqL1xuXHRpbnN0YWxsPyhwYWdlcjogT1dlYlBhZ2VyPHRoaXM+KTogdGhpcztcblxuXHQvKipcblx0ICogRG9lcyB0aGlzIHBhZ2UgcmVxdWlyZSBhIHZlcmlmaWVkIHVzZXIgZm9yIHRoZSByZXF1ZXN0ZWQgcGFnZSByb3V0ZS5cblx0ICpcblx0ICogQHBhcmFtIGNvbnRleHQgVGhlIGFwcCBjb250ZXh0LlxuXHQgKiBAcGFyYW0gcm91dGUgVGhlIHJlcXVlc3QgcGFnZSByb3V0ZS5cblx0ICovXG5cdHJlcXVpcmVMb2dpbj8oY29udGV4dDogT1dlYlJvdXRlQ29udGV4dCwgcm91dGU6IE9QYWdlUm91dGVGdWxsKTogYm9vbGVhbjtcblxuXHQvKipcblx0ICogQ2FsbGVkIGJlZm9yZSBwYWdlIG9wZW4uXG5cdCAqXG5cdCAqIEBwYXJhbSBjb250ZXh0XG5cdCAqIEBwYXJhbSByb3V0ZVxuXHQgKi9cblx0b25PcGVuPyhjb250ZXh0OiBPV2ViUm91dGVDb250ZXh0LCByb3V0ZTogT1BhZ2VSb3V0ZUZ1bGwpOiB2b2lkO1xuXG5cdC8qKlxuXHQgKiBDYWxsZWQgYmVmb3JlIHBhZ2UgY2xvc2UuXG5cdCAqXG5cdCAqIEBwYXJhbSBvbGRSb3V0ZVxuXHQgKiBAcGFyYW0gbmV3Um91dGVcblx0ICovXG5cdG9uQ2xvc2U/KG9sZFJvdXRlOiBPUGFnZVJvdXRlRnVsbCwgbmV3Um91dGU6IE9QYWdlUm91dGVGdWxsKTogdm9pZDtcbn1cblxuY29uc3Qgd0RvYyA9IHdpbmRvdy5kb2N1bWVudDtcbmxldCByb3V0ZUlkID0gMDtcbmNvbnN0IF9pc1BhcmVudE9mID0gKFxuXHRwYXJlbnQ6IE9QYWdlUm91dGVGdWxsLFxuXHRyb3V0ZTogT1BhZ2VSb3V0ZUZ1bGxcbik6IGJvb2xlYW4gPT4ge1xuXHRsZXQgcDtcblx0d2hpbGUgKChwID0gcm91dGUucGFyZW50KSkge1xuXHRcdGlmIChwID09PSBwYXJlbnQpIHtcblx0XHRcdHJldHVybiB0cnVlO1xuXHRcdH1cblxuXHRcdHJvdXRlID0gcDtcblx0fVxuXHRyZXR1cm4gZmFsc2U7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViUGFnZXI8UCBleHRlbmRzIE9QYWdlPiBleHRlbmRzIE9XZWJFdmVudCB7XG5cdHN0YXRpYyByZWFkb25seSBTRUxGID0gaWQoKTtcblx0c3RhdGljIHJlYWRvbmx5IEVWVF9QQUdFX0xPQ0FUSU9OX0NIQU5HRSA9IGlkKCk7XG5cblx0cHJpdmF0ZSByZWFkb25seSBfcGFnZXM6IFJlY29yZDxzdHJpbmcsIFA+ID0ge307XG5cdHByaXZhdGUgX3JvdXRlc0NhY2hlOiBPUGFnZVJvdXRlRnVsbFtdID0gW107XG5cdHByaXZhdGUgX3JvdXRlc0ZsYXR0ZW5lZDogT1BhZ2VSb3V0ZUZ1bGxbXSA9IFtdO1xuXHRwcml2YXRlIF9hY3RpdmVQYWdlPzogUDtcblx0cHJpdmF0ZSBfYWN0aXZlUm91dGU/OiBPUGFnZVJvdXRlRnVsbDtcblxuXHQvKipcblx0ICogQHBhcmFtIF9hcHBDb250ZXh0IFRoZSBhcHAgY29udGV4dC5cblx0ICovXG5cdGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgX2FwcENvbnRleHQ6IE9XZWJBcHApIHtcblx0XHRzdXBlcigpO1xuXHRcdGxvZ2dlci5pbmZvKCdbT1dlYlBhZ2VyXSByZWFkeSEnKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHJlZ2lzdGVyZWQgcGFnZXMgcm91dGVzLlxuXHQgKi9cblx0Z2V0Um91dGVzKCk6IE9QYWdlUm91dGVGdWxsW10ge1xuXHRcdHJldHVybiBbLi4udGhpcy5fcm91dGVzQ2FjaGVdO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgdGhlIHBhZ2Ugd2l0aCB0aGUgZ2l2ZW4gbmFtZS5cblx0ICogQHBhcmFtIG5hbWVcblx0ICovXG5cdGdldFBhZ2UobmFtZTogc3RyaW5nKTogUCB7XG5cdFx0Y29uc3QgcGFnZTogUCA9IHRoaXMuX3BhZ2VzW25hbWVdO1xuXHRcdGlmICh1bmRlZmluZWQgPT09IHBhZ2UpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihgW09XZWJQYWdlcl0gdGhlIHBhZ2UgXCIke25hbWV9XCIgaXMgbm90IGRlZmluZWQuYCk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHBhZ2U7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgYWN0aXZlIHBhZ2UuXG5cdCAqL1xuXHRnZXRBY3RpdmVQYWdlKCk6IFAge1xuXHRcdGlmICghdGhpcy5fYWN0aXZlUGFnZSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdbT1dlYlBhZ2VyXSBubyBhY3RpdmUgcGFnZS4nKTtcblx0XHR9XG5cdFx0cmV0dXJuIHRoaXMuX2FjdGl2ZVBhZ2U7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgYWN0aXZlIHBhZ2Ugcm91dGUuXG5cdCAqL1xuXHRnZXRBY3RpdmVQYWdlUm91dGUoKTogT1BhZ2VSb3V0ZUZ1bGwge1xuXHRcdGlmICghdGhpcy5fYWN0aXZlUm91dGUpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcignW09XZWJQYWdlcl0gbm8gYWN0aXZlIHJvdXRlLicpO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcy5fYWN0aXZlUm91dGU7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyBhbGwgcGFnZXMgbGlzdC5cblx0ICovXG5cdGdldFBhZ2VMaXN0KCk6IFJlY29yZDxzdHJpbmcsIFA+IHtcblx0XHRyZXR1cm4geyAuLi50aGlzLl9wYWdlcyB9O1xuXHR9XG5cblx0LyoqXG5cdCAqIFJlZ2lzdGVyIGEgZ2l2ZW4gcGFnZS5cblx0ICpcblx0ICogQHBhcmFtIHBhZ2Vcblx0ICovXG5cdHJlZ2lzdGVyUGFnZShwYWdlOiBQKTogdGhpcyB7XG5cdFx0Y29uc3QgbmFtZSA9IHBhZ2UubmFtZTtcblxuXHRcdGlmIChuYW1lIGluIHRoaXMuX3BhZ2VzKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYFtPV2ViUGFnZXJdIHBhZ2UgXCIke25hbWV9XCIgYWxyZWFkeSByZWdpc3RlcmVkLmApO1xuXHRcdH1cblxuXHRcdHBhZ2UuaW5zdGFsbCAmJiBwYWdlLmluc3RhbGwodGhpcyk7XG5cblx0XHR0aGlzLl9wYWdlc1tuYW1lXSA9IHBhZ2U7XG5cdFx0Y29uc3Qgcm91dGVzID0gcGFnZS5yb3V0ZXM7XG5cblx0XHR0aGlzLl9yb3V0ZXNDYWNoZS5wdXNoKC4uLihyb3V0ZXMgYXMgYW55W10pKTtcblxuXHRcdHJldHVybiB0aGlzLl9yZWdpc3RlclBhZ2VSb3V0ZXMocGFnZSwgcm91dGVzKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBIZWxwZXJzIHRvIHJlZ2lzdGVyIHBhZ2Ugcm91dGVzLlxuXHQgKlxuXHQgKiBAcGFyYW0gcGFnZSBUaGUgcGFnZS5cblx0ICogQHBhcmFtIHJvdXRlcyBUaGUgcGFnZSByb3V0ZXMgbGlzdC5cblx0ICogQHBhcmFtIHBhcmVudCBUaGUgcGFnZSByb3V0ZXMgcGFyZW50LlxuXHQgKiBAcHJpdmF0ZVxuXHQgKi9cblx0cHJpdmF0ZSBfcmVnaXN0ZXJQYWdlUm91dGVzKFxuXHRcdHBhZ2U6IFAsXG5cdFx0cm91dGVzOiBPUGFnZVJvdXRlW10sXG5cdFx0cGFyZW50PzogT1BhZ2VSb3V0ZUZ1bGxcblx0KTogdGhpcyB7XG5cdFx0Y29uc3Qgcm91dGVyOiBPV2ViUm91dGVyID0gdGhpcy5fYXBwQ29udGV4dC5yb3V0ZXI7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHJvdXRlcy5sZW5ndGg7IGkrKykge1xuXHRcdFx0Y29uc3Qgcm91dGU6IGFueSA9IHJvdXRlc1tpXTtcblxuXHRcdFx0cm91dGUuaWQgPSArK3JvdXRlSWQ7XG5cdFx0XHRyb3V0ZS5wYXJlbnQgPSBwYXJlbnQ7XG5cdFx0XHRyb3V0ZS5wYXRoT3B0aW9ucyA9IHJvdXRlLnBhdGhPcHRpb25zIHx8IHt9O1xuXHRcdFx0cm91dGUuY2hpbGRyZW4gPSByb3V0ZS5jaGlsZHJlbiB8fCBbXTtcblx0XHRcdHJvdXRlLmFjdGl2ZSA9IGZhbHNlO1xuXHRcdFx0cm91dGUuYWN0aXZlQ2hpbGQgPSBmYWxzZTtcblxuXHRcdFx0Y29uc3Qgd2ViUm91dGUgPSAocm91dGUud2ViUm91dGUgPSB0aGlzLl9hZGRSb3V0ZShyb3V0ZSwgcGFnZSkpO1xuXHRcdFx0aWYgKCF3ZWJSb3V0ZS5pc0R5bmFtaWMoKSkge1xuXHRcdFx0XHRyb3V0ZS5ocmVmID0gcm91dGVyLnBhdGhUb1VSTChyb3V0ZS5wYXRoKS5ocmVmO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoISgnc2hvdycgaW4gcm91dGUpKSB7XG5cdFx0XHRcdHJvdXRlLnNob3cgPSB0cnVlO1xuXHRcdFx0fVxuXHRcdFx0aWYgKCEoJ3Nob3dDaGlsZHJlbicgaW4gcm91dGUpKSB7XG5cdFx0XHRcdHJvdXRlLnNob3dDaGlsZHJlbiA9IHRydWU7XG5cdFx0XHR9XG5cdFx0XHRpZiAoISgnZGlzYWJsZWQnIGluIHJvdXRlKSkge1xuXHRcdFx0XHRyb3V0ZS5kaXNhYmxlZCA9IGZhbHNlO1xuXHRcdFx0fVxuXG5cdFx0XHR0aGlzLl9yb3V0ZXNGbGF0dGVuZWQucHVzaChyb3V0ZSk7XG5cblx0XHRcdGlmIChyb3V0ZS5jaGlsZHJlbi5sZW5ndGgpIHtcblx0XHRcdFx0dGhpcy5fcmVnaXN0ZXJQYWdlUm91dGVzKHBhZ2UsIHJvdXRlLmNoaWxkcmVuLCByb3V0ZSk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogSGVscGVyIHRvIGFkZCByb3V0ZS5cblx0ICpcblx0ICogQHBhcmFtIHJvdXRlIFRoZSByb3V0ZSBvYmplY3QuXG5cdCAqIEBwYXJhbSBwYWdlIFRoZSBwYWdlIHRvIHdoaWNoIHRoYXQgcm91dGUgYmVsb25ncyB0by5cblx0ICogQHByaXZhdGVcblx0ICovXG5cdHByaXZhdGUgX2FkZFJvdXRlKHJvdXRlOiBPUGFnZVJvdXRlRnVsbCwgcGFnZTogUCk6IE9XZWJSb3V0ZSB7XG5cdFx0Y29uc3Qgd2ViUm91dGUgPSBuZXcgT1dlYlJvdXRlKFxuXHRcdFx0cm91dGUucGF0aCxcblx0XHRcdHJvdXRlLnBhdGhPcHRpb25zLFxuXHRcdFx0KHJvdXRlQ29udGV4dDogT1dlYlJvdXRlQ29udGV4dCkgPT4ge1xuXHRcdFx0XHRsb2dnZXIuZGVidWcoJ1tPV2ViUGFnZXJdIHBhZ2Ugcm91dGUgbWF0Y2gnLCByb3V0ZSwgcGFnZSwgcm91dGVDb250ZXh0KTtcblxuXHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0cGFnZS5yZXF1aXJlTG9naW4gJiZcblx0XHRcdFx0XHRwYWdlLnJlcXVpcmVMb2dpbihyb3V0ZUNvbnRleHQsIHJvdXRlKSAmJlxuXHRcdFx0XHRcdCF0aGlzLl9hcHBDb250ZXh0LnVzZXIudXNlclZlcmlmaWVkKClcblx0XHRcdFx0KSB7XG5cdFx0XHRcdFx0cmV0dXJuIChcblx0XHRcdFx0XHRcdHJvdXRlQ29udGV4dC5zdG9wKCkgJiZcblx0XHRcdFx0XHRcdHRoaXMuX2FwcENvbnRleHQuc2hvd0xvZ2luUGFnZSh7XG5cdFx0XHRcdFx0XHRcdG5leHQ6IHJvdXRlQ29udGV4dC5nZXRQYXRoKCksXG5cdFx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRpZiAocm91dGUuZGlzYWJsZWQpIHtcblx0XHRcdFx0XHRyZXR1cm4gcm91dGVDb250ZXh0LnN0b3AoKSAmJiB0aGlzLl9hcHBDb250ZXh0LnNob3dIb21lUGFnZSgpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0Y29uc3QgYXIgPSB0aGlzLl9hY3RpdmVSb3V0ZSxcblx0XHRcdFx0XHRhcCA9IHRoaXMuX2FjdGl2ZVBhZ2U7XG5cblx0XHRcdFx0YXAgJiYgYXIgJiYgYXAub25DbG9zZSAmJiBhcC5vbkNsb3NlKGFyLCByb3V0ZSk7XG5cblx0XHRcdFx0cGFnZS5vbk9wZW4gJiYgcGFnZS5vbk9wZW4ocm91dGVDb250ZXh0LCByb3V0ZSk7XG5cblx0XHRcdFx0IXJvdXRlQ29udGV4dC5zdG9wcGVkKCkgJiYgdGhpcy5fc2V0QWN0aXZlKHBhZ2UsIHJvdXRlKTtcblx0XHRcdH1cblx0XHQpO1xuXG5cdFx0dGhpcy5fYXBwQ29udGV4dC5yb3V0ZXIuYWRkUm91dGUod2ViUm91dGUpO1xuXG5cdFx0cmV0dXJuIHdlYlJvdXRlO1xuXHR9XG5cblx0LyoqXG5cdCAqIEhlbHBlciB0byBzZXQgdGhlIGFjdGl2ZSByb3V0ZS5cblx0ICpcblx0ICogQHBhcmFtIHBhZ2Vcblx0ICogQHBhcmFtIHJvdXRlXG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIF9zZXRBY3RpdmUocGFnZTogUCwgcm91dGU6IE9QYWdlUm91dGVGdWxsKTogdGhpcyB7XG5cdFx0Y29uc3Qgb2xkUGFnZSA9IHRoaXMuX2FjdGl2ZVBhZ2UsXG5cdFx0XHRvbGRSb3V0ZSA9IHRoaXMuX2FjdGl2ZVJvdXRlLFxuXHRcdFx0YXBwID0gdGhpcy5fYXBwQ29udGV4dDtcblxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fcm91dGVzRmxhdHRlbmVkLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRjb25zdCBjID0gdGhpcy5fcm91dGVzRmxhdHRlbmVkW2ldO1xuXG5cdFx0XHRjLmFjdGl2ZSA9IHJvdXRlLmlkID09PSBjLmlkO1xuXHRcdFx0Yy5hY3RpdmVDaGlsZCA9ICFjLmFjdGl2ZSAmJiBfaXNQYXJlbnRPZihjLCByb3V0ZSk7XG5cdFx0fVxuXG5cdFx0dGhpcy5fYWN0aXZlUGFnZSA9IHBhZ2U7XG5cdFx0dGhpcy5fYWN0aXZlUm91dGUgPSByb3V0ZTtcblx0XHR3RG9jLnRpdGxlID0gYXBwLmkxOG4udG9IdW1hbihyb3V0ZS50aXRsZSA/IHJvdXRlLnRpdGxlIDogYXBwLmdldEFwcE5hbWUoKSk7XG5cblx0XHRjb25zdCBpbmZvOiBhbnkgPSB7XG5cdFx0XHRwYWdlLFxuXHRcdFx0b2xkUGFnZSxcblx0XHRcdHJvdXRlLFxuXHRcdFx0b2xkUm91dGUsXG5cdFx0XHRzYW1lUGFnZTogb2xkUGFnZSA9PT0gcGFnZSxcblx0XHR9O1xuXG5cdFx0bG9nZ2VyLmRlYnVnKCdbT1dlYlBhZ2VyXSBsb2NhdGlvbiBpbmZvJywgaW5mbyk7XG5cblx0XHR0aGlzLnRyaWdnZXIoT1dlYlBhZ2VyLkVWVF9QQUdFX0xPQ0FUSU9OX0NIQU5HRSwgW3JvdXRlLCBwYWdlXSk7XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdG9uTG9jYXRpb25DaGFuZ2UoaGFuZGxlcjogKHJvdXRlOiBPUGFnZVJvdXRlRnVsbCwgcGFnZTogUCkgPT4gdm9pZCk6IHRoaXMge1xuXHRcdHJldHVybiB0aGlzLm9uKE9XZWJQYWdlci5FVlRfUEFHRV9MT0NBVElPTl9DSEFOR0UsIGhhbmRsZXIpO1xuXHR9XG59XG4iXX0=