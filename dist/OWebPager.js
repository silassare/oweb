import OWebEvent from "./OWebEvent";
import OWebLang from "./OWebLang";
const wDoc = window.document;
let routeId = 0, _isParentOf = (parent, route) => {
    let p;
    while (p = route.parent) {
        if (p === parent) {
            return true;
        }
        route = p;
    }
    return false;
};
export default class OWebPager extends OWebEvent {
    constructor(app_context) {
        super();
        this.app_context = app_context;
        this._pages = {};
        this._routes_cache = [];
        this._routes_flattened = [];
        console.log("[OWebPager] ready!");
    }
    getRoutes() {
        return this._routes_cache;
    }
    getPage(name) {
        let page = this._pages[name];
        if (undefined === page) {
            throw new Error(`[OWebPager] the page "${name}" is not defined.`);
        }
        return page;
    }
    getActivePage() {
        if (!this._active_page) {
            throw new Error("[OWebPager] no active page.");
        }
        return this._active_page;
    }
    getActivePageRoute() {
        if (!this._active_route) {
            throw new Error("[OWebPager] no active route.");
        }
        return this._active_route;
    }
    getPageList() {
        return Object.create(this._pages);
    }
    registerPage(page) {
        let name = page.getName();
        if (name in this._pages) {
            throw new Error(`[OWebPager] page "${name}" already registered.`);
        }
        this._pages[name] = page.install(this);
        let routes = page.getRoutes();
        this._routes_cache.push(...routes);
        return this._registerPageRoutes(page, routes);
    }
    _registerPageRoutes(page, routes, parent) {
        let router = this.app_context.router;
        for (let i = 0; i < routes.length; i++) {
            let route = routes[i];
            route.id = ++routeId;
            route.parent = parent;
            route.href = router.pathToURL(typeof route.path === "string" ? route.path : "/").href;
            route.active = false;
            route.active_child = false;
            route.show = route.show || function () {
                return true;
            };
            this._routes_flattened.push(route);
            this._addRoute(route, page);
            if (route.sub && route.sub.length) {
                this._registerPageRoutes(page, route.sub, route);
            }
        }
        return this;
    }
    _addRoute(route, page) {
        let ctx = this;
        this.app_context.router.on(route.path, route.pathOptions, (routeContext) => {
            console.log("[OWebPager] page route match ->", route, page, routeContext);
            if (page.requireLogin(routeContext, route) && !ctx.app_context.userVerified()) {
                return routeContext.stop() && ctx.app_context.showLoginPage();
            }
            let ar = ctx._active_route, ap = ctx._active_page;
            ap && ar && ap.onClose(ar, route);
            page.onOpen(routeContext, route);
            !routeContext.stopped() && ctx._setActivePage(page)._setActiveRoute(route);
        });
        return this;
    }
    _setActiveRoute(route) {
        let list = this._routes_flattened;
        for (let i = 0; i < list.length; i++) {
            let c = list[i];
            c.active = route.id === c.id;
            c.active_child = !c.active && _isParentOf(c, route);
        }
        wDoc.title = OWebLang.toHuman(route.title.length ? route.title : this.app_context.getAppName());
        this._active_route = route;
        console.log(`[OWebPager] active route ->`, this._active_route);
        return this;
    }
    _setActivePage(newPage) {
        let oldPage = this._active_page;
        if (oldPage !== newPage) {
            console.log(`[OWebPager] page changing ->`, newPage, oldPage);
            this._active_page = newPage;
            this.trigger(OWebPager.EVT_PAGE_CHANGE, [oldPage, newPage]);
        }
        else {
            console.log(`[OWebPager] same page ->`, oldPage, newPage);
        }
        return this;
    }
}
OWebPager.SELF = "OWebPager";
OWebPager.EVT_PAGE_CHANGE = "OWebPager:page_change";
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlBhZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL09XZWJQYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLFNBQVMsTUFBTSxhQUFhLENBQUM7QUFDcEMsT0FBTyxRQUFRLE1BQU0sWUFBWSxDQUFDO0FBdUNsQyxNQUFNLElBQUksR0FBVSxNQUFNLENBQUMsUUFBUSxDQUFDO0FBQ3BDLElBQUksT0FBTyxHQUFTLENBQUMsRUFDbEIsV0FBVyxHQUFHLENBQUMsTUFBc0IsRUFBRSxLQUFxQixFQUFXLEVBQUU7SUFDeEUsSUFBSSxDQUFDLENBQUM7SUFDTixPQUFPLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTyxFQUFFO1FBQ3pCLElBQUksQ0FBQyxLQUFLLE1BQU0sRUFBRTtZQUNqQixPQUFPLElBQUksQ0FBQztTQUNaO1FBRUQsS0FBSyxHQUFHLENBQUMsQ0FBQztLQUNWO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDZCxDQUFDLENBQUM7QUFFTCxNQUFNLENBQUMsT0FBTyxnQkFBaUIsU0FBUSxTQUFTO0lBVS9DLFlBQTZCLFdBQW9CO1FBQ2hELEtBQUssRUFBRSxDQUFDO1FBRG9CLGdCQUFXLEdBQVgsV0FBVyxDQUFTO1FBTmhDLFdBQU0sR0FBNkIsRUFBRSxDQUFDO1FBRS9DLGtCQUFhLEdBQStCLEVBQUUsQ0FBQztRQUMvQyxzQkFBaUIsR0FBMkIsRUFBRSxDQUFDO1FBS3RELE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBRUQsU0FBUztRQUNSLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztJQUMzQixDQUFDO0lBRUQsT0FBTyxDQUFDLElBQVk7UUFDbkIsSUFBSSxJQUFJLEdBQVUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwQyxJQUFJLFNBQVMsS0FBSyxJQUFJLEVBQUU7WUFDdkIsTUFBTSxJQUFJLEtBQUssQ0FBQyx5QkFBeUIs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LEVBQUUsQ0FBQztZQUNuQyxDQUFDLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sSUFBSSxXQUFXLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ3BEO1FBRUQsSUFBSSxDQUFDLEtBQUssR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7UUFFaEcsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUM7UUFFM0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyw2QkFBNkIsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFL0QsT0FBTyxJQUFJLENBQUM7SUFDYixDQUFDO0lBRU8sY0FBYyxDQUFDLE9BQWM7UUFDcEMsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQztRQUVoQyxJQUFJLE9BQU8sS0FBSyxPQUFPLEVBQUU7WUFDeEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyw4QkFBOEIsRUFBRSxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDOUQsSUFBSSxDQUFDLFlBQVksR0FBRyxPQUFPLENBQUM7WUFDNUIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsZUFBZSxFQUFFLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUM7U0FDNUQ7YUFBTTtZQUNOLE9BQU8sQ0FBQyxHQUFHLENBQUMsMEJBQTBCLEVBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQzFEO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDYixDQUFDOztBQTdJZSxjQUFJLEdBQWMsV0FBVyxDQUFDO0FBQzlCLHlCQUFlLEdBQUcsdUJBQXVCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1Z1ZUNvbnN0cnVjdG9yfSBmcm9tIFwidnVlL3R5cGVzL3Z1ZVwiO1xuaW1wb3J0IE9XZWJBcHAgZnJvbSBcIi4vT1dlYkFwcFwiO1xuaW1wb3J0IE9XZWJFdmVudCBmcm9tIFwiLi9PV2ViRXZlbnRcIjtcbmltcG9ydCBPV2ViTGFuZyBmcm9tIFwiLi9PV2ViTGFuZ1wiO1xuaW1wb3J0IE9XZWJSb3V0ZXIsIHtPV2ViUm91dGVDb250ZXh0LCB0Um91dGVQYXRoLCB0Um91dGVQYXRoT3B0aW9uc30gZnJvbSBcIi4vT1dlYlJvdXRlclwiO1xuXG5leHBvcnQgdHlwZSB0UGFnZVJvdXRlID0ge1xuXHRzbHVnPzogc3RyaW5nLFxuXHR0aXRsZTogc3RyaW5nLFxuXHRkZXNjcmlwdGlvbj86IHN0cmluZyxcblx0aWNvbj86IHN0cmluZyxcblx0cGF0aDogdFJvdXRlUGF0aCxcblx0cGF0aE9wdGlvbnM/OiB0Um91dGVQYXRoT3B0aW9ucyxcblx0c3ViPzogdFBhZ2VSb3V0ZVtdLFxuXHRzaG93PygpOiBib29sZWFuXG59O1xuXG5leHBvcnQgdHlwZSB0UGFnZVJvdXRlRnVsbCA9IHRQYWdlUm91dGUgJiB7XG5cdHJlYWRvbmx5IGlkOiBudW1iZXIsXG5cdHJlYWRvbmx5IGhyZWY6IHN0cmluZyxcblx0cmVhZG9ubHkgcGFyZW50PzogdFBhZ2VSb3V0ZUZ1bGwsXG5cdGFjdGl2ZTogYm9vbGVhbixcblx0YWN0aXZlX2NoaWxkOiBib29sZWFuLFxuXHRzaG93KCk6IGJvb2xlYW5cbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVBhZ2Uge1xuXHRnZXROYW1lKCk6IHN0cmluZztcblxuXHRnZXRSb3V0ZXMoKTogdFBhZ2VSb3V0ZVtdO1xuXG5cdGluc3RhbGwocGFnZXI6IE9XZWJQYWdlcik6IHRoaXM7XG5cblx0Y29tcG9uZW50KCk6IFZ1ZUNvbnN0cnVjdG9yIHwgdW5kZWZpbmVkLFxuXG5cdHJlcXVpcmVMb2dpbihjb250ZXh0OiBPV2ViUm91dGVDb250ZXh0LCByb3V0ZTogdFBhZ2VSb3V0ZUZ1bGwpOiBib29sZWFuLFxuXG5cdG9uT3Blbihjb250ZXh0OiBPV2ViUm91dGVDb250ZXh0LCByb3V0ZTogdFBhZ2VSb3V0ZUZ1bGwpOiB2b2lkLFxuXG5cdG9uQ2xvc2Uob2xkUm91dGU6IHRQYWdlUm91dGVGdWxsLCBuZXdSb3V0ZTogdFBhZ2VSb3V0ZUZ1bGwpOiB2b2lkXG59XG5cbmNvbnN0IHdEb2MgICAgICAgID0gd2luZG93LmRvY3VtZW50O1xubGV0IHJvdXRlSWQgICAgICAgPSAwLFxuXHQgIF9pc1BhcmVudE9mID0gKHBhcmVudDogdFBhZ2VSb3V0ZUZ1bGwsIHJvdXRlOiB0UGFnZVJvdXRlRnVsbCk6IGJvb2xlYW4gPT4ge1xuXHRcdCAgbGV0IHA7XG5cdFx0ICB3aGlsZSAocCA9IHJvdXRlLnBhcmVudCEpIHtcblx0XHRcdCAgaWYgKHAgPT09IHBhcmVudCkge1xuXHRcdFx0XHQgIHJldHVybiB0cnVlO1xuXHRcdFx0ICB9XG5cblx0XHRcdCAgcm91dGUgPSBwO1xuXHRcdCAgfVxuXHRcdCAgcmV0dXJuIGZhbHNlO1xuXHQgIH07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJQYWdlciBleHRlbmRzIE9XZWJFdmVudCB7XG5cdHN0YXRpYyByZWFkb25seSBTRUxGICAgICAgICAgICAgPSBcIk9XZWJQYWdlclwiO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX1BBR0VfQ0hBTkdFID0gXCJPV2ViUGFnZXI6cGFnZV9jaGFuZ2VcIjtcblxuXHRwcml2YXRlIHJlYWRvbmx5IF9wYWdlczogeyBba2V5OiBzdHJpbmddOiBpUGFnZSB9ID0ge307XG5cdHByaXZhdGUgX2FjdGl2ZV9wYWdlOiBpUGFnZSB8IHVuZGVmaW5lZDtcblx0cHJpdmF0ZSBfcm91dGVzX2NhY2hlOiB0UGFnZVJvdXRlW10gICAgICAgICAgICAgICA9IFtdO1xuXHRwcml2YXRlIF9yb3V0ZXNfZmxhdHRlbmVkOiB0UGFnZVJvdXRlRnVsbFtdICAgICAgID0gW107XG5cdHByaXZhdGUgX2FjdGl2ZV9yb3V0ZT86IHRQYWdlUm91dGVGdWxsO1xuXG5cdGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgYXBwX2NvbnRleHQ6IE9XZWJBcHApIHtcblx0XHRzdXBlcigpO1xuXHRcdGNvbnNvbGUubG9nKFwiW09XZWJQYWdlcl0gcmVhZHkhXCIpO1xuXHR9XG5cblx0Z2V0Um91dGVzKCk6IHRQYWdlUm91dGVbXSB7XG5cdFx0cmV0dXJuIHRoaXMuX3JvdXRlc19jYWNoZTtcblx0fVxuXG5cdGdldFBhZ2UobmFtZTogc3RyaW5nKTogaVBhZ2Uge1xuXHRcdGxldCBwYWdlOiBpUGFnZSA9IHRoaXMuX3BhZ2VzW25hbWVdO1xuXHRcdGlmICh1bmRlZmluZWQgPT09IHBhZ2UpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihgW09XZWJQYWdlcl0gdGhlIHBhZ2UgXCIke25hbWV9XCIgaXMgbm90IGRlZmluZWQuYCk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHBhZ2U7XG5cdH1cblxuXHRnZXRBY3RpdmVQYWdlKCk6IGlQYWdlIHtcblx0XHRpZiAoIXRoaXMuX2FjdGl2ZV9wYWdlKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoXCJbT1dlYlBhZ2VyXSBubyBhY3RpdmUgcGFnZS5cIik7XG5cdFx0fVxuXHRcdHJldHVybiB0aGlzLl9hY3RpdmVfcGFnZTtcblx0fVxuXG5cdGdldEFjdGl2ZVBhZ2VSb3V0ZSgpOiB0UGFnZVJvdXRlRnVsbCB7XG5cdFx0aWYgKCF0aGlzLl9hY3RpdmVfcm91dGUpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihcIltPV2ViUGFnZXJdIG5vIGFjdGl2ZSByb3V0ZS5cIik7XG5cdFx0fVxuXHRcdHJldHVybiB0aGlzLl9hY3RpdmVfcm91dGU7XG5cdH1cblxuXHRnZXRQYWdlTGlzdCgpIHtcblx0XHRyZXR1cm4gT2JqZWN0LmNyZWF0ZSh0aGlzLl9wYWdlcyk7XG5cdH1cblxuXHRyZWdpc3RlclBhZ2UocGFnZTogaVBhZ2UpOiB0aGlzIHtcblx0XHRsZXQgbmFtZSA9IHBhZ2UuZ2V0TmFtZSgpO1xuXG5cdFx0aWYgKG5hbWUgaW4gdGhpcy5fcGFnZXMpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihgW09XZWJQYWdlcl0gcGFnZSBcIiR7bmFtZX1cIiBhbHJlYWR5IHJlZ2lzdGVyZWQuYCk7XG5cdFx0fVxuXG5cdFx0dGhpcy5fcGFnZXNbbmFtZV0gPSBwYWdlLmluc3RhbGwodGhpcyk7XG5cdFx0bGV0IHJvdXRlcyAgICAgICAgPSBwYWdlLmdldFJvdXRlcygpO1xuXG5cdFx0dGhpcy5fcm91dGVzX2NhY2hlLnB1c2goLi4ucm91dGVzKTtcblxuXHRcdHJldHVybiB0aGlzLl9yZWdpc3RlclBhZ2VSb3V0ZXMocGFnZSwgcm91dGVzKTtcblx0fVxuXG5cdHByaXZhdGUgX3JlZ2lzdGVyUGFnZVJvdXRlcyhwYWdlOiBpUGFnZSwgcm91dGVzOiB0UGFnZVJvdXRlW10sIHBhcmVudD86IHRQYWdlUm91dGVGdWxsKTogdGhpcyB7XG5cblx0XHRsZXQgcm91dGVyOiBPV2ViUm91dGVyID0gdGhpcy5hcHBfY29udGV4dC5yb3V0ZXI7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHJvdXRlcy5sZW5ndGg7IGkrKykge1xuXHRcdFx0bGV0IHJvdXRlOiBhbnkgPSByb3V0ZXNbaV07XG5cblx0XHRcdHJvdXRlLmlkICAgICAgICAgICA9ICsrcm91dGVJZDtcblx0XHRcdHJvdXRlLnBhcmVudCAgICAgICA9IHBhcmVudDtcblx0XHRcdHJvdXRlLmhyZWYgICAgICAgICA9IHJvdXRlci5wYXRoVG9VUkwodHlwZW9mIHJvdXRlLnBhdGggPT09IFwic3RyaW5nXCIgPyByb3V0ZS5wYXRoIDogXCIvXCIpLmhyZWY7XG5cdFx0XHRyb3V0ZS5hY3RpdmUgICAgICAgPSBmYWxzZTtcblx0XHRcdHJvdXRlLmFjdGl2ZV9jaGlsZCA9IGZhbHNlO1xuXG5cdFx0XHRyb3V0ZS5zaG93ID0gcm91dGUuc2hvdyB8fCBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdHJldHVybiB0cnVlO1xuXHRcdFx0fTtcblxuXHRcdFx0dGhpcy5fcm91dGVzX2ZsYXR0ZW5lZC5wdXNoKHJvdXRlKTtcblxuXHRcdFx0dGhpcy5fYWRkUm91dGUocm91dGUsIHBhZ2UpO1xuXG5cdFx0XHRpZiAocm91dGUuc3ViICYmIHJvdXRlLnN1Yi5sZW5ndGgpIHtcblx0XHRcdFx0dGhpcy5fcmVnaXN0ZXJQYWdlUm91dGVzKHBhZ2UsIHJvdXRlLnN1Yiwgcm91dGUpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0cHJpdmF0ZSBfYWRkUm91dGUocm91dGU6IHRQYWdlUm91dGVGdWxsLCBwYWdlOiBpUGFnZSk6IHRoaXMge1xuXHRcdGxldCBjdHggPSB0aGlzO1xuXHRcdHRoaXMuYXBwX2NvbnRleHQucm91dGVyLm9uKHJvdXRlLnBhdGgsIHJvdXRlLnBhdGhPcHRpb25zLCAocm91dGVDb250ZXh0OiBPV2ViUm91dGVDb250ZXh0KSA9PiB7XG5cdFx0XHRjb25zb2xlLmxvZyhcIltPV2ViUGFnZXJdIHBhZ2Ugcm91dGUgbWF0Y2ggLT5cIiwgcm91dGUsIHBhZ2UsIHJvdXRlQ29udGV4dCk7XG5cblx0XHRcdGlmIChwYWdlLnJlcXVpcmVMb2dpbihyb3V0ZUNvbnRleHQsIHJvdXRlKSAmJiAhY3R4LmFwcF9jb250ZXh0LnVzZXJWZXJpZmllZCgpKSB7XG5cdFx0XHRcdHJldHVybiByb3V0ZUNvbnRleHQuc3RvcCgpICYmIGN0eC5hcHBfY29udGV4dC5zaG93TG9naW5QYWdlKCk7XG5cdFx0XHR9XG5cblx0XHRcdGxldCBhciA9IGN0eC5fYWN0aXZlX3JvdXRlLCBhcCA9IGN0eC5fYWN0aXZlX3BhZ2U7XG5cblx0XHRcdGFwICYmIGFyICYmIGFwLm9uQ2xvc2UoYXIsIHJvdXRlKTtcblxuXHRcdFx0cGFnZS5vbk9wZW4ocm91dGVDb250ZXh0LCByb3V0ZSk7XG5cblx0XHRcdCFyb3V0ZUNvbnRleHQuc3RvcHBlZCgpICYmIGN0eC5fc2V0QWN0aXZlUGFnZShwYWdlKS5fc2V0QWN0aXZlUm91dGUocm91dGUpO1xuXHRcdH0pO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRwcml2YXRlIF9zZXRBY3RpdmVSb3V0ZShyb3V0ZTogdFBhZ2VSb3V0ZUZ1bGwpOiB0aGlzIHtcblx0XHRsZXQgbGlzdCA9IHRoaXMuX3JvdXRlc19mbGF0dGVuZWQ7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHtcblx0XHRcdGxldCBjID0gbGlzdFtpXTtcblxuXHRcdFx0Yy5hY3RpdmUgICAgICAgPSByb3V0ZS5pZCA9PT0gYy5pZDtcblx0XHRcdGMuYWN0aXZlX2NoaWxkID0gIWMuYWN0aXZlICYmIF9pc1BhcmVudE9mKGMsIHJvdXRlKTtcblx0XHR9XG5cblx0XHR3RG9jLnRpdGxlID0gT1dlYkxhbmcudG9IdW1hbihyb3V0ZS50aXRsZS5sZW5ndGggPyByb3V0ZS50aXRsZSA6IHRoaXMuYXBwX2NvbnRleHQuZ2V0QXBwTmFtZSgpKTtcblxuXHRcdHRoaXMuX2FjdGl2ZV9yb3V0ZSA9IHJvdXRlO1xuXG5cdFx0Y29uc29sZS5sb2coYFtPV2ViUGFnZXJdIGFjdGl2ZSByb3V0ZSAtPmAsIHRoaXMuX2FjdGl2ZV9yb3V0ZSk7XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHByaXZhdGUgX3NldEFjdGl2ZVBhZ2UobmV3UGFnZTogaVBhZ2UpOiB0aGlzIHtcblx0XHRsZXQgb2xkUGFnZSA9IHRoaXMuX2FjdGl2ZV9wYWdlO1xuXG5cdFx0aWYgKG9sZFBhZ2UgIT09IG5ld1BhZ2UpIHtcblx0XHRcdGNvbnNvbGUubG9nKGBbT1dlYlBhZ2VyXSBwYWdlIGNoYW5naW5nIC0+YCwgbmV3UGFnZSwgb2xkUGFnZSk7XG5cdFx0XHR0aGlzLl9hY3RpdmVfcGFnZSA9IG5ld1BhZ2U7XG5cdFx0XHR0aGlzLnRyaWdnZXIoT1dlYlBhZ2VyLkVWVF9QQUdFX0NIQU5HRSwgW29sZFBhZ2UsIG5ld1BhZ2VdKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc29sZS5sb2coYFtPV2ViUGFnZXJdIHNhbWUgcGFnZSAtPmAsIG9sZFBhZ2UsIG5ld1BhZ2UpO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG59Il19