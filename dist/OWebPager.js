import OWebEvent from './OWebEvent';
import Utils from './utils/Utils';
const wDoc = window.document;
let routeId = 0, _isParentOf = (parent, route) => {
    let p;
    while ((p = route.parent)) {
        if (p === parent) {
            return true;
        }
        route = p;
    }
    return false;
};
export default class OWebPager extends OWebEvent {
    /**
     * @param app_context The app context.
     */
    constructor(app_context) {
        super();
        this.app_context = app_context;
        this._pages = {};
        this._routes_cache = [];
        this._routes_flattened = [];
        console.log('[OWebPager] ready!');
    }
    /**
     * Returns registered pages routes.
     */
    getRoutes() {
        return [...this._routes_cache];
    }
    /**
     * Returns the page with the given name.
     * @param name
     */
    getPage(name) {
        let page = this._pages[name];
        if (undefined === page) {
            throw new Error(`[OWebPager] the page "${name}" is not defined.`);
        }
        return page;
    }
    /**
     * Returns the active page.
     */
    getActivePage() {
        if (!this._active_page) {
            throw new Error('[OWebPager] no active page.');
        }
        return this._active_page;
    }
    /**
     * Returns the active page route.
     */
    getActivePageRoute() {
        if (!this._active_route) {
            throw new Error('[OWebPager] no active route.');
        }
        return this._active_route;
    }
    /**
     * Returns all pages list.
     */
    getPageList() {
        return { ...this._pages };
    }
    /**
     * Register a given page.
     *
     * @param page
     */
    registerPage(page) {
        let name = page.getName();
        if (name in this._pages) {
            throw new Error(`[OWebPager] page "${name}" already registered.`);
        }
        this._pages[name] = page.install(this);
        let routes = page.getRoutes();
        this._routes_cache.push(...routes);
        return this._registerPageRoutes(page, routes);
    }
    /**
     * Helpers to register page routes.
     *
     * @param page The page.
     * @param routes The page routes list.
     * @param parent The page routes parent.
     * @private
     */
    _registerPageRoutes(page, routes, parent) {
        let router = this.app_context.router;
        for (let i = 0; i < routes.length; i++) {
            let route = routes[i];
            route.id = ++routeId;
            route.parent = parent;
            route.href = router.pathToURL(typeof route.path === 'string' ? route.path : '/').href;
            route.active = false;
            route.activeChild = false;
            route.show =
                route.show ||
                    function () {
                        return true;
                    };
            this._routes_flattened.push(route);
            this._addRoute(route, page);
            if (route.sub && route.sub.length) {
                this._registerPageRoutes(page, route.sub, route);
            }
        }
        return this;
    }
    /**
     * Helper to add route.
     *
     * @param route The route object.
     * @param page The page to which that route belongs to.
     * @private
     */
    _addRoute(route, page) {
        let ctx = this;
        this.app_context.router.on(route.path, route.pathOptions, (routeContext) => {
            console.log('[OWebPager] page route match ->', route, page, routeContext);
            if (page.requireLogin(routeContext, route) &&
                !ctx.app_context.userVerified()) {
                return (routeContext.stop() &&
                    ctx.app_context.showLoginPage({
                        next: routeContext.getPath(),
                    }));
            }
            let ar = ctx._active_route, ap = ctx._active_page;
            ap && ar && ap.onClose(ar, route);
            page.onOpen(routeContext, route);
            !routeContext.stopped() && ctx._setActive(page, route);
        });
        return this;
    }
    /**
     * Helper to set the active route.
     *
     * @param page
     * @param route
     * @private
     */
    _setActive(page, route) {
        let oldPage = this._active_page, oldRoute = this._active_route, app = this.app_context;
        for (let i = 0; i < this._routes_flattened.length; i++) {
            let c = this._routes_flattened[i];
            c.active = route.id === c.id;
            c.activeChild = !c.active && _isParentOf(c, route);
        }
        this._active_page = page;
        this._active_route = route;
        wDoc.title = app.i18n.toHuman(route.title ? route.title : app.getAppName());
        let info = {
            page,
            oldPage,
            route,
            oldRoute,
            samePage: oldPage === page,
        };
        console.log('[OWebPager] info', info);
        this.trigger(OWebPager.EVT_PAGE_LOCATION_CHANGE, [route, page]);
        return this;
    }
    onLocationChange(handler) {
        return this.on(OWebPager.EVT_PAGE_LOCATION_CHANGE, handler);
    }
}
OWebPager.SELF = Utils.id();
OWebPager.EVT_PAGE_LOCATION_CHANGE = Utils.id();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlBhZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL09XZWJQYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLFNBQVMsTUFBTSxhQUFhLENBQUM7QUFNcEMsT0FBTyxLQUFLLE1BQU0sZUFBZSxDQUFDO0FBbUZsQyxNQUFNLElBQUksR0FBUSxNQUFNLENBQUMsUUFBUSxDQUFDO0FBQ2xDLElBQUksT0FBTyxHQUFPLENBQUMsRUFDbEIsV0FBVyxHQUFHLENBQUMsTUFBc0IsRUFBRSxLQUFxQixFQUFXLEVBQUU7SUFDeEUsSUFBSSxDQUFDLENBQUM7SUFDTixPQUFPLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFPLENBQUMsRUFBRTtRQUMzQixJQUFJLENBQUMsS0FBSyxNQUFNLEVBQUU7WUFDakIsT0FBTyxJQUFJLENBQUM7U0FDWjtRQUVELEtBQUssR0FBRyxDQUFDLENBQUM7S0FDVjtJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2QsQ0FBQyxDQUFDO0FBRUgsTUFBTSxDQUFDLE9BQU8sT0FBTyxTQUFxQixTQUFRLFNBQVM7SUFVMUQ7O09BRUc7SUFDSCxZQUE2QixXQUFvQjtRQUNoRCxLQUFLLEVBQUUsQ0FBQztRQURvQixnQkFBVyxHQUFYLFdBQVcsQ0FBUztRQVRoQyxXQUFNLEdBQXdDLEVBQUUsQ0FBQztRQUMxRCxrQkFBYSxHQUEwQyxFQUFFLENBQUM7UUFDMUQsc0JBQWlCLEdBQXNDLEVBQUUsQ0FBQztRQVNqRSxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsU0FBUztRQUNSLE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsT0FBTyxDQUFDLElBQVk7UUFDbkIsSUFBSSxJQUFJLEdBQXFCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7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LENBQ2YsT0FBZ0U7UUFFaEUsT0FBTyxJQUFJLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyx3QkFBd0IsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUM3RCxDQUFDOztBQTFOZSxjQUFJLEdBQXVCLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUN0QyxrQ0FBd0IsR0FBRyxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT1dlYkFwcCBmcm9tICcuL09XZWJBcHAnO1xuaW1wb3J0IE9XZWJFdmVudCBmcm9tICcuL09XZWJFdmVudCc7XG5pbXBvcnQgT1dlYlJvdXRlciwge1xuXHRPV2ViUm91dGVDb250ZXh0LFxuXHR0Um91dGVQYXRoLFxuXHR0Um91dGVQYXRoT3B0aW9ucyxcbn0gZnJvbSAnLi9PV2ViUm91dGVyJztcbmltcG9ydCBVdGlscyBmcm9tICcuL3V0aWxzL1V0aWxzJztcbmltcG9ydCB7dEkxOG59IGZyb20gXCIuL293ZWJcIjtcblxuZXhwb3J0IGludGVyZmFjZSBpUGFnZVJvdXRlIHtcblx0c2x1Zz86IHN0cmluZztcblx0dGl0bGU6IHRJMThuO1xuXHRkZXNjcmlwdGlvbj86IHRJMThuO1xuXHRwYXRoOiB0Um91dGVQYXRoO1xuXHRwYXRoT3B0aW9ucz86IHRSb3V0ZVBhdGhPcHRpb25zO1xuXHRzdWI/OiBpUGFnZVJvdXRlW107XG5cdHNob3dTdWI/OiBib29sZWFuO1xuXHRkaXNhYmxlZD86IGJvb2xlYW47XG5cblx0c2hvdz8oKTogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBpUGFnZVJvdXRlRnVsbCB7XG5cdHNsdWc/OiBzdHJpbmc7XG5cdHRpdGxlOiB0STE4bjtcblx0ZGVzY3JpcHRpb24/OiB0STE4bjtcblx0cGF0aDogdFJvdXRlUGF0aDtcblx0cGF0aE9wdGlvbnM/OiB0Um91dGVQYXRoT3B0aW9ucztcblx0c3ViPzogaVBhZ2VSb3V0ZUZ1bGxbXTtcblx0c2hvd1N1Yj86IGJvb2xlYW47XG5cdGRpc2FibGVkPzogYm9vbGVhbjtcblxuXHRzaG93KCk6IGJvb2xlYW47XG5cblx0cmVhZG9ubHkgaWQ6IG51bWJlcjtcblx0cmVhZG9ubHkgaHJlZjogc3RyaW5nO1xuXHRyZWFkb25seSBwYXJlbnQ/OiBpUGFnZVJvdXRlRnVsbDtcblx0YWN0aXZlOiBib29sZWFuO1xuXHRhY3RpdmVDaGlsZDogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBpUGFnZTxDb21wb25lbnQ+IHtcblx0LyoqXG5cdCAqIFRoZSBwYWdlIG5hbWUgZ2V0dGVyLlxuXHQgKi9cblx0Z2V0TmFtZSgpOiBzdHJpbmc7XG5cblx0LyoqXG5cdCAqIFRoZSBwYWdlIHJvdXRlcyBnZXR0ZXIuXG5cdCAqL1xuXHRnZXRSb3V0ZXMoKTogaVBhZ2VSb3V0ZVtdO1xuXG5cdC8qKlxuXHQgKiBUaGUgcGFnZSBjb21wb25lbnQgZ2V0dGVyLlxuXHQgKi9cblx0Z2V0Q29tcG9uZW50KCk6IENvbXBvbmVudDtcblxuXHQvKipcblx0ICogQ2FsbGVkIG9uY2Ugd2hlbiByZWdpc3RlcmluZyB0aGUgcGFnZS5cblx0ICpcblx0ICogQHBhcmFtIHBhZ2VyXG5cdCAqL1xuXHRpbnN0YWxsKHBhZ2VyOiBPV2ViUGFnZXI8Q29tcG9uZW50Pik6IHRoaXM7XG5cblx0LyoqXG5cdCAqIERvZXMgdGhpcyBwYWdlIHJlcXVpcmUgYSB2ZXJpZmllZCB1c2VyIGZvciB0aGUgcmVxdWVzdGVkIHBhZ2Ugcm91dGUuXG5cdCAqXG5cdCAqIEBwYXJhbSBjb250ZXh0IFRoZSBhcHAgY29udGV4dC5cblx0ICogQHBhcmFtIHJvdXRlIFRoZSByZXF1ZXN0IHBhZ2Ugcm91dGUuXG5cdCAqL1xuXHRyZXF1aXJlTG9naW4oY29udGV4dDogT1dlYlJvdXRlQ29udGV4dCwgcm91dGU6IGlQYWdlUm91dGVGdWxsKTogYm9vbGVhbjtcblxuXHQvKipcblx0ICogQ2FsbGVkIGJlZm9yZSBwYWdlIG9wZW4uXG5cdCAqXG5cdCAqIEBwYXJhbSBjb250ZXh0XG5cdCAqIEBwYXJhbSByb3V0ZVxuXHQgKi9cblx0b25PcGVuKGNvbnRleHQ6IE9XZWJSb3V0ZUNvbnRleHQsIHJvdXRlOiBpUGFnZVJvdXRlRnVsbCk6IHZvaWQ7XG5cblx0LyoqXG5cdCAqIENhbGxlZCBiZWZvcmUgcGFnZSBjbG9zZS5cblx0ICpcblx0ICogQHBhcmFtIG9sZFJvdXRlXG5cdCAqIEBwYXJhbSBuZXdSb3V0ZVxuXHQgKi9cblx0b25DbG9zZShvbGRSb3V0ZTogaVBhZ2VSb3V0ZUZ1bGwsIG5ld1JvdXRlOiBpUGFnZVJvdXRlRnVsbCk6IHZvaWQ7XG59XG5cbmNvbnN0IHdEb2MgICAgICA9IHdpbmRvdy5kb2N1bWVudDtcbmxldCByb3V0ZUlkICAgICA9IDAsXG5cdF9pc1BhcmVudE9mID0gKHBhcmVudDogaVBhZ2VSb3V0ZUZ1bGwsIHJvdXRlOiBpUGFnZVJvdXRlRnVsbCk6IGJvb2xlYW4gPT4ge1xuXHRcdGxldCBwO1xuXHRcdHdoaWxlICgocCA9IHJvdXRlLnBhcmVudCEpKSB7XG5cdFx0XHRpZiAocCA9PT0gcGFyZW50KSB7XG5cdFx0XHRcdHJldHVybiB0cnVlO1xuXHRcdFx0fVxuXG5cdFx0XHRyb3V0ZSA9IHA7XG5cdFx0fVxuXHRcdHJldHVybiBmYWxzZTtcblx0fTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT1dlYlBhZ2VyPENvbXBvbmVudD4gZXh0ZW5kcyBPV2ViRXZlbnQge1xuXHRzdGF0aWMgcmVhZG9ubHkgU0VMRiAgICAgICAgICAgICAgICAgICAgID0gVXRpbHMuaWQoKTtcblx0c3RhdGljIHJlYWRvbmx5IEVWVF9QQUdFX0xPQ0FUSU9OX0NIQU5HRSA9IFV0aWxzLmlkKCk7XG5cblx0cHJpdmF0ZSByZWFkb25seSBfcGFnZXM6IHsgW2tleTogc3RyaW5nXTogaVBhZ2U8Q29tcG9uZW50PiB9ID0ge307XG5cdHByaXZhdGUgX3JvdXRlc19jYWNoZTogaVBhZ2VSb3V0ZVtdICAgICAgICAgICAgICAgICAgICAgICAgICA9IFtdO1xuXHRwcml2YXRlIF9yb3V0ZXNfZmxhdHRlbmVkOiBpUGFnZVJvdXRlRnVsbFtdICAgICAgICAgICAgICAgICAgPSBbXTtcblx0cHJpdmF0ZSBfYWN0aXZlX3BhZ2U6IGlQYWdlPENvbXBvbmVudD4gfCB1bmRlZmluZWQ7XG5cdHByaXZhdGUgX2FjdGl2ZV9yb3V0ZT86IGlQYWdlUm91dGVGdWxsO1xuXG5cdC8qKlxuXHQgKiBAcGFyYW0gYXBwX2NvbnRleHQgVGhlIGFwcCBjb250ZXh0LlxuXHQgKi9cblx0Y29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhcHBfY29udGV4dDogT1dlYkFwcCkge1xuXHRcdHN1cGVyKCk7XG5cdFx0Y29uc29sZS5sb2coJ1tPV2ViUGFnZXJdIHJlYWR5IScpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgcmVnaXN0ZXJlZCBwYWdlcyByb3V0ZXMuXG5cdCAqL1xuXHRnZXRSb3V0ZXMoKTogaVBhZ2VSb3V0ZVtdIHtcblx0XHRyZXR1cm4gWy4uLnRoaXMuX3JvdXRlc19jYWNoZV07XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgcGFnZSB3aXRoIHRoZSBnaXZlbiBuYW1lLlxuXHQgKiBAcGFyYW0gbmFtZVxuXHQgKi9cblx0Z2V0UGFnZShuYW1lOiBzdHJpbmcpOiBpUGFnZTxDb21wb25lbnQ+IHtcblx0XHRsZXQgcGFnZTogaVBhZ2U8Q29tcG9uZW50PiA9IHRoaXMuX3BhZ2VzW25hbWVdO1xuXHRcdGlmICh1bmRlZmluZWQgPT09IHBhZ2UpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihgW09XZWJQYWdlcl0gdGhlIHBhZ2UgXCIke25hbWV9XCIgaXMgbm90IGRlZmluZWQuYCk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHBhZ2U7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgYWN0aXZlIHBhZ2UuXG5cdCAqL1xuXHRnZXRBY3RpdmVQYWdlKCk6IGlQYWdlPENvbXBvbmVudD4ge1xuXHRcdGlmICghdGhpcy5fYWN0aXZlX3BhZ2UpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcignW09XZWJQYWdlcl0gbm8gYWN0aXZlIHBhZ2UuJyk7XG5cdFx0fVxuXHRcdHJldHVybiB0aGlzLl9hY3RpdmVfcGFnZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHRoZSBhY3RpdmUgcGFnZSByb3V0ZS5cblx0ICovXG5cdGdldEFjdGl2ZVBhZ2VSb3V0ZSgpOiBpUGFnZVJvdXRlRnVsbCB7XG5cdFx0aWYgKCF0aGlzLl9hY3RpdmVfcm91dGUpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcignW09XZWJQYWdlcl0gbm8gYWN0aXZlIHJvdXRlLicpO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcy5fYWN0aXZlX3JvdXRlO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgYWxsIHBhZ2VzIGxpc3QuXG5cdCAqL1xuXHRnZXRQYWdlTGlzdCgpIHtcblx0XHRyZXR1cm4gey4uLnRoaXMuX3BhZ2VzfTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZWdpc3RlciBhIGdpdmVuIHBhZ2UuXG5cdCAqXG5cdCAqIEBwYXJhbSBwYWdlXG5cdCAqL1xuXHRyZWdpc3RlclBhZ2UocGFnZTogaVBhZ2U8Q29tcG9uZW50Pik6IHRoaXMge1xuXHRcdGxldCBuYW1lID0gcGFnZS5nZXROYW1lKCk7XG5cblx0XHRpZiAobmFtZSBpbiB0aGlzLl9wYWdlcykge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBbT1dlYlBhZ2VyXSBwYWdlIFwiJHtuYW1lfVwiIGFscmVhZHkgcmVnaXN0ZXJlZC5gKTtcblx0XHR9XG5cblx0XHR0aGlzLl9wYWdlc1tuYW1lXSA9IHBhZ2UuaW5zdGFsbCh0aGlzKTtcblx0XHRsZXQgcm91dGVzICAgICAgICA9IHBhZ2UuZ2V0Um91dGVzKCk7XG5cblx0XHR0aGlzLl9yb3V0ZXNfY2FjaGUucHVzaCguLi5yb3V0ZXMpO1xuXG5cdFx0cmV0dXJuIHRoaXMuX3JlZ2lzdGVyUGFnZVJvdXRlcyhwYWdlLCByb3V0ZXMpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEhlbHBlcnMgdG8gcmVnaXN0ZXIgcGFnZSByb3V0ZXMuXG5cdCAqXG5cdCAqIEBwYXJhbSBwYWdlIFRoZSBwYWdlLlxuXHQgKiBAcGFyYW0gcm91dGVzIFRoZSBwYWdlIHJvdXRlcyBsaXN0LlxuXHQgKiBAcGFyYW0gcGFyZW50IFRoZSBwYWdlIHJvdXRlcyBwYXJlbnQuXG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIF9yZWdpc3RlclBhZ2VSb3V0ZXMoXG5cdFx0cGFnZTogaVBhZ2U8Q29tcG9uZW50Pixcblx0XHRyb3V0ZXM6IGlQYWdlUm91dGVbXSxcblx0XHRwYXJlbnQ/OiBpUGFnZVJvdXRlRnVsbFxuXHQpOiB0aGlzIHtcblx0XHRsZXQgcm91dGVyOiBPV2ViUm91dGVyID0gdGhpcy5hcHBfY29udGV4dC5yb3V0ZXI7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHJvdXRlcy5sZW5ndGg7IGkrKykge1xuXHRcdFx0bGV0IHJvdXRlOiBhbnkgPSByb3V0ZXNbaV07XG5cblx0XHRcdHJvdXRlLmlkICAgICAgICAgID0gKytyb3V0ZUlkO1xuXHRcdFx0cm91dGUucGFyZW50ICAgICAgPSBwYXJlbnQ7XG5cdFx0XHRyb3V0ZS5ocmVmICAgICAgICA9IHJvdXRlci5wYXRoVG9VUkwoXG5cdFx0XHRcdHR5cGVvZiByb3V0ZS5wYXRoID09PSAnc3RyaW5nJyA/IHJvdXRlLnBhdGggOiAnLydcblx0XHRcdCkuaHJlZjtcblx0XHRcdHJvdXRlLmFjdGl2ZSAgICAgID0gZmFsc2U7XG5cdFx0XHRyb3V0ZS5hY3RpdmVDaGlsZCA9IGZhbHNlO1xuXG5cdFx0XHRyb3V0ZS5zaG93ID1cblx0XHRcdFx0cm91dGUuc2hvdyB8fFxuXHRcdFx0XHRmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0XHRcdH07XG5cblx0XHRcdHRoaXMuX3JvdXRlc19mbGF0dGVuZWQucHVzaChyb3V0ZSk7XG5cblx0XHRcdHRoaXMuX2FkZFJvdXRlKHJvdXRlLCBwYWdlKTtcblxuXHRcdFx0aWYgKHJvdXRlLnN1YiAmJiByb3V0ZS5zdWIubGVuZ3RoKSB7XG5cdFx0XHRcdHRoaXMuX3JlZ2lzdGVyUGFnZVJvdXRlcyhwYWdlLCByb3V0ZS5zdWIsIHJvdXRlKTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdC8qKlxuXHQgKiBIZWxwZXIgdG8gYWRkIHJvdXRlLlxuXHQgKlxuXHQgKiBAcGFyYW0gcm91dGUgVGhlIHJvdXRlIG9iamVjdC5cblx0ICogQHBhcmFtIHBhZ2UgVGhlIHBhZ2UgdG8gd2hpY2ggdGhhdCByb3V0ZSBiZWxvbmdzIHRvLlxuXHQgKiBAcHJpdmF0ZVxuXHQgKi9cblx0cHJpdmF0ZSBfYWRkUm91dGUocm91dGU6IGlQYWdlUm91dGVGdWxsLCBwYWdlOiBpUGFnZTxDb21wb25lbnQ+KTogdGhpcyB7XG5cdFx0bGV0IGN0eCA9IHRoaXM7XG5cdFx0dGhpcy5hcHBfY29udGV4dC5yb3V0ZXIub24oXG5cdFx0XHRyb3V0ZS5wYXRoLFxuXHRcdFx0cm91dGUucGF0aE9wdGlvbnMsXG5cdFx0XHQocm91dGVDb250ZXh0OiBPV2ViUm91dGVDb250ZXh0KSA9PiB7XG5cdFx0XHRcdGNvbnNvbGUubG9nKFxuXHRcdFx0XHRcdCdbT1dlYlBhZ2VyXSBwYWdlIHJvdXRlIG1hdGNoIC0+Jyxcblx0XHRcdFx0XHRyb3V0ZSxcblx0XHRcdFx0XHRwYWdlLFxuXHRcdFx0XHRcdHJvdXRlQ29udGV4dFxuXHRcdFx0XHQpO1xuXG5cdFx0XHRcdGlmIChcblx0XHRcdFx0XHRwYWdlLnJlcXVpcmVMb2dpbihyb3V0ZUNvbnRleHQsIHJvdXRlKSAmJlxuXHRcdFx0XHRcdCFjdHguYXBwX2NvbnRleHQudXNlclZlcmlmaWVkKClcblx0XHRcdFx0KSB7XG5cdFx0XHRcdFx0cmV0dXJuIChcblx0XHRcdFx0XHRcdHJvdXRlQ29udGV4dC5zdG9wKCkgJiZcblx0XHRcdFx0XHRcdGN0eC5hcHBfY29udGV4dC5zaG93TG9naW5QYWdlKHtcblx0XHRcdFx0XHRcdFx0bmV4dDogcm91dGVDb250ZXh0LmdldFBhdGgoKSxcblx0XHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGxldCBhciA9IGN0eC5fYWN0aXZlX3JvdXRlLFxuXHRcdFx0XHRcdGFwID0gY3R4Ll9hY3RpdmVfcGFnZTtcblxuXHRcdFx0XHRhcCAmJiBhciAmJiBhcC5vbkNsb3NlKGFyLCByb3V0ZSk7XG5cblx0XHRcdFx0cGFnZS5vbk9wZW4ocm91dGVDb250ZXh0LCByb3V0ZSk7XG5cblx0XHRcdFx0IXJvdXRlQ29udGV4dC5zdG9wcGVkKCkgJiYgY3R4Ll9zZXRBY3RpdmUocGFnZSwgcm91dGUpO1xuXHRcdFx0fVxuXHRcdCk7XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdC8qKlxuXHQgKiBIZWxwZXIgdG8gc2V0IHRoZSBhY3RpdmUgcm91dGUuXG5cdCAqXG5cdCAqIEBwYXJhbSBwYWdlXG5cdCAqIEBwYXJhbSByb3V0ZVxuXHQgKiBAcHJpdmF0ZVxuXHQgKi9cblx0cHJpdmF0ZSBfc2V0QWN0aXZlKHBhZ2U6IGlQYWdlPENvbXBvbmVudD4sIHJvdXRlOiBpUGFnZVJvdXRlRnVsbCk6IHRoaXMge1xuXHRcdGxldCBvbGRQYWdlICA9IHRoaXMuX2FjdGl2ZV9wYWdlLFxuXHRcdFx0b2xkUm91dGUgPSB0aGlzLl9hY3RpdmVfcm91dGUsXG5cdFx0XHRhcHAgICAgICA9IHRoaXMuYXBwX2NvbnRleHQ7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX3JvdXRlc19mbGF0dGVuZWQubGVuZ3RoOyBpKyspIHtcblx0XHRcdGxldCBjID0gdGhpcy5fcm91dGVzX2ZsYXR0ZW5lZFtpXTtcblxuXHRcdFx0Yy5hY3RpdmUgICAgICA9IHJvdXRlLmlkID09PSBjLmlkO1xuXHRcdFx0Yy5hY3RpdmVDaGlsZCA9ICFjLmFjdGl2ZSAmJiBfaXNQYXJlbnRPZihjLCByb3V0ZSk7XG5cdFx0fVxuXG5cdFx0dGhpcy5fYWN0aXZlX3BhZ2UgID0gcGFnZTtcblx0XHR0aGlzLl9hY3RpdmVfcm91dGUgPSByb3V0ZTtcblx0XHR3RG9jLnRpdGxlICAgICAgICAgPSBhcHAuaTE4bi50b0h1bWFuKFxuXHRcdFx0cm91dGUudGl0bGUgPyByb3V0ZS50aXRsZSA6IGFwcC5nZXRBcHBOYW1lKClcblx0XHQpO1xuXG5cdFx0bGV0IGluZm86IGFueSA9IHtcblx0XHRcdHBhZ2UsXG5cdFx0XHRvbGRQYWdlLFxuXHRcdFx0cm91dGUsXG5cdFx0XHRvbGRSb3V0ZSxcblx0XHRcdHNhbWVQYWdlOiBvbGRQYWdlID09PSBwYWdlLFxuXHRcdH07XG5cblx0XHRjb25zb2xlLmxvZygnW09XZWJQYWdlcl0gaW5mbycsIGluZm8pO1xuXG5cdFx0dGhpcy50cmlnZ2VyKE9XZWJQYWdlci5FVlRfUEFHRV9MT0NBVElPTl9DSEFOR0UsIFtyb3V0ZSwgcGFnZV0pO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRvbkxvY2F0aW9uQ2hhbmdlKFxuXHRcdGhhbmRsZXI6IChyb3V0ZTogaVBhZ2VSb3V0ZUZ1bGwsIHBhZ2U6IGlQYWdlPENvbXBvbmVudD4pID0+IHZvaWRcblx0KSB7XG5cdFx0cmV0dXJuIHRoaXMub24oT1dlYlBhZ2VyLkVWVF9QQUdFX0xPQ0FUSU9OX0NIQU5HRSwgaGFuZGxlcik7XG5cdH1cbn1cbiJdfQ==