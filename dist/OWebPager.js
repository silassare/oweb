import OWebEvent from "./OWebEvent";
import Utils from "./utils/Utils";
const wDoc = window.document;
let routeId = 0, _isParentOf = (parent, route) => {
    let p;
    while ((p = route.parent)) {
        if (p === parent) {
            return true;
        }
        route = p;
    }
    return false;
};
export default class OWebPager extends OWebEvent {
    /**
     * @param app_context The app context.
     */
    constructor(app_context) {
        super();
        this.app_context = app_context;
        this._pages = {};
        this._routes_cache = [];
        this._routes_flattened = [];
        console.log("[OWebPager] ready!");
    }
    /**
     * Returns registered pages routes.
     */
    getRoutes() {
        return this._routes_cache;
    }
    /**
     * Returns the page with the given name.
     * @param name
     */
    getPage(name) {
        let page = this._pages[name];
        if (undefined === page) {
            throw new Error(`[OWebPager] the page "${name}" is not defined.`);
        }
        return page;
    }
    /**
     * Returns the active page.
     */
    getActivePage() {
        if (!this._active_page) {
            throw new Error("[OWebPager] no active page.");
        }
        return this._active_page;
    }
    /**
     * Returns the active page route.
     */
    getActivePageRoute() {
        if (!this._active_route) {
            throw new Error("[OWebPager] no active route.");
        }
        return this._active_route;
    }
    /**
     * Returns all pages list.
     */
    getPageList() {
        return Object.create(this._pages);
    }
    /**
     * Register a given page.
     *
     * @param page
     */
    registerPage(page) {
        let name = page.getName();
        if (name in this._pages) {
            throw new Error(`[OWebPager] page "${name}" already registered.`);
        }
        this._pages[name] = page.install(this);
        let routes = page.getRoutes();
        this._routes_cache.push(...routes);
        return this._registerPageRoutes(page, routes);
    }
    /**
     * Helpers to register page routes.
     *
     * @param page The page.
     * @param routes The page routes list.
     * @param parent The page routes parent.
     * @private
     */
    _registerPageRoutes(page, routes, parent) {
        let router = this.app_context.router;
        for (let i = 0; i < routes.length; i++) {
            let route = routes[i];
            route.id = ++routeId;
            route.parent = parent;
            route.href = router.pathToURL(typeof route.path === "string" ? route.path : "/").href;
            route.active = false;
            route.activeChild = false;
            route.show = route.show || function () {
                return true;
            };
            this._routes_flattened.push(route);
            this._addRoute(route, page);
            if (route.sub && route.sub.length) {
                this._registerPageRoutes(page, route.sub, route);
            }
        }
        return this;
    }
    /**
     * Helper to add route.
     *
     * @param route The route object.
     * @param page The page to which that route belongs to.
     * @private
     */
    _addRoute(route, page) {
        let ctx = this;
        this.app_context.router.on(route.path, route.pathOptions, (routeContext) => {
            console.log("[OWebPager] page route match ->", route, page, routeContext);
            if (page.requireLogin(routeContext, route) && !ctx.app_context.userVerified()) {
                return routeContext.stop() && ctx.app_context.showLoginPage();
            }
            let ar = ctx._active_route, ap = ctx._active_page;
            ap && ar && ap.onClose(ar, route);
            page.onOpen(routeContext, route);
            !routeContext.stopped() && ctx._setActive(page, route);
        });
        return this;
    }
    /**
     * Helper to set the active route.
     *
     * @param page
     * @param route
     * @private
     */
    _setActive(page, route) {
        let oldPage = this._active_page, oldRoute = this._active_route, app = this.app_context;
        for (let i = 0; i < this._routes_flattened.length; i++) {
            let c = this._routes_flattened[i];
            c.active = route.id === c.id;
            c.activeChild = !c.active && _isParentOf(c, route);
        }
        this._active_page = page;
        this._active_route = route;
        wDoc.title = app.i18n.toHuman(route.title.length ? route.title : app.getAppName());
        let info = {
            page,
            oldPage,
            route,
            oldRoute,
            samePage: oldPage === page
        };
        console.log('[OWebPager] info', info);
        return this.trigger(OWebPager.EVT_PAGE_LOCATION_CHANGE, [route, page]);
    }
    onLocationChange(handler) {
        return this.on(OWebPager.EVT_PAGE_LOCATION_CHANGE, handler);
    }
}
OWebPager.SELF = Utils.id();
OWebPager.EVT_PAGE_LOCATION_CHANGE = Utils.id();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlBhZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL09XZWJQYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLFNBQVMsTUFBTSxhQUFhLENBQUM7QUFFcEMsT0FBTyxLQUFLLE1BQU0sZUFBZSxDQUFDO0FBc0VsQyxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDO0FBQzdCLElBQUksT0FBTyxHQUFHLENBQUMsRUFDZCxXQUFXLEdBQUcsQ0FBQyxNQUFzQixFQUFFLEtBQXFCLEVBQVcsRUFBRTtJQUN4RSxJQUFJLENBQUMsQ0FBQztJQUNOLE9BQU8sQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU8sQ0FBQyxFQUFFO1FBQzNCLElBQUksQ0FBQyxLQUFLLE1BQU0sRUFBRTtZQUNqQixPQUFPLElBQUksQ0FBQztTQUNaO1FBRUQsS0FBSyxHQUFHLENBQUMsQ0FBQztLQUNWO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDZCxDQUFDLENBQUM7QUFFSCxNQUFNLENBQUMsT0FBTyxnQkFBNEIsU0FBUSxTQUFTO0lBVTFEOztPQUVHO0lBQ0gsWUFBNkIsV0FBb0I7UUFDaEQsS0FBSyxFQUFFLENBQUM7UUFEb0IsZ0JBQVcsR0FBWCxXQUFXLENBQVM7UUFUaEMsV0FBTSxHQUEwQyxFQUFFLENBQUM7UUFDNUQsa0JBQWEsR0FBaUIsRUFBRSxDQUFDO1FBQ2pDLHNCQUFpQixHQUFxQixFQUFFLENBQUM7UUFTaEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFRDs7T0FFRztJQUNILFNBQVM7UUFDUixPQUFPLElBQUksQ0FBQyxhQUFhLENBQUM7SUFDM0IsQ0FBQztJQUVEOzs7T0FHRztJQUNILE9BQU8sQ0FBQyxJQUFZO1FBQ25CLElBQUksSUFBSSxHQUFxQixJQUFJLENBQUMsTUFBTSxDQUFFLElBQUksQ0FBRSxDQUFDO1FBQ2pELElBQUksU0FBUyxLQUFL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QUFDOztBQTNMZSxjQUFJLEdBQUcsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQ2xCLGtDQUF3QixHQUFHLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBPV2ViQXBwIGZyb20gXCIuL09XZWJBcHBcIjtcbmltcG9ydCBPV2ViRXZlbnQgZnJvbSBcIi4vT1dlYkV2ZW50XCI7XG5pbXBvcnQgT1dlYlJvdXRlciwgeyBPV2ViUm91dGVDb250ZXh0LCB0Um91dGVQYXRoLCB0Um91dGVQYXRoT3B0aW9ucyB9IGZyb20gXCIuL09XZWJSb3V0ZXJcIjtcbmltcG9ydCBVdGlscyBmcm9tIFwiLi91dGlscy9VdGlsc1wiO1xuXG5leHBvcnQgdHlwZSB0UGFnZVJvdXRlID0ge1xuXHRzbHVnPzogc3RyaW5nLFxuXHR0aXRsZTogc3RyaW5nLFxuXHRkZXNjcmlwdGlvbj86IHN0cmluZyxcblx0aWNvbj86IHN0cmluZyxcblx0cGF0aDogdFJvdXRlUGF0aCxcblx0cGF0aE9wdGlvbnM/OiB0Um91dGVQYXRoT3B0aW9ucyxcblx0c3ViPzogdFBhZ2VSb3V0ZVtdLFxuXHRzaG93PygpOiBib29sZWFuXG59O1xuXG5leHBvcnQgdHlwZSB0UGFnZVJvdXRlRnVsbCA9IHRQYWdlUm91dGUgJiB7XG5cdHJlYWRvbmx5IGlkOiBudW1iZXIsXG5cdHJlYWRvbmx5IGhyZWY6IHN0cmluZyxcblx0cmVhZG9ubHkgcGFyZW50PzogdFBhZ2VSb3V0ZUZ1bGwsXG5cdGFjdGl2ZTogYm9vbGVhbixcblx0YWN0aXZlQ2hpbGQ6IGJvb2xlYW4sXG5cdHNob3coKTogYm9vbGVhblxufTtcblxuZXhwb3J0IGludGVyZmFjZSBpUGFnZTxDb21wb25lbnQ+IHtcblx0LyoqXG5cdCAqIFRoZSBwYWdlIG5hbWUgZ2V0dGVyLlxuXHQgKi9cblx0Z2V0TmFtZSgpOiBzdHJpbmc7XG5cblx0LyoqXG5cdCAqIFRoZSBwYWdlIHJvdXRlcyBnZXR0ZXIuXG5cdCAqL1xuXHRnZXRSb3V0ZXMoKTogdFBhZ2VSb3V0ZVtdO1xuXG5cdC8qKlxuXHQgKiBUaGUgcGFnZSBjb21wb25lbnQgZ2V0dGVyLlxuXHQgKi9cblx0Z2V0Q29tcG9uZW50KCk6IENvbXBvbmVudDtcblxuXHQvKipcblx0ICogQ2FsbGVkIG9uY2Ugd2hlbiByZWdpc3RlcmluZyB0aGUgcGFnZS5cblx0ICpcblx0ICogQHBhcmFtIHBhZ2VyXG5cdCAqL1xuXHRpbnN0YWxsKHBhZ2VyOiBPV2ViUGFnZXI8Q29tcG9uZW50Pik6IHRoaXM7XG5cblx0LyoqXG5cdCAqIERvZXMgdGhpcyBwYWdlIHJlcXVpcmUgYSB2ZXJpZmllZCB1c2VyIGZvciB0aGUgcmVxdWVzdGVkIHBhZ2Ugcm91dGUuXG5cdCAqXG5cdCAqIEBwYXJhbSBjb250ZXh0IFRoZSBhcHAgY29udGV4dC5cblx0ICogQHBhcmFtIHJvdXRlIFRoZSByZXF1ZXN0IHBhZ2Ugcm91dGUuXG5cdCAqL1xuXHRyZXF1aXJlTG9naW4oY29udGV4dDogT1dlYlJvdXRlQ29udGV4dCwgcm91dGU6IHRQYWdlUm91dGVGdWxsKTogYm9vbGVhbixcblxuXHQvKipcblx0ICogQ2FsbGVkIGJlZm9yZSBwYWdlIG9wZW4uXG5cdCAqXG5cdCAqIEBwYXJhbSBjb250ZXh0XG5cdCAqIEBwYXJhbSByb3V0ZVxuXHQgKi9cblx0b25PcGVuKGNvbnRleHQ6IE9XZWJSb3V0ZUNvbnRleHQsIHJvdXRlOiB0UGFnZVJvdXRlRnVsbCk6IHZvaWQsXG5cblx0LyoqXG5cdCAqIENhbGxlZCBiZWZvcmUgcGFnZSBjbG9zZS5cblx0ICpcblx0ICogQHBhcmFtIG9sZFJvdXRlXG5cdCAqIEBwYXJhbSBuZXdSb3V0ZVxuXHQgKi9cblx0b25DbG9zZShvbGRSb3V0ZTogdFBhZ2VSb3V0ZUZ1bGwsIG5ld1JvdXRlOiB0UGFnZVJvdXRlRnVsbCk6IHZvaWRcbn1cblxuY29uc3Qgd0RvYyA9IHdpbmRvdy5kb2N1bWVudDtcbmxldCByb3V0ZUlkID0gMCxcblx0X2lzUGFyZW50T2YgPSAocGFyZW50OiB0UGFnZVJvdXRlRnVsbCwgcm91dGU6IHRQYWdlUm91dGVGdWxsKTogYm9vbGVhbiA9PiB7XG5cdFx0bGV0IHA7XG5cdFx0d2hpbGUgKChwID0gcm91dGUucGFyZW50ISkpIHtcblx0XHRcdGlmIChwID09PSBwYXJlbnQpIHtcblx0XHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0XHR9XG5cblx0XHRcdHJvdXRlID0gcDtcblx0XHR9XG5cdFx0cmV0dXJuIGZhbHNlO1xuXHR9O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViUGFnZXI8Q29tcG9uZW50PiBleHRlbmRzIE9XZWJFdmVudCB7XG5cdHN0YXRpYyByZWFkb25seSBTRUxGID0gVXRpbHMuaWQoKTtcblx0c3RhdGljIHJlYWRvbmx5IEVWVF9QQUdFX0xPQ0FUSU9OX0NIQU5HRSA9IFV0aWxzLmlkKCk7XG5cblx0cHJpdmF0ZSByZWFkb25seSBfcGFnZXM6IHsgWyBrZXk6IHN0cmluZyBdOiBpUGFnZTxDb21wb25lbnQ+IH0gPSB7fTtcblx0cHJpdmF0ZSBfcm91dGVzX2NhY2hlOiB0UGFnZVJvdXRlW10gPSBbXTtcblx0cHJpdmF0ZSBfcm91dGVzX2ZsYXR0ZW5lZDogdFBhZ2VSb3V0ZUZ1bGxbXSA9IFtdO1xuXHRwcml2YXRlIF9hY3RpdmVfcGFnZTogaVBhZ2U8Q29tcG9uZW50PiB8IHVuZGVmaW5lZDtcblx0cHJpdmF0ZSBfYWN0aXZlX3JvdXRlPzogdFBhZ2VSb3V0ZUZ1bGw7XG5cblx0LyoqXG5cdCAqIEBwYXJhbSBhcHBfY29udGV4dCBUaGUgYXBwIGNvbnRleHQuXG5cdCAqL1xuXHRjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGFwcF9jb250ZXh0OiBPV2ViQXBwKSB7XG5cdFx0c3VwZXIoKTtcblx0XHRjb25zb2xlLmxvZyhcIltPV2ViUGFnZXJdIHJlYWR5IVwiKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHJlZ2lzdGVyZWQgcGFnZXMgcm91dGVzLlxuXHQgKi9cblx0Z2V0Um91dGVzKCk6IHRQYWdlUm91dGVbXSB7XG5cdFx0cmV0dXJuIHRoaXMuX3JvdXRlc19jYWNoZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHRoZSBwYWdlIHdpdGggdGhlIGdpdmVuIG5hbWUuXG5cdCAqIEBwYXJhbSBuYW1lXG5cdCAqL1xuXHRnZXRQYWdlKG5hbWU6IHN0cmluZyk6IGlQYWdlPENvbXBvbmVudD4ge1xuXHRcdGxldCBwYWdlOiBpUGFnZTxDb21wb25lbnQ+ID0gdGhpcy5fcGFnZXNbIG5hbWUgXTtcblx0XHRpZiAodW5kZWZpbmVkID09PSBwYWdlKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYFtPV2ViUGFnZXJdIHRoZSBwYWdlIFwiJHsgbmFtZSB9XCIgaXMgbm90IGRlZmluZWQuYCk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHBhZ2U7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgYWN0aXZlIHBhZ2UuXG5cdCAqL1xuXHRnZXRBY3RpdmVQYWdlKCk6IGlQYWdlPENvbXBvbmVudD4ge1xuXHRcdGlmICghdGhpcy5fYWN0aXZlX3BhZ2UpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihcIltPV2ViUGFnZXJdIG5vIGFjdGl2ZSBwYWdlLlwiKTtcblx0XHR9XG5cdFx0cmV0dXJuIHRoaXMuX2FjdGl2ZV9wYWdlO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgdGhlIGFjdGl2ZSBwYWdlIHJvdXRlLlxuXHQgKi9cblx0Z2V0QWN0aXZlUGFnZVJvdXRlKCk6IHRQYWdlUm91dGVGdWxsIHtcblx0XHRpZiAoIXRoaXMuX2FjdGl2ZV9yb3V0ZSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFwiW09XZWJQYWdlcl0gbm8gYWN0aXZlIHJvdXRlLlwiKTtcblx0XHR9XG5cdFx0cmV0dXJuIHRoaXMuX2FjdGl2ZV9yb3V0ZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIGFsbCBwYWdlcyBsaXN0LlxuXHQgKi9cblx0Z2V0UGFnZUxpc3QoKSB7XG5cdFx0cmV0dXJuIE9iamVjdC5jcmVhdGUodGhpcy5fcGFnZXMpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJlZ2lzdGVyIGEgZ2l2ZW4gcGFnZS5cblx0ICpcblx0ICogQHBhcmFtIHBhZ2Vcblx0ICovXG5cdHJlZ2lzdGVyUGFnZShwYWdlOiBpUGFnZTxDb21wb25lbnQ+KTogdGhpcyB7XG5cdFx0bGV0IG5hbWUgPSBwYWdlLmdldE5hbWUoKTtcblxuXHRcdGlmIChuYW1lIGluIHRoaXMuX3BhZ2VzKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYFtPV2ViUGFnZXJdIHBhZ2UgXCIkeyBuYW1lIH1cIiBhbHJlYWR5IHJlZ2lzdGVyZWQuYCk7XG5cdFx0fVxuXG5cdFx0dGhpcy5fcGFnZXNbIG5hbWUgXSA9IHBhZ2UuaW5zdGFsbCh0aGlzKTtcblx0XHRsZXQgcm91dGVzID0gcGFnZS5nZXRSb3V0ZXMoKTtcblxuXHRcdHRoaXMuX3JvdXRlc19jYWNoZS5wdXNoKC4uLnJvdXRlcyk7XG5cblx0XHRyZXR1cm4gdGhpcy5fcmVnaXN0ZXJQYWdlUm91dGVzKHBhZ2UsIHJvdXRlcyk7XG5cdH1cblxuXHQvKipcblx0ICogSGVscGVycyB0byByZWdpc3RlciBwYWdlIHJvdXRlcy5cblx0ICpcblx0ICogQHBhcmFtIHBhZ2UgVGhlIHBhZ2UuXG5cdCAqIEBwYXJhbSByb3V0ZXMgVGhlIHBhZ2Ugcm91dGVzIGxpc3QuXG5cdCAqIEBwYXJhbSBwYXJlbnQgVGhlIHBhZ2Ugcm91dGVzIHBhcmVudC5cblx0ICogQHByaXZhdGVcblx0ICovXG5cdHByaXZhdGUgX3JlZ2lzdGVyUGFnZVJvdXRlcyhwYWdlOiBpUGFnZTxDb21wb25lbnQ+LCByb3V0ZXM6IHRQYWdlUm91dGVbXSwgcGFyZW50PzogdFBhZ2VSb3V0ZUZ1bGwpOiB0aGlzIHtcblxuXHRcdGxldCByb3V0ZXI6IE9XZWJSb3V0ZXIgPSB0aGlzLmFwcF9jb250ZXh0LnJvdXRlcjtcblxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgcm91dGVzLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRsZXQgcm91dGU6IGFueSA9IHJvdXRlc1sgaSBdO1xuXG5cdFx0XHRyb3V0ZS5pZCA9ICsrcm91dGVJZDtcblx0XHRcdHJvdXRlLnBhcmVudCA9IHBhcmVudDtcblx0XHRcdHJvdXRlLmhyZWYgPSByb3V0ZXIucGF0aFRvVVJMKHR5cGVvZiByb3V0ZS5wYXRoID09PSBcInN0cmluZ1wiID8gcm91dGUucGF0aCA6IFwiL1wiKS5ocmVmO1xuXHRcdFx0cm91dGUuYWN0aXZlID0gZmFsc2U7XG5cdFx0XHRyb3V0ZS5hY3RpdmVDaGlsZCA9IGZhbHNlO1xuXG5cdFx0XHRyb3V0ZS5zaG93ID0gcm91dGUuc2hvdyB8fCBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdHJldHVybiB0cnVlO1xuXHRcdFx0fTtcblxuXHRcdFx0dGhpcy5fcm91dGVzX2ZsYXR0ZW5lZC5wdXNoKHJvdXRlKTtcblxuXHRcdFx0dGhpcy5fYWRkUm91dGUocm91dGUsIHBhZ2UpO1xuXG5cdFx0XHRpZiAocm91dGUuc3ViICYmIHJvdXRlLnN1Yi5sZW5ndGgpIHtcblx0XHRcdFx0dGhpcy5fcmVnaXN0ZXJQYWdlUm91dGVzKHBhZ2UsIHJvdXRlLnN1Yiwgcm91dGUpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0LyoqXG5cdCAqIEhlbHBlciB0byBhZGQgcm91dGUuXG5cdCAqXG5cdCAqIEBwYXJhbSByb3V0ZSBUaGUgcm91dGUgb2JqZWN0LlxuXHQgKiBAcGFyYW0gcGFnZSBUaGUgcGFnZSB0byB3aGljaCB0aGF0IHJvdXRlIGJlbG9uZ3MgdG8uXG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIF9hZGRSb3V0ZShyb3V0ZTogdFBhZ2VSb3V0ZUZ1bGwsIHBhZ2U6IGlQYWdlPENvbXBvbmVudD4pOiB0aGlzIHtcblx0XHRsZXQgY3R4ID0gdGhpcztcblx0XHR0aGlzLmFwcF9jb250ZXh0LnJvdXRlci5vbihyb3V0ZS5wYXRoLCByb3V0ZS5wYXRoT3B0aW9ucywgKHJvdXRlQ29udGV4dDogT1dlYlJvdXRlQ29udGV4dCkgPT4ge1xuXHRcdFx0Y29uc29sZS5sb2coXCJbT1dlYlBhZ2VyXSBwYWdlIHJvdXRlIG1hdGNoIC0+XCIsIHJvdXRlLCBwYWdlLCByb3V0ZUNvbnRleHQpO1xuXG5cdFx0XHRpZiAocGFnZS5yZXF1aXJlTG9naW4ocm91dGVDb250ZXh0LCByb3V0ZSkgJiYgIWN0eC5hcHBfY29udGV4dC51c2VyVmVyaWZpZWQoKSkge1xuXHRcdFx0XHRyZXR1cm4gcm91dGVDb250ZXh0LnN0b3AoKSAmJiBjdHguYXBwX2NvbnRleHQuc2hvd0xvZ2luUGFnZSgpO1xuXHRcdFx0fVxuXG5cdFx0XHRsZXQgYXIgPSBjdHguX2FjdGl2ZV9yb3V0ZSwgYXAgPSBjdHguX2FjdGl2ZV9wYWdlO1xuXG5cdFx0XHRhcCAmJiBhciAmJiBhcC5vbkNsb3NlKGFyLCByb3V0ZSk7XG5cblx0XHRcdHBhZ2Uub25PcGVuKHJvdXRlQ29udGV4dCwgcm91dGUpO1xuXG5cdFx0XHQhcm91dGVDb250ZXh0LnN0b3BwZWQoKSAmJiBjdHguX3NldEFjdGl2ZShwYWdlLCByb3V0ZSk7XG5cdFx0fSk7XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdC8qKlxuXHQgKiBIZWxwZXIgdG8gc2V0IHRoZSBhY3RpdmUgcm91dGUuXG5cdCAqXG5cdCAqIEBwYXJhbSBwYWdlXG5cdCAqIEBwYXJhbSByb3V0ZVxuXHQgKiBAcHJpdmF0ZVxuXHQgKi9cblx0cHJpdmF0ZSBfc2V0QWN0aXZlKHBhZ2U6IGlQYWdlPENvbXBvbmVudD4sIHJvdXRlOiB0UGFnZVJvdXRlRnVsbCk6IHRoaXMge1xuXHRcdGxldCBvbGRQYWdlID0gdGhpcy5fYWN0aXZlX3BhZ2UsXG5cdFx0XHRvbGRSb3V0ZSA9IHRoaXMuX2FjdGl2ZV9yb3V0ZSxcblx0XHRcdGFwcCA9IHRoaXMuYXBwX2NvbnRleHQ7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX3JvdXRlc19mbGF0dGVuZWQubGVuZ3RoOyBpKyspIHtcblx0XHRcdGxldCBjID0gdGhpcy5fcm91dGVzX2ZsYXR0ZW5lZFsgaSBdO1xuXG5cdFx0XHRjLmFjdGl2ZSA9IHJvdXRlLmlkID09PSBjLmlkO1xuXHRcdFx0Yy5hY3RpdmVDaGlsZCA9ICFjLmFjdGl2ZSAmJiBfaXNQYXJlbnRPZihjLCByb3V0ZSk7XG5cdFx0fVxuXG5cdFx0dGhpcy5fYWN0aXZlX3BhZ2UgPSBwYWdlO1xuXHRcdHRoaXMuX2FjdGl2ZV9yb3V0ZSA9IHJvdXRlO1xuXHRcdHdEb2MudGl0bGUgPSBhcHAuaTE4bi50b0h1bWFuKHJvdXRlLnRpdGxlLmxlbmd0aCA/IHJvdXRlLnRpdGxlIDogYXBwLmdldEFwcE5hbWUoKSk7XG5cblx0XHRsZXQgaW5mbzogYW55ID0ge1xuXHRcdFx0cGFnZSxcblx0XHRcdG9sZFBhZ2UsXG5cdFx0XHRyb3V0ZSxcblx0XHRcdG9sZFJvdXRlLFxuXHRcdFx0c2FtZVBhZ2U6IG9sZFBhZ2UgPT09IHBhZ2Vcblx0XHR9O1xuXG5cdFx0Y29uc29sZS5sb2coJ1tPV2ViUGFnZXJdIGluZm8nLCBpbmZvKTtcblxuXHRcdHJldHVybiB0aGlzLnRyaWdnZXIoT1dlYlBhZ2VyLkVWVF9QQUdFX0xPQ0FUSU9OX0NIQU5HRSwgWyByb3V0ZSwgcGFnZSBdKTtcblx0fVxuXG5cdG9uTG9jYXRpb25DaGFuZ2UoaGFuZGxlcjogKHJvdXRlOiB0UGFnZVJvdXRlRnVsbCwgcGFnZTogaVBhZ2U8Q29tcG9uZW50PikgPT4gdm9pZCkge1xuXHRcdHJldHVybiB0aGlzLm9uKE9XZWJQYWdlci5FVlRfUEFHRV9MT0NBVElPTl9DSEFOR0UsIGhhbmRsZXIpO1xuXHR9XG59XG4iXX0=