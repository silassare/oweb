import OWebEvent from './OWebEvent';
import { id, logger } from './utils';
import OWebRoute from './OWebRoute';
const wDoc = window.document;
let routeId = 0;
const _isParentOf = (parent, route) => {
    let p;
    while ((p = route.parent)) {
        if (p === parent) {
            return true;
        }
        route = p;
    }
    return false;
};
export default class OWebPager extends OWebEvent {
    /**
     * @param _appContext The app context.
     */
    constructor(_appContext) {
        super();
        this._appContext = _appContext;
        this._pages = {};
        this._routesCache = [];
        this._routesFlattened = [];
        logger.info('[OWebPager] ready!');
    }
    /**
     * Returns registered pages routes.
     */
    getRoutes() {
        return [...this._routesCache];
    }
    /**
     * Returns the page with the given name.
     * @param name
     */
    getPage(name) {
        const page = this._pages[name];
        if (undefined === page) {
            throw new Error(`[OWebPager] the page "${name}" is not defined.`);
        }
        return page;
    }
    /**
     * Returns the active page.
     */
    getActivePage() {
        if (!this._activePage) {
            throw new Error('[OWebPager] no active page.');
        }
        return this._activePage;
    }
    /**
     * Returns the active page route.
     */
    getActivePageRoute() {
        if (!this._activeRoute) {
            throw new Error('[OWebPager] no active route.');
        }
        return this._activeRoute;
    }
    /**
     * Returns all pages list.
     */
    getPageList() {
        return { ...this._pages };
    }
    /**
     * Register a given page.
     *
     * @param page
     */
    registerPage(page) {
        const name = page.name;
        if (name in this._pages) {
            throw new Error(`[OWebPager] page "${name}" already registered.`);
        }
        page.install && page.install(this);
        this._pages[name] = page;
        const routes = page.routes;
        this._routesCache.push(...routes);
        return this._registerPageRoutes(page, routes);
    }
    /**
     * Helpers to register page routes.
     *
     * @param page The page.
     * @param routes The page routes list.
     * @param parent The page routes parent.
     * @private
     */
    _registerPageRoutes(page, routes, parent) {
        const router = this._appContext.router;
        for (let i = 0; i < routes.length; i++) {
            const route = routes[i];
            route.id = ++routeId;
            route.parent = parent;
            route.pathOptions = route.pathOptions || {};
            route.children = route.children || [];
            route.active = false;
            route.activeChild = false;
            const webRoute = (route.webRoute = this._addRoute(route, page));
            if (!webRoute.isDynamic()) {
                route.href = router.pathToURL(route.path).href;
            }
            if (!('show' in route)) {
                route.show = true;
            }
            if (!('showChildren' in route)) {
                route.showChildren = true;
            }
            if (!('disabled' in route)) {
                route.disabled = false;
            }
            this._routesFlattened.push(route);
            if (route.children.length) {
                this._registerPageRoutes(page, route.children, route);
            }
        }
        return this;
    }
    /**
     * Helper to add route.
     *
     * @param route The route object.
     * @param page The page to which that route belongs to.
     * @private
     */
    _addRoute(route, page) {
        const webRoute = new OWebRoute(route.path, route.pathOptions, (routeContext) => {
            logger.debug('[OWebPager] page route match', route, page, routeContext);
            if (page.requireLogin &&
                page.requireLogin(routeContext, route) &&
                !this._appContext.user.userVerified()) {
                return (routeContext.stop() &&
                    this._appContext.showLoginPage({
                        next: routeContext.getPath(),
                    }));
            }
            const ar = this._activeRoute, ap = this._activePage;
            ap && ar && ap.onClose && ap.onClose(ar, route);
            page.onOpen && page.onOpen(routeContext, route);
            !routeContext.stopped() && this._setActive(page, route);
        });
        this._appContext.router.addRoute(webRoute);
        return webRoute;
    }
    /**
     * Helper to set the active route.
     *
     * @param page
     * @param route
     * @private
     */
    _setActive(page, route) {
        const oldPage = this._activePage, oldRoute = this._activeRoute, app = this._appContext;
        for (let i = 0; i < this._routesFlattened.length; i++) {
            const c = this._routesFlattened[i];
            c.active = route.id === c.id;
            c.activeChild = !c.active && _isParentOf(c, route);
        }
        this._activePage = page;
        this._activeRoute = route;
        wDoc.title = app.i18n.toHuman(route.title ? route.title : app.getAppName());
        const info = {
            page,
            oldPage,
            route,
            oldRoute,
            samePage: oldPage === page,
        };
        logger.debug('[OWebPager] location info', info);
        this.trigger(OWebPager.EVT_PAGE_LOCATION_CHANGE, [route, page]);
        return this;
    }
    onLocationChange(handler) {
        return this.on(OWebPager.EVT_PAGE_LOCATION_CHANGE, handler);
    }
}
OWebPager.SELF = id();
OWebPager.EVT_PAGE_LOCATION_CHANGE = id();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlBhZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL09XZWJQYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLFNBQVMsTUFBTSxhQUFhLENBQUM7QUFFcEMsT0FBTyxFQUFDLEVBQUUsRUFBRSxNQUFNLEVBQUMsTUFBTSxTQUFTLENBQUM7QUFFbkMsT0FBTyxTQUEwQyxNQUFNLGFBQWEsQ0FBQztBQStFckUsTUFBTSxJQUFJLEdBQVUsTUFBTSxDQUFDLFFBQVEsQ0FBQztBQUNwQyxJQUFJLE9BQU8sR0FBUyxDQUFDLENBQUM7QUFDdEIsTUFBTSxXQUFXLEdBQUcsQ0FDbkIsTUFBc0IsRUFDdEIsS0FBcUIsRUFDWCxFQUFFO0lBQ1osSUFBSSxDQUFDLENBQUM7SUFDTixPQUFPLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRTtRQUMxQixJQUFJLENBQUMsS0FBSyxNQUFNLEVBQUU7WUFDakIsT0FBTyxJQUFJLENBQUM7U0FDWjtRQUVELEtBQUssR0FBRyxDQUFDLENBQUM7S0FDVjtJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2QsQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLE9BQU8sT0FBTyxTQUEyQixTQUFRLFNBQVM7SUFVaEU7O09BRUc7SUFDSCxZQUE2QixXQUFvQjtRQUNoRCxLQUFLLEVBQUUsQ0FBQztRQURvQixnQkFBVyxHQUFYLFdBQVcsQ0FBUztRQVRoQyxXQUFNLEdBQXlCLEVBQUUsQ0FBQztRQUMzQyxpQkFBWSxHQUEyQixFQUFFLENBQUM7UUFDMUMscUJBQWdCLEdBQXVCLEVBQUUsQ0FBQztRQVNqRCxNQUFNLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsU0FBUztRQUNSLE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsT0FBTyxDQUFD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R0FBSSxJQUFJLENBQUM7UUFDekIsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7UUFDMUIsSUFBSSxDQUFDLEtBQUssR0FBVSxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FDbkMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUM1QyxDQUFDO1FBRUYsTUFBTSxJQUFJLEdBQVE7WUFDakIsSUFBSTtZQUNKLE9BQU87WUFDUCxLQUFLO1lBQ0wsUUFBUTtZQUNSLFFBQVEsRUFBRSxPQUFPLEtBQUssSUFBSTtTQUMxQixDQUFDO1FBRUYsTUFBTSxDQUFDLEtBQUssQ0FBQywyQkFBMkIsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVoRCxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyx3QkFBd0IsRUFBRSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRWhFLE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztJQUVELGdCQUFnQixDQUNmLE9BQWlEO1FBRWpELE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsd0JBQXdCLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDN0QsQ0FBQzs7QUF0T2UsY0FBSSxHQUF1QixFQUFFLEVBQUUsQ0FBQztBQUNoQyxrQ0FBd0IsR0FBRyxFQUFFLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBPV2ViQXBwIGZyb20gJy4vT1dlYkFwcCc7XG5pbXBvcnQgT1dlYkV2ZW50IGZyb20gJy4vT1dlYkV2ZW50JztcbmltcG9ydCBPV2ViUm91dGVyIGZyb20gJy4vT1dlYlJvdXRlcic7XG5pbXBvcnQge2lkLCBsb2dnZXJ9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IE9XZWJSb3V0ZUNvbnRleHQgZnJvbSAnLi9PV2ViUm91dGVDb250ZXh0JztcbmltcG9ydCBPV2ViUm91dGUsIHtPUm91dGVQYXRoLCBPUm91dGVQYXRoT3B0aW9uc30gZnJvbSAnLi9PV2ViUm91dGUnO1xuaW1wb3J0IHtPSTE4bn0gZnJvbSAnLi9PV2ViSTE4bic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgT1BhZ2VSb3V0ZSB7XG5cdHNsdWc/OiBzdHJpbmc7XG5cdGljb24/OiBzdHJpbmc7XG5cdHRpdGxlOiBPSTE4bjtcblx0ZGVzY3JpcHRpb24/OiBPSTE4bjtcblx0cGF0aDogT1JvdXRlUGF0aDtcblx0cGF0aE9wdGlvbnM/OiBPUm91dGVQYXRoT3B0aW9ucztcblx0Y2hpbGRyZW4/OiBPUGFnZVJvdXRlW107XG5cdHNob3dDaGlsZHJlbj86IGJvb2xlYW47XG5cdGRpc2FibGVkPzogYm9vbGVhbjtcblx0c2hvdz86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgT1BhZ2VSb3V0ZUZ1bGwge1xuXHRzbHVnPzogc3RyaW5nO1xuXHRpY29uPzogc3RyaW5nO1xuXHR0aXRsZTogT0kxOG47XG5cdGRlc2NyaXB0aW9uPzogT0kxOG47XG5cdHBhdGg6IE9Sb3V0ZVBhdGg7XG5cdHBhdGhPcHRpb25zOiBPUm91dGVQYXRoT3B0aW9ucztcblx0Y2hpbGRyZW46IE9QYWdlUm91dGVGdWxsW107XG5cdHNob3dDaGlsZHJlbjogYm9vbGVhbjtcblx0ZGlzYWJsZWQ6IGJvb2xlYW47XG5cdHNob3c6IGJvb2xlYW47XG5cblx0cmVhZG9ubHkgaWQ6IG51bWJlcjtcblx0cmVhZG9ubHkgaHJlZj86IHN0cmluZztcblx0cmVhZG9ubHkgcGFyZW50PzogT1BhZ2VSb3V0ZUZ1bGw7XG5cdGFjdGl2ZTogYm9vbGVhbjtcblx0YWN0aXZlQ2hpbGQ6IGJvb2xlYW47XG5cdHdlYlJvdXRlOiBPV2ViUm91dGU7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgT1BhZ2Uge1xuXHQvKipcblx0ICogVGhlIHBhZ2UgbmFtZSBnZXR0ZXIuXG5cdCAqL1xuXHRuYW1lOiBzdHJpbmc7XG5cblx0LyoqXG5cdCAqIFRoZSBwYWdlIHJvdXRlcyBnZXR0ZXIuXG5cdCAqL1xuXHRyb3V0ZXM6IE9QYWdlUm91dGVbXTtcblxuXHQvKipcblx0ICogQ2FsbGVkIG9uY2Ugd2hlbiByZWdpc3RlcmluZyB0aGUgcGFnZS5cblx0ICpcblx0ICogQHBhcmFtIHBhZ2VyXG5cdCAqL1xuXHRpbnN0YWxsPyhwYWdlcjogT1dlYlBhZ2VyPHRoaXM+KTogdGhpcztcblxuXHQvKipcblx0ICogRG9lcyB0aGlzIHBhZ2UgcmVxdWlyZSBhIHZlcmlmaWVkIHVzZXIgZm9yIHRoZSByZXF1ZXN0ZWQgcGFnZSByb3V0ZS5cblx0ICpcblx0ICogQHBhcmFtIGNvbnRleHQgVGhlIGFwcCBjb250ZXh0LlxuXHQgKiBAcGFyYW0gcm91dGUgVGhlIHJlcXVlc3QgcGFnZSByb3V0ZS5cblx0ICovXG5cdHJlcXVpcmVMb2dpbj8oY29udGV4dDogT1dlYlJvdXRlQ29udGV4dCwgcm91dGU6IE9QYWdlUm91dGVGdWxsKTogYm9vbGVhbjtcblxuXHQvKipcblx0ICogQ2FsbGVkIGJlZm9yZSBwYWdlIG9wZW4uXG5cdCAqXG5cdCAqIEBwYXJhbSBjb250ZXh0XG5cdCAqIEBwYXJhbSByb3V0ZVxuXHQgKi9cblx0b25PcGVuPyhjb250ZXh0OiBPV2ViUm91dGVDb250ZXh0LCByb3V0ZTogT1BhZ2VSb3V0ZUZ1bGwpOiB2b2lkO1xuXG5cdC8qKlxuXHQgKiBDYWxsZWQgYmVmb3JlIHBhZ2UgY2xvc2UuXG5cdCAqXG5cdCAqIEBwYXJhbSBvbGRSb3V0ZVxuXHQgKiBAcGFyYW0gbmV3Um91dGVcblx0ICovXG5cdG9uQ2xvc2U/KG9sZFJvdXRlOiBPUGFnZVJvdXRlRnVsbCwgbmV3Um91dGU6IE9QYWdlUm91dGVGdWxsKTogdm9pZDtcbn1cblxuY29uc3Qgd0RvYyAgICAgICAgPSB3aW5kb3cuZG9jdW1lbnQ7XG5sZXQgcm91dGVJZCAgICAgICA9IDA7XG5jb25zdCBfaXNQYXJlbnRPZiA9IChcblx0cGFyZW50OiBPUGFnZVJvdXRlRnVsbCxcblx0cm91dGU6IE9QYWdlUm91dGVGdWxsLFxuKTogYm9vbGVhbiA9PiB7XG5cdGxldCBwO1xuXHR3aGlsZSAoKHAgPSByb3V0ZS5wYXJlbnQpKSB7XG5cdFx0aWYgKHAgPT09IHBhcmVudCkge1xuXHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0fVxuXG5cdFx0cm91dGUgPSBwO1xuXHR9XG5cdHJldHVybiBmYWxzZTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJQYWdlcjxQIGV4dGVuZHMgT1BhZ2U+IGV4dGVuZHMgT1dlYkV2ZW50IHtcblx0c3RhdGljIHJlYWRvbmx5IFNFTEYgICAgICAgICAgICAgICAgICAgICA9IGlkKCk7XG5cdHN0YXRpYyByZWFkb25seSBFVlRfUEFHRV9MT0NBVElPTl9DSEFOR0UgPSBpZCgpO1xuXG5cdHByaXZhdGUgcmVhZG9ubHkgX3BhZ2VzOiB7IFtrZXk6IHN0cmluZ106IFAgfSA9IHt9O1xuXHRwcml2YXRlIF9yb3V0ZXNDYWNoZTogT1BhZ2VSb3V0ZUZ1bGxbXSAgICAgICA9IFtdO1xuXHRwcml2YXRlIF9yb3V0ZXNGbGF0dGVuZWQ6IE9QYWdlUm91dGVGdWxsW10gICA9IFtdO1xuXHRwcml2YXRlIF9hY3RpdmVQYWdlPzogUDtcblx0cHJpdmF0ZSBfYWN0aXZlUm91dGU/OiBPUGFnZVJvdXRlRnVsbDtcblxuXHQvKipcblx0ICogQHBhcmFtIF9hcHBDb250ZXh0IFRoZSBhcHAgY29udGV4dC5cblx0ICovXG5cdGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgX2FwcENvbnRleHQ6IE9XZWJBcHApIHtcblx0XHRzdXBlcigpO1xuXHRcdGxvZ2dlci5pbmZvKCdbT1dlYlBhZ2VyXSByZWFkeSEnKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHJlZ2lzdGVyZWQgcGFnZXMgcm91dGVzLlxuXHQgKi9cblx0Z2V0Um91dGVzKCk6IE9QYWdlUm91dGVGdWxsW10ge1xuXHRcdHJldHVybiBbLi4udGhpcy5fcm91dGVzQ2FjaGVdO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgdGhlIHBhZ2Ugd2l0aCB0aGUgZ2l2ZW4gbmFtZS5cblx0ICogQHBhcmFtIG5hbWVcblx0ICovXG5cdGdldFBhZ2UobmFtZTogc3RyaW5nKTogUCB7XG5cdFx0Y29uc3QgcGFnZTogUCA9IHRoaXMuX3BhZ2VzW25hbWVdO1xuXHRcdGlmICh1bmRlZmluZWQgPT09IHBhZ2UpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihgW09XZWJQYWdlcl0gdGhlIHBhZ2UgXCIke25hbWV9XCIgaXMgbm90IGRlZmluZWQuYCk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHBhZ2U7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgYWN0aXZlIHBhZ2UuXG5cdCAqL1xuXHRnZXRBY3RpdmVQYWdlKCk6IFAge1xuXHRcdGlmICghdGhpcy5fYWN0aXZlUGFnZSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdbT1dlYlBhZ2VyXSBubyBhY3RpdmUgcGFnZS4nKTtcblx0XHR9XG5cdFx0cmV0dXJuIHRoaXMuX2FjdGl2ZVBhZ2U7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgYWN0aXZlIHBhZ2Ugcm91dGUuXG5cdCAqL1xuXHRnZXRBY3RpdmVQYWdlUm91dGUoKTogT1BhZ2VSb3V0ZUZ1bGwge1xuXHRcdGlmICghdGhpcy5fYWN0aXZlUm91dGUpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcignW09XZWJQYWdlcl0gbm8gYWN0aXZlIHJvdXRlLicpO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcy5fYWN0aXZlUm91dGU7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyBhbGwgcGFnZXMgbGlzdC5cblx0ICovXG5cdGdldFBhZ2VMaXN0KCkge1xuXHRcdHJldHVybiB7Li4udGhpcy5fcGFnZXN9O1xuXHR9XG5cblx0LyoqXG5cdCAqIFJlZ2lzdGVyIGEgZ2l2ZW4gcGFnZS5cblx0ICpcblx0ICogQHBhcmFtIHBhZ2Vcblx0ICovXG5cdHJlZ2lzdGVyUGFnZShwYWdlOiBQKTogdGhpcyB7XG5cdFx0Y29uc3QgbmFtZSA9IHBhZ2UubmFtZTtcblxuXHRcdGlmIChuYW1lIGluIHRoaXMuX3BhZ2VzKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYFtPV2ViUGFnZXJdIHBhZ2UgXCIke25hbWV9XCIgYWxyZWFkeSByZWdpc3RlcmVkLmApO1xuXHRcdH1cblxuXHRcdHBhZ2UuaW5zdGFsbCAmJiBwYWdlLmluc3RhbGwodGhpcyk7XG5cblx0XHR0aGlzLl9wYWdlc1tuYW1lXSA9IHBhZ2U7XG5cdFx0Y29uc3Qgcm91dGVzICAgICAgPSBwYWdlLnJvdXRlcztcblxuXHRcdHRoaXMuX3JvdXRlc0NhY2hlLnB1c2goLi4uKHJvdXRlcyBhcyBhbnlbXSkpO1xuXG5cdFx0cmV0dXJuIHRoaXMuX3JlZ2lzdGVyUGFnZVJvdXRlcyhwYWdlLCByb3V0ZXMpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEhlbHBlcnMgdG8gcmVnaXN0ZXIgcGFnZSByb3V0ZXMuXG5cdCAqXG5cdCAqIEBwYXJhbSBwYWdlIFRoZSBwYWdlLlxuXHQgKiBAcGFyYW0gcm91dGVzIFRoZSBwYWdlIHJvdXRlcyBsaXN0LlxuXHQgKiBAcGFyYW0gcGFyZW50IFRoZSBwYWdlIHJvdXRlcyBwYXJlbnQuXG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIF9yZWdpc3RlclBhZ2VSb3V0ZXMoXG5cdFx0cGFnZTogUCxcblx0XHRyb3V0ZXM6IE9QYWdlUm91dGVbXSxcblx0XHRwYXJlbnQ/OiBPUGFnZVJvdXRlRnVsbCxcblx0KTogdGhpcyB7XG5cdFx0Y29uc3Qgcm91dGVyOiBPV2ViUm91dGVyID0gdGhpcy5fYXBwQ29udGV4dC5yb3V0ZXI7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHJvdXRlcy5sZW5ndGg7IGkrKykge1xuXHRcdFx0Y29uc3Qgcm91dGU6IGFueSA9IHJvdXRlc1tpXTtcblxuXHRcdFx0cm91dGUuaWQgICAgICAgICAgPSArK3JvdXRlSWQ7XG5cdFx0XHRyb3V0ZS5wYXJlbnQgICAgICA9IHBhcmVudDtcblx0XHRcdHJvdXRlLnBhdGhPcHRpb25zID0gcm91dGUucGF0aE9wdGlvbnMgfHwge307XG5cdFx0XHRyb3V0ZS5jaGlsZHJlbiAgICA9IHJvdXRlLmNoaWxkcmVuIHx8IFtdO1xuXHRcdFx0cm91dGUuYWN0aXZlICAgICAgPSBmYWxzZTtcblx0XHRcdHJvdXRlLmFjdGl2ZUNoaWxkID0gZmFsc2U7XG5cblx0XHRcdGNvbnN0IHdlYlJvdXRlID0gKHJvdXRlLndlYlJvdXRlID0gdGhpcy5fYWRkUm91dGUocm91dGUsIHBhZ2UpKTtcblx0XHRcdGlmICghd2ViUm91dGUuaXNEeW5hbWljKCkpIHtcblx0XHRcdFx0cm91dGUuaHJlZiA9IHJvdXRlci5wYXRoVG9VUkwocm91dGUucGF0aCkuaHJlZjtcblx0XHRcdH1cblxuXHRcdFx0aWYgKCEoJ3Nob3cnIGluIHJvdXRlKSkge1xuXHRcdFx0XHRyb3V0ZS5zaG93ID0gdHJ1ZTtcblx0XHRcdH1cblx0XHRcdGlmICghKCdzaG93Q2hpbGRyZW4nIGluIHJvdXRlKSkge1xuXHRcdFx0XHRyb3V0ZS5zaG93Q2hpbGRyZW4gPSB0cnVlO1xuXHRcdFx0fVxuXHRcdFx0aWYgKCEoJ2Rpc2FibGVkJyBpbiByb3V0ZSkpIHtcblx0XHRcdFx0cm91dGUuZGlzYWJsZWQgPSBmYWxzZTtcblx0XHRcdH1cblxuXHRcdFx0dGhpcy5fcm91dGVzRmxhdHRlbmVkLnB1c2gocm91dGUpO1xuXG5cdFx0XHRpZiAocm91dGUuY2hpbGRyZW4ubGVuZ3RoKSB7XG5cdFx0XHRcdHRoaXMuX3JlZ2lzdGVyUGFnZVJvdXRlcyhwYWdlLCByb3V0ZS5jaGlsZHJlbiwgcm91dGUpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0LyoqXG5cdCAqIEhlbHBlciB0byBhZGQgcm91dGUuXG5cdCAqXG5cdCAqIEBwYXJhbSByb3V0ZSBUaGUgcm91dGUgb2JqZWN0LlxuXHQgKiBAcGFyYW0gcGFnZSBUaGUgcGFnZSB0byB3aGljaCB0aGF0IHJvdXRlIGJlbG9uZ3MgdG8uXG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIF9hZGRSb3V0ZShcblx0XHRyb3V0ZTogT1BhZ2VSb3V0ZUZ1bGwsXG5cdFx0cGFnZTogUCxcblx0KTogT1dlYlJvdXRlIHtcblx0XHRjb25zdCB3ZWJSb3V0ZSA9IG5ldyBPV2ViUm91dGUoXG5cdFx0XHRyb3V0ZS5wYXRoLFxuXHRcdFx0cm91dGUucGF0aE9wdGlvbnMsXG5cdFx0XHQocm91dGVDb250ZXh0OiBPV2ViUm91dGVDb250ZXh0KSA9PiB7XG5cdFx0XHRcdGxvZ2dlci5kZWJ1Zyhcblx0XHRcdFx0XHQnW09XZWJQYWdlcl0gcGFnZSByb3V0ZSBtYXRjaCcsXG5cdFx0XHRcdFx0cm91dGUsXG5cdFx0XHRcdFx0cGFnZSxcblx0XHRcdFx0XHRyb3V0ZUNvbnRleHQsXG5cdFx0XHRcdCk7XG5cblx0XHRcdFx0aWYgKHBhZ2UucmVxdWlyZUxvZ2luICYmXG5cdFx0XHRcdFx0cGFnZS5yZXF1aXJlTG9naW4ocm91dGVDb250ZXh0LCByb3V0ZSkgJiZcblx0XHRcdFx0XHQhdGhpcy5fYXBwQ29udGV4dC51c2VyLnVzZXJWZXJpZmllZCgpXG5cdFx0XHRcdCkge1xuXHRcdFx0XHRcdHJldHVybiAoXG5cdFx0XHRcdFx0XHRyb3V0ZUNvbnRleHQuc3RvcCgpICYmXG5cdFx0XHRcdFx0XHR0aGlzLl9hcHBDb250ZXh0LnNob3dMb2dpblBhZ2Uoe1xuXHRcdFx0XHRcdFx0XHRuZXh0OiByb3V0ZUNvbnRleHQuZ2V0UGF0aCgpLFxuXHRcdFx0XHRcdFx0fSlcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0Y29uc3QgYXIgPSB0aGlzLl9hY3RpdmVSb3V0ZSxcblx0XHRcdFx0XHQgIGFwID0gdGhpcy5fYWN0aXZlUGFnZTtcblxuXHRcdFx0XHRhcCAmJiBhciAmJiBhcC5vbkNsb3NlICYmIGFwLm9uQ2xvc2UoYXIsIHJvdXRlKTtcblxuXHRcdFx0XHRwYWdlLm9uT3BlbiAmJiBwYWdlLm9uT3Blbihyb3V0ZUNvbnRleHQsIHJvdXRlKTtcblxuXHRcdFx0XHQhcm91dGVDb250ZXh0LnN0b3BwZWQoKSAmJiB0aGlzLl9zZXRBY3RpdmUocGFnZSwgcm91dGUpO1xuXHRcdFx0fSxcblx0XHQpO1xuXG5cdFx0dGhpcy5fYXBwQ29udGV4dC5yb3V0ZXIuYWRkUm91dGUod2ViUm91dGUpO1xuXG5cdFx0cmV0dXJuIHdlYlJvdXRlO1xuXHR9XG5cblx0LyoqXG5cdCAqIEhlbHBlciB0byBzZXQgdGhlIGFjdGl2ZSByb3V0ZS5cblx0ICpcblx0ICogQHBhcmFtIHBhZ2Vcblx0ICogQHBhcmFtIHJvdXRlXG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIF9zZXRBY3RpdmUocGFnZTogUCwgcm91dGU6IE9QYWdlUm91dGVGdWxsKTogdGhpcyB7XG5cdFx0Y29uc3Qgb2xkUGFnZSAgPSB0aGlzLl9hY3RpdmVQYWdlLFxuXHRcdFx0ICBvbGRSb3V0ZSA9IHRoaXMuX2FjdGl2ZVJvdXRlLFxuXHRcdFx0ICBhcHAgICAgICA9IHRoaXMuX2FwcENvbnRleHQ7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX3JvdXRlc0ZsYXR0ZW5lZC5sZW5ndGg7IGkrKykge1xuXHRcdFx0Y29uc3QgYyA9IHRoaXMuX3JvdXRlc0ZsYXR0ZW5lZFtpXTtcblxuXHRcdFx0Yy5hY3RpdmUgICAgICA9IHJvdXRlLmlkID09PSBjLmlkO1xuXHRcdFx0Yy5hY3RpdmVDaGlsZCA9ICFjLmFjdGl2ZSAmJiBfaXNQYXJlbnRPZihjLCByb3V0ZSk7XG5cdFx0fVxuXG5cdFx0dGhpcy5fYWN0aXZlUGFnZSAgPSBwYWdlO1xuXHRcdHRoaXMuX2FjdGl2ZVJvdXRlID0gcm91dGU7XG5cdFx0d0RvYy50aXRsZSAgICAgICAgPSBhcHAuaTE4bi50b0h1bWFuKFxuXHRcdFx0cm91dGUudGl0bGUgPyByb3V0ZS50aXRsZSA6IGFwcC5nZXRBcHBOYW1lKCksXG5cdFx0KTtcblxuXHRcdGNvbnN0IGluZm86IGFueSA9IHtcblx0XHRcdHBhZ2UsXG5cdFx0XHRvbGRQYWdlLFxuXHRcdFx0cm91dGUsXG5cdFx0XHRvbGRSb3V0ZSxcblx0XHRcdHNhbWVQYWdlOiBvbGRQYWdlID09PSBwYWdlLFxuXHRcdH07XG5cblx0XHRsb2dnZXIuZGVidWcoJ1tPV2ViUGFnZXJdIGxvY2F0aW9uIGluZm8nLCBpbmZvKTtcblxuXHRcdHRoaXMudHJpZ2dlcihPV2ViUGFnZXIuRVZUX1BBR0VfTE9DQVRJT05fQ0hBTkdFLCBbcm91dGUsIHBhZ2VdKTtcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0b25Mb2NhdGlvbkNoYW5nZShcblx0XHRoYW5kbGVyOiAocm91dGU6IE9QYWdlUm91dGVGdWxsLCBwYWdlOiBQKSA9PiB2b2lkLFxuXHQpIHtcblx0XHRyZXR1cm4gdGhpcy5vbihPV2ViUGFnZXIuRVZUX1BBR0VfTE9DQVRJT05fQ0hBTkdFLCBoYW5kbGVyKTtcblx0fVxufVxuIl19