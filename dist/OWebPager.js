import OWebEvent from './OWebEvent';
import { id, logger } from './utils';
import OWebRoute from './OWebRoute';
const wDoc = window.document;
let routeId = 0;
const _isParentOf = (parent, route) => {
    let p;
    while ((p = route.parent)) {
        if (p === parent) {
            return true;
        }
        route = p;
    }
    return false;
};
export default class OWebPager extends OWebEvent {
    _appContext;
    static SELF = id();
    static EVT_PAGE_LOCATION_CHANGE = id();
    _pages = {};
    _routesCache = [];
    _routesFlattened = [];
    _activePage;
    _activeRoute;
    constructor(_appContext) {
        super();
        this._appContext = _appContext;
        logger.info('[OWebPager] ready!');
    }
    getRoutes() {
        return [...this._routesCache];
    }
    getPage(name) {
        const page = this._pages[name];
        if (undefined === page) {
            throw new Error(`[OWebPager] the page "${name}" is not defined.`);
        }
        return page;
    }
    getActivePage() {
        if (!this._activePage) {
            throw new Error('[OWebPager] no active page.');
        }
        return this._activePage;
    }
    getActivePageRoute() {
        if (!this._activeRoute) {
            throw new Error('[OWebPager] no active route.');
        }
        return this._activeRoute;
    }
    getPageList() {
        return { ...this._pages };
    }
    registerPage(page) {
        const name = page.name;
        if (name in this._pages) {
            throw new Error(`[OWebPager] page "${name}" already registered.`);
        }
        page.install && page.install(this);
        this._pages[name] = page;
        const routes = page.routes;
        this._routesCache.push(...routes);
        return this._registerPageRoutes(page, routes);
    }
    _registerPageRoutes(page, routes, parent) {
        const router = this._appContext.router;
        for (let i = 0; i < routes.length; i++) {
            const route = routes[i];
            if (!route.id) {
                route.id = ++routeId;
                route.parent = parent;
                route.pathOptions = route.pathOptions || {};
                route.children = route.children || [];
                route.active = false;
                route.activeChild = false;
                const webRoute = (route.webRoute = this._addRoute(route, page));
                if (!webRoute.isDynamic()) {
                    route.href = router.pathToURL(route.path).href;
                }
                if (!('show' in route)) {
                    route.show = true;
                }
                if (!('showChildren' in route)) {
                    route.showChildren = true;
                }
                if (!('disabled' in route)) {
                    route.disabled = false;
                }
                this._routesFlattened.push(route);
                if (route.children.length) {
                    this._registerPageRoutes(page, route.children, route);
                }
            }
        }
        return this;
    }
    _addRoute(route, page) {
        const webRoute = new OWebRoute(route.path, route.pathOptions, (routeContext) => {
            logger.debug('[OWebPager] page route match', route, page, routeContext);
            if (page.requireLogin &&
                page.requireLogin(routeContext, route) &&
                !this._appContext.user.userVerified()) {
                return (routeContext.stop() &&
                    this._appContext.showLoginPage({
                        next: routeContext.getPath(),
                    }));
            }
            if (route.disabled) {
                return routeContext.stop() && this._appContext.showHomePage();
            }
            const ar = this._activeRoute, ap = this._activePage;
            ap && ar && ap.onClose && ap.onClose(ar, route);
            page.onOpen && page.onOpen(routeContext, route);
            !routeContext.stopped() && this._setActive(page, route);
        });
        this._appContext.router.addRoute(webRoute);
        return webRoute;
    }
    _setActive(page, route) {
        const oldPage = this._activePage, oldRoute = this._activeRoute, app = this._appContext;
        for (let i = 0; i < this._routesFlattened.length; i++) {
            const c = this._routesFlattened[i];
            c.active = route.id === c.id;
            c.activeChild = !c.active && _isParentOf(c, route);
        }
        this._activePage = page;
        this._activeRoute = route;
        wDoc.title = app.i18n.toHuman(route.title ? route.title : app.getAppName());
        const info = {
            page,
            oldPage,
            route,
            oldRoute,
            samePage: oldPage === page,
        };
        logger.debug('[OWebPager] location info', info);
        this.trigger(OWebPager.EVT_PAGE_LOCATION_CHANGE, [route, page]);
        return this;
    }
    onLocationChange(handler) {
        return this.on(OWebPager.EVT_PAGE_LOCATION_CHANGE, handler);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlBhZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL09XZWJQYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLFNBQVMsTUFBTSxhQUFhLENBQUM7QUFFcEMsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFckMsT0FBTyxTQUE0QyxNQUFNLGFBQWEsQ0FBQztBQWdGdkUsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQztBQUM3QixJQUFJLE9BQU8sR0FBRyxDQUFDLENBQUM7QUFDaEIsTUFBTSxXQUFXLEdBQUcsQ0FDbkIsTUFBc0IsRUFDdEIsS0FBcUIsRUFDWCxFQUFFO0lBQ1osSUFBSSxDQUFDLENBQUM7SUFDTixPQUFPLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRTtRQUMxQixJQUFJLENBQUMsS0FBSyxNQUFNLEVBQUU7WUFDakIsT0FBTyxJQUFJLENBQUM7U0FDWjtRQUVELEtBQUssR0FBRyxDQUFDLENBQUM7S0FDVjtJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2QsQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLE9BQU8sT0FBTyxTQUduQixTQUFRLFNBQVM7SUFhVztJQVo3QixNQUFNLENBQVUsSUFBSSxHQUFHLEVBQUUsRUFBRSxDQUFDO0lBQzVCLE1BQU0sQ0FBVSx3QkFBd0IsR0FBRyxFQUFFLEVBQUUsQ0FBQztJQUUvQixNQUFNLEdBQXNCLEVBQUUsQ0FBQztJQUN4QyxZQUFZLEdBQXdCLEVBQUUsQ0FBQztJQUN2QyxnQkFBZ0IsR0FBd0IsRUFBRSxDQUFDO0lBQzNDLFdBQVcsQ0FBSztJQUNoQixZQUFZLENBQXFCO0lBS3pDLFlBQTZCLFdBQW9CO1FBQ2hELEtBQUssRUFBRSxDQUFDO1FBRG9CLGdCQUFXLEdBQVgsV0FBVyxDQUFTO1FBRWhELE1BQU0sQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQztJQUNu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LEdBQUcsS0FBSyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQzdCLENBQUMsQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxJQUFJLFdBQVcsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDbkQ7UUFFRCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztRQUN4QixJQUFJLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQztRQUMxQixJQUFJLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBRTVFLE1BQU0sSUFBSSxHQUFRO1lBQ2pCLElBQUk7WUFDSixPQUFPO1lBQ1AsS0FBSztZQUNMLFFBQVE7WUFDUixRQUFRLEVBQUUsT0FBTyxLQUFLLElBQUk7U0FDMUIsQ0FBQztRQUVGLE1BQU0sQ0FBQyxLQUFLLENBQUMsMkJBQTJCLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFaEQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsd0JBQXdCLEVBQUUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUVoRSxPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7SUFFRCxnQkFBZ0IsQ0FBQyxPQUFvRDtRQUNwRSxPQUFPLElBQUksQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLHdCQUF3QixFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzdELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT1dlYkFwcCBmcm9tICcuL09XZWJBcHAnO1xuaW1wb3J0IE9XZWJFdmVudCBmcm9tICcuL09XZWJFdmVudCc7XG5pbXBvcnQgT1dlYlJvdXRlciBmcm9tICcuL09XZWJSb3V0ZXInO1xuaW1wb3J0IHsgaWQsIGxvZ2dlciB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IE9XZWJSb3V0ZUNvbnRleHQgZnJvbSAnLi9PV2ViUm91dGVDb250ZXh0JztcbmltcG9ydCBPV2ViUm91dGUsIHsgT1JvdXRlUGF0aCwgT1JvdXRlUGF0aE9wdGlvbnMgfSBmcm9tICcuL09XZWJSb3V0ZSc7XG5pbXBvcnQgeyBPSTE4biB9IGZyb20gJy4vT1dlYkkxOG4nO1xuXG5leHBvcnQgaW50ZXJmYWNlIE9QYWdlUm91dGUge1xuXHRzbHVnPzogc3RyaW5nO1xuXHRpY29uPzogc3RyaW5nO1xuXHR0aXRsZTogT0kxOG47XG5cdGRlc2NyaXB0aW9uPzogT0kxOG47XG5cdHBhdGg6IE9Sb3V0ZVBhdGg7XG5cdHBhdGhPcHRpb25zPzogT1JvdXRlUGF0aE9wdGlvbnM7XG5cdGNoaWxkcmVuPzogT1BhZ2VSb3V0ZVtdO1xuXHRzaG93Q2hpbGRyZW4/OiBib29sZWFuO1xuXHRkaXNhYmxlZD86IGJvb2xlYW47XG5cdHNob3c/OiBib29sZWFuO1xufVxuXG5leHBvcnQgdHlwZSBPUGFnZVJvdXRlRnVsbDxSb3V0ZSBleHRlbmRzIE9QYWdlUm91dGUgPSBPUGFnZVJvdXRlPiA9IFJvdXRlICYge1xuXHRwYXRoT3B0aW9uczogT1JvdXRlUGF0aE9wdGlvbnM7XG5cdGNoaWxkcmVuOiBPUGFnZVJvdXRlRnVsbFtdO1xuXHRzaG93Q2hpbGRyZW46IGJvb2xlYW47XG5cdGRpc2FibGVkOiBib29sZWFuO1xuXHRzaG93OiBib29sZWFuO1xuXG5cdHJlYWRvbmx5IGlkOiBudW1iZXI7XG5cdHJlYWRvbmx5IGhyZWY/OiBzdHJpbmc7XG5cdHJlYWRvbmx5IHBhcmVudD86IE9QYWdlUm91dGVGdWxsPFJvdXRlPjtcblx0YWN0aXZlOiBib29sZWFuO1xuXHRhY3RpdmVDaGlsZDogYm9vbGVhbjtcblx0d2ViUm91dGU6IE9XZWJSb3V0ZTtcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgT1BhZ2U8Um91dGUgZXh0ZW5kcyBPUGFnZVJvdXRlID0gT1BhZ2VSb3V0ZT4ge1xuXHQvKipcblx0ICogVGhlIHBhZ2UgbmFtZSBnZXR0ZXIuXG5cdCAqL1xuXHRuYW1lOiBzdHJpbmc7XG5cblx0LyoqXG5cdCAqIFRoZSBwYWdlIHJvdXRlcyBnZXR0ZXIuXG5cdCAqL1xuXHRyb3V0ZXM6IFJvdXRlW107XG5cblx0LyoqXG5cdCAqIENhbGxlZCBvbmNlIHdoZW4gcmVnaXN0ZXJpbmcgdGhlIHBhZ2UuXG5cdCAqXG5cdCAqIEBwYXJhbSBwYWdlclxuXHQgKi9cblx0aW5zdGFsbD8ocGFnZXI6IE9XZWJQYWdlcjx0aGlzPik6IHRoaXM7XG5cblx0LyoqXG5cdCAqIERvZXMgdGhpcyBwYWdlIHJlcXVpcmUgYSB2ZXJpZmllZCB1c2VyIGZvciB0aGUgcmVxdWVzdGVkIHBhZ2Ugcm91dGUuXG5cdCAqXG5cdCAqIEBwYXJhbSBjb250ZXh0IFRoZSBhcHAgY29udGV4dC5cblx0ICogQHBhcmFtIHJvdXRlIFRoZSByZXF1ZXN0IHBhZ2Ugcm91dGUuXG5cdCAqL1xuXHRyZXF1aXJlTG9naW4/KFxuXHRcdGNvbnRleHQ6IE9XZWJSb3V0ZUNvbnRleHQsXG5cdFx0cm91dGU6IE9QYWdlUm91dGVGdWxsPFJvdXRlPlxuXHQpOiBib29sZWFuO1xuXG5cdC8qKlxuXHQgKiBDYWxsZWQgYmVmb3JlIHBhZ2Ugb3Blbi5cblx0ICpcblx0ICogQHBhcmFtIGNvbnRleHRcblx0ICogQHBhcmFtIHJvdXRlXG5cdCAqL1xuXHRvbk9wZW4/KGNvbnRleHQ6IE9XZWJSb3V0ZUNvbnRleHQsIHJvdXRlOiBPUGFnZVJvdXRlRnVsbDxSb3V0ZT4pOiB2b2lkO1xuXG5cdC8qKlxuXHQgKiBDYWxsZWQgYmVmb3JlIHBhZ2UgY2xvc2UuXG5cdCAqXG5cdCAqIEBwYXJhbSBvbGRSb3V0ZVxuXHQgKiBAcGFyYW0gbmV3Um91dGVcblx0ICovXG5cdG9uQ2xvc2U/KFxuXHRcdG9sZFJvdXRlOiBPUGFnZVJvdXRlRnVsbDxSb3V0ZT4sXG5cdFx0bmV3Um91dGU6IE9QYWdlUm91dGVGdWxsPFJvdXRlPlxuXHQpOiB2b2lkO1xufVxuXG5jb25zdCB3RG9jID0gd2luZG93LmRvY3VtZW50O1xubGV0IHJvdXRlSWQgPSAwO1xuY29uc3QgX2lzUGFyZW50T2YgPSAoXG5cdHBhcmVudDogT1BhZ2VSb3V0ZUZ1bGwsXG5cdHJvdXRlOiBPUGFnZVJvdXRlRnVsbFxuKTogYm9vbGVhbiA9PiB7XG5cdGxldCBwO1xuXHR3aGlsZSAoKHAgPSByb3V0ZS5wYXJlbnQpKSB7XG5cdFx0aWYgKHAgPT09IHBhcmVudCkge1xuXHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0fVxuXG5cdFx0cm91dGUgPSBwO1xuXHR9XG5cdHJldHVybiBmYWxzZTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJQYWdlcjxcblx0UCBleHRlbmRzIE9QYWdlPFI+LFxuXHRSIGV4dGVuZHMgT1BhZ2VSb3V0ZSA9IE9QYWdlUm91dGVcbj4gZXh0ZW5kcyBPV2ViRXZlbnQge1xuXHRzdGF0aWMgcmVhZG9ubHkgU0VMRiA9IGlkKCk7XG5cdHN0YXRpYyByZWFkb25seSBFVlRfUEFHRV9MT0NBVElPTl9DSEFOR0UgPSBpZCgpO1xuXG5cdHByaXZhdGUgcmVhZG9ubHkgX3BhZ2VzOiBSZWNvcmQ8c3RyaW5nLCBQPiA9IHt9O1xuXHRwcml2YXRlIF9yb3V0ZXNDYWNoZTogT1BhZ2VSb3V0ZUZ1bGw8Uj5bXSA9IFtdO1xuXHRwcml2YXRlIF9yb3V0ZXNGbGF0dGVuZWQ6IE9QYWdlUm91dGVGdWxsPFI+W10gPSBbXTtcblx0cHJpdmF0ZSBfYWN0aXZlUGFnZT86IFA7XG5cdHByaXZhdGUgX2FjdGl2ZVJvdXRlPzogT1BhZ2VSb3V0ZUZ1bGw8Uj47XG5cblx0LyoqXG5cdCAqIEBwYXJhbSBfYXBwQ29udGV4dCBUaGUgYXBwIGNvbnRleHQuXG5cdCAqL1xuXHRjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IF9hcHBDb250ZXh0OiBPV2ViQXBwKSB7XG5cdFx0c3VwZXIoKTtcblx0XHRsb2dnZXIuaW5mbygnW09XZWJQYWdlcl0gcmVhZHkhJyk7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyByZWdpc3RlcmVkIHBhZ2VzIHJvdXRlcy5cblx0ICovXG5cdGdldFJvdXRlcygpOiBPUGFnZVJvdXRlRnVsbDxSPltdIHtcblx0XHRyZXR1cm4gWy4uLnRoaXMuX3JvdXRlc0NhY2hlXTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHRoZSBwYWdlIHdpdGggdGhlIGdpdmVuIG5hbWUuXG5cdCAqIEBwYXJhbSBuYW1lXG5cdCAqL1xuXHRnZXRQYWdlKG5hbWU6IHN0cmluZyk6IFAge1xuXHRcdGNvbnN0IHBhZ2U6IFAgPSB0aGlzLl9wYWdlc1tuYW1lXTtcblx0XHRpZiAodW5kZWZpbmVkID09PSBwYWdlKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYFtPV2ViUGFnZXJdIHRoZSBwYWdlIFwiJHtuYW1lfVwiIGlzIG5vdCBkZWZpbmVkLmApO1xuXHRcdH1cblxuXHRcdHJldHVybiBwYWdlO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgdGhlIGFjdGl2ZSBwYWdlLlxuXHQgKi9cblx0Z2V0QWN0aXZlUGFnZSgpOiBQIHtcblx0XHRpZiAoIXRoaXMuX2FjdGl2ZVBhZ2UpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcignW09XZWJQYWdlcl0gbm8gYWN0aXZlIHBhZ2UuJyk7XG5cdFx0fVxuXHRcdHJldHVybiB0aGlzLl9hY3RpdmVQYWdlO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgdGhlIGFjdGl2ZSBwYWdlIHJvdXRlLlxuXHQgKi9cblx0Z2V0QWN0aXZlUGFnZVJvdXRlKCk6IE9QYWdlUm91dGVGdWxsPFI+IHtcblx0XHRpZiAoIXRoaXMuX2FjdGl2ZVJvdXRlKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ1tPV2ViUGFnZXJdIG5vIGFjdGl2ZSByb3V0ZS4nKTtcblx0XHR9XG5cdFx0cmV0dXJuIHRoaXMuX2FjdGl2ZVJvdXRlO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgYWxsIHBhZ2VzIGxpc3QuXG5cdCAqL1xuXHRnZXRQYWdlTGlzdCgpOiBSZWNvcmQ8c3RyaW5nLCBQPiB7XG5cdFx0cmV0dXJuIHsgLi4udGhpcy5fcGFnZXMgfTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZWdpc3RlciBhIGdpdmVuIHBhZ2UuXG5cdCAqXG5cdCAqIEBwYXJhbSBwYWdlXG5cdCAqL1xuXHRyZWdpc3RlclBhZ2UocGFnZTogUCk6IHRoaXMge1xuXHRcdGNvbnN0IG5hbWUgPSBwYWdlLm5hbWU7XG5cblx0XHRpZiAobmFtZSBpbiB0aGlzLl9wYWdlcykge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBbT1dlYlBhZ2VyXSBwYWdlIFwiJHtuYW1lfVwiIGFscmVhZHkgcmVnaXN0ZXJlZC5gKTtcblx0XHR9XG5cblx0XHRwYWdlLmluc3RhbGwgJiYgcGFnZS5pbnN0YWxsKHRoaXMpO1xuXG5cdFx0dGhpcy5fcGFnZXNbbmFtZV0gPSBwYWdlO1xuXHRcdGNvbnN0IHJvdXRlcyA9IHBhZ2Uucm91dGVzO1xuXG5cdFx0dGhpcy5fcm91dGVzQ2FjaGUucHVzaCguLi4ocm91dGVzIGFzIGFueVtdKSk7XG5cblx0XHRyZXR1cm4gdGhpcy5fcmVnaXN0ZXJQYWdlUm91dGVzKHBhZ2UsIHJvdXRlcyk7XG5cdH1cblxuXHQvKipcblx0ICogSGVscGVycyB0byByZWdpc3RlciBwYWdlIHJvdXRlcy5cblx0ICpcblx0ICogQHBhcmFtIHBhZ2UgVGhlIHBhZ2UuXG5cdCAqIEBwYXJhbSByb3V0ZXMgVGhlIHBhZ2Ugcm91dGVzIGxpc3QuXG5cdCAqIEBwYXJhbSBwYXJlbnQgVGhlIHBhZ2Ugcm91dGVzIHBhcmVudC5cblx0ICogQHByaXZhdGVcblx0ICovXG5cdHByaXZhdGUgX3JlZ2lzdGVyUGFnZVJvdXRlcyhcblx0XHRwYWdlOiBQLFxuXHRcdHJvdXRlczogUltdLFxuXHRcdHBhcmVudD86IE9QYWdlUm91dGVGdWxsPFI+XG5cdCk6IHRoaXMge1xuXHRcdGNvbnN0IHJvdXRlcjogT1dlYlJvdXRlciA9IHRoaXMuX2FwcENvbnRleHQucm91dGVyO1xuXG5cdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCByb3V0ZXMubGVuZ3RoOyBpKyspIHtcblx0XHRcdGNvbnN0IHJvdXRlOiBhbnkgPSByb3V0ZXNbaV07XG5cblx0XHRcdGlmICghcm91dGUuaWQpIHtcblx0XHRcdFx0cm91dGUuaWQgPSArK3JvdXRlSWQ7XG5cdFx0XHRcdHJvdXRlLnBhcmVudCA9IHBhcmVudDtcblx0XHRcdFx0cm91dGUucGF0aE9wdGlvbnMgPSByb3V0ZS5wYXRoT3B0aW9ucyB8fCB7fTtcblx0XHRcdFx0cm91dGUuY2hpbGRyZW4gPSByb3V0ZS5jaGlsZHJlbiB8fCBbXTtcblx0XHRcdFx0cm91dGUuYWN0aXZlID0gZmFsc2U7XG5cdFx0XHRcdHJvdXRlLmFjdGl2ZUNoaWxkID0gZmFsc2U7XG5cblx0XHRcdFx0Y29uc3Qgd2ViUm91dGUgPSAocm91dGUud2ViUm91dGUgPSB0aGlzLl9hZGRSb3V0ZShyb3V0ZSwgcGFnZSkpO1xuXHRcdFx0XHRpZiAoIXdlYlJvdXRlLmlzRHluYW1pYygpKSB7XG5cdFx0XHRcdFx0cm91dGUuaHJlZiA9IHJvdXRlci5wYXRoVG9VUkwocm91dGUucGF0aCkuaHJlZjtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGlmICghKCdzaG93JyBpbiByb3V0ZSkpIHtcblx0XHRcdFx0XHRyb3V0ZS5zaG93ID0gdHJ1ZTtcblx0XHRcdFx0fVxuXHRcdFx0XHRpZiAoISgnc2hvd0NoaWxkcmVuJyBpbiByb3V0ZSkpIHtcblx0XHRcdFx0XHRyb3V0ZS5zaG93Q2hpbGRyZW4gPSB0cnVlO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGlmICghKCdkaXNhYmxlZCcgaW4gcm91dGUpKSB7XG5cdFx0XHRcdFx0cm91dGUuZGlzYWJsZWQgPSBmYWxzZTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdHRoaXMuX3JvdXRlc0ZsYXR0ZW5lZC5wdXNoKHJvdXRlKTtcblxuXHRcdFx0XHRpZiAocm91dGUuY2hpbGRyZW4ubGVuZ3RoKSB7XG5cdFx0XHRcdFx0dGhpcy5fcmVnaXN0ZXJQYWdlUm91dGVzKHBhZ2UsIHJvdXRlLmNoaWxkcmVuLCByb3V0ZSk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdC8qKlxuXHQgKiBIZWxwZXIgdG8gYWRkIHJvdXRlLlxuXHQgKlxuXHQgKiBAcGFyYW0gcm91dGUgVGhlIHJvdXRlIG9iamVjdC5cblx0ICogQHBhcmFtIHBhZ2UgVGhlIHBhZ2UgdG8gd2hpY2ggdGhhdCByb3V0ZSBiZWxvbmdzIHRvLlxuXHQgKiBAcHJpdmF0ZVxuXHQgKi9cblx0cHJpdmF0ZSBfYWRkUm91dGUocm91dGU6IE9QYWdlUm91dGVGdWxsPFI+LCBwYWdlOiBQKTogT1dlYlJvdXRlIHtcblx0XHRjb25zdCB3ZWJSb3V0ZSA9IG5ldyBPV2ViUm91dGUoXG5cdFx0XHRyb3V0ZS5wYXRoLFxuXHRcdFx0cm91dGUucGF0aE9wdGlvbnMsXG5cdFx0XHQocm91dGVDb250ZXh0OiBPV2ViUm91dGVDb250ZXh0KSA9PiB7XG5cdFx0XHRcdGxvZ2dlci5kZWJ1ZygnW09XZWJQYWdlcl0gcGFnZSByb3V0ZSBtYXRjaCcsIHJvdXRlLCBwYWdlLCByb3V0ZUNvbnRleHQpO1xuXG5cdFx0XHRcdGlmIChcblx0XHRcdFx0XHRwYWdlLnJlcXVpcmVMb2dpbiAmJlxuXHRcdFx0XHRcdHBhZ2UucmVxdWlyZUxvZ2luKHJvdXRlQ29udGV4dCwgcm91dGUpICYmXG5cdFx0XHRcdFx0IXRoaXMuX2FwcENvbnRleHQudXNlci51c2VyVmVyaWZpZWQoKVxuXHRcdFx0XHQpIHtcblx0XHRcdFx0XHRyZXR1cm4gKFxuXHRcdFx0XHRcdFx0cm91dGVDb250ZXh0LnN0b3AoKSAmJlxuXHRcdFx0XHRcdFx0dGhpcy5fYXBwQ29udGV4dC5zaG93TG9naW5QYWdlKHtcblx0XHRcdFx0XHRcdFx0bmV4dDogcm91dGVDb250ZXh0LmdldFBhdGgoKSxcblx0XHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGlmIChyb3V0ZS5kaXNhYmxlZCkge1xuXHRcdFx0XHRcdHJldHVybiByb3V0ZUNvbnRleHQuc3RvcCgpICYmIHRoaXMuX2FwcENvbnRleHQuc2hvd0hvbWVQYWdlKCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRjb25zdCBhciA9IHRoaXMuX2FjdGl2ZVJvdXRlLFxuXHRcdFx0XHRcdGFwID0gdGhpcy5fYWN0aXZlUGFnZTtcblxuXHRcdFx0XHRhcCAmJiBhciAmJiBhcC5vbkNsb3NlICYmIGFwLm9uQ2xvc2UoYXIsIHJvdXRlKTtcblxuXHRcdFx0XHRwYWdlLm9uT3BlbiAmJiBwYWdlLm9uT3Blbihyb3V0ZUNvbnRleHQsIHJvdXRlKTtcblxuXHRcdFx0XHQhcm91dGVDb250ZXh0LnN0b3BwZWQoKSAmJiB0aGlzLl9zZXRBY3RpdmUocGFnZSwgcm91dGUpO1xuXHRcdFx0fVxuXHRcdCk7XG5cblx0XHR0aGlzLl9hcHBDb250ZXh0LnJvdXRlci5hZGRSb3V0ZSh3ZWJSb3V0ZSk7XG5cblx0XHRyZXR1cm4gd2ViUm91dGU7XG5cdH1cblxuXHQvKipcblx0ICogSGVscGVyIHRvIHNldCB0aGUgYWN0aXZlIHJvdXRlLlxuXHQgKlxuXHQgKiBAcGFyYW0gcGFnZVxuXHQgKiBAcGFyYW0gcm91dGVcblx0ICogQHByaXZhdGVcblx0ICovXG5cdHByaXZhdGUgX3NldEFjdGl2ZShwYWdlOiBQLCByb3V0ZTogT1BhZ2VSb3V0ZUZ1bGw8Uj4pOiB0aGlzIHtcblx0XHRjb25zdCBvbGRQYWdlID0gdGhpcy5fYWN0aXZlUGFnZSxcblx0XHRcdG9sZFJvdXRlID0gdGhpcy5fYWN0aXZlUm91dGUsXG5cdFx0XHRhcHAgPSB0aGlzLl9hcHBDb250ZXh0O1xuXG5cdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLl9yb3V0ZXNGbGF0dGVuZWQubGVuZ3RoOyBpKyspIHtcblx0XHRcdGNvbnN0IGMgPSB0aGlzLl9yb3V0ZXNGbGF0dGVuZWRbaV07XG5cblx0XHRcdGMuYWN0aXZlID0gcm91dGUuaWQgPT09IGMuaWQ7XG5cdFx0XHRjLmFjdGl2ZUNoaWxkID0gIWMuYWN0aXZlICYmIF9pc1BhcmVudE9mKGMsIHJvdXRlKTtcblx0XHR9XG5cblx0XHR0aGlzLl9hY3RpdmVQYWdlID0gcGFnZTtcblx0XHR0aGlzLl9hY3RpdmVSb3V0ZSA9IHJvdXRlO1xuXHRcdHdEb2MudGl0bGUgPSBhcHAuaTE4bi50b0h1bWFuKHJvdXRlLnRpdGxlID8gcm91dGUudGl0bGUgOiBhcHAuZ2V0QXBwTmFtZSgpKTtcblxuXHRcdGNvbnN0IGluZm86IGFueSA9IHtcblx0XHRcdHBhZ2UsXG5cdFx0XHRvbGRQYWdlLFxuXHRcdFx0cm91dGUsXG5cdFx0XHRvbGRSb3V0ZSxcblx0XHRcdHNhbWVQYWdlOiBvbGRQYWdlID09PSBwYWdlLFxuXHRcdH07XG5cblx0XHRsb2dnZXIuZGVidWcoJ1tPV2ViUGFnZXJdIGxvY2F0aW9uIGluZm8nLCBpbmZvKTtcblxuXHRcdHRoaXMudHJpZ2dlcihPV2ViUGFnZXIuRVZUX1BBR0VfTE9DQVRJT05fQ0hBTkdFLCBbcm91dGUsIHBhZ2VdKTtcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0b25Mb2NhdGlvbkNoYW5nZShoYW5kbGVyOiAocm91dGU6IE9QYWdlUm91dGVGdWxsPFI+LCBwYWdlOiBQKSA9PiB2b2lkKTogdGhpcyB7XG5cdFx0cmV0dXJuIHRoaXMub24oT1dlYlBhZ2VyLkVWVF9QQUdFX0xPQ0FUSU9OX0NIQU5HRSwgaGFuZGxlcik7XG5cdH1cbn1cbiJdfQ==