import OWebEvent from "./OWebEvent";
import OWebLang from "./OWebLang";
import Utils from "./utils/Utils";
const wDoc = window.document;
let routeId = 0, _isParentOf = (parent, route) => {
    let p;
    while (p = route.parent) {
        if (p === parent) {
            return true;
        }
        route = p;
    }
    return false;
};
export default class OWebPager extends OWebEvent {
    constructor(app_context) {
        super();
        this.app_context = app_context;
        this._pages = {};
        this._routes_cache = [];
        this._routes_flattened = [];
        console.log("[OWebPager] ready!");
    }
    getRoutes() {
        return this._routes_cache;
    }
    getPage(name) {
        let page = this._pages[name];
        if (undefined === page) {
            throw new Error(`[OWebPager] the page "${name}" is not defined.`);
        }
        return page;
    }
    getActivePage() {
        if (!this._active_page) {
            throw new Error("[OWebPager] no active page.");
        }
        return this._active_page;
    }
    getActivePageRoute() {
        if (!this._active_route) {
            throw new Error("[OWebPager] no active route.");
        }
        return this._active_route;
    }
    getPageList() {
        return Object.create(this._pages);
    }
    registerPage(page) {
        let name = page.getName();
        if (name in this._pages) {
            throw new Error(`[OWebPager] page "${name}" already registered.`);
        }
        this._pages[name] = page.install(this);
        let routes = page.getRoutes();
        this._routes_cache.push(...routes);
        return this._registerPageRoutes(page, routes);
    }
    _registerPageRoutes(page, routes, parent) {
        let router = this.app_context.router;
        for (let i = 0; i < routes.length; i++) {
            let route = routes[i];
            route.id = ++routeId;
            route.parent = parent;
            route.href = router.pathToURL(typeof route.path === "string" ? route.path : "/").href;
            route.active = false;
            route.active_child = false;
            route.show = route.show || function () {
                return true;
            };
            this._routes_flattened.push(route);
            this._addRoute(route, page);
            if (route.sub && route.sub.length) {
                this._registerPageRoutes(page, route.sub, route);
            }
        }
        return this;
    }
    _addRoute(route, page) {
        let ctx = this;
        this.app_context.router.on(route.path, route.pathOptions, (routeContext) => {
            console.log("[OWebPager] page route match ->", route, page, routeContext);
            if (page.requireLogin(routeContext, route) && !ctx.app_context.userVerified()) {
                return routeContext.stop() && ctx.app_context.showLoginPage();
            }
            let ar = ctx._active_route, ap = ctx._active_page;
            ap && ar && ap.onClose(ar, route);
            page.onOpen(routeContext, route);
            !routeContext.stopped() && ctx._setActivePage(page)._setActiveRoute(route);
        });
        return this;
    }
    _setActiveRoute(route) {
        let list = this._routes_flattened;
        for (let i = 0; i < list.length; i++) {
            let c = list[i];
            c.active = route.id === c.id;
            c.active_child = !c.active && _isParentOf(c, route);
        }
        wDoc.title = OWebLang.toHuman(route.title.length ? route.title : this.app_context.getAppName());
        this._active_route = route;
        console.log(`[OWebPager] active route ->`, this._active_route);
        return this;
    }
    _setActivePage(newPage) {
        let oldPage = this._active_page;
        if (oldPage !== newPage) {
            console.log(`[OWebPager] page changing ->`, newPage, oldPage);
            this._active_page = newPage;
            this.trigger(OWebPager.EVT_PAGE_CHANGE, [oldPage, newPage]);
        }
        else {
            console.log(`[OWebPager] same page ->`, oldPage, newPage);
        }
        return this;
    }
}
OWebPager.SELF = Utils.id();
OWebPager.EVT_PAGE_CHANGE = Utils.id();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlBhZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL09XZWJQYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLFNBQVMsTUFBTSxhQUFhLENBQUM7QUFDcEMsT0FBTyxRQUFRLE1BQU0sWUFBWSxDQUFDO0FBRWxDLE9BQU8sS0FBSyxNQUFNLGVBQWUsQ0FBQztBQXNDbEMsTUFBTSxJQUFJLEdBQVUsTUFBTSxDQUFDLFFBQVEsQ0FBQztBQUNwQyxJQUFJLE9BQU8sR0FBUyxDQUFDLEVBQ2xCLFdBQVcsR0FBRyxDQUFDLE1BQXNCLEVBQUUsS0FBcUIsRUFBVyxFQUFFO0lBQ3hFLElBQUksQ0FBQyxDQUFDO0lBQ04sT0FBTyxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU8sRUFBRTtRQUN6QixJQUFJLENBQUMsS0FBSyxNQUFNLEVBQUU7WUFDakIsT0FBTyxJQUFJLENBQUM7U0FDWjtRQUVELEtBQUssR0FBRyxDQUFDLENBQUM7S0FDVjtJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2QsQ0FBQyxDQUFDO0FBRUwsTUFBTSxDQUFDLE9BQU8sZ0JBQWlCLFNBQVEsU0FBUztJQVUvQyxZQUE2QixXQUFvQjtRQUNoRCxLQUFLLEVBQUUsQ0FBQztRQURvQixnQkFBVyxHQUFYLFdBQVcsQ0FBUztRQU5oQyxXQUFNLEdBQTZCLEVBQUUsQ0FBQztRQUUvQyxrQkFBYSxHQUErQixFQUFFLENBQUM7UUFDL0Msc0JBQWlCLEdBQTJCLEVBQUUsQ0FBQztRQUt0RCxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVELFNBQVM7UUFDUixPQUFPLElBQUksQ0FBQyxhQUFhLENBQUM7SUFDM0IsQ0FBQztJQUVELE9BQU8sQ0FBQyxJQUFZO1FBQ25CLElBQUksSUFBSSxHQUFVLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDcEMsSUFBSSxTQUFTLEtBQUssSUFBSSxFQUFFO1lB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IjpbImltcG9ydCB7VnVlQ29uc3RydWN0b3J9IGZyb20gXCJ2dWUvdHlwZXMvdnVlXCI7XG5pbXBvcnQgT1dlYkFwcCBmcm9tIFwiLi9PV2ViQXBwXCI7XG5pbXBvcnQgT1dlYkV2ZW50IGZyb20gXCIuL09XZWJFdmVudFwiO1xuaW1wb3J0IE9XZWJMYW5nIGZyb20gXCIuL09XZWJMYW5nXCI7XG5pbXBvcnQgT1dlYlJvdXRlciwge09XZWJSb3V0ZUNvbnRleHQsIHRSb3V0ZVBhdGgsIHRSb3V0ZVBhdGhPcHRpb25zfSBmcm9tIFwiLi9PV2ViUm91dGVyXCI7XG5pbXBvcnQgVXRpbHMgZnJvbSBcIi4vdXRpbHMvVXRpbHNcIjtcblxuZXhwb3J0IHR5cGUgdFBhZ2VSb3V0ZSA9IHtcblx0c2x1Zz86IHN0cmluZyxcblx0dGl0bGU6IHN0cmluZyxcblx0ZGVzY3JpcHRpb24/OiBzdHJpbmcsXG5cdGljb24/OiBzdHJpbmcsXG5cdHBhdGg6IHRSb3V0ZVBhdGgsXG5cdHBhdGhPcHRpb25zPzogdFJvdXRlUGF0aE9wdGlvbnMsXG5cdHN1Yj86IHRQYWdlUm91dGVbXSxcblx0c2hvdz8oKTogYm9vbGVhblxufTtcblxuZXhwb3J0IHR5cGUgdFBhZ2VSb3V0ZUZ1bGwgPSB0UGFnZVJvdXRlICYge1xuXHRyZWFkb25seSBpZDogbnVtYmVyLFxuXHRyZWFkb25seSBocmVmOiBzdHJpbmcsXG5cdHJlYWRvbmx5IHBhcmVudD86IHRQYWdlUm91dGVGdWxsLFxuXHRhY3RpdmU6IGJvb2xlYW4sXG5cdGFjdGl2ZV9jaGlsZDogYm9vbGVhbixcblx0c2hvdygpOiBib29sZWFuXG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIGlQYWdlIHtcblx0Z2V0TmFtZSgpOiBzdHJpbmc7XG5cblx0Z2V0Um91dGVzKCk6IHRQYWdlUm91dGVbXTtcblxuXHRpbnN0YWxsKHBhZ2VyOiBPV2ViUGFnZXIpOiB0aGlzO1xuXG5cdGNvbXBvbmVudCgpOiBWdWVDb25zdHJ1Y3RvciB8IHVuZGVmaW5lZCxcblxuXHRyZXF1aXJlTG9naW4oY29udGV4dDogT1dlYlJvdXRlQ29udGV4dCwgcm91dGU6IHRQYWdlUm91dGVGdWxsKTogYm9vbGVhbixcblxuXHRvbk9wZW4oY29udGV4dDogT1dlYlJvdXRlQ29udGV4dCwgcm91dGU6IHRQYWdlUm91dGVGdWxsKTogdm9pZCxcblxuXHRvbkNsb3NlKG9sZFJvdXRlOiB0UGFnZVJvdXRlRnVsbCwgbmV3Um91dGU6IHRQYWdlUm91dGVGdWxsKTogdm9pZFxufVxuXG5jb25zdCB3RG9jICAgICAgICA9IHdpbmRvdy5kb2N1bWVudDtcbmxldCByb3V0ZUlkICAgICAgID0gMCxcblx0ICBfaXNQYXJlbnRPZiA9IChwYXJlbnQ6IHRQYWdlUm91dGVGdWxsLCByb3V0ZTogdFBhZ2VSb3V0ZUZ1bGwpOiBib29sZWFuID0+IHtcblx0XHQgIGxldCBwO1xuXHRcdCAgd2hpbGUgKHAgPSByb3V0ZS5wYXJlbnQhKSB7XG5cdFx0XHQgIGlmIChwID09PSBwYXJlbnQpIHtcblx0XHRcdFx0ICByZXR1cm4gdHJ1ZTtcblx0XHRcdCAgfVxuXG5cdFx0XHQgIHJvdXRlID0gcDtcblx0XHQgIH1cblx0XHQgIHJldHVybiBmYWxzZTtcblx0ICB9O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViUGFnZXIgZXh0ZW5kcyBPV2ViRXZlbnQge1xuXHRzdGF0aWMgcmVhZG9ubHkgU0VMRiAgICAgICAgICAgID0gVXRpbHMuaWQoKTtcblx0c3RhdGljIHJlYWRvbmx5IEVWVF9QQUdFX0NIQU5HRSA9IFV0aWxzLmlkKCk7XG5cblx0cHJpdmF0ZSByZWFkb25seSBfcGFnZXM6IHsgW2tleTogc3RyaW5nXTogaVBhZ2UgfSA9IHt9O1xuXHRwcml2YXRlIF9hY3RpdmVfcGFnZTogaVBhZ2UgfCB1bmRlZmluZWQ7XG5cdHByaXZhdGUgX3JvdXRlc19jYWNoZTogdFBhZ2VSb3V0ZVtdICAgICAgICAgICAgICAgPSBbXTtcblx0cHJpdmF0ZSBfcm91dGVzX2ZsYXR0ZW5lZDogdFBhZ2VSb3V0ZUZ1bGxbXSAgICAgICA9IFtdO1xuXHRwcml2YXRlIF9hY3RpdmVfcm91dGU/OiB0UGFnZVJvdXRlRnVsbDtcblxuXHRjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGFwcF9jb250ZXh0OiBPV2ViQXBwKSB7XG5cdFx0c3VwZXIoKTtcblx0XHRjb25zb2xlLmxvZyhcIltPV2ViUGFnZXJdIHJlYWR5IVwiKTtcblx0fVxuXG5cdGdldFJvdXRlcygpOiB0UGFnZVJvdXRlW10ge1xuXHRcdHJldHVybiB0aGlzLl9yb3V0ZXNfY2FjaGU7XG5cdH1cblxuXHRnZXRQYWdlKG5hbWU6IHN0cmluZyk6IGlQYWdlIHtcblx0XHRsZXQgcGFnZTogaVBhZ2UgPSB0aGlzLl9wYWdlc1tuYW1lXTtcblx0XHRpZiAodW5kZWZpbmVkID09PSBwYWdlKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYFtPV2ViUGFnZXJdIHRoZSBwYWdlIFwiJHtuYW1lfVwiIGlzIG5vdCBkZWZpbmVkLmApO1xuXHRcdH1cblxuXHRcdHJldHVybiBwYWdlO1xuXHR9XG5cblx0Z2V0QWN0aXZlUGFnZSgpOiBpUGFnZSB7XG5cdFx0aWYgKCF0aGlzLl9hY3RpdmVfcGFnZSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFwiW09XZWJQYWdlcl0gbm8gYWN0aXZlIHBhZ2UuXCIpO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcy5fYWN0aXZlX3BhZ2U7XG5cdH1cblxuXHRnZXRBY3RpdmVQYWdlUm91dGUoKTogdFBhZ2VSb3V0ZUZ1bGwge1xuXHRcdGlmICghdGhpcy5fYWN0aXZlX3JvdXRlKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoXCJbT1dlYlBhZ2VyXSBubyBhY3RpdmUgcm91dGUuXCIpO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcy5fYWN0aXZlX3JvdXRlO1xuXHR9XG5cblx0Z2V0UGFnZUxpc3QoKSB7XG5cdFx0cmV0dXJuIE9iamVjdC5jcmVhdGUodGhpcy5fcGFnZXMpO1xuXHR9XG5cblx0cmVnaXN0ZXJQYWdlKHBhZ2U6IGlQYWdlKTogdGhpcyB7XG5cdFx0bGV0IG5hbWUgPSBwYWdlLmdldE5hbWUoKTtcblxuXHRcdGlmIChuYW1lIGluIHRoaXMuX3BhZ2VzKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYFtPV2ViUGFnZXJdIHBhZ2UgXCIke25hbWV9XCIgYWxyZWFkeSByZWdpc3RlcmVkLmApO1xuXHRcdH1cblxuXHRcdHRoaXMuX3BhZ2VzW25hbWVdID0gcGFnZS5pbnN0YWxsKHRoaXMpO1xuXHRcdGxldCByb3V0ZXMgICAgICAgID0gcGFnZS5nZXRSb3V0ZXMoKTtcblxuXHRcdHRoaXMuX3JvdXRlc19jYWNoZS5wdXNoKC4uLnJvdXRlcyk7XG5cblx0XHRyZXR1cm4gdGhpcy5fcmVnaXN0ZXJQYWdlUm91dGVzKHBhZ2UsIHJvdXRlcyk7XG5cdH1cblxuXHRwcml2YXRlIF9yZWdpc3RlclBhZ2VSb3V0ZXMocGFnZTogaVBhZ2UsIHJvdXRlczogdFBhZ2VSb3V0ZVtdLCBwYXJlbnQ/OiB0UGFnZVJvdXRlRnVsbCk6IHRoaXMge1xuXG5cdFx0bGV0IHJvdXRlcjogT1dlYlJvdXRlciA9IHRoaXMuYXBwX2NvbnRleHQucm91dGVyO1xuXG5cdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCByb3V0ZXMubGVuZ3RoOyBpKyspIHtcblx0XHRcdGxldCByb3V0ZTogYW55ID0gcm91dGVzW2ldO1xuXG5cdFx0XHRyb3V0ZS5pZCAgICAgICAgICAgPSArK3JvdXRlSWQ7XG5cdFx0XHRyb3V0ZS5wYXJlbnQgICAgICAgPSBwYXJlbnQ7XG5cdFx0XHRyb3V0ZS5ocmVmICAgICAgICAgPSByb3V0ZXIucGF0aFRvVVJMKHR5cGVvZiByb3V0ZS5wYXRoID09PSBcInN0cmluZ1wiID8gcm91dGUucGF0aCA6IFwiL1wiKS5ocmVmO1xuXHRcdFx0cm91dGUuYWN0aXZlICAgICAgID0gZmFsc2U7XG5cdFx0XHRyb3V0ZS5hY3RpdmVfY2hpbGQgPSBmYWxzZTtcblxuXHRcdFx0cm91dGUuc2hvdyA9IHJvdXRlLnNob3cgfHwgZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHRcdH07XG5cblx0XHRcdHRoaXMuX3JvdXRlc19mbGF0dGVuZWQucHVzaChyb3V0ZSk7XG5cblx0XHRcdHRoaXMuX2FkZFJvdXRlKHJvdXRlLCBwYWdlKTtcblxuXHRcdFx0aWYgKHJvdXRlLnN1YiAmJiByb3V0ZS5zdWIubGVuZ3RoKSB7XG5cdFx0XHRcdHRoaXMuX3JlZ2lzdGVyUGFnZVJvdXRlcyhwYWdlLCByb3V0ZS5zdWIsIHJvdXRlKTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHByaXZhdGUgX2FkZFJvdXRlKHJvdXRlOiB0UGFnZVJvdXRlRnVsbCwgcGFnZTogaVBhZ2UpOiB0aGlzIHtcblx0XHRsZXQgY3R4ID0gdGhpcztcblx0XHR0aGlzLmFwcF9jb250ZXh0LnJvdXRlci5vbihyb3V0ZS5wYXRoLCByb3V0ZS5wYXRoT3B0aW9ucywgKHJvdXRlQ29udGV4dDogT1dlYlJvdXRlQ29udGV4dCkgPT4ge1xuXHRcdFx0Y29uc29sZS5sb2coXCJbT1dlYlBhZ2VyXSBwYWdlIHJvdXRlIG1hdGNoIC0+XCIsIHJvdXRlLCBwYWdlLCByb3V0ZUNvbnRleHQpO1xuXG5cdFx0XHRpZiAocGFnZS5yZXF1aXJlTG9naW4ocm91dGVDb250ZXh0LCByb3V0ZSkgJiYgIWN0eC5hcHBfY29udGV4dC51c2VyVmVyaWZpZWQoKSkge1xuXHRcdFx0XHRyZXR1cm4gcm91dGVDb250ZXh0LnN0b3AoKSAmJiBjdHguYXBwX2NvbnRleHQuc2hvd0xvZ2luUGFnZSgpO1xuXHRcdFx0fVxuXG5cdFx0XHRsZXQgYXIgPSBjdHguX2FjdGl2ZV9yb3V0ZSwgYXAgPSBjdHguX2FjdGl2ZV9wYWdlO1xuXG5cdFx0XHRhcCAmJiBhciAmJiBhcC5vbkNsb3NlKGFyLCByb3V0ZSk7XG5cblx0XHRcdHBhZ2Uub25PcGVuKHJvdXRlQ29udGV4dCwgcm91dGUpO1xuXG5cdFx0XHQhcm91dGVDb250ZXh0LnN0b3BwZWQoKSAmJiBjdHguX3NldEFjdGl2ZVBhZ2UocGFnZSkuX3NldEFjdGl2ZVJvdXRlKHJvdXRlKTtcblx0XHR9KTtcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0cHJpdmF0ZSBfc2V0QWN0aXZlUm91dGUocm91dGU6IHRQYWdlUm91dGVGdWxsKTogdGhpcyB7XG5cdFx0bGV0IGxpc3QgPSB0aGlzLl9yb3V0ZXNfZmxhdHRlbmVkO1xuXG5cdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRsZXQgYyA9IGxpc3RbaV07XG5cblx0XHRcdGMuYWN0aXZlICAgICAgID0gcm91dGUuaWQgPT09IGMuaWQ7XG5cdFx0XHRjLmFjdGl2ZV9jaGlsZCA9ICFjLmFjdGl2ZSAmJiBfaXNQYXJlbnRPZihjLCByb3V0ZSk7XG5cdFx0fVxuXG5cdFx0d0RvYy50aXRsZSA9IE9XZWJMYW5nLnRvSHVtYW4ocm91dGUudGl0bGUubGVuZ3RoID8gcm91dGUudGl0bGUgOiB0aGlzLmFwcF9jb250ZXh0LmdldEFwcE5hbWUoKSk7XG5cblx0XHR0aGlzLl9hY3RpdmVfcm91dGUgPSByb3V0ZTtcblxuXHRcdGNvbnNvbGUubG9nKGBbT1dlYlBhZ2VyXSBhY3RpdmUgcm91dGUgLT5gLCB0aGlzLl9hY3RpdmVfcm91dGUpO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRwcml2YXRlIF9zZXRBY3RpdmVQYWdlKG5ld1BhZ2U6IGlQYWdlKTogdGhpcyB7XG5cdFx0bGV0IG9sZFBhZ2UgPSB0aGlzLl9hY3RpdmVfcGFnZTtcblxuXHRcdGlmIChvbGRQYWdlICE9PSBuZXdQYWdlKSB7XG5cdFx0XHRjb25zb2xlLmxvZyhgW09XZWJQYWdlcl0gcGFnZSBjaGFuZ2luZyAtPmAsIG5ld1BhZ2UsIG9sZFBhZ2UpO1xuXHRcdFx0dGhpcy5fYWN0aXZlX3BhZ2UgPSBuZXdQYWdlO1xuXHRcdFx0dGhpcy50cmlnZ2VyKE9XZWJQYWdlci5FVlRfUEFHRV9DSEFOR0UsIFtvbGRQYWdlLCBuZXdQYWdlXSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGNvbnNvbGUubG9nKGBbT1dlYlBhZ2VyXSBzYW1lIHBhZ2UgLT5gLCBvbGRQYWdlLCBuZXdQYWdlKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxufSJdfQ==