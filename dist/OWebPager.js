import OWebEvent from './OWebEvent';
import Utils from './utils/Utils';
const wDoc = window.document;
let routeId = 0, _isParentOf = (parent, route) => {
    let p;
    while ((p = route.parent)) {
        if (p === parent) {
            return true;
        }
        route = p;
    }
    return false;
};
export default class OWebPager extends OWebEvent {
    /**
     * @param app_context The app context.
     */
    constructor(app_context) {
        super();
        this.app_context = app_context;
        this._pages = {};
        this._routes_cache = [];
        this._routes_flattened = [];
        console.log('[OWebPager] ready!');
    }
    /**
     * Returns registered pages routes.
     */
    getRoutes() {
        return [...this._routes_cache];
    }
    /**
     * Returns the page with the given name.
     * @param name
     */
    getPage(name) {
        let page = this._pages[name];
        if (undefined === page) {
            throw new Error(`[OWebPager] the page "${name}" is not defined.`);
        }
        return page;
    }
    /**
     * Returns the active page.
     */
    getActivePage() {
        if (!this._active_page) {
            throw new Error('[OWebPager] no active page.');
        }
        return this._active_page;
    }
    /**
     * Returns the active page route.
     */
    getActivePageRoute() {
        if (!this._active_route) {
            throw new Error('[OWebPager] no active route.');
        }
        return this._active_route;
    }
    /**
     * Returns all pages list.
     */
    getPageList() {
        return { ...this._pages };
    }
    /**
     * Register a given page.
     *
     * @param page
     */
    registerPage(page) {
        let name = page.getName();
        if (name in this._pages) {
            throw new Error(`[OWebPager] page "${name}" already registered.`);
        }
        this._pages[name] = page.install(this);
        let routes = page.getRoutes();
        this._routes_cache.push(...routes);
        return this._registerPageRoutes(page, routes);
    }
    /**
     * Helpers to register page routes.
     *
     * @param page The page.
     * @param routes The page routes list.
     * @param parent The page routes parent.
     * @private
     */
    _registerPageRoutes(page, routes, parent) {
        let router = this.app_context.router;
        for (let i = 0; i < routes.length; i++) {
            let route = routes[i];
            route.id = ++routeId;
            route.parent = parent;
            route.href = router.pathToURL(typeof route.path === 'string' ? route.path : '/').href;
            route.active = false;
            route.activeChild = false;
            route.show =
                route.show ||
                    function () {
                        return true;
                    };
            this._routes_flattened.push(route);
            this._addRoute(route, page);
            if (route.sub && route.sub.length) {
                this._registerPageRoutes(page, route.sub, route);
            }
        }
        return this;
    }
    /**
     * Helper to add route.
     *
     * @param route The route object.
     * @param page The page to which that route belongs to.
     * @private
     */
    _addRoute(route, page) {
        let ctx = this;
        this.app_context.router.on(route.path, route.pathOptions, (routeContext) => {
            console.log('[OWebPager] page route match ->', route, page, routeContext);
            if (page.requireLogin(routeContext, route) &&
                !ctx.app_context.userVerified()) {
                return (routeContext.stop() && ctx.app_context.showLoginPage());
            }
            let ar = ctx._active_route, ap = ctx._active_page;
            ap && ar && ap.onClose(ar, route);
            page.onOpen(routeContext, route);
            !routeContext.stopped() && ctx._setActive(page, route);
        });
        return this;
    }
    /**
     * Helper to set the active route.
     *
     * @param page
     * @param route
     * @private
     */
    _setActive(page, route) {
        let oldPage = this._active_page, oldRoute = this._active_route, app = this.app_context;
        for (let i = 0; i < this._routes_flattened.length; i++) {
            let c = this._routes_flattened[i];
            c.active = route.id === c.id;
            c.activeChild = !c.active && _isParentOf(c, route);
        }
        this._active_page = page;
        this._active_route = route;
        wDoc.title = app.i18n.toHuman(route.title.length ? route.title : app.getAppName());
        let info = {
            page,
            oldPage,
            route,
            oldRoute,
            samePage: oldPage === page,
        };
        console.log('[OWebPager] info', info);
        this.trigger(OWebPager.EVT_PAGE_LOCATION_CHANGE, [route, page]);
        return this;
    }
    onLocationChange(handler) {
        return this.on(OWebPager.EVT_PAGE_LOCATION_CHANGE, handler);
    }
}
OWebPager.SELF = Utils.id();
OWebPager.EVT_PAGE_LOCATION_CHANGE = Utils.id();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlBhZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL09XZWJQYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLFNBQVMsTUFBTSxhQUFhLENBQUM7QUFNcEMsT0FBTyxLQUFLLE1BQU0sZUFBZSxDQUFDO0FBNEVsQyxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDO0FBQzdCLElBQUksT0FBTyxHQUFHLENBQUMsRUFDZCxXQUFXLEdBQUcsQ0FBQyxNQUFzQixFQUFFLEtBQXFCLEVBQVcsRUFBRTtJQUN4RSxJQUFJLENBQUMsQ0FBQztJQUNOLE9BQU8sQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU8sQ0FBQyxFQUFFO1FBQzNCLElBQUksQ0FBQyxLQUFLLE1BQU0sRUFBRTtZQUNqQixPQUFPLElBQUksQ0FBQztTQUNaO1FBRUQsS0FBSyxHQUFHLENBQUMsQ0FBQztLQUNWO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDZCxDQUFDLENBQUM7QUFFSCxNQUFNLENBQUMsT0FBTyxPQUFPLFNBQXFCLFNBQVEsU0FBUztJQVUxRDs7T0FFRztJQUNILFlBQTZCLFdBQW9CO1FBQ2hELEtBQUssRUFBRSxDQUFDO1FBRG9CLGdCQUFXLEdBQVgsV0FBVyxDQUFTO1FBVGhDLFdBQU0sR0FBd0MsRUFBRSxDQUFDO1FBQzFELGtCQUFhLEdBQWlCLEVBQUUsQ0FBQztRQUNqQyxzQkFBaUIsR0FBcUIsRUFBRSxDQUFDO1FBU2hELE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxTQUFTO1FBQ1IsT0FBTyxDQUFDLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFRDs7O09BR0c7SUFDSCxPQUFPLENBQUMsSUFBWTtRQUNuQixJQUFJLElBQUksR0FBcUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztR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QyxTQUFTLENBQUMsd0JBQXdCLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDN0QsQ0FBQzs7QUF2TmUsY0FBSSxHQUFHLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUNsQixrQ0FBd0IsR0FBRyxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT1dlYkFwcCBmcm9tICcuL09XZWJBcHAnO1xuaW1wb3J0IE9XZWJFdmVudCBmcm9tICcuL09XZWJFdmVudCc7XG5pbXBvcnQgT1dlYlJvdXRlciwge1xuXHRPV2ViUm91dGVDb250ZXh0LFxuXHR0Um91dGVQYXRoLFxuXHR0Um91dGVQYXRoT3B0aW9ucyxcbn0gZnJvbSAnLi9PV2ViUm91dGVyJztcbmltcG9ydCBVdGlscyBmcm9tICcuL3V0aWxzL1V0aWxzJztcblxuZXhwb3J0IGludGVyZmFjZSBpUGFnZVJvdXRlIHtcblx0c2x1Zz86IHN0cmluZztcblx0dGl0bGU6IHN0cmluZztcblx0ZGVzY3JpcHRpb24/OiBzdHJpbmc7XG5cdHBhdGg6IHRSb3V0ZVBhdGg7XG5cdHBhdGhPcHRpb25zPzogdFJvdXRlUGF0aE9wdGlvbnM7XG5cdHN1Yj86IGlQYWdlUm91dGVbXTtcblx0c2hvdz8oKTogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBpUGFnZVJvdXRlRnVsbCB7XG5cdHNsdWc/OiBzdHJpbmc7XG5cdHRpdGxlOiBzdHJpbmc7XG5cdGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuXHRwYXRoOiB0Um91dGVQYXRoO1xuXHRwYXRoT3B0aW9ucz86IHRSb3V0ZVBhdGhPcHRpb25zO1xuXHRzdWI/OiBpUGFnZVJvdXRlW107XG5cdHNob3coKTogYm9vbGVhbjtcblxuXHRyZWFkb25seSBpZDogbnVtYmVyO1xuXHRyZWFkb25seSBocmVmOiBzdHJpbmc7XG5cdHJlYWRvbmx5IHBhcmVudD86IGlQYWdlUm91dGVGdWxsO1xuXHRhY3RpdmU6IGJvb2xlYW47XG5cdGFjdGl2ZUNoaWxkOiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlQYWdlPENvbXBvbmVudD4ge1xuXHQvKipcblx0ICogVGhlIHBhZ2UgbmFtZSBnZXR0ZXIuXG5cdCAqL1xuXHRnZXROYW1lKCk6IHN0cmluZztcblxuXHQvKipcblx0ICogVGhlIHBhZ2Ugcm91dGVzIGdldHRlci5cblx0ICovXG5cdGdldFJvdXRlcygpOiBpUGFnZVJvdXRlW107XG5cblx0LyoqXG5cdCAqIFRoZSBwYWdlIGNvbXBvbmVudCBnZXR0ZXIuXG5cdCAqL1xuXHRnZXRDb21wb25lbnQoKTogQ29tcG9uZW50O1xuXG5cdC8qKlxuXHQgKiBDYWxsZWQgb25jZSB3aGVuIHJlZ2lzdGVyaW5nIHRoZSBwYWdlLlxuXHQgKlxuXHQgKiBAcGFyYW0gcGFnZXJcblx0ICovXG5cdGluc3RhbGwocGFnZXI6IE9XZWJQYWdlcjxDb21wb25lbnQ+KTogdGhpcztcblxuXHQvKipcblx0ICogRG9lcyB0aGlzIHBhZ2UgcmVxdWlyZSBhIHZlcmlmaWVkIHVzZXIgZm9yIHRoZSByZXF1ZXN0ZWQgcGFnZSByb3V0ZS5cblx0ICpcblx0ICogQHBhcmFtIGNvbnRleHQgVGhlIGFwcCBjb250ZXh0LlxuXHQgKiBAcGFyYW0gcm91dGUgVGhlIHJlcXVlc3QgcGFnZSByb3V0ZS5cblx0ICovXG5cdHJlcXVpcmVMb2dpbihjb250ZXh0OiBPV2ViUm91dGVDb250ZXh0LCByb3V0ZTogaVBhZ2VSb3V0ZUZ1bGwpOiBib29sZWFuO1xuXG5cdC8qKlxuXHQgKiBDYWxsZWQgYmVmb3JlIHBhZ2Ugb3Blbi5cblx0ICpcblx0ICogQHBhcmFtIGNvbnRleHRcblx0ICogQHBhcmFtIHJvdXRlXG5cdCAqL1xuXHRvbk9wZW4oY29udGV4dDogT1dlYlJvdXRlQ29udGV4dCwgcm91dGU6IGlQYWdlUm91dGVGdWxsKTogdm9pZDtcblxuXHQvKipcblx0ICogQ2FsbGVkIGJlZm9yZSBwYWdlIGNsb3NlLlxuXHQgKlxuXHQgKiBAcGFyYW0gb2xkUm91dGVcblx0ICogQHBhcmFtIG5ld1JvdXRlXG5cdCAqL1xuXHRvbkNsb3NlKG9sZFJvdXRlOiBpUGFnZVJvdXRlRnVsbCwgbmV3Um91dGU6IGlQYWdlUm91dGVGdWxsKTogdm9pZDtcbn1cblxuY29uc3Qgd0RvYyA9IHdpbmRvdy5kb2N1bWVudDtcbmxldCByb3V0ZUlkID0gMCxcblx0X2lzUGFyZW50T2YgPSAocGFyZW50OiBpUGFnZVJvdXRlRnVsbCwgcm91dGU6IGlQYWdlUm91dGVGdWxsKTogYm9vbGVhbiA9PiB7XG5cdFx0bGV0IHA7XG5cdFx0d2hpbGUgKChwID0gcm91dGUucGFyZW50ISkpIHtcblx0XHRcdGlmIChwID09PSBwYXJlbnQpIHtcblx0XHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0XHR9XG5cblx0XHRcdHJvdXRlID0gcDtcblx0XHR9XG5cdFx0cmV0dXJuIGZhbHNlO1xuXHR9O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViUGFnZXI8Q29tcG9uZW50PiBleHRlbmRzIE9XZWJFdmVudCB7XG5cdHN0YXRpYyByZWFkb25seSBTRUxGID0gVXRpbHMuaWQoKTtcblx0c3RhdGljIHJlYWRvbmx5IEVWVF9QQUdFX0xPQ0FUSU9OX0NIQU5HRSA9IFV0aWxzLmlkKCk7XG5cblx0cHJpdmF0ZSByZWFkb25seSBfcGFnZXM6IHsgW2tleTogc3RyaW5nXTogaVBhZ2U8Q29tcG9uZW50PiB9ID0ge307XG5cdHByaXZhdGUgX3JvdXRlc19jYWNoZTogaVBhZ2VSb3V0ZVtdID0gW107XG5cdHByaXZhdGUgX3JvdXRlc19mbGF0dGVuZWQ6IGlQYWdlUm91dGVGdWxsW10gPSBbXTtcblx0cHJpdmF0ZSBfYWN0aXZlX3BhZ2U6IGlQYWdlPENvbXBvbmVudD4gfCB1bmRlZmluZWQ7XG5cdHByaXZhdGUgX2FjdGl2ZV9yb3V0ZT86IGlQYWdlUm91dGVGdWxsO1xuXG5cdC8qKlxuXHQgKiBAcGFyYW0gYXBwX2NvbnRleHQgVGhlIGFwcCBjb250ZXh0LlxuXHQgKi9cblx0Y29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhcHBfY29udGV4dDogT1dlYkFwcCkge1xuXHRcdHN1cGVyKCk7XG5cdFx0Y29uc29sZS5sb2coJ1tPV2ViUGFnZXJdIHJlYWR5IScpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgcmVnaXN0ZXJlZCBwYWdlcyByb3V0ZXMuXG5cdCAqL1xuXHRnZXRSb3V0ZXMoKTogaVBhZ2VSb3V0ZVtdIHtcblx0XHRyZXR1cm4gWy4uLnRoaXMuX3JvdXRlc19jYWNoZV07XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgcGFnZSB3aXRoIHRoZSBnaXZlbiBuYW1lLlxuXHQgKiBAcGFyYW0gbmFtZVxuXHQgKi9cblx0Z2V0UGFnZShuYW1lOiBzdHJpbmcpOiBpUGFnZTxDb21wb25lbnQ+IHtcblx0XHRsZXQgcGFnZTogaVBhZ2U8Q29tcG9uZW50PiA9IHRoaXMuX3BhZ2VzW25hbWVdO1xuXHRcdGlmICh1bmRlZmluZWQgPT09IHBhZ2UpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihgW09XZWJQYWdlcl0gdGhlIHBhZ2UgXCIke25hbWV9XCIgaXMgbm90IGRlZmluZWQuYCk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHBhZ2U7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgYWN0aXZlIHBhZ2UuXG5cdCAqL1xuXHRnZXRBY3RpdmVQYWdlKCk6IGlQYWdlPENvbXBvbmVudD4ge1xuXHRcdGlmICghdGhpcy5fYWN0aXZlX3BhZ2UpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcignW09XZWJQYWdlcl0gbm8gYWN0aXZlIHBhZ2UuJyk7XG5cdFx0fVxuXHRcdHJldHVybiB0aGlzLl9hY3RpdmVfcGFnZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHRoZSBhY3RpdmUgcGFnZSByb3V0ZS5cblx0ICovXG5cdGdldEFjdGl2ZVBhZ2VSb3V0ZSgpOiBpUGFnZVJvdXRlRnVsbCB7XG5cdFx0aWYgKCF0aGlzLl9hY3RpdmVfcm91dGUpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcignW09XZWJQYWdlcl0gbm8gYWN0aXZlIHJvdXRlLicpO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcy5fYWN0aXZlX3JvdXRlO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgYWxsIHBhZ2VzIGxpc3QuXG5cdCAqL1xuXHRnZXRQYWdlTGlzdCgpIHtcblx0XHRyZXR1cm4geyAuLi50aGlzLl9wYWdlcyB9O1xuXHR9XG5cblx0LyoqXG5cdCAqIFJlZ2lzdGVyIGEgZ2l2ZW4gcGFnZS5cblx0ICpcblx0ICogQHBhcmFtIHBhZ2Vcblx0ICovXG5cdHJlZ2lzdGVyUGFnZShwYWdlOiBpUGFnZTxDb21wb25lbnQ+KTogdGhpcyB7XG5cdFx0bGV0IG5hbWUgPSBwYWdlLmdldE5hbWUoKTtcblxuXHRcdGlmIChuYW1lIGluIHRoaXMuX3BhZ2VzKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYFtPV2ViUGFnZXJdIHBhZ2UgXCIke25hbWV9XCIgYWxyZWFkeSByZWdpc3RlcmVkLmApO1xuXHRcdH1cblxuXHRcdHRoaXMuX3BhZ2VzW25hbWVdID0gcGFnZS5pbnN0YWxsKHRoaXMpO1xuXHRcdGxldCByb3V0ZXMgPSBwYWdlLmdldFJvdXRlcygpO1xuXG5cdFx0dGhpcy5fcm91dGVzX2NhY2hlLnB1c2goLi4ucm91dGVzKTtcblxuXHRcdHJldHVybiB0aGlzLl9yZWdpc3RlclBhZ2VSb3V0ZXMocGFnZSwgcm91dGVzKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBIZWxwZXJzIHRvIHJlZ2lzdGVyIHBhZ2Ugcm91dGVzLlxuXHQgKlxuXHQgKiBAcGFyYW0gcGFnZSBUaGUgcGFnZS5cblx0ICogQHBhcmFtIHJvdXRlcyBUaGUgcGFnZSByb3V0ZXMgbGlzdC5cblx0ICogQHBhcmFtIHBhcmVudCBUaGUgcGFnZSByb3V0ZXMgcGFyZW50LlxuXHQgKiBAcHJpdmF0ZVxuXHQgKi9cblx0cHJpdmF0ZSBfcmVnaXN0ZXJQYWdlUm91dGVzKFxuXHRcdHBhZ2U6IGlQYWdlPENvbXBvbmVudD4sXG5cdFx0cm91dGVzOiBpUGFnZVJvdXRlW10sXG5cdFx0cGFyZW50PzogaVBhZ2VSb3V0ZUZ1bGxcblx0KTogdGhpcyB7XG5cdFx0bGV0IHJvdXRlcjogT1dlYlJvdXRlciA9IHRoaXMuYXBwX2NvbnRleHQucm91dGVyO1xuXG5cdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCByb3V0ZXMubGVuZ3RoOyBpKyspIHtcblx0XHRcdGxldCByb3V0ZTogYW55ID0gcm91dGVzW2ldO1xuXG5cdFx0XHRyb3V0ZS5pZCA9ICsrcm91dGVJZDtcblx0XHRcdHJvdXRlLnBhcmVudCA9IHBhcmVudDtcblx0XHRcdHJvdXRlLmhyZWYgPSByb3V0ZXIucGF0aFRvVVJMKFxuXHRcdFx0XHR0eXBlb2Ygcm91dGUucGF0aCA9PT0gJ3N0cmluZycgPyByb3V0ZS5wYXRoIDogJy8nXG5cdFx0XHQpLmhyZWY7XG5cdFx0XHRyb3V0ZS5hY3RpdmUgPSBmYWxzZTtcblx0XHRcdHJvdXRlLmFjdGl2ZUNoaWxkID0gZmFsc2U7XG5cblx0XHRcdHJvdXRlLnNob3cgPVxuXHRcdFx0XHRyb3V0ZS5zaG93IHx8XG5cdFx0XHRcdGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRcdHJldHVybiB0cnVlO1xuXHRcdFx0XHR9O1xuXG5cdFx0XHR0aGlzLl9yb3V0ZXNfZmxhdHRlbmVkLnB1c2gocm91dGUpO1xuXG5cdFx0XHR0aGlzLl9hZGRSb3V0ZShyb3V0ZSwgcGFnZSk7XG5cblx0XHRcdGlmIChyb3V0ZS5zdWIgJiYgcm91dGUuc3ViLmxlbmd0aCkge1xuXHRcdFx0XHR0aGlzLl9yZWdpc3RlclBhZ2VSb3V0ZXMocGFnZSwgcm91dGUuc3ViLCByb3V0ZSk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogSGVscGVyIHRvIGFkZCByb3V0ZS5cblx0ICpcblx0ICogQHBhcmFtIHJvdXRlIFRoZSByb3V0ZSBvYmplY3QuXG5cdCAqIEBwYXJhbSBwYWdlIFRoZSBwYWdlIHRvIHdoaWNoIHRoYXQgcm91dGUgYmVsb25ncyB0by5cblx0ICogQHByaXZhdGVcblx0ICovXG5cdHByaXZhdGUgX2FkZFJvdXRlKHJvdXRlOiBpUGFnZVJvdXRlRnVsbCwgcGFnZTogaVBhZ2U8Q29tcG9uZW50Pik6IHRoaXMge1xuXHRcdGxldCBjdHggPSB0aGlzO1xuXHRcdHRoaXMuYXBwX2NvbnRleHQucm91dGVyLm9uKFxuXHRcdFx0cm91dGUucGF0aCxcblx0XHRcdHJvdXRlLnBhdGhPcHRpb25zLFxuXHRcdFx0KHJvdXRlQ29udGV4dDogT1dlYlJvdXRlQ29udGV4dCkgPT4ge1xuXHRcdFx0XHRjb25zb2xlLmxvZyhcblx0XHRcdFx0XHQnW09XZWJQYWdlcl0gcGFnZSByb3V0ZSBtYXRjaCAtPicsXG5cdFx0XHRcdFx0cm91dGUsXG5cdFx0XHRcdFx0cGFnZSxcblx0XHRcdFx0XHRyb3V0ZUNvbnRleHRcblx0XHRcdFx0KTtcblxuXHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0cGFnZS5yZXF1aXJlTG9naW4ocm91dGVDb250ZXh0LCByb3V0ZSkgJiZcblx0XHRcdFx0XHQhY3R4LmFwcF9jb250ZXh0LnVzZXJWZXJpZmllZCgpXG5cdFx0XHRcdCkge1xuXHRcdFx0XHRcdHJldHVybiAoXG5cdFx0XHRcdFx0XHRyb3V0ZUNvbnRleHQuc3RvcCgpICYmIGN0eC5hcHBfY29udGV4dC5zaG93TG9naW5QYWdlKClcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0bGV0IGFyID0gY3R4Ll9hY3RpdmVfcm91dGUsXG5cdFx0XHRcdFx0YXAgPSBjdHguX2FjdGl2ZV9wYWdlO1xuXG5cdFx0XHRcdGFwICYmIGFyICYmIGFwLm9uQ2xvc2UoYXIsIHJvdXRlKTtcblxuXHRcdFx0XHRwYWdlLm9uT3Blbihyb3V0ZUNvbnRleHQsIHJvdXRlKTtcblxuXHRcdFx0XHQhcm91dGVDb250ZXh0LnN0b3BwZWQoKSAmJiBjdHguX3NldEFjdGl2ZShwYWdlLCByb3V0ZSk7XG5cdFx0XHR9XG5cdFx0KTtcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0LyoqXG5cdCAqIEhlbHBlciB0byBzZXQgdGhlIGFjdGl2ZSByb3V0ZS5cblx0ICpcblx0ICogQHBhcmFtIHBhZ2Vcblx0ICogQHBhcmFtIHJvdXRlXG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIF9zZXRBY3RpdmUocGFnZTogaVBhZ2U8Q29tcG9uZW50Piwgcm91dGU6IGlQYWdlUm91dGVGdWxsKTogdGhpcyB7XG5cdFx0bGV0IG9sZFBhZ2UgPSB0aGlzLl9hY3RpdmVfcGFnZSxcblx0XHRcdG9sZFJvdXRlID0gdGhpcy5fYWN0aXZlX3JvdXRlLFxuXHRcdFx0YXBwID0gdGhpcy5hcHBfY29udGV4dDtcblxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fcm91dGVzX2ZsYXR0ZW5lZC5sZW5ndGg7IGkrKykge1xuXHRcdFx0bGV0IGMgPSB0aGlzLl9yb3V0ZXNfZmxhdHRlbmVkW2ldO1xuXG5cdFx0XHRjLmFjdGl2ZSA9IHJvdXRlLmlkID09PSBjLmlkO1xuXHRcdFx0Yy5hY3RpdmVDaGlsZCA9ICFjLmFjdGl2ZSAmJiBfaXNQYXJlbnRPZihjLCByb3V0ZSk7XG5cdFx0fVxuXG5cdFx0dGhpcy5fYWN0aXZlX3BhZ2UgPSBwYWdlO1xuXHRcdHRoaXMuX2FjdGl2ZV9yb3V0ZSA9IHJvdXRlO1xuXHRcdHdEb2MudGl0bGUgPSBhcHAuaTE4bi50b0h1bWFuKFxuXHRcdFx0cm91dGUudGl0bGUubGVuZ3RoID8gcm91dGUudGl0bGUgOiBhcHAuZ2V0QXBwTmFtZSgpXG5cdFx0KTtcblxuXHRcdGxldCBpbmZvOiBhbnkgPSB7XG5cdFx0XHRwYWdlLFxuXHRcdFx0b2xkUGFnZSxcblx0XHRcdHJvdXRlLFxuXHRcdFx0b2xkUm91dGUsXG5cdFx0XHRzYW1lUGFnZTogb2xkUGFnZSA9PT0gcGFnZSxcblx0XHR9O1xuXG5cdFx0Y29uc29sZS5sb2coJ1tPV2ViUGFnZXJdIGluZm8nLCBpbmZvKTtcblxuXHRcdHRoaXMudHJpZ2dlcihPV2ViUGFnZXIuRVZUX1BBR0VfTE9DQVRJT05fQ0hBTkdFLCBbcm91dGUsIHBhZ2VdKTtcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0b25Mb2NhdGlvbkNoYW5nZShcblx0XHRoYW5kbGVyOiAocm91dGU6IGlQYWdlUm91dGVGdWxsLCBwYWdlOiBpUGFnZTxDb21wb25lbnQ+KSA9PiB2b2lkXG5cdCkge1xuXHRcdHJldHVybiB0aGlzLm9uKE9XZWJQYWdlci5FVlRfUEFHRV9MT0NBVElPTl9DSEFOR0UsIGhhbmRsZXIpO1xuXHR9XG59XG4iXX0=