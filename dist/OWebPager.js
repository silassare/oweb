import OWebEvent from './OWebEvent';
import { id, logger } from './utils';
import OWebRoute from './OWebRoute';
const wDoc = window.document;
let routeId = 0;
const _isParentOf = (parent, route) => {
    let p;
    while ((p = route.parent)) {
        if (p === parent) {
            return true;
        }
        route = p;
    }
    return false;
};
export default class OWebPager extends OWebEvent {
    _appContext;
    static SELF = id();
    static EVT_PAGE_LOCATION_CHANGE = id();
    _pages = {};
    _routesCache = [];
    _routesFlattened = [];
    _activePage;
    _activeRoute;
    /**
     * @param _appContext The app context.
     */
    constructor(_appContext) {
        super();
        this._appContext = _appContext;
        logger.info('[OWebPager] ready!');
    }
    /**
     * Returns registered pages routes.
     */
    getRoutes() {
        return [...this._routesCache];
    }
    /**
     * Returns the page with the given name.
     * @param name
     */
    getPage(name) {
        const page = this._pages[name];
        if (undefined === page) {
            throw new Error(`[OWebPager] the page "${name}" is not defined.`);
        }
        return page;
    }
    /**
     * Returns the active page.
     */
    getActivePage() {
        if (!this._activePage) {
            throw new Error('[OWebPager] no active page.');
        }
        return this._activePage;
    }
    /**
     * Returns the active page route.
     */
    getActivePageRoute() {
        if (!this._activeRoute) {
            throw new Error('[OWebPager] no active route.');
        }
        return this._activeRoute;
    }
    /**
     * Returns all pages list.
     */
    getPageList() {
        return { ...this._pages };
    }
    /**
     * Register a given page.
     *
     * @param page
     */
    registerPage(page) {
        const name = page.name;
        if (name in this._pages) {
            throw new Error(`[OWebPager] page "${name}" already registered.`);
        }
        page.install && page.install(this);
        this._pages[name] = page;
        const routes = page.routes;
        this._routesCache.push(...routes);
        return this._registerPageRoutes(page, routes);
    }
    /**
     * Helpers to register page routes.
     *
     * @param page The page.
     * @param routes The page routes list.
     * @param parent The page routes parent.
     * @private
     */
    _registerPageRoutes(page, routes, parent) {
        const router = this._appContext.router;
        for (let i = 0; i < routes.length; i++) {
            const route = routes[i];
            if (!route.id) {
                route.id = ++routeId;
                route.parent = parent;
                route.pathOptions = route.pathOptions || {};
                route.children = route.children || [];
                route.active = false;
                route.activeChild = false;
                const webRoute = (route.webRoute = this._addRoute(route, page));
                if (!webRoute.isDynamic()) {
                    route.href = router.pathToURL(route.path).href;
                }
                if (!('show' in route)) {
                    route.show = true;
                }
                if (!('showChildren' in route)) {
                    route.showChildren = true;
                }
                if (!('disabled' in route)) {
                    route.disabled = false;
                }
                this._routesFlattened.push(route);
                if (route.children.length) {
                    this._registerPageRoutes(page, route.children, route);
                }
            }
        }
        return this;
    }
    /**
     * Helper to add route.
     *
     * @param route The route object.
     * @param page The page to which that route belongs to.
     * @private
     */
    _addRoute(route, page) {
        const webRoute = new OWebRoute(route.path, route.pathOptions, (routeContext) => {
            logger.debug('[OWebPager] page route match', route, page, routeContext);
            if (page.requireLogin &&
                page.requireLogin(routeContext, route) &&
                !this._appContext.user.userVerified()) {
                return (routeContext.stop() &&
                    this._appContext.showLoginPage({
                        next: routeContext.getPath(),
                    }));
            }
            if (route.disabled) {
                return routeContext.stop() && this._appContext.showHomePage();
            }
            const ar = this._activeRoute, ap = this._activePage;
            ap && ar && ap.onClose && ap.onClose(ar, route);
            page.onOpen && page.onOpen(routeContext, route);
            if (!routeContext.isStopped()) {
                routeContext.stop();
                this._setActive(page, route);
            }
        });
        this._appContext.router.addRoute(webRoute);
        return webRoute;
    }
    /**
     * Helper to set the active route.
     *
     * @param page
     * @param route
     * @private
     */
    _setActive(page, route) {
        const oldPage = this._activePage, oldRoute = this._activeRoute, app = this._appContext;
        for (let i = 0; i < this._routesFlattened.length; i++) {
            const c = this._routesFlattened[i];
            c.active = route.id === c.id;
            c.activeChild = !c.active && _isParentOf(c, route);
        }
        this._activePage = page;
        this._activeRoute = route;
        wDoc.title = app.i18n.toHuman(route.title ? route.title : app.getAppName());
        const info = {
            page,
            oldPage,
            route,
            oldRoute,
            samePage: oldPage === page,
        };
        logger.debug('[OWebPager] location info', info);
        this.trigger(OWebPager.EVT_PAGE_LOCATION_CHANGE, [route, page]);
        return this;
    }
    onLocationChange(handler) {
        return this.on(OWebPager.EVT_PAGE_LOCATION_CHANGE, handler);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlBhZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL09XZWJQYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLFNBQVMsTUFBTSxhQUFhLENBQUM7QUFFcEMsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFckMsT0FBTyxTQUE0QyxNQUFNLGFBQWEsQ0FBQztBQWdGdkUsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQztBQUM3QixJQUFJLE9BQU8sR0FBRyxDQUFDLENBQUM7QUFDaEIsTUFBTSxXQUFXLEdBQUcsQ0FDbkIsTUFBc0IsRUFDdEIsS0FBcUIsRUFDWCxFQUFFO0lBQ1osSUFBSSxDQUFDLENBQUM7SUFDTixPQUFPLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRTtRQUMxQixJQUFJLENBQUMsS0FBSyxNQUFNLEVBQUU7WUFDakIsT0FBTyxJQUFJLENBQUM7U0FDWjtRQUVELEtBQUssR0FBRyxDQUFDLENBQUM7S0FDVjtJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2QsQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLE9BQU8sT0FBTyxTQUduQixTQUFRLFNBQVM7SUFhVztJQVo3QixNQUFNLENBQVUsSUFBSSxHQUFHLEVBQUUsRUFBRSxDQUFDO0lBQzVCLE1BQU0sQ0FBVSx3QkFBd0IsR0FBRyxFQUFFLEVBQUUsQ0FBQztJQUUvQixNQUFNLEdBQXNCLEVBQUUsQ0FBQztJQUN4QyxZQUFZLEdBQXdCLEVBQUUsQ0FBQztJQUN2QyxnQkFBZ0IsR0FBd0IsRUFBRSxDQUFDO0lBQzNDLFdBQVcsQ0FBSztJQUNoQixZQUFZLENBQXFCO0lBRXpDOztPQUVHO0lBQ0gsWUFBNkIsV0FBb0I7UUFDaEQsS0FBSyxFQUFFLENBQUM7UUFEb0IsZ0JBQVcsR0FBWCxXQUFXLENBQVM7UUFFaEQsTUFBTSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FB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Iiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IE9XZWJBcHAgZnJvbSAnLi9PV2ViQXBwJztcbmltcG9ydCBPV2ViRXZlbnQgZnJvbSAnLi9PV2ViRXZlbnQnO1xuaW1wb3J0IE9XZWJSb3V0ZXIgZnJvbSAnLi9PV2ViUm91dGVyJztcbmltcG9ydCB7IGlkLCBsb2dnZXIgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBPV2ViUm91dGVDb250ZXh0IGZyb20gJy4vT1dlYlJvdXRlQ29udGV4dCc7XG5pbXBvcnQgT1dlYlJvdXRlLCB7IE9Sb3V0ZVBhdGgsIE9Sb3V0ZVBhdGhPcHRpb25zIH0gZnJvbSAnLi9PV2ViUm91dGUnO1xuaW1wb3J0IHsgT0kxOG4gfSBmcm9tICcuL09XZWJJMThuJztcblxuZXhwb3J0IGludGVyZmFjZSBPUGFnZVJvdXRlIHtcblx0c2x1Zz86IHN0cmluZztcblx0aWNvbj86IHN0cmluZztcblx0dGl0bGU6IE9JMThuO1xuXHRkZXNjcmlwdGlvbj86IE9JMThuO1xuXHRwYXRoOiBPUm91dGVQYXRoO1xuXHRwYXRoT3B0aW9ucz86IE9Sb3V0ZVBhdGhPcHRpb25zO1xuXHRjaGlsZHJlbj86IE9QYWdlUm91dGVbXTtcblx0c2hvd0NoaWxkcmVuPzogYm9vbGVhbjtcblx0ZGlzYWJsZWQ/OiBib29sZWFuO1xuXHRzaG93PzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IHR5cGUgT1BhZ2VSb3V0ZUZ1bGw8Um91dGUgZXh0ZW5kcyBPUGFnZVJvdXRlID0gT1BhZ2VSb3V0ZT4gPSBSb3V0ZSAmIHtcblx0cGF0aE9wdGlvbnM6IE9Sb3V0ZVBhdGhPcHRpb25zO1xuXHRjaGlsZHJlbjogT1BhZ2VSb3V0ZUZ1bGxbXTtcblx0c2hvd0NoaWxkcmVuOiBib29sZWFuO1xuXHRkaXNhYmxlZDogYm9vbGVhbjtcblx0c2hvdzogYm9vbGVhbjtcblxuXHRyZWFkb25seSBpZDogbnVtYmVyO1xuXHRyZWFkb25seSBocmVmPzogc3RyaW5nO1xuXHRyZWFkb25seSBwYXJlbnQ/OiBPUGFnZVJvdXRlRnVsbDxSb3V0ZT47XG5cdGFjdGl2ZTogYm9vbGVhbjtcblx0YWN0aXZlQ2hpbGQ6IGJvb2xlYW47XG5cdHdlYlJvdXRlOiBPV2ViUm91dGU7XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIE9QYWdlPFJvdXRlIGV4dGVuZHMgT1BhZ2VSb3V0ZSA9IE9QYWdlUm91dGU+IHtcblx0LyoqXG5cdCAqIFRoZSBwYWdlIG5hbWUgZ2V0dGVyLlxuXHQgKi9cblx0bmFtZTogc3RyaW5nO1xuXG5cdC8qKlxuXHQgKiBUaGUgcGFnZSByb3V0ZXMgZ2V0dGVyLlxuXHQgKi9cblx0cm91dGVzOiBSb3V0ZVtdO1xuXG5cdC8qKlxuXHQgKiBDYWxsZWQgb25jZSB3aGVuIHJlZ2lzdGVyaW5nIHRoZSBwYWdlLlxuXHQgKlxuXHQgKiBAcGFyYW0gcGFnZXJcblx0ICovXG5cdGluc3RhbGw/KHBhZ2VyOiBPV2ViUGFnZXI8dGhpcz4pOiB0aGlzO1xuXG5cdC8qKlxuXHQgKiBEb2VzIHRoaXMgcGFnZSByZXF1aXJlIGEgdmVyaWZpZWQgdXNlciBmb3IgdGhlIHJlcXVlc3RlZCBwYWdlIHJvdXRlLlxuXHQgKlxuXHQgKiBAcGFyYW0gY29udGV4dCBUaGUgYXBwIGNvbnRleHQuXG5cdCAqIEBwYXJhbSByb3V0ZSBUaGUgcmVxdWVzdCBwYWdlIHJvdXRlLlxuXHQgKi9cblx0cmVxdWlyZUxvZ2luPyhcblx0XHRjb250ZXh0OiBPV2ViUm91dGVDb250ZXh0LFxuXHRcdHJvdXRlOiBPUGFnZVJvdXRlRnVsbDxSb3V0ZT5cblx0KTogYm9vbGVhbjtcblxuXHQvKipcblx0ICogQ2FsbGVkIGJlZm9yZSBwYWdlIG9wZW4uXG5cdCAqXG5cdCAqIEBwYXJhbSBjb250ZXh0XG5cdCAqIEBwYXJhbSByb3V0ZVxuXHQgKi9cblx0b25PcGVuPyhjb250ZXh0OiBPV2ViUm91dGVDb250ZXh0LCByb3V0ZTogT1BhZ2VSb3V0ZUZ1bGw8Um91dGU+KTogdm9pZDtcblxuXHQvKipcblx0ICogQ2FsbGVkIGJlZm9yZSBwYWdlIGNsb3NlLlxuXHQgKlxuXHQgKiBAcGFyYW0gb2xkUm91dGVcblx0ICogQHBhcmFtIG5ld1JvdXRlXG5cdCAqL1xuXHRvbkNsb3NlPyhcblx0XHRvbGRSb3V0ZTogT1BhZ2VSb3V0ZUZ1bGw8Um91dGU+LFxuXHRcdG5ld1JvdXRlOiBPUGFnZVJvdXRlRnVsbDxSb3V0ZT5cblx0KTogdm9pZDtcbn1cblxuY29uc3Qgd0RvYyA9IHdpbmRvdy5kb2N1bWVudDtcbmxldCByb3V0ZUlkID0gMDtcbmNvbnN0IF9pc1BhcmVudE9mID0gKFxuXHRwYXJlbnQ6IE9QYWdlUm91dGVGdWxsLFxuXHRyb3V0ZTogT1BhZ2VSb3V0ZUZ1bGxcbik6IGJvb2xlYW4gPT4ge1xuXHRsZXQgcDtcblx0d2hpbGUgKChwID0gcm91dGUucGFyZW50KSkge1xuXHRcdGlmIChwID09PSBwYXJlbnQpIHtcblx0XHRcdHJldHVybiB0cnVlO1xuXHRcdH1cblxuXHRcdHJvdXRlID0gcDtcblx0fVxuXHRyZXR1cm4gZmFsc2U7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViUGFnZXI8XG5cdFAgZXh0ZW5kcyBPUGFnZTxSPixcblx0UiBleHRlbmRzIE9QYWdlUm91dGUgPSBPUGFnZVJvdXRlXG4+IGV4dGVuZHMgT1dlYkV2ZW50IHtcblx0c3RhdGljIHJlYWRvbmx5IFNFTEYgPSBpZCgpO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX1BBR0VfTE9DQVRJT05fQ0hBTkdFID0gaWQoKTtcblxuXHRwcml2YXRlIHJlYWRvbmx5IF9wYWdlczogUmVjb3JkPHN0cmluZywgUD4gPSB7fTtcblx0cHJpdmF0ZSBfcm91dGVzQ2FjaGU6IE9QYWdlUm91dGVGdWxsPFI+W10gPSBbXTtcblx0cHJpdmF0ZSBfcm91dGVzRmxhdHRlbmVkOiBPUGFnZVJvdXRlRnVsbDxSPltdID0gW107XG5cdHByaXZhdGUgX2FjdGl2ZVBhZ2U/OiBQO1xuXHRwcml2YXRlIF9hY3RpdmVSb3V0ZT86IE9QYWdlUm91dGVGdWxsPFI+O1xuXG5cdC8qKlxuXHQgKiBAcGFyYW0gX2FwcENvbnRleHQgVGhlIGFwcCBjb250ZXh0LlxuXHQgKi9cblx0Y29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBfYXBwQ29udGV4dDogT1dlYkFwcCkge1xuXHRcdHN1cGVyKCk7XG5cdFx0bG9nZ2VyLmluZm8oJ1tPV2ViUGFnZXJdIHJlYWR5IScpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgcmVnaXN0ZXJlZCBwYWdlcyByb3V0ZXMuXG5cdCAqL1xuXHRnZXRSb3V0ZXMoKTogT1BhZ2VSb3V0ZUZ1bGw8Uj5bXSB7XG5cdFx0cmV0dXJuIFsuLi50aGlzLl9yb3V0ZXNDYWNoZV07XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgcGFnZSB3aXRoIHRoZSBnaXZlbiBuYW1lLlxuXHQgKiBAcGFyYW0gbmFtZVxuXHQgKi9cblx0Z2V0UGFnZShuYW1lOiBzdHJpbmcpOiBQIHtcblx0XHRjb25zdCBwYWdlOiBQID0gdGhpcy5fcGFnZXNbbmFtZV07XG5cdFx0aWYgKHVuZGVmaW5lZCA9PT0gcGFnZSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBbT1dlYlBhZ2VyXSB0aGUgcGFnZSBcIiR7bmFtZX1cIiBpcyBub3QgZGVmaW5lZC5gKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gcGFnZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHRoZSBhY3RpdmUgcGFnZS5cblx0ICovXG5cdGdldEFjdGl2ZVBhZ2UoKTogUCB7XG5cdFx0aWYgKCF0aGlzLl9hY3RpdmVQYWdlKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ1tPV2ViUGFnZXJdIG5vIGFjdGl2ZSBwYWdlLicpO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcy5fYWN0aXZlUGFnZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHRoZSBhY3RpdmUgcGFnZSByb3V0ZS5cblx0ICovXG5cdGdldEFjdGl2ZVBhZ2VSb3V0ZSgpOiBPUGFnZVJvdXRlRnVsbDxSPiB7XG5cdFx0aWYgKCF0aGlzLl9hY3RpdmVSb3V0ZSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdbT1dlYlBhZ2VyXSBubyBhY3RpdmUgcm91dGUuJyk7XG5cdFx0fVxuXHRcdHJldHVybiB0aGlzLl9hY3RpdmVSb3V0ZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIGFsbCBwYWdlcyBsaXN0LlxuXHQgKi9cblx0Z2V0UGFnZUxpc3QoKTogUmVjb3JkPHN0cmluZywgUD4ge1xuXHRcdHJldHVybiB7IC4uLnRoaXMuX3BhZ2VzIH07XG5cdH1cblxuXHQvKipcblx0ICogUmVnaXN0ZXIgYSBnaXZlbiBwYWdlLlxuXHQgKlxuXHQgKiBAcGFyYW0gcGFnZVxuXHQgKi9cblx0cmVnaXN0ZXJQYWdlKHBhZ2U6IFApOiB0aGlzIHtcblx0XHRjb25zdCBuYW1lID0gcGFnZS5uYW1lO1xuXG5cdFx0aWYgKG5hbWUgaW4gdGhpcy5fcGFnZXMpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihgW09XZWJQYWdlcl0gcGFnZSBcIiR7bmFtZX1cIiBhbHJlYWR5IHJlZ2lzdGVyZWQuYCk7XG5cdFx0fVxuXG5cdFx0cGFnZS5pbnN0YWxsICYmIHBhZ2UuaW5zdGFsbCh0aGlzKTtcblxuXHRcdHRoaXMuX3BhZ2VzW25hbWVdID0gcGFnZTtcblx0XHRjb25zdCByb3V0ZXMgPSBwYWdlLnJvdXRlcztcblxuXHRcdHRoaXMuX3JvdXRlc0NhY2hlLnB1c2goLi4uKHJvdXRlcyBhcyBhbnlbXSkpO1xuXG5cdFx0cmV0dXJuIHRoaXMuX3JlZ2lzdGVyUGFnZVJvdXRlcyhwYWdlLCByb3V0ZXMpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEhlbHBlcnMgdG8gcmVnaXN0ZXIgcGFnZSByb3V0ZXMuXG5cdCAqXG5cdCAqIEBwYXJhbSBwYWdlIFRoZSBwYWdlLlxuXHQgKiBAcGFyYW0gcm91dGVzIFRoZSBwYWdlIHJvdXRlcyBsaXN0LlxuXHQgKiBAcGFyYW0gcGFyZW50IFRoZSBwYWdlIHJvdXRlcyBwYXJlbnQuXG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIF9yZWdpc3RlclBhZ2VSb3V0ZXMoXG5cdFx0cGFnZTogUCxcblx0XHRyb3V0ZXM6IFJbXSxcblx0XHRwYXJlbnQ/OiBPUGFnZVJvdXRlRnVsbDxSPlxuXHQpOiB0aGlzIHtcblx0XHRjb25zdCByb3V0ZXI6IE9XZWJSb3V0ZXIgPSB0aGlzLl9hcHBDb250ZXh0LnJvdXRlcjtcblxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgcm91dGVzLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRjb25zdCByb3V0ZTogYW55ID0gcm91dGVzW2ldO1xuXG5cdFx0XHRpZiAoIXJvdXRlLmlkKSB7XG5cdFx0XHRcdHJvdXRlLmlkID0gKytyb3V0ZUlkO1xuXHRcdFx0XHRyb3V0ZS5wYXJlbnQgPSBwYXJlbnQ7XG5cdFx0XHRcdHJvdXRlLnBhdGhPcHRpb25zID0gcm91dGUucGF0aE9wdGlvbnMgfHwge307XG5cdFx0XHRcdHJvdXRlLmNoaWxkcmVuID0gcm91dGUuY2hpbGRyZW4gfHwgW107XG5cdFx0XHRcdHJvdXRlLmFjdGl2ZSA9IGZhbHNlO1xuXHRcdFx0XHRyb3V0ZS5hY3RpdmVDaGlsZCA9IGZhbHNlO1xuXG5cdFx0XHRcdGNvbnN0IHdlYlJvdXRlID0gKHJvdXRlLndlYlJvdXRlID0gdGhpcy5fYWRkUm91dGUocm91dGUsIHBhZ2UpKTtcblx0XHRcdFx0aWYgKCF3ZWJSb3V0ZS5pc0R5bmFtaWMoKSkge1xuXHRcdFx0XHRcdHJvdXRlLmhyZWYgPSByb3V0ZXIucGF0aFRvVVJMKHJvdXRlLnBhdGgpLmhyZWY7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRpZiAoISgnc2hvdycgaW4gcm91dGUpKSB7XG5cdFx0XHRcdFx0cm91dGUuc2hvdyA9IHRydWU7XG5cdFx0XHRcdH1cblx0XHRcdFx0aWYgKCEoJ3Nob3dDaGlsZHJlbicgaW4gcm91dGUpKSB7XG5cdFx0XHRcdFx0cm91dGUuc2hvd0NoaWxkcmVuID0gdHJ1ZTtcblx0XHRcdFx0fVxuXHRcdFx0XHRpZiAoISgnZGlzYWJsZWQnIGluIHJvdXRlKSkge1xuXHRcdFx0XHRcdHJvdXRlLmRpc2FibGVkID0gZmFsc2U7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHR0aGlzLl9yb3V0ZXNGbGF0dGVuZWQucHVzaChyb3V0ZSk7XG5cblx0XHRcdFx0aWYgKHJvdXRlLmNoaWxkcmVuLmxlbmd0aCkge1xuXHRcdFx0XHRcdHRoaXMuX3JlZ2lzdGVyUGFnZVJvdXRlcyhwYWdlLCByb3V0ZS5jaGlsZHJlbiwgcm91dGUpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogSGVscGVyIHRvIGFkZCByb3V0ZS5cblx0ICpcblx0ICogQHBhcmFtIHJvdXRlIFRoZSByb3V0ZSBvYmplY3QuXG5cdCAqIEBwYXJhbSBwYWdlIFRoZSBwYWdlIHRvIHdoaWNoIHRoYXQgcm91dGUgYmVsb25ncyB0by5cblx0ICogQHByaXZhdGVcblx0ICovXG5cdHByaXZhdGUgX2FkZFJvdXRlKHJvdXRlOiBPUGFnZVJvdXRlRnVsbDxSPiwgcGFnZTogUCk6IE9XZWJSb3V0ZSB7XG5cdFx0Y29uc3Qgd2ViUm91dGUgPSBuZXcgT1dlYlJvdXRlKFxuXHRcdFx0cm91dGUucGF0aCxcblx0XHRcdHJvdXRlLnBhdGhPcHRpb25zLFxuXHRcdFx0KHJvdXRlQ29udGV4dDogT1dlYlJvdXRlQ29udGV4dCkgPT4ge1xuXHRcdFx0XHRsb2dnZXIuZGVidWcoJ1tPV2ViUGFnZXJdIHBhZ2Ugcm91dGUgbWF0Y2gnLCByb3V0ZSwgcGFnZSwgcm91dGVDb250ZXh0KTtcblxuXHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0cGFnZS5yZXF1aXJlTG9naW4gJiZcblx0XHRcdFx0XHRwYWdlLnJlcXVpcmVMb2dpbihyb3V0ZUNvbnRleHQsIHJvdXRlKSAmJlxuXHRcdFx0XHRcdCF0aGlzLl9hcHBDb250ZXh0LnVzZXIudXNlclZlcmlmaWVkKClcblx0XHRcdFx0KSB7XG5cdFx0XHRcdFx0cmV0dXJuIChcblx0XHRcdFx0XHRcdHJvdXRlQ29udGV4dC5zdG9wKCkgJiZcblx0XHRcdFx0XHRcdHRoaXMuX2FwcENvbnRleHQuc2hvd0xvZ2luUGFnZSh7XG5cdFx0XHRcdFx0XHRcdG5leHQ6IHJvdXRlQ29udGV4dC5nZXRQYXRoKCksXG5cdFx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRpZiAocm91dGUuZGlzYWJsZWQpIHtcblx0XHRcdFx0XHRyZXR1cm4gcm91dGVDb250ZXh0LnN0b3AoKSAmJiB0aGlzLl9hcHBDb250ZXh0LnNob3dIb21lUGFnZSgpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0Y29uc3QgYXIgPSB0aGlzLl9hY3RpdmVSb3V0ZSxcblx0XHRcdFx0XHRhcCA9IHRoaXMuX2FjdGl2ZVBhZ2U7XG5cblx0XHRcdFx0YXAgJiYgYXIgJiYgYXAub25DbG9zZSAmJiBhcC5vbkNsb3NlKGFyLCByb3V0ZSk7XG5cblx0XHRcdFx0cGFnZS5vbk9wZW4gJiYgcGFnZS5vbk9wZW4ocm91dGVDb250ZXh0LCByb3V0ZSk7XG5cblx0XHRcdFx0aWYgKCFyb3V0ZUNvbnRleHQuaXNTdG9wcGVkKCkpIHtcblx0XHRcdFx0XHRyb3V0ZUNvbnRleHQuc3RvcCgpO1xuXHRcdFx0XHRcdHRoaXMuX3NldEFjdGl2ZShwYWdlLCByb3V0ZSk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHQpO1xuXG5cdFx0dGhpcy5fYXBwQ29udGV4dC5yb3V0ZXIuYWRkUm91dGUod2ViUm91dGUpO1xuXG5cdFx0cmV0dXJuIHdlYlJvdXRlO1xuXHR9XG5cblx0LyoqXG5cdCAqIEhlbHBlciB0byBzZXQgdGhlIGFjdGl2ZSByb3V0ZS5cblx0ICpcblx0ICogQHBhcmFtIHBhZ2Vcblx0ICogQHBhcmFtIHJvdXRlXG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIF9zZXRBY3RpdmUocGFnZTogUCwgcm91dGU6IE9QYWdlUm91dGVGdWxsPFI+KTogdGhpcyB7XG5cdFx0Y29uc3Qgb2xkUGFnZSA9IHRoaXMuX2FjdGl2ZVBhZ2UsXG5cdFx0XHRvbGRSb3V0ZSA9IHRoaXMuX2FjdGl2ZVJvdXRlLFxuXHRcdFx0YXBwID0gdGhpcy5fYXBwQ29udGV4dDtcblxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fcm91dGVzRmxhdHRlbmVkLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRjb25zdCBjID0gdGhpcy5fcm91dGVzRmxhdHRlbmVkW2ldO1xuXG5cdFx0XHRjLmFjdGl2ZSA9IHJvdXRlLmlkID09PSBjLmlkO1xuXHRcdFx0Yy5hY3RpdmVDaGlsZCA9ICFjLmFjdGl2ZSAmJiBfaXNQYXJlbnRPZihjLCByb3V0ZSk7XG5cdFx0fVxuXG5cdFx0dGhpcy5fYWN0aXZlUGFnZSA9IHBhZ2U7XG5cdFx0dGhpcy5fYWN0aXZlUm91dGUgPSByb3V0ZTtcblx0XHR3RG9jLnRpdGxlID0gYXBwLmkxOG4udG9IdW1hbihyb3V0ZS50aXRsZSA/IHJvdXRlLnRpdGxlIDogYXBwLmdldEFwcE5hbWUoKSk7XG5cblx0XHRjb25zdCBpbmZvOiBhbnkgPSB7XG5cdFx0XHRwYWdlLFxuXHRcdFx0b2xkUGFnZSxcblx0XHRcdHJvdXRlLFxuXHRcdFx0b2xkUm91dGUsXG5cdFx0XHRzYW1lUGFnZTogb2xkUGFnZSA9PT0gcGFnZSxcblx0XHR9O1xuXG5cdFx0bG9nZ2VyLmRlYnVnKCdbT1dlYlBhZ2VyXSBsb2NhdGlvbiBpbmZvJywgaW5mbyk7XG5cblx0XHR0aGlzLnRyaWdnZXIoT1dlYlBhZ2VyLkVWVF9QQUdFX0xPQ0FUSU9OX0NIQU5HRSwgW3JvdXRlLCBwYWdlXSk7XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdG9uTG9jYXRpb25DaGFuZ2UoaGFuZGxlcjogKHJvdXRlOiBPUGFnZVJvdXRlRnVsbDxSPiwgcGFnZTogUCkgPT4gdm9pZCk6IHRoaXMge1xuXHRcdHJldHVybiB0aGlzLm9uKE9XZWJQYWdlci5FVlRfUEFHRV9MT0NBVElPTl9DSEFOR0UsIGhhbmRsZXIpO1xuXHR9XG59XG4iXX0=