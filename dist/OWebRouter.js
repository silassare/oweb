import { Utils } from "./oweb";
const token_type_reg_map = {
    "num": (/(\d+)/).source,
    "alpha": (/([a-zA-Z]+)/).source,
    "alpha-u": (/([a-z]+)/).source,
    "alpha-l": (/([A-Z]+)/).source,
    "alpha-num": (/([a-zA-Z0-9]+)/).source,
    "alpha-num-l": (/([a-z0-9]+)/).source,
    "alpha-num-u": (/([A-Z0-9]+)/).source,
    "any": /([^/]+)/.source
}, token_reg = /:([a-z][a-z0-9_]*)/i, wLoc = window.location, wDoc = window.document, wHistory = window.history;
let escapeString = function (str) {
    return str.replace(/([.+*?=^!:${}()[\]|\/])/g, "\\$1");
};
let stringReg = function (str) {
    return new RegExp(escapeString(str));
};
let fixPath = (path) => {
    if (!path.length || path == "/") {
        return "/";
    }
    path = path.replace(/^#/, "");
    if (path[0] != "/") {
        path = "/" + path;
    }
    return path;
};
/*
 t = "path/to/:id/file/:index/name.:format";
 p = {id:"num",index:"alpha",format:"alpha-num"};
 parseDynamicPath(t,p);
*/
let parseDynamicPath = function (path, options) {
    let tokens = [], reg = "", _path = path, match;
    while ((match = token_reg.exec(_path)) != null) {
        let found = match[0], token = match[1], rule = options[token] || "any", head = _path.slice(0, match.index);
        if (head.length) {
            reg += stringReg(head).source;
        }
        if (typeof rule === "string" && rule in token_type_reg_map) {
            reg += token_type_reg_map[rule];
        }
        else if (rule instanceof RegExp) {
            reg += rule.source;
        }
        else {
            throw new Error("Invalid rule for token ':" + token + "' in path '" + path + "'");
        }
        tokens.push(token);
        _path = _path.slice(match.index + found.length);
    }
    if (!reg.length) {
        return {
            reg: null,
            tokens: tokens
        };
    }
    if (_path.length) {
        reg += stringReg(_path).source;
    }
    return {
        reg: new RegExp("^" + reg + "$"),
        tokens: tokens
    };
};
export class OWebRoute {
    constructor(path, rules, action) {
        if (path instanceof RegExp) {
            this.path = path.toString();
            this.reg = path;
            this.tokens = Utils.isArray(rules) ? rules : [];
        }
        else if (Utils.isString(path) && path.length) {
            rules = (Utils.isPlainObject(rules) ? rules : {});
            let p = parseDynamicPath(path, rules);
            this.path = path;
            this.reg = p.reg;
            this.tokens = p.tokens;
        }
        else {
            throw new TypeError("[OWebRoute] invalid route path, string or RegExp required.");
        }
        if ("function" !== typeof action) {
            throw new TypeError(`[OWebRoute] invalid action type, got "${typeof action}" instead of "function".`);
        }
        this.action = action;
    }
    isDynamic() {
        return this.reg != null;
    }
    getPath() {
        return this.path;
    }
    getAction() {
        return this.action;
    }
    is(path) {
        return (this.reg) ? this.reg.test(path) : this.path === path;
    }
    parse(path) {
        if (this.isDynamic()) {
            let founds;
            if (founds = String(path).match(this.reg)) {
                return this.tokens.reduce((acc, key, index) => {
                    acc[key] = founds[index + 1];
                    return acc;
                }, {});
            }
        }
        return {};
    }
}
export class OWebRouteContext {
    constructor(router, path, state) {
        this._stopped = false;
        this._path = path;
        this._tokens = {};
        this._state = state || {};
        this._router = router;
    }
    getToken(token) {
        return this._tokens[token];
    }
    getTokens() {
        return Object.create(this._tokens);
    }
    getPath() {
        return this._path;
    }
    getStateItem(key) {
        return this._state[key];
    }
    setStateItem(key, value) {
        this._state[key] = value;
        return this;
    }
    stopped() {
        return this._stopped;
    }
    stop() {
        if (!this._stopped) {
            console.warn("[OWebDispatchContext] route context will stop.");
            this.save(); // save before stop
            this._stopped = true;
            console.warn("[OWebDispatchContext] route context was stopped!");
        }
        else {
            console.warn("[OWebDispatchContext] route context already stopped!");
        }
        return this;
    }
    save() {
        if (!this.stopped()) {
            console.log("[OWebDispatchContext] saving state!");
            this._router.replaceHistory(this._path, this._state);
        }
        else {
            console.error("[OWebDispatchContext] you shouldn't try to save when stopped.");
        }
        return this;
    }
    actionRunner(route) {
        this._tokens = route.parse(this._path);
        route.getAction()(this);
        return this;
    }
}
export default class OWebRouter {
    constructor(baseUrl, hashMode = true) {
        this._current_path = "";
        this._routes = [];
        this._initialized = false;
        this._listening = false;
        this._notFound = undefined;
        this._dispatch_id = 0;
        let r = this;
        this._baseUrl = baseUrl;
        this._hashMode = hashMode;
        this._popStateListener = (e) => {
            r.onPopState(e);
        };
        console.log("[OWebRouter] ready!");
    }
    start(firstRun = true, path = this.getLocationPath()) {
        if (!this._initialized) {
            this._initialized = true;
            this.register();
            console.log("[OWebRouter] start routing!");
            console.log("[OWebRouter] watching routes ->", this._routes);
            firstRun && this.browseTo(path, undefined, false);
        }
        else {
            console.warn("[OWebRouter] router already started!");
        }
        return this;
    }
    stopRouting() {
        if (this._initialized) {
            this._initialized = false;
            this.unregister();
            console.log("[OWebRouter] stop routing!");
        }
        else {
            console.warn("[OWebRouter] you should start routing first!");
        }
        return this;
    }
    getCurrentPath() {
        return this._current_path;
    }
    getLocationPath() {
        // TODO when using pathname make sure to remove base uri pathname for app in subdirectory
        return fixPath(wLoc[this._hashMode ? "hash" : "pathname"]);
    }
    pathToURL(path) {
        path = fixPath(path);
        return new URL(this._hashMode ? "#" + path : path, this._baseUrl);
    }
    register() {
        if (!this._listening) {
            this._listening = true;
            window.addEventListener("popstate", this._popStateListener, false);
        }
        return this;
    }
    unregister() {
        if (this._listening) {
            this._listening = false;
            window.removeEventListener("popstate", this._popStateListener, false);
        }
        return this;
    }
    onPopState(e) {
        console.log("[OWebRouter] popstate ->", arguments);
        if (e.state) {
            this.browseTo(e.state.path, e.state.data, false);
        }
        else {
            this.browseTo(this.getLocationPath(), undefined, false);
        }
    }
    on(path, rules = {}, action) {
        this._routes.push(new OWebRoute(path, rules, action));
        return this;
    }
    notFound(callback) {
        this._notFound = callback;
        return this;
    }
    goBack(distance = 1) {
        if (distance > 0) {
            console.log("[OWebRouter] going back -> ", distance);
            let hLen = wHistory.length;
            if (hLen > 1) {
                if (hLen >= distance) {
                    wHistory.go(-distance);
                }
                else {
                    wHistory.go(-hLen);
                }
            }
            else {
                console.warn("[OWebRouter] can't go back -> history.length === 1", distance);
            }
        }
        return this;
    }
    browseTo(path, state = {}, push = true, ignoreIfSamePath = false) {
        path = fixPath(path);
        console.log("[OWebRouter] browsing to -> ", path, state, push);
        if (ignoreIfSamePath && this._current_path === path) {
            console.log("[OWebRouter] ignore same path -> ", path);
            return this;
        }
        if (this._current_dispatcher && this._current_dispatcher.isActive()) {
            this._current_dispatcher.cancel();
        }
        this._current_path = path;
        push && this.addHistory(path, state);
        let cd = this._current_dispatcher = this.createDispatcher(path, state, ++this._dispatch_id);
        cd.dispatch();
        if (cd.id === this._dispatch_id && !cd.context.stopped()) {
            if (!cd.found.length) {
                console.warn("[OWebRouter] no route found for path ->", path);
                if (this._notFound) {
                    this._notFound(path);
                }
                else {
                    console.error("[OWebRouter] notFound action is not defined!");
                    this.stopRouting();
                }
            }
            else {
                cd.context.save();
                console.log("[OWebRouter] success ->", path);
            }
        }
        return this;
    }
    addHistory(path, data, title = "") {
        path = fixPath(path);
        title = title && title.length ? title : wDoc.title;
        let state = {
            "path": path,
            "data": data
        }, url = this.pathToURL(path);
        wHistory.pushState(state, title, url.href);
        console.warn("[OWebDispatchContext] history added", wHistory.state, url.href);
        return this;
    }
    replaceHistory(path, data, title = "") {
        path = fixPath(path);
        title = title && title.length ? title : wDoc.title;
        let state = {
            "path": path,
            "data": data
        }, url = this.pathToURL(path);
        wHistory.replaceState(state, title, url.href);
        console.warn("[OWebDispatchContext] history updated", wHistory.state);
        return this;
    }
    createDispatcher(path, state, id) {
        console.log(`[OWebRouter][dispatcher-${id}] creation.`);
        let ctx = this, found = [], len = this._routes.length, active = false, routeContext = new OWebRouteContext(this, path, state), o = {
            context: routeContext,
            id,
            found,
            isActive: () => active,
            cancel: function () {
                if (active) {
                    active = false;
                    console.warn(`[OWebRouter][dispatcher-${id}] cancel called!`);
                }
                else {
                    console.error(`[OWebRouter][dispatcher-${id}] cancel called when inactive.`);
                }
            },
            dispatch: function () {
                if (!active) {
                    console.log(`[OWebRouter][dispatcher-${id}] start ->`, o);
                    active = true;
                    let i = -1;
                    while (++i < len) {
                        if (!active) {
                            console.warn(`[OWebRouter][dispatcher-${id}] browseTo called while dispatching: ${path} -> ${ctx._current_path}`);
                            break;
                        }
                        let route = ctx._routes[i];
                        if (routeContext.stopped()) {
                            console.warn(`[OWebRouter][dispatcher-${id}] canceled for "${path}" by route action ->`, route.getAction());
                            o.cancel();
                            break;
                        }
                        if (route.is(path)) {
                            found.push(route);
                            routeContext.actionRunner(route);
                        }
                    }
                    active = false;
                }
                else {
                    console.warn(`[OWebRouter][dispatcher-${id}] is busy`);
                }
            }
        };
        return o;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlJvdXRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViUm91dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxLQUFLLEVBQUMsTUFBTSxRQUFRLENBQUM7QUFvQjdCLE1BQU0sa0JBQWtCLEdBQUc7SUFDdkIsS0FBSyxFQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTTtJQUMvQixPQUFPLEVBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQyxNQUFNO0lBQ3JDLFNBQVMsRUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLE1BQU07SUFDbEMsU0FBUyxFQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTTtJQUNsQyxXQUFXLEVBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE1BQU07SUFDeEMsYUFBYSxFQUFFLENBQUMsYUFBYSxDQUFDLENBQUMsTUFBTTtJQUNyQyxhQUFhLEVBQUUsQ0FBQyxhQUFhLENBQUMsQ0FBQyxNQUFNO0lBQ3JDLEtBQUssRUFBVSxTQUFTLENBQUMsTUFBTTtDQUMvQixFQUNELFNBQVMsR0FBWSxxQkFBcUIsRUFDMUMsSUFBSSxHQUFpQixNQUFNLENBQUMsUUFBUSxFQUNwQyxJQUFJLEdBQWlCLE1BQU0sQ0FBQyxRQUFRLEVBQ3BDLFFBQVEsR0FBYSxNQUFNLENBQUMsT0FBTyxDQUFDO0FBRXZDLElBQUksWUFBWSxHQUFHLFVBQVUsR0FBVztJQUN2QyxPQUFPLEdBQUcsQ0FBQyxPQUFPLENBQUMsMEJBQTBCLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDeEQsQ0FBQyxDQUFDO0FBRUYsSUFBSSxTQUFTLEdBQUcsVUFBVSxHQUFXO0lBQ3BDLE9BQU8sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDdEMsQ0FBQyxDQUFDO0FBRUYsSUFBSSxPQUFPLEdBQUcsQ0FBQyxJQUFZLEVBQVUsRUFBRTtJQUN0QyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0s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RUFBRSxXQUFXLENBQUMsQ0FBQztpQkFDdkQ7WUFDRixDQUFDO1NBQ0QsQ0FBQztRQUVILE9BQU8sQ0FBQyxDQUFDO0lBQ1YsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtVdGlsc30gZnJvbSBcIi4vb3dlYlwiO1xuXG5leHBvcnQgdHlwZSB0Um91dGUgPSBzdHJpbmcgfCBSZWdFeHA7XG5leHBvcnQgdHlwZSB0Um91dGVPcHRpb25zID0geyBba2V5OiBzdHJpbmddOiBSZWdFeHAgfCBrZXlvZiB0eXBlb2YgdG9rZW5fdHlwZV9yZWdfbWFwIH07XG5leHBvcnQgdHlwZSB0Um91dGVQYXJhbXMgPSB7IFtrZXk6IHN0cmluZ106IGFueSB9O1xuZXhwb3J0IHR5cGUgdFJvdXRlQWN0aW9uID0gKGN0eDogT1dlYlJvdXRlQ29udGV4dCkgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIHRSb3V0ZUluZm8gPSB7IHJlZzogUmVnRXhwIHwgbnVsbCwgdG9rZW5zOiBBcnJheTxzdHJpbmc+IH07XG5cbmludGVyZmFjZSBpUm91dGVEaXNwYXRjaGVyIHtcblx0cmVhZG9ubHkgaWQ6IG51bWJlcixcblx0cmVhZG9ubHkgY29udGV4dDogT1dlYlJvdXRlQ29udGV4dCxcblx0cmVhZG9ubHkgZm91bmQ6IE9XZWJSb3V0ZVtdXG5cblx0aXNBY3RpdmUoKTogYm9vbGVhbixcblxuXHRkaXNwYXRjaCgpOiB2b2lkLFxuXG5cdGNhbmNlbCgpOiB2b2lkLFxufVxuXG5jb25zdCB0b2tlbl90eXBlX3JlZ19tYXAgPSB7XG5cdFx0ICBcIm51bVwiICAgICAgICA6ICgvKFxcZCspLykuc291cmNlLFxuXHRcdCAgXCJhbHBoYVwiICAgICAgOiAoLyhbYS16QS1aXSspLykuc291cmNlLFxuXHRcdCAgXCJhbHBoYS11XCIgICAgOiAoLyhbYS16XSspLykuc291cmNlLFxuXHRcdCAgXCJhbHBoYS1sXCIgICAgOiAoLyhbQS1aXSspLykuc291cmNlLFxuXHRcdCAgXCJhbHBoYS1udW1cIiAgOiAoLyhbYS16QS1aMC05XSspLykuc291cmNlLFxuXHRcdCAgXCJhbHBoYS1udW0tbFwiOiAoLyhbYS16MC05XSspLykuc291cmNlLFxuXHRcdCAgXCJhbHBoYS1udW0tdVwiOiAoLyhbQS1aMC05XSspLykuc291cmNlLFxuXHRcdCAgXCJhbnlcIiAgICAgICAgOiAvKFteL10rKS8uc291cmNlXG5cdCAgfSxcblx0ICB0b2tlbl9yZWcgICAgICAgICAgPSAvOihbYS16XVthLXowLTlfXSopL2ksXG5cdCAgd0xvYyAgICAgICAgICAgICAgID0gd2luZG93LmxvY2F0aW9uLFxuXHQgIHdEb2MgICAgICAgICAgICAgICA9IHdpbmRvdy5kb2N1bWVudCxcblx0ICB3SGlzdG9yeSAgICAgICAgICAgPSB3aW5kb3cuaGlzdG9yeTtcblxubGV0IGVzY2FwZVN0cmluZyA9IGZ1bmN0aW9uIChzdHI6IHN0cmluZykge1xuXHRyZXR1cm4gc3RyLnJlcGxhY2UoLyhbLisqPz1eIToke30oKVtcXF18XFwvXSkvZywgXCJcXFxcJDFcIik7XG59O1xuXG5sZXQgc3RyaW5nUmVnID0gZnVuY3Rpb24gKHN0cjogc3RyaW5nKSB7XG5cdHJldHVybiBuZXcgUmVnRXhwKGVzY2FwZVN0cmluZyhzdHIpKTtcbn07XG5cbmxldCBmaXhQYXRoID0gKHBhdGg6IHN0cmluZyk6IHN0cmluZyA9PiB7XG5cdGlmICghcGF0aC5sZW5ndGggfHwgcGF0aCA9PSBcIi9cIikge1xuXHRcdHJldHVybiBcIi9cIjtcblx0fVxuXHRwYXRoID0gcGF0aC5yZXBsYWNlKC9eIy8sIFwiXCIpO1xuXG5cdGlmIChwYXRoWzBdICE9IFwiL1wiKSB7XG5cdFx0cGF0aCA9IFwiL1wiICsgcGF0aDtcblx0fVxuXG5cdHJldHVybiBwYXRoO1xufTtcblxuLypcbiB0ID0gXCJwYXRoL3RvLzppZC9maWxlLzppbmRleC9uYW1lLjpmb3JtYXRcIjtcbiBwID0ge2lkOlwibnVtXCIsaW5kZXg6XCJhbHBoYVwiLGZvcm1hdDpcImFscGhhLW51bVwifTtcbiBwYXJzZUR5bmFtaWNQYXRoKHQscCk7XG4qL1xubGV0IHBhcnNlRHluYW1pY1BhdGggPSBmdW5jdGlvbiAocGF0aDogc3RyaW5nLCBvcHRpb25zOiB0Um91dGVPcHRpb25zKTogdFJvdXRlSW5mbyB7XG5cblx0bGV0IHRva2VuczogQXJyYXk8c3RyaW5nPiA9IFtdLFxuXHRcdHJlZzogc3RyaW5nICAgICAgICAgICA9IFwiXCIsXG5cdFx0X3BhdGg6IHN0cmluZyAgICAgICAgID0gcGF0aCxcblx0XHRtYXRjaDogUmVnRXhwRXhlY0FycmF5IHwgbnVsbDtcblxuXHR3aGlsZSAoKG1hdGNoID0gdG9rZW5fcmVnLmV4ZWMoX3BhdGgpKSAhPSBudWxsKSB7XG5cdFx0bGV0IGZvdW5kOiBhbnkgICA9IG1hdGNoWzBdLFxuXHRcdFx0dG9rZW46IGFueSAgID0gbWF0Y2hbMV0sXG5cdFx0XHRydWxlOiBhbnkgICAgPSBvcHRpb25zW3Rva2VuXSB8fCBcImFueVwiLFxuXHRcdFx0aGVhZDogc3RyaW5nID0gX3BhdGguc2xpY2UoMCwgbWF0Y2guaW5kZXgpO1xuXG5cdFx0aWYgKGhlYWQubGVuZ3RoKSB7XG5cdFx0XHRyZWcgKz0gc3RyaW5nUmVnKGhlYWQpLnNvdXJjZTtcblx0XHR9XG5cblx0XHRpZiAodHlwZW9mIHJ1bGUgPT09IFwic3RyaW5nXCIgJiYgcnVsZSBpbiB0b2tlbl90eXBlX3JlZ19tYXApIHtcblx0XHRcdHJlZyArPSAodG9rZW5fdHlwZV9yZWdfbWFwIGFzIGFueSlbcnVsZV07XG5cdFx0fSBlbHNlIGlmIChydWxlIGluc3RhbmNlb2YgUmVnRXhwKSB7XG5cdFx0XHRyZWcgKz0gcnVsZS5zb3VyY2U7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgcnVsZSBmb3IgdG9rZW4gJzpcIiArIHRva2VuICsgXCInIGluIHBhdGggJ1wiICsgcGF0aCArIFwiJ1wiKTtcblx0XHR9XG5cblx0XHR0b2tlbnMucHVzaCh0b2tlbik7XG5cblx0XHRfcGF0aCA9IF9wYXRoLnNsaWNlKG1hdGNoLmluZGV4ICsgZm91bmQubGVuZ3RoKTtcblx0fVxuXG5cdGlmICghcmVnLmxlbmd0aCkge1xuXHRcdHJldHVybiB7XG5cdFx0XHRyZWcgICA6IG51bGwsXG5cdFx0XHR0b2tlbnM6IHRva2Vuc1xuXHRcdH07XG5cdH1cblxuXHRpZiAoX3BhdGgubGVuZ3RoKSB7XG5cdFx0cmVnICs9IHN0cmluZ1JlZyhfcGF0aCkuc291cmNlO1xuXHR9XG5cblx0cmV0dXJuIHtcblx0XHRyZWcgICA6IG5ldyBSZWdFeHAoXCJeXCIgKyByZWcgKyBcIiRcIiksXG5cdFx0dG9rZW5zOiB0b2tlbnNcblx0fTtcbn07XG5cbmV4cG9ydCBjbGFzcyBPV2ViUm91dGUge1xuXHRwcml2YXRlIHJlYWRvbmx5IHBhdGg6IHN0cmluZztcblx0cHJpdmF0ZSByZWFkb25seSByZWc6IFJlZ0V4cCB8IG51bGw7XG5cdHByaXZhdGUgdG9rZW5zOiBBcnJheTxzdHJpbmc+O1xuXHRwcml2YXRlIHJlYWRvbmx5IGFjdGlvbjogdFJvdXRlQWN0aW9uO1xuXG5cdGNvbnN0cnVjdG9yKHBhdGg6IHN0cmluZyB8IFJlZ0V4cCwgcnVsZXM6IHRSb3V0ZU9wdGlvbnMgfCBBcnJheTxzdHJpbmc+LCBhY3Rpb246IHRSb3V0ZUFjdGlvbikge1xuXG5cdFx0aWYgKHBhdGggaW5zdGFuY2VvZiBSZWdFeHApIHtcblx0XHRcdHRoaXMucGF0aCAgID0gcGF0aC50b1N0cmluZygpO1xuXHRcdFx0dGhpcy5yZWcgICAgPSBwYXRoO1xuXHRcdFx0dGhpcy50b2tlbnMgPSBVdGlscy5pc0FycmF5KHJ1bGVzKSA/IHJ1bGVzIDogW107XG5cdFx0fSBlbHNlIGlmIChVdGlscy5pc1N0cmluZyhwYXRoKSAmJiBwYXRoLmxlbmd0aCkge1xuXHRcdFx0cnVsZXMgICAgICAgPSA8dFJvdXRlT3B0aW9ucz4gKFV0aWxzLmlzUGxhaW5PYmplY3QocnVsZXMpID8gcnVsZXMgOiB7fSk7XG5cdFx0XHRsZXQgcCAgICAgICA9IHBhcnNlRHluYW1pY1BhdGgocGF0aCwgcnVsZXMpO1xuXHRcdFx0dGhpcy5wYXRoICAgPSBwYXRoO1xuXHRcdFx0dGhpcy5yZWcgICAgPSBwLnJlZztcblx0XHRcdHRoaXMudG9rZW5zID0gcC50b2tlbnM7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoXCJbT1dlYlJvdXRlXSBpbnZhbGlkIHJvdXRlIHBhdGgsIHN0cmluZyBvciBSZWdFeHAgcmVxdWlyZWQuXCIpO1xuXHRcdH1cblxuXHRcdGlmIChcImZ1bmN0aW9uXCIgIT09IHR5cGVvZiBhY3Rpb24pIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoYFtPV2ViUm91dGVdIGludmFsaWQgYWN0aW9uIHR5cGUsIGdvdCBcIiR7IHR5cGVvZiBhY3Rpb259XCIgaW5zdGVhZCBvZiBcImZ1bmN0aW9uXCIuYCk7XG5cdFx0fVxuXG5cdFx0dGhpcy5hY3Rpb24gPSBhY3Rpb247XG5cdH1cblxuXHRpc0R5bmFtaWMoKSB7XG5cdFx0cmV0dXJuIHRoaXMucmVnICE9IG51bGw7XG5cdH1cblxuXHRnZXRQYXRoKCk6IHN0cmluZyB7XG5cdFx0cmV0dXJuIHRoaXMucGF0aDtcblx0fVxuXG5cdGdldEFjdGlvbigpOiB0Um91dGVBY3Rpb24ge1xuXHRcdHJldHVybiB0aGlzLmFjdGlvbjtcblx0fVxuXG5cdGlzKHBhdGg6IHN0cmluZyk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiAodGhpcy5yZWcpID8gdGhpcy5yZWcudGVzdChwYXRoKSA6IHRoaXMucGF0aCA9PT0gcGF0aDtcblx0fVxuXG5cdHBhcnNlKHBhdGg6IHN0cmluZyk6IHRSb3V0ZVBhcmFtcyB7XG5cblx0XHRpZiAodGhpcy5pc0R5bmFtaWMoKSkge1xuXHRcdFx0bGV0IGZvdW5kczogYW55O1xuXG5cdFx0XHRpZiAoZm91bmRzID0gU3RyaW5nKHBhdGgpLm1hdGNoKHRoaXMucmVnIGFzIFJlZ0V4cCkpIHtcblx0XHRcdFx0cmV0dXJuIHRoaXMudG9rZW5zLnJlZHVjZSgoYWNjOiBhbnksIGtleTogc3RyaW5nLCBpbmRleDogbnVtYmVyKSA9PiB7XG5cdFx0XHRcdFx0YWNjW2tleV0gPSBmb3VuZHNbaW5kZXggKyAxXTtcblx0XHRcdFx0XHRyZXR1cm4gYWNjO1xuXHRcdFx0XHR9LCB7fSk7XG5cblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4ge307XG5cdH1cbn1cblxuZXhwb3J0IHR5cGUgdFJvdXRlU3RhdGVJdGVtID0gc3RyaW5nIHwgbnVtYmVyIHwgbnVsbCB8IHVuZGVmaW5lZCB8IERhdGUgfCB0Um91dGVTdGF0ZU9iamVjdDtcbmV4cG9ydCB0eXBlIHRSb3V0ZVN0YXRlT2JqZWN0ID0ge1xuXHRba2V5OiBzdHJpbmddOiB0Um91dGVTdGF0ZUl0ZW1cbn07XG5cbmV4cG9ydCBjbGFzcyBPV2ViUm91dGVDb250ZXh0IHtcblx0cHJpdmF0ZSBfdG9rZW5zOiB0Um91dGVQYXJhbXM7XG5cdHByaXZhdGUgX3N0b3BwZWQ6IGJvb2xlYW4gPSBmYWxzZTtcblx0cHJpdmF0ZSByZWFkb25seSBfcGF0aDogc3RyaW5nO1xuXHRwcml2YXRlIHJlYWRvbmx5IF9zdGF0ZTogdFJvdXRlU3RhdGVPYmplY3Q7XG5cdHByaXZhdGUgcmVhZG9ubHkgX3JvdXRlcjogT1dlYlJvdXRlcjtcblxuXHRjb25zdHJ1Y3Rvcihyb3V0ZXI6IE9XZWJSb3V0ZXIsIHBhdGg6IHN0cmluZywgc3RhdGU6IHRSb3V0ZVN0YXRlT2JqZWN0KSB7XG5cdFx0dGhpcy5fcGF0aCAgID0gcGF0aDtcblx0XHR0aGlzLl90b2tlbnMgPSB7fTtcblx0XHR0aGlzLl9zdGF0ZSAgPSBzdGF0ZSB8fCB7fTtcblx0XHR0aGlzLl9yb3V0ZXIgPSByb3V0ZXI7XG5cdH1cblxuXHRnZXRUb2tlbih0b2tlbjogc3RyaW5nKTogYW55IHtcblx0XHRyZXR1cm4gdGhpcy5fdG9rZW5zW3Rva2VuXTtcblx0fVxuXG5cdGdldFRva2VucygpIHtcblx0XHRyZXR1cm4gT2JqZWN0LmNyZWF0ZSh0aGlzLl90b2tlbnMpO1xuXHR9XG5cblx0Z2V0UGF0aCgpOiBzdHJpbmcge1xuXHRcdHJldHVybiB0aGlzLl9wYXRoO1xuXHR9XG5cblx0Z2V0U3RhdGVJdGVtKGtleTogc3RyaW5nKTogdFJvdXRlU3RhdGVJdGVtIHtcblx0XHRyZXR1cm4gdGhpcy5fc3RhdGVba2V5XTtcblx0fVxuXG5cdHNldFN0YXRlSXRlbShrZXk6IHN0cmluZywgdmFsdWU6IHRSb3V0ZVN0YXRlSXRlbSk6IHRoaXMge1xuXHRcdHRoaXMuX3N0YXRlW2tleV0gPSB2YWx1ZTtcblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHN0b3BwZWQoKTogYm9vbGVhbiB7XG5cdFx0cmV0dXJuIHRoaXMuX3N0b3BwZWQ7XG5cdH1cblxuXHRzdG9wKCk6IHRoaXMge1xuXHRcdGlmICghdGhpcy5fc3RvcHBlZCkge1xuXHRcdFx0Y29uc29sZS53YXJuKFwiW09XZWJEaXNwYXRjaENvbnRleHRdIHJvdXRlIGNvbnRleHQgd2lsbCBzdG9wLlwiKTtcblx0XHRcdHRoaXMuc2F2ZSgpOy8vIHNhdmUgYmVmb3JlIHN0b3Bcblx0XHRcdHRoaXMuX3N0b3BwZWQgPSB0cnVlO1xuXHRcdFx0Y29uc29sZS53YXJuKFwiW09XZWJEaXNwYXRjaENvbnRleHRdIHJvdXRlIGNvbnRleHQgd2FzIHN0b3BwZWQhXCIpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRjb25zb2xlLndhcm4oXCJbT1dlYkRpc3BhdGNoQ29udGV4dF0gcm91dGUgY29udGV4dCBhbHJlYWR5IHN0b3BwZWQhXCIpO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHNhdmUoKTogdGhpcyB7XG5cdFx0aWYgKCF0aGlzLnN0b3BwZWQoKSkge1xuXHRcdFx0Y29uc29sZS5sb2coXCJbT1dlYkRpc3BhdGNoQ29udGV4dF0gc2F2aW5nIHN0YXRlIVwiKTtcblx0XHRcdHRoaXMuX3JvdXRlci5yZXBsYWNlSGlzdG9yeSh0aGlzLl9wYXRoLCB0aGlzLl9zdGF0ZSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGNvbnNvbGUuZXJyb3IoXCJbT1dlYkRpc3BhdGNoQ29udGV4dF0geW91IHNob3VsZG4ndCB0cnkgdG8gc2F2ZSB3aGVuIHN0b3BwZWQuXCIpXG5cdFx0fVxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0YWN0aW9uUnVubmVyKHJvdXRlOiBPV2ViUm91dGUpOiB0aGlzIHtcblx0XHR0aGlzLl90b2tlbnMgPSByb3V0ZS5wYXJzZSh0aGlzLl9wYXRoKTtcblxuXHRcdHJvdXRlLmdldEFjdGlvbigpKHRoaXMpO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT1dlYlJvdXRlciB7XG5cdHByaXZhdGUgcmVhZG9ubHkgX2Jhc2VVcmw6IHN0cmluZztcblx0cHJpdmF0ZSByZWFkb25seSBfaGFzaE1vZGU6IGJvb2xlYW47XG5cdHByaXZhdGUgX2N1cnJlbnRfcGF0aDogc3RyaW5nICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBcIlwiO1xuXHRwcml2YXRlIF9yb3V0ZXM6IE9XZWJSb3V0ZVtdICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gW107XG5cdHByaXZhdGUgX2luaXRpYWxpemVkOiBib29sZWFuICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBmYWxzZTtcblx0cHJpdmF0ZSBfbGlzdGVuaW5nOiBib29sZWFuICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IGZhbHNlO1xuXHRwcml2YXRlIF9ub3RGb3VuZDogdW5kZWZpbmVkIHwgKChwYXRoOiBzdHJpbmcpID0+IHZvaWQpID0gdW5kZWZpbmVkO1xuXHRwcml2YXRlIHJlYWRvbmx5IF9wb3BTdGF0ZUxpc3RlbmVyOiAoZTogUG9wU3RhdGVFdmVudCkgPT4gdm9pZDtcblx0cHJpdmF0ZSBfZGlzcGF0Y2hfaWQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IDA7XG5cdHByaXZhdGUgX2N1cnJlbnRfZGlzcGF0Y2hlcj86IGlSb3V0ZURpc3BhdGNoZXI7XG5cblx0Y29uc3RydWN0b3IoYmFzZVVybDogc3RyaW5nLCBoYXNoTW9kZTogYm9vbGVhbiA9IHRydWUpIHtcblx0XHRsZXQgciAgICAgICAgICAgICAgICAgID0gdGhpcztcblx0XHR0aGlzLl9iYXNlVXJsICAgICAgICAgID0gYmFzZVVybDtcblx0XHR0aGlzLl9oYXNoTW9kZSAgICAgICAgID0gaGFzaE1vZGU7XG5cdFx0dGhpcy5fcG9wU3RhdGVMaXN0ZW5lciA9IChlOiBQb3BTdGF0ZUV2ZW50KSA9PiB7XG5cdFx0XHRyLm9uUG9wU3RhdGUoZSk7XG5cdFx0fTtcblxuXHRcdGNvbnNvbGUubG9nKFwiW09XZWJSb3V0ZXJdIHJlYWR5IVwiKTtcblx0fVxuXG5cdHN0YXJ0KGZpcnN0UnVuOiBib29sZWFuID0gdHJ1ZSwgcGF0aDogc3RyaW5nID0gdGhpcy5nZXRMb2NhdGlvblBhdGgoKSk6IHRoaXMge1xuXHRcdGlmICghdGhpcy5faW5pdGlhbGl6ZWQpIHtcblx0XHRcdHRoaXMuX2luaXRpYWxpemVkID0gdHJ1ZTtcblx0XHRcdHRoaXMucmVnaXN0ZXIoKTtcblx0XHRcdGNvbnNvbGUubG9nKFwiW09XZWJSb3V0ZXJdIHN0YXJ0IHJvdXRpbmchXCIpO1xuXHRcdFx0Y29uc29sZS5sb2coXCJbT1dlYlJvdXRlcl0gd2F0Y2hpbmcgcm91dGVzIC0+XCIsIHRoaXMuX3JvdXRlcyk7XG5cdFx0XHRmaXJzdFJ1biAmJiB0aGlzLmJyb3dzZVRvKHBhdGgsIHVuZGVmaW5lZCwgZmFsc2UpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRjb25zb2xlLndhcm4oXCJbT1dlYlJvdXRlcl0gcm91dGVyIGFscmVhZHkgc3RhcnRlZCFcIik7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRzdG9wUm91dGluZygpOiB0aGlzIHtcblx0XHRpZiAodGhpcy5faW5pdGlhbGl6ZWQpIHtcblx0XHRcdHRoaXMuX2luaXRpYWxpemVkID0gZmFsc2U7XG5cdFx0XHR0aGlzLnVucmVnaXN0ZXIoKTtcblx0XHRcdGNvbnNvbGUubG9nKFwiW09XZWJSb3V0ZXJdIHN0b3Agcm91dGluZyFcIik7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGNvbnNvbGUud2FybihcIltPV2ViUm91dGVyXSB5b3Ugc2hvdWxkIHN0YXJ0IHJvdXRpbmcgZmlyc3QhXCIpO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0Z2V0Q3VycmVudFBhdGgoKTogc3RyaW5nIHtcblx0XHRyZXR1cm4gdGhpcy5fY3VycmVudF9wYXRoO1xuXHR9XG5cblx0Z2V0TG9jYXRpb25QYXRoKCk6IHN0cmluZyB7XG5cdFx0Ly8gVE9ETyB3aGVuIHVzaW5nIHBhdGhuYW1lIG1ha2Ugc3VyZSB0byByZW1vdmUgYmFzZSB1cmkgcGF0aG5hbWUgZm9yIGFwcCBpbiBzdWJkaXJlY3Rvcnlcblx0XHRyZXR1cm4gZml4UGF0aCh3TG9jW3RoaXMuX2hhc2hNb2RlID8gXCJoYXNoXCIgOiBcInBhdGhuYW1lXCJdKTtcblx0fVxuXG5cdHBhdGhUb1VSTChwYXRoOiBzdHJpbmcpOiBVUkwge1xuXHRcdHBhdGggPSBmaXhQYXRoKHBhdGgpO1xuXHRcdHJldHVybiBuZXcgVVJMKHRoaXMuX2hhc2hNb2RlID8gXCIjXCIgKyBwYXRoIDogcGF0aCwgdGhpcy5fYmFzZVVybCk7XG5cdH1cblxuXHRwcml2YXRlIHJlZ2lzdGVyKCk6IHRoaXMge1xuXHRcdGlmICghdGhpcy5fbGlzdGVuaW5nKSB7XG5cdFx0XHR0aGlzLl9saXN0ZW5pbmcgPSB0cnVlO1xuXHRcdFx0d2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJwb3BzdGF0ZVwiLCB0aGlzLl9wb3BTdGF0ZUxpc3RlbmVyLCBmYWxzZSk7XG5cdFx0fVxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0cHJpdmF0ZSB1bnJlZ2lzdGVyKCk6IHRoaXMge1xuXHRcdGlmICh0aGlzLl9saXN0ZW5pbmcpIHtcblx0XHRcdHRoaXMuX2xpc3RlbmluZyA9IGZhbHNlO1xuXHRcdFx0d2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJwb3BzdGF0ZVwiLCB0aGlzLl9wb3BTdGF0ZUxpc3RlbmVyLCBmYWxzZSk7XG5cdFx0fVxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0cHJpdmF0ZSBvblBvcFN0YXRlKGU6IFBvcFN0YXRlRXZlbnQpIHtcblx0XHRjb25zb2xlLmxvZyhcIltPV2ViUm91dGVyXSBwb3BzdGF0ZSAtPlwiLCBhcmd1bWVudHMpO1xuXG5cdFx0aWYgKGUuc3RhdGUpIHtcblx0XHRcdHRoaXMuYnJvd3NlVG8oZS5zdGF0ZS5wYXRoLCBlLnN0YXRlLmRhdGEsIGZhbHNlKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5icm93c2VUbyh0aGlzLmdldExvY2F0aW9uUGF0aCgpLCB1bmRlZmluZWQsIGZhbHNlKTtcblx0XHR9XG5cdH1cblxuXHRvbihwYXRoOiB0Um91dGUsIHJ1bGVzOiB0Um91dGVPcHRpb25zID0ge30sIGFjdGlvbjogdFJvdXRlQWN0aW9uKTogdGhpcyB7XG5cdFx0dGhpcy5fcm91dGVzLnB1c2gobmV3IE9XZWJSb3V0ZShwYXRoLCBydWxlcywgYWN0aW9uKSk7XG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRub3RGb3VuZChjYWxsYmFjazogKHBhdGg6IHN0cmluZykgPT4gdm9pZCk6IHRoaXMge1xuXHRcdHRoaXMuX25vdEZvdW5kID0gY2FsbGJhY2s7XG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRnb0JhY2soZGlzdGFuY2U6IG51bWJlciA9IDEpOiB0aGlzIHtcblx0XHRpZiAoZGlzdGFuY2UgPiAwKSB7XG5cdFx0XHRjb25zb2xlLmxvZyhcIltPV2ViUm91dGVyXSBnb2luZyBiYWNrIC0+IFwiLCBkaXN0YW5jZSk7XG5cdFx0XHRsZXQgaExlbiA9IHdIaXN0b3J5Lmxlbmd0aDtcblx0XHRcdGlmIChoTGVuID4gMSkge1xuXHRcdFx0XHRpZiAoaExlbiA+PSBkaXN0YW5jZSkge1xuXHRcdFx0XHRcdHdIaXN0b3J5LmdvKC1kaXN0YW5jZSk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0d0hpc3RvcnkuZ28oLWhMZW4pO1xuXHRcdFx0XHR9XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRjb25zb2xlLndhcm4oXCJbT1dlYlJvdXRlcl0gY2FuJ3QgZ28gYmFjayAtPiBoaXN0b3J5Lmxlbmd0aCA9PT0gMVwiLCBkaXN0YW5jZSk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRicm93c2VUbyhwYXRoOiBzdHJpbmcsIHN0YXRlOiB0Um91dGVTdGF0ZU9iamVjdCA9IHt9LCBwdXNoOiBib29sZWFuID0gdHJ1ZSwgaWdub3JlSWZTYW1lUGF0aDogYm9vbGVhbiA9IGZhbHNlKTogdGhpcyB7XG5cdFx0cGF0aCA9IGZpeFBhdGgocGF0aCk7XG5cblx0XHRjb25zb2xlLmxvZyhcIltPV2ViUm91dGVyXSBicm93c2luZyB0byAtPiBcIiwgcGF0aCwgc3RhdGUsIHB1c2gpO1xuXG5cdFx0aWYgKGlnbm9yZUlmU2FtZVBhdGggJiYgdGhpcy5fY3VycmVudF9wYXRoID09PSBwYXRoKSB7XG5cdFx0XHRjb25zb2xlLmxvZyhcIltPV2ViUm91dGVyXSBpZ25vcmUgc2FtZSBwYXRoIC0+IFwiLCBwYXRoKTtcblx0XHRcdHJldHVybiB0aGlzO1xuXHRcdH1cblxuXHRcdGlmICh0aGlzLl9jdXJyZW50X2Rpc3BhdGNoZXIgJiYgdGhpcy5fY3VycmVudF9kaXNwYXRjaGVyLmlzQWN0aXZlKCkpIHtcblx0XHRcdHRoaXMuX2N1cnJlbnRfZGlzcGF0Y2hlci5jYW5jZWwoKTtcblx0XHR9XG5cblx0XHR0aGlzLl9jdXJyZW50X3BhdGggPSBwYXRoO1xuXG5cdFx0cHVzaCAmJiB0aGlzLmFkZEhpc3RvcnkocGF0aCwgc3RhdGUpO1xuXG5cdFx0bGV0IGNkID0gdGhpcy5fY3VycmVudF9kaXNwYXRjaGVyID0gdGhpcy5jcmVhdGVEaXNwYXRjaGVyKHBhdGgsIHN0YXRlLCArK3RoaXMuX2Rpc3BhdGNoX2lkKTtcblxuXHRcdGNkLmRpc3BhdGNoKCk7XG5cblx0XHRpZiAoY2QuaWQgPT09IHRoaXMuX2Rpc3BhdGNoX2lkICYmICFjZC5jb250ZXh0LnN0b3BwZWQoKSkge1xuXHRcdFx0aWYgKCFjZC5mb3VuZC5sZW5ndGgpIHtcblx0XHRcdFx0Y29uc29sZS53YXJuKFwiW09XZWJSb3V0ZXJdIG5vIHJvdXRlIGZvdW5kIGZvciBwYXRoIC0+XCIsIHBhdGgpO1xuXHRcdFx0XHRpZiAodGhpcy5fbm90Rm91bmQpIHtcblx0XHRcdFx0XHR0aGlzLl9ub3RGb3VuZChwYXRoKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRjb25zb2xlLmVycm9yKFwiW09XZWJSb3V0ZXJdIG5vdEZvdW5kIGFjdGlvbiBpcyBub3QgZGVmaW5lZCFcIik7XG5cdFx0XHRcdFx0dGhpcy5zdG9wUm91dGluZygpO1xuXHRcdFx0XHR9XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRjZC5jb250ZXh0LnNhdmUoKTtcblx0XHRcdFx0Y29uc29sZS5sb2coXCJbT1dlYlJvdXRlcl0gc3VjY2VzcyAtPlwiLCBwYXRoKTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdGFkZEhpc3RvcnkocGF0aDogc3RyaW5nLCBkYXRhOiB0Um91dGVTdGF0ZU9iamVjdCwgdGl0bGU6IHN0cmluZyA9IFwiXCIpOiB0aGlzIHtcblx0XHRwYXRoICAgICAgPSBmaXhQYXRoKHBhdGgpO1xuXHRcdHRpdGxlICAgICA9IHRpdGxlICYmIHRpdGxlLmxlbmd0aCA/IHRpdGxlIDogd0RvYy50aXRsZTtcblx0XHRsZXQgc3RhdGUgPSB7XG5cdFx0XHRcdFwicGF0aFwiOiBwYXRoLFxuXHRcdFx0XHRcImRhdGFcIjogZGF0YVxuXHRcdFx0fSxcblx0XHRcdHVybCAgID0gdGhpcy5wYXRoVG9VUkwocGF0aCk7XG5cblx0XHR3SGlzdG9yeS5wdXNoU3RhdGUoc3RhdGUsIHRpdGxlLCB1cmwuaHJlZik7XG5cdFx0Y29uc29sZS53YXJuKFwiW09XZWJEaXNwYXRjaENvbnRleHRdIGhpc3RvcnkgYWRkZWRcIiwgd0hpc3Rvcnkuc3RhdGUsIHVybC5ocmVmKTtcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0cmVwbGFjZUhpc3RvcnkocGF0aDogc3RyaW5nLCBkYXRhOiB0Um91dGVTdGF0ZU9iamVjdCwgdGl0bGU6IHN0cmluZyA9IFwiXCIpOiB0aGlzIHtcblx0XHRwYXRoICAgICAgPSBmaXhQYXRoKHBhdGgpO1xuXHRcdHRpdGxlICAgICA9IHRpdGxlICYmIHRpdGxlLmxlbmd0aCA/IHRpdGxlIDogd0RvYy50aXRsZTtcblx0XHRsZXQgc3RhdGUgPSB7XG5cdFx0XHRcdFwicGF0aFwiOiBwYXRoLFxuXHRcdFx0XHRcImRhdGFcIjogZGF0YVxuXHRcdFx0fSxcblx0XHRcdHVybCAgID0gdGhpcy5wYXRoVG9VUkwocGF0aCk7XG5cblx0XHR3SGlzdG9yeS5yZXBsYWNlU3RhdGUoc3RhdGUsIHRpdGxlLCB1cmwuaHJlZik7XG5cdFx0Y29uc29sZS53YXJuKFwiW09XZWJEaXNwYXRjaENvbnRleHRdIGhpc3RvcnkgdXBkYXRlZFwiLCB3SGlzdG9yeS5zdGF0ZSk7XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHByaXZhdGUgY3JlYXRlRGlzcGF0Y2hlcihwYXRoOiBzdHJpbmcsIHN0YXRlOiB0Um91dGVTdGF0ZU9iamVjdCwgaWQ6IG51bWJlcik6IGlSb3V0ZURpc3BhdGNoZXIge1xuXG5cdFx0Y29uc29sZS5sb2coYFtPV2ViUm91dGVyXVtkaXNwYXRjaGVyLSR7aWR9XSBjcmVhdGlvbi5gKTtcblxuXHRcdGxldCBjdHggICAgICAgICAgICAgICAgPSB0aGlzLFxuXHRcdFx0Zm91bmQ6IE9XZWJSb3V0ZVtdID0gW10sXG5cdFx0XHRsZW4gICAgICAgICAgICAgICAgPSB0aGlzLl9yb3V0ZXMubGVuZ3RoLFxuXHRcdFx0YWN0aXZlICAgICAgICAgICAgID0gZmFsc2UsXG5cdFx0XHRyb3V0ZUNvbnRleHQgICAgICAgPSBuZXcgT1dlYlJvdXRlQ29udGV4dCh0aGlzLCBwYXRoLCBzdGF0ZSksXG5cdFx0XHRvICAgICAgICAgICAgICAgICAgPSB7XG5cdFx0XHRcdGNvbnRleHQgOiByb3V0ZUNvbnRleHQsXG5cdFx0XHRcdGlkLFxuXHRcdFx0XHRmb3VuZCxcblx0XHRcdFx0aXNBY3RpdmU6ICgpID0+IGFjdGl2ZSxcblx0XHRcdFx0Y2FuY2VsICA6IGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0XHRpZiAoYWN0aXZlKSB7XG5cdFx0XHRcdFx0XHRhY3RpdmUgPSBmYWxzZTtcblx0XHRcdFx0XHRcdGNvbnNvbGUud2FybihgW09XZWJSb3V0ZXJdW2Rpc3BhdGNoZXItJHtpZH1dIGNhbmNlbCBjYWxsZWQhYCk7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdGNvbnNvbGUuZXJyb3IoYFtPV2ViUm91dGVyXVtkaXNwYXRjaGVyLSR7aWR9XSBjYW5jZWwgY2FsbGVkIHdoZW4gaW5hY3RpdmUuYCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9LFxuXHRcdFx0XHRkaXNwYXRjaDogZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRcdGlmICghYWN0aXZlKSB7XG5cdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhgW09XZWJSb3V0ZXJdW2Rpc3BhdGNoZXItJHtpZH1dIHN0YXJ0IC0+YCwgbyk7XG5cdFx0XHRcdFx0XHRhY3RpdmUgPSB0cnVlO1xuXHRcdFx0XHRcdFx0bGV0IGkgID0gLTE7XG5cblx0XHRcdFx0XHRcdHdoaWxlICgrK2kgPCBsZW4pIHtcblx0XHRcdFx0XHRcdFx0aWYgKCFhY3RpdmUpIHtcblx0XHRcdFx0XHRcdFx0XHRjb25zb2xlLndhcm4oYFtPV2ViUm91dGVyXVtkaXNwYXRjaGVyLSR7aWR9XSBicm93c2VUbyBjYWxsZWQgd2hpbGUgZGlzcGF0Y2hpbmc6ICR7cGF0aH0gLT4gJHtjdHguX2N1cnJlbnRfcGF0aH1gKTtcblx0XHRcdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdGxldCByb3V0ZSA9IGN0eC5fcm91dGVzW2ldO1xuXG5cdFx0XHRcdFx0XHRcdGlmIChyb3V0ZUNvbnRleHQuc3RvcHBlZCgpKSB7XG5cdFx0XHRcdFx0XHRcdFx0Y29uc29sZS53YXJuKGBbT1dlYlJvdXRlcl1bZGlzcGF0Y2hlci0ke2lkfV0gY2FuY2VsZWQgZm9yIFwiJHtwYXRofVwiIGJ5IHJvdXRlIGFjdGlvbiAtPmAsIHJvdXRlLmdldEFjdGlvbigpKTtcblx0XHRcdFx0XHRcdFx0XHRvLmNhbmNlbCgpO1xuXHRcdFx0XHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdFx0aWYgKHJvdXRlLmlzKHBhdGgpKSB7XG5cdFx0XHRcdFx0XHRcdFx0Zm91bmQucHVzaChyb3V0ZSk7XG5cdFx0XHRcdFx0XHRcdFx0cm91dGVDb250ZXh0LmFjdGlvblJ1bm5lcihyb3V0ZSk7XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0YWN0aXZlID0gZmFsc2U7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdGNvbnNvbGUud2FybihgW09XZWJSb3V0ZXJdW2Rpc3BhdGNoZXItJHtpZH1dIGlzIGJ1c3lgKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH07XG5cblx0XHRyZXR1cm4gbztcblx0fVxufSJdfQ==