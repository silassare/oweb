"use strict";
/*
 t = "path/to/:id/file/:index/name.:format";
 p = {id:"num",index:"alpha",format:"alpha-num"};
 parseDynamicPath(t,p);
*/
import Utils from "./utils/Utils";
const token_type_reg_map = {
    "num": (/(\d+)/).source,
    "alpha": (/([a-zA-Z]+)/).source,
    "alpha-u": (/([a-z]+)/).source,
    "alpha-l": (/([A-Z]+)/).source,
    "alpha-num": (/([a-zA-Z0-9]+)/).source,
    "alpha-num-l": (/([a-z0-9]+)/).source,
    "alpha-num-u": (/([A-Z0-9]+)/).source,
    "any": /([^/]+)/.source
}, token_reg = /:([a-z][a-z0-9_]*)/i, wLoc = window.location, wDoc = window.document, wHistory = window.history;
let escapeString = function (str) {
    return str.replace(/([.+*?=^!:${}()[\]|\/])/g, "\\$1");
};
let stringReg = function (str) {
    return new RegExp(escapeString(str));
};
let fixPath = (path) => {
    if (!path.length || path == "/") {
        return "/";
    }
    path = path.replace(/^#/, "");
    if (path[0] != "/") {
        path = "/" + path;
    }
    return path;
};
let parseDynamicPath = function (path, options) {
    let tokens = [], reg = "", _path = path, match;
    while ((match = token_reg.exec(_path)) != null) {
        let found = match[0], token = match[1], rule = options[token] || "any", head = _path.slice(0, match.index);
        if (head.length) {
            reg += stringReg(head).source;
        }
        if (typeof rule === "string" && rule in token_type_reg_map) {
            reg += token_type_reg_map[rule];
        }
        else if (rule instanceof RegExp) {
            reg += rule.source;
        }
        else {
            throw new Error("Invalid rule for token ':" + token + "' in path '" + path + "'");
        }
        tokens.push(token);
        _path = _path.slice(match.index + found.length);
    }
    if (!reg.length) {
        return {
            reg: null,
            tokens: tokens
        };
    }
    if (_path.length) {
        reg += stringReg(_path).source;
    }
    return {
        reg: new RegExp("^" + reg + "$"),
        tokens: tokens
    };
};
export class OWebRoute {
    constructor(path, rules, action) {
        if (path instanceof RegExp) {
            this.path = path.toString();
            this.reg = path;
            this.tokens = Utils.isArray(rules) ? rules : [];
        }
        else if (Utils.isString(path) && path.length) {
            rules = (Utils.isPlainObject(rules) ? rules : {});
            let p = parseDynamicPath(path, rules);
            this.path = path;
            this.reg = p.reg;
            this.tokens = p.tokens;
        }
        else {
            throw new TypeError("[OWebRoute] invalid route path, string or RegExp required.");
        }
        if ("function" !== typeof action) {
            throw new TypeError(`[OWebRoute] invalid action type, got "${typeof action}" instead of "function".`);
        }
        this.action = action;
    }
    isDynamic() {
        return this.reg != null;
    }
    getPath() {
        return this.path;
    }
    getAction() {
        return this.action;
    }
    is(path) {
        return (this.reg) ? this.reg.test(path) : this.path === path;
    }
    parse(path) {
        if (this.isDynamic()) {
            let founds;
            if (founds = String(path).match(this.reg)) {
                return this.tokens.reduce((acc, key, index) => {
                    acc[key] = founds[index + 1];
                    return acc;
                }, {});
            }
        }
        return {};
    }
}
export class OWebDispatchContext {
    constructor(router, path, state) {
        this._stopped = false;
        this._path = path;
        this._tokens = {};
        this._state = state || {};
        this._router = router;
    }
    getToken(token) {
        return this._tokens[token];
    }
    getTokens() {
        return Object.create(this._tokens);
    }
    getPath() {
        return this._path;
    }
    getStateItem(key) {
        return this._state[key];
    }
    setStateItem(key, value) {
        this._state[key] = value;
        return this;
    }
    stopped() {
        return this._stopped;
    }
    stop() {
        if (!this._stopped) {
            console.warn("[OWebDispatchContext] route context will stop.");
            this.save(); // save before stop
            this._stopped = true;
            console.warn("[OWebDispatchContext] route context was stopped!");
        }
        else {
            console.warn("[OWebDispatchContext] route context already stopped!");
        }
        return this;
    }
    save() {
        if (!this.stopped()) {
            console.log("[OWebDispatchContext] saving state!");
            this._router.replaceHistory(this._path, this._state);
        }
        else {
            console.error("[OWebDispatchContext] you shouldn't try to save when stopped.");
        }
        return this;
    }
    actionRunner(route) {
        this._tokens = route.parse(this._path);
        route.getAction()(this);
        return this;
    }
}
export default class OWebRouter {
    constructor(baseUrl, hashMode = true) {
        this._current_path = "";
        this._routes = [];
        this._initialized = false;
        this._listening = false;
        this._notFound = undefined;
        this._dispatch_id = 0;
        let r = this;
        this._baseUrl = baseUrl;
        this._hashMode = hashMode;
        this._popStateListener = (e) => {
            r.onPopState(e);
        };
        console.log("[OWebRouter] ready!");
    }
    start(firstRun = true, path = this.getLocationPath()) {
        if (!this._initialized) {
            this._initialized = true;
            this.register();
            console.log("[OWebRouter] start routing!");
            console.log("[OWebRouter] watching routes ->", this._routes);
            firstRun && this.browseTo(path, undefined, false);
        }
        else {
            console.warn("[OWebRouter] router already started!");
        }
        return this;
    }
    stopRouting() {
        if (this._initialized) {
            this._initialized = false;
            this.unregister();
            console.log("[OWebRouter] stop routing!");
        }
        else {
            console.warn("[OWebRouter] you should start routing first!");
        }
        return this;
    }
    getCurrentPath() {
        return this._current_path;
    }
    getLocationPath() {
        // TODO when using pathname make sure to remove base uri pathname for app in subdirectory
        return fixPath(wLoc[this._hashMode ? "hash" : "pathname"]);
    }
    pathToURL(path) {
        path = fixPath(path);
        return new URL(this._hashMode ? "#" + path : path, this._baseUrl);
    }
    register() {
        if (!this._listening) {
            this._listening = true;
            window.addEventListener("popstate", this._popStateListener, false);
        }
        return this;
    }
    unregister() {
        if (this._listening) {
            this._listening = false;
            window.removeEventListener("popstate", this._popStateListener, false);
        }
        return this;
    }
    onPopState(e) {
        console.log("[OWebRouter] popstate ->", arguments);
        if (e.state) {
            this.browseTo(e.state.path, e.state.data, false);
        }
        else {
            this.browseTo(this.getLocationPath(), undefined, false);
        }
    }
    on(path, rules = {}, action) {
        this._routes.push(new OWebRoute(path, rules, action));
        return this;
    }
    notFound(callback) {
        this._notFound = callback;
        return this;
    }
    goBack(distance = 1) {
        if (distance > 0) {
            console.log("[OWebRouter] going back -> ", distance);
            let hLen = wHistory.length;
            if (hLen > 1) {
                if (hLen >= distance) {
                    wHistory.go(-distance);
                }
                else {
                    wHistory.go(-hLen);
                }
            }
            else {
                console.warn("[OWebRouter] can't go back -> history.length === 1", distance);
            }
        }
        return this;
    }
    browseTo(path, state = {}, push = true, ignoreIfSamePath = false) {
        path = fixPath(path);
        console.log("[OWebRouter] browsing to -> ", path, state, push);
        if (ignoreIfSamePath && this._current_path !== path) {
            console.log("[OWebRouter] ignore same path -> ", path);
            return this;
        }
        if (this._current_dispatcher && this._current_dispatcher.isActive()) {
            this._current_dispatcher.cancel();
        }
        this._current_path = path;
        push && this.addHistory(path, state);
        let cd = this._current_dispatcher = this.createDispatcher(path, state, ++this._dispatch_id);
        cd.dispatch();
        if (cd.id === this._dispatch_id && !cd.context.stopped()) {
            if (!cd.found.length) {
                console.warn("[OWebRouter] no route found for path ->", path);
                if (this._notFound) {
                    this._notFound(path);
                }
                else {
                    console.error("[OWebRouter] notFound action is not defined!");
                    this.stopRouting();
                }
            }
            else {
                cd.context.save();
                console.log("[OWebRouter] success ->", path);
            }
        }
        return this;
    }
    addHistory(path, data, title = "") {
        path = fixPath(path);
        title = title && title.length ? title : wDoc.title;
        let state = {
            "path": path,
            "data": data
        }, url = this.pathToURL(path);
        wHistory.pushState(state, title, url.href);
        console.warn("[OWebDispatchContext] history added", wHistory.state, url.href);
        return this;
    }
    replaceHistory(path, data, title = "") {
        path = fixPath(path);
        title = title && title.length ? title : wDoc.title;
        let state = {
            "path": path,
            "data": data
        }, url = this.pathToURL(path);
        wHistory.replaceState(state, title, url.href);
        console.warn("[OWebDispatchContext] history updated", wHistory.state);
        return this;
    }
    createDispatcher(path, state, id) {
        console.log(`[OWebRouter][dispatcher-${id}] creation.`);
        let ctx = this, found = [], len = this._routes.length, active = false, dispatchContext = new OWebDispatchContext(this, path, state), o = {
            context: dispatchContext,
            id,
            found,
            isActive: () => active,
            cancel: function () {
                if (active) {
                    active = false;
                    console.warn(`[OWebRouter][dispatcher-${id}] cancel called!`);
                }
                else {
                    console.error(`[OWebRouter][dispatcher-${id}] cancel called when inactive.`);
                }
            },
            dispatch: function () {
                if (!active) {
                    console.log(`[OWebRouter][dispatcher-${id}] start ->`, o);
                    active = true;
                    let i = -1;
                    while (++i < len) {
                        if (!active) {
                            console.warn(`[OWebRouter][dispatcher-${id}] browseTo called while dispatching: ${path} -> ${ctx._current_path}`);
                            break;
                        }
                        let route = ctx._routes[i];
                        if (dispatchContext.stopped()) {
                            console.warn(`[OWebRouter][dispatcher-${id}] canceled for "${path}" by route action ->`, route.getAction());
                            o.cancel();
                            break;
                        }
                        if (route.is(path)) {
                            found.push(route);
                            dispatchContext.actionRunner(route);
                        }
                    }
                    active = false;
                }
                else {
                    console.warn(`[OWebRouter][dispatcher-${id}] is busy`);
                }
            }
        };
        return o;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlJvdXRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViUm91dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQztBQUNiOzs7O0VBSUU7QUFDRixPQUFPLEtBQUssTUFBTSxlQUFlLENBQUM7QUFtQmxDLE1BQU0sa0JBQWtCLEdBQUc7SUFDdkIsS0FBSyxFQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTTtJQUMvQixPQUFPLEVBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQyxNQUFNO0lBQ3JDLFNBQVMsRUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLE1BQU07SUFDbEMsU0FBUyxFQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTTtJQUNsQyxXQUFXLEVBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE1BQU07SUFDeEMsYUFBYSxFQUFFLENBQUMsYUFBYSxDQUFDLENBQUMsTUFBTTtJQUNyQyxhQUFhLEVBQUUsQ0FBQyxhQUFhLENBQUMsQ0FBQyxNQUFNO0lBQ3JDLEtBQUssRUFBVSxTQUFTLENBQUMsTUFBTTtDQUMvQixFQUNELFNBQVMsR0FBWSxxQkFBcUIsRUFDMUMsSUFBSSxHQUFpQixNQUFNLENBQUMsUUFBUSxFQUNwQyxJQUFJLEdBQWlCLE1BQU0sQ0FBQyxRQUFRLEVBQ3BDLFFBQVEsR0FBYSxNQUFNLENBQUMsT0FBTyxDQUFDO0FBRXZDLElBQUksWUFBWSxHQUFHLFVBQVUsR0FBVztJQUN2QyxPQUFPLEdBQUcsQ0FBQyxPQUFPLENBQUMsMEJBQTBCLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDeEQsQ0FBQyxDQUFDO0FBRUYsSUFBSSxTQUFTLEdBQUcsVUFBVSxHQUFXO0lBQ3BDLE9BQU8sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDdEMsQ0FBQyxDQUFDO0FBRUYsSUFBSSxPQUFPLEdBQUcsQ0FBQyxJQUFZLEVBQVUsRUFBRTtJQUN0QyxJQUFJLENB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QkFBMkIsRUFBRSxXQUFXLENBQUMsQ0FBQztpQkFDdkQ7WUFDRixDQUFDO1NBQ0QsQ0FBQztRQUVILE9BQU8sQ0FBQyxDQUFDO0lBQ1YsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG4vKlxuIHQgPSBcInBhdGgvdG8vOmlkL2ZpbGUvOmluZGV4L25hbWUuOmZvcm1hdFwiO1xuIHAgPSB7aWQ6XCJudW1cIixpbmRleDpcImFscGhhXCIsZm9ybWF0OlwiYWxwaGEtbnVtXCJ9O1xuIHBhcnNlRHluYW1pY1BhdGgodCxwKTtcbiovXG5pbXBvcnQgVXRpbHMgZnJvbSBcIi4vdXRpbHMvVXRpbHNcIjtcblxuZXhwb3J0IHR5cGUgdFJvdXRlT3B0aW9ucyA9IHsgW2tleTogc3RyaW5nXToga2V5b2YgdHlwZW9mIHRva2VuX3R5cGVfcmVnX21hcCB9O1xuZXhwb3J0IHR5cGUgdFJvdXRlUGFyYW1zID0geyBba2V5OiBzdHJpbmddOiBhbnkgfTtcbmV4cG9ydCB0eXBlIHRSb3V0ZUFjdGlvbiA9IChjdHg6IE9XZWJEaXNwYXRjaENvbnRleHQpID0+IHZvaWQ7XG5leHBvcnQgdHlwZSB0Um91dGVJbmZvID0geyByZWc6IFJlZ0V4cCB8IG51bGwsIHRva2VuczogQXJyYXk8c3RyaW5nPiB9O1xuXG5pbnRlcmZhY2UgaVJvdXRlRGlzcGF0Y2hlciB7XG5cdHJlYWRvbmx5IGlkOiBudW1iZXIsXG5cdHJlYWRvbmx5IGNvbnRleHQ6IE9XZWJEaXNwYXRjaENvbnRleHQsXG5cdHJlYWRvbmx5IGZvdW5kOiBPV2ViUm91dGVbXVxuXG5cdGlzQWN0aXZlKCk6IGJvb2xlYW4sXG5cblx0ZGlzcGF0Y2goKTogdm9pZCxcblxuXHRjYW5jZWwoKTogdm9pZCxcbn1cblxuY29uc3QgdG9rZW5fdHlwZV9yZWdfbWFwID0ge1xuXHRcdCAgXCJudW1cIiAgICAgICAgOiAoLyhcXGQrKS8pLnNvdXJjZSxcblx0XHQgIFwiYWxwaGFcIiAgICAgIDogKC8oW2EtekEtWl0rKS8pLnNvdXJjZSxcblx0XHQgIFwiYWxwaGEtdVwiICAgIDogKC8oW2Etel0rKS8pLnNvdXJjZSxcblx0XHQgIFwiYWxwaGEtbFwiICAgIDogKC8oW0EtWl0rKS8pLnNvdXJjZSxcblx0XHQgIFwiYWxwaGEtbnVtXCIgIDogKC8oW2EtekEtWjAtOV0rKS8pLnNvdXJjZSxcblx0XHQgIFwiYWxwaGEtbnVtLWxcIjogKC8oW2EtejAtOV0rKS8pLnNvdXJjZSxcblx0XHQgIFwiYWxwaGEtbnVtLXVcIjogKC8oW0EtWjAtOV0rKS8pLnNvdXJjZSxcblx0XHQgIFwiYW55XCIgICAgICAgIDogLyhbXi9dKykvLnNvdXJjZVxuXHQgIH0sXG5cdCAgdG9rZW5fcmVnICAgICAgICAgID0gLzooW2Etel1bYS16MC05X10qKS9pLFxuXHQgIHdMb2MgICAgICAgICAgICAgICA9IHdpbmRvdy5sb2NhdGlvbixcblx0ICB3RG9jICAgICAgICAgICAgICAgPSB3aW5kb3cuZG9jdW1lbnQsXG5cdCAgd0hpc3RvcnkgICAgICAgICAgID0gd2luZG93Lmhpc3Rvcnk7XG5cbmxldCBlc2NhcGVTdHJpbmcgPSBmdW5jdGlvbiAoc3RyOiBzdHJpbmcpIHtcblx0cmV0dXJuIHN0ci5yZXBsYWNlKC8oWy4rKj89XiE6JHt9KClbXFxdfFxcL10pL2csIFwiXFxcXCQxXCIpO1xufTtcblxubGV0IHN0cmluZ1JlZyA9IGZ1bmN0aW9uIChzdHI6IHN0cmluZykge1xuXHRyZXR1cm4gbmV3IFJlZ0V4cChlc2NhcGVTdHJpbmcoc3RyKSk7XG59O1xuXG5sZXQgZml4UGF0aCA9IChwYXRoOiBzdHJpbmcpOiBzdHJpbmcgPT4ge1xuXHRpZiAoIXBhdGgubGVuZ3RoIHx8IHBhdGggPT0gXCIvXCIpIHtcblx0XHRyZXR1cm4gXCIvXCI7XG5cdH1cblx0cGF0aCA9IHBhdGgucmVwbGFjZSgvXiMvLCBcIlwiKTtcblxuXHRpZiAocGF0aFswXSAhPSBcIi9cIikge1xuXHRcdHBhdGggPSBcIi9cIiArIHBhdGg7XG5cdH1cblxuXHRyZXR1cm4gcGF0aDtcbn07XG5cbmxldCBwYXJzZUR5bmFtaWNQYXRoID0gZnVuY3Rpb24gKHBhdGg6IHN0cmluZywgb3B0aW9uczogdFJvdXRlT3B0aW9ucyk6IHRSb3V0ZUluZm8ge1xuXG5cdGxldCB0b2tlbnM6IEFycmF5PHN0cmluZz4gPSBbXSxcblx0XHRyZWc6IHN0cmluZyAgICAgICAgICAgPSBcIlwiLFxuXHRcdF9wYXRoOiBzdHJpbmcgICAgICAgICA9IHBhdGgsXG5cdFx0bWF0Y2g6IFJlZ0V4cEV4ZWNBcnJheSB8IG51bGw7XG5cblx0d2hpbGUgKChtYXRjaCA9IHRva2VuX3JlZy5leGVjKF9wYXRoKSkgIT0gbnVsbCkge1xuXHRcdGxldCBmb3VuZDogYW55ICAgPSBtYXRjaFswXSxcblx0XHRcdHRva2VuOiBhbnkgICA9IG1hdGNoWzFdLFxuXHRcdFx0cnVsZTogYW55ICAgID0gb3B0aW9uc1t0b2tlbl0gfHwgXCJhbnlcIixcblx0XHRcdGhlYWQ6IHN0cmluZyA9IF9wYXRoLnNsaWNlKDAsIG1hdGNoLmluZGV4KTtcblxuXHRcdGlmIChoZWFkLmxlbmd0aCkge1xuXHRcdFx0cmVnICs9IHN0cmluZ1JlZyhoZWFkKS5zb3VyY2U7XG5cdFx0fVxuXG5cdFx0aWYgKHR5cGVvZiBydWxlID09PSBcInN0cmluZ1wiICYmIHJ1bGUgaW4gdG9rZW5fdHlwZV9yZWdfbWFwKSB7XG5cdFx0XHRyZWcgKz0gKHRva2VuX3R5cGVfcmVnX21hcCBhcyBhbnkpW3J1bGVdO1xuXHRcdH0gZWxzZSBpZiAocnVsZSBpbnN0YW5jZW9mIFJlZ0V4cCkge1xuXHRcdFx0cmVnICs9IHJ1bGUuc291cmNlO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIHJ1bGUgZm9yIHRva2VuICc6XCIgKyB0b2tlbiArIFwiJyBpbiBwYXRoICdcIiArIHBhdGggKyBcIidcIik7XG5cdFx0fVxuXG5cdFx0dG9rZW5zLnB1c2godG9rZW4pO1xuXG5cdFx0X3BhdGggPSBfcGF0aC5zbGljZShtYXRjaC5pbmRleCArIGZvdW5kLmxlbmd0aCk7XG5cdH1cblxuXHRpZiAoIXJlZy5sZW5ndGgpIHtcblx0XHRyZXR1cm4ge1xuXHRcdFx0cmVnICAgOiBudWxsLFxuXHRcdFx0dG9rZW5zOiB0b2tlbnNcblx0XHR9O1xuXHR9XG5cblx0aWYgKF9wYXRoLmxlbmd0aCkge1xuXHRcdHJlZyArPSBzdHJpbmdSZWcoX3BhdGgpLnNvdXJjZTtcblx0fVxuXG5cdHJldHVybiB7XG5cdFx0cmVnICAgOiBuZXcgUmVnRXhwKFwiXlwiICsgcmVnICsgXCIkXCIpLFxuXHRcdHRva2VuczogdG9rZW5zXG5cdH07XG59O1xuXG5leHBvcnQgY2xhc3MgT1dlYlJvdXRlIHtcblx0cHJpdmF0ZSByZWFkb25seSBwYXRoOiBzdHJpbmc7XG5cdHByaXZhdGUgcmVhZG9ubHkgcmVnOiBSZWdFeHAgfCBudWxsO1xuXHRwcml2YXRlIHRva2VuczogQXJyYXk8c3RyaW5nPjtcblx0cHJpdmF0ZSByZWFkb25seSBhY3Rpb246IHRSb3V0ZUFjdGlvbjtcblxuXHRjb25zdHJ1Y3RvcihwYXRoOiBzdHJpbmcgfCBSZWdFeHAsIHJ1bGVzOiB0Um91dGVPcHRpb25zIHwgQXJyYXk8c3RyaW5nPiwgYWN0aW9uOiB0Um91dGVBY3Rpb24pIHtcblxuXHRcdGlmIChwYXRoIGluc3RhbmNlb2YgUmVnRXhwKSB7XG5cdFx0XHR0aGlzLnBhdGggICA9IHBhdGgudG9TdHJpbmcoKTtcblx0XHRcdHRoaXMucmVnICAgID0gcGF0aDtcblx0XHRcdHRoaXMudG9rZW5zID0gVXRpbHMuaXNBcnJheShydWxlcykgPyBydWxlcyA6IFtdO1xuXHRcdH0gZWxzZSBpZiAoVXRpbHMuaXNTdHJpbmcocGF0aCkgJiYgcGF0aC5sZW5ndGgpIHtcblx0XHRcdHJ1bGVzICAgICAgID0gPHRSb3V0ZU9wdGlvbnM+IChVdGlscy5pc1BsYWluT2JqZWN0KHJ1bGVzKSA/IHJ1bGVzIDoge30pO1xuXHRcdFx0bGV0IHAgICAgICAgPSBwYXJzZUR5bmFtaWNQYXRoKHBhdGgsIHJ1bGVzKTtcblx0XHRcdHRoaXMucGF0aCAgID0gcGF0aDtcblx0XHRcdHRoaXMucmVnICAgID0gcC5yZWc7XG5cdFx0XHR0aGlzLnRva2VucyA9IHAudG9rZW5zO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR0aHJvdyBuZXcgVHlwZUVycm9yKFwiW09XZWJSb3V0ZV0gaW52YWxpZCByb3V0ZSBwYXRoLCBzdHJpbmcgb3IgUmVnRXhwIHJlcXVpcmVkLlwiKTtcblx0XHR9XG5cblx0XHRpZiAoXCJmdW5jdGlvblwiICE9PSB0eXBlb2YgYWN0aW9uKSB7XG5cdFx0XHR0aHJvdyBuZXcgVHlwZUVycm9yKGBbT1dlYlJvdXRlXSBpbnZhbGlkIGFjdGlvbiB0eXBlLCBnb3QgXCIkeyB0eXBlb2YgYWN0aW9ufVwiIGluc3RlYWQgb2YgXCJmdW5jdGlvblwiLmApO1xuXHRcdH1cblxuXHRcdHRoaXMuYWN0aW9uID0gYWN0aW9uO1xuXHR9XG5cblx0aXNEeW5hbWljKCkge1xuXHRcdHJldHVybiB0aGlzLnJlZyAhPSBudWxsO1xuXHR9XG5cblx0Z2V0UGF0aCgpOiBzdHJpbmcge1xuXHRcdHJldHVybiB0aGlzLnBhdGg7XG5cdH1cblxuXHRnZXRBY3Rpb24oKTogdFJvdXRlQWN0aW9uIHtcblx0XHRyZXR1cm4gdGhpcy5hY3Rpb247XG5cdH1cblxuXHRpcyhwYXRoOiBzdHJpbmcpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gKHRoaXMucmVnKSA/IHRoaXMucmVnLnRlc3QocGF0aCkgOiB0aGlzLnBhdGggPT09IHBhdGg7XG5cdH1cblxuXHRwYXJzZShwYXRoOiBzdHJpbmcpOiB0Um91dGVQYXJhbXMge1xuXG5cdFx0aWYgKHRoaXMuaXNEeW5hbWljKCkpIHtcblx0XHRcdGxldCBmb3VuZHM6IGFueTtcblxuXHRcdFx0aWYgKGZvdW5kcyA9IFN0cmluZyhwYXRoKS5tYXRjaCh0aGlzLnJlZyBhcyBSZWdFeHApKSB7XG5cdFx0XHRcdHJldHVybiB0aGlzLnRva2Vucy5yZWR1Y2UoKGFjYzogYW55LCBrZXk6IHN0cmluZywgaW5kZXg6IG51bWJlcikgPT4ge1xuXHRcdFx0XHRcdGFjY1trZXldID0gZm91bmRzW2luZGV4ICsgMV07XG5cdFx0XHRcdFx0cmV0dXJuIGFjYztcblx0XHRcdFx0fSwge30pO1xuXG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHt9O1xuXHR9XG59XG5cbmV4cG9ydCB0eXBlIHRSb3V0ZVN0YXRlSXRlbSA9IHN0cmluZyB8IG51bWJlciB8IG51bGwgfCB1bmRlZmluZWQgfCBEYXRlIHwgdFJvdXRlU3RhdGVPYmplY3Q7XG5leHBvcnQgdHlwZSB0Um91dGVTdGF0ZU9iamVjdCA9IHtcblx0W2tleTogc3RyaW5nXTogdFJvdXRlU3RhdGVJdGVtXG59O1xuXG5leHBvcnQgY2xhc3MgT1dlYkRpc3BhdGNoQ29udGV4dCB7XG5cdHByaXZhdGUgX3Rva2VuczogdFJvdXRlUGFyYW1zO1xuXHRwcml2YXRlIF9zdG9wcGVkOiBib29sZWFuID0gZmFsc2U7XG5cdHByaXZhdGUgcmVhZG9ubHkgX3BhdGg6IHN0cmluZztcblx0cHJpdmF0ZSByZWFkb25seSBfc3RhdGU6IHRSb3V0ZVN0YXRlT2JqZWN0O1xuXHRwcml2YXRlIHJlYWRvbmx5IF9yb3V0ZXI6IE9XZWJSb3V0ZXI7XG5cblx0Y29uc3RydWN0b3Iocm91dGVyOiBPV2ViUm91dGVyLCBwYXRoOiBzdHJpbmcsIHN0YXRlOiB0Um91dGVTdGF0ZU9iamVjdCkge1xuXHRcdHRoaXMuX3BhdGggICA9IHBhdGg7XG5cdFx0dGhpcy5fdG9rZW5zID0ge307XG5cdFx0dGhpcy5fc3RhdGUgID0gc3RhdGUgfHwge307XG5cdFx0dGhpcy5fcm91dGVyID0gcm91dGVyO1xuXHR9XG5cblx0Z2V0VG9rZW4odG9rZW46IHN0cmluZyk6IGFueSB7XG5cdFx0cmV0dXJuIHRoaXMuX3Rva2Vuc1t0b2tlbl07XG5cdH1cblxuXHRnZXRUb2tlbnMoKSB7XG5cdFx0cmV0dXJuIE9iamVjdC5jcmVhdGUodGhpcy5fdG9rZW5zKTtcblx0fVxuXG5cdGdldFBhdGgoKTogc3RyaW5nIHtcblx0XHRyZXR1cm4gdGhpcy5fcGF0aDtcblx0fVxuXG5cdGdldFN0YXRlSXRlbShrZXk6IHN0cmluZyk6IHRSb3V0ZVN0YXRlSXRlbSB7XG5cdFx0cmV0dXJuIHRoaXMuX3N0YXRlW2tleV07XG5cdH1cblxuXHRzZXRTdGF0ZUl0ZW0oa2V5OiBzdHJpbmcsIHZhbHVlOiB0Um91dGVTdGF0ZUl0ZW0pOiB0aGlzIHtcblx0XHR0aGlzLl9zdGF0ZVtrZXldID0gdmFsdWU7XG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRzdG9wcGVkKCk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiB0aGlzLl9zdG9wcGVkO1xuXHR9XG5cblx0c3RvcCgpOiB0aGlzIHtcblx0XHRpZiAoIXRoaXMuX3N0b3BwZWQpIHtcblx0XHRcdGNvbnNvbGUud2FybihcIltPV2ViRGlzcGF0Y2hDb250ZXh0XSByb3V0ZSBjb250ZXh0IHdpbGwgc3RvcC5cIik7XG5cdFx0XHR0aGlzLnNhdmUoKTsvLyBzYXZlIGJlZm9yZSBzdG9wXG5cdFx0XHR0aGlzLl9zdG9wcGVkID0gdHJ1ZTtcblx0XHRcdGNvbnNvbGUud2FybihcIltPV2ViRGlzcGF0Y2hDb250ZXh0XSByb3V0ZSBjb250ZXh0IHdhcyBzdG9wcGVkIVwiKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc29sZS53YXJuKFwiW09XZWJEaXNwYXRjaENvbnRleHRdIHJvdXRlIGNvbnRleHQgYWxyZWFkeSBzdG9wcGVkIVwiKTtcblx0XHR9XG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRzYXZlKCk6IHRoaXMge1xuXHRcdGlmICghdGhpcy5zdG9wcGVkKCkpIHtcblx0XHRcdGNvbnNvbGUubG9nKFwiW09XZWJEaXNwYXRjaENvbnRleHRdIHNhdmluZyBzdGF0ZSFcIik7XG5cdFx0XHR0aGlzLl9yb3V0ZXIucmVwbGFjZUhpc3RvcnkodGhpcy5fcGF0aCwgdGhpcy5fc3RhdGUpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRjb25zb2xlLmVycm9yKFwiW09XZWJEaXNwYXRjaENvbnRleHRdIHlvdSBzaG91bGRuJ3QgdHJ5IHRvIHNhdmUgd2hlbiBzdG9wcGVkLlwiKVxuXHRcdH1cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdGFjdGlvblJ1bm5lcihyb3V0ZTogT1dlYlJvdXRlKTogdGhpcyB7XG5cdFx0dGhpcy5fdG9rZW5zID0gcm91dGUucGFyc2UodGhpcy5fcGF0aCk7XG5cblx0XHRyb3V0ZS5nZXRBY3Rpb24oKSh0aGlzKTtcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJSb3V0ZXIge1xuXHRwcml2YXRlIHJlYWRvbmx5IF9iYXNlVXJsOiBzdHJpbmc7XG5cdHByaXZhdGUgcmVhZG9ubHkgX2hhc2hNb2RlOiBib29sZWFuO1xuXHRwcml2YXRlIF9jdXJyZW50X3BhdGg6IHN0cmluZyAgICAgICAgICAgICAgICAgICAgICAgICAgID0gXCJcIjtcblx0cHJpdmF0ZSBfcm91dGVzOiBPV2ViUm91dGVbXSAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IFtdO1xuXHRwcml2YXRlIF9pbml0aWFsaXplZDogYm9vbGVhbiAgICAgICAgICAgICAgICAgICAgICAgICAgID0gZmFsc2U7XG5cdHByaXZhdGUgX2xpc3RlbmluZzogYm9vbGVhbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBmYWxzZTtcblx0cHJpdmF0ZSBfbm90Rm91bmQ6IHVuZGVmaW5lZCB8ICgocGF0aDogc3RyaW5nKSA9PiB2b2lkKSA9IHVuZGVmaW5lZDtcblx0cHJpdmF0ZSByZWFkb25seSBfcG9wU3RhdGVMaXN0ZW5lcjogKGU6IFBvcFN0YXRlRXZlbnQpID0+IHZvaWQ7XG5cdHByaXZhdGUgX2Rpc3BhdGNoX2lkICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSAwO1xuXHRwcml2YXRlIF9jdXJyZW50X2Rpc3BhdGNoZXI/OiBpUm91dGVEaXNwYXRjaGVyO1xuXG5cdGNvbnN0cnVjdG9yKGJhc2VVcmw6IHN0cmluZywgaGFzaE1vZGU6IGJvb2xlYW4gPSB0cnVlKSB7XG5cdFx0bGV0IHIgICAgICAgICAgICAgICAgICA9IHRoaXM7XG5cdFx0dGhpcy5fYmFzZVVybCAgICAgICAgICA9IGJhc2VVcmw7XG5cdFx0dGhpcy5faGFzaE1vZGUgICAgICAgICA9IGhhc2hNb2RlO1xuXHRcdHRoaXMuX3BvcFN0YXRlTGlzdGVuZXIgPSAoZTogUG9wU3RhdGVFdmVudCkgPT4ge1xuXHRcdFx0ci5vblBvcFN0YXRlKGUpO1xuXHRcdH07XG5cblx0XHRjb25zb2xlLmxvZyhcIltPV2ViUm91dGVyXSByZWFkeSFcIik7XG5cdH1cblxuXHRzdGFydChmaXJzdFJ1bjogYm9vbGVhbiA9IHRydWUsIHBhdGg6IHN0cmluZyA9IHRoaXMuZ2V0TG9jYXRpb25QYXRoKCkpOiB0aGlzIHtcblx0XHRpZiAoIXRoaXMuX2luaXRpYWxpemVkKSB7XG5cdFx0XHR0aGlzLl9pbml0aWFsaXplZCA9IHRydWU7XG5cdFx0XHR0aGlzLnJlZ2lzdGVyKCk7XG5cdFx0XHRjb25zb2xlLmxvZyhcIltPV2ViUm91dGVyXSBzdGFydCByb3V0aW5nIVwiKTtcblx0XHRcdGNvbnNvbGUubG9nKFwiW09XZWJSb3V0ZXJdIHdhdGNoaW5nIHJvdXRlcyAtPlwiLCB0aGlzLl9yb3V0ZXMpO1xuXHRcdFx0Zmlyc3RSdW4gJiYgdGhpcy5icm93c2VUbyhwYXRoLCB1bmRlZmluZWQsIGZhbHNlKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc29sZS53YXJuKFwiW09XZWJSb3V0ZXJdIHJvdXRlciBhbHJlYWR5IHN0YXJ0ZWQhXCIpO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0c3RvcFJvdXRpbmcoKTogdGhpcyB7XG5cdFx0aWYgKHRoaXMuX2luaXRpYWxpemVkKSB7XG5cdFx0XHR0aGlzLl9pbml0aWFsaXplZCA9IGZhbHNlO1xuXHRcdFx0dGhpcy51bnJlZ2lzdGVyKCk7XG5cdFx0XHRjb25zb2xlLmxvZyhcIltPV2ViUm91dGVyXSBzdG9wIHJvdXRpbmchXCIpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRjb25zb2xlLndhcm4oXCJbT1dlYlJvdXRlcl0geW91IHNob3VsZCBzdGFydCByb3V0aW5nIGZpcnN0IVwiKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdGdldEN1cnJlbnRQYXRoKCk6IHN0cmluZyB7XG5cdFx0cmV0dXJuIHRoaXMuX2N1cnJlbnRfcGF0aDtcblx0fVxuXG5cdGdldExvY2F0aW9uUGF0aCgpOiBzdHJpbmcge1xuXHRcdC8vIFRPRE8gd2hlbiB1c2luZyBwYXRobmFtZSBtYWtlIHN1cmUgdG8gcmVtb3ZlIGJhc2UgdXJpIHBhdGhuYW1lIGZvciBhcHAgaW4gc3ViZGlyZWN0b3J5XG5cdFx0cmV0dXJuIGZpeFBhdGgod0xvY1t0aGlzLl9oYXNoTW9kZSA/IFwiaGFzaFwiIDogXCJwYXRobmFtZVwiXSk7XG5cdH1cblxuXHRwYXRoVG9VUkwocGF0aDogc3RyaW5nKTogVVJMIHtcblx0XHRwYXRoID0gZml4UGF0aChwYXRoKTtcblx0XHRyZXR1cm4gbmV3IFVSTCh0aGlzLl9oYXNoTW9kZSA/IFwiI1wiICsgcGF0aCA6IHBhdGgsIHRoaXMuX2Jhc2VVcmwpO1xuXHR9XG5cblx0cHJpdmF0ZSByZWdpc3RlcigpOiB0aGlzIHtcblx0XHRpZiAoIXRoaXMuX2xpc3RlbmluZykge1xuXHRcdFx0dGhpcy5fbGlzdGVuaW5nID0gdHJ1ZTtcblx0XHRcdHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwicG9wc3RhdGVcIiwgdGhpcy5fcG9wU3RhdGVMaXN0ZW5lciwgZmFsc2UpO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHByaXZhdGUgdW5yZWdpc3RlcigpOiB0aGlzIHtcblx0XHRpZiAodGhpcy5fbGlzdGVuaW5nKSB7XG5cdFx0XHR0aGlzLl9saXN0ZW5pbmcgPSBmYWxzZTtcblx0XHRcdHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKFwicG9wc3RhdGVcIiwgdGhpcy5fcG9wU3RhdGVMaXN0ZW5lciwgZmFsc2UpO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHByaXZhdGUgb25Qb3BTdGF0ZShlOiBQb3BTdGF0ZUV2ZW50KSB7XG5cdFx0Y29uc29sZS5sb2coXCJbT1dlYlJvdXRlcl0gcG9wc3RhdGUgLT5cIiwgYXJndW1lbnRzKTtcblxuXHRcdGlmIChlLnN0YXRlKSB7XG5cdFx0XHR0aGlzLmJyb3dzZVRvKGUuc3RhdGUucGF0aCwgZS5zdGF0ZS5kYXRhLCBmYWxzZSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRoaXMuYnJvd3NlVG8odGhpcy5nZXRMb2NhdGlvblBhdGgoKSwgdW5kZWZpbmVkLCBmYWxzZSk7XG5cdFx0fVxuXHR9XG5cblx0b24ocGF0aDogc3RyaW5nIHwgUmVnRXhwLCBydWxlczogdFJvdXRlT3B0aW9ucyA9IHt9LCBhY3Rpb246IHRSb3V0ZUFjdGlvbik6IHRoaXMge1xuXHRcdHRoaXMuX3JvdXRlcy5wdXNoKG5ldyBPV2ViUm91dGUocGF0aCwgcnVsZXMsIGFjdGlvbikpO1xuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0bm90Rm91bmQoY2FsbGJhY2s6IChwYXRoOiBzdHJpbmcpID0+IHZvaWQpOiB0aGlzIHtcblx0XHR0aGlzLl9ub3RGb3VuZCA9IGNhbGxiYWNrO1xuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0Z29CYWNrKGRpc3RhbmNlOiBudW1iZXIgPSAxKTogdGhpcyB7XG5cdFx0aWYgKGRpc3RhbmNlID4gMCkge1xuXHRcdFx0Y29uc29sZS5sb2coXCJbT1dlYlJvdXRlcl0gZ29pbmcgYmFjayAtPiBcIiwgZGlzdGFuY2UpO1xuXHRcdFx0bGV0IGhMZW4gPSB3SGlzdG9yeS5sZW5ndGg7XG5cdFx0XHRpZiAoaExlbiA+IDEpIHtcblx0XHRcdFx0aWYgKGhMZW4gPj0gZGlzdGFuY2UpIHtcblx0XHRcdFx0XHR3SGlzdG9yeS5nbygtZGlzdGFuY2UpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHdIaXN0b3J5LmdvKC1oTGVuKTtcblx0XHRcdFx0fVxuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0Y29uc29sZS53YXJuKFwiW09XZWJSb3V0ZXJdIGNhbid0IGdvIGJhY2sgLT4gaGlzdG9yeS5sZW5ndGggPT09IDFcIiwgZGlzdGFuY2UpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0YnJvd3NlVG8ocGF0aDogc3RyaW5nLCBzdGF0ZTogdFJvdXRlU3RhdGVPYmplY3QgPSB7fSwgcHVzaDogYm9vbGVhbiA9IHRydWUsIGlnbm9yZUlmU2FtZVBhdGg6IGJvb2xlYW4gPSBmYWxzZSk6IHRoaXMge1xuXHRcdHBhdGggPSBmaXhQYXRoKHBhdGgpO1xuXG5cdFx0Y29uc29sZS5sb2coXCJbT1dlYlJvdXRlcl0gYnJvd3NpbmcgdG8gLT4gXCIsIHBhdGgsIHN0YXRlLCBwdXNoKTtcblxuXHRcdGlmIChpZ25vcmVJZlNhbWVQYXRoICYmIHRoaXMuX2N1cnJlbnRfcGF0aCAhPT0gcGF0aCkge1xuXHRcdFx0Y29uc29sZS5sb2coXCJbT1dlYlJvdXRlcl0gaWdub3JlIHNhbWUgcGF0aCAtPiBcIiwgcGF0aCk7XG5cdFx0XHRyZXR1cm4gdGhpcztcblx0XHR9XG5cblx0XHRpZiAodGhpcy5fY3VycmVudF9kaXNwYXRjaGVyICYmIHRoaXMuX2N1cnJlbnRfZGlzcGF0Y2hlci5pc0FjdGl2ZSgpKSB7XG5cdFx0XHR0aGlzLl9jdXJyZW50X2Rpc3BhdGNoZXIuY2FuY2VsKCk7XG5cdFx0fVxuXG5cdFx0dGhpcy5fY3VycmVudF9wYXRoID0gcGF0aDtcblxuXHRcdHB1c2ggJiYgdGhpcy5hZGRIaXN0b3J5KHBhdGgsIHN0YXRlKTtcblxuXHRcdGxldCBjZCA9IHRoaXMuX2N1cnJlbnRfZGlzcGF0Y2hlciA9IHRoaXMuY3JlYXRlRGlzcGF0Y2hlcihwYXRoLCBzdGF0ZSwgKyt0aGlzLl9kaXNwYXRjaF9pZCk7XG5cblx0XHRjZC5kaXNwYXRjaCgpO1xuXG5cdFx0aWYgKGNkLmlkID09PSB0aGlzLl9kaXNwYXRjaF9pZCAmJiAhY2QuY29udGV4dC5zdG9wcGVkKCkpIHtcblx0XHRcdGlmICghY2QuZm91bmQubGVuZ3RoKSB7XG5cdFx0XHRcdGNvbnNvbGUud2FybihcIltPV2ViUm91dGVyXSBubyByb3V0ZSBmb3VuZCBmb3IgcGF0aCAtPlwiLCBwYXRoKTtcblx0XHRcdFx0aWYgKHRoaXMuX25vdEZvdW5kKSB7XG5cdFx0XHRcdFx0dGhpcy5fbm90Rm91bmQocGF0aCk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0Y29uc29sZS5lcnJvcihcIltPV2ViUm91dGVyXSBub3RGb3VuZCBhY3Rpb24gaXMgbm90IGRlZmluZWQhXCIpO1xuXHRcdFx0XHRcdHRoaXMuc3RvcFJvdXRpbmcoKTtcblx0XHRcdFx0fVxuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0Y2QuY29udGV4dC5zYXZlKCk7XG5cdFx0XHRcdGNvbnNvbGUubG9nKFwiW09XZWJSb3V0ZXJdIHN1Y2Nlc3MgLT5cIiwgcGF0aCk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRhZGRIaXN0b3J5KHBhdGg6IHN0cmluZywgZGF0YTogdFJvdXRlU3RhdGVPYmplY3QsIHRpdGxlOiBzdHJpbmcgPSBcIlwiKTogdGhpcyB7XG5cdFx0cGF0aCAgICAgID0gZml4UGF0aChwYXRoKTtcblx0XHR0aXRsZSAgICAgPSB0aXRsZSAmJiB0aXRsZS5sZW5ndGggPyB0aXRsZSA6IHdEb2MudGl0bGU7XG5cdFx0bGV0IHN0YXRlID0ge1xuXHRcdFx0XHRcInBhdGhcIjogcGF0aCxcblx0XHRcdFx0XCJkYXRhXCI6IGRhdGFcblx0XHRcdH0sXG5cdFx0XHR1cmwgICA9IHRoaXMucGF0aFRvVVJMKHBhdGgpO1xuXG5cdFx0d0hpc3RvcnkucHVzaFN0YXRlKHN0YXRlLCB0aXRsZSwgdXJsLmhyZWYpO1xuXHRcdGNvbnNvbGUud2FybihcIltPV2ViRGlzcGF0Y2hDb250ZXh0XSBoaXN0b3J5IGFkZGVkXCIsIHdIaXN0b3J5LnN0YXRlLCB1cmwuaHJlZik7XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHJlcGxhY2VIaXN0b3J5KHBhdGg6IHN0cmluZywgZGF0YTogdFJvdXRlU3RhdGVPYmplY3QsIHRpdGxlOiBzdHJpbmcgPSBcIlwiKTogdGhpcyB7XG5cdFx0cGF0aCAgICAgID0gZml4UGF0aChwYXRoKTtcblx0XHR0aXRsZSAgICAgPSB0aXRsZSAmJiB0aXRsZS5sZW5ndGggPyB0aXRsZSA6IHdEb2MudGl0bGU7XG5cdFx0bGV0IHN0YXRlID0ge1xuXHRcdFx0XHRcInBhdGhcIjogcGF0aCxcblx0XHRcdFx0XCJkYXRhXCI6IGRhdGFcblx0XHRcdH0sXG5cdFx0XHR1cmwgICA9IHRoaXMucGF0aFRvVVJMKHBhdGgpO1xuXG5cdFx0d0hpc3RvcnkucmVwbGFjZVN0YXRlKHN0YXRlLCB0aXRsZSwgdXJsLmhyZWYpO1xuXHRcdGNvbnNvbGUud2FybihcIltPV2ViRGlzcGF0Y2hDb250ZXh0XSBoaXN0b3J5IHVwZGF0ZWRcIiwgd0hpc3Rvcnkuc3RhdGUpO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRwcml2YXRlIGNyZWF0ZURpc3BhdGNoZXIocGF0aDogc3RyaW5nLCBzdGF0ZTogdFJvdXRlU3RhdGVPYmplY3QsIGlkOiBudW1iZXIpOiBpUm91dGVEaXNwYXRjaGVyIHtcblxuXHRcdGNvbnNvbGUubG9nKGBbT1dlYlJvdXRlcl1bZGlzcGF0Y2hlci0ke2lkfV0gY3JlYXRpb24uYCk7XG5cblx0XHRsZXQgY3R4ICAgICAgICAgICAgICAgID0gdGhpcyxcblx0XHRcdGZvdW5kOiBPV2ViUm91dGVbXSA9IFtdLFxuXHRcdFx0bGVuICAgICAgICAgICAgICAgID0gdGhpcy5fcm91dGVzLmxlbmd0aCxcblx0XHRcdGFjdGl2ZSAgICAgICAgICAgICA9IGZhbHNlLFxuXHRcdFx0ZGlzcGF0Y2hDb250ZXh0ICAgID0gbmV3IE9XZWJEaXNwYXRjaENvbnRleHQodGhpcywgcGF0aCwgc3RhdGUpLFxuXHRcdFx0byAgICAgICAgICAgICAgICAgID0ge1xuXHRcdFx0XHRjb250ZXh0IDogZGlzcGF0Y2hDb250ZXh0LFxuXHRcdFx0XHRpZCxcblx0XHRcdFx0Zm91bmQsXG5cdFx0XHRcdGlzQWN0aXZlOiAoKSA9PiBhY3RpdmUsXG5cdFx0XHRcdGNhbmNlbCAgOiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdFx0aWYgKGFjdGl2ZSkge1xuXHRcdFx0XHRcdFx0YWN0aXZlID0gZmFsc2U7XG5cdFx0XHRcdFx0XHRjb25zb2xlLndhcm4oYFtPV2ViUm91dGVyXVtkaXNwYXRjaGVyLSR7aWR9XSBjYW5jZWwgY2FsbGVkIWApO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRjb25zb2xlLmVycm9yKGBbT1dlYlJvdXRlcl1bZGlzcGF0Y2hlci0ke2lkfV0gY2FuY2VsIGNhbGxlZCB3aGVuIGluYWN0aXZlLmApO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSxcblx0XHRcdFx0ZGlzcGF0Y2g6IGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0XHRpZiAoIWFjdGl2ZSkge1xuXHRcdFx0XHRcdFx0Y29uc29sZS5sb2coYFtPV2ViUm91dGVyXVtkaXNwYXRjaGVyLSR7aWR9XSBzdGFydCAtPmAsIG8pO1xuXHRcdFx0XHRcdFx0YWN0aXZlID0gdHJ1ZTtcblx0XHRcdFx0XHRcdGxldCBpICA9IC0xO1xuXG5cdFx0XHRcdFx0XHR3aGlsZSAoKytpIDwgbGVuKSB7XG5cdFx0XHRcdFx0XHRcdGlmICghYWN0aXZlKSB7XG5cdFx0XHRcdFx0XHRcdFx0Y29uc29sZS53YXJuKGBbT1dlYlJvdXRlcl1bZGlzcGF0Y2hlci0ke2lkfV0gYnJvd3NlVG8gY2FsbGVkIHdoaWxlIGRpc3BhdGNoaW5nOiAke3BhdGh9IC0+ICR7Y3R4Ll9jdXJyZW50X3BhdGh9YCk7XG5cdFx0XHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0XHRsZXQgcm91dGUgPSBjdHguX3JvdXRlc1tpXTtcblxuXHRcdFx0XHRcdFx0XHRpZiAoZGlzcGF0Y2hDb250ZXh0LnN0b3BwZWQoKSkge1xuXHRcdFx0XHRcdFx0XHRcdGNvbnNvbGUud2FybihgW09XZWJSb3V0ZXJdW2Rpc3BhdGNoZXItJHtpZH1dIGNhbmNlbGVkIGZvciBcIiR7cGF0aH1cIiBieSByb3V0ZSBhY3Rpb24gLT5gLCByb3V0ZS5nZXRBY3Rpb24oKSk7XG5cdFx0XHRcdFx0XHRcdFx0by5jYW5jZWwoKTtcblx0XHRcdFx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdGlmIChyb3V0ZS5pcyhwYXRoKSkge1xuXHRcdFx0XHRcdFx0XHRcdGZvdW5kLnB1c2gocm91dGUpO1xuXHRcdFx0XHRcdFx0XHRcdGRpc3BhdGNoQ29udGV4dC5hY3Rpb25SdW5uZXIocm91dGUpO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdGFjdGl2ZSA9IGZhbHNlO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRjb25zb2xlLndhcm4oYFtPV2ViUm91dGVyXVtkaXNwYXRjaGVyLSR7aWR9XSBpcyBidXN5YCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9O1xuXG5cdFx0cmV0dXJuIG87XG5cdH1cbn0iXX0=