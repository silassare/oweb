import OWebEvent from './OWebEvent';
import { id, logger } from './utils';
const ls = window.localStorage, parse = function parse(data) {
    let value;
    if (data !== null) {
        try {
            value = JSON.parse(data);
        }
        catch (e) {
            logger.error(e);
        }
    }
    return value;
};
export default class OWebDataStore extends OWebEvent {
    static EVT_DATA_STORE_CLEARED = id();
    _key;
    _data = {};
    constructor(_appContext) {
        super();
        this._key = _appContext.getAppName();
        this._data = parse(ls.getItem(this._key)) || {};
    }
    /**
     * Sets key/value pair in the store.
     *
     * @param key The data key name.
     * @param value The data value.
     */
    set(key, value) {
        this._data[key] = value;
        this._persist();
        return false;
    }
    /**
     * Gets data with the given key.
     *
     * When the key is a regexp all data with a key name that match the given
     * regexp will be returned in an object.
     *
     * @param key The data key name.
     */
    get(key) {
        if (key instanceof RegExp) {
            const list = Object.keys(this._data), result = {};
            for (let i = 0; i < list.length; i++) {
                const k = list[i];
                if (key.test(k)) {
                    result[k] = this._data[k];
                }
            }
            return result;
        }
        else {
            return this._data[key];
        }
    }
    /**
     * Removes data with the given key.
     *
     * When the key is a regexp all data with a key name that match the given
     * regexp will be removed.
     *
     * @param key
     */
    remove(key) {
        if (ls) {
            if (key instanceof RegExp) {
                const list = Object.keys(this._data);
                for (let i = 0; i < list.length; i++) {
                    const k = list[i];
                    if (key.test(k)) {
                        delete this._data[k];
                    }
                }
            }
            else {
                delete this._data[key];
            }
            this._persist();
            return true;
        }
        return false;
    }
    /**
     * Clear the data store.
     */
    clear() {
        this._data = {};
        this._persist();
        this.trigger(OWebDataStore.EVT_DATA_STORE_CLEARED);
        return true;
    }
    /**
     * Register data store clear event handler.
     *
     * @param cb
     */
    onClear(cb) {
        return this.on(OWebDataStore.EVT_DATA_STORE_CLEARED, cb);
    }
    /**
     * Helper to make data store persistent.
     *
     * @private
     */
    _persist() {
        if (ls) {
            try {
                ls.setItem(this._key, JSON.stringify(this._data));
                return true;
            }
            catch (e) {
                logger.error(e);
            }
        }
        return false;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkRhdGFTdG9yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViRGF0YVN0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sU0FBUyxNQUFNLGFBQWEsQ0FBQztBQUNwQyxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxNQUFNLFNBQVMsQ0FBQztBQWVyQyxNQUFNLEVBQUUsR0FBRyxNQUFNLENBQUMsWUFBWSxFQUM3QixLQUFLLEdBQUcsU0FBUyxLQUFLLENBQUMsSUFBbUI7SUFDekMsSUFBSSxLQUFVLENBQUM7SUFFZixJQUFJLElBQUksS0FBSyxJQUFJLEVBQUU7UUFDbEIsSUFBSTtZQUNILEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3pCO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDWCxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ2hCO0tBQ0Q7SUFFRCxPQUFPLEtBQUssQ0FBQztBQUNkLENBQUMsQ0FBQztBQUVILE1BQU0sQ0FBQyxPQUFPLE9BQU8sYUFBYyxTQUFRLFNBQVM7SUFDbkQsTUFBTSxDQUFVLHNCQUFzQixHQUFHLEVBQUUsRUFBRSxDQUFDO0lBQzdCLElBQUksQ0FBUztJQUN0QixLQUFLLEdBQWtDLEVBQUUsQ0FBQztJQUVsRCxZQUFZLFdBQW9CO1FBQy9CLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLElBQUksR0FBRyxXQUFXLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDckMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDakQsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsR0FBRyxDQUFDLEdBQVcsRUFBRSxLQUFpQjtRQUNqQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUV4QixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7UUFFaEIsT0FBTyxLQUFLLENBQUM7SUFDZCxDQUFDO0lBRUQ7Ozs7Ozs7T0FPRztJQUNILEdBQUcsQ0FBQyxHQUFvQjtRQUN2QixJQUFJLEdBQUcsWUFBWSxNQUFNLEVBQUU7WUFDMUIsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQ25DLE1BQU0sR0FBUSxFQUFFLENBQUM7WUFFbEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQ3JDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDbEIsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFO29CQUNoQixNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDMUI7YUFDRDtZQUVELE9BQU8sTUFBTSxDQUFDO1NBQ2Q7YUFBTTtZQUNOLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUN2QjtJQUNGLENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0gsTUFBTSxDQUFDLEdBQW9CO1FBQzFCLElBQUksRUFBRSxFQUFFO1lBQ1AsSUFBSSxHQUFHLFlBQVksTUFBTSxFQUFFO2dCQUMxQixNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFFckMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7b0JBQ3JDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDbEIsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFO3dCQUNoQixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7cUJBQ3JCO2lCQUNEO2FBQ0Q7aUJBQU07Z0JBQ04sT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ3ZCO1lBRUQsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBRWhCLE9BQU8sSUFBSSxDQUFDO1NBQ1o7UUFFRCxPQUFPLEtBQUssQ0FBQztJQUNkLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUs7UUFDSixJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztRQUVoQixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7UUFFaEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsc0JBQXNCLENBQUMsQ0FBQztRQUVuRCxPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsT0FBTyxDQUFDLEVBQXdCO1FBQy9CLE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsc0JBQXNCLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDMUQsQ0FBQztJQUVEOzs7O09BSUc7SUFDSyxRQUFRO1FBQ2YsSUFBSSxFQUFFLEVBQUU7WUFDUCxJQUFJO2dCQUNILEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUNsRCxPQUFPLElBQUksQ0FBQzthQUNaO1lBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQ1gsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUNoQjtTQUNEO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDZCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IE9XZWJBcHAgZnJvbSAnLi9PV2ViQXBwJztcbmltcG9ydCBPV2ViRXZlbnQgZnJvbSAnLi9PV2ViRXZlbnQnO1xuaW1wb3J0IHsgaWQsIGxvZ2dlciB9IGZyb20gJy4vdXRpbHMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIE9KU09OU2VyaWFsaXphYmxlIHtcblx0dG9KU09OKCk6IE9KU09OVmFsdWU7XG59XG5cbmV4cG9ydCB0eXBlIE9KU09OVmFsdWUgPVxuXHR8IHN0cmluZ1xuXHR8IG51bWJlclxuXHR8IGJvb2xlYW5cblx0fCBEYXRlXG5cdHwgT0pTT05TZXJpYWxpemFibGVcblx0fCB7IFtrZXk6IHN0cmluZ106IE9KU09OVmFsdWUgfVxuXHR8IE9KU09OVmFsdWVbXTtcblxuY29uc3QgbHMgPSB3aW5kb3cubG9jYWxTdG9yYWdlLFxuXHRwYXJzZSA9IGZ1bmN0aW9uIHBhcnNlKGRhdGE6IHN0cmluZyB8IG51bGwpOiBhbnkge1xuXHRcdGxldCB2YWx1ZTogYW55O1xuXG5cdFx0aWYgKGRhdGEgIT09IG51bGwpIHtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdHZhbHVlID0gSlNPTi5wYXJzZShkYXRhKTtcblx0XHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdFx0bG9nZ2VyLmVycm9yKGUpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiB2YWx1ZTtcblx0fTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT1dlYkRhdGFTdG9yZSBleHRlbmRzIE9XZWJFdmVudCB7XG5cdHN0YXRpYyByZWFkb25seSBFVlRfREFUQV9TVE9SRV9DTEVBUkVEID0gaWQoKTtcblx0cHJpdmF0ZSByZWFkb25seSBfa2V5OiBzdHJpbmc7XG5cdHByaXZhdGUgX2RhdGE6IHsgW2tleTogc3RyaW5nXTogT0pTT05WYWx1ZSB9ID0ge307XG5cblx0Y29uc3RydWN0b3IoX2FwcENvbnRleHQ6IE9XZWJBcHApIHtcblx0XHRzdXBlcigpO1xuXHRcdHRoaXMuX2tleSA9IF9hcHBDb250ZXh0LmdldEFwcE5hbWUoKTtcblx0XHR0aGlzLl9kYXRhID0gcGFyc2UobHMuZ2V0SXRlbSh0aGlzLl9rZXkpKSB8fCB7fTtcblx0fVxuXG5cdC8qKlxuXHQgKiBTZXRzIGtleS92YWx1ZSBwYWlyIGluIHRoZSBzdG9yZS5cblx0ICpcblx0ICogQHBhcmFtIGtleSBUaGUgZGF0YSBrZXkgbmFtZS5cblx0ICogQHBhcmFtIHZhbHVlIFRoZSBkYXRhIHZhbHVlLlxuXHQgKi9cblx0c2V0KGtleTogc3RyaW5nLCB2YWx1ZTogT0pTT05WYWx1ZSk6IGJvb2xlYW4ge1xuXHRcdHRoaXMuX2RhdGFba2V5XSA9IHZhbHVlO1xuXG5cdFx0dGhpcy5fcGVyc2lzdCgpO1xuXG5cdFx0cmV0dXJuIGZhbHNlO1xuXHR9XG5cblx0LyoqXG5cdCAqIEdldHMgZGF0YSB3aXRoIHRoZSBnaXZlbiBrZXkuXG5cdCAqXG5cdCAqIFdoZW4gdGhlIGtleSBpcyBhIHJlZ2V4cCBhbGwgZGF0YSB3aXRoIGEga2V5IG5hbWUgdGhhdCBtYXRjaCB0aGUgZ2l2ZW5cblx0ICogcmVnZXhwIHdpbGwgYmUgcmV0dXJuZWQgaW4gYW4gb2JqZWN0LlxuXHQgKlxuXHQgKiBAcGFyYW0ga2V5IFRoZSBkYXRhIGtleSBuYW1lLlxuXHQgKi9cblx0Z2V0KGtleTogc3RyaW5nIHwgUmVnRXhwKTogYW55IHtcblx0XHRpZiAoa2V5IGluc3RhbmNlb2YgUmVnRXhwKSB7XG5cdFx0XHRjb25zdCBsaXN0ID0gT2JqZWN0LmtleXModGhpcy5fZGF0YSksXG5cdFx0XHRcdHJlc3VsdDogYW55ID0ge307XG5cblx0XHRcdGZvciAobGV0IGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykge1xuXHRcdFx0XHRjb25zdCBrID0gbGlzdFtpXTtcblx0XHRcdFx0aWYgKGtleS50ZXN0KGspKSB7XG5cdFx0XHRcdFx0cmVzdWx0W2tdID0gdGhpcy5fZGF0YVtrXTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gcmVzdWx0O1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRyZXR1cm4gdGhpcy5fZGF0YVtrZXldO1xuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBSZW1vdmVzIGRhdGEgd2l0aCB0aGUgZ2l2ZW4ga2V5LlxuXHQgKlxuXHQgKiBXaGVuIHRoZSBrZXkgaXMgYSByZWdleHAgYWxsIGRhdGEgd2l0aCBhIGtleSBuYW1lIHRoYXQgbWF0Y2ggdGhlIGdpdmVuXG5cdCAqIHJlZ2V4cCB3aWxsIGJlIHJlbW92ZWQuXG5cdCAqXG5cdCAqIEBwYXJhbSBrZXlcblx0ICovXG5cdHJlbW92ZShrZXk6IHN0cmluZyB8IFJlZ0V4cCk6IGJvb2xlYW4ge1xuXHRcdGlmIChscykge1xuXHRcdFx0aWYgKGtleSBpbnN0YW5jZW9mIFJlZ0V4cCkge1xuXHRcdFx0XHRjb25zdCBsaXN0ID0gT2JqZWN0LmtleXModGhpcy5fZGF0YSk7XG5cblx0XHRcdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRcdFx0Y29uc3QgayA9IGxpc3RbaV07XG5cdFx0XHRcdFx0aWYgKGtleS50ZXN0KGspKSB7XG5cdFx0XHRcdFx0XHRkZWxldGUgdGhpcy5fZGF0YVtrXTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGRlbGV0ZSB0aGlzLl9kYXRhW2tleV07XG5cdFx0XHR9XG5cblx0XHRcdHRoaXMuX3BlcnNpc3QoKTtcblxuXHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGZhbHNlO1xuXHR9XG5cblx0LyoqXG5cdCAqIENsZWFyIHRoZSBkYXRhIHN0b3JlLlxuXHQgKi9cblx0Y2xlYXIoKTogYm9vbGVhbiB7XG5cdFx0dGhpcy5fZGF0YSA9IHt9O1xuXG5cdFx0dGhpcy5fcGVyc2lzdCgpO1xuXG5cdFx0dGhpcy50cmlnZ2VyKE9XZWJEYXRhU3RvcmUuRVZUX0RBVEFfU1RPUkVfQ0xFQVJFRCk7XG5cblx0XHRyZXR1cm4gdHJ1ZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZWdpc3RlciBkYXRhIHN0b3JlIGNsZWFyIGV2ZW50IGhhbmRsZXIuXG5cdCAqXG5cdCAqIEBwYXJhbSBjYlxuXHQgKi9cblx0b25DbGVhcihjYjogKHRoaXM6IHRoaXMpID0+IHZvaWQpOiB0aGlzIHtcblx0XHRyZXR1cm4gdGhpcy5vbihPV2ViRGF0YVN0b3JlLkVWVF9EQVRBX1NUT1JFX0NMRUFSRUQsIGNiKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBIZWxwZXIgdG8gbWFrZSBkYXRhIHN0b3JlIHBlcnNpc3RlbnQuXG5cdCAqXG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIF9wZXJzaXN0KCk6IGJvb2xlYW4ge1xuXHRcdGlmIChscykge1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0bHMuc2V0SXRlbSh0aGlzLl9rZXksIEpTT04uc3RyaW5naWZ5KHRoaXMuX2RhdGEpKTtcblx0XHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRcdGxvZ2dlci5lcnJvcihlKTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gZmFsc2U7XG5cdH1cbn1cbiJdfQ==