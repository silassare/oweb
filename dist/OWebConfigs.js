"use strict";
import OWebEvent from "./OWebEvent";
import Utils from "./utils/Utils";
import OWebDataStore from "./OWebDataStore";
import OWebLang from "./OWebLang";
export default class OWebConfigs extends OWebEvent {
    constructor(app_context, configs) {
        super();
        this.app_context = app_context;
        this._default_configs = {};
        this._user_configs = {};
        this._private_configs_map = {};
        this._tag_name = app_context.getAppName() + ":user_configs";
        this.loadConfigs(configs);
        this._loadSavedConfigs();
        console.log("[OWebConfigs] ready!");
    }
    loadConfigs(configs) {
        let s = this;
        Utils.forEach(configs, (value, cfg) => {
            cfg = s._realConfigName(cfg);
            s._user_configs[cfg] = s._default_configs[cfg] = value;
        });
        return s;
    }
    resetToDefault(config) {
        if (config in this._default_configs) {
            this.set(config, this._default_configs[config]);
        }
        return this;
    }
    resetAllToDefault() {
        if (confirm(OWebLang.toHuman("OZ_CONFIRM_RESET_CONFIGS"))) {
            OWebDataStore.save(this._tag_name, this._default_configs);
            this.app_context.reloadApp();
        }
    }
    get(config) {
        this._warnUndefined(config);
        return this._user_configs[config];
    }
    set(config, value) {
        let m = this;
        if (Utils.isPlainObject(config)) {
            Utils.forEach(config, (value, key) => {
                m._set(key, value);
            });
        }
        else {
            m._set(config, value);
        }
        OWebDataStore.save(this._tag_name, this._user_configs);
        return this;
    }
    _loadSavedConfigs() {
        let m = this, saved_cfg = OWebDataStore.load(this._tag_name) || {};
        Utils.forEach(m._default_configs, (value, key) => {
            if (this._isPublic(key) && saved_cfg[key] !== undefined) {
                m._user_configs[key] = saved_cfg[key];
            }
        });
        OWebDataStore.save(this._tag_name, m._user_configs);
    }
    _set(config, value) {
        this._warnUndefined(config);
        if (!this._isPublic(config)) {
            throw new Error(`[OWebConfigs] can't overwrite config "${config}" permission denied.`);
        }
        if (config in this._user_configs) {
            this._user_configs[config] = value;
            this.trigger(OWebConfigs.EVT_CONFIG_CHANGE, [config, value, this]);
        }
    }
    _realConfigName(config) {
        if (config[0] === "!") {
            config = config.substr(1);
            this._private_configs_map[config] = 1;
        }
        return config;
    }
    _isPublic(config) {
        return undefined === this._private_configs_map[config];
    }
    _warnUndefined(config) {
        if (!(config in this._user_configs)) {
            console.warn(`[OWebConfigs] config "${config}" is not defined.`);
        }
    }
}
OWebConfigs.SELF = "OWebConfigs";
OWebConfigs.EVT_CONFIG_CHANGE = "OWebConfigs:change";
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkNvbmZpZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYkNvbmZpZ3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDO0FBRWIsT0FBTyxTQUFTLE1BQU0sYUFBYSxDQUFDO0FBQ3BDLE9BQU8sS0FBSyxNQUFNLGVBQWUsQ0FBQztBQUVsQyxPQUFPLGFBQWEsTUFBTSxpQkFBaUIsQ0FBQztBQUM1QyxPQUFPLFFBQVEsTUFBTSxZQUFZLENBQUM7QUFJbEMsTUFBTSxDQUFDLE9BQU8sa0JBQW1CLFNBQVEsU0FBUztJQVNqRCxZQUE2QixXQUFvQixFQUFFLE9BQW9CO1FBQ3RFLEtBQUssRUFBRSxDQUFDO1FBRG9CLGdCQUFXLEdBQVgsV0FBVyxDQUFTO1FBTGhDLHFCQUFnQixHQUFvQixFQUFFLENBQUM7UUFDdkMsa0JBQWEsR0FBdUIsRUFBRSxDQUFDO1FBQ3ZDLHlCQUFvQixHQUFnQixFQUFFLENBQUM7UUFLdkQsSUFBSSxDQUFDLFNBQVMsR0FBRyxXQUFXLENBQUMsVUFBVSxFQUFFLEdBQUcsZUFBZSxDQUFDO1FBRTVELElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDMUIsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFFekIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFFRCxXQUFXLENBQUMsT0FBb0I7UUFDL0IsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBRWIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFVLEVBQUUsR0FBVyxFQUFFLEVBQUU7WUFDbEQsR0FBRyxHQUFvQixDQUFDLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzlDLENBQUMsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQztR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QyxNQUFjO1FBQ3JDLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsRUFBRTtZQUN0QixNQUFNLEdBQThCLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckQsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUN0QztRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2YsQ0FBQztJQUVPLFNBQVMsQ0FBQyxNQUFjO1FBQy9CLE9BQU8sU0FBUyxLQUFLLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN4RCxDQUFDO0lBRU8sY0FBYyxDQUFDLE1BQWM7UUFDcEMsSUFBSSxDQUFDLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRTtZQUNwQyxPQUFPLENBQUMsSUFBSSxDQUFDLHlCQUF5QixNQUFNLG1CQUFtQixDQUFDLENBQUM7U0FDakU7SUFDRixDQUFDOztBQTdHZSxnQkFBSSxHQUFnQixhQUFhLENBQUM7QUFDbEMsNkJBQWlCLEdBQUcsb0JBQW9CLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcclxuXHJcbmltcG9ydCBPV2ViRXZlbnQgZnJvbSBcIi4vT1dlYkV2ZW50XCI7XHJcbmltcG9ydCBVdGlscyBmcm9tIFwiLi91dGlscy9VdGlsc1wiO1xyXG5pbXBvcnQgT1dlYkFwcCBmcm9tIFwiLi9PV2ViQXBwXCI7XHJcbmltcG9ydCBPV2ViRGF0YVN0b3JlIGZyb20gXCIuL09XZWJEYXRhU3RvcmVcIjtcclxuaW1wb3J0IE9XZWJMYW5nIGZyb20gXCIuL09XZWJMYW5nXCI7XHJcblxyXG5leHBvcnQgdHlwZSB0Q29uZmlnTGlzdCA9IHsgW2tleTogc3RyaW5nXTogYW55IH07XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViQ29uZmlncyBleHRlbmRzIE9XZWJFdmVudCB7XHJcblx0c3RhdGljIHJlYWRvbmx5IFNFTEYgICAgICAgICAgICAgID0gXCJPV2ViQ29uZmlnc1wiO1xyXG5cdHN0YXRpYyByZWFkb25seSBFVlRfQ09ORklHX0NIQU5HRSA9IFwiT1dlYkNvbmZpZ3M6Y2hhbmdlXCI7XHJcblxyXG5cdHByaXZhdGUgcmVhZG9ubHkgX2RlZmF1bHRfY29uZmlnczogdENvbmZpZ0xpc3QgICAgID0ge307XHJcblx0cHJpdmF0ZSByZWFkb25seSBfdXNlcl9jb25maWdzOiB0Q29uZmlnTGlzdCAgICAgICAgPSB7fTtcclxuXHRwcml2YXRlIHJlYWRvbmx5IF9wcml2YXRlX2NvbmZpZ3NfbWFwOiB0Q29uZmlnTGlzdCA9IHt9O1xyXG5cdHByaXZhdGUgcmVhZG9ubHkgX3RhZ19uYW1lOiBzdHJpbmc7XHJcblxyXG5cdGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgYXBwX2NvbnRleHQ6IE9XZWJBcHAsIGNvbmZpZ3M6IHRDb25maWdMaXN0KSB7XHJcblx0XHRzdXBlcigpO1xyXG5cdFx0dGhpcy5fdGFnX25hbWUgPSBhcHBfY29udGV4dC5nZXRBcHBOYW1lKCkgKyBcIjp1c2VyX2NvbmZpZ3NcIjtcclxuXHJcblx0XHR0aGlzLmxvYWRDb25maWdzKGNvbmZpZ3MpO1xyXG5cdFx0dGhpcy5fbG9hZFNhdmVkQ29uZmlncygpO1xyXG5cclxuXHRcdGNvbnNvbGUubG9nKFwiW09XZWJDb25maWdzXSByZWFkeSFcIik7XHJcblx0fVxyXG5cclxuXHRsb2FkQ29uZmlncyhjb25maWdzOiB0Q29uZmlnTGlzdCk6IHRoaXMge1xyXG5cdFx0bGV0IHMgPSB0aGlzO1xyXG5cclxuXHRcdFV0aWxzLmZvckVhY2goY29uZmlncywgKHZhbHVlOiBhbnksIGNmZzogc3RyaW5nKSA9PiB7XHJcblx0XHRcdGNmZyAgICAgICAgICAgICAgICAgID0gcy5fcmVhbENvbmZpZ05hbWUoY2ZnKTtcclxuXHRcdFx0cy5fdXNlcl9jb25maWdzW2NmZ10gPSBzLl9kZWZhdWx0X2NvbmZpZ3NbY2ZnXSA9IHZhbHVlO1xyXG5cdFx0fSk7XHJcblxyXG5cdFx0cmV0dXJuIHM7XHJcblx0fVxyXG5cclxuXHRyZXNldFRvRGVmYXVsdChjb25maWc6IHN0cmluZyk6IHRoaXMge1xyXG5cdFx0aWYgKGNvbmZpZyBpbiB0aGlzLl9kZWZhdWx0X2NvbmZpZ3MpIHtcclxuXHRcdFx0dGhpcy5zZXQoY29uZmlnLCB0aGlzLl9kZWZhdWx0X2NvbmZpZ3NbY29uZmlnXSk7XHJcblx0XHR9XHJcblxyXG5cdFx0cmV0dXJuIHRoaXM7XHJcblx0fVxyXG5cclxuXHRyZXNldEFsbFRvRGVmYXVsdCgpOiB2b2lkIHtcclxuXHRcdGlmIChjb25maXJtKE9XZWJMYW5nLnRvSHVtYW4oXCJPWl9DT05GSVJNX1JFU0VUX0NPTkZJR1NcIikpKSB7XHJcblx0XHRcdE9XZWJEYXRhU3RvcmUuc2F2ZSh0aGlzLl90YWdfbmFtZSwgdGhpcy5fZGVmYXVsdF9jb25maWdzKTtcclxuXHJcblx0XHRcdHRoaXMuYXBwX2NvbnRleHQucmVsb2FkQXBwKCk7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRnZXQoY29uZmlnOiBzdHJpbmcpOiBhbnkge1xyXG5cdFx0dGhpcy5fd2FyblVuZGVmaW5lZChjb25maWcpO1xyXG5cdFx0cmV0dXJuIHRoaXMuX3VzZXJfY29uZmlnc1tjb25maWddO1xyXG5cdH1cclxuXHJcblx0c2V0KGNvbmZpZzogc3RyaW5nLCB2YWx1ZTogYW55KTogdGhpcyB7XHJcblx0XHRsZXQgbSA9IHRoaXM7XHJcblx0XHRpZiAoVXRpbHMuaXNQbGFpbk9iamVjdChjb25maWcpKSB7XHJcblx0XHRcdFV0aWxzLmZvckVhY2goY29uZmlnIGFzIHt9LCAodmFsdWUsIGtleSkgPT4ge1xyXG5cdFx0XHRcdG0uX3NldChrZXksIHZhbHVlKTtcclxuXHRcdFx0fSk7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHRtLl9zZXQoY29uZmlnLCB2YWx1ZSk7XHJcblx0XHR9XHJcblxyXG5cdFx0T1dlYkRhdGFTdG9yZS5zYXZlKHRoaXMuX3RhZ19uYW1lLCB0aGlzLl91c2VyX2NvbmZpZ3MpO1xyXG5cdFx0cmV0dXJuIHRoaXM7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIF9sb2FkU2F2ZWRDb25maWdzKCkge1xyXG5cdFx0bGV0IG0gICAgICAgICA9IHRoaXMsXHJcblx0XHRcdHNhdmVkX2NmZyA9IE9XZWJEYXRhU3RvcmUubG9hZCh0aGlzLl90YWdfbmFtZSkgfHwge307XHJcblxyXG5cdFx0VXRpbHMuZm9yRWFjaChtLl9kZWZhdWx0X2NvbmZpZ3MsICh2YWx1ZSwga2V5KSA9PiB7XHJcblx0XHRcdGlmICh0aGlzLl9pc1B1YmxpYyhrZXkpICYmIHNhdmVkX2NmZ1trZXldICE9PSB1bmRlZmluZWQpIHtcclxuXHRcdFx0XHRtLl91c2VyX2NvbmZpZ3Nba2V5XSA9IHNhdmVkX2NmZ1trZXldO1xyXG5cdFx0XHR9XHJcblx0XHR9KTtcclxuXHJcblx0XHRPV2ViRGF0YVN0b3JlLnNhdmUodGhpcy5fdGFnX25hbWUsIG0uX3VzZXJfY29uZmlncyk7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIF9zZXQoY29uZmlnOiBzdHJpbmcsIHZhbHVlOiBhbnkpOiB2b2lkIHtcclxuXHJcblx0XHR0aGlzLl93YXJuVW5kZWZpbmVkKGNvbmZpZyk7XHJcblxyXG5cdFx0aWYgKCF0aGlzLl9pc1B1YmxpYyhjb25maWcpKSB7XHJcblx0XHRcdHRocm93IG5ldyBFcnJvcihgW09XZWJDb25maWdzXSBjYW4ndCBvdmVyd3JpdGUgY29uZmlnIFwiJHtjb25maWd9XCIgcGVybWlzc2lvbiBkZW5pZWQuYCk7XHJcblx0XHR9XHJcblxyXG5cdFx0aWYgKGNvbmZpZyBpbiB0aGlzLl91c2VyX2NvbmZpZ3MpIHtcclxuXHRcdFx0dGhpcy5fdXNlcl9jb25maWdzW2NvbmZpZ10gPSB2YWx1ZTtcclxuXHJcblx0XHRcdHRoaXMudHJpZ2dlcihPV2ViQ29uZmlncy5FVlRfQ09ORklHX0NIQU5HRSwgW2NvbmZpZywgdmFsdWUsIHRoaXNdKTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdHByaXZhdGUgX3JlYWxDb25maWdOYW1lKGNvbmZpZzogc3RyaW5nKTogc3RyaW5nIHtcclxuXHRcdGlmIChjb25maWdbMF0gPT09IFwiIVwiKSB7XHJcblx0XHRcdGNvbmZpZyAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IGNvbmZpZy5zdWJzdHIoMSk7XHJcblx0XHRcdHRoaXMuX3ByaXZhdGVfY29uZmlnc19tYXBbY29uZmlnXSA9IDE7XHJcblx0XHR9XHJcblxyXG5cdFx0cmV0dXJuIGNvbmZpZztcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgX2lzUHVibGljKGNvbmZpZzogc3RyaW5nKTogYm9vbGVhbiB7XHJcblx0XHRyZXR1cm4gdW5kZWZpbmVkID09PSB0aGlzLl9wcml2YXRlX2NvbmZpZ3NfbWFwW2NvbmZpZ107XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIF93YXJuVW5kZWZpbmVkKGNvbmZpZzogc3RyaW5nKSB7XHJcblx0XHRpZiAoIShjb25maWcgaW4gdGhpcy5fdXNlcl9jb25maWdzKSkge1xyXG5cdFx0XHRjb25zb2xlLndhcm4oYFtPV2ViQ29uZmlnc10gY29uZmlnIFwiJHtjb25maWd9XCIgaXMgbm90IGRlZmluZWQuYCk7XHJcblx0XHR9XHJcblx0fVxyXG59Il19