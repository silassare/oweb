import { OWebEvent, OWebDataStore, OWebLang, Utils } from "./oweb";
export default class OWebConfigs extends OWebEvent {
    constructor(app_context, configs) {
        super();
        this.app_context = app_context;
        this._default_configs = {};
        this._user_configs = {};
        this._private_configs_map = {};
        this._tag_name = app_context.getAppName() + ":user_configs";
        this.loadConfigs(configs);
        this._loadSavedConfigs();
        console.log("[OWebConfigs] ready!");
    }
    loadConfigs(configs) {
        let s = this;
        Utils.forEach(configs, (value, cfg) => {
            cfg = s._realConfigName(cfg);
            s._user_configs[cfg] = s._default_configs[cfg] = value;
        });
        return s;
    }
    resetToDefault(config) {
        if (config in this._default_configs) {
            this.set(config, this._default_configs[config]);
        }
        return this;
    }
    resetAllToDefault() {
        if (confirm(OWebLang.toHuman("OZ_CONFIRM_RESET_CONFIGS"))) {
            OWebDataStore.save(this._tag_name, this._default_configs);
            this.app_context.reloadApp();
        }
    }
    get(config) {
        this._warnUndefined(config);
        return this._user_configs[config];
    }
    set(config, value) {
        let m = this;
        if (Utils.isPlainObject(config)) {
            Utils.forEach(config, (value, key) => {
                m._set(key, value);
            });
        }
        else {
            m._set(config, value);
        }
        OWebDataStore.save(this._tag_name, this._user_configs);
        return this;
    }
    _loadSavedConfigs() {
        let m = this, saved_cfg = OWebDataStore.load(this._tag_name) || {};
        Utils.forEach(m._default_configs, (value, key) => {
            if (this._isPublic(key) && saved_cfg[key] !== undefined) {
                m._user_configs[key] = saved_cfg[key];
            }
        });
        OWebDataStore.save(this._tag_name, m._user_configs);
    }
    _set(config, value) {
        this._warnUndefined(config);
        if (!this._isPublic(config)) {
            throw new Error(`[OWebConfigs] can't overwrite config "${config}" permission denied.`);
        }
        if (config in this._user_configs) {
            this._user_configs[config] = value;
            this.trigger(OWebConfigs.EVT_CONFIG_CHANGE, [config, value, this]);
        }
    }
    _realConfigName(config) {
        if (config[0] === "!") {
            config = config.substr(1);
            this._private_configs_map[config] = 1;
        }
        return config;
    }
    _isPublic(config) {
        return undefined === this._private_configs_map[config];
    }
    _warnUndefined(config) {
        if (!(config in this._user_configs)) {
            console.warn(`[OWebConfigs] config "${config}" is not defined.`);
        }
    }
}
OWebConfigs.SELF = "OWebConfigs";
OWebConfigs.EVT_CONFIG_CHANGE = "OWebConfigs:change";
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkNvbmZpZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYkNvbmZpZ3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFVLFNBQVMsRUFBRSxhQUFhLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBQyxNQUFNLFFBQVEsQ0FBQztBQUkxRSxNQUFNLENBQUMsT0FBTyxrQkFBbUIsU0FBUSxTQUFTO0lBU2pELFlBQTZCLFdBQW9CLEVBQUUsT0FBb0I7UUFDdEUsS0FBSyxFQUFFLENBQUM7UUFEb0IsZ0JBQVcsR0FBWCxXQUFXLENBQVM7UUFMaEMscUJBQWdCLEdBQW9CLEVBQUUsQ0FBQztRQUN2QyxrQkFBYSxHQUF1QixFQUFFLENBQUM7UUFDdkMseUJBQW9CLEdBQWdCLEVBQUUsQ0FBQztRQUt2RCxJQUFJLENBQUMsU0FBUyxHQUFHLFdBQVcsQ0FBQyxVQUFVLEVBQUUsR0FBRyxlQUFlLENBQUM7UUFFNUQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMxQixJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUV6QixPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVELFdBQVcsQ0FBQyxPQUFvQjtRQUMvQixJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7UUFFYixLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLEtBQVUsRUFBRSxHQUFXLEVBQUUsRUFBRTtZQUNsRCxHQUFHLEdBQW9CLENBQUMsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDOUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQ3hELENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxDQUFDLENBQUM7SUFDVixDQUFDO0lBRUQsY0FBYyxDQUFDLE1BQWM7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TUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNyRCxJQUFJLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3RDO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDZixDQUFDO0lBRU8sU0FBUyxDQUFDLE1BQWM7UUFDL0IsT0FBTyxTQUFTLEtBQUssSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3hELENBQUM7SUFFTyxjQUFjLENBQUMsTUFBYztRQUNwQyxJQUFJLENBQUMsQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFO1lBQ3BDLE9BQU8sQ0FBQyxJQUFJLENBQUMseUJBQXlCLE1BQU0sbUJBQW1CLENBQUMsQ0FBQztTQUNqRTtJQUNGLENBQUM7O0FBN0dlLGdCQUFJLEdBQWdCLGFBQWEsQ0FBQztBQUNsQyw2QkFBaUIsR0FBRyxvQkFBb0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7T1dlYkFwcCwgT1dlYkV2ZW50LCBPV2ViRGF0YVN0b3JlLCBPV2ViTGFuZywgVXRpbHN9IGZyb20gXCIuL293ZWJcIjtcclxuXHJcbmV4cG9ydCB0eXBlIHRDb25maWdMaXN0ID0geyBba2V5OiBzdHJpbmddOiBhbnkgfTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJDb25maWdzIGV4dGVuZHMgT1dlYkV2ZW50IHtcclxuXHRzdGF0aWMgcmVhZG9ubHkgU0VMRiAgICAgICAgICAgICAgPSBcIk9XZWJDb25maWdzXCI7XHJcblx0c3RhdGljIHJlYWRvbmx5IEVWVF9DT05GSUdfQ0hBTkdFID0gXCJPV2ViQ29uZmlnczpjaGFuZ2VcIjtcclxuXHJcblx0cHJpdmF0ZSByZWFkb25seSBfZGVmYXVsdF9jb25maWdzOiB0Q29uZmlnTGlzdCAgICAgPSB7fTtcclxuXHRwcml2YXRlIHJlYWRvbmx5IF91c2VyX2NvbmZpZ3M6IHRDb25maWdMaXN0ICAgICAgICA9IHt9O1xyXG5cdHByaXZhdGUgcmVhZG9ubHkgX3ByaXZhdGVfY29uZmlnc19tYXA6IHRDb25maWdMaXN0ID0ge307XHJcblx0cHJpdmF0ZSByZWFkb25seSBfdGFnX25hbWU6IHN0cmluZztcclxuXHJcblx0Y29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhcHBfY29udGV4dDogT1dlYkFwcCwgY29uZmlnczogdENvbmZpZ0xpc3QpIHtcclxuXHRcdHN1cGVyKCk7XHJcblx0XHR0aGlzLl90YWdfbmFtZSA9IGFwcF9jb250ZXh0LmdldEFwcE5hbWUoKSArIFwiOnVzZXJfY29uZmlnc1wiO1xyXG5cclxuXHRcdHRoaXMubG9hZENvbmZpZ3MoY29uZmlncyk7XHJcblx0XHR0aGlzLl9sb2FkU2F2ZWRDb25maWdzKCk7XHJcblxyXG5cdFx0Y29uc29sZS5sb2coXCJbT1dlYkNvbmZpZ3NdIHJlYWR5IVwiKTtcclxuXHR9XHJcblxyXG5cdGxvYWRDb25maWdzKGNvbmZpZ3M6IHRDb25maWdMaXN0KTogdGhpcyB7XHJcblx0XHRsZXQgcyA9IHRoaXM7XHJcblxyXG5cdFx0VXRpbHMuZm9yRWFjaChjb25maWdzLCAodmFsdWU6IGFueSwgY2ZnOiBzdHJpbmcpID0+IHtcclxuXHRcdFx0Y2ZnICAgICAgICAgICAgICAgICAgPSBzLl9yZWFsQ29uZmlnTmFtZShjZmcpO1xyXG5cdFx0XHRzLl91c2VyX2NvbmZpZ3NbY2ZnXSA9IHMuX2RlZmF1bHRfY29uZmlnc1tjZmddID0gdmFsdWU7XHJcblx0XHR9KTtcclxuXHJcblx0XHRyZXR1cm4gcztcclxuXHR9XHJcblxyXG5cdHJlc2V0VG9EZWZhdWx0KGNvbmZpZzogc3RyaW5nKTogdGhpcyB7XHJcblx0XHRpZiAoY29uZmlnIGluIHRoaXMuX2RlZmF1bHRfY29uZmlncykge1xyXG5cdFx0XHR0aGlzLnNldChjb25maWcsIHRoaXMuX2RlZmF1bHRfY29uZmlnc1tjb25maWddKTtcclxuXHRcdH1cclxuXHJcblx0XHRyZXR1cm4gdGhpcztcclxuXHR9XHJcblxyXG5cdHJlc2V0QWxsVG9EZWZhdWx0KCk6IHZvaWQge1xyXG5cdFx0aWYgKGNvbmZpcm0oT1dlYkxhbmcudG9IdW1hbihcIk9aX0NPTkZJUk1fUkVTRVRfQ09ORklHU1wiKSkpIHtcclxuXHRcdFx0T1dlYkRhdGFTdG9yZS5zYXZlKHRoaXMuX3RhZ19uYW1lLCB0aGlzLl9kZWZhdWx0X2NvbmZpZ3MpO1xyXG5cclxuXHRcdFx0dGhpcy5hcHBfY29udGV4dC5yZWxvYWRBcHAoKTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdGdldChjb25maWc6IHN0cmluZyk6IGFueSB7XHJcblx0XHR0aGlzLl93YXJuVW5kZWZpbmVkKGNvbmZpZyk7XHJcblx0XHRyZXR1cm4gdGhpcy5fdXNlcl9jb25maWdzW2NvbmZpZ107XHJcblx0fVxyXG5cclxuXHRzZXQoY29uZmlnOiBzdHJpbmcsIHZhbHVlOiBhbnkpOiB0aGlzIHtcclxuXHRcdGxldCBtID0gdGhpcztcclxuXHRcdGlmIChVdGlscy5pc1BsYWluT2JqZWN0KGNvbmZpZykpIHtcclxuXHRcdFx0VXRpbHMuZm9yRWFjaChjb25maWcgYXMge30sICh2YWx1ZSwga2V5KSA9PiB7XHJcblx0XHRcdFx0bS5fc2V0KGtleSwgdmFsdWUpO1xyXG5cdFx0XHR9KTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdG0uX3NldChjb25maWcsIHZhbHVlKTtcclxuXHRcdH1cclxuXHJcblx0XHRPV2ViRGF0YVN0b3JlLnNhdmUodGhpcy5fdGFnX25hbWUsIHRoaXMuX3VzZXJfY29uZmlncyk7XHJcblx0XHRyZXR1cm4gdGhpcztcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgX2xvYWRTYXZlZENvbmZpZ3MoKSB7XHJcblx0XHRsZXQgbSAgICAgICAgID0gdGhpcyxcclxuXHRcdFx0c2F2ZWRfY2ZnID0gT1dlYkRhdGFTdG9yZS5sb2FkKHRoaXMuX3RhZ19uYW1lKSB8fCB7fTtcclxuXHJcblx0XHRVdGlscy5mb3JFYWNoKG0uX2RlZmF1bHRfY29uZmlncywgKHZhbHVlLCBrZXkpID0+IHtcclxuXHRcdFx0aWYgKHRoaXMuX2lzUHVibGljKGtleSkgJiYgc2F2ZWRfY2ZnW2tleV0gIT09IHVuZGVmaW5lZCkge1xyXG5cdFx0XHRcdG0uX3VzZXJfY29uZmlnc1trZXldID0gc2F2ZWRfY2ZnW2tleV07XHJcblx0XHRcdH1cclxuXHRcdH0pO1xyXG5cclxuXHRcdE9XZWJEYXRhU3RvcmUuc2F2ZSh0aGlzLl90YWdfbmFtZSwgbS5fdXNlcl9jb25maWdzKTtcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgX3NldChjb25maWc6IHN0cmluZywgdmFsdWU6IGFueSk6IHZvaWQge1xyXG5cclxuXHRcdHRoaXMuX3dhcm5VbmRlZmluZWQoY29uZmlnKTtcclxuXHJcblx0XHRpZiAoIXRoaXMuX2lzUHVibGljKGNvbmZpZykpIHtcclxuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBbT1dlYkNvbmZpZ3NdIGNhbid0IG92ZXJ3cml0ZSBjb25maWcgXCIke2NvbmZpZ31cIiBwZXJtaXNzaW9uIGRlbmllZC5gKTtcclxuXHRcdH1cclxuXHJcblx0XHRpZiAoY29uZmlnIGluIHRoaXMuX3VzZXJfY29uZmlncykge1xyXG5cdFx0XHR0aGlzLl91c2VyX2NvbmZpZ3NbY29uZmlnXSA9IHZhbHVlO1xyXG5cclxuXHRcdFx0dGhpcy50cmlnZ2VyKE9XZWJDb25maWdzLkVWVF9DT05GSUdfQ0hBTkdFLCBbY29uZmlnLCB2YWx1ZSwgdGhpc10pO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBfcmVhbENvbmZpZ05hbWUoY29uZmlnOiBzdHJpbmcpOiBzdHJpbmcge1xyXG5cdFx0aWYgKGNvbmZpZ1swXSA9PT0gXCIhXCIpIHtcclxuXHRcdFx0Y29uZmlnICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gY29uZmlnLnN1YnN0cigxKTtcclxuXHRcdFx0dGhpcy5fcHJpdmF0ZV9jb25maWdzX21hcFtjb25maWddID0gMTtcclxuXHRcdH1cclxuXHJcblx0XHRyZXR1cm4gY29uZmlnO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBfaXNQdWJsaWMoY29uZmlnOiBzdHJpbmcpOiBib29sZWFuIHtcclxuXHRcdHJldHVybiB1bmRlZmluZWQgPT09IHRoaXMuX3ByaXZhdGVfY29uZmlnc19tYXBbY29uZmlnXTtcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgX3dhcm5VbmRlZmluZWQoY29uZmlnOiBzdHJpbmcpIHtcclxuXHRcdGlmICghKGNvbmZpZyBpbiB0aGlzLl91c2VyX2NvbmZpZ3MpKSB7XHJcblx0XHRcdGNvbnNvbGUud2FybihgW09XZWJDb25maWdzXSBjb25maWcgXCIke2NvbmZpZ31cIiBpcyBub3QgZGVmaW5lZC5gKTtcclxuXHRcdH1cclxuXHR9XHJcbn0iXX0=