import OWebEvent from './OWebEvent';
import { clone, forEach, id, logger } from './utils';
export default class OWebConfigs extends OWebEvent {
    _appContext;
    static SELF = id();
    static EVT_CONFIG_CHANGE = id();
    _tagName = 'user_configs';
    _defaultUserConfigs = {};
    _appConfigs = {};
    _usersConfigs = {};
    constructor(_appContext, appConfigs, userConfigs) {
        super();
        this._appContext = _appContext;
        this._defaultUserConfigs = clone(userConfigs);
        this._appConfigs = clone(appConfigs);
        this._loadSavedConfigs();
        logger.info('[OWebConfigs] ready!');
    }
    resetToDefault(config) {
        if (config in this._defaultUserConfigs) {
            delete this._usersConfigs[config];
            this._appContext.ls.set(this._tagName, this._usersConfigs);
        }
        return this;
    }
    resetAllToDefault(confirmFirst = true) {
        if (!confirmFirst ||
            confirm(this._appContext.i18n.toHuman('OZ_CONFIRM_RESET_USER_CONFIGS'))) {
            this._usersConfigs = {};
            this._appContext.ls.set(this._tagName, this._usersConfigs);
        }
        return this;
    }
    get(config) {
        this._assertDefined(config);
        let val;
        if (config in this._usersConfigs) {
            val = this._usersConfigs[config];
        }
        else if (config in this._defaultUserConfigs) {
            val = this._defaultUserConfigs[config];
        }
        else if (config in this._appConfigs) {
            val = this._appConfigs[config];
        }
        return clone(val);
    }
    set(config, value) {
        this._assertDefined(config);
        if (this._isAppConfig(config)) {
            throw new Error(`[OWebConfigs] can't overwrite app config "${config}".`);
        }
        if (value === undefined) {
            delete this._usersConfigs[config];
        }
        else {
            this._usersConfigs[config] = clone(value);
        }
        this._appContext.ls.set(this._tagName, this._usersConfigs);
        this.trigger(OWebConfigs.EVT_CONFIG_CHANGE, [
            config,
            this.get(config),
            this,
        ]);
        return this;
    }
    _loadSavedConfigs() {
        const m = this, savedConfig = this._appContext.ls.get(this._tagName) || {};
        forEach(m._defaultUserConfigs, (_val, key) => {
            if (savedConfig[key] !== undefined) {
                m._usersConfigs[key] = savedConfig[key];
            }
        });
        this._appContext.ls.set(this._tagName, m._usersConfigs);
    }
    _isAppConfig(config) {
        return config in this._appConfigs;
    }
    _assertDefined(config) {
        if (!(config in this._defaultUserConfigs || config in this._appConfigs)) {
            throw new Error(`[OWebConfigs] config "${config}" is not defined.`);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkNvbmZpZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYkNvbmZpZ3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxTQUFTLE1BQU0sYUFBYSxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFHckQsTUFBTSxDQUFDLE9BQU8sT0FBTyxXQVFuQixTQUFRLFNBQVM7SUFVQTtJQVRsQixNQUFNLENBQVUsSUFBSSxHQUFHLEVBQUUsRUFBRSxDQUFDO0lBQzVCLE1BQU0sQ0FBVSxpQkFBaUIsR0FBRyxFQUFFLEVBQUUsQ0FBQztJQUV4QixRQUFRLEdBQVcsY0FBYyxDQUFDO0lBQ2xDLG1CQUFtQixHQUFNLEVBQVMsQ0FBQztJQUNuQyxXQUFXLEdBQU0sRUFBUyxDQUFDO0lBQ3BDLGFBQWEsR0FBTSxFQUFTLENBQUM7SUFFckMsWUFDa0IsV0FBb0IsRUFDckMsVUFBYSxFQUNiLFdBQWM7UUFFZCxLQUFLLEVBQUUsQ0FBQztRQUpTLGdCQUFXLEdBQVgsV0FBVyxDQUFTO1FBTXJDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDOUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFckMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFFekIsTUFBTSxDQUFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFPRCxjQUFjLENBQW9CLE1BQVM7UUFDMUMsSUFBSSxNQUFNLElBQUksSUFBSSxDQUFDLG1CQUFtQixFQUFFO1lBQ3ZDLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNsQyxJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFB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WUFBWSxDQUFDLE1BQWM7UUFDbEMsT0FBTyxNQUFNLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUNuQyxDQUFDO0lBUU8sY0FBYyxDQUFDLE1BQVc7UUFDakMsSUFBSSxDQUFDLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxtQkFBbUIsSUFBSSxNQUFNLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFO1lBQ3hFLE1BQU0sSUFBSSxLQUFLLENBQUMseUJBQXlCLE1BQU0sbUJBQW1CLENBQUMsQ0FBQztTQUNwRTtJQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT1dlYkFwcCBmcm9tICcuL09XZWJBcHAnO1xuaW1wb3J0IE9XZWJFdmVudCBmcm9tICcuL09XZWJFdmVudCc7XG5pbXBvcnQgeyBjbG9uZSwgZm9yRWFjaCwgaWQsIGxvZ2dlciB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHsgT0pTT05WYWx1ZSB9IGZyb20gJy4vT1dlYkRhdGFTdG9yZSc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJDb25maWdzPFxuXHRQIGV4dGVuZHMge1xuXHRcdFtrZXk6IHN0cmluZ106IE9KU09OVmFsdWU7XG5cdH0sXG5cdFUgZXh0ZW5kcyB7XG5cdFx0W2tleTogc3RyaW5nXTogT0pTT05WYWx1ZTtcblx0fSxcblx0QiA9IFUgJiBQXG4+IGV4dGVuZHMgT1dlYkV2ZW50IHtcblx0c3RhdGljIHJlYWRvbmx5IFNFTEYgPSBpZCgpO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTkZJR19DSEFOR0UgPSBpZCgpO1xuXG5cdHByaXZhdGUgcmVhZG9ubHkgX3RhZ05hbWU6IHN0cmluZyA9ICd1c2VyX2NvbmZpZ3MnO1xuXHRwcml2YXRlIHJlYWRvbmx5IF9kZWZhdWx0VXNlckNvbmZpZ3M6IFUgPSB7fSBhcyBhbnk7XG5cdHByaXZhdGUgcmVhZG9ubHkgX2FwcENvbmZpZ3M6IFAgPSB7fSBhcyBhbnk7XG5cdHByaXZhdGUgX3VzZXJzQ29uZmlnczogVSA9IHt9IGFzIGFueTtcblxuXHRjb25zdHJ1Y3Rvcihcblx0XHRwcml2YXRlIHJlYWRvbmx5IF9hcHBDb250ZXh0OiBPV2ViQXBwLFxuXHRcdGFwcENvbmZpZ3M6IFAsXG5cdFx0dXNlckNvbmZpZ3M6IFVcblx0KSB7XG5cdFx0c3VwZXIoKTtcblxuXHRcdHRoaXMuX2RlZmF1bHRVc2VyQ29uZmlncyA9IGNsb25lKHVzZXJDb25maWdzKTtcblx0XHR0aGlzLl9hcHBDb25maWdzID0gY2xvbmUoYXBwQ29uZmlncyk7XG5cblx0XHR0aGlzLl9sb2FkU2F2ZWRDb25maWdzKCk7XG5cblx0XHRsb2dnZXIuaW5mbygnW09XZWJDb25maWdzXSByZWFkeSEnKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXNldHMgYSBnaXZlbiBjb25maWcgdG8gaXRzIGRlZmF1bHQgdmFsdWUuXG5cdCAqXG5cdCAqIEBwYXJhbSBjb25maWdcblx0ICovXG5cdHJlc2V0VG9EZWZhdWx0PFQgZXh0ZW5kcyBrZXlvZiBVPihjb25maWc6IFQpOiB0aGlzIHtcblx0XHRpZiAoY29uZmlnIGluIHRoaXMuX2RlZmF1bHRVc2VyQ29uZmlncykge1xuXHRcdFx0ZGVsZXRlIHRoaXMuX3VzZXJzQ29uZmlnc1tjb25maWddO1xuXHRcdFx0dGhpcy5fYXBwQ29udGV4dC5scy5zZXQodGhpcy5fdGFnTmFtZSwgdGhpcy5fdXNlcnNDb25maWdzKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXNldHMgYWxsIGNvbmZpZ3MgdG8gdGhlaXIgZGVmYXVsdCB2YWx1ZXMuXG5cdCAqXG5cdCAqIEBwYXJhbSBjb25maXJtRmlyc3QgV2hlbiB0cnVlIGEgY29uZmlybSB3aWxsIHJlcXVlc3Qgd2lsbCBiZSBzZW50IHRvIHRoZSB1c2VyLlxuXHQgKi9cblx0cmVzZXRBbGxUb0RlZmF1bHQoY29uZmlybUZpcnN0ID0gdHJ1ZSk6IHRoaXMge1xuXHRcdGlmIChcblx0XHRcdCFjb25maXJtRmlyc3QgfHxcblx0XHRcdGNvbmZpcm0odGhpcy5fYXBwQ29udGV4dC5pMThuLnRvSHVtYW4oJ09aX0NPTkZJUk1fUkVTRVRfVVNFUl9DT05GSUdTJykpXG5cdFx0KSB7XG5cdFx0XHR0aGlzLl91c2Vyc0NvbmZpZ3MgPSB7fSBhcyBhbnk7XG5cblx0XHRcdHRoaXMuX2FwcENvbnRleHQubHMuc2V0KHRoaXMuX3RhZ05hbWUsIHRoaXMuX3VzZXJzQ29uZmlncyk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogR2V0cyBhIGNvbmZpZyB2YWx1ZS5cblx0ICpcblx0ICogQHBhcmFtIGNvbmZpZ1xuXHQgKi9cblx0Z2V0PFQgZXh0ZW5kcyBrZXlvZiBCPihjb25maWc6IFQpOiBCW1RdIHtcblx0XHR0aGlzLl9hc3NlcnREZWZpbmVkKGNvbmZpZyk7XG5cblx0XHRsZXQgdmFsO1xuXG5cdFx0aWYgKGNvbmZpZyBpbiB0aGlzLl91c2Vyc0NvbmZpZ3MpIHtcblx0XHRcdHZhbCA9ICh0aGlzLl91c2Vyc0NvbmZpZ3MgYXMgYW55KVtjb25maWddO1xuXHRcdH0gZWxzZSBpZiAoY29uZmlnIGluIHRoaXMuX2RlZmF1bHRVc2VyQ29uZmlncykge1xuXHRcdFx0dmFsID0gKHRoaXMuX2RlZmF1bHRVc2VyQ29uZmlncyBhcyBhbnkpW2NvbmZpZ107XG5cdFx0fSBlbHNlIGlmIChjb25maWcgaW4gdGhpcy5fYXBwQ29uZmlncykge1xuXHRcdFx0dmFsID0gKHRoaXMuX2FwcENvbmZpZ3MgYXMgYW55KVtjb25maWddO1xuXHRcdH1cblxuXHRcdHJldHVybiBjbG9uZSh2YWwpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFVwZGF0ZXMgYSBnaXZlbiBjb25maWcgd2l0aCB0aGUgZ2l2ZW4gdmFsdWUuXG5cdCAqXG5cdCAqIEBwYXJhbSBjb25maWcgVGhlIGNvbmZpZyBuYW1lLlxuXHQgKiBAcGFyYW0gdmFsdWUgVGhlIG5ldyB2YWx1ZS5cblx0ICovXG5cdHNldDxUIGV4dGVuZHMga2V5b2YgVT4oY29uZmlnOiBULCB2YWx1ZTogVVtUXSk6IHRoaXMge1xuXHRcdHRoaXMuX2Fzc2VydERlZmluZWQoY29uZmlnKTtcblxuXHRcdGlmICh0aGlzLl9pc0FwcENvbmZpZyhjb25maWcgYXMgc3RyaW5nKSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBbT1dlYkNvbmZpZ3NdIGNhbid0IG92ZXJ3cml0ZSBhcHAgY29uZmlnIFwiJHtjb25maWd9XCIuYCk7XG5cdFx0fVxuXG5cdFx0aWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcblx0XHRcdGRlbGV0ZSB0aGlzLl91c2Vyc0NvbmZpZ3NbY29uZmlnXTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5fdXNlcnNDb25maWdzW2NvbmZpZ10gPSBjbG9uZSh2YWx1ZSk7XG5cdFx0fVxuXG5cdFx0dGhpcy5fYXBwQ29udGV4dC5scy5zZXQodGhpcy5fdGFnTmFtZSwgdGhpcy5fdXNlcnNDb25maWdzKTtcblxuXHRcdHRoaXMudHJpZ2dlcihPV2ViQ29uZmlncy5FVlRfQ09ORklHX0NIQU5HRSwgW1xuXHRcdFx0Y29uZmlnLFxuXHRcdFx0dGhpcy5nZXQoY29uZmlnIGFzIGFueSksXG5cdFx0XHR0aGlzLFxuXHRcdF0pO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogTG9hZCBhbGwgc2F2ZWQgY29uZmlncy5cblx0ICpcblx0ICogQHByaXZhdGVcblx0ICovXG5cdHByaXZhdGUgX2xvYWRTYXZlZENvbmZpZ3MoKSB7XG5cdFx0Y29uc3QgbSA9IHRoaXMsXG5cdFx0XHRzYXZlZENvbmZpZyA9IHRoaXMuX2FwcENvbnRleHQubHMuZ2V0KHRoaXMuX3RhZ05hbWUpIHx8IHt9O1xuXG5cdFx0Zm9yRWFjaChtLl9kZWZhdWx0VXNlckNvbmZpZ3MgYXMgYW55LCAoX3ZhbCwga2V5KSA9PiB7XG5cdFx0XHRpZiAoc2F2ZWRDb25maWdba2V5XSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRcdChtLl91c2Vyc0NvbmZpZ3MgYXMgYW55KVtrZXldID0gc2F2ZWRDb25maWdba2V5XTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdHRoaXMuX2FwcENvbnRleHQubHMuc2V0KHRoaXMuX3RhZ05hbWUsIG0uX3VzZXJzQ29uZmlncyk7XG5cdH1cblxuXHQvKipcblx0ICogQ2hlY2tzIGlmIHRoZSBjb25maWcgaXMgYW4gYXBwIGNvbmZpZyBuYW1lLlxuXHQgKlxuXHQgKiBAcGFyYW0gY29uZmlnXG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIF9pc0FwcENvbmZpZyhjb25maWc6IHN0cmluZyk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiBjb25maWcgaW4gdGhpcy5fYXBwQ29uZmlncztcblx0fVxuXG5cdC8qKlxuXHQgKiBDaGVja3MgaWYgdGhlIGNvbmZpZyBleGlzdHMuXG5cdCAqXG5cdCAqIEBwYXJhbSBjb25maWdcblx0ICogQHByaXZhdGVcblx0ICovXG5cdHByaXZhdGUgX2Fzc2VydERlZmluZWQoY29uZmlnOiBhbnkpIHtcblx0XHRpZiAoIShjb25maWcgaW4gdGhpcy5fZGVmYXVsdFVzZXJDb25maWdzIHx8IGNvbmZpZyBpbiB0aGlzLl9hcHBDb25maWdzKSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBbT1dlYkNvbmZpZ3NdIGNvbmZpZyBcIiR7Y29uZmlnfVwiIGlzIG5vdCBkZWZpbmVkLmApO1xuXHRcdH1cblx0fVxufVxuIl19