import OWebEvent from "./OWebEvent";
import OWebLang from "./OWebLang";
import Utils from "./utils/Utils";
export default class OWebConfigs extends OWebEvent {
    constructor(app_context, configs) {
        super();
        this.app_context = app_context;
        this._default_configs = {};
        this._user_configs = {};
        this._private_configs_map = {};
        this._tag_name = "user_configs";
        this.loadConfigs(configs);
        this._loadSavedConfigs();
        console.log("[OWebConfigs] ready!");
    }
    loadConfigs(configs) {
        let s = this;
        Utils.forEach(configs, (value, cfg) => {
            cfg = s._realConfigName(cfg);
            s._user_configs[cfg] = s._default_configs[cfg] = value;
        });
        return s;
    }
    resetToDefault(config) {
        if (config in this._default_configs) {
            this.set(config, this._default_configs[config]);
        }
        return this;
    }
    resetAllToDefault() {
        if (confirm(OWebLang.toHuman("OZ_CONFIRM_RESET_CONFIGS"))) {
            this.app_context.ls.save(this._tag_name, this._default_configs);
            this.app_context.reloadApp();
        }
    }
    get(config) {
        this._warnUndefined(config);
        return this._user_configs[config];
    }
    set(config, value) {
        let m = this;
        if (Utils.isPlainObject(config)) {
            Utils.forEach(config, (value, key) => {
                m._set(key, value);
            });
        }
        else {
            m._set(config, value);
        }
        this.app_context.ls.save(this._tag_name, this._user_configs);
        return this;
    }
    _loadSavedConfigs() {
        let m = this, saved_cfg = this.app_context.ls.load(this._tag_name) || {};
        Utils.forEach(m._default_configs, (value, key) => {
            if (this._isPublic(key) && saved_cfg[key] !== undefined) {
                m._user_configs[key] = saved_cfg[key];
            }
        });
        this.app_context.ls.save(this._tag_name, m._user_configs);
    }
    _set(config, value) {
        this._warnUndefined(config);
        if (!this._isPublic(config)) {
            throw new Error(`[OWebConfigs] can't overwrite config "${config}" permission denied.`);
        }
        if (config in this._user_configs) {
            this._user_configs[config] = value;
            this.trigger(OWebConfigs.EVT_CONFIG_CHANGE, [config, value, this]);
        }
    }
    _realConfigName(config) {
        if (config[0] === "!") {
            config = config.substr(1);
            this._private_configs_map[config] = 1;
        }
        return config;
    }
    _isPublic(config) {
        return undefined === this._private_configs_map[config];
    }
    _warnUndefined(config) {
        if (!(config in this._user_configs)) {
            console.warn(`[OWebConfigs] config "${config}" is not defined.`);
        }
    }
}
OWebConfigs.SELF = Utils.id();
OWebConfigs.EVT_CONFIG_CHANGE = Utils.id();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkNvbmZpZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYkNvbmZpZ3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxTQUFTLE1BQU0sYUFBYSxDQUFDO0FBQ3BDLE9BQU8sUUFBUSxNQUFNLFlBQVksQ0FBQztBQUNsQyxPQUFPLEtBQUssTUFBTSxlQUFlLENBQUM7QUFJbEMsTUFBTSxDQUFDLE9BQU8sa0JBQW1CLFNBQVEsU0FBUztJQVNqRCxZQUE2QixXQUFvQixFQUFFLE9BQW9CO1FBQ3RFLEtBQUssRUFBRSxDQUFDO1FBRG9CLGdCQUFXLEdBQVgsV0FBVyxDQUFTO1FBTGhDLHFCQUFnQixHQUFvQixFQUFFLENBQUM7UUFDdkMsa0JBQWEsR0FBdUIsRUFBRSxDQUFDO1FBQ3ZDLHlCQUFvQixHQUFnQixFQUFFLENBQUM7UUFDdkMsY0FBUyxHQUEyQixjQUFjLENBQUM7UUFLbkUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMxQixJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUV6QixPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVELFdBQVcsQ0FBQyxPQUFvQjtRQUMvQixJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7UUFFYixLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLEtBQVUsRUFBRSxHQUFXLEVBQUUsRUFBRTtZQUNsRCxHQUFHLEdBQW9CLENBQUMsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDOUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQ3hELENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxDQUFDLENBQUM7SUFDVixDQUFDO0lBRUQsY0FBYyxDQUFDLE1BQWM7UUFDNUIsSUFBSSxN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TUFBYztRQUNyQyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLEVBQUU7WUFDdEIsTUFBTSxHQUE4QixNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3JELElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDdEM7UUFFRCxPQUFPLE1BQU0sQ0FBQztJQUNmLENBQUM7SUFFTyxTQUFTLENBQUMsTUFBYztRQUMvQixPQUFPLFNBQVMsS0FBSyxJQUFJLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDeEQsQ0FBQztJQUVPLGNBQWMsQ0FBQyxNQUFjO1FBQ3BDLElBQUksQ0FBQyxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUU7WUFDcEMsT0FBTyxDQUFDLElBQUksQ0FBQyx5QkFBeUIsTUFBTSxtQkFBbUIsQ0FBQyxDQUFDO1NBQ2pFO0lBQ0YsQ0FBQzs7QUE1R2UsZ0JBQUksR0FBZ0IsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQy9CLDZCQUFpQixHQUFHLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBPV2ViQXBwIGZyb20gXCIuL09XZWJBcHBcIjtcclxuaW1wb3J0IE9XZWJFdmVudCBmcm9tIFwiLi9PV2ViRXZlbnRcIjtcclxuaW1wb3J0IE9XZWJMYW5nIGZyb20gXCIuL09XZWJMYW5nXCI7XHJcbmltcG9ydCBVdGlscyBmcm9tIFwiLi91dGlscy9VdGlsc1wiO1xyXG5cclxuZXhwb3J0IHR5cGUgdENvbmZpZ0xpc3QgPSB7IFtrZXk6IHN0cmluZ106IGFueSB9O1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT1dlYkNvbmZpZ3MgZXh0ZW5kcyBPV2ViRXZlbnQge1xyXG5cdHN0YXRpYyByZWFkb25seSBTRUxGICAgICAgICAgICAgICA9IFV0aWxzLmlkKCk7XHJcblx0c3RhdGljIHJlYWRvbmx5IEVWVF9DT05GSUdfQ0hBTkdFID0gVXRpbHMuaWQoKTtcclxuXHJcblx0cHJpdmF0ZSByZWFkb25seSBfZGVmYXVsdF9jb25maWdzOiB0Q29uZmlnTGlzdCAgICAgPSB7fTtcclxuXHRwcml2YXRlIHJlYWRvbmx5IF91c2VyX2NvbmZpZ3M6IHRDb25maWdMaXN0ICAgICAgICA9IHt9O1xyXG5cdHByaXZhdGUgcmVhZG9ubHkgX3ByaXZhdGVfY29uZmlnc19tYXA6IHRDb25maWdMaXN0ID0ge307XHJcblx0cHJpdmF0ZSByZWFkb25seSBfdGFnX25hbWU6IHN0cmluZyAgICAgICAgICAgICAgICAgPSBcInVzZXJfY29uZmlnc1wiO1xyXG5cclxuXHRjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGFwcF9jb250ZXh0OiBPV2ViQXBwLCBjb25maWdzOiB0Q29uZmlnTGlzdCkge1xyXG5cdFx0c3VwZXIoKTtcclxuXHJcblx0XHR0aGlzLmxvYWRDb25maWdzKGNvbmZpZ3MpO1xyXG5cdFx0dGhpcy5fbG9hZFNhdmVkQ29uZmlncygpO1xyXG5cclxuXHRcdGNvbnNvbGUubG9nKFwiW09XZWJDb25maWdzXSByZWFkeSFcIik7XHJcblx0fVxyXG5cclxuXHRsb2FkQ29uZmlncyhjb25maWdzOiB0Q29uZmlnTGlzdCk6IHRoaXMge1xyXG5cdFx0bGV0IHMgPSB0aGlzO1xyXG5cclxuXHRcdFV0aWxzLmZvckVhY2goY29uZmlncywgKHZhbHVlOiBhbnksIGNmZzogc3RyaW5nKSA9PiB7XHJcblx0XHRcdGNmZyAgICAgICAgICAgICAgICAgID0gcy5fcmVhbENvbmZpZ05hbWUoY2ZnKTtcclxuXHRcdFx0cy5fdXNlcl9jb25maWdzW2NmZ10gPSBzLl9kZWZhdWx0X2NvbmZpZ3NbY2ZnXSA9IHZhbHVlO1xyXG5cdFx0fSk7XHJcblxyXG5cdFx0cmV0dXJuIHM7XHJcblx0fVxyXG5cclxuXHRyZXNldFRvRGVmYXVsdChjb25maWc6IHN0cmluZyk6IHRoaXMge1xyXG5cdFx0aWYgKGNvbmZpZyBpbiB0aGlzLl9kZWZhdWx0X2NvbmZpZ3MpIHtcclxuXHRcdFx0dGhpcy5zZXQoY29uZmlnLCB0aGlzLl9kZWZhdWx0X2NvbmZpZ3NbY29uZmlnXSk7XHJcblx0XHR9XHJcblxyXG5cdFx0cmV0dXJuIHRoaXM7XHJcblx0fVxyXG5cclxuXHRyZXNldEFsbFRvRGVmYXVsdCgpOiB2b2lkIHtcclxuXHRcdGlmIChjb25maXJtKE9XZWJMYW5nLnRvSHVtYW4oXCJPWl9DT05GSVJNX1JFU0VUX0NPTkZJR1NcIikpKSB7XHJcblx0XHRcdHRoaXMuYXBwX2NvbnRleHQubHMuc2F2ZSh0aGlzLl90YWdfbmFtZSwgdGhpcy5fZGVmYXVsdF9jb25maWdzKTtcclxuXHJcblx0XHRcdHRoaXMuYXBwX2NvbnRleHQucmVsb2FkQXBwKCk7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRnZXQoY29uZmlnOiBzdHJpbmcpOiBhbnkge1xyXG5cdFx0dGhpcy5fd2FyblVuZGVmaW5lZChjb25maWcpO1xyXG5cdFx0cmV0dXJuIHRoaXMuX3VzZXJfY29uZmlnc1tjb25maWddO1xyXG5cdH1cclxuXHJcblx0c2V0KGNvbmZpZzogc3RyaW5nLCB2YWx1ZTogYW55KTogdGhpcyB7XHJcblx0XHRsZXQgbSA9IHRoaXM7XHJcblx0XHRpZiAoVXRpbHMuaXNQbGFpbk9iamVjdChjb25maWcpKSB7XHJcblx0XHRcdFV0aWxzLmZvckVhY2goY29uZmlnIGFzIHt9LCAodmFsdWUsIGtleSkgPT4ge1xyXG5cdFx0XHRcdG0uX3NldChrZXksIHZhbHVlKTtcclxuXHRcdFx0fSk7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHRtLl9zZXQoY29uZmlnLCB2YWx1ZSk7XHJcblx0XHR9XHJcblxyXG5cdFx0dGhpcy5hcHBfY29udGV4dC5scy5zYXZlKHRoaXMuX3RhZ19uYW1lLCB0aGlzLl91c2VyX2NvbmZpZ3MpO1xyXG5cdFx0cmV0dXJuIHRoaXM7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIF9sb2FkU2F2ZWRDb25maWdzKCkge1xyXG5cdFx0bGV0IG0gICAgICAgICA9IHRoaXMsXHJcblx0XHRcdHNhdmVkX2NmZyA9IHRoaXMuYXBwX2NvbnRleHQubHMubG9hZCh0aGlzLl90YWdfbmFtZSkgfHwge307XHJcblxyXG5cdFx0VXRpbHMuZm9yRWFjaChtLl9kZWZhdWx0X2NvbmZpZ3MsICh2YWx1ZSwga2V5KSA9PiB7XHJcblx0XHRcdGlmICh0aGlzLl9pc1B1YmxpYyhrZXkpICYmIHNhdmVkX2NmZ1trZXldICE9PSB1bmRlZmluZWQpIHtcclxuXHRcdFx0XHRtLl91c2VyX2NvbmZpZ3Nba2V5XSA9IHNhdmVkX2NmZ1trZXldO1xyXG5cdFx0XHR9XHJcblx0XHR9KTtcclxuXHJcblx0XHR0aGlzLmFwcF9jb250ZXh0LmxzLnNhdmUodGhpcy5fdGFnX25hbWUsIG0uX3VzZXJfY29uZmlncyk7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIF9zZXQoY29uZmlnOiBzdHJpbmcsIHZhbHVlOiBhbnkpOiB2b2lkIHtcclxuXHJcblx0XHR0aGlzLl93YXJuVW5kZWZpbmVkKGNvbmZpZyk7XHJcblxyXG5cdFx0aWYgKCF0aGlzLl9pc1B1YmxpYyhjb25maWcpKSB7XHJcblx0XHRcdHRocm93IG5ldyBFcnJvcihgW09XZWJDb25maWdzXSBjYW4ndCBvdmVyd3JpdGUgY29uZmlnIFwiJHtjb25maWd9XCIgcGVybWlzc2lvbiBkZW5pZWQuYCk7XHJcblx0XHR9XHJcblxyXG5cdFx0aWYgKGNvbmZpZyBpbiB0aGlzLl91c2VyX2NvbmZpZ3MpIHtcclxuXHRcdFx0dGhpcy5fdXNlcl9jb25maWdzW2NvbmZpZ10gPSB2YWx1ZTtcclxuXHJcblx0XHRcdHRoaXMudHJpZ2dlcihPV2ViQ29uZmlncy5FVlRfQ09ORklHX0NIQU5HRSwgW2NvbmZpZywgdmFsdWUsIHRoaXNdKTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdHByaXZhdGUgX3JlYWxDb25maWdOYW1lKGNvbmZpZzogc3RyaW5nKTogc3RyaW5nIHtcclxuXHRcdGlmIChjb25maWdbMF0gPT09IFwiIVwiKSB7XHJcblx0XHRcdGNvbmZpZyAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IGNvbmZpZy5zdWJzdHIoMSk7XHJcblx0XHRcdHRoaXMuX3ByaXZhdGVfY29uZmlnc19tYXBbY29uZmlnXSA9IDE7XHJcblx0XHR9XHJcblxyXG5cdFx0cmV0dXJuIGNvbmZpZztcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgX2lzUHVibGljKGNvbmZpZzogc3RyaW5nKTogYm9vbGVhbiB7XHJcblx0XHRyZXR1cm4gdW5kZWZpbmVkID09PSB0aGlzLl9wcml2YXRlX2NvbmZpZ3NfbWFwW2NvbmZpZ107XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIF93YXJuVW5kZWZpbmVkKGNvbmZpZzogc3RyaW5nKSB7XHJcblx0XHRpZiAoIShjb25maWcgaW4gdGhpcy5fdXNlcl9jb25maWdzKSkge1xyXG5cdFx0XHRjb25zb2xlLndhcm4oYFtPV2ViQ29uZmlnc10gY29uZmlnIFwiJHtjb25maWd9XCIgaXMgbm90IGRlZmluZWQuYCk7XHJcblx0XHR9XHJcblx0fVxyXG59Il19