import OWebEvent from "./OWebEvent";
import OWebLang from "./OWebLang";
import Utils from "./utils/Utils";
export default class OWebConfigs extends OWebEvent {
    constructor(app_context, configs) {
        super();
        this.app_context = app_context;
        this._default_configs = {};
        this._user_configs = {};
        this._private_configs_map = {};
        this._tag_name = "user_configs";
        this.loadConfigs(configs);
        this._loadSavedConfigs();
        console.log("[OWebConfigs] ready!");
    }
    loadConfigs(configs) {
        let s = this;
        Utils.forEach(configs, (value, cfg) => {
            cfg = s._realConfigName(cfg);
            s._user_configs[cfg] = s._default_configs[cfg] = value;
        });
        return s;
    }
    resetToDefault(config) {
        if (config in this._default_configs) {
            this.set(config, this._default_configs[config]);
        }
        return this;
    }
    resetAllToDefault() {
        if (confirm(OWebLang.toHuman("OZ_CONFIRM_RESET_CONFIGS"))) {
            this.app_context.ls.save(this._tag_name, this._default_configs);
            this.app_context.reloadApp();
        }
    }
    get(config) {
        this._warnUndefined(config);
        return this._user_configs[config];
    }
    set(config, value) {
        let m = this;
        if (Utils.isPlainObject(config)) {
            Utils.forEach(config, (value, key) => {
                m._set(key, value);
            });
        }
        else {
            m._set(config, value);
        }
        this.app_context.ls.save(this._tag_name, this._user_configs);
        return this;
    }
    _loadSavedConfigs() {
        let m = this, saved_cfg = this.app_context.ls.load(this._tag_name) || {};
        Utils.forEach(m._default_configs, (value, key) => {
            if (this._isPublic(key) && saved_cfg[key] !== undefined) {
                m._user_configs[key] = saved_cfg[key];
            }
        });
        this.app_context.ls.save(this._tag_name, m._user_configs);
    }
    _set(config, value) {
        this._warnUndefined(config);
        if (!this._isPublic(config)) {
            throw new Error(`[OWebConfigs] can't overwrite config "${config}" permission denied.`);
        }
        if (config in this._user_configs) {
            this._user_configs[config] = value;
            this.trigger(OWebConfigs.EVT_CONFIG_CHANGE, [config, value, this]);
        }
    }
    _realConfigName(config) {
        if (config[0] === "!") {
            config = config.substr(1);
            this._private_configs_map[config] = 1;
        }
        return config;
    }
    _isPublic(config) {
        return undefined === this._private_configs_map[config];
    }
    _warnUndefined(config) {
        if (!(config in this._user_configs)) {
            console.warn(`[OWebConfigs] config "${config}" is not defined.`);
        }
    }
}
OWebConfigs.SELF = "OWebConfigs";
OWebConfigs.EVT_CONFIG_CHANGE = "OWebConfigs:change";
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkNvbmZpZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYkNvbmZpZ3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxTQUFTLE1BQU0sYUFBYSxDQUFDO0FBQ3BDLE9BQU8sUUFBUSxNQUFNLFlBQVksQ0FBQztBQUNsQyxPQUFPLEtBQUssTUFBTSxlQUFlLENBQUM7QUFJbEMsTUFBTSxDQUFDLE9BQU8sa0JBQW1CLFNBQVEsU0FBUztJQVNqRCxZQUE2QixXQUFvQixFQUFFLE9BQW9CO1FBQ3RFLEtBQUssRUFBRSxDQUFDO1FBRG9CLGdCQUFXLEdBQVgsV0FBVyxDQUFTO1FBTGhDLHFCQUFnQixHQUFvQixFQUFFLENBQUM7UUFDdkMsa0JBQWEsR0FBdUIsRUFBRSxDQUFDO1FBQ3ZDLHlCQUFvQixHQUFnQixFQUFFLENBQUM7UUFDdkMsY0FBUyxHQUEyQixjQUFjLENBQUM7UUFLbkUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMxQixJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUV6QixPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVELFdBQVcsQ0FBQyxPQUFvQjtRQUMvQixJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7UUFFYixLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLEtBQVUsRUFBRSxHQUFXLEVBQUUsRUFBRTtZQUNsRCxHQUFHLEdBQW9CLENBQUMsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDOUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQ3hELENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxDQUFDLENBQUM7SUFDVixDQUFDO0lBRUQsY0FBYyxDQUFDLE1BQWM7UUFDNUIsSUFBSSxN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TUFBYztRQUNyQyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLEVBQUU7WUFDdEIsTUFBTSxHQUE4QixNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3JELElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDdEM7UUFFRCxPQUFPLE1BQU0sQ0FBQztJQUNmLENBQUM7SUFFTyxTQUFTLENBQUMsTUFBYztRQUMvQixPQUFPLFNBQVMsS0FBSyxJQUFJLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDeEQsQ0FBQztJQUVPLGNBQWMsQ0FBQyxNQUFjO1FBQ3BDLElBQUksQ0FBQyxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUU7WUFDcEMsT0FBTyxDQUFDLElBQUksQ0FBQyx5QkFBeUIsTUFBTSxtQkFBbUIsQ0FBQyxDQUFDO1NBQ2pFO0lBQ0YsQ0FBQzs7QUE1R2UsZ0JBQUksR0FBZ0IsYUFBYSxDQUFDO0FBQ2xDLDZCQUFpQixHQUFHLG9CQUFvQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IE9XZWJBcHAgZnJvbSBcIi4vT1dlYkFwcFwiO1xyXG5pbXBvcnQgT1dlYkV2ZW50IGZyb20gXCIuL09XZWJFdmVudFwiO1xyXG5pbXBvcnQgT1dlYkxhbmcgZnJvbSBcIi4vT1dlYkxhbmdcIjtcclxuaW1wb3J0IFV0aWxzIGZyb20gXCIuL3V0aWxzL1V0aWxzXCI7XHJcblxyXG5leHBvcnQgdHlwZSB0Q29uZmlnTGlzdCA9IHsgW2tleTogc3RyaW5nXTogYW55IH07XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViQ29uZmlncyBleHRlbmRzIE9XZWJFdmVudCB7XHJcblx0c3RhdGljIHJlYWRvbmx5IFNFTEYgICAgICAgICAgICAgID0gXCJPV2ViQ29uZmlnc1wiO1xyXG5cdHN0YXRpYyByZWFkb25seSBFVlRfQ09ORklHX0NIQU5HRSA9IFwiT1dlYkNvbmZpZ3M6Y2hhbmdlXCI7XHJcblxyXG5cdHByaXZhdGUgcmVhZG9ubHkgX2RlZmF1bHRfY29uZmlnczogdENvbmZpZ0xpc3QgICAgID0ge307XHJcblx0cHJpdmF0ZSByZWFkb25seSBfdXNlcl9jb25maWdzOiB0Q29uZmlnTGlzdCAgICAgICAgPSB7fTtcclxuXHRwcml2YXRlIHJlYWRvbmx5IF9wcml2YXRlX2NvbmZpZ3NfbWFwOiB0Q29uZmlnTGlzdCA9IHt9O1xyXG5cdHByaXZhdGUgcmVhZG9ubHkgX3RhZ19uYW1lOiBzdHJpbmcgICAgICAgICAgICAgICAgID0gXCJ1c2VyX2NvbmZpZ3NcIjtcclxuXHJcblx0Y29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhcHBfY29udGV4dDogT1dlYkFwcCwgY29uZmlnczogdENvbmZpZ0xpc3QpIHtcclxuXHRcdHN1cGVyKCk7XHJcblxyXG5cdFx0dGhpcy5sb2FkQ29uZmlncyhjb25maWdzKTtcclxuXHRcdHRoaXMuX2xvYWRTYXZlZENvbmZpZ3MoKTtcclxuXHJcblx0XHRjb25zb2xlLmxvZyhcIltPV2ViQ29uZmlnc10gcmVhZHkhXCIpO1xyXG5cdH1cclxuXHJcblx0bG9hZENvbmZpZ3MoY29uZmlnczogdENvbmZpZ0xpc3QpOiB0aGlzIHtcclxuXHRcdGxldCBzID0gdGhpcztcclxuXHJcblx0XHRVdGlscy5mb3JFYWNoKGNvbmZpZ3MsICh2YWx1ZTogYW55LCBjZmc6IHN0cmluZykgPT4ge1xyXG5cdFx0XHRjZmcgICAgICAgICAgICAgICAgICA9IHMuX3JlYWxDb25maWdOYW1lKGNmZyk7XHJcblx0XHRcdHMuX3VzZXJfY29uZmlnc1tjZmddID0gcy5fZGVmYXVsdF9jb25maWdzW2NmZ10gPSB2YWx1ZTtcclxuXHRcdH0pO1xyXG5cclxuXHRcdHJldHVybiBzO1xyXG5cdH1cclxuXHJcblx0cmVzZXRUb0RlZmF1bHQoY29uZmlnOiBzdHJpbmcpOiB0aGlzIHtcclxuXHRcdGlmIChjb25maWcgaW4gdGhpcy5fZGVmYXVsdF9jb25maWdzKSB7XHJcblx0XHRcdHRoaXMuc2V0KGNvbmZpZywgdGhpcy5fZGVmYXVsdF9jb25maWdzW2NvbmZpZ10pO1xyXG5cdFx0fVxyXG5cclxuXHRcdHJldHVybiB0aGlzO1xyXG5cdH1cclxuXHJcblx0cmVzZXRBbGxUb0RlZmF1bHQoKTogdm9pZCB7XHJcblx0XHRpZiAoY29uZmlybShPV2ViTGFuZy50b0h1bWFuKFwiT1pfQ09ORklSTV9SRVNFVF9DT05GSUdTXCIpKSkge1xyXG5cdFx0XHR0aGlzLmFwcF9jb250ZXh0LmxzLnNhdmUodGhpcy5fdGFnX25hbWUsIHRoaXMuX2RlZmF1bHRfY29uZmlncyk7XHJcblxyXG5cdFx0XHR0aGlzLmFwcF9jb250ZXh0LnJlbG9hZEFwcCgpO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0Z2V0KGNvbmZpZzogc3RyaW5nKTogYW55IHtcclxuXHRcdHRoaXMuX3dhcm5VbmRlZmluZWQoY29uZmlnKTtcclxuXHRcdHJldHVybiB0aGlzLl91c2VyX2NvbmZpZ3NbY29uZmlnXTtcclxuXHR9XHJcblxyXG5cdHNldChjb25maWc6IHN0cmluZywgdmFsdWU6IGFueSk6IHRoaXMge1xyXG5cdFx0bGV0IG0gPSB0aGlzO1xyXG5cdFx0aWYgKFV0aWxzLmlzUGxhaW5PYmplY3QoY29uZmlnKSkge1xyXG5cdFx0XHRVdGlscy5mb3JFYWNoKGNvbmZpZyBhcyB7fSwgKHZhbHVlLCBrZXkpID0+IHtcclxuXHRcdFx0XHRtLl9zZXQoa2V5LCB2YWx1ZSk7XHJcblx0XHRcdH0pO1xyXG5cdFx0fSBlbHNlIHtcclxuXHRcdFx0bS5fc2V0KGNvbmZpZywgdmFsdWUpO1xyXG5cdFx0fVxyXG5cclxuXHRcdHRoaXMuYXBwX2NvbnRleHQubHMuc2F2ZSh0aGlzLl90YWdfbmFtZSwgdGhpcy5fdXNlcl9jb25maWdzKTtcclxuXHRcdHJldHVybiB0aGlzO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBfbG9hZFNhdmVkQ29uZmlncygpIHtcclxuXHRcdGxldCBtICAgICAgICAgPSB0aGlzLFxyXG5cdFx0XHRzYXZlZF9jZmcgPSB0aGlzLmFwcF9jb250ZXh0LmxzLmxvYWQodGhpcy5fdGFnX25hbWUpIHx8IHt9O1xyXG5cclxuXHRcdFV0aWxzLmZvckVhY2gobS5fZGVmYXVsdF9jb25maWdzLCAodmFsdWUsIGtleSkgPT4ge1xyXG5cdFx0XHRpZiAodGhpcy5faXNQdWJsaWMoa2V5KSAmJiBzYXZlZF9jZmdba2V5XSAhPT0gdW5kZWZpbmVkKSB7XHJcblx0XHRcdFx0bS5fdXNlcl9jb25maWdzW2tleV0gPSBzYXZlZF9jZmdba2V5XTtcclxuXHRcdFx0fVxyXG5cdFx0fSk7XHJcblxyXG5cdFx0dGhpcy5hcHBfY29udGV4dC5scy5zYXZlKHRoaXMuX3RhZ19uYW1lLCBtLl91c2VyX2NvbmZpZ3MpO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBfc2V0KGNvbmZpZzogc3RyaW5nLCB2YWx1ZTogYW55KTogdm9pZCB7XHJcblxyXG5cdFx0dGhpcy5fd2FyblVuZGVmaW5lZChjb25maWcpO1xyXG5cclxuXHRcdGlmICghdGhpcy5faXNQdWJsaWMoY29uZmlnKSkge1xyXG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYFtPV2ViQ29uZmlnc10gY2FuJ3Qgb3ZlcndyaXRlIGNvbmZpZyBcIiR7Y29uZmlnfVwiIHBlcm1pc3Npb24gZGVuaWVkLmApO1xyXG5cdFx0fVxyXG5cclxuXHRcdGlmIChjb25maWcgaW4gdGhpcy5fdXNlcl9jb25maWdzKSB7XHJcblx0XHRcdHRoaXMuX3VzZXJfY29uZmlnc1tjb25maWddID0gdmFsdWU7XHJcblxyXG5cdFx0XHR0aGlzLnRyaWdnZXIoT1dlYkNvbmZpZ3MuRVZUX0NPTkZJR19DSEFOR0UsIFtjb25maWcsIHZhbHVlLCB0aGlzXSk7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIF9yZWFsQ29uZmlnTmFtZShjb25maWc6IHN0cmluZyk6IHN0cmluZyB7XHJcblx0XHRpZiAoY29uZmlnWzBdID09PSBcIiFcIikge1xyXG5cdFx0XHRjb25maWcgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBjb25maWcuc3Vic3RyKDEpO1xyXG5cdFx0XHR0aGlzLl9wcml2YXRlX2NvbmZpZ3NfbWFwW2NvbmZpZ10gPSAxO1xyXG5cdFx0fVxyXG5cclxuXHRcdHJldHVybiBjb25maWc7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIF9pc1B1YmxpYyhjb25maWc6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG5cdFx0cmV0dXJuIHVuZGVmaW5lZCA9PT0gdGhpcy5fcHJpdmF0ZV9jb25maWdzX21hcFtjb25maWddO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBfd2FyblVuZGVmaW5lZChjb25maWc6IHN0cmluZykge1xyXG5cdFx0aWYgKCEoY29uZmlnIGluIHRoaXMuX3VzZXJfY29uZmlncykpIHtcclxuXHRcdFx0Y29uc29sZS53YXJuKGBbT1dlYkNvbmZpZ3NdIGNvbmZpZyBcIiR7Y29uZmlnfVwiIGlzIG5vdCBkZWZpbmVkLmApO1xyXG5cdFx0fVxyXG5cdH1cclxufSJdfQ==