import OWebEvent from "./OWebEvent";
import OWebFS from "./OWebFS";
import Utils from "./utils/Utils";
const file_alias_errors = [
    "OZ_FILE_ALIAS_UNKNOWN",
    "OZ_FILE_ALIAS_NOT_FOUND",
    "OZ_FILE_ALIAS_PARSE_ERROR"
];
let searchAndReplaceMarkedFile = function (data) {
    let form_data = new FormData(), has_marked_file = false, check = (value, name) => {
        let v = value;
        if (OWebFS.isMarkedFile(v)) {
            v = OWebFS.createFileAlias(v);
            has_marked_file = true;
        }
        form_data.append(name, v);
    };
    if (data) {
        if (data instanceof FormData) {
            data.forEach(check);
        }
        else if (Utils.isPlainObject(data)) {
            Object.keys(data).forEach(function (key_name) {
                check(data[key_name], key_name);
            });
        }
    }
    return has_marked_file ? form_data : false;
};
export default class OWebCom extends OWebEvent {
    constructor(app_context, options) {
        super();
        this.app_context = app_context;
        this._busy = false;
        if (options && !Utils.isPlainObject(options)) {
            throw new TypeError(`[OWebCom] require an 'object' as options not:  ${typeof options}.`);
        }
        this._options = Object.assign({ method: "GET", dataType: "json", data: {}, crossDomain: true, badNewsShow: false, 
            // increase request timeout for mobile device
            timeout: (app_context.isMobileApp() ? 10000 : undefined) }, (options || {}));
        this._original_data = options.data || {};
        this._modified_data = searchAndReplaceMarkedFile(options.data);
        if (this._modified_data) {
            this._options.data = this._modified_data;
        }
    }
    /**
     * Prepare the request before sending.
     *
     * @private
     */
    _prepare() {
        let m = this, real_method = m._options.method, replace_methods = ["PATCH", "PUT", "DELETE"], api_key_header = this.app_context.configs.get("OZ_API_KEY_HEADER_NAME"), real_method_header = this.app_context.configs.get("OZ_API_REAL_METHOD_HEADER_NAME");
        let headers = this._options.headers = this._options.headers || {};
        headers[api_key_header] = this.app_context.configs.get("OZ_API_KEY");
        // we update request method
        if (~replace_methods.indexOf(real_method)) {
            headers[real_method_header] = real_method;
            this._options.method = "POST";
        }
        if (this._options.data instanceof FormData) {
            this._options.processData = false;
            this._options.contentType = false;
        }
        // workaround because jqXHR does not expose upload property
        this._options.xhr = function () {
            let xhr = $.ajaxSetup({}).xhr();
            // allow CORS
            xhr.withCredentials = true;
            if (xhr.upload) {
                xhr.upload.addEventListener("progress", (e) => {
                    let percent = 0;
                    let position = e.loaded || e.position; // e.position
                    let total = e.total;
                    if (e.lengthComputable) {
                        percent = Math.floor(position / total * 100);
                    }
                    m.trigger(OWebCom.EVT_COM_UPLOAD_PROGRESS, [e, position, total, percent]);
                }, false);
            }
            return xhr;
        };
    }
    /**
     * Handle server response.
     *
     * > Called only when the connection to the server was successfully established.
     *
     * @param response The server response.
     * @private
     */
    _handleResponse(response) {
        let m = this;
        if (response.stime) {
            m.app_context.user.setSessionExpire(response.stime);
        }
        if (response.error === 0) {
            m.trigger(OWebCom.EVT_COM_REQUEST_SUCCESS, [response, m]);
            m.trigger(OWebCom.EVT_COM_FINISH, [response, m]);
        }
        else {
            if (response.msg === "OZ_ERROR_YOU_MUST_LOGIN") {
                m.trigger(OWebCom.EVT_COM_REQUEST_ERROR, [response, m]);
                m.app_context.forceLogin();
            }
            else if (~file_alias_errors.indexOf(response.msg)) {
                // our attempt to minimize file upload failed
                console.warn("[OWebCom] unable to minimize file upload data ->", response, m._options.data);
                this._modified_data = false;
                this._options.data = this._original_data;
                m._busy = false;
                m.send();
            }
            else {
                if (m._options.badNewsShow) {
                    m.app_context.view.dialog({
                        type: "error",
                        text: response.msg,
                        data: response.data
                    });
                }
                m.trigger(OWebCom.EVT_COM_REQUEST_ERROR, [response, m]);
                m.trigger(OWebCom.EVT_COM_FINISH, [response, m]);
            }
        }
    }
    /**
     * Send request.
     */
    send() {
        let m = this;
        this._prepare();
        if (this._busy) {
            console.warn("[OWebCom] instance is busy ->", m);
            return;
        }
        if (this._options) {
            this._busy = true;
            this._request = $.ajax(m._options)
                .done((response) => {
                m._handleResponse(response);
            })
                .fail((request) => {
                let network_error = !Utils.isPlainObject(request["responseJSON"]);
                if (network_error) {
                    console.error("[OWebCom] request network error ->", request);
                    m.trigger(OWebCom.EVT_COM_NETWORK_ERROR, [request, m]);
                }
                else {
                    console.error("[OWebCom] request server error ->", request);
                    m._handleResponse(request["responseJSON"]);
                }
            });
        }
    }
    /**
     * Try to abort the current request.
     */
    abort() {
        this._busy = false;
        if (this._request) {
            this._request.abort();
        }
    }
}
OWebCom.SELF = Utils.id();
OWebCom.EVT_COM_REQUEST_SUCCESS = Utils.id();
OWebCom.EVT_COM_REQUEST_ERROR = Utils.id();
OWebCom.EVT_COM_NETWORK_ERROR = Utils.id();
OWebCom.EVT_COM_UPLOAD_PROGRESS = Utils.id();
OWebCom.EVT_COM_FINISH = Utils.id();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkNvbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViQ29tLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sU0FBUyxNQUFNLGFBQWEsQ0FBQztBQUNwQyxPQUFPLE1BQU0sTUFBTSxVQUFVLENBQUM7QUFDOUIsT0FBTyxLQUFLLE1BQU0sZUFBZSxDQUFDO0FBeUJsQyxNQUFNLGlCQUFpQixHQUFHO0lBQ3pCLHVCQUF1QjtJQUN2Qix5QkFBeUI7SUFDekIsMkJBQTJCO0NBQzNCLENBQUM7QUFFRixJQUFJLDBCQUEwQixHQUFHLFVBQVUsSUFBd0M7SUFDbEYsSUFBSSxTQUFTLEdBQVMsSUFBSSxRQUFRLEVBQUUsRUFDbkMsZUFBZSxHQUFHLEtBQUssRUFDdkIsS0FBSyxHQUFhLENBQUMsS0FBVSxFQUFFLElBQVksRUFBRSxFQUFFO1FBQzlDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUVkLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUMzQixDQUFDLEdBQWlCLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDNUMsZUFBZSxHQUFHLElBQUksQ0FBQztTQUN2QjtRQUVELFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzNCLENBQUMsQ0FBQztJQUVILElBQUksSUFBSSxFQUFFO1FBQ1QsSUFBSSxJQUFJLFlBQVksUUFBUSxFQUFFO1lBQzVCLElBQVksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDN0I7YUFBTSxJQUFJLEtBQUssQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDckMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxRQUFRO2dCQUMzQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQ2pDLENB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QUFLLENBQUM7UUFDbkIsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2xCLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDdEI7SUFDRixDQUFDOztBQS9LZSxZQUFJLEdBQXNCLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUNyQywrQkFBdUIsR0FBRyxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUM7QUFDckMsNkJBQXFCLEdBQUssS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQ3JDLDZCQUFxQixHQUFLLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUNyQywrQkFBdUIsR0FBRyxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUM7QUFDckMsc0JBQWMsR0FBWSxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT1dlYkFwcCBmcm9tIFwiLi9PV2ViQXBwXCI7XG5pbXBvcnQgT1dlYkV2ZW50IGZyb20gXCIuL09XZWJFdmVudFwiO1xuaW1wb3J0IE9XZWJGUyBmcm9tIFwiLi9PV2ViRlNcIjtcbmltcG9ydCBVdGlscyBmcm9tIFwiLi91dGlscy9VdGlsc1wiO1xuaW1wb3J0IGpxWEhSID0gSlF1ZXJ5LmpxWEhSO1xuXG5leHBvcnQgaW50ZXJmYWNlIGlDb21SZXNwb25zZSB7XG5cdGVycm9yOiBudW1iZXIsXG5cdG1zZzogc3RyaW5nLFxuXHRkYXRhPzogYW55LFxuXHR1dGltZTogbnVtYmVyLFxuXHRzdGltZT86IG51bWJlcixcblx0bmV0ZXJyb3I/OiBib29sZWFuXG59XG5cbmV4cG9ydCB0eXBlIHRDb21PcHRpb25zID0ge1xuXHR1cmw6IHN0cmluZyxcblx0bWV0aG9kOiBzdHJpbmcsXG5cdHhocj86IGFueSxcblx0aGVhZGVycz86IHt9LFxuXHRkYXRhPzoge30sXG5cdGRhdGFUeXBlPzogc3RyaW5nLFxuXHRjcm9zc0RvbWFpbj86IGJvb2xlYW4sXG5cdHByb2Nlc3NEYXRhPzogYm9vbGVhbixcblx0Y29udGVudFR5cGU/OiBhbnksXG5cdGJhZE5ld3NTaG93PzogYm9vbGVhbixcblx0dGltZW91dD86IG51bWJlclxufTtcbmNvbnN0IGZpbGVfYWxpYXNfZXJyb3JzID0gW1xuXHRcIk9aX0ZJTEVfQUxJQVNfVU5LTk9XTlwiLFxuXHRcIk9aX0ZJTEVfQUxJQVNfTk9UX0ZPVU5EXCIsXG5cdFwiT1pfRklMRV9BTElBU19QQVJTRV9FUlJPUlwiXG5dO1xuXG5sZXQgc2VhcmNoQW5kUmVwbGFjZU1hcmtlZEZpbGUgPSBmdW5jdGlvbiAoZGF0YT86IHsgW2tleTogc3RyaW5nXTogYW55IH0gfCBGb3JtRGF0YSkge1xuXHRsZXQgZm9ybV9kYXRhICAgICAgID0gbmV3IEZvcm1EYXRhKCksXG5cdFx0aGFzX21hcmtlZF9maWxlID0gZmFsc2UsXG5cdFx0Y2hlY2sgICAgICAgICAgID0gKHZhbHVlOiBhbnksIG5hbWU6IHN0cmluZykgPT4ge1xuXHRcdFx0bGV0IHYgPSB2YWx1ZTtcblxuXHRcdFx0aWYgKE9XZWJGUy5pc01hcmtlZEZpbGUodikpIHtcblx0XHRcdFx0diAgICAgICAgICAgICAgID0gT1dlYkZTLmNyZWF0ZUZpbGVBbGlhcyh2KTtcblx0XHRcdFx0aGFzX21hcmtlZF9maWxlID0gdHJ1ZTtcblx0XHRcdH1cblxuXHRcdFx0Zm9ybV9kYXRhLmFwcGVuZChuYW1lLCB2KTtcblx0XHR9O1xuXG5cdGlmIChkYXRhKSB7XG5cdFx0aWYgKGRhdGEgaW5zdGFuY2VvZiBGb3JtRGF0YSkge1xuXHRcdFx0KGRhdGEgYXMgYW55KS5mb3JFYWNoKGNoZWNrKTtcblx0XHR9IGVsc2UgaWYgKFV0aWxzLmlzUGxhaW5PYmplY3QoZGF0YSkpIHtcblx0XHRcdE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2goZnVuY3Rpb24gKGtleV9uYW1lKSB7XG5cdFx0XHRcdGNoZWNrKGRhdGFba2V5X25hbWVdLCBrZXlfbmFtZSk7XG5cdFx0XHR9KTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gaGFzX21hcmtlZF9maWxlID8gZm9ybV9kYXRhIDogZmFsc2U7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViQ29tIGV4dGVuZHMgT1dlYkV2ZW50IHtcblxuXHRzdGF0aWMgcmVhZG9ubHkgU0VMRiAgICAgICAgICAgICAgICAgICAgPSBVdGlscy5pZCgpO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9SRVFVRVNUX1NVQ0NFU1MgPSBVdGlscy5pZCgpO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9SRVFVRVNUX0VSUk9SICAgPSBVdGlscy5pZCgpO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9ORVRXT1JLX0VSUk9SICAgPSBVdGlscy5pZCgpO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9VUExPQURfUFJPR1JFU1MgPSBVdGlscy5pZCgpO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9GSU5JU0ggICAgICAgICAgPSBVdGlscy5pZCgpO1xuXG5cdHByaXZhdGUgcmVhZG9ubHkgX29wdGlvbnM6IHRDb21PcHRpb25zO1xuXHRwcml2YXRlIHJlYWRvbmx5IF9vcmlnaW5hbF9kYXRhOiBhbnk7XG5cdHByaXZhdGUgX21vZGlmaWVkX2RhdGE6IEZvcm1EYXRhIHwgYm9vbGVhbjtcblx0cHJpdmF0ZSBfYnVzeTogYm9vbGVhbiA9IGZhbHNlO1xuXHRwcml2YXRlIF9yZXF1ZXN0PzoganFYSFI7XG5cblx0Y29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhcHBfY29udGV4dDogT1dlYkFwcCwgb3B0aW9uczogdENvbU9wdGlvbnMpIHtcblx0XHRzdXBlcigpO1xuXG5cdFx0aWYgKG9wdGlvbnMgJiYgIVV0aWxzLmlzUGxhaW5PYmplY3Qob3B0aW9ucykpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoYFtPV2ViQ29tXSByZXF1aXJlIGFuICdvYmplY3QnIGFzIG9wdGlvbnMgbm90OiAgJHt0eXBlb2Ygb3B0aW9uc30uYCk7XG5cdFx0fVxuXG5cdFx0dGhpcy5fb3B0aW9ucyAgICAgICA9IHtcblx0XHRcdG1ldGhvZCAgICAgOiBcIkdFVFwiLFxuXHRcdFx0ZGF0YVR5cGUgICA6IFwianNvblwiLFxuXHRcdFx0ZGF0YSAgICAgICA6IHt9LFxuXHRcdFx0Y3Jvc3NEb21haW46IHRydWUsXG5cdFx0XHRiYWROZXdzU2hvdzogZmFsc2UsXG5cdFx0XHQvLyBpbmNyZWFzZSByZXF1ZXN0IHRpbWVvdXQgZm9yIG1vYmlsZSBkZXZpY2Vcblx0XHRcdHRpbWVvdXQgICAgOiAoYXBwX2NvbnRleHQuaXNNb2JpbGVBcHAoKSA/IDEwMDAwIDogdW5kZWZpbmVkKSxcblx0XHRcdC4uLihvcHRpb25zIHx8IHt9KVxuXHRcdH07XG5cdFx0dGhpcy5fb3JpZ2luYWxfZGF0YSA9IG9wdGlvbnMuZGF0YSB8fCB7fTtcblx0XHR0aGlzLl9tb2RpZmllZF9kYXRhID0gc2VhcmNoQW5kUmVwbGFjZU1hcmtlZEZpbGUob3B0aW9ucy5kYXRhKTtcblxuXHRcdGlmICh0aGlzLl9tb2RpZmllZF9kYXRhKSB7XG5cdFx0XHR0aGlzLl9vcHRpb25zLmRhdGEgPSB0aGlzLl9tb2RpZmllZF9kYXRhO1xuXHRcdH1cblxuXHR9XG5cblx0LyoqXG5cdCAqIFByZXBhcmUgdGhlIHJlcXVlc3QgYmVmb3JlIHNlbmRpbmcuXG5cdCAqXG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIF9wcmVwYXJlKCkge1xuXHRcdGxldCBtICAgICAgICAgICAgICAgICAgPSB0aGlzLFxuXHRcdFx0cmVhbF9tZXRob2QgICAgICAgID0gbS5fb3B0aW9ucy5tZXRob2QsXG5cdFx0XHRyZXBsYWNlX21ldGhvZHMgICAgPSBbXCJQQVRDSFwiLCBcIlBVVFwiLCBcIkRFTEVURVwiXSxcblx0XHRcdGFwaV9rZXlfaGVhZGVyICAgICA9IHRoaXMuYXBwX2NvbnRleHQuY29uZmlncy5nZXQoXCJPWl9BUElfS0VZX0hFQURFUl9OQU1FXCIpLFxuXHRcdFx0cmVhbF9tZXRob2RfaGVhZGVyID0gdGhpcy5hcHBfY29udGV4dC5jb25maWdzLmdldChcIk9aX0FQSV9SRUFMX01FVEhPRF9IRUFERVJfTkFNRVwiKTtcblxuXHRcdGxldCBoZWFkZXJzOiBhbnkgICAgICAgID0gdGhpcy5fb3B0aW9ucy5oZWFkZXJzID0gdGhpcy5fb3B0aW9ucy5oZWFkZXJzIHx8IHt9O1xuXHRcdGhlYWRlcnNbYXBpX2tleV9oZWFkZXJdID0gdGhpcy5hcHBfY29udGV4dC5jb25maWdzLmdldChcIk9aX0FQSV9LRVlcIik7XG5cblx0XHQvLyB3ZSB1cGRhdGUgcmVxdWVzdCBtZXRob2Rcblx0XHRpZiAofnJlcGxhY2VfbWV0aG9kcy5pbmRleE9mKHJlYWxfbWV0aG9kKSkge1xuXHRcdFx0aGVhZGVyc1tyZWFsX21ldGhvZF9oZWFkZXJdID0gcmVhbF9tZXRob2Q7XG5cdFx0XHR0aGlzLl9vcHRpb25zLm1ldGhvZCAgICAgICAgPSBcIlBPU1RcIjtcblx0XHR9XG5cblx0XHRpZiAodGhpcy5fb3B0aW9ucy5kYXRhIGluc3RhbmNlb2YgRm9ybURhdGEpIHtcblx0XHRcdHRoaXMuX29wdGlvbnMucHJvY2Vzc0RhdGEgPSBmYWxzZTtcblx0XHRcdHRoaXMuX29wdGlvbnMuY29udGVudFR5cGUgPSBmYWxzZTtcblx0XHR9XG5cblx0XHQvLyB3b3JrYXJvdW5kIGJlY2F1c2UganFYSFIgZG9lcyBub3QgZXhwb3NlIHVwbG9hZCBwcm9wZXJ0eVxuXHRcdHRoaXMuX29wdGlvbnMueGhyID0gZnVuY3Rpb24gKCkge1xuXHRcdFx0bGV0IHhociA9ICQuYWpheFNldHVwKHt9KS54aHIhKCk7XG5cblx0XHRcdC8vIGFsbG93IENPUlNcblx0XHRcdHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlO1xuXG5cdFx0XHRpZiAoeGhyLnVwbG9hZCkge1xuXHRcdFx0XHR4aHIudXBsb2FkLmFkZEV2ZW50TGlzdGVuZXIoXCJwcm9ncmVzc1wiLCAoZTogYW55KSA9PiB7XG5cdFx0XHRcdFx0bGV0IHBlcmNlbnQgID0gMDtcblx0XHRcdFx0XHRsZXQgcG9zaXRpb24gPSBlLmxvYWRlZCB8fCBlLnBvc2l0aW9uOy8vIGUucG9zaXRpb25cblx0XHRcdFx0XHRsZXQgdG90YWwgICAgPSBlLnRvdGFsO1xuXG5cdFx0XHRcdFx0aWYgKGUubGVuZ3RoQ29tcHV0YWJsZSkge1xuXHRcdFx0XHRcdFx0cGVyY2VudCA9IE1hdGguZmxvb3IocG9zaXRpb24gLyB0b3RhbCAqIDEwMCk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0bS50cmlnZ2VyKE9XZWJDb20uRVZUX0NPTV9VUExPQURfUFJPR1JFU1MsIFtlLCBwb3NpdGlvbiwgdG90YWwsIHBlcmNlbnRdKTtcblxuXHRcdFx0XHR9LCBmYWxzZSk7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiB4aHI7XG5cdFx0fTtcblx0fVxuXG5cdC8qKlxuXHQgKiBIYW5kbGUgc2VydmVyIHJlc3BvbnNlLlxuXHQgKlxuXHQgKiA+IENhbGxlZCBvbmx5IHdoZW4gdGhlIGNvbm5lY3Rpb24gdG8gdGhlIHNlcnZlciB3YXMgc3VjY2Vzc2Z1bGx5IGVzdGFibGlzaGVkLlxuXHQgKlxuXHQgKiBAcGFyYW0gcmVzcG9uc2UgVGhlIHNlcnZlciByZXNwb25zZS5cblx0ICogQHByaXZhdGVcblx0ICovXG5cdHByaXZhdGUgX2hhbmRsZVJlc3BvbnNlKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpIHtcblx0XHRsZXQgbSA9IHRoaXM7XG5cblx0XHRpZiAocmVzcG9uc2Uuc3RpbWUpIHtcblx0XHRcdG0uYXBwX2NvbnRleHQudXNlci5zZXRTZXNzaW9uRXhwaXJlKHJlc3BvbnNlLnN0aW1lKTtcblx0XHR9XG5cblx0XHRpZiAocmVzcG9uc2UuZXJyb3IgPT09IDApIHtcblx0XHRcdG0udHJpZ2dlcihPV2ViQ29tLkVWVF9DT01fUkVRVUVTVF9TVUNDRVNTLCBbcmVzcG9uc2UsIG1dKTtcblx0XHRcdG0udHJpZ2dlcihPV2ViQ29tLkVWVF9DT01fRklOSVNILCBbcmVzcG9uc2UsIG1dKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0aWYgKHJlc3BvbnNlLm1zZyA9PT0gXCJPWl9FUlJPUl9ZT1VfTVVTVF9MT0dJTlwiKSB7XG5cdFx0XHRcdG0udHJpZ2dlcihPV2ViQ29tLkVWVF9DT01fUkVRVUVTVF9FUlJPUiwgW3Jlc3BvbnNlLCBtXSk7XG5cdFx0XHRcdG0uYXBwX2NvbnRleHQuZm9yY2VMb2dpbigpO1xuXHRcdFx0fSBlbHNlIGlmICh+ZmlsZV9hbGlhc19lcnJvcnMuaW5kZXhPZihyZXNwb25zZS5tc2cpKSB7XG5cdFx0XHRcdC8vIG91ciBhdHRlbXB0IHRvIG1pbmltaXplIGZpbGUgdXBsb2FkIGZhaWxlZFxuXHRcdFx0XHRjb25zb2xlLndhcm4oXCJbT1dlYkNvbV0gdW5hYmxlIHRvIG1pbmltaXplIGZpbGUgdXBsb2FkIGRhdGEgLT5cIiwgcmVzcG9uc2UsIG0uX29wdGlvbnMuZGF0YSk7XG5cdFx0XHRcdHRoaXMuX21vZGlmaWVkX2RhdGEgPSBmYWxzZTtcblx0XHRcdFx0dGhpcy5fb3B0aW9ucy5kYXRhICA9IHRoaXMuX29yaWdpbmFsX2RhdGE7XG5cdFx0XHRcdG0uX2J1c3kgICAgICAgICAgICAgPSBmYWxzZTtcblx0XHRcdFx0bS5zZW5kKCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRpZiAobS5fb3B0aW9ucy5iYWROZXdzU2hvdykge1xuXHRcdFx0XHRcdG0uYXBwX2NvbnRleHQudmlldy5kaWFsb2coe1xuXHRcdFx0XHRcdFx0dHlwZTogXCJlcnJvclwiLFxuXHRcdFx0XHRcdFx0dGV4dDogcmVzcG9uc2UubXNnLFxuXHRcdFx0XHRcdFx0ZGF0YTogcmVzcG9uc2UuZGF0YVxuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0bS50cmlnZ2VyKE9XZWJDb20uRVZUX0NPTV9SRVFVRVNUX0VSUk9SLCBbcmVzcG9uc2UsIG1dKTtcblx0XHRcdFx0bS50cmlnZ2VyKE9XZWJDb20uRVZUX0NPTV9GSU5JU0gsIFtyZXNwb25zZSwgbV0pO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBTZW5kIHJlcXVlc3QuXG5cdCAqL1xuXHRzZW5kKCkge1xuXHRcdGxldCBtID0gdGhpcztcblx0XHR0aGlzLl9wcmVwYXJlKCk7XG5cblx0XHRpZiAodGhpcy5fYnVzeSkge1xuXHRcdFx0Y29uc29sZS53YXJuKFwiW09XZWJDb21dIGluc3RhbmNlIGlzIGJ1c3kgLT5cIiwgbSk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0aWYgKHRoaXMuX29wdGlvbnMpIHtcblx0XHRcdHRoaXMuX2J1c3kgICAgPSB0cnVlO1xuXHRcdFx0dGhpcy5fcmVxdWVzdCA9ICQuYWpheChtLl9vcHRpb25zKVxuXHRcdFx0XHRcdFx0XHQgLmRvbmUoKHJlc3BvbnNlOiBhbnkpID0+IHtcblx0XHRcdFx0XHRcdFx0XHQgbS5faGFuZGxlUmVzcG9uc2UocmVzcG9uc2UpO1xuXHRcdFx0XHRcdFx0XHQgfSlcblx0XHRcdFx0XHRcdFx0IC5mYWlsKChyZXF1ZXN0OiBhbnkpID0+IHtcblx0XHRcdFx0XHRcdFx0XHQgbGV0IG5ldHdvcmtfZXJyb3IgPSAhVXRpbHMuaXNQbGFpbk9iamVjdChcblx0XHRcdFx0XHRcdFx0XHRcdCByZXF1ZXN0W1wicmVzcG9uc2VKU09OXCJdKTtcblx0XHRcdFx0XHRcdFx0XHQgaWYgKG5ldHdvcmtfZXJyb3IpIHtcblx0XHRcdFx0XHRcdFx0XHRcdCBjb25zb2xlLmVycm9yKFwiW09XZWJDb21dIHJlcXVlc3QgbmV0d29yayBlcnJvciAtPlwiLCByZXF1ZXN0KTtcblx0XHRcdFx0XHRcdFx0XHRcdCBtLnRyaWdnZXIoT1dlYkNvbS5FVlRfQ09NX05FVFdPUktfRVJST1IsIFtyZXF1ZXN0LCBtXSk7XG5cdFx0XHRcdFx0XHRcdFx0IH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdFx0XHQgY29uc29sZS5lcnJvcihcIltPV2ViQ29tXSByZXF1ZXN0IHNlcnZlciBlcnJvciAtPlwiLCByZXF1ZXN0KTtcblx0XHRcdFx0XHRcdFx0XHRcdCBtLl9oYW5kbGVSZXNwb25zZShyZXF1ZXN0W1wicmVzcG9uc2VKU09OXCJdKTtcblx0XHRcdFx0XHRcdFx0XHQgfVxuXHRcdFx0XHRcdFx0XHQgfSk7XG5cdFx0fVxuXHR9XG5cblx0LyoqXG5cdCAqIFRyeSB0byBhYm9ydCB0aGUgY3VycmVudCByZXF1ZXN0LlxuXHQgKi9cblx0YWJvcnQoKSB7XG5cdFx0dGhpcy5fYnVzeSA9IGZhbHNlO1xuXHRcdGlmICh0aGlzLl9yZXF1ZXN0KSB7XG5cdFx0XHR0aGlzLl9yZXF1ZXN0LmFib3J0KCk7XG5cdFx0fVxuXHR9XG59Il19