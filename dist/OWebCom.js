import { OWebEvent, Utils, OWebFS } from "./oweb";
const file_alias_errors = [
    "OZ_FILE_ALIAS_UNKNOWN",
    "OZ_FILE_ALIAS_NOT_FOUND",
    "OZ_FILE_ALIAS_PARSE_ERROR"
], default_options = {
    url: "",
    method: "GET",
    data: {},
    dataType: "json",
    crossDomain: true,
    badNewsShow: false,
    // increase request timeout for mobile device
    // TODO: find a good way to check if mobile device
    timeout: ("cordova" in window ? 10000 : undefined)
};
let searchAndReplaceMarkedFile = function (data) {
    let form_data = new FormData(), has_marked_file = false, check = (value, name) => {
        let v = value;
        if (OWebFS.isMarkedFile(v)) {
            v = OWebFS.createFileAlias(v);
            has_marked_file = true;
        }
        form_data.append(name, v);
    };
    if (data) {
        if (data instanceof FormData) {
            data.forEach(check);
        }
        else if (Utils.isPlainObject(data)) {
            Object.keys(data).forEach(function (key_name) {
                check(data[key_name], key_name);
            });
        }
    }
    return has_marked_file ? form_data : false;
};
export default class OWebCom extends OWebEvent {
    constructor(app_context, options) {
        super();
        this.app_context = app_context;
        this._busy = false;
        if (options && !Utils.isPlainObject(options)) {
            throw new TypeError(`[OWebCom] require an 'object' as options not:  ${typeof options}.`);
        }
        this._options = Utils.assign({}, default_options, options || {});
        this._original_data = options.data || {};
        this._modified_data = searchAndReplaceMarkedFile(options.data);
        if (this._modified_data) {
            this._options.data = this._modified_data;
        }
    }
    _init() {
        let m = this, real_method = m._options.method, replace_methods = ["PATCH", "PUT", "DELETE"], api_key_header = this.app_context.configs.get("OZ_API_KEY_HEADER_NAME"), real_method_header = this.app_context.configs.get("OZ_API_REAL_METHOD_HEADER_NAME");
        let headers = this._options.headers = this._options.headers || {};
        headers[api_key_header] = this.app_context.configs.get("OZ_API_KEY");
        // update request method
        if (~replace_methods.indexOf(real_method)) {
            headers[real_method_header] = real_method;
            this._options.method = "POST";
        }
        if (this._options.data instanceof FormData) {
            this._options.processData = false;
            this._options.contentType = false;
        }
        // workaround because jqXHR does not expose upload property
        this._options.xhr = function () {
            let xhr = $.ajaxSettings.xhr();
            // allow CORS
            xhr.withCredentials = true;
            if (xhr.upload) {
                xhr.upload.addEventListener("progress", (e) => {
                    let percent = 0;
                    let position = e.loaded || e.position; // e.position
                    let total = e.total;
                    if (e.lengthComputable) {
                        percent = Math.floor(position / total * 100);
                    }
                    m.trigger(OWebCom.EVT_COM_UPLOAD_PROGRESS, [e, position, total, percent]);
                }, false);
            }
            return xhr;
        };
    }
    // the connection to the server was successfully established
    _handleResponse(response) {
        let m = this;
        if (response.stime) {
            m.app_context.user.setSessionExpire(response.stime);
        }
        if (response.error === 0) {
            m.trigger(OWebCom.EVT_COM_REQUEST_SUCCESS, [response, m]);
            m.trigger(OWebCom.EVT_COM_FINISH, [response, m]);
        }
        else {
            if (response.msg === "OZ_ERROR_YOU_MUST_LOGIN") {
                m.app_context.forceLogin();
            }
            else if (~file_alias_errors.indexOf(response.msg)) {
                // our attempt to minimize file upload failed
                console.warn("[OWebCom] unable to minimize file upload data ->", response, m._options.data);
                this._modified_data = false;
                this._options.data = this._original_data;
                m._busy = false;
                m.send();
            }
            else {
                if (m._options.badNewsShow) {
                    m.app_context.view.dialog({
                        type: "error",
                        text: response.msg,
                        data: response.data
                    });
                }
                m.trigger(OWebCom.EVT_COM_REQUEST_ERROR, [response, m]);
                m.trigger(OWebCom.EVT_COM_FINISH, [response, m]);
            }
        }
    }
    send() {
        let m = this;
        this._init();
        if (this._busy) {
            console.warn("[OWebCom] instance is busy ->", m);
            return;
        }
        if (this._options) {
            this._busy = true;
            this._request = $.ajax(m._options)
                .done((response) => {
                m._handleResponse(response);
            })
                .fail((request) => {
                let network_error = !Utils.isPlainObject(request["responseJSON"]);
                if (network_error) {
                    console.error("[OWebCom] request network error ->", request);
                    m.trigger(OWebCom.EVT_COM_NETWORK_ERROR, [request, m]);
                }
                else {
                    console.error("[OWebCom] request server error ->", request);
                    m._handleResponse(request["responseJSON"]);
                }
            });
        }
    }
    abort() {
        this._busy = false;
        if (this._request) {
            this._request.abort();
        }
    }
}
OWebCom.EVT_COM_REQUEST_SUCCESS = "OWebCom:success";
OWebCom.EVT_COM_REQUEST_ERROR = "OWebCom:error";
OWebCom.EVT_COM_NETWORK_ERROR = "OWebCom:net_error";
OWebCom.EVT_COM_UPLOAD_PROGRESS = "OWebCom:upload_progress";
OWebCom.EVT_COM_FINISH = "OWebCom:finish";
OWebCom.SELF = "OWebCom";
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkNvbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViQ29tLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBVSxTQUFTLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBQyxNQUFNLFFBQVEsQ0FBQztBQXlCekQsTUFBTSxpQkFBaUIsR0FBYztJQUNqQyx1QkFBdUI7SUFDdkIseUJBQXlCO0lBQ3pCLDJCQUEyQjtDQUMzQixFQUNELGVBQWUsR0FBZ0I7SUFDOUIsR0FBRyxFQUFVLEVBQUU7SUFDZixNQUFNLEVBQU8sS0FBSztJQUNsQixJQUFJLEVBQVMsRUFBRTtJQUNmLFFBQVEsRUFBSyxNQUFNO0lBQ25CLFdBQVcsRUFBRSxJQUFJO0lBQ2pCLFdBQVcsRUFBRSxLQUFLO0lBQ2xCLDZDQUE2QztJQUM3QyxrREFBa0Q7SUFDbEQsT0FBTyxFQUFNLENBQUMsU0FBUyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7Q0FDdEQsQ0FBQztBQUVMLElBQUksMEJBQTBCLEdBQUcsVUFBVSxJQUF3QztJQUNsRixJQUFJLFNBQVMsR0FBUyxJQUFJLFFBQVEsRUFBRSxFQUNuQyxlQUFlLEdBQUcsS0FBSyxFQUN2QixLQUFLLEdBQWEsQ0FBQyxLQUFVLEVBQUUsSUFBWSxFQUFFLEVBQUU7UUFDOUMsSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBRWQsSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQzNCLENBQUMsR0FBaUIsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM1QyxlQUFlLEdBQUcsSUFBSSxDQUFDO1NBQ3ZCO1FBRUQsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDM0IsQ0FBQyxDQUFDO0lBRUgsSUFBSSxJQUFJLEVBQUU7UUFDVCxJQUFJLElBQUksWUFBWSxRQUFRLEVB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LENBQUM7O0FBbkplLCtCQUF1QixHQUFHLGlCQUFpQixDQUFDO0FBQzVDLDZCQUFxQixHQUFLLGVBQWUsQ0FBQztBQUMxQyw2QkFBcUIsR0FBSyxtQkFBbUIsQ0FBQztBQUM5QywrQkFBdUIsR0FBRyx5QkFBeUIsQ0FBQztBQUNwRCxzQkFBYyxHQUFZLGdCQUFnQixDQUFDO0FBQzNDLFlBQUksR0FBc0IsU0FBUyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtPV2ViQXBwLCBPV2ViRXZlbnQsIFV0aWxzLCBPV2ViRlN9IGZyb20gXCIuL293ZWJcIjtcbmltcG9ydCBqcVhIUiA9IEpRdWVyeS5qcVhIUjtcblxuZXhwb3J0IGludGVyZmFjZSBpQ29tUmVzcG9uc2Uge1xuXHRlcnJvcjogbnVtYmVyLFxuXHRtc2c6IHN0cmluZyxcblx0ZGF0YT86IGFueSxcblx0dXRpbWU6IG51bWJlcixcblx0c3RpbWU/OiBudW1iZXIsXG5cdG5ldGVycm9yPzogYm9vbGVhblxufVxuXG5leHBvcnQgdHlwZSB0Q29tT3B0aW9ucyA9IHtcblx0dXJsOiBzdHJpbmcsXG5cdG1ldGhvZDogc3RyaW5nLFxuXHR4aHI/OiBhbnksXG5cdGhlYWRlcnM/OiB7fSxcblx0ZGF0YT86IHt9LFxuXHRkYXRhVHlwZT86IHN0cmluZyxcblx0Y3Jvc3NEb21haW4/OiBib29sZWFuLFxuXHRwcm9jZXNzRGF0YT86IGJvb2xlYW4sXG5cdGNvbnRlbnRUeXBlPzogYW55LFxuXHRiYWROZXdzU2hvdz86IGJvb2xlYW4sXG5cdHRpbWVvdXQ/OiBudW1iZXJcbn07XG5jb25zdCBmaWxlX2FsaWFzX2Vycm9ycyAgICAgICAgICAgID0gW1xuXHRcdCAgXCJPWl9GSUxFX0FMSUFTX1VOS05PV05cIixcblx0XHQgIFwiT1pfRklMRV9BTElBU19OT1RfRk9VTkRcIixcblx0XHQgIFwiT1pfRklMRV9BTElBU19QQVJTRV9FUlJPUlwiXG5cdCAgXSxcblx0ICBkZWZhdWx0X29wdGlvbnM6IHRDb21PcHRpb25zID0ge1xuXHRcdCAgdXJsICAgICAgICA6IFwiXCIsXG5cdFx0ICBtZXRob2QgICAgIDogXCJHRVRcIixcblx0XHQgIGRhdGEgICAgICAgOiB7fSxcblx0XHQgIGRhdGFUeXBlICAgOiBcImpzb25cIixcblx0XHQgIGNyb3NzRG9tYWluOiB0cnVlLFxuXHRcdCAgYmFkTmV3c1Nob3c6IGZhbHNlLFxuXHRcdCAgLy8gaW5jcmVhc2UgcmVxdWVzdCB0aW1lb3V0IGZvciBtb2JpbGUgZGV2aWNlXG5cdFx0ICAvLyBUT0RPOiBmaW5kIGEgZ29vZCB3YXkgdG8gY2hlY2sgaWYgbW9iaWxlIGRldmljZVxuXHRcdCAgdGltZW91dCAgICA6IChcImNvcmRvdmFcIiBpbiB3aW5kb3cgPyAxMDAwMCA6IHVuZGVmaW5lZClcblx0ICB9O1xuXG5sZXQgc2VhcmNoQW5kUmVwbGFjZU1hcmtlZEZpbGUgPSBmdW5jdGlvbiAoZGF0YT86IHsgW2tleTogc3RyaW5nXTogYW55IH0gfCBGb3JtRGF0YSkge1xuXHRsZXQgZm9ybV9kYXRhICAgICAgID0gbmV3IEZvcm1EYXRhKCksXG5cdFx0aGFzX21hcmtlZF9maWxlID0gZmFsc2UsXG5cdFx0Y2hlY2sgICAgICAgICAgID0gKHZhbHVlOiBhbnksIG5hbWU6IHN0cmluZykgPT4ge1xuXHRcdFx0bGV0IHYgPSB2YWx1ZTtcblxuXHRcdFx0aWYgKE9XZWJGUy5pc01hcmtlZEZpbGUodikpIHtcblx0XHRcdFx0diAgICAgICAgICAgICAgID0gT1dlYkZTLmNyZWF0ZUZpbGVBbGlhcyh2KTtcblx0XHRcdFx0aGFzX21hcmtlZF9maWxlID0gdHJ1ZTtcblx0XHRcdH1cblxuXHRcdFx0Zm9ybV9kYXRhLmFwcGVuZChuYW1lLCB2KTtcblx0XHR9O1xuXG5cdGlmIChkYXRhKSB7XG5cdFx0aWYgKGRhdGEgaW5zdGFuY2VvZiBGb3JtRGF0YSkge1xuXHRcdFx0KGRhdGEgYXMgYW55KS5mb3JFYWNoKGNoZWNrKTtcblx0XHR9IGVsc2UgaWYgKFV0aWxzLmlzUGxhaW5PYmplY3QoZGF0YSkpIHtcblx0XHRcdE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2goZnVuY3Rpb24gKGtleV9uYW1lKSB7XG5cdFx0XHRcdGNoZWNrKGRhdGFba2V5X25hbWVdLCBrZXlfbmFtZSk7XG5cdFx0XHR9KTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gaGFzX21hcmtlZF9maWxlID8gZm9ybV9kYXRhIDogZmFsc2U7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViQ29tIGV4dGVuZHMgT1dlYkV2ZW50IHtcblxuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9SRVFVRVNUX1NVQ0NFU1MgPSBcIk9XZWJDb206c3VjY2Vzc1wiO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9SRVFVRVNUX0VSUk9SICAgPSBcIk9XZWJDb206ZXJyb3JcIjtcblx0c3RhdGljIHJlYWRvbmx5IEVWVF9DT01fTkVUV09SS19FUlJPUiAgID0gXCJPV2ViQ29tOm5ldF9lcnJvclwiO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9VUExPQURfUFJPR1JFU1MgPSBcIk9XZWJDb206dXBsb2FkX3Byb2dyZXNzXCI7XG5cdHN0YXRpYyByZWFkb25seSBFVlRfQ09NX0ZJTklTSCAgICAgICAgICA9IFwiT1dlYkNvbTpmaW5pc2hcIjtcblx0c3RhdGljIHJlYWRvbmx5IFNFTEYgICAgICAgICAgICAgICAgICAgID0gXCJPV2ViQ29tXCI7XG5cblx0cHJpdmF0ZSByZWFkb25seSBfb3B0aW9uczogdENvbU9wdGlvbnM7XG5cdHByaXZhdGUgcmVhZG9ubHkgX29yaWdpbmFsX2RhdGE6IGFueTtcblx0cHJpdmF0ZSBfbW9kaWZpZWRfZGF0YTogRm9ybURhdGEgfCBib29sZWFuO1xuXHRwcml2YXRlIF9idXN5OiBib29sZWFuID0gZmFsc2U7XG5cdHByaXZhdGUgX3JlcXVlc3Q/OiBqcVhIUjtcblxuXHRjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGFwcF9jb250ZXh0OiBPV2ViQXBwLCBvcHRpb25zOiB0Q29tT3B0aW9ucykge1xuXHRcdHN1cGVyKCk7XG5cblx0XHRpZiAob3B0aW9ucyAmJiAhVXRpbHMuaXNQbGFpbk9iamVjdChvcHRpb25zKSkge1xuXHRcdFx0dGhyb3cgbmV3IFR5cGVFcnJvcihgW09XZWJDb21dIHJlcXVpcmUgYW4gJ29iamVjdCcgYXMgb3B0aW9ucyBub3Q6ICAke3R5cGVvZiBvcHRpb25zfS5gKTtcblx0XHR9XG5cblx0XHR0aGlzLl9vcHRpb25zICAgICAgID0gVXRpbHMuYXNzaWduKHt9LCBkZWZhdWx0X29wdGlvbnMsIG9wdGlvbnMgfHwge30pO1xuXHRcdHRoaXMuX29yaWdpbmFsX2RhdGEgPSBvcHRpb25zLmRhdGEgfHwge307XG5cdFx0dGhpcy5fbW9kaWZpZWRfZGF0YSA9IHNlYXJjaEFuZFJlcGxhY2VNYXJrZWRGaWxlKG9wdGlvbnMuZGF0YSk7XG5cblx0XHRpZiAodGhpcy5fbW9kaWZpZWRfZGF0YSkge1xuXHRcdFx0dGhpcy5fb3B0aW9ucy5kYXRhID0gdGhpcy5fbW9kaWZpZWRfZGF0YTtcblx0XHR9XG5cblx0fVxuXG5cdHByaXZhdGUgX2luaXQoKSB7XG5cdFx0bGV0IG0gICAgICAgICAgICAgICAgICA9IHRoaXMsXG5cdFx0XHRyZWFsX21ldGhvZCAgICAgICAgPSBtLl9vcHRpb25zLm1ldGhvZCxcblx0XHRcdHJlcGxhY2VfbWV0aG9kcyAgICA9IFtcIlBBVENIXCIsIFwiUFVUXCIsIFwiREVMRVRFXCJdLFxuXHRcdFx0YXBpX2tleV9oZWFkZXIgICAgID0gdGhpcy5hcHBfY29udGV4dC5jb25maWdzLmdldChcIk9aX0FQSV9LRVlfSEVBREVSX05BTUVcIiksXG5cdFx0XHRyZWFsX21ldGhvZF9oZWFkZXIgPSB0aGlzLmFwcF9jb250ZXh0LmNvbmZpZ3MuZ2V0KFwiT1pfQVBJX1JFQUxfTUVUSE9EX0hFQURFUl9OQU1FXCIpO1xuXG5cdFx0bGV0IGhlYWRlcnM6IGFueSA9IHRoaXMuX29wdGlvbnMuaGVhZGVycyA9IHRoaXMuX29wdGlvbnMuaGVhZGVycyB8fCB7fTtcblx0XHRoZWFkZXJzW2FwaV9rZXlfaGVhZGVyXSA9IHRoaXMuYXBwX2NvbnRleHQuY29uZmlncy5nZXQoXCJPWl9BUElfS0VZXCIpO1xuXG5cdFx0Ly8gdXBkYXRlIHJlcXVlc3QgbWV0aG9kXG5cdFx0aWYgKH5yZXBsYWNlX21ldGhvZHMuaW5kZXhPZihyZWFsX21ldGhvZCkpIHtcblx0XHRcdGhlYWRlcnNbcmVhbF9tZXRob2RfaGVhZGVyXSA9IHJlYWxfbWV0aG9kO1xuXHRcdFx0dGhpcy5fb3B0aW9ucy5tZXRob2QgICAgICAgID0gXCJQT1NUXCI7XG5cdFx0fVxuXG5cdFx0aWYgKHRoaXMuX29wdGlvbnMuZGF0YSBpbnN0YW5jZW9mIEZvcm1EYXRhKSB7XG5cdFx0XHR0aGlzLl9vcHRpb25zLnByb2Nlc3NEYXRhID0gZmFsc2U7XG5cdFx0XHR0aGlzLl9vcHRpb25zLmNvbnRlbnRUeXBlID0gZmFsc2U7XG5cdFx0fVxuXG5cdFx0Ly8gd29ya2Fyb3VuZCBiZWNhdXNlIGpxWEhSIGRvZXMgbm90IGV4cG9zZSB1cGxvYWQgcHJvcGVydHlcblx0XHR0aGlzLl9vcHRpb25zLnhociA9IGZ1bmN0aW9uICgpIHtcblx0XHRcdGxldCB4aHIgPSAkLmFqYXhTZXR0aW5ncy54aHIhKCk7XG5cblx0XHRcdC8vIGFsbG93IENPUlNcblx0XHRcdHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlO1xuXG5cdFx0XHRpZiAoeGhyLnVwbG9hZCkge1xuXHRcdFx0XHR4aHIudXBsb2FkLmFkZEV2ZW50TGlzdGVuZXIoXCJwcm9ncmVzc1wiLCAoZTogYW55KSA9PiB7XG5cdFx0XHRcdFx0bGV0IHBlcmNlbnQgID0gMDtcblx0XHRcdFx0XHRsZXQgcG9zaXRpb24gPSBlLmxvYWRlZCB8fCBlLnBvc2l0aW9uOy8vIGUucG9zaXRpb25cblx0XHRcdFx0XHRsZXQgdG90YWwgICAgPSBlLnRvdGFsO1xuXG5cdFx0XHRcdFx0aWYgKGUubGVuZ3RoQ29tcHV0YWJsZSkge1xuXHRcdFx0XHRcdFx0cGVyY2VudCA9IE1hdGguZmxvb3IocG9zaXRpb24gLyB0b3RhbCAqIDEwMCk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0bS50cmlnZ2VyKE9XZWJDb20uRVZUX0NPTV9VUExPQURfUFJPR1JFU1MsIFtlLCBwb3NpdGlvbiwgdG90YWwsIHBlcmNlbnRdKTtcblxuXHRcdFx0XHR9LCBmYWxzZSk7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiB4aHI7XG5cdFx0fTtcblx0fVxuXG5cdC8vIHRoZSBjb25uZWN0aW9uIHRvIHRoZSBzZXJ2ZXIgd2FzIHN1Y2Nlc3NmdWxseSBlc3RhYmxpc2hlZFxuXHRwcml2YXRlIF9oYW5kbGVSZXNwb25zZShyZXNwb25zZTogaUNvbVJlc3BvbnNlKSB7XG5cdFx0bGV0IG0gPSB0aGlzO1xuXG5cdFx0aWYgKHJlc3BvbnNlLnN0aW1lKSB7XG5cdFx0XHRtLmFwcF9jb250ZXh0LnVzZXIuc2V0U2Vzc2lvbkV4cGlyZShyZXNwb25zZS5zdGltZSk7XG5cdFx0fVxuXG5cdFx0aWYgKHJlc3BvbnNlLmVycm9yID09PSAwKSB7XG5cdFx0XHRtLnRyaWdnZXIoT1dlYkNvbS5FVlRfQ09NX1JFUVVFU1RfU1VDQ0VTUywgW3Jlc3BvbnNlLCBtXSk7XG5cdFx0XHRtLnRyaWdnZXIoT1dlYkNvbS5FVlRfQ09NX0ZJTklTSCwgW3Jlc3BvbnNlLCBtXSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGlmIChyZXNwb25zZS5tc2cgPT09IFwiT1pfRVJST1JfWU9VX01VU1RfTE9HSU5cIikge1xuXHRcdFx0XHRtLmFwcF9jb250ZXh0LmZvcmNlTG9naW4oKTtcblx0XHRcdH0gZWxzZSBpZiAofmZpbGVfYWxpYXNfZXJyb3JzLmluZGV4T2YocmVzcG9uc2UubXNnKSkge1xuXHRcdFx0XHQvLyBvdXIgYXR0ZW1wdCB0byBtaW5pbWl6ZSBmaWxlIHVwbG9hZCBmYWlsZWRcblx0XHRcdFx0Y29uc29sZS53YXJuKFwiW09XZWJDb21dIHVuYWJsZSB0byBtaW5pbWl6ZSBmaWxlIHVwbG9hZCBkYXRhIC0+XCIsIHJlc3BvbnNlLCBtLl9vcHRpb25zLmRhdGEpO1xuXHRcdFx0XHR0aGlzLl9tb2RpZmllZF9kYXRhID0gZmFsc2U7XG5cdFx0XHRcdHRoaXMuX29wdGlvbnMuZGF0YSAgPSB0aGlzLl9vcmlnaW5hbF9kYXRhO1xuXHRcdFx0XHRtLl9idXN5ICAgICAgICAgICAgID0gZmFsc2U7XG5cdFx0XHRcdG0uc2VuZCgpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0aWYgKG0uX29wdGlvbnMuYmFkTmV3c1Nob3cpIHtcblx0XHRcdFx0XHRtLmFwcF9jb250ZXh0LnZpZXcuZGlhbG9nKHtcblx0XHRcdFx0XHRcdHR5cGU6IFwiZXJyb3JcIixcblx0XHRcdFx0XHRcdHRleHQ6IHJlc3BvbnNlLm1zZyxcblx0XHRcdFx0XHRcdGRhdGE6IHJlc3BvbnNlLmRhdGFcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdG0udHJpZ2dlcihPV2ViQ29tLkVWVF9DT01fUkVRVUVTVF9FUlJPUiwgW3Jlc3BvbnNlLCBtXSk7XG5cdFx0XHRcdG0udHJpZ2dlcihPV2ViQ29tLkVWVF9DT01fRklOSVNILCBbcmVzcG9uc2UsIG1dKTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRzZW5kKCkge1xuXHRcdGxldCBtID0gdGhpcztcblx0XHR0aGlzLl9pbml0KCk7XG5cblx0XHRpZiAodGhpcy5fYnVzeSkge1xuXHRcdFx0Y29uc29sZS53YXJuKFwiW09XZWJDb21dIGluc3RhbmNlIGlzIGJ1c3kgLT5cIiwgbSk7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0aWYgKHRoaXMuX29wdGlvbnMpIHtcblx0XHRcdHRoaXMuX2J1c3kgICAgPSB0cnVlO1xuXHRcdFx0dGhpcy5fcmVxdWVzdCA9ICQuYWpheChtLl9vcHRpb25zKVxuXHRcdFx0XHQuZG9uZSgocmVzcG9uc2U6IGFueSkgPT4ge1xuXHRcdFx0XHRcdG0uX2hhbmRsZVJlc3BvbnNlKHJlc3BvbnNlKTtcblx0XHRcdFx0fSlcblx0XHRcdFx0LmZhaWwoKHJlcXVlc3Q6IGFueSkgPT4ge1xuXHRcdFx0XHRcdGxldCBuZXR3b3JrX2Vycm9yID0gIVV0aWxzLmlzUGxhaW5PYmplY3QoXG5cdFx0XHRcdFx0XHRyZXF1ZXN0W1wicmVzcG9uc2VKU09OXCJdKTtcblx0XHRcdFx0XHRpZiAobmV0d29ya19lcnJvcikge1xuXHRcdFx0XHRcdFx0Y29uc29sZS5lcnJvcihcIltPV2ViQ29tXSByZXF1ZXN0IG5ldHdvcmsgZXJyb3IgLT5cIiwgcmVxdWVzdCk7XG5cdFx0XHRcdFx0XHRtLnRyaWdnZXIoT1dlYkNvbS5FVlRfQ09NX05FVFdPUktfRVJST1IsIFtyZXF1ZXN0LCBtXSk7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdGNvbnNvbGUuZXJyb3IoXCJbT1dlYkNvbV0gcmVxdWVzdCBzZXJ2ZXIgZXJyb3IgLT5cIiwgcmVxdWVzdCk7XG5cdFx0XHRcdFx0XHRtLl9oYW5kbGVSZXNwb25zZShyZXF1ZXN0W1wicmVzcG9uc2VKU09OXCJdKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXHRcdH1cblx0fVxuXG5cdGFib3J0KCkge1xuXHRcdHRoaXMuX2J1c3kgPSBmYWxzZTtcblx0XHRpZiAodGhpcy5fcmVxdWVzdCkge1xuXHRcdFx0dGhpcy5fcmVxdWVzdC5hYm9ydCgpO1xuXHRcdH1cblx0fVxufSJdfQ==