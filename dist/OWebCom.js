import OWebEvent from "./OWebEvent";
import OWebFS from "./OWebFS";
import Utils from "./utils/Utils";
const file_alias_errors = [
    "OZ_FILE_ALIAS_UNKNOWN",
    "OZ_FILE_ALIAS_NOT_FOUND",
    "OZ_FILE_ALIAS_PARSE_ERROR"
], default_options = {
    url: "",
    method: "GET",
    data: {},
    dataType: "json",
    crossDomain: true,
    badNewsShow: false,
    // increase request timeout for mobile device
    // TODO: find a good way to check if mobile device
    timeout: ("cordova" in window ? 10000 : undefined)
};
let searchAndReplaceMarkedFile = function (data) {
    let form_data = new FormData(), has_marked_file = false, check = (value, name) => {
        let v = value;
        if (OWebFS.isMarkedFile(v)) {
            v = OWebFS.createFileAlias(v);
            has_marked_file = true;
        }
        form_data.append(name, v);
    };
    if (data) {
        if (data instanceof FormData) {
            data.forEach(check);
        }
        else if (Utils.isPlainObject(data)) {
            Object.keys(data).forEach(function (key_name) {
                check(data[key_name], key_name);
            });
        }
    }
    return has_marked_file ? form_data : false;
};
export default class OWebCom extends OWebEvent {
    constructor(app_context, options) {
        super();
        this.app_context = app_context;
        this._busy = false;
        if (options && !Utils.isPlainObject(options)) {
            throw new TypeError(`[OWebCom] require an 'object' as options not:  ${typeof options}.`);
        }
        this._options = Utils.assign({}, default_options, options || {});
        this._original_data = options.data || {};
        this._modified_data = searchAndReplaceMarkedFile(options.data);
        if (this._modified_data) {
            this._options.data = this._modified_data;
        }
    }
    _init() {
        let m = this, real_method = m._options.method, replace_methods = ["PATCH", "PUT", "DELETE"], api_key_header = this.app_context.configs.get("OZ_API_KEY_HEADER_NAME"), real_method_header = this.app_context.configs.get("OZ_API_REAL_METHOD_HEADER_NAME");
        let headers = this._options.headers = this._options.headers || {};
        headers[api_key_header] = this.app_context.configs.get("OZ_API_KEY");
        // update request method
        if (~replace_methods.indexOf(real_method)) {
            headers[real_method_header] = real_method;
            this._options.method = "POST";
        }
        if (this._options.data instanceof FormData) {
            this._options.processData = false;
            this._options.contentType = false;
        }
        // workaround because jqXHR does not expose upload property
        this._options.xhr = function () {
            let xhr = $.ajaxSettings.xhr();
            // allow CORS
            xhr.withCredentials = true;
            if (xhr.upload) {
                xhr.upload.addEventListener("progress", (e) => {
                    let percent = 0;
                    let position = e.loaded || e.position; // e.position
                    let total = e.total;
                    if (e.lengthComputable) {
                        percent = Math.floor(position / total * 100);
                    }
                    m.trigger(OWebCom.EVT_COM_UPLOAD_PROGRESS, [e, position, total, percent]);
                }, false);
            }
            return xhr;
        };
    }
    // the connection to the server was successfully established
    _handleResponse(response) {
        let m = this;
        if (response.stime) {
            m.app_context.user.setSessionExpire(response.stime);
        }
        if (response.error === 0) {
            m.trigger(OWebCom.EVT_COM_REQUEST_SUCCESS, [response, m]);
            m.trigger(OWebCom.EVT_COM_FINISH, [response, m]);
        }
        else {
            if (response.msg === "OZ_ERROR_YOU_MUST_LOGIN") {
                m.trigger(OWebCom.EVT_COM_REQUEST_ERROR, [response, m]);
                m.app_context.forceLogin();
            }
            else if (~file_alias_errors.indexOf(response.msg)) {
                // our attempt to minimize file upload failed
                console.warn("[OWebCom] unable to minimize file upload data ->", response, m._options.data);
                this._modified_data = false;
                this._options.data = this._original_data;
                m._busy = false;
                m.send();
            }
            else {
                if (m._options.badNewsShow) {
                    m.app_context.view.dialog({
                        type: "error",
                        text: response.msg,
                        data: response.data
                    });
                }
                m.trigger(OWebCom.EVT_COM_REQUEST_ERROR, [response, m]);
                m.trigger(OWebCom.EVT_COM_FINISH, [response, m]);
            }
        }
    }
    send() {
        let m = this;
        this._init();
        if (this._busy) {
            console.warn("[OWebCom] instance is busy ->", m);
            return;
        }
        if (this._options) {
            this._busy = true;
            this._request = $.ajax(m._options)
                .done((response) => {
                m._handleResponse(response);
            })
                .fail((request) => {
                let network_error = !Utils.isPlainObject(request["responseJSON"]);
                if (network_error) {
                    console.error("[OWebCom] request network error ->", request);
                    m.trigger(OWebCom.EVT_COM_NETWORK_ERROR, [request, m]);
                }
                else {
                    console.error("[OWebCom] request server error ->", request);
                    m._handleResponse(request["responseJSON"]);
                }
            });
        }
    }
    abort() {
        this._busy = false;
        if (this._request) {
            this._request.abort();
        }
    }
}
OWebCom.SELF = Utils.id();
OWebCom.EVT_COM_REQUEST_SUCCESS = Utils.id();
OWebCom.EVT_COM_REQUEST_ERROR = Utils.id();
OWebCom.EVT_COM_NETWORK_ERROR = Utils.id();
OWebCom.EVT_COM_UPLOAD_PROGRESS = Utils.id();
OWebCom.EVT_COM_FINISH = Utils.id();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkNvbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViQ29tLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sU0FBUyxNQUFNLGFBQWEsQ0FBQztBQUNwQyxPQUFPLE1BQU0sTUFBTSxVQUFVLENBQUM7QUFDOUIsT0FBTyxLQUFLLE1BQU0sZUFBZSxDQUFDO0FBeUJsQyxNQUFNLGlCQUFpQixHQUFjO0lBQ2pDLHVCQUF1QjtJQUN2Qix5QkFBeUI7SUFDekIsMkJBQTJCO0NBQzNCLEVBQ0QsZUFBZSxHQUFnQjtJQUM5QixHQUFHLEVBQVUsRUFBRTtJQUNmLE1BQU0sRUFBTyxLQUFLO0lBQ2xCLElBQUksRUFBUyxFQUFFO0lBQ2YsUUFBUSxFQUFLLE1BQU07SUFDbkIsV0FBVyxFQUFFLElBQUk7SUFDakIsV0FBVyxFQUFFLEtBQUs7SUFDbEIsNkNBQTZDO0lBQzdDLGtEQUFrRDtJQUNsRCxPQUFPLEVBQU0sQ0FBQyxTQUFTLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztDQUN0RCxDQUFDO0FBRUwsSUFBSSwwQkFBMEIsR0FBRyxVQUFVLElBQXdDO0lBQ2xGLElBQUksU0FBUyxHQUFTLElBQUksUUFBUSxFQUFFLEVBQ25DLGVBQWUsR0FBRyxLQUFLLEVBQ3ZCLEtBQUssR0FBYSxDQUFDLEtBQVUsRUFBRSxJQUFZLEVBQUUsRUFBRTtRQUM5QyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUM7UUFFZCxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDM0IsQ0FBQyxHQUFpQixNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzVDLGVBQWUsR0FBRyxJQUFJLENBQUM7U0FDdkI7UUFFRCxTQUFTLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMzQixDQUFDLENBQUM7SUFFSCxJQUFJLElBQUks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QUNKLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNsQixJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQ3RCO0lBQ0YsQ0FBQzs7QUFwSmUsWUFBSSxHQUFzQixLQUFLLENBQUMsRUFBRSxFQUFFLENBQUM7QUFDckMsK0JBQXVCLEdBQUcsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQ3JDLDZCQUFxQixHQUFLLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUNyQyw2QkFBcUIsR0FBSyxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUM7QUFDckMsK0JBQXVCLEdBQUcsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQ3JDLHNCQUFjLEdBQVksS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IE9XZWJBcHAgZnJvbSBcIi4vT1dlYkFwcFwiO1xuaW1wb3J0IE9XZWJFdmVudCBmcm9tIFwiLi9PV2ViRXZlbnRcIjtcbmltcG9ydCBPV2ViRlMgZnJvbSBcIi4vT1dlYkZTXCI7XG5pbXBvcnQgVXRpbHMgZnJvbSBcIi4vdXRpbHMvVXRpbHNcIjtcbmltcG9ydCBqcVhIUiA9IEpRdWVyeS5qcVhIUjtcblxuZXhwb3J0IGludGVyZmFjZSBpQ29tUmVzcG9uc2Uge1xuXHRlcnJvcjogbnVtYmVyLFxuXHRtc2c6IHN0cmluZyxcblx0ZGF0YT86IGFueSxcblx0dXRpbWU6IG51bWJlcixcblx0c3RpbWU/OiBudW1iZXIsXG5cdG5ldGVycm9yPzogYm9vbGVhblxufVxuXG5leHBvcnQgdHlwZSB0Q29tT3B0aW9ucyA9IHtcblx0dXJsOiBzdHJpbmcsXG5cdG1ldGhvZDogc3RyaW5nLFxuXHR4aHI/OiBhbnksXG5cdGhlYWRlcnM/OiB7fSxcblx0ZGF0YT86IHt9LFxuXHRkYXRhVHlwZT86IHN0cmluZyxcblx0Y3Jvc3NEb21haW4/OiBib29sZWFuLFxuXHRwcm9jZXNzRGF0YT86IGJvb2xlYW4sXG5cdGNvbnRlbnRUeXBlPzogYW55LFxuXHRiYWROZXdzU2hvdz86IGJvb2xlYW4sXG5cdHRpbWVvdXQ/OiBudW1iZXJcbn07XG5jb25zdCBmaWxlX2FsaWFzX2Vycm9ycyAgICAgICAgICAgID0gW1xuXHRcdCAgXCJPWl9GSUxFX0FMSUFTX1VOS05PV05cIixcblx0XHQgIFwiT1pfRklMRV9BTElBU19OT1RfRk9VTkRcIixcblx0XHQgIFwiT1pfRklMRV9BTElBU19QQVJTRV9FUlJPUlwiXG5cdCAgXSxcblx0ICBkZWZhdWx0X29wdGlvbnM6IHRDb21PcHRpb25zID0ge1xuXHRcdCAgdXJsICAgICAgICA6IFwiXCIsXG5cdFx0ICBtZXRob2QgICAgIDogXCJHRVRcIixcblx0XHQgIGRhdGEgICAgICAgOiB7fSxcblx0XHQgIGRhdGFUeXBlICAgOiBcImpzb25cIixcblx0XHQgIGNyb3NzRG9tYWluOiB0cnVlLFxuXHRcdCAgYmFkTmV3c1Nob3c6IGZhbHNlLFxuXHRcdCAgLy8gaW5jcmVhc2UgcmVxdWVzdCB0aW1lb3V0IGZvciBtb2JpbGUgZGV2aWNlXG5cdFx0ICAvLyBUT0RPOiBmaW5kIGEgZ29vZCB3YXkgdG8gY2hlY2sgaWYgbW9iaWxlIGRldmljZVxuXHRcdCAgdGltZW91dCAgICA6IChcImNvcmRvdmFcIiBpbiB3aW5kb3cgPyAxMDAwMCA6IHVuZGVmaW5lZClcblx0ICB9O1xuXG5sZXQgc2VhcmNoQW5kUmVwbGFjZU1hcmtlZEZpbGUgPSBmdW5jdGlvbiAoZGF0YT86IHsgW2tleTogc3RyaW5nXTogYW55IH0gfCBGb3JtRGF0YSkge1xuXHRsZXQgZm9ybV9kYXRhICAgICAgID0gbmV3IEZvcm1EYXRhKCksXG5cdFx0aGFzX21hcmtlZF9maWxlID0gZmFsc2UsXG5cdFx0Y2hlY2sgICAgICAgICAgID0gKHZhbHVlOiBhbnksIG5hbWU6IHN0cmluZykgPT4ge1xuXHRcdFx0bGV0IHYgPSB2YWx1ZTtcblxuXHRcdFx0aWYgKE9XZWJGUy5pc01hcmtlZEZpbGUodikpIHtcblx0XHRcdFx0diAgICAgICAgICAgICAgID0gT1dlYkZTLmNyZWF0ZUZpbGVBbGlhcyh2KTtcblx0XHRcdFx0aGFzX21hcmtlZF9maWxlID0gdHJ1ZTtcblx0XHRcdH1cblxuXHRcdFx0Zm9ybV9kYXRhLmFwcGVuZChuYW1lLCB2KTtcblx0XHR9O1xuXG5cdGlmIChkYXRhKSB7XG5cdFx0aWYgKGRhdGEgaW5zdGFuY2VvZiBGb3JtRGF0YSkge1xuXHRcdFx0KGRhdGEgYXMgYW55KS5mb3JFYWNoKGNoZWNrKTtcblx0XHR9IGVsc2UgaWYgKFV0aWxzLmlzUGxhaW5PYmplY3QoZGF0YSkpIHtcblx0XHRcdE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2goZnVuY3Rpb24gKGtleV9uYW1lKSB7XG5cdFx0XHRcdGNoZWNrKGRhdGFba2V5X25hbWVdLCBrZXlfbmFtZSk7XG5cdFx0XHR9KTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gaGFzX21hcmtlZF9maWxlID8gZm9ybV9kYXRhIDogZmFsc2U7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViQ29tIGV4dGVuZHMgT1dlYkV2ZW50IHtcblxuXHRzdGF0aWMgcmVhZG9ubHkgU0VMRiAgICAgICAgICAgICAgICAgICAgPSBVdGlscy5pZCgpO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9SRVFVRVNUX1NVQ0NFU1MgPSBVdGlscy5pZCgpO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9SRVFVRVNUX0VSUk9SICAgPSBVdGlscy5pZCgpO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9ORVRXT1JLX0VSUk9SICAgPSBVdGlscy5pZCgpO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9VUExPQURfUFJPR1JFU1MgPSBVdGlscy5pZCgpO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9GSU5JU0ggICAgICAgICAgPSBVdGlscy5pZCgpO1xuXG5cdHByaXZhdGUgcmVhZG9ubHkgX29wdGlvbnM6IHRDb21PcHRpb25zO1xuXHRwcml2YXRlIHJlYWRvbmx5IF9vcmlnaW5hbF9kYXRhOiBhbnk7XG5cdHByaXZhdGUgX21vZGlmaWVkX2RhdGE6IEZvcm1EYXRhIHwgYm9vbGVhbjtcblx0cHJpdmF0ZSBfYnVzeTogYm9vbGVhbiA9IGZhbHNlO1xuXHRwcml2YXRlIF9yZXF1ZXN0PzoganFYSFI7XG5cblx0Y29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhcHBfY29udGV4dDogT1dlYkFwcCwgb3B0aW9uczogdENvbU9wdGlvbnMpIHtcblx0XHRzdXBlcigpO1xuXG5cdFx0aWYgKG9wdGlvbnMgJiYgIVV0aWxzLmlzUGxhaW5PYmplY3Qob3B0aW9ucykpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoYFtPV2ViQ29tXSByZXF1aXJlIGFuICdvYmplY3QnIGFzIG9wdGlvbnMgbm90OiAgJHt0eXBlb2Ygb3B0aW9uc30uYCk7XG5cdFx0fVxuXG5cdFx0dGhpcy5fb3B0aW9ucyAgICAgICA9IFV0aWxzLmFzc2lnbih7fSwgZGVmYXVsdF9vcHRpb25zLCBvcHRpb25zIHx8IHt9KTtcblx0XHR0aGlzLl9vcmlnaW5hbF9kYXRhID0gb3B0aW9ucy5kYXRhIHx8IHt9O1xuXHRcdHRoaXMuX21vZGlmaWVkX2RhdGEgPSBzZWFyY2hBbmRSZXBsYWNlTWFya2VkRmlsZShvcHRpb25zLmRhdGEpO1xuXG5cdFx0aWYgKHRoaXMuX21vZGlmaWVkX2RhdGEpIHtcblx0XHRcdHRoaXMuX29wdGlvbnMuZGF0YSA9IHRoaXMuX21vZGlmaWVkX2RhdGE7XG5cdFx0fVxuXG5cdH1cblxuXHRwcml2YXRlIF9pbml0KCkge1xuXHRcdGxldCBtICAgICAgICAgICAgICAgICAgPSB0aGlzLFxuXHRcdFx0cmVhbF9tZXRob2QgICAgICAgID0gbS5fb3B0aW9ucy5tZXRob2QsXG5cdFx0XHRyZXBsYWNlX21ldGhvZHMgICAgPSBbXCJQQVRDSFwiLCBcIlBVVFwiLCBcIkRFTEVURVwiXSxcblx0XHRcdGFwaV9rZXlfaGVhZGVyICAgICA9IHRoaXMuYXBwX2NvbnRleHQuY29uZmlncy5nZXQoXCJPWl9BUElfS0VZX0hFQURFUl9OQU1FXCIpLFxuXHRcdFx0cmVhbF9tZXRob2RfaGVhZGVyID0gdGhpcy5hcHBfY29udGV4dC5jb25maWdzLmdldChcIk9aX0FQSV9SRUFMX01FVEhPRF9IRUFERVJfTkFNRVwiKTtcblxuXHRcdGxldCBoZWFkZXJzOiBhbnkgICAgICAgID0gdGhpcy5fb3B0aW9ucy5oZWFkZXJzID0gdGhpcy5fb3B0aW9ucy5oZWFkZXJzIHx8IHt9O1xuXHRcdGhlYWRlcnNbYXBpX2tleV9oZWFkZXJdID0gdGhpcy5hcHBfY29udGV4dC5jb25maWdzLmdldChcIk9aX0FQSV9LRVlcIik7XG5cblx0XHQvLyB1cGRhdGUgcmVxdWVzdCBtZXRob2Rcblx0XHRpZiAofnJlcGxhY2VfbWV0aG9kcy5pbmRleE9mKHJlYWxfbWV0aG9kKSkge1xuXHRcdFx0aGVhZGVyc1tyZWFsX21ldGhvZF9oZWFkZXJdID0gcmVhbF9tZXRob2Q7XG5cdFx0XHR0aGlzLl9vcHRpb25zLm1ldGhvZCAgICAgICAgPSBcIlBPU1RcIjtcblx0XHR9XG5cblx0XHRpZiAodGhpcy5fb3B0aW9ucy5kYXRhIGluc3RhbmNlb2YgRm9ybURhdGEpIHtcblx0XHRcdHRoaXMuX29wdGlvbnMucHJvY2Vzc0RhdGEgPSBmYWxzZTtcblx0XHRcdHRoaXMuX29wdGlvbnMuY29udGVudFR5cGUgPSBmYWxzZTtcblx0XHR9XG5cblx0XHQvLyB3b3JrYXJvdW5kIGJlY2F1c2UganFYSFIgZG9lcyBub3QgZXhwb3NlIHVwbG9hZCBwcm9wZXJ0eVxuXHRcdHRoaXMuX29wdGlvbnMueGhyID0gZnVuY3Rpb24gKCkge1xuXHRcdFx0bGV0IHhociA9ICQuYWpheFNldHRpbmdzLnhociEoKTtcblxuXHRcdFx0Ly8gYWxsb3cgQ09SU1xuXHRcdFx0eGhyLndpdGhDcmVkZW50aWFscyA9IHRydWU7XG5cblx0XHRcdGlmICh4aHIudXBsb2FkKSB7XG5cdFx0XHRcdHhoci51cGxvYWQuYWRkRXZlbnRMaXN0ZW5lcihcInByb2dyZXNzXCIsIChlOiBhbnkpID0+IHtcblx0XHRcdFx0XHRsZXQgcGVyY2VudCAgPSAwO1xuXHRcdFx0XHRcdGxldCBwb3NpdGlvbiA9IGUubG9hZGVkIHx8IGUucG9zaXRpb247Ly8gZS5wb3NpdGlvblxuXHRcdFx0XHRcdGxldCB0b3RhbCAgICA9IGUudG90YWw7XG5cblx0XHRcdFx0XHRpZiAoZS5sZW5ndGhDb21wdXRhYmxlKSB7XG5cdFx0XHRcdFx0XHRwZXJjZW50ID0gTWF0aC5mbG9vcihwb3NpdGlvbiAvIHRvdGFsICogMTAwKTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRtLnRyaWdnZXIoT1dlYkNvbS5FVlRfQ09NX1VQTE9BRF9QUk9HUkVTUywgW2UsIHBvc2l0aW9uLCB0b3RhbCwgcGVyY2VudF0pO1xuXG5cdFx0XHRcdH0sIGZhbHNlKTtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIHhocjtcblx0XHR9O1xuXHR9XG5cblx0Ly8gdGhlIGNvbm5lY3Rpb24gdG8gdGhlIHNlcnZlciB3YXMgc3VjY2Vzc2Z1bGx5IGVzdGFibGlzaGVkXG5cdHByaXZhdGUgX2hhbmRsZVJlc3BvbnNlKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpIHtcblx0XHRsZXQgbSA9IHRoaXM7XG5cblx0XHRpZiAocmVzcG9uc2Uuc3RpbWUpIHtcblx0XHRcdG0uYXBwX2NvbnRleHQudXNlci5zZXRTZXNzaW9uRXhwaXJlKHJlc3BvbnNlLnN0aW1lKTtcblx0XHR9XG5cblx0XHRpZiAocmVzcG9uc2UuZXJyb3IgPT09IDApIHtcblx0XHRcdG0udHJpZ2dlcihPV2ViQ29tLkVWVF9DT01fUkVRVUVTVF9TVUNDRVNTLCBbcmVzcG9uc2UsIG1dKTtcblx0XHRcdG0udHJpZ2dlcihPV2ViQ29tLkVWVF9DT01fRklOSVNILCBbcmVzcG9uc2UsIG1dKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0aWYgKHJlc3BvbnNlLm1zZyA9PT0gXCJPWl9FUlJPUl9ZT1VfTVVTVF9MT0dJTlwiKSB7XG5cdFx0XHRcdG0udHJpZ2dlcihPV2ViQ29tLkVWVF9DT01fUkVRVUVTVF9FUlJPUiwgW3Jlc3BvbnNlLCBtXSk7XG5cdFx0XHRcdG0uYXBwX2NvbnRleHQuZm9yY2VMb2dpbigpO1xuXHRcdFx0fSBlbHNlIGlmICh+ZmlsZV9hbGlhc19lcnJvcnMuaW5kZXhPZihyZXNwb25zZS5tc2cpKSB7XG5cdFx0XHRcdC8vIG91ciBhdHRlbXB0IHRvIG1pbmltaXplIGZpbGUgdXBsb2FkIGZhaWxlZFxuXHRcdFx0XHRjb25zb2xlLndhcm4oXCJbT1dlYkNvbV0gdW5hYmxlIHRvIG1pbmltaXplIGZpbGUgdXBsb2FkIGRhdGEgLT5cIiwgcmVzcG9uc2UsIG0uX29wdGlvbnMuZGF0YSk7XG5cdFx0XHRcdHRoaXMuX21vZGlmaWVkX2RhdGEgPSBmYWxzZTtcblx0XHRcdFx0dGhpcy5fb3B0aW9ucy5kYXRhICA9IHRoaXMuX29yaWdpbmFsX2RhdGE7XG5cdFx0XHRcdG0uX2J1c3kgICAgICAgICAgICAgPSBmYWxzZTtcblx0XHRcdFx0bS5zZW5kKCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRpZiAobS5fb3B0aW9ucy5iYWROZXdzU2hvdykge1xuXHRcdFx0XHRcdG0uYXBwX2NvbnRleHQudmlldy5kaWFsb2coe1xuXHRcdFx0XHRcdFx0dHlwZTogXCJlcnJvclwiLFxuXHRcdFx0XHRcdFx0dGV4dDogcmVzcG9uc2UubXNnLFxuXHRcdFx0XHRcdFx0ZGF0YTogcmVzcG9uc2UuZGF0YVxuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0bS50cmlnZ2VyKE9XZWJDb20uRVZUX0NPTV9SRVFVRVNUX0VSUk9SLCBbcmVzcG9uc2UsIG1dKTtcblx0XHRcdFx0bS50cmlnZ2VyKE9XZWJDb20uRVZUX0NPTV9GSU5JU0gsIFtyZXNwb25zZSwgbV0pO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdHNlbmQoKSB7XG5cdFx0bGV0IG0gPSB0aGlzO1xuXHRcdHRoaXMuX2luaXQoKTtcblxuXHRcdGlmICh0aGlzLl9idXN5KSB7XG5cdFx0XHRjb25zb2xlLndhcm4oXCJbT1dlYkNvbV0gaW5zdGFuY2UgaXMgYnVzeSAtPlwiLCBtKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRpZiAodGhpcy5fb3B0aW9ucykge1xuXHRcdFx0dGhpcy5fYnVzeSAgICA9IHRydWU7XG5cdFx0XHR0aGlzLl9yZXF1ZXN0ID0gJC5hamF4KG0uX29wdGlvbnMpXG5cdFx0XHRcdC5kb25lKChyZXNwb25zZTogYW55KSA9PiB7XG5cdFx0XHRcdFx0bS5faGFuZGxlUmVzcG9uc2UocmVzcG9uc2UpO1xuXHRcdFx0XHR9KVxuXHRcdFx0XHQuZmFpbCgocmVxdWVzdDogYW55KSA9PiB7XG5cdFx0XHRcdFx0bGV0IG5ldHdvcmtfZXJyb3IgPSAhVXRpbHMuaXNQbGFpbk9iamVjdChcblx0XHRcdFx0XHRcdHJlcXVlc3RbXCJyZXNwb25zZUpTT05cIl0pO1xuXHRcdFx0XHRcdGlmIChuZXR3b3JrX2Vycm9yKSB7XG5cdFx0XHRcdFx0XHRjb25zb2xlLmVycm9yKFwiW09XZWJDb21dIHJlcXVlc3QgbmV0d29yayBlcnJvciAtPlwiLCByZXF1ZXN0KTtcblx0XHRcdFx0XHRcdG0udHJpZ2dlcihPV2ViQ29tLkVWVF9DT01fTkVUV09SS19FUlJPUiwgW3JlcXVlc3QsIG1dKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0Y29uc29sZS5lcnJvcihcIltPV2ViQ29tXSByZXF1ZXN0IHNlcnZlciBlcnJvciAtPlwiLCByZXF1ZXN0KTtcblx0XHRcdFx0XHRcdG0uX2hhbmRsZVJlc3BvbnNlKHJlcXVlc3RbXCJyZXNwb25zZUpTT05cIl0pO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSk7XG5cdFx0fVxuXHR9XG5cblx0YWJvcnQoKSB7XG5cdFx0dGhpcy5fYnVzeSA9IGZhbHNlO1xuXHRcdGlmICh0aGlzLl9yZXF1ZXN0KSB7XG5cdFx0XHR0aGlzLl9yZXF1ZXN0LmFib3J0KCk7XG5cdFx0fVxuXHR9XG59Il19