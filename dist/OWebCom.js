import OWebEvent from './OWebEvent';
import OWebFS from './OWebFS';
import { assign, id, isPlainObject } from './utils/Utils';
const fileAliasErrors = [
    'OZ_FILE_ALIAS_UNKNOWN',
    'OZ_FILE_ALIAS_NOT_FOUND',
    'OZ_FILE_ALIAS_PARSE_ERROR',
];
const searchAndReplaceMarkedFile = function (data) {
    let hasMarkedFile = false;
    const formData = new FormData(), check = (value, name) => {
        let v = value;
        if (OWebFS.isMarkedFile(v)) {
            v = OWebFS.createFileAlias(v);
            hasMarkedFile = true;
        }
        formData.append(name, v);
    };
    if (data) {
        if (data instanceof FormData) {
            data.forEach(check);
        }
        else if (isPlainObject(data)) {
            Object.keys(data).forEach(function (keyName) {
                check(data[keyName], keyName);
            });
        }
    }
    return hasMarkedFile ? formData : false;
};
const ajaxTransport = {
    // FOR GOBL JSON HELPER: WE DO NOT TRUST JQUERY JSON.parse
    converters: {
        'text json'(a) {
            return JSON.parse(a);
        },
    },
};
export default class OWebCom extends OWebEvent {
    constructor(appContext, options) {
        super();
        this.appContext = appContext;
        this._busy = false;
        this._aborted = false;
        if (options && !isPlainObject(options)) {
            throw new TypeError(`[OWebCom] require an 'object' as options not:  ${typeof options}.`);
        }
        const appOptions = this.appContext.getRequestDefaultOptions();
        this._options = {
            method: 'GET',
            dataType: 'json',
            data: {},
            crossDomain: true,
            badNewsShow: false,
            // increase request timeout for mobile device
            timeout: appContext.isMobileApp() ? 10000 : undefined,
            ...appOptions,
            ...options,
        };
        this._options.headers = assign({}, appOptions.headers, options.headers || {});
        this._originalData = options.data || {};
        this._modifiedData = searchAndReplaceMarkedFile(options.data);
        if (this._modifiedData) {
            this._options.data = this._modifiedData;
        }
    }
    /**
     * Prepare the request before sending.
     *
     * @private
     */
    _prepare() {
        const m = this, realMethod = m._options.method, replaceMethods = ['PATCH', 'PUT', 'DELETE'], realMethodHeader = this.appContext.configs.get('OZ_API_REAL_METHOD_HEADER_NAME'), headers = this._options.headers;
        this._aborted = false;
        // we update request method
        if (~replaceMethods.indexOf(realMethod)) {
            headers[realMethodHeader] = realMethod;
            this._options.method = 'POST';
        }
        if (this._options.data instanceof FormData) {
            this._options.processData = false;
            this._options.contentType = false;
        }
        // workaround because jqXHR does not expose upload property
        this._options.xhr = function () {
            const xhr = $.ajaxSetup(ajaxTransport).xhr();
            // allow CORS
            xhr.withCredentials = true;
            xhr.addEventListener('abort', function () {
                m._aborted = true;
            });
            if (xhr.upload) {
                xhr.upload.addEventListener('progress', (e) => {
                    let percent = 0;
                    const position = e.loaded || e.position; // e.position
                    const total = e.total;
                    if (e.lengthComputable) {
                        percent = Math.floor((position / total) * 100);
                    }
                    m.trigger(OWebCom.EVT_COM_UPLOAD_PROGRESS, [
                        e,
                        position,
                        total,
                        percent,
                    ]);
                }, false);
            }
            return xhr;
        };
    }
    /**
     * Handle server response.
     *
     * > Called only when the connection to the server was successfully established.
     *
     * @param response The server response.
     * @private
     */
    _handleResponse(response) {
        const m = this;
        if (response.stime) {
            m.appContext.user.setSessionExpire(response.stime);
        }
        if (response.stoken) {
            m.appContext.setSessionToken(response.stoken);
        }
        if (response.error === 0) {
            m.trigger(OWebCom.EVT_COM_REQUEST_SUCCESS, [response, m]);
            m.trigger(OWebCom.EVT_COM_FINISH, [response, m]);
        }
        else {
            if (response.msg === 'OZ_ERROR_YOU_MUST_LOGIN') {
                m.trigger(OWebCom.EVT_COM_REQUEST_ERROR, [response, m]);
                m.appContext.forceLogin();
            }
            else if (~fileAliasErrors.indexOf(response.msg)) {
                // our attempt to minimize file upload failed
                console.warn('[OWebCom] unable to minimize file upload data ->', response, m._options.data);
                this._modifiedData = false;
                this._options.data = this._originalData;
                m._busy = false;
                m.send();
            }
            else {
                if (m._options.badNewsShow) {
                    m.appContext.view.dialog({
                        type: 'error',
                        text: response.msg,
                        data: response.data,
                    });
                }
                m.trigger(OWebCom.EVT_COM_REQUEST_ERROR, [response, m]);
                m.trigger(OWebCom.EVT_COM_FINISH, [response, m]);
            }
        }
    }
    /**
     * Send request.
     */
    send() {
        const m = this;
        this._prepare();
        if (this._busy) {
            console.warn('[OWebCom] instance is busy ->', m);
            return;
        }
        if (this._options) {
            this._busy = true;
            this._request = $.ajax(m._options)
                .done((response) => {
                m._handleResponse(response);
            })
                .fail((request) => {
                const networkError = !isPlainObject(request.responseJSON);
                if (networkError) {
                    console.error('[OWebCom] request network error ->', request);
                    m.trigger(OWebCom.EVT_COM_NETWORK_ERROR, [request, m]);
                }
                else {
                    console.error('[OWebCom] request server error ->', request);
                    m._handleResponse(request.responseJSON);
                }
            });
        }
    }
    /**
     * Checks if the current request has been aborted.
     */
    isAborted() {
        return this._aborted;
    }
    /**
     * Try to abort the current request.
     */
    abort() {
        this._busy = false;
        if (this._request) {
            this._request.abort();
        }
    }
}
OWebCom.SELF = id();
OWebCom.EVT_COM_REQUEST_SUCCESS = id();
OWebCom.EVT_COM_REQUEST_ERROR = id();
OWebCom.EVT_COM_NETWORK_ERROR = id();
OWebCom.EVT_COM_UPLOAD_PROGRESS = id();
OWebCom.EVT_COM_FINISH = id();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkNvbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViQ29tLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sU0FBUyxNQUFNLGFBQWEsQ0FBQztBQUNwQyxPQUFPLE1BQU0sTUFBTSxVQUFVLENBQUM7QUFFOUIsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsYUFBYSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBeUIxRCxNQUFNLGVBQWUsR0FBRztJQUN2Qix1QkFBdUI7SUFDdkIseUJBQXlCO0lBQ3pCLDJCQUEyQjtDQUMzQixDQUFDO0FBRUYsTUFBTSwwQkFBMEIsR0FBRyxVQUNsQyxJQUF3QztJQUV4QyxJQUFJLGFBQWEsR0FBRyxLQUFLLENBQUM7SUFDMUIsTUFBTSxRQUFRLEdBQUcsSUFBSSxRQUFRLEVBQUUsRUFDOUIsS0FBSyxHQUFHLENBQUMsS0FBVSxFQUFFLElBQVksRUFBRSxFQUFFO1FBQ3BDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUVkLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUMzQixDQUFDLEdBQUcsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM5QixhQUFhLEdBQUcsSUFBSSxDQUFDO1NBQ3JCO1FBRUQsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDMUIsQ0FBQyxDQUFDO0lBRUgsSUFBSSxJQUFJLEVBQUU7UUFDVCxJQUFJLElBQUksWUFBWSxRQUFRLEVBQUU7WUFDNUIsSUFBWSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUM3QjthQUFNLElBQUksYUFBYSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQy9CLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsT0FBTztnQkFDMUMsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMs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O2dCQUMxRCxJQUFJLFlBQVksRUFBRTtvQkFDakIsT0FBTyxDQUFDLEtBQUssQ0FDWixvQ0FBb0MsRUFDcEMsT0FBTyxDQUNQLENBQUM7b0JBQ0YsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMscUJBQXFCLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDdkQ7cUJBQU07b0JBQ04sT0FBTyxDQUFDLEtBQUssQ0FDWixtQ0FBbUMsRUFDbkMsT0FBTyxDQUNQLENBQUM7b0JBQ0YsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7aUJBQ3hDO1lBQ0YsQ0FBQyxDQUFDLENBQUM7U0FDSjtJQUNGLENBQUM7SUFFRDs7T0FFRztJQUNILFNBQVM7UUFDUixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDdEIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSztRQUNKLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNsQixJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQ3RCO0lBQ0YsQ0FBQzs7QUE3TmUsWUFBSSxHQUFHLEVBQUUsRUFBRSxDQUFDO0FBQ1osK0JBQXVCLEdBQUcsRUFBRSxFQUFFLENBQUM7QUFDL0IsNkJBQXFCLEdBQUcsRUFBRSxFQUFFLENBQUM7QUFDN0IsNkJBQXFCLEdBQUcsRUFBRSxFQUFFLENBQUM7QUFDN0IsK0JBQXVCLEdBQUcsRUFBRSxFQUFFLENBQUM7QUFDL0Isc0JBQWMsR0FBRyxFQUFFLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBPV2ViQXBwIGZyb20gJy4vT1dlYkFwcCc7XG5pbXBvcnQgT1dlYkV2ZW50IGZyb20gJy4vT1dlYkV2ZW50JztcbmltcG9ydCBPV2ViRlMgZnJvbSAnLi9PV2ViRlMnO1xuaW1wb3J0IGpxWEhSID0gSlF1ZXJ5LmpxWEhSO1xuaW1wb3J0IHsgYXNzaWduLCBpZCwgaXNQbGFpbk9iamVjdCB9IGZyb20gJy4vdXRpbHMvVXRpbHMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIElDb21SZXNwb25zZSB7XG5cdGVycm9yOiBudW1iZXI7XG5cdG1zZzogc3RyaW5nO1xuXHRkYXRhPzogYW55O1xuXHR1dGltZTogbnVtYmVyOyAvLyByZXNwb25zZSB0aW1lXG5cdHN0aW1lPzogbnVtYmVyOyAvLyBzZXNzaW9uIGV4cGlyZSB0aW1lXG5cdHN0b2tlbj86IHN0cmluZzsgLy8gc2Vzc2lvbiB0b2tlblxuXHRuZXRlcnJvcj86IGJvb2xlYW47XG59XG5cbmV4cG9ydCB0eXBlIHRDb21PcHRpb25zID0ge1xuXHR1cmw6IHN0cmluZztcblx0bWV0aG9kOiBzdHJpbmc7XG5cdHhocj86IGFueTtcblx0aGVhZGVycz86IHt9O1xuXHRkYXRhPzoge307XG5cdGRhdGFUeXBlPzogc3RyaW5nO1xuXHRjcm9zc0RvbWFpbj86IGJvb2xlYW47XG5cdHByb2Nlc3NEYXRhPzogYm9vbGVhbjtcblx0Y29udGVudFR5cGU/OiBhbnk7XG5cdGJhZE5ld3NTaG93PzogYm9vbGVhbjtcblx0dGltZW91dD86IG51bWJlcjtcbn07XG5jb25zdCBmaWxlQWxpYXNFcnJvcnMgPSBbXG5cdCdPWl9GSUxFX0FMSUFTX1VOS05PV04nLFxuXHQnT1pfRklMRV9BTElBU19OT1RfRk9VTkQnLFxuXHQnT1pfRklMRV9BTElBU19QQVJTRV9FUlJPUicsXG5dO1xuXG5jb25zdCBzZWFyY2hBbmRSZXBsYWNlTWFya2VkRmlsZSA9IGZ1bmN0aW9uIChcblx0ZGF0YT86IHsgW2tleTogc3RyaW5nXTogYW55IH0gfCBGb3JtRGF0YSxcbikge1xuXHRsZXQgaGFzTWFya2VkRmlsZSA9IGZhbHNlO1xuXHRjb25zdCBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpLFxuXHRcdGNoZWNrID0gKHZhbHVlOiBhbnksIG5hbWU6IHN0cmluZykgPT4ge1xuXHRcdFx0bGV0IHYgPSB2YWx1ZTtcblxuXHRcdFx0aWYgKE9XZWJGUy5pc01hcmtlZEZpbGUodikpIHtcblx0XHRcdFx0diA9IE9XZWJGUy5jcmVhdGVGaWxlQWxpYXModik7XG5cdFx0XHRcdGhhc01hcmtlZEZpbGUgPSB0cnVlO1xuXHRcdFx0fVxuXG5cdFx0XHRmb3JtRGF0YS5hcHBlbmQobmFtZSwgdik7XG5cdFx0fTtcblxuXHRpZiAoZGF0YSkge1xuXHRcdGlmIChkYXRhIGluc3RhbmNlb2YgRm9ybURhdGEpIHtcblx0XHRcdChkYXRhIGFzIGFueSkuZm9yRWFjaChjaGVjayk7XG5cdFx0fSBlbHNlIGlmIChpc1BsYWluT2JqZWN0KGRhdGEpKSB7XG5cdFx0XHRPYmplY3Qua2V5cyhkYXRhKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXlOYW1lKSB7XG5cdFx0XHRcdGNoZWNrKGRhdGFba2V5TmFtZV0sIGtleU5hbWUpO1xuXHRcdFx0fSk7XG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIGhhc01hcmtlZEZpbGUgPyBmb3JtRGF0YSA6IGZhbHNlO1xufTtcblxuY29uc3QgYWpheFRyYW5zcG9ydCA9IHtcblx0Ly8gRk9SIEdPQkwgSlNPTiBIRUxQRVI6IFdFIERPIE5PVCBUUlVTVCBKUVVFUlkgSlNPTi5wYXJzZVxuXHRjb252ZXJ0ZXJzOiB7XG5cdFx0J3RleHQganNvbicoYTogc3RyaW5nKSB7XG5cdFx0XHRyZXR1cm4gSlNPTi5wYXJzZShhKTtcblx0XHR9LFxuXHR9LFxufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT1dlYkNvbSBleHRlbmRzIE9XZWJFdmVudCB7XG5cdHN0YXRpYyByZWFkb25seSBTRUxGID0gaWQoKTtcblx0c3RhdGljIHJlYWRvbmx5IEVWVF9DT01fUkVRVUVTVF9TVUNDRVNTID0gaWQoKTtcblx0c3RhdGljIHJlYWRvbmx5IEVWVF9DT01fUkVRVUVTVF9FUlJPUiA9IGlkKCk7XG5cdHN0YXRpYyByZWFkb25seSBFVlRfQ09NX05FVFdPUktfRVJST1IgPSBpZCgpO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9VUExPQURfUFJPR1JFU1MgPSBpZCgpO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9GSU5JU0ggPSBpZCgpO1xuXG5cdHByaXZhdGUgcmVhZG9ubHkgX29wdGlvbnM6IHRDb21PcHRpb25zO1xuXHRwcml2YXRlIHJlYWRvbmx5IF9vcmlnaW5hbERhdGE6IGFueTtcblx0cHJpdmF0ZSBfbW9kaWZpZWREYXRhOiBGb3JtRGF0YSB8IGJvb2xlYW47XG5cdHByaXZhdGUgX2J1c3k6IGJvb2xlYW4gPSBmYWxzZTtcblx0cHJpdmF0ZSBfcmVxdWVzdD86IGpxWEhSO1xuXHRwcml2YXRlIF9hYm9ydGVkID0gZmFsc2U7XG5cblx0Y29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhcHBDb250ZXh0OiBPV2ViQXBwLCBvcHRpb25zOiB0Q29tT3B0aW9ucykge1xuXHRcdHN1cGVyKCk7XG5cblx0XHRpZiAob3B0aW9ucyAmJiAhaXNQbGFpbk9iamVjdChvcHRpb25zKSkge1xuXHRcdFx0dGhyb3cgbmV3IFR5cGVFcnJvcihcblx0XHRcdFx0YFtPV2ViQ29tXSByZXF1aXJlIGFuICdvYmplY3QnIGFzIG9wdGlvbnMgbm90OiAgJHt0eXBlb2Ygb3B0aW9uc30uYCxcblx0XHRcdCk7XG5cdFx0fVxuXG5cdFx0Y29uc3QgYXBwT3B0aW9ucyA9IHRoaXMuYXBwQ29udGV4dC5nZXRSZXF1ZXN0RGVmYXVsdE9wdGlvbnMoKTtcblxuXHRcdHRoaXMuX29wdGlvbnMgPSB7XG5cdFx0XHRtZXRob2Q6ICdHRVQnLFxuXHRcdFx0ZGF0YVR5cGU6ICdqc29uJyxcblx0XHRcdGRhdGE6IHt9LFxuXHRcdFx0Y3Jvc3NEb21haW46IHRydWUsXG5cdFx0XHRiYWROZXdzU2hvdzogZmFsc2UsXG5cdFx0XHQvLyBpbmNyZWFzZSByZXF1ZXN0IHRpbWVvdXQgZm9yIG1vYmlsZSBkZXZpY2Vcblx0XHRcdHRpbWVvdXQ6IGFwcENvbnRleHQuaXNNb2JpbGVBcHAoKSA/IDEwMDAwIDogdW5kZWZpbmVkLFxuXG5cdFx0XHQuLi5hcHBPcHRpb25zLFxuXG5cdFx0XHQuLi5vcHRpb25zLFxuXHRcdH07XG5cblx0XHR0aGlzLl9vcHRpb25zLmhlYWRlcnMgPSBhc3NpZ24oXG5cdFx0XHR7fSxcblx0XHRcdGFwcE9wdGlvbnMuaGVhZGVycyxcblx0XHRcdG9wdGlvbnMuaGVhZGVycyB8fCB7fSxcblx0XHQpO1xuXG5cdFx0dGhpcy5fb3JpZ2luYWxEYXRhID0gb3B0aW9ucy5kYXRhIHx8IHt9O1xuXHRcdHRoaXMuX21vZGlmaWVkRGF0YSA9IHNlYXJjaEFuZFJlcGxhY2VNYXJrZWRGaWxlKG9wdGlvbnMuZGF0YSk7XG5cblx0XHRpZiAodGhpcy5fbW9kaWZpZWREYXRhKSB7XG5cdFx0XHR0aGlzLl9vcHRpb25zLmRhdGEgPSB0aGlzLl9tb2RpZmllZERhdGE7XG5cdFx0fVxuXHR9XG5cblx0LyoqXG5cdCAqIFByZXBhcmUgdGhlIHJlcXVlc3QgYmVmb3JlIHNlbmRpbmcuXG5cdCAqXG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIF9wcmVwYXJlKCkge1xuXHRcdGNvbnN0IG0gPSB0aGlzLFxuXHRcdFx0cmVhbE1ldGhvZCA9IG0uX29wdGlvbnMubWV0aG9kLFxuXHRcdFx0cmVwbGFjZU1ldGhvZHMgPSBbJ1BBVENIJywgJ1BVVCcsICdERUxFVEUnXSxcblx0XHRcdHJlYWxNZXRob2RIZWFkZXIgPSB0aGlzLmFwcENvbnRleHQuY29uZmlncy5nZXQoXG5cdFx0XHRcdCdPWl9BUElfUkVBTF9NRVRIT0RfSEVBREVSX05BTUUnLFxuXHRcdFx0KSxcblx0XHRcdGhlYWRlcnM6IGFueSA9IHRoaXMuX29wdGlvbnMuaGVhZGVycztcblxuXHRcdHRoaXMuX2Fib3J0ZWQgPSBmYWxzZTtcblxuXHRcdC8vIHdlIHVwZGF0ZSByZXF1ZXN0IG1ldGhvZFxuXHRcdGlmICh+cmVwbGFjZU1ldGhvZHMuaW5kZXhPZihyZWFsTWV0aG9kKSkge1xuXHRcdFx0aGVhZGVyc1tyZWFsTWV0aG9kSGVhZGVyXSA9IHJlYWxNZXRob2Q7XG5cdFx0XHR0aGlzLl9vcHRpb25zLm1ldGhvZCA9ICdQT1NUJztcblx0XHR9XG5cblx0XHRpZiAodGhpcy5fb3B0aW9ucy5kYXRhIGluc3RhbmNlb2YgRm9ybURhdGEpIHtcblx0XHRcdHRoaXMuX29wdGlvbnMucHJvY2Vzc0RhdGEgPSBmYWxzZTtcblx0XHRcdHRoaXMuX29wdGlvbnMuY29udGVudFR5cGUgPSBmYWxzZTtcblx0XHR9XG5cblx0XHQvLyB3b3JrYXJvdW5kIGJlY2F1c2UganFYSFIgZG9lcyBub3QgZXhwb3NlIHVwbG9hZCBwcm9wZXJ0eVxuXHRcdHRoaXMuX29wdGlvbnMueGhyID0gZnVuY3Rpb24gKCkge1xuXHRcdFx0Y29uc3QgeGhyID0gJC5hamF4U2V0dXAoYWpheFRyYW5zcG9ydCkueGhyISgpO1xuXG5cdFx0XHQvLyBhbGxvdyBDT1JTXG5cdFx0XHR4aHIud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTtcblxuXHRcdFx0eGhyLmFkZEV2ZW50TGlzdGVuZXIoJ2Fib3J0JywgZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRtLl9hYm9ydGVkID0gdHJ1ZTtcblx0XHRcdH0pO1xuXG5cdFx0XHRpZiAoeGhyLnVwbG9hZCkge1xuXHRcdFx0XHR4aHIudXBsb2FkLmFkZEV2ZW50TGlzdGVuZXIoXG5cdFx0XHRcdFx0J3Byb2dyZXNzJyxcblx0XHRcdFx0XHQoZTogYW55KSA9PiB7XG5cdFx0XHRcdFx0XHRsZXQgcGVyY2VudCA9IDA7XG5cdFx0XHRcdFx0XHRjb25zdCBwb3NpdGlvbiA9IGUubG9hZGVkIHx8IGUucG9zaXRpb247IC8vIGUucG9zaXRpb25cblx0XHRcdFx0XHRcdGNvbnN0IHRvdGFsID0gZS50b3RhbDtcblxuXHRcdFx0XHRcdFx0aWYgKGUubGVuZ3RoQ29tcHV0YWJsZSkge1xuXHRcdFx0XHRcdFx0XHRwZXJjZW50ID0gTWF0aC5mbG9vcigocG9zaXRpb24gLyB0b3RhbCkgKiAxMDApO1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRtLnRyaWdnZXIoT1dlYkNvbS5FVlRfQ09NX1VQTE9BRF9QUk9HUkVTUywgW1xuXHRcdFx0XHRcdFx0XHRlLFxuXHRcdFx0XHRcdFx0XHRwb3NpdGlvbixcblx0XHRcdFx0XHRcdFx0dG90YWwsXG5cdFx0XHRcdFx0XHRcdHBlcmNlbnQsXG5cdFx0XHRcdFx0XHRdKTtcblx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdGZhbHNlLFxuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4geGhyO1xuXHRcdH07XG5cdH1cblxuXHQvKipcblx0ICogSGFuZGxlIHNlcnZlciByZXNwb25zZS5cblx0ICpcblx0ICogPiBDYWxsZWQgb25seSB3aGVuIHRoZSBjb25uZWN0aW9uIHRvIHRoZSBzZXJ2ZXIgd2FzIHN1Y2Nlc3NmdWxseSBlc3RhYmxpc2hlZC5cblx0ICpcblx0ICogQHBhcmFtIHJlc3BvbnNlIFRoZSBzZXJ2ZXIgcmVzcG9uc2UuXG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIF9oYW5kbGVSZXNwb25zZShyZXNwb25zZTogSUNvbVJlc3BvbnNlKSB7XG5cdFx0Y29uc3QgbSA9IHRoaXM7XG5cblx0XHRpZiAocmVzcG9uc2Uuc3RpbWUpIHtcblx0XHRcdG0uYXBwQ29udGV4dC51c2VyLnNldFNlc3Npb25FeHBpcmUocmVzcG9uc2Uuc3RpbWUpO1xuXHRcdH1cblx0XHRpZiAocmVzcG9uc2Uuc3Rva2VuKSB7XG5cdFx0XHRtLmFwcENvbnRleHQuc2V0U2Vzc2lvblRva2VuKHJlc3BvbnNlLnN0b2tlbik7XG5cdFx0fVxuXG5cdFx0aWYgKHJlc3BvbnNlLmVycm9yID09PSAwKSB7XG5cdFx0XHRtLnRyaWdnZXIoT1dlYkNvbS5FVlRfQ09NX1JFUVVFU1RfU1VDQ0VTUywgW3Jlc3BvbnNlLCBtXSk7XG5cdFx0XHRtLnRyaWdnZXIoT1dlYkNvbS5FVlRfQ09NX0ZJTklTSCwgW3Jlc3BvbnNlLCBtXSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGlmIChyZXNwb25zZS5tc2cgPT09ICdPWl9FUlJPUl9ZT1VfTVVTVF9MT0dJTicpIHtcblx0XHRcdFx0bS50cmlnZ2VyKE9XZWJDb20uRVZUX0NPTV9SRVFVRVNUX0VSUk9SLCBbcmVzcG9uc2UsIG1dKTtcblx0XHRcdFx0bS5hcHBDb250ZXh0LmZvcmNlTG9naW4oKTtcblx0XHRcdH0gZWxzZSBpZiAofmZpbGVBbGlhc0Vycm9ycy5pbmRleE9mKHJlc3BvbnNlLm1zZykpIHtcblx0XHRcdFx0Ly8gb3VyIGF0dGVtcHQgdG8gbWluaW1pemUgZmlsZSB1cGxvYWQgZmFpbGVkXG5cdFx0XHRcdGNvbnNvbGUud2Fybihcblx0XHRcdFx0XHQnW09XZWJDb21dIHVuYWJsZSB0byBtaW5pbWl6ZSBmaWxlIHVwbG9hZCBkYXRhIC0+Jyxcblx0XHRcdFx0XHRyZXNwb25zZSxcblx0XHRcdFx0XHRtLl9vcHRpb25zLmRhdGEsXG5cdFx0XHRcdCk7XG5cdFx0XHRcdHRoaXMuX21vZGlmaWVkRGF0YSA9IGZhbHNlO1xuXHRcdFx0XHR0aGlzLl9vcHRpb25zLmRhdGEgPSB0aGlzLl9vcmlnaW5hbERhdGE7XG5cdFx0XHRcdG0uX2J1c3kgPSBmYWxzZTtcblx0XHRcdFx0bS5zZW5kKCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRpZiAobS5fb3B0aW9ucy5iYWROZXdzU2hvdykge1xuXHRcdFx0XHRcdG0uYXBwQ29udGV4dC52aWV3LmRpYWxvZyh7XG5cdFx0XHRcdFx0XHR0eXBlOiAnZXJyb3InLFxuXHRcdFx0XHRcdFx0dGV4dDogcmVzcG9uc2UubXNnLFxuXHRcdFx0XHRcdFx0ZGF0YTogcmVzcG9uc2UuZGF0YSxcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdG0udHJpZ2dlcihPV2ViQ29tLkVWVF9DT01fUkVRVUVTVF9FUlJPUiwgW3Jlc3BvbnNlLCBtXSk7XG5cdFx0XHRcdG0udHJpZ2dlcihPV2ViQ29tLkVWVF9DT01fRklOSVNILCBbcmVzcG9uc2UsIG1dKTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHQvKipcblx0ICogU2VuZCByZXF1ZXN0LlxuXHQgKi9cblx0c2VuZCgpIHtcblx0XHRjb25zdCBtID0gdGhpcztcblx0XHR0aGlzLl9wcmVwYXJlKCk7XG5cblx0XHRpZiAodGhpcy5fYnVzeSkge1xuXHRcdFx0Y29uc29sZS53YXJuKCdbT1dlYkNvbV0gaW5zdGFuY2UgaXMgYnVzeSAtPicsIG0pO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGlmICh0aGlzLl9vcHRpb25zKSB7XG5cdFx0XHR0aGlzLl9idXN5ID0gdHJ1ZTtcblx0XHRcdHRoaXMuX3JlcXVlc3QgPSAkLmFqYXgobS5fb3B0aW9ucylcblx0XHRcdFx0LmRvbmUoKHJlc3BvbnNlOiBhbnkpID0+IHtcblx0XHRcdFx0XHRtLl9oYW5kbGVSZXNwb25zZShyZXNwb25zZSk7XG5cdFx0XHRcdH0pXG5cdFx0XHRcdC5mYWlsKChyZXF1ZXN0OiBhbnkpID0+IHtcblx0XHRcdFx0XHRjb25zdCBuZXR3b3JrRXJyb3IgPSAhaXNQbGFpbk9iamVjdChyZXF1ZXN0LnJlc3BvbnNlSlNPTik7XG5cdFx0XHRcdFx0aWYgKG5ldHdvcmtFcnJvcikge1xuXHRcdFx0XHRcdFx0Y29uc29sZS5lcnJvcihcblx0XHRcdFx0XHRcdFx0J1tPV2ViQ29tXSByZXF1ZXN0IG5ldHdvcmsgZXJyb3IgLT4nLFxuXHRcdFx0XHRcdFx0XHRyZXF1ZXN0LFxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdG0udHJpZ2dlcihPV2ViQ29tLkVWVF9DT01fTkVUV09SS19FUlJPUiwgW3JlcXVlc3QsIG1dKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0Y29uc29sZS5lcnJvcihcblx0XHRcdFx0XHRcdFx0J1tPV2ViQ29tXSByZXF1ZXN0IHNlcnZlciBlcnJvciAtPicsXG5cdFx0XHRcdFx0XHRcdHJlcXVlc3QsXG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0bS5faGFuZGxlUmVzcG9uc2UocmVxdWVzdC5yZXNwb25zZUpTT04pO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSk7XG5cdFx0fVxuXHR9XG5cblx0LyoqXG5cdCAqIENoZWNrcyBpZiB0aGUgY3VycmVudCByZXF1ZXN0IGhhcyBiZWVuIGFib3J0ZWQuXG5cdCAqL1xuXHRpc0Fib3J0ZWQoKSB7XG5cdFx0cmV0dXJuIHRoaXMuX2Fib3J0ZWQ7XG5cdH1cblxuXHQvKipcblx0ICogVHJ5IHRvIGFib3J0IHRoZSBjdXJyZW50IHJlcXVlc3QuXG5cdCAqL1xuXHRhYm9ydCgpIHtcblx0XHR0aGlzLl9idXN5ID0gZmFsc2U7XG5cdFx0aWYgKHRoaXMuX3JlcXVlc3QpIHtcblx0XHRcdHRoaXMuX3JlcXVlc3QuYWJvcnQoKTtcblx0XHR9XG5cdH1cbn1cbiJdfQ==