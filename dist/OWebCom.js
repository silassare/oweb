import OWebEvent from './OWebEvent';
import OWebFS from './OWebFS';
import Utils from './utils/Utils';
const file_alias_errors = [
    'OZ_FILE_ALIAS_UNKNOWN',
    'OZ_FILE_ALIAS_NOT_FOUND',
    'OZ_FILE_ALIAS_PARSE_ERROR',
];
let searchAndReplaceMarkedFile = function (data) {
    let form_data = new FormData(), has_marked_file = false, check = (value, name) => {
        let v = value;
        if (OWebFS.isMarkedFile(v)) {
            v = OWebFS.createFileAlias(v);
            has_marked_file = true;
        }
        form_data.append(name, v);
    };
    if (data) {
        if (data instanceof FormData) {
            data.forEach(check);
        }
        else if (Utils.isPlainObject(data)) {
            Object.keys(data).forEach(function (key_name) {
                check(data[key_name], key_name);
            });
        }
    }
    return has_marked_file ? form_data : false;
};
const ajaxTransport = {
    // FOR GOBL JSON HELPER: WE DO NOT TRUST JQUERY JSON.parse
    converters: {
        'text json': function (a) {
            return JSON.parse(a);
        },
    },
};
export default class OWebCom extends OWebEvent {
    constructor(app_context, options) {
        super();
        this.app_context = app_context;
        this._busy = false;
        if (options && !Utils.isPlainObject(options)) {
            throw new TypeError(`[OWebCom] require an 'object' as options not:  ${typeof options}.`);
        }
        this._options = {
            method: 'GET',
            dataType: 'json',
            data: {},
            crossDomain: true,
            badNewsShow: false,
            // increase request timeout for mobile device
            timeout: app_context.isMobileApp() ? 10000 : undefined,
            ...(options || {}),
        };
        this._original_data = options.data || {};
        this._modified_data = searchAndReplaceMarkedFile(options.data);
        if (this._modified_data) {
            this._options.data = this._modified_data;
        }
    }
    /**
     * Prepare the request before sending.
     *
     * @private
     */
    _prepare() {
        let m = this, real_method = m._options.method, replace_methods = ['PATCH', 'PUT', 'DELETE'], api_key_header = this.app_context.configs.get('OZ_API_KEY_HEADER_NAME'), real_method_header = this.app_context.configs.get('OZ_API_REAL_METHOD_HEADER_NAME');
        let headers = (this._options.headers =
            this._options.headers || {});
        headers[api_key_header] = this.app_context.configs.get('OZ_API_KEY');
        // we update request method
        if (~replace_methods.indexOf(real_method)) {
            headers[real_method_header] = real_method;
            this._options.method = 'POST';
        }
        if (this._options.data instanceof FormData) {
            this._options.processData = false;
            this._options.contentType = false;
        }
        // workaround because jqXHR does not expose upload property
        this._options.xhr = function () {
            let xhr = $.ajaxSetup(ajaxTransport).xhr();
            // allow CORS
            xhr.withCredentials = true;
            if (xhr.upload) {
                xhr.upload.addEventListener('progress', (e) => {
                    let percent = 0;
                    let position = e.loaded || e.position; // e.position
                    let total = e.total;
                    if (e.lengthComputable) {
                        percent = Math.floor((position / total) * 100);
                    }
                    m.trigger(OWebCom.EVT_COM_UPLOAD_PROGRESS, [
                        e,
                        position,
                        total,
                        percent,
                    ]);
                }, false);
            }
            return xhr;
        };
    }
    /**
     * Handle server response.
     *
     * > Called only when the connection to the server was successfully established.
     *
     * @param response The server response.
     * @private
     */
    _handleResponse(response) {
        let m = this;
        if (response.stime) {
            m.app_context.user.setSessionExpire(response.stime);
        }
        if (response.error === 0) {
            m.trigger(OWebCom.EVT_COM_REQUEST_SUCCESS, [response, m]);
            m.trigger(OWebCom.EVT_COM_FINISH, [response, m]);
        }
        else {
            if (response.msg === 'OZ_ERROR_YOU_MUST_LOGIN') {
                m.trigger(OWebCom.EVT_COM_REQUEST_ERROR, [response, m]);
                m.app_context.forceLogin();
            }
            else if (~file_alias_errors.indexOf(response.msg)) {
                // our attempt to minimize file upload failed
                console.warn('[OWebCom] unable to minimize file upload data ->', response, m._options.data);
                this._modified_data = false;
                this._options.data = this._original_data;
                m._busy = false;
                m.send();
            }
            else {
                if (m._options.badNewsShow) {
                    m.app_context.view.dialog({
                        type: 'error',
                        text: response.msg,
                        data: response.data,
                    });
                }
                m.trigger(OWebCom.EVT_COM_REQUEST_ERROR, [response, m]);
                m.trigger(OWebCom.EVT_COM_FINISH, [response, m]);
            }
        }
    }
    /**
     * Send request.
     */
    send() {
        let m = this;
        this._prepare();
        if (this._busy) {
            console.warn('[OWebCom] instance is busy ->', m);
            return;
        }
        if (this._options) {
            this._busy = true;
            this._request = $.ajax(m._options)
                .done((response) => {
                m._handleResponse(response);
            })
                .fail((request) => {
                let network_error = !Utils.isPlainObject(request['responseJSON']);
                if (network_error) {
                    console.error('[OWebCom] request network error ->', request);
                    m.trigger(OWebCom.EVT_COM_NETWORK_ERROR, [request, m]);
                }
                else {
                    console.error('[OWebCom] request server error ->', request);
                    m._handleResponse(request['responseJSON']);
                }
            });
        }
    }
    /**
     * Try to abort the current request.
     */
    abort() {
        this._busy = false;
        if (this._request) {
            this._request.abort();
        }
    }
}
OWebCom.SELF = Utils.id();
OWebCom.EVT_COM_REQUEST_SUCCESS = Utils.id();
OWebCom.EVT_COM_REQUEST_ERROR = Utils.id();
OWebCom.EVT_COM_NETWORK_ERROR = Utils.id();
OWebCom.EVT_COM_UPLOAD_PROGRESS = Utils.id();
OWebCom.EVT_COM_FINISH = Utils.id();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkNvbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViQ29tLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sU0FBUyxNQUFNLGFBQWEsQ0FBQztBQUNwQyxPQUFPLE1BQU0sTUFBTSxVQUFVLENBQUM7QUFDOUIsT0FBTyxLQUFLLE1BQU0sZUFBZSxDQUFDO0FBeUJsQyxNQUFNLGlCQUFpQixHQUFHO0lBQ3pCLHVCQUF1QjtJQUN2Qix5QkFBeUI7SUFDekIsMkJBQTJCO0NBQzNCLENBQUM7QUFFRixJQUFJLDBCQUEwQixHQUFHLFVBQ2hDLElBQXdDO0lBRXhDLElBQUksU0FBUyxHQUFHLElBQUksUUFBUSxFQUFFLEVBQzdCLGVBQWUsR0FBRyxLQUFLLEVBQ3ZCLEtBQUssR0FBRyxDQUFDLEtBQVUsRUFBRSxJQUFZLEVBQUUsRUFBRTtRQUNwQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUM7UUFFZCxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDM0IsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDOUIsZUFBZSxHQUFHLElBQUksQ0FBQztTQUN2QjtRQUVELFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzNCLENBQUMsQ0FBQztJQUVILElBQUksSUFBSSxFQUFFO1FBQ1QsSUFBSSxJQUFJLFlBQVksUUFBUSxFQUFFO1lBQzVCLElBQVksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDN0I7YUFBTSxJQUFJLEtBQUssQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDckMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBUyxRQUFRO2dCQUMxQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQ2pDLENB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Q1osbUNBQW1DLEVBQ25DLE9BQU8sQ0FDUCxDQUFDO29CQUNGLENBQUMsQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7aUJBQzNDO1lBQ0YsQ0FBQyxDQUFDLENBQUM7U0FDSjtJQUNGLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUs7UUFDSixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDbEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUN0QjtJQUNGLENBQUM7O0FBeE1lLFlBQUksR0FBRyxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUM7QUFDbEIsK0JBQXVCLEdBQUcsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQ3JDLDZCQUFxQixHQUFHLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUNuQyw2QkFBcUIsR0FBRyxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUM7QUFDbkMsK0JBQXVCLEdBQUcsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQ3JDLHNCQUFjLEdBQUcsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IE9XZWJBcHAgZnJvbSAnLi9PV2ViQXBwJztcbmltcG9ydCBPV2ViRXZlbnQgZnJvbSAnLi9PV2ViRXZlbnQnO1xuaW1wb3J0IE9XZWJGUyBmcm9tICcuL09XZWJGUyc7XG5pbXBvcnQgVXRpbHMgZnJvbSAnLi91dGlscy9VdGlscyc7XG5pbXBvcnQganFYSFIgPSBKUXVlcnkuanFYSFI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgaUNvbVJlc3BvbnNlIHtcblx0ZXJyb3I6IG51bWJlcjtcblx0bXNnOiBzdHJpbmc7XG5cdGRhdGE/OiBhbnk7XG5cdHV0aW1lOiBudW1iZXI7XG5cdHN0aW1lPzogbnVtYmVyO1xuXHRuZXRlcnJvcj86IGJvb2xlYW47XG59XG5cbmV4cG9ydCB0eXBlIHRDb21PcHRpb25zID0ge1xuXHR1cmw6IHN0cmluZztcblx0bWV0aG9kOiBzdHJpbmc7XG5cdHhocj86IGFueTtcblx0aGVhZGVycz86IHt9O1xuXHRkYXRhPzoge307XG5cdGRhdGFUeXBlPzogc3RyaW5nO1xuXHRjcm9zc0RvbWFpbj86IGJvb2xlYW47XG5cdHByb2Nlc3NEYXRhPzogYm9vbGVhbjtcblx0Y29udGVudFR5cGU/OiBhbnk7XG5cdGJhZE5ld3NTaG93PzogYm9vbGVhbjtcblx0dGltZW91dD86IG51bWJlcjtcbn07XG5jb25zdCBmaWxlX2FsaWFzX2Vycm9ycyA9IFtcblx0J09aX0ZJTEVfQUxJQVNfVU5LTk9XTicsXG5cdCdPWl9GSUxFX0FMSUFTX05PVF9GT1VORCcsXG5cdCdPWl9GSUxFX0FMSUFTX1BBUlNFX0VSUk9SJyxcbl07XG5cbmxldCBzZWFyY2hBbmRSZXBsYWNlTWFya2VkRmlsZSA9IGZ1bmN0aW9uKFxuXHRkYXRhPzogeyBba2V5OiBzdHJpbmddOiBhbnkgfSB8IEZvcm1EYXRhXG4pIHtcblx0bGV0IGZvcm1fZGF0YSA9IG5ldyBGb3JtRGF0YSgpLFxuXHRcdGhhc19tYXJrZWRfZmlsZSA9IGZhbHNlLFxuXHRcdGNoZWNrID0gKHZhbHVlOiBhbnksIG5hbWU6IHN0cmluZykgPT4ge1xuXHRcdFx0bGV0IHYgPSB2YWx1ZTtcblxuXHRcdFx0aWYgKE9XZWJGUy5pc01hcmtlZEZpbGUodikpIHtcblx0XHRcdFx0diA9IE9XZWJGUy5jcmVhdGVGaWxlQWxpYXModik7XG5cdFx0XHRcdGhhc19tYXJrZWRfZmlsZSA9IHRydWU7XG5cdFx0XHR9XG5cblx0XHRcdGZvcm1fZGF0YS5hcHBlbmQobmFtZSwgdik7XG5cdFx0fTtcblxuXHRpZiAoZGF0YSkge1xuXHRcdGlmIChkYXRhIGluc3RhbmNlb2YgRm9ybURhdGEpIHtcblx0XHRcdChkYXRhIGFzIGFueSkuZm9yRWFjaChjaGVjayk7XG5cdFx0fSBlbHNlIGlmIChVdGlscy5pc1BsYWluT2JqZWN0KGRhdGEpKSB7XG5cdFx0XHRPYmplY3Qua2V5cyhkYXRhKS5mb3JFYWNoKGZ1bmN0aW9uKGtleV9uYW1lKSB7XG5cdFx0XHRcdGNoZWNrKGRhdGFba2V5X25hbWVdLCBrZXlfbmFtZSk7XG5cdFx0XHR9KTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gaGFzX21hcmtlZF9maWxlID8gZm9ybV9kYXRhIDogZmFsc2U7XG59O1xuXG5jb25zdCBhamF4VHJhbnNwb3J0ID0ge1xuXHQvLyBGT1IgR09CTCBKU09OIEhFTFBFUjogV0UgRE8gTk9UIFRSVVNUIEpRVUVSWSBKU09OLnBhcnNlXG5cdGNvbnZlcnRlcnM6IHtcblx0XHQndGV4dCBqc29uJzogZnVuY3Rpb24oYTogc3RyaW5nKSB7XG5cdFx0XHRyZXR1cm4gSlNPTi5wYXJzZShhKTtcblx0XHR9LFxuXHR9LFxufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT1dlYkNvbSBleHRlbmRzIE9XZWJFdmVudCB7XG5cdHN0YXRpYyByZWFkb25seSBTRUxGID0gVXRpbHMuaWQoKTtcblx0c3RhdGljIHJlYWRvbmx5IEVWVF9DT01fUkVRVUVTVF9TVUNDRVNTID0gVXRpbHMuaWQoKTtcblx0c3RhdGljIHJlYWRvbmx5IEVWVF9DT01fUkVRVUVTVF9FUlJPUiA9IFV0aWxzLmlkKCk7XG5cdHN0YXRpYyByZWFkb25seSBFVlRfQ09NX05FVFdPUktfRVJST1IgPSBVdGlscy5pZCgpO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9VUExPQURfUFJPR1JFU1MgPSBVdGlscy5pZCgpO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9GSU5JU0ggPSBVdGlscy5pZCgpO1xuXG5cdHByaXZhdGUgcmVhZG9ubHkgX29wdGlvbnM6IHRDb21PcHRpb25zO1xuXHRwcml2YXRlIHJlYWRvbmx5IF9vcmlnaW5hbF9kYXRhOiBhbnk7XG5cdHByaXZhdGUgX21vZGlmaWVkX2RhdGE6IEZvcm1EYXRhIHwgYm9vbGVhbjtcblx0cHJpdmF0ZSBfYnVzeTogYm9vbGVhbiA9IGZhbHNlO1xuXHRwcml2YXRlIF9yZXF1ZXN0PzoganFYSFI7XG5cblx0Y29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhcHBfY29udGV4dDogT1dlYkFwcCwgb3B0aW9uczogdENvbU9wdGlvbnMpIHtcblx0XHRzdXBlcigpO1xuXG5cdFx0aWYgKG9wdGlvbnMgJiYgIVV0aWxzLmlzUGxhaW5PYmplY3Qob3B0aW9ucykpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoXG5cdFx0XHRcdGBbT1dlYkNvbV0gcmVxdWlyZSBhbiAnb2JqZWN0JyBhcyBvcHRpb25zIG5vdDogICR7dHlwZW9mIG9wdGlvbnN9LmBcblx0XHRcdCk7XG5cdFx0fVxuXG5cdFx0dGhpcy5fb3B0aW9ucyA9IHtcblx0XHRcdG1ldGhvZDogJ0dFVCcsXG5cdFx0XHRkYXRhVHlwZTogJ2pzb24nLFxuXHRcdFx0ZGF0YToge30sXG5cdFx0XHRjcm9zc0RvbWFpbjogdHJ1ZSxcblx0XHRcdGJhZE5ld3NTaG93OiBmYWxzZSxcblx0XHRcdC8vIGluY3JlYXNlIHJlcXVlc3QgdGltZW91dCBmb3IgbW9iaWxlIGRldmljZVxuXHRcdFx0dGltZW91dDogYXBwX2NvbnRleHQuaXNNb2JpbGVBcHAoKSA/IDEwMDAwIDogdW5kZWZpbmVkLFxuXHRcdFx0Li4uKG9wdGlvbnMgfHwge30pLFxuXHRcdH07XG5cdFx0dGhpcy5fb3JpZ2luYWxfZGF0YSA9IG9wdGlvbnMuZGF0YSB8fCB7fTtcblx0XHR0aGlzLl9tb2RpZmllZF9kYXRhID0gc2VhcmNoQW5kUmVwbGFjZU1hcmtlZEZpbGUob3B0aW9ucy5kYXRhKTtcblxuXHRcdGlmICh0aGlzLl9tb2RpZmllZF9kYXRhKSB7XG5cdFx0XHR0aGlzLl9vcHRpb25zLmRhdGEgPSB0aGlzLl9tb2RpZmllZF9kYXRhO1xuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBQcmVwYXJlIHRoZSByZXF1ZXN0IGJlZm9yZSBzZW5kaW5nLlxuXHQgKlxuXHQgKiBAcHJpdmF0ZVxuXHQgKi9cblx0cHJpdmF0ZSBfcHJlcGFyZSgpIHtcblx0XHRsZXQgbSA9IHRoaXMsXG5cdFx0XHRyZWFsX21ldGhvZCA9IG0uX29wdGlvbnMubWV0aG9kLFxuXHRcdFx0cmVwbGFjZV9tZXRob2RzID0gWydQQVRDSCcsICdQVVQnLCAnREVMRVRFJ10sXG5cdFx0XHRhcGlfa2V5X2hlYWRlciA9IHRoaXMuYXBwX2NvbnRleHQuY29uZmlncy5nZXQoXG5cdFx0XHRcdCdPWl9BUElfS0VZX0hFQURFUl9OQU1FJ1xuXHRcdFx0KSxcblx0XHRcdHJlYWxfbWV0aG9kX2hlYWRlciA9IHRoaXMuYXBwX2NvbnRleHQuY29uZmlncy5nZXQoXG5cdFx0XHRcdCdPWl9BUElfUkVBTF9NRVRIT0RfSEVBREVSX05BTUUnXG5cdFx0XHQpO1xuXG5cdFx0bGV0IGhlYWRlcnM6IGFueSA9ICh0aGlzLl9vcHRpb25zLmhlYWRlcnMgPVxuXHRcdFx0dGhpcy5fb3B0aW9ucy5oZWFkZXJzIHx8IHt9KTtcblx0XHRoZWFkZXJzW2FwaV9rZXlfaGVhZGVyXSA9IHRoaXMuYXBwX2NvbnRleHQuY29uZmlncy5nZXQoJ09aX0FQSV9LRVknKTtcblxuXHRcdC8vIHdlIHVwZGF0ZSByZXF1ZXN0IG1ldGhvZFxuXHRcdGlmICh+cmVwbGFjZV9tZXRob2RzLmluZGV4T2YocmVhbF9tZXRob2QpKSB7XG5cdFx0XHRoZWFkZXJzW3JlYWxfbWV0aG9kX2hlYWRlcl0gPSByZWFsX21ldGhvZDtcblx0XHRcdHRoaXMuX29wdGlvbnMubWV0aG9kID0gJ1BPU1QnO1xuXHRcdH1cblxuXHRcdGlmICh0aGlzLl9vcHRpb25zLmRhdGEgaW5zdGFuY2VvZiBGb3JtRGF0YSkge1xuXHRcdFx0dGhpcy5fb3B0aW9ucy5wcm9jZXNzRGF0YSA9IGZhbHNlO1xuXHRcdFx0dGhpcy5fb3B0aW9ucy5jb250ZW50VHlwZSA9IGZhbHNlO1xuXHRcdH1cblxuXHRcdC8vIHdvcmthcm91bmQgYmVjYXVzZSBqcVhIUiBkb2VzIG5vdCBleHBvc2UgdXBsb2FkIHByb3BlcnR5XG5cdFx0dGhpcy5fb3B0aW9ucy54aHIgPSBmdW5jdGlvbigpIHtcblx0XHRcdGxldCB4aHIgPSAkLmFqYXhTZXR1cChhamF4VHJhbnNwb3J0KS54aHIhKCk7XG5cblx0XHRcdC8vIGFsbG93IENPUlNcblx0XHRcdHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlO1xuXG5cdFx0XHRpZiAoeGhyLnVwbG9hZCkge1xuXHRcdFx0XHR4aHIudXBsb2FkLmFkZEV2ZW50TGlzdGVuZXIoXG5cdFx0XHRcdFx0J3Byb2dyZXNzJyxcblx0XHRcdFx0XHQoZTogYW55KSA9PiB7XG5cdFx0XHRcdFx0XHRsZXQgcGVyY2VudCA9IDA7XG5cdFx0XHRcdFx0XHRsZXQgcG9zaXRpb24gPSBlLmxvYWRlZCB8fCBlLnBvc2l0aW9uOyAvLyBlLnBvc2l0aW9uXG5cdFx0XHRcdFx0XHRsZXQgdG90YWwgPSBlLnRvdGFsO1xuXG5cdFx0XHRcdFx0XHRpZiAoZS5sZW5ndGhDb21wdXRhYmxlKSB7XG5cdFx0XHRcdFx0XHRcdHBlcmNlbnQgPSBNYXRoLmZsb29yKChwb3NpdGlvbiAvIHRvdGFsKSAqIDEwMCk7XG5cdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdG0udHJpZ2dlcihPV2ViQ29tLkVWVF9DT01fVVBMT0FEX1BST0dSRVNTLCBbXG5cdFx0XHRcdFx0XHRcdGUsXG5cdFx0XHRcdFx0XHRcdHBvc2l0aW9uLFxuXHRcdFx0XHRcdFx0XHR0b3RhbCxcblx0XHRcdFx0XHRcdFx0cGVyY2VudCxcblx0XHRcdFx0XHRcdF0pO1xuXHRcdFx0XHRcdH0sXG5cdFx0XHRcdFx0ZmFsc2Vcblx0XHRcdFx0KTtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIHhocjtcblx0XHR9O1xuXHR9XG5cblx0LyoqXG5cdCAqIEhhbmRsZSBzZXJ2ZXIgcmVzcG9uc2UuXG5cdCAqXG5cdCAqID4gQ2FsbGVkIG9ubHkgd2hlbiB0aGUgY29ubmVjdGlvbiB0byB0aGUgc2VydmVyIHdhcyBzdWNjZXNzZnVsbHkgZXN0YWJsaXNoZWQuXG5cdCAqXG5cdCAqIEBwYXJhbSByZXNwb25zZSBUaGUgc2VydmVyIHJlc3BvbnNlLlxuXHQgKiBAcHJpdmF0ZVxuXHQgKi9cblx0cHJpdmF0ZSBfaGFuZGxlUmVzcG9uc2UocmVzcG9uc2U6IGlDb21SZXNwb25zZSkge1xuXHRcdGxldCBtID0gdGhpcztcblxuXHRcdGlmIChyZXNwb25zZS5zdGltZSkge1xuXHRcdFx0bS5hcHBfY29udGV4dC51c2VyLnNldFNlc3Npb25FeHBpcmUocmVzcG9uc2Uuc3RpbWUpO1xuXHRcdH1cblxuXHRcdGlmIChyZXNwb25zZS5lcnJvciA9PT0gMCkge1xuXHRcdFx0bS50cmlnZ2VyKE9XZWJDb20uRVZUX0NPTV9SRVFVRVNUX1NVQ0NFU1MsIFtyZXNwb25zZSwgbV0pO1xuXHRcdFx0bS50cmlnZ2VyKE9XZWJDb20uRVZUX0NPTV9GSU5JU0gsIFtyZXNwb25zZSwgbV0pO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRpZiAocmVzcG9uc2UubXNnID09PSAnT1pfRVJST1JfWU9VX01VU1RfTE9HSU4nKSB7XG5cdFx0XHRcdG0udHJpZ2dlcihPV2ViQ29tLkVWVF9DT01fUkVRVUVTVF9FUlJPUiwgW3Jlc3BvbnNlLCBtXSk7XG5cdFx0XHRcdG0uYXBwX2NvbnRleHQuZm9yY2VMb2dpbigpO1xuXHRcdFx0fSBlbHNlIGlmICh+ZmlsZV9hbGlhc19lcnJvcnMuaW5kZXhPZihyZXNwb25zZS5tc2cpKSB7XG5cdFx0XHRcdC8vIG91ciBhdHRlbXB0IHRvIG1pbmltaXplIGZpbGUgdXBsb2FkIGZhaWxlZFxuXHRcdFx0XHRjb25zb2xlLndhcm4oXG5cdFx0XHRcdFx0J1tPV2ViQ29tXSB1bmFibGUgdG8gbWluaW1pemUgZmlsZSB1cGxvYWQgZGF0YSAtPicsXG5cdFx0XHRcdFx0cmVzcG9uc2UsXG5cdFx0XHRcdFx0bS5fb3B0aW9ucy5kYXRhXG5cdFx0XHRcdCk7XG5cdFx0XHRcdHRoaXMuX21vZGlmaWVkX2RhdGEgPSBmYWxzZTtcblx0XHRcdFx0dGhpcy5fb3B0aW9ucy5kYXRhID0gdGhpcy5fb3JpZ2luYWxfZGF0YTtcblx0XHRcdFx0bS5fYnVzeSA9IGZhbHNlO1xuXHRcdFx0XHRtLnNlbmQoKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGlmIChtLl9vcHRpb25zLmJhZE5ld3NTaG93KSB7XG5cdFx0XHRcdFx0bS5hcHBfY29udGV4dC52aWV3LmRpYWxvZyh7XG5cdFx0XHRcdFx0XHR0eXBlOiAnZXJyb3InLFxuXHRcdFx0XHRcdFx0dGV4dDogcmVzcG9uc2UubXNnLFxuXHRcdFx0XHRcdFx0ZGF0YTogcmVzcG9uc2UuZGF0YSxcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdG0udHJpZ2dlcihPV2ViQ29tLkVWVF9DT01fUkVRVUVTVF9FUlJPUiwgW3Jlc3BvbnNlLCBtXSk7XG5cdFx0XHRcdG0udHJpZ2dlcihPV2ViQ29tLkVWVF9DT01fRklOSVNILCBbcmVzcG9uc2UsIG1dKTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHQvKipcblx0ICogU2VuZCByZXF1ZXN0LlxuXHQgKi9cblx0c2VuZCgpIHtcblx0XHRsZXQgbSA9IHRoaXM7XG5cdFx0dGhpcy5fcHJlcGFyZSgpO1xuXG5cdFx0aWYgKHRoaXMuX2J1c3kpIHtcblx0XHRcdGNvbnNvbGUud2FybignW09XZWJDb21dIGluc3RhbmNlIGlzIGJ1c3kgLT4nLCBtKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRpZiAodGhpcy5fb3B0aW9ucykge1xuXHRcdFx0dGhpcy5fYnVzeSA9IHRydWU7XG5cdFx0XHR0aGlzLl9yZXF1ZXN0ID0gJC5hamF4KG0uX29wdGlvbnMpXG5cdFx0XHRcdC5kb25lKChyZXNwb25zZTogYW55KSA9PiB7XG5cdFx0XHRcdFx0bS5faGFuZGxlUmVzcG9uc2UocmVzcG9uc2UpO1xuXHRcdFx0XHR9KVxuXHRcdFx0XHQuZmFpbCgocmVxdWVzdDogYW55KSA9PiB7XG5cdFx0XHRcdFx0bGV0IG5ldHdvcmtfZXJyb3IgPSAhVXRpbHMuaXNQbGFpbk9iamVjdChcblx0XHRcdFx0XHRcdHJlcXVlc3RbJ3Jlc3BvbnNlSlNPTiddXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRpZiAobmV0d29ya19lcnJvcikge1xuXHRcdFx0XHRcdFx0Y29uc29sZS5lcnJvcihcblx0XHRcdFx0XHRcdFx0J1tPV2ViQ29tXSByZXF1ZXN0IG5ldHdvcmsgZXJyb3IgLT4nLFxuXHRcdFx0XHRcdFx0XHRyZXF1ZXN0XG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0bS50cmlnZ2VyKE9XZWJDb20uRVZUX0NPTV9ORVRXT1JLX0VSUk9SLCBbcmVxdWVzdCwgbV0pO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRjb25zb2xlLmVycm9yKFxuXHRcdFx0XHRcdFx0XHQnW09XZWJDb21dIHJlcXVlc3Qgc2VydmVyIGVycm9yIC0+Jyxcblx0XHRcdFx0XHRcdFx0cmVxdWVzdFxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdG0uX2hhbmRsZVJlc3BvbnNlKHJlcXVlc3RbJ3Jlc3BvbnNlSlNPTiddKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBUcnkgdG8gYWJvcnQgdGhlIGN1cnJlbnQgcmVxdWVzdC5cblx0ICovXG5cdGFib3J0KCkge1xuXHRcdHRoaXMuX2J1c3kgPSBmYWxzZTtcblx0XHRpZiAodGhpcy5fcmVxdWVzdCkge1xuXHRcdFx0dGhpcy5fcmVxdWVzdC5hYm9ydCgpO1xuXHRcdH1cblx0fVxufVxuIl19