"use strict";
import Utils from "./utils/Utils";
import OWebEvent from "./OWebEvent";
import OWebFS from "./OWebFS";
const file_alias_errors = [
    "OZ_FILE_ALIAS_UNKNOWN",
    "OZ_FILE_ALIAS_NOT_FOUND",
    "OZ_FILE_ALIAS_PARSE_ERROR"
], default_options = {
    url: "",
    method: "GET",
    data: {},
    dataType: "json",
    crossDomain: true,
    badNewsShow: false,
    // increase request timeout for mobile device
    // TODO: find a good way to check if mobile device
    timeout: ("cordova" in window ? 10000 : undefined)
};
let searchAndReplaceMarkedFile = function (data) {
    let form_data = new FormData(), has_marked_file = false, check = (value, name) => {
        let v = value;
        if (OWebFS.isMarkedFile(v)) {
            v = OWebFS.createFileAlias(v);
            has_marked_file = true;
        }
        form_data.append(name, v);
    };
    if (data) {
        if (data instanceof FormData) {
            data.forEach(check);
        }
        else if (Utils.isPlainObject(data)) {
            Object.keys(data).forEach(function (key_name) {
                check(data[key_name], key_name);
            });
        }
    }
    return has_marked_file ? form_data : false;
};
export default class OWebCom extends OWebEvent {
    constructor(app_context, options) {
        super();
        this.app_context = app_context;
        this._busy = false;
        if (options && !Utils.isPlainObject(options)) {
            throw new TypeError(`[OWebCom] require an 'object' as options not:  ${typeof options}.`);
        }
        this._options = Utils.assign({}, default_options, options || {});
        this._original_data = options.data || {};
        this._modified_data = searchAndReplaceMarkedFile(options.data);
        if (this._modified_data) {
            this._options.data = this._modified_data;
        }
    }
    _init() {
        let m = this, real_method = m._options.method, replace_methods = ["PATCH", "PUT", "DELETE"], api_key_header = this.app_context.configs.get("OZ_API_KEY_HEADER_NAME"), real_method_header = this.app_context.configs.get("OZ_API_REAL_METHOD_HEADER_NAME");
        let headers = this._options.headers = this._options.headers || {};
        headers[api_key_header] = this.app_context.configs.get("OZ_API_KEY");
        // update request method
        if (~replace_methods.indexOf(real_method)) {
            headers[real_method_header] = real_method;
            this._options.method = "POST";
        }
        if (this._options.data instanceof FormData) {
            this._options.processData = false;
            this._options.contentType = false;
        }
        // workaround because jqXHR does not expose upload property
        this._options.xhr = function () {
            let xhr = $.ajaxSettings.xhr();
            // allow CORS
            xhr.withCredentials = true;
            if (xhr.upload) {
                xhr.upload.addEventListener("progress", (e) => {
                    let percent = 0;
                    let position = e.loaded || e.position; // e.position
                    let total = e.total;
                    if (e.lengthComputable) {
                        percent = Math.floor(position / total * 100);
                    }
                    m.trigger(OWebCom.EVT_COM_UPLOAD_PROGRESS, [e, position, total, percent]);
                }, false);
            }
            return xhr;
        };
    }
    // the connection to the server was successfully established
    _handleResponse(response) {
        let m = this;
        if (response.stime) {
            m.app_context.user.setSessionExpire(response.stime);
        }
        if (response.error === 0) {
            m.trigger(OWebCom.EVT_COM_REQUEST_SUCCESS, [response, m]);
            m.trigger(OWebCom.EVT_COM_FINISH, [response, m]);
        }
        else {
            if (response.msg === "OZ_ERROR_YOU_MUST_LOGIN") {
                m.app_context.forceLogin();
            }
            else if (~file_alias_errors.indexOf(response.msg)) {
                // our attempt to minimize file upload failed
                console.warn("[OWebCom] unable to minimize file upload data ->", response, m._options.data);
                this._modified_data = false;
                this._options.data = this._original_data;
                m._busy = false;
                m.send();
            }
            else {
                if (m._options.badNewsShow) {
                    m.app_context.view.dialog({
                        type: "error",
                        text: response.msg,
                        data: response.data
                    });
                }
                m.trigger(OWebCom.EVT_COM_REQUEST_ERROR, [response, m]);
                m.trigger(OWebCom.EVT_COM_FINISH, [response, m]);
            }
        }
    }
    send() {
        let m = this;
        this._init();
        if (this._busy) {
            console.warn("[OWebCom] instance is busy ->", m);
            return;
        }
        if (this._options) {
            this._busy = true;
            this._request = $.ajax(m._options)
                .done((response) => {
                m._handleResponse(response);
            })
                .fail((request) => {
                let network_error = !Utils.isPlainObject(request["responseJSON"]);
                if (network_error) {
                    console.error("[OWebCom] request network error ->", request);
                    m.trigger(OWebCom.EVT_COM_NETWORK_ERROR, [request, m]);
                }
                else {
                    console.error("[OWebCom] request server error ->", request);
                    m._handleResponse(request["responseJSON"]);
                }
            });
        }
    }
    abort() {
        this._busy = false;
        if (this._request) {
            this._request.abort();
        }
    }
}
OWebCom.EVT_COM_REQUEST_SUCCESS = "OWebCom:success";
OWebCom.EVT_COM_REQUEST_ERROR = "OWebCom:error";
OWebCom.EVT_COM_NETWORK_ERROR = "OWebCom:net_error";
OWebCom.EVT_COM_UPLOAD_PROGRESS = "OWebCom:upload_progress";
OWebCom.EVT_COM_FINISH = "OWebCom:finish";
OWebCom.SELF = "OWebCom";
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkNvbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViQ29tLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQztBQUViLE9BQU8sS0FBSyxNQUFNLGVBQWUsQ0FBQztBQUNsQyxPQUFPLFNBQVMsTUFBTSxhQUFhLENBQUM7QUFFcEMsT0FBTyxNQUFNLE1BQU0sVUFBVSxDQUFDO0FBeUI5QixNQUFNLGlCQUFpQixHQUFjO0lBQ2pDLHVCQUF1QjtJQUN2Qix5QkFBeUI7SUFDekIsMkJBQTJCO0NBQzNCLEVBQ0QsZUFBZSxHQUFnQjtJQUM5QixHQUFHLEVBQVUsRUFBRTtJQUNmLE1BQU0sRUFBTyxLQUFLO0lBQ2xCLElBQUksRUFBUyxFQUFFO0lBQ2YsUUFBUSxFQUFLLE1BQU07SUFDbkIsV0FBVyxFQUFFLElBQUk7SUFDakIsV0FBVyxFQUFFLEtBQUs7SUFDbEIsNkNBQTZDO0lBQzdDLGtEQUFrRDtJQUNsRCxPQUFPLEVBQU0sQ0FBQyxTQUFTLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztDQUN0RCxDQUFDO0FBRUwsSUFBSSwwQkFBMEIsR0FBRyxVQUFVLElBQXdDO0lBQ2xGLElBQUksU0FBUyxHQUFTLElBQUksUUFBUSxFQUFFLEVBQ25DLGVBQWUsR0FBRyxLQUFLLEVBQ3ZCLEtBQUssR0FBYSxDQUFDLEtBQVUsRUFBRSxJQUFZLEVBQUUsRUFBRTtRQUM5QyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUM7UUFFZCxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDM0IsQ0FBQyxHQUFpQixNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzVDLGVBQWUsR0FBRyxJQUFJLENBQUM7U0FDdkI7UUFFRCxTQUFTLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMzQixDQUFDLENBQUM7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QixJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQ3RCO0lBQ0YsQ0FBQzs7QUFuSmUsK0JBQXVCLEdBQUcsaUJBQWlCLENBQUM7QUFDNUMsNkJBQXFCLEdBQUssZUFBZSxDQUFDO0FBQzFDLDZCQUFxQixHQUFLLG1CQUFtQixDQUFDO0FBQzlDLCtCQUF1QixHQUFHLHlCQUF5QixDQUFDO0FBQ3BELHNCQUFjLEdBQVksZ0JBQWdCLENBQUM7QUFDM0MsWUFBSSxHQUFzQixTQUFTLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IFV0aWxzIGZyb20gXCIuL3V0aWxzL1V0aWxzXCI7XG5pbXBvcnQgT1dlYkV2ZW50IGZyb20gXCIuL09XZWJFdmVudFwiO1xuaW1wb3J0IE9XZWJBcHAgZnJvbSBcIi4vT1dlYkFwcFwiO1xuaW1wb3J0IE9XZWJGUyBmcm9tIFwiLi9PV2ViRlNcIjtcbmltcG9ydCBqcVhIUiA9IEpRdWVyeS5qcVhIUjtcblxuZXhwb3J0IHR5cGUgdENvbVJlc3BvbnNlID0ge1xuXHRlcnJvcjogbnVtYmVyLFxuXHRtc2c6IHN0cmluZyxcblx0ZGF0YT86IGFueSxcblx0dXRpbWU6IG51bWJlcixcblx0c3RpbWU/OiBudW1iZXIsXG5cdG5ldGVycm9yPzogYm9vbGVhblxufTtcblxuZXhwb3J0IHR5cGUgdENvbU9wdGlvbnMgPSB7XG5cdHVybDogc3RyaW5nLFxuXHRtZXRob2Q6IHN0cmluZyxcblx0eGhyPzogYW55LFxuXHRoZWFkZXJzPzoge30sXG5cdGRhdGE/OiB7fSxcblx0ZGF0YVR5cGU/OiBzdHJpbmcsXG5cdGNyb3NzRG9tYWluPzogYm9vbGVhbixcblx0cHJvY2Vzc0RhdGE/OiBib29sZWFuLFxuXHRjb250ZW50VHlwZT86IGFueSxcblx0YmFkTmV3c1Nob3c/OiBib29sZWFuLFxuXHR0aW1lb3V0PzogbnVtYmVyXG59O1xuY29uc3QgZmlsZV9hbGlhc19lcnJvcnMgICAgICAgICAgICA9IFtcblx0XHQgIFwiT1pfRklMRV9BTElBU19VTktOT1dOXCIsXG5cdFx0ICBcIk9aX0ZJTEVfQUxJQVNfTk9UX0ZPVU5EXCIsXG5cdFx0ICBcIk9aX0ZJTEVfQUxJQVNfUEFSU0VfRVJST1JcIlxuXHQgIF0sXG5cdCAgZGVmYXVsdF9vcHRpb25zOiB0Q29tT3B0aW9ucyA9IHtcblx0XHQgIHVybCAgICAgICAgOiBcIlwiLFxuXHRcdCAgbWV0aG9kICAgICA6IFwiR0VUXCIsXG5cdFx0ICBkYXRhICAgICAgIDoge30sXG5cdFx0ICBkYXRhVHlwZSAgIDogXCJqc29uXCIsXG5cdFx0ICBjcm9zc0RvbWFpbjogdHJ1ZSxcblx0XHQgIGJhZE5ld3NTaG93OiBmYWxzZSxcblx0XHQgIC8vIGluY3JlYXNlIHJlcXVlc3QgdGltZW91dCBmb3IgbW9iaWxlIGRldmljZVxuXHRcdCAgLy8gVE9ETzogZmluZCBhIGdvb2Qgd2F5IHRvIGNoZWNrIGlmIG1vYmlsZSBkZXZpY2Vcblx0XHQgIHRpbWVvdXQgICAgOiAoXCJjb3Jkb3ZhXCIgaW4gd2luZG93ID8gMTAwMDAgOiB1bmRlZmluZWQpXG5cdCAgfTtcblxubGV0IHNlYXJjaEFuZFJlcGxhY2VNYXJrZWRGaWxlID0gZnVuY3Rpb24gKGRhdGE/OiB7IFtrZXk6IHN0cmluZ106IGFueSB9IHwgRm9ybURhdGEpIHtcblx0bGV0IGZvcm1fZGF0YSAgICAgICA9IG5ldyBGb3JtRGF0YSgpLFxuXHRcdGhhc19tYXJrZWRfZmlsZSA9IGZhbHNlLFxuXHRcdGNoZWNrICAgICAgICAgICA9ICh2YWx1ZTogYW55LCBuYW1lOiBzdHJpbmcpID0+IHtcblx0XHRcdGxldCB2ID0gdmFsdWU7XG5cblx0XHRcdGlmIChPV2ViRlMuaXNNYXJrZWRGaWxlKHYpKSB7XG5cdFx0XHRcdHYgICAgICAgICAgICAgICA9IE9XZWJGUy5jcmVhdGVGaWxlQWxpYXModik7XG5cdFx0XHRcdGhhc19tYXJrZWRfZmlsZSA9IHRydWU7XG5cdFx0XHR9XG5cblx0XHRcdGZvcm1fZGF0YS5hcHBlbmQobmFtZSwgdik7XG5cdFx0fTtcblxuXHRpZiAoZGF0YSkge1xuXHRcdGlmIChkYXRhIGluc3RhbmNlb2YgRm9ybURhdGEpIHtcblx0XHRcdChkYXRhIGFzIGFueSkuZm9yRWFjaChjaGVjayk7XG5cdFx0fSBlbHNlIGlmIChVdGlscy5pc1BsYWluT2JqZWN0KGRhdGEpKSB7XG5cdFx0XHRPYmplY3Qua2V5cyhkYXRhKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXlfbmFtZSkge1xuXHRcdFx0XHRjaGVjayhkYXRhW2tleV9uYW1lXSwga2V5X25hbWUpO1xuXHRcdFx0fSk7XG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIGhhc19tYXJrZWRfZmlsZSA/IGZvcm1fZGF0YSA6IGZhbHNlO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT1dlYkNvbSBleHRlbmRzIE9XZWJFdmVudCB7XG5cblx0c3RhdGljIHJlYWRvbmx5IEVWVF9DT01fUkVRVUVTVF9TVUNDRVNTID0gXCJPV2ViQ29tOnN1Y2Nlc3NcIjtcblx0c3RhdGljIHJlYWRvbmx5IEVWVF9DT01fUkVRVUVTVF9FUlJPUiAgID0gXCJPV2ViQ29tOmVycm9yXCI7XG5cdHN0YXRpYyByZWFkb25seSBFVlRfQ09NX05FVFdPUktfRVJST1IgICA9IFwiT1dlYkNvbTpuZXRfZXJyb3JcIjtcblx0c3RhdGljIHJlYWRvbmx5IEVWVF9DT01fVVBMT0FEX1BST0dSRVNTID0gXCJPV2ViQ29tOnVwbG9hZF9wcm9ncmVzc1wiO1xuXHRzdGF0aWMgcmVhZG9ubHkgRVZUX0NPTV9GSU5JU0ggICAgICAgICAgPSBcIk9XZWJDb206ZmluaXNoXCI7XG5cdHN0YXRpYyByZWFkb25seSBTRUxGICAgICAgICAgICAgICAgICAgICA9IFwiT1dlYkNvbVwiO1xuXG5cdHByaXZhdGUgcmVhZG9ubHkgX29wdGlvbnM6IHRDb21PcHRpb25zO1xuXHRwcml2YXRlIHJlYWRvbmx5IF9vcmlnaW5hbF9kYXRhOiBhbnk7XG5cdHByaXZhdGUgX21vZGlmaWVkX2RhdGE6IEZvcm1EYXRhIHwgYm9vbGVhbjtcblx0cHJpdmF0ZSBfYnVzeTogYm9vbGVhbiA9IGZhbHNlO1xuXHRwcml2YXRlIF9yZXF1ZXN0PzoganFYSFI7XG5cblx0Y29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhcHBfY29udGV4dDogT1dlYkFwcCwgb3B0aW9uczogdENvbU9wdGlvbnMpIHtcblx0XHRzdXBlcigpO1xuXG5cdFx0aWYgKG9wdGlvbnMgJiYgIVV0aWxzLmlzUGxhaW5PYmplY3Qob3B0aW9ucykpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoYFtPV2ViQ29tXSByZXF1aXJlIGFuICdvYmplY3QnIGFzIG9wdGlvbnMgbm90OiAgJHt0eXBlb2Ygb3B0aW9uc30uYCk7XG5cdFx0fVxuXG5cdFx0dGhpcy5fb3B0aW9ucyAgICAgICA9IFV0aWxzLmFzc2lnbih7fSwgZGVmYXVsdF9vcHRpb25zLCBvcHRpb25zIHx8IHt9KTtcblx0XHR0aGlzLl9vcmlnaW5hbF9kYXRhID0gb3B0aW9ucy5kYXRhIHx8IHt9O1xuXHRcdHRoaXMuX21vZGlmaWVkX2RhdGEgPSBzZWFyY2hBbmRSZXBsYWNlTWFya2VkRmlsZShvcHRpb25zLmRhdGEpO1xuXG5cdFx0aWYgKHRoaXMuX21vZGlmaWVkX2RhdGEpIHtcblx0XHRcdHRoaXMuX29wdGlvbnMuZGF0YSA9IHRoaXMuX21vZGlmaWVkX2RhdGE7XG5cdFx0fVxuXG5cdH1cblxuXHRwcml2YXRlIF9pbml0KCkge1xuXHRcdGxldCBtICAgICAgICAgICAgICAgICAgPSB0aGlzLFxuXHRcdFx0cmVhbF9tZXRob2QgICAgICAgID0gbS5fb3B0aW9ucy5tZXRob2QsXG5cdFx0XHRyZXBsYWNlX21ldGhvZHMgICAgPSBbXCJQQVRDSFwiLCBcIlBVVFwiLCBcIkRFTEVURVwiXSxcblx0XHRcdGFwaV9rZXlfaGVhZGVyICAgICA9IHRoaXMuYXBwX2NvbnRleHQuY29uZmlncy5nZXQoXCJPWl9BUElfS0VZX0hFQURFUl9OQU1FXCIpLFxuXHRcdFx0cmVhbF9tZXRob2RfaGVhZGVyID0gdGhpcy5hcHBfY29udGV4dC5jb25maWdzLmdldChcIk9aX0FQSV9SRUFMX01FVEhPRF9IRUFERVJfTkFNRVwiKTtcblxuXHRcdGxldCBoZWFkZXJzOiBhbnkgPSB0aGlzLl9vcHRpb25zLmhlYWRlcnMgPSB0aGlzLl9vcHRpb25zLmhlYWRlcnMgfHwge307XG5cdFx0aGVhZGVyc1thcGlfa2V5X2hlYWRlcl0gPSB0aGlzLmFwcF9jb250ZXh0LmNvbmZpZ3MuZ2V0KFwiT1pfQVBJX0tFWVwiKTtcblxuXHRcdC8vIHVwZGF0ZSByZXF1ZXN0IG1ldGhvZFxuXHRcdGlmICh+cmVwbGFjZV9tZXRob2RzLmluZGV4T2YocmVhbF9tZXRob2QpKSB7XG5cdFx0XHRoZWFkZXJzW3JlYWxfbWV0aG9kX2hlYWRlcl0gPSByZWFsX21ldGhvZDtcblx0XHRcdHRoaXMuX29wdGlvbnMubWV0aG9kICAgICAgICA9IFwiUE9TVFwiO1xuXHRcdH1cblxuXHRcdGlmICh0aGlzLl9vcHRpb25zLmRhdGEgaW5zdGFuY2VvZiBGb3JtRGF0YSkge1xuXHRcdFx0dGhpcy5fb3B0aW9ucy5wcm9jZXNzRGF0YSA9IGZhbHNlO1xuXHRcdFx0dGhpcy5fb3B0aW9ucy5jb250ZW50VHlwZSA9IGZhbHNlO1xuXHRcdH1cblxuXHRcdC8vIHdvcmthcm91bmQgYmVjYXVzZSBqcVhIUiBkb2VzIG5vdCBleHBvc2UgdXBsb2FkIHByb3BlcnR5XG5cdFx0dGhpcy5fb3B0aW9ucy54aHIgPSBmdW5jdGlvbiAoKSB7XG5cdFx0XHRsZXQgeGhyID0gJC5hamF4U2V0dGluZ3MueGhyISgpO1xuXG5cdFx0XHQvLyBhbGxvdyBDT1JTXG5cdFx0XHR4aHIud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTtcblxuXHRcdFx0aWYgKHhoci51cGxvYWQpIHtcblx0XHRcdFx0eGhyLnVwbG9hZC5hZGRFdmVudExpc3RlbmVyKFwicHJvZ3Jlc3NcIiwgKGU6IGFueSkgPT4ge1xuXHRcdFx0XHRcdGxldCBwZXJjZW50ICA9IDA7XG5cdFx0XHRcdFx0bGV0IHBvc2l0aW9uID0gZS5sb2FkZWQgfHwgZS5wb3NpdGlvbjsvLyBlLnBvc2l0aW9uXG5cdFx0XHRcdFx0bGV0IHRvdGFsICAgID0gZS50b3RhbDtcblxuXHRcdFx0XHRcdGlmIChlLmxlbmd0aENvbXB1dGFibGUpIHtcblx0XHRcdFx0XHRcdHBlcmNlbnQgPSBNYXRoLmZsb29yKHBvc2l0aW9uIC8gdG90YWwgKiAxMDApO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdG0udHJpZ2dlcihPV2ViQ29tLkVWVF9DT01fVVBMT0FEX1BST0dSRVNTLCBbZSwgcG9zaXRpb24sIHRvdGFsLCBwZXJjZW50XSk7XG5cblx0XHRcdFx0fSwgZmFsc2UpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4geGhyO1xuXHRcdH07XG5cdH1cblxuXHQvLyB0aGUgY29ubmVjdGlvbiB0byB0aGUgc2VydmVyIHdhcyBzdWNjZXNzZnVsbHkgZXN0YWJsaXNoZWRcblx0cHJpdmF0ZSBfaGFuZGxlUmVzcG9uc2UocmVzcG9uc2U6IHRDb21SZXNwb25zZSkge1xuXHRcdGxldCBtID0gdGhpcztcblxuXHRcdGlmIChyZXNwb25zZS5zdGltZSkge1xuXHRcdFx0bS5hcHBfY29udGV4dC51c2VyLnNldFNlc3Npb25FeHBpcmUocmVzcG9uc2Uuc3RpbWUpO1xuXHRcdH1cblxuXHRcdGlmIChyZXNwb25zZS5lcnJvciA9PT0gMCkge1xuXHRcdFx0bS50cmlnZ2VyKE9XZWJDb20uRVZUX0NPTV9SRVFVRVNUX1NVQ0NFU1MsIFtyZXNwb25zZSwgbV0pO1xuXHRcdFx0bS50cmlnZ2VyKE9XZWJDb20uRVZUX0NPTV9GSU5JU0gsIFtyZXNwb25zZSwgbV0pO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRpZiAocmVzcG9uc2UubXNnID09PSBcIk9aX0VSUk9SX1lPVV9NVVNUX0xPR0lOXCIpIHtcblx0XHRcdFx0bS5hcHBfY29udGV4dC5mb3JjZUxvZ2luKCk7XG5cdFx0XHR9IGVsc2UgaWYgKH5maWxlX2FsaWFzX2Vycm9ycy5pbmRleE9mKHJlc3BvbnNlLm1zZykpIHtcblx0XHRcdFx0Ly8gb3VyIGF0dGVtcHQgdG8gbWluaW1pemUgZmlsZSB1cGxvYWQgZmFpbGVkXG5cdFx0XHRcdGNvbnNvbGUud2FybihcIltPV2ViQ29tXSB1bmFibGUgdG8gbWluaW1pemUgZmlsZSB1cGxvYWQgZGF0YSAtPlwiLCByZXNwb25zZSwgbS5fb3B0aW9ucy5kYXRhKTtcblx0XHRcdFx0dGhpcy5fbW9kaWZpZWRfZGF0YSA9IGZhbHNlO1xuXHRcdFx0XHR0aGlzLl9vcHRpb25zLmRhdGEgID0gdGhpcy5fb3JpZ2luYWxfZGF0YTtcblx0XHRcdFx0bS5fYnVzeSAgICAgICAgICAgICA9IGZhbHNlO1xuXHRcdFx0XHRtLnNlbmQoKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGlmIChtLl9vcHRpb25zLmJhZE5ld3NTaG93KSB7XG5cdFx0XHRcdFx0bS5hcHBfY29udGV4dC52aWV3LmRpYWxvZyh7XG5cdFx0XHRcdFx0XHR0eXBlOiBcImVycm9yXCIsXG5cdFx0XHRcdFx0XHR0ZXh0OiByZXNwb25zZS5tc2csXG5cdFx0XHRcdFx0XHRkYXRhOiByZXNwb25zZS5kYXRhXG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRtLnRyaWdnZXIoT1dlYkNvbS5FVlRfQ09NX1JFUVVFU1RfRVJST1IsIFtyZXNwb25zZSwgbV0pO1xuXHRcdFx0XHRtLnRyaWdnZXIoT1dlYkNvbS5FVlRfQ09NX0ZJTklTSCwgW3Jlc3BvbnNlLCBtXSk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG5cblx0c2VuZCgpIHtcblx0XHRsZXQgbSA9IHRoaXM7XG5cdFx0dGhpcy5faW5pdCgpO1xuXG5cdFx0aWYgKHRoaXMuX2J1c3kpIHtcblx0XHRcdGNvbnNvbGUud2FybihcIltPV2ViQ29tXSBpbnN0YW5jZSBpcyBidXN5IC0+XCIsIG0pO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGlmICh0aGlzLl9vcHRpb25zKSB7XG5cdFx0XHR0aGlzLl9idXN5ICAgID0gdHJ1ZTtcblx0XHRcdHRoaXMuX3JlcXVlc3QgPSAkLmFqYXgobS5fb3B0aW9ucylcblx0XHRcdFx0LmRvbmUoKHJlc3BvbnNlOiBhbnkpID0+IHtcblx0XHRcdFx0XHRtLl9oYW5kbGVSZXNwb25zZShyZXNwb25zZSk7XG5cdFx0XHRcdH0pXG5cdFx0XHRcdC5mYWlsKChyZXF1ZXN0OiBhbnkpID0+IHtcblx0XHRcdFx0XHRsZXQgbmV0d29ya19lcnJvciA9ICFVdGlscy5pc1BsYWluT2JqZWN0KFxuXHRcdFx0XHRcdFx0cmVxdWVzdFtcInJlc3BvbnNlSlNPTlwiXSk7XG5cdFx0XHRcdFx0aWYgKG5ldHdvcmtfZXJyb3IpIHtcblx0XHRcdFx0XHRcdGNvbnNvbGUuZXJyb3IoXCJbT1dlYkNvbV0gcmVxdWVzdCBuZXR3b3JrIGVycm9yIC0+XCIsIHJlcXVlc3QpO1xuXHRcdFx0XHRcdFx0bS50cmlnZ2VyKE9XZWJDb20uRVZUX0NPTV9ORVRXT1JLX0VSUk9SLCBbcmVxdWVzdCwgbV0pO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRjb25zb2xlLmVycm9yKFwiW09XZWJDb21dIHJlcXVlc3Qgc2VydmVyIGVycm9yIC0+XCIsIHJlcXVlc3QpO1xuXHRcdFx0XHRcdFx0bS5faGFuZGxlUmVzcG9uc2UocmVxdWVzdFtcInJlc3BvbnNlSlNPTlwiXSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblx0XHR9XG5cdH1cblxuXHRhYm9ydCgpIHtcblx0XHR0aGlzLl9idXN5ID0gZmFsc2U7XG5cdFx0aWYgKHRoaXMuX3JlcXVlc3QpIHtcblx0XHRcdHRoaXMuX3JlcXVlc3QuYWJvcnQoKTtcblx0XHR9XG5cdH1cbn0iXX0=