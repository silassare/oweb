import OWebCom from './OWebCom';
import OWebConfigs from './OWebConfigs';
import OWebCurrentUser from './OWebCurrentUser';
import OWebDataStore from './OWebDataStore';
import OWebEvent from './OWebEvent';
import OWebFormValidator from './OWebFormValidator';
import OWebRouter from './OWebRouter';
import OWebUrl from './OWebUrl';
import OWebView from './OWebView';
import OWebDate from './plugins/OWebDate';
import Utils from './utils/Utils';
import OWebI18n from './OWebI18n';
import OWebPager from './OWebPager';
/**
 * @ignore
 */
const noop = () => { };
const requestDefaultOptions = {
    headers: {},
};
export default class OWebApp extends OWebEvent {
    /**
     * OWebApp constructor.
     *
     * @param name The app name.
     * @param configs The app config.
     * @param urls The app url list.
     * @param state The app state.
     */
    constructor(name, configs, urls) {
        super();
        this.name = name;
        this.ls = new OWebDataStore(this);
        this.configs = new OWebConfigs(this, configs);
        this.url = new OWebUrl(this, urls);
        this.user = new OWebCurrentUser(this);
        this.view = new OWebView();
        this.pager = new OWebPager(this);
        this.i18n = new OWebI18n();
        let base_url = this.configs.get('OW_APP_LOCAL_BASE_URL'), hash_mode = false !== this.configs.get('OW_APP_ROUTER_HASH_MODE');
        this.router = new OWebRouter(base_url, hash_mode);
        this.router.notFound(this.showNotFound.bind(this));
        this.i18n.setDefaultLang(this.configs.get('OW_APP_DEFAULT_LANG'));
        let api_key_header = this.configs.get('OZ_API_KEY_HEADER_NAME');
        requestDefaultOptions.headers = {
            [api_key_header]: this.configs.get('OZ_API_KEY'),
        };
    }
    /**
     * Get request default options
     */
    getRequestDefaultOptions() {
        return Utils.copy(requestDefaultOptions);
    }
    /**
     * Set session token
     */
    setSessionToken(token) {
        let header_name = this.configs.get('OZ_SESSION_TOKEN_HEADER_NAME');
        if (header_name && token) {
            requestDefaultOptions.headers[header_name] = token;
        }
        return this;
    }
    /**
     * App name getter.
     */
    getAppName() {
        return this.name;
    }
    /**
     * Checks if we are running in mobile app.
     */
    isMobileApp() {
        return 'cordova' in window;
    }
    /**
     * To start the web app.
     */
    start() {
        console.log('[OWebApp] app started!');
        this.trigger(OWebApp.EVT_APP_READY);
        return this;
    }
    /**
     * Returns new form validator instance.
     *
     * @param form The html form element.
     * @param required The required fields names list.
     * @param excluded The fields names to exclude.
     * @param checkAll Force the validator to check all fields.
     */
    getFormValidator(form, required = [], excluded = [], checkAll = false) {
        return new OWebFormValidator(this, form, required, excluded, checkAll);
    }
    /**
     * Force login.
     *
     * > This will clear all saved data in the local storage.
     */
    forceLogin() {
        this.ls.clear();
        this.showLoginPage();
    }
    /**
     * Reload the app.
     */
    reloadApp() {
        // TODO: instead of reloading the current location, find a way to browse to web app entry point
        // for android & ios restart the app
        // window.location.reload(true);
        this.showHomePage();
    }
    /**
     * Destroy the app.
     *
     * > This will clear all saved data in the local storage.
     */
    destroyApp() {
        // erase data
        this.ls.clear();
        this.reloadApp();
    }
    /**
     * Close app.
     */
    closeApp() {
        // cordova
        if (window.navigator && window.navigator.app) {
            window.navigator.app.exitApp();
        }
        else {
            window.close();
        }
    }
    /**
     * Checks if user session is active.
     */
    sessionActive() {
        let now = new Date().getTime(); // milliseconds
        let hour = 60 * 60; // seconds
        let expire = this.user.getSessionExpire() - hour; // seconds
        return expire * 1000 > now;
    }
    /**
     * Checks if the current user has been authenticated.
     */
    userVerified() {
        return Boolean(this.user.getCurrentUser() && this.sessionActive());
    }
    /**
     * Send request and return promise.
     *
     * @param method The request method.
     * @param url The request url.
     * @param data The request payload.
     * @param freeze Force app view to be frozen.
     */
    requestPromise(method, url, data, freeze = false) {
        let m = this;
        return new Promise(function (resolve, reject) {
            m.request(method, url, data, resolve, reject, freeze);
        });
    }
    /**
     * Send request.
     *
     * @param method The request method.
     * @param url The request url.
     * @param data The request payload.
     * @param success Request success callback.
     * @param fail Request fail callback.
     * @param freeze Force app view to be frozen.
     */
    request(method, url, data, success = noop, fail = noop, freeze = false) {
        let app = this;
        if (freeze) {
            app.view.freeze();
        }
        let options = {
            url: url,
            method: method,
            data: data,
            badNewsShow: false,
        };
        let com = new OWebCom(this, options);
        com.on(OWebCom.EVT_COM_REQUEST_SUCCESS, (response) => {
            // setTimeout(function () {
            if (freeze) {
                app.view.unfreeze();
            }
            success.call(com, response);
            // }, 1000);
        })
            .on(OWebCom.EVT_COM_REQUEST_ERROR, (response) => {
            if (response['msg'] === 'OZ_ERROR_YOU_ARE_NOT_ADMIN') {
                app.destroyApp();
            }
            if (freeze) {
                app.view.unfreeze();
            }
            fail.call(com, response);
        })
            .on(OWebCom.EVT_COM_NETWORK_ERROR, () => {
            if (freeze) {
                app.view.unfreeze();
            }
            let response = {
                error: 1,
                msg: 'OZ_ERROR_REQUEST_FAIL',
                utime: OWebDate.timestamp(),
            };
            response.neterror = true;
            fail.call(com, response);
        })
            .send();
        return com;
    }
    /**
     * Register handler for OWebApp.EVT_APP_READY event
     *
     * @param handler
     */
    onReady(handler) {
        return this.on(OWebApp.EVT_APP_READY, handler);
    }
}
OWebApp.SELF = Utils.id();
OWebApp.EVT_APP_READY = Utils.id();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkFwcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViQXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sT0FBeUIsTUFBTSxXQUFXLENBQUM7QUFDbEQsT0FBTyxXQUE0QixNQUFNLGVBQWUsQ0FBQztBQUN6RCxPQUFPLGVBQWUsTUFBTSxtQkFBbUIsQ0FBQztBQUNoRCxPQUFPLGFBQWEsTUFBTSxpQkFBaUIsQ0FBQztBQUM1QyxPQUFPLFNBQVMsTUFBTSxhQUFhLENBQUM7QUFDcEMsT0FBTyxpQkFBaUIsTUFBTSxxQkFBcUIsQ0FBQztBQUNwRCxPQUFPLFVBQTRCLE1BQU0sY0FBYyxDQUFDO0FBQ3hELE9BQU8sT0FBcUIsTUFBTSxXQUFXLENBQUM7QUFDOUMsT0FBTyxRQUFRLE1BQU0sWUFBWSxDQUFDO0FBQ2xDLE9BQU8sUUFBUSxNQUFNLG9CQUFvQixDQUFDO0FBQzFDLE9BQU8sS0FBSyxNQUFNLGVBQWUsQ0FBQztBQUNsQyxPQUFPLFFBQVEsTUFBTSxZQUFZLENBQUM7QUFDbEMsT0FBTyxTQUFTLE1BQU0sYUFBYSxDQUFDO0FBRXBDOztHQUVHO0FBQ0gsTUFBTSxJQUFJLEdBQUcsR0FBRyxFQUFFLEdBQUUsQ0FBQyxDQUFDO0FBRXRCLE1BQU0scUJBQXFCLEdBQVE7SUFDbEMsT0FBTyxFQUFFLEVBQUU7Q0FDWCxDQUFDO0FBRUYsTUFBTSxDQUFDLE9BQU8sT0FBZ0IsT0FBUSxTQUFRLFNBQVM7SUFhdEQ7Ozs7Ozs7T0FPRztJQUNILFlBQ2tCLElBQVksRUFDN0IsT0FBb0IsRUFDcEIsSUFBYztRQUVkLEtBQUssRUFBRSxDQUFDO1FBSlMsU0FBSSxHQUFKLElBQUksQ0FBUTtRQU03QixJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxXQUFXLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQzlD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LFFBQVEsQ0FBQyxDQUFDO1FBQzFCLENBQUMsQ0FBQzthQUNELEVBQUUsQ0FBQyxPQUFPLENBQUMscUJBQXFCLEVBQUUsR0FBRyxFQUFFO1lBQ3ZDLElBQUksTUFBTSxFQUFFO2dCQUNYLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7YUFDcEI7WUFDRCxJQUFJLFFBQVEsR0FBaUI7Z0JBQzVCLEtBQUssRUFBRSxDQUFDO2dCQUNSLEdBQUcsRUFBRSx1QkFBdUI7Z0JBQzVCLEtBQUssRUFBRSxRQUFRLENBQUMsU0FBUyxFQUFFO2FBQzNCLENBQUM7WUFFRixRQUFRLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztZQUV6QixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUMxQixDQUFDLENBQUM7YUFDRCxJQUFJLEVBQUUsQ0FBQztRQUVULE9BQU8sR0FBRyxDQUFDO0lBQ1osQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxPQUFPLENBQUMsT0FBdUM7UUFDOUMsT0FBTyxJQUFJLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDaEQsQ0FBQzs7QUE1UWUsWUFBSSxHQUFHLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUNsQixxQkFBYSxHQUFHLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBPV2ViQ29tLCB7IGlDb21SZXNwb25zZSB9IGZyb20gJy4vT1dlYkNvbSc7XG5pbXBvcnQgT1dlYkNvbmZpZ3MsIHsgdENvbmZpZ0xpc3QgfSBmcm9tICcuL09XZWJDb25maWdzJztcbmltcG9ydCBPV2ViQ3VycmVudFVzZXIgZnJvbSAnLi9PV2ViQ3VycmVudFVzZXInO1xuaW1wb3J0IE9XZWJEYXRhU3RvcmUgZnJvbSAnLi9PV2ViRGF0YVN0b3JlJztcbmltcG9ydCBPV2ViRXZlbnQgZnJvbSAnLi9PV2ViRXZlbnQnO1xuaW1wb3J0IE9XZWJGb3JtVmFsaWRhdG9yIGZyb20gJy4vT1dlYkZvcm1WYWxpZGF0b3InO1xuaW1wb3J0IE9XZWJSb3V0ZXIsIHsgdFJvdXRlVGFyZ2V0IH0gZnJvbSAnLi9PV2ViUm91dGVyJztcbmltcG9ydCBPV2ViVXJsLCB7IHRVcmxMaXN0IH0gZnJvbSAnLi9PV2ViVXJsJztcbmltcG9ydCBPV2ViVmlldyBmcm9tICcuL09XZWJWaWV3JztcbmltcG9ydCBPV2ViRGF0ZSBmcm9tICcuL3BsdWdpbnMvT1dlYkRhdGUnO1xuaW1wb3J0IFV0aWxzIGZyb20gJy4vdXRpbHMvVXRpbHMnO1xuaW1wb3J0IE9XZWJJMThuIGZyb20gJy4vT1dlYkkxOG4nO1xuaW1wb3J0IE9XZWJQYWdlciBmcm9tICcuL09XZWJQYWdlcic7XG5cbi8qKlxuICogQGlnbm9yZVxuICovXG5jb25zdCBub29wID0gKCkgPT4ge307XG5cbmNvbnN0IHJlcXVlc3REZWZhdWx0T3B0aW9uczogYW55ID0ge1xuXHRoZWFkZXJzOiB7fSxcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGFic3RyYWN0IGNsYXNzIE9XZWJBcHAgZXh0ZW5kcyBPV2ViRXZlbnQge1xuXHRzdGF0aWMgcmVhZG9ubHkgU0VMRiA9IFV0aWxzLmlkKCk7XG5cdHN0YXRpYyByZWFkb25seSBFVlRfQVBQX1JFQURZID0gVXRpbHMuaWQoKTtcblxuXHRyZWFkb25seSB2aWV3OiBPV2ViVmlldztcblx0cmVhZG9ubHkgcGFnZXI6IE9XZWJQYWdlcjxhbnk+O1xuXHRyZWFkb25seSBsczogT1dlYkRhdGFTdG9yZTtcblx0cmVhZG9ubHkgcm91dGVyOiBPV2ViUm91dGVyO1xuXHRyZWFkb25seSB1c2VyOiBPV2ViQ3VycmVudFVzZXI7XG5cdHJlYWRvbmx5IGNvbmZpZ3M6IE9XZWJDb25maWdzO1xuXHRyZWFkb25seSB1cmw6IE9XZWJVcmw7XG5cdHJlYWRvbmx5IGkxOG46IE9XZWJJMThuO1xuXG5cdC8qKlxuXHQgKiBPV2ViQXBwIGNvbnN0cnVjdG9yLlxuXHQgKlxuXHQgKiBAcGFyYW0gbmFtZSBUaGUgYXBwIG5hbWUuXG5cdCAqIEBwYXJhbSBjb25maWdzIFRoZSBhcHAgY29uZmlnLlxuXHQgKiBAcGFyYW0gdXJscyBUaGUgYXBwIHVybCBsaXN0LlxuXHQgKiBAcGFyYW0gc3RhdGUgVGhlIGFwcCBzdGF0ZS5cblx0ICovXG5cdHByb3RlY3RlZCBjb25zdHJ1Y3Rvcihcblx0XHRwcml2YXRlIHJlYWRvbmx5IG5hbWU6IHN0cmluZyxcblx0XHRjb25maWdzOiB0Q29uZmlnTGlzdCxcblx0XHR1cmxzOiB0VXJsTGlzdFxuXHQpIHtcblx0XHRzdXBlcigpO1xuXG5cdFx0dGhpcy5scyA9IG5ldyBPV2ViRGF0YVN0b3JlKHRoaXMpO1xuXHRcdHRoaXMuY29uZmlncyA9IG5ldyBPV2ViQ29uZmlncyh0aGlzLCBjb25maWdzKTtcblx0XHR0aGlzLnVybCA9IG5ldyBPV2ViVXJsKHRoaXMsIHVybHMpO1xuXHRcdHRoaXMudXNlciA9IG5ldyBPV2ViQ3VycmVudFVzZXIodGhpcyk7XG5cdFx0dGhpcy52aWV3ID0gbmV3IE9XZWJWaWV3KCk7XG5cdFx0dGhpcy5wYWdlciA9IG5ldyBPV2ViUGFnZXIodGhpcyk7XG5cdFx0dGhpcy5pMThuID0gbmV3IE9XZWJJMThuKCk7XG5cblx0XHRsZXQgYmFzZV91cmwgPSB0aGlzLmNvbmZpZ3MuZ2V0KCdPV19BUFBfTE9DQUxfQkFTRV9VUkwnKSxcblx0XHRcdGhhc2hfbW9kZSA9IGZhbHNlICE9PSB0aGlzLmNvbmZpZ3MuZ2V0KCdPV19BUFBfUk9VVEVSX0hBU0hfTU9ERScpO1xuXG5cdFx0dGhpcy5yb3V0ZXIgPSBuZXcgT1dlYlJvdXRlcihiYXNlX3VybCwgaGFzaF9tb2RlKTtcblxuXHRcdHRoaXMucm91dGVyLm5vdEZvdW5kKHRoaXMuc2hvd05vdEZvdW5kLmJpbmQodGhpcykpO1xuXG5cdFx0dGhpcy5pMThuLnNldERlZmF1bHRMYW5nKHRoaXMuY29uZmlncy5nZXQoJ09XX0FQUF9ERUZBVUxUX0xBTkcnKSk7XG5cblx0XHRsZXQgYXBpX2tleV9oZWFkZXIgPSB0aGlzLmNvbmZpZ3MuZ2V0KCdPWl9BUElfS0VZX0hFQURFUl9OQU1FJyk7XG5cdFx0cmVxdWVzdERlZmF1bHRPcHRpb25zLmhlYWRlcnMgPSB7XG5cdFx0XHRbYXBpX2tleV9oZWFkZXJdOiB0aGlzLmNvbmZpZ3MuZ2V0KCdPWl9BUElfS0VZJyksXG5cdFx0fTtcblx0fVxuXG5cdC8qKlxuXHQgKiBHZXQgcmVxdWVzdCBkZWZhdWx0IG9wdGlvbnNcblx0ICovXG5cdGdldFJlcXVlc3REZWZhdWx0T3B0aW9ucygpIHtcblx0XHRyZXR1cm4gVXRpbHMuY29weShyZXF1ZXN0RGVmYXVsdE9wdGlvbnMpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFNldCBzZXNzaW9uIHRva2VuXG5cdCAqL1xuXHRzZXRTZXNzaW9uVG9rZW4odG9rZW46IHN0cmluZykge1xuXHRcdGxldCBoZWFkZXJfbmFtZSA9IHRoaXMuY29uZmlncy5nZXQoJ09aX1NFU1NJT05fVE9LRU5fSEVBREVSX05BTUUnKTtcblxuXHRcdGlmIChoZWFkZXJfbmFtZSAmJiB0b2tlbikge1xuXHRcdFx0cmVxdWVzdERlZmF1bHRPcHRpb25zLmhlYWRlcnNbaGVhZGVyX25hbWVdID0gdG9rZW47XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogQXBwIG5hbWUgZ2V0dGVyLlxuXHQgKi9cblx0Z2V0QXBwTmFtZSgpOiBzdHJpbmcge1xuXHRcdHJldHVybiB0aGlzLm5hbWU7XG5cdH1cblxuXHQvKipcblx0ICogQ2hlY2tzIGlmIHdlIGFyZSBydW5uaW5nIGluIG1vYmlsZSBhcHAuXG5cdCAqL1xuXHRpc01vYmlsZUFwcCgpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gJ2NvcmRvdmEnIGluIHdpbmRvdztcblx0fVxuXG5cdC8qKlxuXHQgKiBUbyBzdGFydCB0aGUgd2ViIGFwcC5cblx0ICovXG5cdHN0YXJ0KCk6IHRoaXMge1xuXHRcdGNvbnNvbGUubG9nKCdbT1dlYkFwcF0gYXBwIHN0YXJ0ZWQhJyk7XG5cdFx0dGhpcy50cmlnZ2VyKE9XZWJBcHAuRVZUX0FQUF9SRUFEWSk7XG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyBuZXcgZm9ybSB2YWxpZGF0b3IgaW5zdGFuY2UuXG5cdCAqXG5cdCAqIEBwYXJhbSBmb3JtIFRoZSBodG1sIGZvcm0gZWxlbWVudC5cblx0ICogQHBhcmFtIHJlcXVpcmVkIFRoZSByZXF1aXJlZCBmaWVsZHMgbmFtZXMgbGlzdC5cblx0ICogQHBhcmFtIGV4Y2x1ZGVkIFRoZSBmaWVsZHMgbmFtZXMgdG8gZXhjbHVkZS5cblx0ICogQHBhcmFtIGNoZWNrQWxsIEZvcmNlIHRoZSB2YWxpZGF0b3IgdG8gY2hlY2sgYWxsIGZpZWxkcy5cblx0ICovXG5cdGdldEZvcm1WYWxpZGF0b3IoXG5cdFx0Zm9ybTogSFRNTEZvcm1FbGVtZW50LFxuXHRcdHJlcXVpcmVkOiBBcnJheTxzdHJpbmc+ID0gW10sXG5cdFx0ZXhjbHVkZWQ6IEFycmF5PHN0cmluZz4gPSBbXSxcblx0XHRjaGVja0FsbDogYm9vbGVhbiA9IGZhbHNlXG5cdCkge1xuXHRcdHJldHVybiBuZXcgT1dlYkZvcm1WYWxpZGF0b3IodGhpcywgZm9ybSwgcmVxdWlyZWQsIGV4Y2x1ZGVkLCBjaGVja0FsbCk7XG5cdH1cblxuXHQvKipcblx0ICogRm9yY2UgbG9naW4uXG5cdCAqXG5cdCAqID4gVGhpcyB3aWxsIGNsZWFyIGFsbCBzYXZlZCBkYXRhIGluIHRoZSBsb2NhbCBzdG9yYWdlLlxuXHQgKi9cblx0Zm9yY2VMb2dpbigpIHtcblx0XHR0aGlzLmxzLmNsZWFyKCk7XG5cdFx0dGhpcy5zaG93TG9naW5QYWdlKCk7XG5cdH1cblxuXHQvKipcblx0ICogUmVsb2FkIHRoZSBhcHAuXG5cdCAqL1xuXHRyZWxvYWRBcHAoKSB7XG5cdFx0Ly8gVE9ETzogaW5zdGVhZCBvZiByZWxvYWRpbmcgdGhlIGN1cnJlbnQgbG9jYXRpb24sIGZpbmQgYSB3YXkgdG8gYnJvd3NlIHRvIHdlYiBhcHAgZW50cnkgcG9pbnRcblx0XHQvLyBmb3IgYW5kcm9pZCAmIGlvcyByZXN0YXJ0IHRoZSBhcHBcblx0XHQvLyB3aW5kb3cubG9jYXRpb24ucmVsb2FkKHRydWUpO1xuXHRcdHRoaXMuc2hvd0hvbWVQYWdlKCk7XG5cdH1cblxuXHQvKipcblx0ICogRGVzdHJveSB0aGUgYXBwLlxuXHQgKlxuXHQgKiA+IFRoaXMgd2lsbCBjbGVhciBhbGwgc2F2ZWQgZGF0YSBpbiB0aGUgbG9jYWwgc3RvcmFnZS5cblx0ICovXG5cdGRlc3Ryb3lBcHAoKSB7XG5cdFx0Ly8gZXJhc2UgZGF0YVxuXHRcdHRoaXMubHMuY2xlYXIoKTtcblx0XHR0aGlzLnJlbG9hZEFwcCgpO1xuXHR9XG5cblx0LyoqXG5cdCAqIENsb3NlIGFwcC5cblx0ICovXG5cdGNsb3NlQXBwKCkge1xuXHRcdC8vIGNvcmRvdmFcblx0XHRpZiAod2luZG93Lm5hdmlnYXRvciAmJiAod2luZG93Lm5hdmlnYXRvciBhcyBhbnkpLmFwcCkge1xuXHRcdFx0KHdpbmRvdy5uYXZpZ2F0b3IgYXMgYW55KS5hcHAuZXhpdEFwcCgpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR3aW5kb3cuY2xvc2UoKTtcblx0XHR9XG5cdH1cblxuXHQvKipcblx0ICogQ2hlY2tzIGlmIHVzZXIgc2Vzc2lvbiBpcyBhY3RpdmUuXG5cdCAqL1xuXHRzZXNzaW9uQWN0aXZlKCk6IGJvb2xlYW4ge1xuXHRcdGxldCBub3cgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsgLy8gbWlsbGlzZWNvbmRzXG5cdFx0bGV0IGhvdXIgPSA2MCAqIDYwOyAvLyBzZWNvbmRzXG5cdFx0bGV0IGV4cGlyZSA9IHRoaXMudXNlci5nZXRTZXNzaW9uRXhwaXJlKCkgLSBob3VyOyAvLyBzZWNvbmRzXG5cdFx0cmV0dXJuIGV4cGlyZSAqIDEwMDAgPiBub3c7XG5cdH1cblxuXHQvKipcblx0ICogQ2hlY2tzIGlmIHRoZSBjdXJyZW50IHVzZXIgaGFzIGJlZW4gYXV0aGVudGljYXRlZC5cblx0ICovXG5cdHVzZXJWZXJpZmllZCgpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gQm9vbGVhbih0aGlzLnVzZXIuZ2V0Q3VycmVudFVzZXIoKSAmJiB0aGlzLnNlc3Npb25BY3RpdmUoKSk7XG5cdH1cblxuXHQvKipcblx0ICogU2VuZCByZXF1ZXN0IGFuZCByZXR1cm4gcHJvbWlzZS5cblx0ICpcblx0ICogQHBhcmFtIG1ldGhvZCBUaGUgcmVxdWVzdCBtZXRob2QuXG5cdCAqIEBwYXJhbSB1cmwgVGhlIHJlcXVlc3QgdXJsLlxuXHQgKiBAcGFyYW0gZGF0YSBUaGUgcmVxdWVzdCBwYXlsb2FkLlxuXHQgKiBAcGFyYW0gZnJlZXplIEZvcmNlIGFwcCB2aWV3IHRvIGJlIGZyb3plbi5cblx0ICovXG5cdHJlcXVlc3RQcm9taXNlKFxuXHRcdG1ldGhvZDogc3RyaW5nLFxuXHRcdHVybDogc3RyaW5nLFxuXHRcdGRhdGE6IGFueSxcblx0XHRmcmVlemU6IGJvb2xlYW4gPSBmYWxzZVxuXHQpOiBQcm9taXNlPGlDb21SZXNwb25zZT4ge1xuXHRcdGxldCBtID0gdGhpcztcblx0XHRyZXR1cm4gbmV3IFByb21pc2U8aUNvbVJlc3BvbnNlPihmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcblx0XHRcdG0ucmVxdWVzdChtZXRob2QsIHVybCwgZGF0YSwgcmVzb2x2ZSwgcmVqZWN0LCBmcmVlemUpO1xuXHRcdH0pO1xuXHR9XG5cblx0LyoqXG5cdCAqIFNlbmQgcmVxdWVzdC5cblx0ICpcblx0ICogQHBhcmFtIG1ldGhvZCBUaGUgcmVxdWVzdCBtZXRob2QuXG5cdCAqIEBwYXJhbSB1cmwgVGhlIHJlcXVlc3QgdXJsLlxuXHQgKiBAcGFyYW0gZGF0YSBUaGUgcmVxdWVzdCBwYXlsb2FkLlxuXHQgKiBAcGFyYW0gc3VjY2VzcyBSZXF1ZXN0IHN1Y2Nlc3MgY2FsbGJhY2suXG5cdCAqIEBwYXJhbSBmYWlsIFJlcXVlc3QgZmFpbCBjYWxsYmFjay5cblx0ICogQHBhcmFtIGZyZWV6ZSBGb3JjZSBhcHAgdmlldyB0byBiZSBmcm96ZW4uXG5cdCAqL1xuXHRyZXF1ZXN0KFxuXHRcdG1ldGhvZDogc3RyaW5nLFxuXHRcdHVybDogc3RyaW5nLFxuXHRcdGRhdGE6IGFueSxcblx0XHRzdWNjZXNzOiAodGhpczogT1dlYkNvbSwgcmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4gdm9pZCA9IG5vb3AsXG5cdFx0ZmFpbDogKHRoaXM6IE9XZWJDb20sIHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHZvaWQgPSBub29wLFxuXHRcdGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlXG5cdCk6IE9XZWJDb20ge1xuXHRcdGxldCBhcHAgPSB0aGlzO1xuXG5cdFx0aWYgKGZyZWV6ZSkge1xuXHRcdFx0YXBwLnZpZXcuZnJlZXplKCk7XG5cdFx0fVxuXG5cdFx0bGV0IG9wdGlvbnMgPSB7XG5cdFx0XHR1cmw6IHVybCxcblx0XHRcdG1ldGhvZDogbWV0aG9kLFxuXHRcdFx0ZGF0YTogZGF0YSxcblx0XHRcdGJhZE5ld3NTaG93OiBmYWxzZSxcblx0XHR9O1xuXG5cdFx0bGV0IGNvbSA9IG5ldyBPV2ViQ29tKHRoaXMsIG9wdGlvbnMpO1xuXHRcdGNvbS5vbihPV2ViQ29tLkVWVF9DT01fUkVRVUVTVF9TVUNDRVNTLCAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0Ly8gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG5cdFx0XHRpZiAoZnJlZXplKSB7XG5cdFx0XHRcdGFwcC52aWV3LnVuZnJlZXplKCk7XG5cdFx0XHR9XG5cblx0XHRcdHN1Y2Nlc3MuY2FsbChjb20sIHJlc3BvbnNlKTtcblx0XHRcdC8vIH0sIDEwMDApO1xuXHRcdH0pXG5cdFx0XHQub24oT1dlYkNvbS5FVlRfQ09NX1JFUVVFU1RfRVJST1IsIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB7XG5cdFx0XHRcdGlmIChyZXNwb25zZVsnbXNnJ10gPT09ICdPWl9FUlJPUl9ZT1VfQVJFX05PVF9BRE1JTicpIHtcblx0XHRcdFx0XHRhcHAuZGVzdHJveUFwcCgpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0aWYgKGZyZWV6ZSkge1xuXHRcdFx0XHRcdGFwcC52aWV3LnVuZnJlZXplKCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRmYWlsLmNhbGwoY29tLCByZXNwb25zZSk7XG5cdFx0XHR9KVxuXHRcdFx0Lm9uKE9XZWJDb20uRVZUX0NPTV9ORVRXT1JLX0VSUk9SLCAoKSA9PiB7XG5cdFx0XHRcdGlmIChmcmVlemUpIHtcblx0XHRcdFx0XHRhcHAudmlldy51bmZyZWV6ZSgpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGxldCByZXNwb25zZTogaUNvbVJlc3BvbnNlID0ge1xuXHRcdFx0XHRcdGVycm9yOiAxLFxuXHRcdFx0XHRcdG1zZzogJ09aX0VSUk9SX1JFUVVFU1RfRkFJTCcsXG5cdFx0XHRcdFx0dXRpbWU6IE9XZWJEYXRlLnRpbWVzdGFtcCgpLFxuXHRcdFx0XHR9O1xuXG5cdFx0XHRcdHJlc3BvbnNlLm5ldGVycm9yID0gdHJ1ZTtcblxuXHRcdFx0XHRmYWlsLmNhbGwoY29tLCByZXNwb25zZSk7XG5cdFx0XHR9KVxuXHRcdFx0LnNlbmQoKTtcblxuXHRcdHJldHVybiBjb207XG5cdH1cblxuXHQvKipcblx0ICogUmVnaXN0ZXIgaGFuZGxlciBmb3IgT1dlYkFwcC5FVlRfQVBQX1JFQURZIGV2ZW50XG5cdCAqXG5cdCAqIEBwYXJhbSBoYW5kbGVyXG5cdCAqL1xuXHRvblJlYWR5KGhhbmRsZXI6ICh0aGlzOiB0aGlzKSA9PiB2b2lkIHwgYm9vbGVhbikge1xuXHRcdHJldHVybiB0aGlzLm9uKE9XZWJBcHAuRVZUX0FQUF9SRUFEWSwgaGFuZGxlcik7XG5cdH1cblxuXHQvKipcblx0ICogQ2FsbGVkIHdoZW4gYXBwIHNob3VsZCBzaG93IHRoZSBob21lIHBhZ2UuXG5cdCAqL1xuXHRhYnN0cmFjdCBzaG93SG9tZVBhZ2UoKTogdGhpcztcblxuXHQvKipcblx0ICogQ2FsbGVkIHdoZW4gdGhlIHJlcXVlc3RlZCByb3V0ZSB3YXMgbm90IGZvdW5kLlxuXHQgKi9cblx0YWJzdHJhY3Qgc2hvd05vdEZvdW5kKHRhcmdldDogdFJvdXRlVGFyZ2V0KTogdGhpcztcblxuXHQvKipcblx0ICogQ2FsbGVkIHdoZW4gYXBwIHNob3VsZCBzaG93IHRoZSBsb2dpbiBwYWdlLlxuXHQgKi9cblx0YWJzdHJhY3Qgc2hvd0xvZ2luUGFnZSgpOiB0aGlzO1xuXG5cdC8qKlxuXHQgKiBDYWxsZWQgd2hlbiBhcHAgc2hvdWxkIHNob3cgdGhlIHNpZ251cCBwYWdlLlxuXHQgKi9cblx0YWJzdHJhY3Qgc2hvd1NpZ25VcFBhZ2UoKTogdGhpcztcbn1cbiJdfQ==