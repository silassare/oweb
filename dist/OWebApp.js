import { OWebConfigs, OWebEvent, OWebCurrentUser, OWebView, OWebDataStore, OWebDate, OWebCom, OWebFormValidator, OWebUrl, OWebRouter } from "./oweb";
const noop = () => {
};
export default class OWebApp extends OWebEvent {
    constructor(app_name, app_config_list, app_url_list) {
        super();
        this.app_name = app_name;
        this.services = {};
        this.configs = new OWebConfigs(this, app_config_list);
        this.url = new OWebUrl(this, app_url_list);
        this.user = new OWebCurrentUser(this);
        this.view = new OWebView();
        let base_url = this.configs.get("OW_APP_LOCAL_BASE_URL"), hash_mode = false !== this.configs.get("OW_APP_ROUTER_HASH_MODE");
        this.router = new OWebRouter(base_url, hash_mode);
    }
    getAppName() {
        return this.app_name;
    }
    start() {
        console.log("[OWebApp] app started!");
        this.trigger(OWebApp.EVT_APP_READY);
    }
    getService(service_name) {
        return this.services[service_name];
    }
    registerService(service) {
        let service_name = service.getName();
        if (this.services[service_name]) {
            throw new Error(`A service with the name "${service_name}" already defined.`);
        }
        this.services[service_name] = service;
        return this;
    }
    getFormValidator(form, required = [], excluded = []) {
        return new OWebFormValidator(this, form, required, excluded);
    }
    forceLogin() {
        OWebDataStore.clear();
        this.reloadApp();
    }
    reloadApp() {
        // TODO: instead of reloading the current location, find a way to browse to web app entry point
        // for android & ios restart the app
        window.location.reload(true);
    }
    destroyApp() {
        // erase data
        OWebDataStore.clear();
        this.reloadApp();
    }
    sessionActive() {
        let now = (new Date()).getTime(); // milliseconds
        let hour = 60 * 60; // seconds
        let expire = this.user.getSessionExpire() - hour; // seconds
        return (expire * 1000) > now;
    }
    userVerified() {
        return this.user.getCurrentUser() && this.sessionActive();
    }
    requestPromise(method, url, data, freeze = false) {
        let m = this;
        return new Promise(function (resolve, reject) {
            m.request(method, url, data, resolve, reject, freeze);
        });
    }
    request(method, url, data, success = noop, fail = noop, freeze = false) {
        let app = this;
        if (freeze) {
            app.view.freeze();
        }
        let options = {
            url: url,
            method: method,
            data: data,
            badNewsShow: false
        };
        let com = new OWebCom(this, options);
        com.on(OWebCom.EVT_COM_REQUEST_SUCCESS, (response) => {
            // setTimeout(function () {
            if (freeze) {
                app.view.unfreeze();
            }
            success(response);
            // }, 1000);
        }).on(OWebCom.EVT_COM_REQUEST_ERROR, (response) => {
            if (response["msg"] === "OZ_ERROR_YOU_ARE_NOT_ADMIN") {
                app.destroyApp();
            }
            if (freeze) {
                app.view.unfreeze();
            }
            fail(response);
        }).on(OWebCom.EVT_COM_NETWORK_ERROR, () => {
            if (freeze) {
                app.view.unfreeze();
            }
            let response = {
                "error": 1,
                "msg": "OZ_ERROR_REQUEST_FAIL",
                "utime": OWebDate.timestamp()
            };
            response.neterror = true;
            fail(response);
        }).send();
        return com;
    }
}
OWebApp.EVT_APP_READY = "OWebApp:ready";
OWebApp.SELF = "OWebApp";
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkFwcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViQXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTixXQUFXLEVBQ1gsU0FBUyxFQUNULGVBQWUsRUFDZixRQUFRLEVBQ1IsYUFBYSxFQUNiLFFBQVEsRUFDUixPQUFPLEVBQ1AsaUJBQWlCLEVBR2pCLE9BQU8sRUFDUCxVQUFVLEVBR1YsTUFBTSxRQUFRLENBQUM7QUFFaEIsTUFBTSxJQUFJLEdBQUcsR0FBRyxFQUFFO0FBQ2xCLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxPQUFPLGNBQXdCLFNBQVEsU0FBUztJQVl0RCxZQUF1QyxRQUFnQixFQUFFLGVBQTRCLEVBQUUsWUFBc0I7UUFDNUcsS0FBSyxFQUFFLENBQUM7UUFEOEIsYUFBUSxHQUFSLFFBQVEsQ0FBUTtRQUY5QyxhQUFRLEdBQXdDLEVBQUUsQ0FBQztRQUkzRCxJQUFJLENBQUMsT0FBTyxHQUFJLElBQUksV0FBVyxDQUFDLElBQUksRUFBRSxlQUFlLENBQUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsR0FBRyxHQUFRLElBQUksT0FBTyxDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQztRQUNoRCxJQUFJLENBQUMsSUFBSSxHQUFPLElBQUksZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzFDLElBQUksQ0FBQyxJQUFJLEdBQU8sSUFBSSxRQUFRLEVBQUUsQ0FBQztRQUMvQixJQUFJLFFBQVEsR0FBSSxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsQ0FBQyxFQUN4RCxTQUFTLEdBQUcsS0FBSyxLQUFLLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixDQUFDLENBQUM7UUFDbkUsSUFBSSxDQUFDLE1BQU0sR0FBSyxJQUFJLFVBQVUsQ0FBQyxRQUFRLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVELFVBQVU7UUFDVCxPQUFP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cUJBQWEsR0FBRyxlQUFlLENBQUM7QUFDaEMsWUFBSSxHQUFZLFNBQVMsQ0FBQztBQTZJMUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG5cdE9XZWJDb25maWdzLFxuXHRPV2ViRXZlbnQsXG5cdE9XZWJDdXJyZW50VXNlcixcblx0T1dlYlZpZXcsXG5cdE9XZWJEYXRhU3RvcmUsXG5cdE9XZWJEYXRlLFxuXHRPV2ViQ29tLFxuXHRPV2ViRm9ybVZhbGlkYXRvcixcblx0T1dlYlNlcnZpY2UsXG5cdHRDb25maWdMaXN0LFxuXHRPV2ViVXJsLFxuXHRPV2ViUm91dGVyLFxuXHR0VXJsTGlzdCxcblx0aUNvbVJlc3BvbnNlXG59IGZyb20gXCIuL293ZWJcIjtcblxuY29uc3Qgbm9vcCA9ICgpID0+IHtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGFic3RyYWN0IGNsYXNzIE9XZWJBcHAgZXh0ZW5kcyBPV2ViRXZlbnQge1xuXG5cdHN0YXRpYyByZWFkb25seSBFVlRfQVBQX1JFQURZID0gXCJPV2ViQXBwOnJlYWR5XCI7XG5cdHN0YXRpYyByZWFkb25seSBTRUxGICAgICAgICAgID0gXCJPV2ViQXBwXCI7XG5cblx0cmVhZG9ubHkgdmlldzogT1dlYlZpZXc7XG5cdHJlYWRvbmx5IHJvdXRlcjogT1dlYlJvdXRlcjtcblx0cmVhZG9ubHkgdXNlcjogT1dlYkN1cnJlbnRVc2VyO1xuXHRyZWFkb25seSBjb25maWdzOiBPV2ViQ29uZmlncztcblx0cmVhZG9ubHkgdXJsOiBPV2ViVXJsO1xuXHRyZWFkb25seSBzZXJ2aWNlczogeyBba2V5OiBzdHJpbmddOiBPV2ViU2VydmljZTxhbnk+IH0gPSB7fTtcblxuXHRwcm90ZWN0ZWQgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhcHBfbmFtZTogc3RyaW5nLCBhcHBfY29uZmlnX2xpc3Q6IHRDb25maWdMaXN0LCBhcHBfdXJsX2xpc3Q6IHRVcmxMaXN0KSB7XG5cdFx0c3VwZXIoKTtcblx0XHR0aGlzLmNvbmZpZ3MgID0gbmV3IE9XZWJDb25maWdzKHRoaXMsIGFwcF9jb25maWdfbGlzdCk7XG5cdFx0dGhpcy51cmwgICAgICA9IG5ldyBPV2ViVXJsKHRoaXMsIGFwcF91cmxfbGlzdCk7XG5cdFx0dGhpcy51c2VyICAgICA9IG5ldyBPV2ViQ3VycmVudFVzZXIodGhpcyk7XG5cdFx0dGhpcy52aWV3ICAgICA9IG5ldyBPV2ViVmlldygpO1xuXHRcdGxldCBiYXNlX3VybCAgPSB0aGlzLmNvbmZpZ3MuZ2V0KFwiT1dfQVBQX0xPQ0FMX0JBU0VfVVJMXCIpLFxuXHRcdFx0aGFzaF9tb2RlID0gZmFsc2UgIT09IHRoaXMuY29uZmlncy5nZXQoXCJPV19BUFBfUk9VVEVSX0hBU0hfTU9ERVwiKTtcblx0XHR0aGlzLnJvdXRlciAgID0gbmV3IE9XZWJSb3V0ZXIoYmFzZV91cmwsIGhhc2hfbW9kZSk7XG5cdH1cblxuXHRnZXRBcHBOYW1lKCkge1xuXHRcdHJldHVybiB0aGlzLmFwcF9uYW1lO1xuXHR9XG5cblx0c3RhcnQoKSB7XG5cdFx0Y29uc29sZS5sb2coXCJbT1dlYkFwcF0gYXBwIHN0YXJ0ZWQhXCIpO1xuXHRcdHRoaXMudHJpZ2dlcihPV2ViQXBwLkVWVF9BUFBfUkVBRFkpO1xuXHR9XG5cblx0Z2V0U2VydmljZTxUID0gYW55PihzZXJ2aWNlX25hbWU6IHN0cmluZyk6IE9XZWJTZXJ2aWNlPFQ+IHwgdW5kZWZpbmVkIHtcblx0XHRyZXR1cm4gdGhpcy5zZXJ2aWNlc1tzZXJ2aWNlX25hbWVdO1xuXHR9XG5cblx0cmVnaXN0ZXJTZXJ2aWNlPFQgZXh0ZW5kcyBPV2ViU2VydmljZTxhbnk+PihzZXJ2aWNlOiBUKTogdGhpcyB7XG5cblx0XHRsZXQgc2VydmljZV9uYW1lID0gc2VydmljZS5nZXROYW1lKCk7XG5cblx0XHRpZiAodGhpcy5zZXJ2aWNlc1tzZXJ2aWNlX25hbWVdKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYEEgc2VydmljZSB3aXRoIHRoZSBuYW1lIFwiJHtzZXJ2aWNlX25hbWV9XCIgYWxyZWFkeSBkZWZpbmVkLmApO1xuXHRcdH1cblxuXHRcdHRoaXMuc2VydmljZXNbc2VydmljZV9uYW1lXSA9IHNlcnZpY2U7XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdGdldEZvcm1WYWxpZGF0b3IoZm9ybTogSFRNTEZvcm1FbGVtZW50LCByZXF1aXJlZDogQXJyYXk8c3RyaW5nPiA9IFtdLCBleGNsdWRlZDogQXJyYXk8c3RyaW5nPiA9IFtdKSB7XG5cdFx0cmV0dXJuIG5ldyBPV2ViRm9ybVZhbGlkYXRvcih0aGlzLCBmb3JtLCByZXF1aXJlZCwgZXhjbHVkZWQpO1xuXHR9XG5cblx0Zm9yY2VMb2dpbigpIHtcblx0XHRPV2ViRGF0YVN0b3JlLmNsZWFyKCk7XG5cdFx0dGhpcy5yZWxvYWRBcHAoKTtcblx0fVxuXG5cdHJlbG9hZEFwcCgpIHtcblx0XHQvLyBUT0RPOiBpbnN0ZWFkIG9mIHJlbG9hZGluZyB0aGUgY3VycmVudCBsb2NhdGlvbiwgZmluZCBhIHdheSB0byBicm93c2UgdG8gd2ViIGFwcCBlbnRyeSBwb2ludFxuXHRcdC8vIGZvciBhbmRyb2lkICYgaW9zIHJlc3RhcnQgdGhlIGFwcFxuXHRcdHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQodHJ1ZSk7XG5cdH1cblxuXHRkZXN0cm95QXBwKCkge1xuXHRcdC8vIGVyYXNlIGRhdGFcblx0XHRPV2ViRGF0YVN0b3JlLmNsZWFyKCk7XG5cdFx0dGhpcy5yZWxvYWRBcHAoKTtcblx0fVxuXG5cdHNlc3Npb25BY3RpdmUoKTogYm9vbGVhbiB7XG5cdFx0bGV0IG5vdyAgICA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7Ly8gbWlsbGlzZWNvbmRzXG5cdFx0bGV0IGhvdXIgICA9IDYwICogNjA7Ly8gc2Vjb25kc1xuXHRcdGxldCBleHBpcmUgPSB0aGlzLnVzZXIuZ2V0U2Vzc2lvbkV4cGlyZSgpIC0gaG91cjsvLyBzZWNvbmRzXG5cdFx0cmV0dXJuIChleHBpcmUgKiAxMDAwKSA+IG5vdztcblx0fVxuXG5cdHVzZXJWZXJpZmllZCgpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gdGhpcy51c2VyLmdldEN1cnJlbnRVc2VyKCkgJiYgdGhpcy5zZXNzaW9uQWN0aXZlKCk7XG5cdH1cblxuXHRyZXF1ZXN0UHJvbWlzZShtZXRob2Q6IHN0cmluZywgdXJsOiBzdHJpbmcsIGRhdGE6IGFueSwgZnJlZXplOiBib29sZWFuID0gZmFsc2UpOiBQcm9taXNlPGlDb21SZXNwb25zZT4ge1xuXHRcdGxldCBtID0gdGhpcztcblx0XHRyZXR1cm4gbmV3IFByb21pc2U8aUNvbVJlc3BvbnNlPihmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG5cdFx0XHRtLnJlcXVlc3QobWV0aG9kLCB1cmwsIGRhdGEsIHJlc29sdmUsIHJlamVjdCwgZnJlZXplKTtcblx0XHR9KTtcblx0fVxuXG5cdHJlcXVlc3QobWV0aG9kOiBzdHJpbmcsIHVybDogc3RyaW5nLCBkYXRhOiBhbnksIHN1Y2Nlc3M6IChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB2b2lkID0gbm9vcCwgZmFpbDogKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHZvaWQgPSBub29wLCBmcmVlemU6IGJvb2xlYW4gPSBmYWxzZSk6IE9XZWJDb20ge1xuXHRcdGxldCBhcHAgPSB0aGlzO1xuXG5cdFx0aWYgKGZyZWV6ZSkge1xuXHRcdFx0YXBwLnZpZXcuZnJlZXplKCk7XG5cdFx0fVxuXG5cdFx0bGV0IG9wdGlvbnMgPSB7XG5cdFx0XHR1cmwgICAgICAgIDogdXJsLFxuXHRcdFx0bWV0aG9kICAgICA6IG1ldGhvZCxcblx0XHRcdGRhdGEgICAgICAgOiBkYXRhLFxuXHRcdFx0YmFkTmV3c1Nob3c6IGZhbHNlXG5cdFx0fTtcblxuXHRcdGxldCBjb20gPSBuZXcgT1dlYkNvbSh0aGlzLCBvcHRpb25zKTtcblx0XHRjb20ub24oT1dlYkNvbS5FVlRfQ09NX1JFUVVFU1RfU1VDQ0VTUywgKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHtcblx0XHRcdC8vIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuXHRcdFx0aWYgKGZyZWV6ZSkge1xuXHRcdFx0XHRhcHAudmlldy51bmZyZWV6ZSgpO1xuXHRcdFx0fVxuXG5cdFx0XHRzdWNjZXNzKHJlc3BvbnNlKTtcblx0XHRcdC8vIH0sIDEwMDApO1xuXHRcdH0pLm9uKE9XZWJDb20uRVZUX0NPTV9SRVFVRVNUX0VSUk9SLCAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0aWYgKHJlc3BvbnNlW1wibXNnXCJdID09PSBcIk9aX0VSUk9SX1lPVV9BUkVfTk9UX0FETUlOXCIpIHtcblx0XHRcdFx0YXBwLmRlc3Ryb3lBcHAoKTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKGZyZWV6ZSkge1xuXHRcdFx0XHRhcHAudmlldy51bmZyZWV6ZSgpO1xuXHRcdFx0fVxuXG5cdFx0XHRmYWlsKHJlc3BvbnNlKTtcblx0XHR9KS5vbihPV2ViQ29tLkVWVF9DT01fTkVUV09SS19FUlJPUiwgKCkgPT4ge1xuXHRcdFx0aWYgKGZyZWV6ZSkge1xuXHRcdFx0XHRhcHAudmlldy51bmZyZWV6ZSgpO1xuXHRcdFx0fVxuXHRcdFx0bGV0IHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UgPSB7XG5cdFx0XHRcdFwiZXJyb3JcIjogMSxcblx0XHRcdFx0XCJtc2dcIiAgOiBcIk9aX0VSUk9SX1JFUVVFU1RfRkFJTFwiLFxuXHRcdFx0XHRcInV0aW1lXCI6IE9XZWJEYXRlLnRpbWVzdGFtcCgpXG5cdFx0XHR9O1xuXG5cdFx0XHRyZXNwb25zZS5uZXRlcnJvciA9IHRydWU7XG5cblx0XHRcdGZhaWwocmVzcG9uc2UpO1xuXHRcdH0pLnNlbmQoKTtcblxuXHRcdHJldHVybiBjb207XG5cdH1cblxuXHRhYnN0cmFjdCBzaG93SG9tZVBhZ2UoKTogdGhpc1xuXG5cdGFic3RyYWN0IHNob3dMb2dpblBhZ2UoKTogdGhpc1xuXG5cdGFic3RyYWN0IHNob3dTaWduVXBQYWdlKCk6IHRoaXNcbn07XG4iXX0=