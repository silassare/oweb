import OWebCom from "./OWebCom";
import OWebConfigs from "./OWebConfigs";
import OWebCurrentUser from "./OWebCurrentUser";
import OWebDataStore from "./OWebDataStore";
import OWebEvent from "./OWebEvent";
import OWebFormValidator from "./OWebFormValidator";
import OWebRouter from "./OWebRouter";
import OWebUrl from "./OWebUrl";
import OWebView from "./OWebView";
import OWebDate from "./plugins/OWebDate";
import Utils from "./utils/Utils";
import OWebI18n from "./OWebI18n";
import OWebPager from "./OWebPager";
/**
 * @ignore
 */
const noop = () => {
};
export default class OWebApp extends OWebEvent {
    /**
     * OWebApp constructor.
     *
     * @param name The app name.
     * @param configs The app config.
     * @param urls The app url list.
     * @param state The app state.
     */
    constructor(name, configs, urls, state = {}) {
        super();
        this.name = name;
        this.services = {};
        this.state = Object.assign({ ready: false, frozen: false, splash: true, show_nav: true, current_page: undefined, dialogs: [] }, state);
        this.ls = new OWebDataStore(this);
        this.configs = new OWebConfigs(this, configs);
        this.url = new OWebUrl(this, urls);
        this.user = new OWebCurrentUser(this);
        this.view = new OWebView();
        this.pager = new OWebPager(this);
        this.i18n = new OWebI18n(this);
        let base_url = this.configs.get("OW_APP_LOCAL_BASE_URL"), hash_mode = false !== this.configs.get("OW_APP_ROUTER_HASH_MODE"), m = this;
        this.router = new OWebRouter(base_url, hash_mode);
        this.router.notFound(this.showNotFound.bind(this));
        this.i18n.setDefaultLang(this.configs.get("OW_APP_DEFAULT_LANG"));
        this.pager.on(OWebPager.EVT_PAGE_CHANGE, () => {
            m.state.current_page = m.pager.getActivePage();
        });
        this.view.onFreeze(() => {
            m.state.frozen = true;
        }).onUnFreeze(() => {
            m.state.frozen = false;
        }).onDialog((dialog, can_use_alert) => {
            let { text, data } = dialog;
            if (text && text.length) {
                if (can_use_alert && m.isMobileApp()) {
                    alert(m.i18n.toHuman(text, data));
                }
                else {
                    m.state.dialogs.push(dialog);
                }
            }
        });
    }
    /**
     * App name getter.
     */
    getAppName() {
        return this.name;
    }
    /**
     * Checks if we are running in mobile app.
     */
    isMobileApp() {
        return "cordova" in window;
    }
    /**
     * To start the web app.
     */
    start() {
        console.log("[OWebApp] app started!");
        this.trigger(OWebApp.EVT_APP_READY);
        return this;
    }
    /**
     * Returns registered service with a given name.
     *
     * @param service_name The service name.
     */
    getService(service_name) {
        return this.services[service_name];
    }
    /**
     * Register a new service.
     *
     * @param service The service object.
     */
    registerService(service) {
        let service_name = service.getName();
        if (this.services[service_name]) {
            throw new Error(`A service with the name "${service_name}" already defined.`);
        }
        this.services[service_name] = service;
        return this;
    }
    /**
     * Returns new form validator instance.
     *
     * @param form The html form element.
     * @param required The required fields names list.
     * @param excluded The fields names to exclude.
     * @param checkAll Force the validator to check all fields.
     */
    getFormValidator(form, required = [], excluded = [], checkAll = false) {
        return new OWebFormValidator(this, form, required, excluded, checkAll);
    }
    /**
     * Force login.
     *
     * > This will clear all saved data in the local storage.
     */
    forceLogin() {
        this.ls.clear();
        this.showLoginPage();
    }
    /**
     * Reload the app.
     */
    reloadApp() {
        // TODO: instead of reloading the current location, find a way to browse to web app entry point
        // for android & ios restart the app
        // window.location.reload(true);
        this.showHomePage();
    }
    /**
     * Destroy the app.
     *
     * > This will clear all saved data in the local storage.
     */
    destroyApp() {
        // erase data
        this.ls.clear();
        this.reloadApp();
    }
    /**
     * Close app.
     */
    closeApp() {
        // cordova
        if (window.navigator && window.navigator.app) {
            window.navigator.app.exitApp();
        }
        else {
            window.close();
        }
    }
    /**
     * Checks if user session is active.
     */
    sessionActive() {
        let now = (new Date()).getTime(); // milliseconds
        let hour = 60 * 60; // seconds
        let expire = this.user.getSessionExpire() - hour; // seconds
        return (expire * 1000) > now;
    }
    /**
     * Checks if the current user has been authenticated.
     */
    userVerified() {
        return Boolean(this.user.getCurrentUser() && this.sessionActive());
    }
    /**
     * Send request and return promise.
     *
     * @param method The request method.
     * @param url The request url.
     * @param data The request payload.
     * @param freeze Force app view to be frozen.
     */
    requestPromise(method, url, data, freeze = false) {
        let m = this;
        return new Promise(function (resolve, reject) {
            m.request(method, url, data, resolve, reject, freeze);
        });
    }
    /**
     * Send request.
     *
     * @param method The request method.
     * @param url The request url.
     * @param data The request payload.
     * @param success Request success callback.
     * @param fail Request fail callback.
     * @param freeze Force app view to be frozen.
     */
    request(method, url, data, success = noop, fail = noop, freeze = false) {
        let app = this;
        if (freeze) {
            app.view.freeze();
        }
        let options = {
            url: url,
            method: method,
            data: data,
            badNewsShow: false
        };
        let com = new OWebCom(this, options);
        com.on(OWebCom.EVT_COM_REQUEST_SUCCESS, (response) => {
            // setTimeout(function () {
            if (freeze) {
                app.view.unfreeze();
            }
            success.call(com, response);
            // }, 1000);
        }).on(OWebCom.EVT_COM_REQUEST_ERROR, (response) => {
            if (response["msg"] === "OZ_ERROR_YOU_ARE_NOT_ADMIN") {
                app.destroyApp();
            }
            if (freeze) {
                app.view.unfreeze();
            }
            fail.call(com, response);
        }).on(OWebCom.EVT_COM_NETWORK_ERROR, () => {
            if (freeze) {
                app.view.unfreeze();
            }
            let response = {
                "error": 1,
                "msg": "OZ_ERROR_REQUEST_FAIL",
                "utime": OWebDate.timestamp()
            };
            response.neterror = true;
            fail.call(com, response);
        }).send();
        return com;
    }
    /**
     * Register handler for OWebApp.EVT_APP_READY event
     *
     * @param handler
     */
    onReady(handler) {
        return this.on(OWebApp.EVT_APP_READY, handler);
    }
}
OWebApp.SELF = Utils.id();
OWebApp.EVT_APP_READY = Utils.id();
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkFwcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViQXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sT0FBdUIsTUFBTSxXQUFXLENBQUM7QUFDaEQsT0FBTyxXQUEwQixNQUFNLGVBQWUsQ0FBQztBQUN2RCxPQUFPLGVBQWUsTUFBTSxtQkFBbUIsQ0FBQztBQUNoRCxPQUFPLGFBQWEsTUFBTSxpQkFBaUIsQ0FBQztBQUM1QyxPQUFPLFNBQVMsTUFBTSxhQUFhLENBQUM7QUFDcEMsT0FBTyxpQkFBaUIsTUFBTSxxQkFBcUIsQ0FBQztBQUNwRCxPQUFPLFVBQTBCLE1BQU0sY0FBYyxDQUFDO0FBRXRELE9BQU8sT0FBbUIsTUFBTSxXQUFXLENBQUM7QUFDNUMsT0FBTyxRQUF1QixNQUFNLFlBQVksQ0FBQztBQUNqRCxPQUFPLFFBQVEsTUFBTSxvQkFBb0IsQ0FBQztBQUMxQyxPQUFPLEtBQUssTUFBTSxlQUFlLENBQUM7QUFDbEMsT0FBTyxRQUFRLE1BQU0sWUFBWSxDQUFDO0FBQ2xDLE9BQU8sU0FBa0IsTUFBTSxhQUFhLENBQUM7QUFFN0M7O0dBRUc7QUFDSCxNQUFNLElBQUksR0FBRyxHQUFHLEVBQUU7QUFDbEIsQ0FBQyxDQUFDO0FBb0JGLE1BQU0sQ0FBQyxPQUFPLGNBQXdCLFNBQVEsU0FBUztJQWdCdEQ7Ozs7Ozs7T0FPRztJQUNILFlBQXVDLElBQVksRUFBRSxPQUFvQixFQUFFLElBQWMsRUFBRSxRQUEyQixFQUF1QjtRQUM1SSxLQUFLLEVBQUUsQ0FBQztRQUQ4QixTQUFJLEdBQUosSUFBSSxDQUFRO1FBWDFDLGFBQVEsR0FBd0MsRUFBRSxDQUFDO1FBYzNELElBQUksQ0FBQyxLQUFLLG1CQUNULEtBQUssRUFBUyxLQUFLLEVBQ25CLE1BQU0sRUFBUSxLQUFLLEVBQ25CLE1BQU0sRUFBUSxJQUFJLEVBQ2xCLFFBQVEsRUFBTSxJQUFJLEVBQ2xCLFlBQVksRUFBRSxTQUFTLEVBQ3ZCLE9BQU8s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LE1BQU0sRUFBRTtnQkFDWCxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO2FBQ3BCO1lBQ0QsSUFBSSxRQUFRLEdBQWlCO2dCQUM1QixPQUFPLEVBQUUsQ0FBQztnQkFDVixLQUFLLEVBQUksdUJBQXVCO2dCQUNoQyxPQUFPLEVBQUUsUUFBUSxDQUFDLFNBQVMsRUFBRTthQUM3QixDQUFDO1lBRUYsUUFBUSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7WUFFekIsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDMUIsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFFVixPQUFPLEdBQUcsQ0FBQztJQUNaLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsT0FBTyxDQUFDLE9BQXVDO1FBQzlDLE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsYUFBYSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2hELENBQUM7O0FBdFJlLFlBQUksR0FBWSxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUM7QUFDM0IscUJBQWEsR0FBRyxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUM7QUEwUzNDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT1dlYkNvbSwge2lDb21SZXNwb25zZX0gZnJvbSBcIi4vT1dlYkNvbVwiO1xuaW1wb3J0IE9XZWJDb25maWdzLCB7dENvbmZpZ0xpc3R9IGZyb20gXCIuL09XZWJDb25maWdzXCI7XG5pbXBvcnQgT1dlYkN1cnJlbnRVc2VyIGZyb20gXCIuL09XZWJDdXJyZW50VXNlclwiO1xuaW1wb3J0IE9XZWJEYXRhU3RvcmUgZnJvbSBcIi4vT1dlYkRhdGFTdG9yZVwiO1xuaW1wb3J0IE9XZWJFdmVudCBmcm9tIFwiLi9PV2ViRXZlbnRcIjtcbmltcG9ydCBPV2ViRm9ybVZhbGlkYXRvciBmcm9tIFwiLi9PV2ViRm9ybVZhbGlkYXRvclwiO1xuaW1wb3J0IE9XZWJSb3V0ZXIsIHt0Um91dGVUYXJnZXR9IGZyb20gXCIuL09XZWJSb3V0ZXJcIjtcbmltcG9ydCBPV2ViU2VydmljZSBmcm9tIFwiLi9PV2ViU2VydmljZVwiO1xuaW1wb3J0IE9XZWJVcmwsIHt0VXJsTGlzdH0gZnJvbSBcIi4vT1dlYlVybFwiO1xuaW1wb3J0IE9XZWJWaWV3LCB7dFZpZXdEaWFsb2d9IGZyb20gXCIuL09XZWJWaWV3XCI7XG5pbXBvcnQgT1dlYkRhdGUgZnJvbSBcIi4vcGx1Z2lucy9PV2ViRGF0ZVwiO1xuaW1wb3J0IFV0aWxzIGZyb20gXCIuL3V0aWxzL1V0aWxzXCI7XG5pbXBvcnQgT1dlYkkxOG4gZnJvbSBcIi4vT1dlYkkxOG5cIjtcbmltcG9ydCBPV2ViUGFnZXIsIHtpUGFnZX0gZnJvbSBcIi4vT1dlYlBhZ2VyXCI7XG5cbi8qKlxuICogQGlnbm9yZVxuICovXG5jb25zdCBub29wID0gKCkgPT4ge1xufTtcblxuZXhwb3J0IGludGVyZmFjZSBpQXBwU3RhdGUge1xuXHRyZWFkeTogYm9vbGVhbixcblx0c3BsYXNoOiBib29sZWFuLFxuXHRmcm96ZW46IGJvb2xlYW4sXG5cdHNob3dfbmF2OiBib29sZWFuLFxuXHRjdXJyZW50X3BhZ2U/OiBpUGFnZSxcblx0ZGlhbG9nczogdFZpZXdEaWFsb2dbXVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlBcHBTdGF0ZU9wdGlvbnMge1xuXHRyZWFkeT86IGJvb2xlYW4sXG5cdHNwbGFzaD86IGJvb2xlYW4sXG5cdGZyb3plbj86IGJvb2xlYW4sXG5cdHNob3dfbmF2PzogYm9vbGVhbixcblx0Y3VycmVudF9wYWdlPzogaVBhZ2UsXG5cdGRpYWxvZ3M/OiB0Vmlld0RpYWxvZ1tdXG59XG5cbmV4cG9ydCBkZWZhdWx0IGFic3RyYWN0IGNsYXNzIE9XZWJBcHAgZXh0ZW5kcyBPV2ViRXZlbnQge1xuXG5cdHN0YXRpYyByZWFkb25seSBTRUxGICAgICAgICAgID0gVXRpbHMuaWQoKTtcblx0c3RhdGljIHJlYWRvbmx5IEVWVF9BUFBfUkVBRFkgPSBVdGlscy5pZCgpO1xuXG5cdHJlYWRvbmx5IHN0YXRlOiBpQXBwU3RhdGU7XG5cdHJlYWRvbmx5IHZpZXc6IE9XZWJWaWV3O1xuXHRyZWFkb25seSBwYWdlcjogT1dlYlBhZ2VyO1xuXHRyZWFkb25seSBsczogT1dlYkRhdGFTdG9yZTtcblx0cmVhZG9ubHkgcm91dGVyOiBPV2ViUm91dGVyO1xuXHRyZWFkb25seSB1c2VyOiBPV2ViQ3VycmVudFVzZXI7XG5cdHJlYWRvbmx5IGNvbmZpZ3M6IE9XZWJDb25maWdzO1xuXHRyZWFkb25seSB1cmw6IE9XZWJVcmw7XG5cdHJlYWRvbmx5IHNlcnZpY2VzOiB7IFtrZXk6IHN0cmluZ106IE9XZWJTZXJ2aWNlPGFueT4gfSA9IHt9O1xuXHRyZWFkb25seSBpMThuOiBPV2ViSTE4bjtcblxuXHQvKipcblx0ICogT1dlYkFwcCBjb25zdHJ1Y3Rvci5cblx0ICpcblx0ICogQHBhcmFtIG5hbWUgVGhlIGFwcCBuYW1lLlxuXHQgKiBAcGFyYW0gY29uZmlncyBUaGUgYXBwIGNvbmZpZy5cblx0ICogQHBhcmFtIHVybHMgVGhlIGFwcCB1cmwgbGlzdC5cblx0ICogQHBhcmFtIHN0YXRlIFRoZSBhcHAgc3RhdGUuXG5cdCAqL1xuXHRwcm90ZWN0ZWQgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBuYW1lOiBzdHJpbmcsIGNvbmZpZ3M6IHRDb25maWdMaXN0LCB1cmxzOiB0VXJsTGlzdCwgc3RhdGU6IGlBcHBTdGF0ZU9wdGlvbnMgPSAoe30gYXMgaUFwcFN0YXRlT3B0aW9ucykpIHtcblx0XHRzdXBlcigpO1xuXG5cdFx0dGhpcy5zdGF0ZSA9IHtcblx0XHRcdHJlYWR5ICAgICAgIDogZmFsc2UsXG5cdFx0XHRmcm96ZW4gICAgICA6IGZhbHNlLFxuXHRcdFx0c3BsYXNoICAgICAgOiB0cnVlLFxuXHRcdFx0c2hvd19uYXYgICAgOiB0cnVlLFxuXHRcdFx0Y3VycmVudF9wYWdlOiB1bmRlZmluZWQsXG5cdFx0XHRkaWFsb2dzICAgICA6IFtdLFxuXHRcdFx0Li4uc3RhdGVcblx0XHR9O1xuXG5cdFx0dGhpcy5scyAgICAgICA9IG5ldyBPV2ViRGF0YVN0b3JlKHRoaXMpO1xuXHRcdHRoaXMuY29uZmlncyAgPSBuZXcgT1dlYkNvbmZpZ3ModGhpcywgY29uZmlncyk7XG5cdFx0dGhpcy51cmwgICAgICA9IG5ldyBPV2ViVXJsKHRoaXMsIHVybHMpO1xuXHRcdHRoaXMudXNlciAgICAgPSBuZXcgT1dlYkN1cnJlbnRVc2VyKHRoaXMpO1xuXHRcdHRoaXMudmlldyAgICAgPSBuZXcgT1dlYlZpZXcoKTtcblx0XHR0aGlzLnBhZ2VyICAgID0gbmV3IE9XZWJQYWdlcih0aGlzKTtcblx0XHR0aGlzLmkxOG4gICAgID0gbmV3IE9XZWJJMThuKHRoaXMpO1xuXHRcdGxldCBiYXNlX3VybCAgPSB0aGlzLmNvbmZpZ3MuZ2V0KFwiT1dfQVBQX0xPQ0FMX0JBU0VfVVJMXCIpLFxuXHRcdFx0aGFzaF9tb2RlID0gZmFsc2UgIT09IHRoaXMuY29uZmlncy5nZXQoXCJPV19BUFBfUk9VVEVSX0hBU0hfTU9ERVwiKSxcblx0XHRcdG0gICAgICAgICA9IHRoaXM7XG5cdFx0dGhpcy5yb3V0ZXIgICA9IG5ldyBPV2ViUm91dGVyKGJhc2VfdXJsLCBoYXNoX21vZGUpO1xuXG5cdFx0dGhpcy5yb3V0ZXIubm90Rm91bmQodGhpcy5zaG93Tm90Rm91bmQuYmluZCh0aGlzKSk7XG5cblx0XHR0aGlzLmkxOG4uc2V0RGVmYXVsdExhbmcodGhpcy5jb25maWdzLmdldChcIk9XX0FQUF9ERUZBVUxUX0xBTkdcIikpO1xuXG5cdFx0dGhpcy5wYWdlci5vbihPV2ViUGFnZXIuRVZUX1BBR0VfQ0hBTkdFLCAoKSA9PiB7XG5cdFx0XHRtLnN0YXRlLmN1cnJlbnRfcGFnZSA9IG0ucGFnZXIuZ2V0QWN0aXZlUGFnZSgpO1xuXHRcdH0pO1xuXG5cdFx0dGhpcy52aWV3Lm9uRnJlZXplKCgpID0+IHtcblx0XHRcdG0uc3RhdGUuZnJvemVuID0gdHJ1ZTtcblx0XHR9KS5vblVuRnJlZXplKCgpID0+IHtcblx0XHRcdG0uc3RhdGUuZnJvemVuID0gZmFsc2U7XG5cdFx0fSkub25EaWFsb2coKGRpYWxvZzogdFZpZXdEaWFsb2csIGNhbl91c2VfYWxlcnQ6IGJvb2xlYW4pID0+IHtcblxuXHRcdFx0bGV0IHt0ZXh0LCBkYXRhfSA9IGRpYWxvZztcblxuXHRcdFx0aWYgKHRleHQgJiYgdGV4dC5sZW5ndGgpIHtcblx0XHRcdFx0aWYgKGNhbl91c2VfYWxlcnQgJiYgbS5pc01vYmlsZUFwcCgpKSB7XG5cdFx0XHRcdFx0YWxlcnQobS5pMThuLnRvSHVtYW4odGV4dCwgZGF0YSkpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdG0uc3RhdGUuZGlhbG9ncy5wdXNoKGRpYWxvZyk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBBcHAgbmFtZSBnZXR0ZXIuXG5cdCAqL1xuXHRnZXRBcHBOYW1lKCk6IHN0cmluZyB7XG5cdFx0cmV0dXJuIHRoaXMubmFtZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBDaGVja3MgaWYgd2UgYXJlIHJ1bm5pbmcgaW4gbW9iaWxlIGFwcC5cblx0ICovXG5cdGlzTW9iaWxlQXBwKCk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiBcImNvcmRvdmFcIiBpbiB3aW5kb3c7XG5cdH1cblxuXHQvKipcblx0ICogVG8gc3RhcnQgdGhlIHdlYiBhcHAuXG5cdCAqL1xuXHRzdGFydCgpOiB0aGlzIHtcblx0XHRjb25zb2xlLmxvZyhcIltPV2ViQXBwXSBhcHAgc3RhcnRlZCFcIik7XG5cdFx0dGhpcy50cmlnZ2VyKE9XZWJBcHAuRVZUX0FQUF9SRUFEWSk7XG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyByZWdpc3RlcmVkIHNlcnZpY2Ugd2l0aCBhIGdpdmVuIG5hbWUuXG5cdCAqXG5cdCAqIEBwYXJhbSBzZXJ2aWNlX25hbWUgVGhlIHNlcnZpY2UgbmFtZS5cblx0ICovXG5cdGdldFNlcnZpY2U8VCA9IGFueT4oc2VydmljZV9uYW1lOiBzdHJpbmcpOiBPV2ViU2VydmljZTxUPiB8IHVuZGVmaW5lZCB7XG5cdFx0cmV0dXJuIHRoaXMuc2VydmljZXNbc2VydmljZV9uYW1lXTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZWdpc3RlciBhIG5ldyBzZXJ2aWNlLlxuXHQgKlxuXHQgKiBAcGFyYW0gc2VydmljZSBUaGUgc2VydmljZSBvYmplY3QuXG5cdCAqL1xuXHRyZWdpc3RlclNlcnZpY2U8VCBleHRlbmRzIE9XZWJTZXJ2aWNlPGFueT4+KHNlcnZpY2U6IFQpOiB0aGlzIHtcblxuXHRcdGxldCBzZXJ2aWNlX25hbWUgPSBzZXJ2aWNlLmdldE5hbWUoKTtcblxuXHRcdGlmICh0aGlzLnNlcnZpY2VzW3NlcnZpY2VfbmFtZV0pIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihgQSBzZXJ2aWNlIHdpdGggdGhlIG5hbWUgXCIke3NlcnZpY2VfbmFtZX1cIiBhbHJlYWR5IGRlZmluZWQuYCk7XG5cdFx0fVxuXG5cdFx0dGhpcy5zZXJ2aWNlc1tzZXJ2aWNlX25hbWVdID0gc2VydmljZTtcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgbmV3IGZvcm0gdmFsaWRhdG9yIGluc3RhbmNlLlxuXHQgKlxuXHQgKiBAcGFyYW0gZm9ybSBUaGUgaHRtbCBmb3JtIGVsZW1lbnQuXG5cdCAqIEBwYXJhbSByZXF1aXJlZCBUaGUgcmVxdWlyZWQgZmllbGRzIG5hbWVzIGxpc3QuXG5cdCAqIEBwYXJhbSBleGNsdWRlZCBUaGUgZmllbGRzIG5hbWVzIHRvIGV4Y2x1ZGUuXG5cdCAqIEBwYXJhbSBjaGVja0FsbCBGb3JjZSB0aGUgdmFsaWRhdG9yIHRvIGNoZWNrIGFsbCBmaWVsZHMuXG5cdCAqL1xuXHRnZXRGb3JtVmFsaWRhdG9yKGZvcm06IEhUTUxGb3JtRWxlbWVudCwgcmVxdWlyZWQ6IEFycmF5PHN0cmluZz4gPSBbXSwgZXhjbHVkZWQ6IEFycmF5PHN0cmluZz4gPSBbXSwgY2hlY2tBbGw6IGJvb2xlYW4gPSBmYWxzZSkge1xuXHRcdHJldHVybiBuZXcgT1dlYkZvcm1WYWxpZGF0b3IodGhpcywgZm9ybSwgcmVxdWlyZWQsIGV4Y2x1ZGVkLCBjaGVja0FsbCk7XG5cdH1cblxuXHQvKipcblx0ICogRm9yY2UgbG9naW4uXG5cdCAqXG5cdCAqID4gVGhpcyB3aWxsIGNsZWFyIGFsbCBzYXZlZCBkYXRhIGluIHRoZSBsb2NhbCBzdG9yYWdlLlxuXHQgKi9cblx0Zm9yY2VMb2dpbigpIHtcblx0XHR0aGlzLmxzLmNsZWFyKCk7XG5cdFx0dGhpcy5zaG93TG9naW5QYWdlKCk7XG5cdH1cblxuXHQvKipcblx0ICogUmVsb2FkIHRoZSBhcHAuXG5cdCAqL1xuXHRyZWxvYWRBcHAoKSB7XG5cdFx0Ly8gVE9ETzogaW5zdGVhZCBvZiByZWxvYWRpbmcgdGhlIGN1cnJlbnQgbG9jYXRpb24sIGZpbmQgYSB3YXkgdG8gYnJvd3NlIHRvIHdlYiBhcHAgZW50cnkgcG9pbnRcblx0XHQvLyBmb3IgYW5kcm9pZCAmIGlvcyByZXN0YXJ0IHRoZSBhcHBcblx0XHQvLyB3aW5kb3cubG9jYXRpb24ucmVsb2FkKHRydWUpO1xuXHRcdHRoaXMuc2hvd0hvbWVQYWdlKCk7XG5cdH1cblxuXHQvKipcblx0ICogRGVzdHJveSB0aGUgYXBwLlxuXHQgKlxuXHQgKiA+IFRoaXMgd2lsbCBjbGVhciBhbGwgc2F2ZWQgZGF0YSBpbiB0aGUgbG9jYWwgc3RvcmFnZS5cblx0ICovXG5cdGRlc3Ryb3lBcHAoKSB7XG5cdFx0Ly8gZXJhc2UgZGF0YVxuXHRcdHRoaXMubHMuY2xlYXIoKTtcblx0XHR0aGlzLnJlbG9hZEFwcCgpO1xuXHR9XG5cblx0LyoqXG5cdCAqIENsb3NlIGFwcC5cblx0ICovXG5cdGNsb3NlQXBwKCkge1xuXHRcdC8vIGNvcmRvdmFcblx0XHRpZiAod2luZG93Lm5hdmlnYXRvciAmJiAod2luZG93Lm5hdmlnYXRvciBhcyBhbnkpLmFwcCkge1xuXHRcdFx0KHdpbmRvdy5uYXZpZ2F0b3IgYXMgYW55KS5hcHAuZXhpdEFwcCgpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR3aW5kb3cuY2xvc2UoKTtcblx0XHR9XG5cdH1cblxuXHQvKipcblx0ICogQ2hlY2tzIGlmIHVzZXIgc2Vzc2lvbiBpcyBhY3RpdmUuXG5cdCAqL1xuXHRzZXNzaW9uQWN0aXZlKCk6IGJvb2xlYW4ge1xuXHRcdGxldCBub3cgICAgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpOy8vIG1pbGxpc2Vjb25kc1xuXHRcdGxldCBob3VyICAgPSA2MCAqIDYwOy8vIHNlY29uZHNcblx0XHRsZXQgZXhwaXJlID0gdGhpcy51c2VyLmdldFNlc3Npb25FeHBpcmUoKSAtIGhvdXI7Ly8gc2Vjb25kc1xuXHRcdHJldHVybiAoZXhwaXJlICogMTAwMCkgPiBub3c7XG5cdH1cblxuXHQvKipcblx0ICogQ2hlY2tzIGlmIHRoZSBjdXJyZW50IHVzZXIgaGFzIGJlZW4gYXV0aGVudGljYXRlZC5cblx0ICovXG5cdHVzZXJWZXJpZmllZCgpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gQm9vbGVhbih0aGlzLnVzZXIuZ2V0Q3VycmVudFVzZXIoKSAmJiB0aGlzLnNlc3Npb25BY3RpdmUoKSk7XG5cdH1cblxuXHQvKipcblx0ICogU2VuZCByZXF1ZXN0IGFuZCByZXR1cm4gcHJvbWlzZS5cblx0ICpcblx0ICogQHBhcmFtIG1ldGhvZCBUaGUgcmVxdWVzdCBtZXRob2QuXG5cdCAqIEBwYXJhbSB1cmwgVGhlIHJlcXVlc3QgdXJsLlxuXHQgKiBAcGFyYW0gZGF0YSBUaGUgcmVxdWVzdCBwYXlsb2FkLlxuXHQgKiBAcGFyYW0gZnJlZXplIEZvcmNlIGFwcCB2aWV3IHRvIGJlIGZyb3plbi5cblx0ICovXG5cdHJlcXVlc3RQcm9taXNlKG1ldGhvZDogc3RyaW5nLCB1cmw6IHN0cmluZywgZGF0YTogYW55LCBmcmVlemU6IGJvb2xlYW4gPSBmYWxzZSk6IFByb21pc2U8aUNvbVJlc3BvbnNlPiB7XG5cdFx0bGV0IG0gPSB0aGlzO1xuXHRcdHJldHVybiBuZXcgUHJvbWlzZTxpQ29tUmVzcG9uc2U+KGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcblx0XHRcdG0ucmVxdWVzdChtZXRob2QsIHVybCwgZGF0YSwgcmVzb2x2ZSwgcmVqZWN0LCBmcmVlemUpO1xuXHRcdH0pO1xuXHR9XG5cblx0LyoqXG5cdCAqIFNlbmQgcmVxdWVzdC5cblx0ICpcblx0ICogQHBhcmFtIG1ldGhvZCBUaGUgcmVxdWVzdCBtZXRob2QuXG5cdCAqIEBwYXJhbSB1cmwgVGhlIHJlcXVlc3QgdXJsLlxuXHQgKiBAcGFyYW0gZGF0YSBUaGUgcmVxdWVzdCBwYXlsb2FkLlxuXHQgKiBAcGFyYW0gc3VjY2VzcyBSZXF1ZXN0IHN1Y2Nlc3MgY2FsbGJhY2suXG5cdCAqIEBwYXJhbSBmYWlsIFJlcXVlc3QgZmFpbCBjYWxsYmFjay5cblx0ICogQHBhcmFtIGZyZWV6ZSBGb3JjZSBhcHAgdmlldyB0byBiZSBmcm96ZW4uXG5cdCAqL1xuXHRyZXF1ZXN0KG1ldGhvZDogc3RyaW5nLCB1cmw6IHN0cmluZywgZGF0YTogYW55LCBzdWNjZXNzOiAodGhpczogT1dlYkNvbSwgcmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4gdm9pZCA9IG5vb3AsIGZhaWw6ICh0aGlzOiBPV2ViQ29tLCByZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB2b2lkID0gbm9vcCwgZnJlZXplOiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgYXBwID0gdGhpcztcblxuXHRcdGlmIChmcmVlemUpIHtcblx0XHRcdGFwcC52aWV3LmZyZWV6ZSgpO1xuXHRcdH1cblxuXHRcdGxldCBvcHRpb25zID0ge1xuXHRcdFx0dXJsICAgICAgICA6IHVybCxcblx0XHRcdG1ldGhvZCAgICAgOiBtZXRob2QsXG5cdFx0XHRkYXRhICAgICAgIDogZGF0YSxcblx0XHRcdGJhZE5ld3NTaG93OiBmYWxzZVxuXHRcdH07XG5cblx0XHRsZXQgY29tID0gbmV3IE9XZWJDb20odGhpcywgb3B0aW9ucyk7XG5cdFx0Y29tLm9uKE9XZWJDb20uRVZUX0NPTV9SRVFVRVNUX1NVQ0NFU1MsIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB7XG5cdFx0XHQvLyBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcblx0XHRcdGlmIChmcmVlemUpIHtcblx0XHRcdFx0YXBwLnZpZXcudW5mcmVlemUoKTtcblx0XHRcdH1cblxuXHRcdFx0c3VjY2Vzcy5jYWxsKGNvbSwgcmVzcG9uc2UpO1xuXHRcdFx0Ly8gfSwgMTAwMCk7XG5cdFx0fSkub24oT1dlYkNvbS5FVlRfQ09NX1JFUVVFU1RfRVJST1IsIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB7XG5cdFx0XHRpZiAocmVzcG9uc2VbXCJtc2dcIl0gPT09IFwiT1pfRVJST1JfWU9VX0FSRV9OT1RfQURNSU5cIikge1xuXHRcdFx0XHRhcHAuZGVzdHJveUFwcCgpO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoZnJlZXplKSB7XG5cdFx0XHRcdGFwcC52aWV3LnVuZnJlZXplKCk7XG5cdFx0XHR9XG5cblx0XHRcdGZhaWwuY2FsbChjb20sIHJlc3BvbnNlKTtcblx0XHR9KS5vbihPV2ViQ29tLkVWVF9DT01fTkVUV09SS19FUlJPUiwgKCkgPT4ge1xuXHRcdFx0aWYgKGZyZWV6ZSkge1xuXHRcdFx0XHRhcHAudmlldy51bmZyZWV6ZSgpO1xuXHRcdFx0fVxuXHRcdFx0bGV0IHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UgPSB7XG5cdFx0XHRcdFwiZXJyb3JcIjogMSxcblx0XHRcdFx0XCJtc2dcIiAgOiBcIk9aX0VSUk9SX1JFUVVFU1RfRkFJTFwiLFxuXHRcdFx0XHRcInV0aW1lXCI6IE9XZWJEYXRlLnRpbWVzdGFtcCgpXG5cdFx0XHR9O1xuXG5cdFx0XHRyZXNwb25zZS5uZXRlcnJvciA9IHRydWU7XG5cblx0XHRcdGZhaWwuY2FsbChjb20sIHJlc3BvbnNlKTtcblx0XHR9KS5zZW5kKCk7XG5cblx0XHRyZXR1cm4gY29tO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJlZ2lzdGVyIGhhbmRsZXIgZm9yIE9XZWJBcHAuRVZUX0FQUF9SRUFEWSBldmVudFxuXHQgKlxuXHQgKiBAcGFyYW0gaGFuZGxlclxuXHQgKi9cblx0b25SZWFkeShoYW5kbGVyOiAodGhpczogdGhpcykgPT4gdm9pZCB8IGJvb2xlYW4pIHtcblx0XHRyZXR1cm4gdGhpcy5vbihPV2ViQXBwLkVWVF9BUFBfUkVBRFksIGhhbmRsZXIpO1xuXHR9XG5cblx0LyoqXG5cdCAqIENhbGxlZCB3aGVuIGFwcCBzaG91bGQgc2hvdyB0aGUgaG9tZSBwYWdlLlxuXHQgKi9cblx0YWJzdHJhY3Qgc2hvd0hvbWVQYWdlKCk6IHRoaXNcblxuXHQvKipcblx0ICogQ2FsbGVkIHdoZW4gdGhlIHJlcXVlc3RlZCByb3V0ZSB3YXMgbm90IGZvdW5kLlxuXHQgKi9cblx0YWJzdHJhY3Qgc2hvd05vdEZvdW5kKHRhcmdldDogdFJvdXRlVGFyZ2V0KTogdGhpc1xuXG5cdC8qKlxuXHQgKiBDYWxsZWQgd2hlbiBhcHAgc2hvdWxkIHNob3cgdGhlIGxvZ2luIHBhZ2UuXG5cdCAqL1xuXHRhYnN0cmFjdCBzaG93TG9naW5QYWdlKCk6IHRoaXNcblxuXHQvKipcblx0ICogQ2FsbGVkIHdoZW4gYXBwIHNob3VsZCBzaG93IHRoZSBzaWdudXAgcGFnZS5cblx0ICovXG5cdGFic3RyYWN0IHNob3dTaWduVXBQYWdlKCk6IHRoaXNcbn07XG4iXX0=