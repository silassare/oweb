import OWebCom from "./OWebCom";
import OWebConfigs from "./OWebConfigs";
import OWebCurrentUser from "./OWebCurrentUser";
import OWebDataStore from "./OWebDataStore";
import OWebEvent from "./OWebEvent";
import OWebFormValidator from "./OWebFormValidator";
import OWebRouter from "./OWebRouter";
import OWebUrl from "./OWebUrl";
import OWebView from "./OWebView";
import OWebDate from "./plugins/OWebDate";
import Utils from "./utils/Utils";
const noop = () => {
};
export default class OWebApp extends OWebEvent {
    constructor(app_name, app_config_list, app_url_list) {
        super();
        this.app_name = app_name;
        this.services = {};
        this.ls = new OWebDataStore(this);
        this.configs = new OWebConfigs(this, app_config_list);
        this.url = new OWebUrl(this, app_url_list);
        this.user = new OWebCurrentUser(this);
        this.view = new OWebView();
        let base_url = this.configs.get("OW_APP_LOCAL_BASE_URL"), hash_mode = false !== this.configs.get("OW_APP_ROUTER_HASH_MODE");
        this.router = new OWebRouter(base_url, hash_mode);
    }
    getAppName() {
        return this.app_name;
    }
    isMobileApp() {
        return "cordova" in window;
    }
    start() {
        console.log("[OWebApp] app started!");
        this.trigger(OWebApp.EVT_APP_READY);
        return this;
    }
    getService(service_name) {
        return this.services[service_name];
    }
    registerService(service) {
        let service_name = service.getName();
        if (this.services[service_name]) {
            throw new Error(`A service with the name "${service_name}" already defined.`);
        }
        this.services[service_name] = service;
        return this;
    }
    getFormValidator(form, required = [], excluded = [], checkAll = false) {
        return new OWebFormValidator(this, form, required, excluded, checkAll);
    }
    forceLogin() {
        this.ls.clear();
        this.showLoginPage();
    }
    reloadApp() {
        // TODO: instead of reloading the current location, find a way to browse to web app entry point
        // for android & ios restart the app
        // window.location.reload(true);
        this.showHomePage();
    }
    destroyApp() {
        // erase data
        this.ls.clear();
        this.reloadApp();
    }
    closeApp() {
        // cordova
        if (window.navigator && window.navigator.app) {
            window.navigator.app.exitApp();
        }
        else {
            window.close();
        }
    }
    sessionActive() {
        let now = (new Date()).getTime(); // milliseconds
        let hour = 60 * 60; // seconds
        let expire = this.user.getSessionExpire() - hour; // seconds
        return (expire * 1000) > now;
    }
    userVerified() {
        return Boolean(this.user.getCurrentUser() && this.sessionActive());
    }
    requestPromise(method, url, data, freeze = false) {
        let m = this;
        return new Promise(function (resolve, reject) {
            m.request(method, url, data, resolve, reject, freeze);
        });
    }
    request(method, url, data, success = noop, fail = noop, freeze = false) {
        let app = this;
        if (freeze) {
            app.view.freeze();
        }
        let options = {
            url: url,
            method: method,
            data: data,
            badNewsShow: false
        };
        let com = new OWebCom(this, options);
        com.on(OWebCom.EVT_COM_REQUEST_SUCCESS, (response) => {
            // setTimeout(function () {
            if (freeze) {
                app.view.unfreeze();
            }
            success(response);
            // }, 1000);
        }).on(OWebCom.EVT_COM_REQUEST_ERROR, (response) => {
            if (response["msg"] === "OZ_ERROR_YOU_ARE_NOT_ADMIN") {
                app.destroyApp();
            }
            if (freeze) {
                app.view.unfreeze();
            }
            fail(response);
        }).on(OWebCom.EVT_COM_NETWORK_ERROR, () => {
            if (freeze) {
                app.view.unfreeze();
            }
            let response = {
                "error": 1,
                "msg": "OZ_ERROR_REQUEST_FAIL",
                "utime": OWebDate.timestamp()
            };
            response.neterror = true;
            fail(response);
        }).send();
        return com;
    }
}
OWebApp.SELF = Utils.id();
OWebApp.EVT_APP_READY = Utils.id();
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkFwcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViQXBwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sT0FBdUIsTUFBTSxXQUFXLENBQUM7QUFDaEQsT0FBTyxXQUEwQixNQUFNLGVBQWUsQ0FBQztBQUN2RCxPQUFPLGVBQWUsTUFBTSxtQkFBbUIsQ0FBQztBQUNoRCxPQUFPLGFBQWEsTUFBTSxpQkFBaUIsQ0FBQztBQUM1QyxPQUFPLFNBQVMsTUFBTSxhQUFhLENBQUM7QUFDcEMsT0FBTyxpQkFBaUIsTUFBTSxxQkFBcUIsQ0FBQztBQUNwRCxPQUFPLFVBQVUsTUFBTSxjQUFjLENBQUM7QUFFdEMsT0FBTyxPQUFtQixNQUFNLFdBQVcsQ0FBQztBQUM1QyxPQUFPLFFBQVEsTUFBTSxZQUFZLENBQUM7QUFDbEMsT0FBTyxRQUFRLE1BQU0sb0JBQW9CLENBQUM7QUFDMUMsT0FBTyxLQUFLLE1BQU0sZUFBZSxDQUFDO0FBRWxDLE1BQU0sSUFBSSxHQUFHLEdBQUcsRUFBRTtBQUNsQixDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsT0FBTyxjQUF3QixTQUFRLFNBQVM7SUFhdEQsWUFBdUMsUUFBZ0IsRUFBRSxlQUE0QixFQUFFLFlBQXNCO1FBQzVHLEtBQUssRUFBRSxDQUFDO1FBRDhCLGFBQVEsR0FBUixRQUFRLENBQVE7UUFGOUMsYUFBUSxHQUF3QyxFQUFFLENBQUM7UUFJM0QsSUFBSSxDQUFDLEVBQUUsR0FBUyxJQUFJLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4QyxJQUFJLENBQUMsT0FBTyxHQUFJLElBQUksV0FBVyxDQUFDLElBQUksRUFBRSxlQUFlLENBQUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsR0FBRyxHQUFRLElBQUksT0FBTyxDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQztRQUNoRCxJQUFJLENBQUMsSUFBSSxHQUFPLElBQUksZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1FB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RSxDQUFDLFFBQXNCLEVBQUUsRUFBRTtZQUMvRCxJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyw0QkFBNEIsRUFBRTtnQkFDckQsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUFDO2FBQ2pCO1lBRUQsSUFBSSxNQUFNLEVBQUU7Z0JBQ1gsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQzthQUNwQjtZQUVELElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNoQixDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLHFCQUFxQixFQUFFLEdBQUcsRUFBRTtZQUN6QyxJQUFJLE1BQU0sRUFBRTtnQkFDWCxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO2FBQ3BCO1lBQ0QsSUFBSSxRQUFRLEdBQWlCO2dCQUM1QixPQUFPLEVBQUUsQ0FBQztnQkFDVixLQUFLLEVBQUksdUJBQXVCO2dCQUNoQyxPQUFPLEVBQUUsUUFBUSxDQUFDLFNBQVMsRUFBRTthQUM3QixDQUFDO1lBRUYsUUFBUSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7WUFFekIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRVYsT0FBTyxHQUFHLENBQUM7SUFDWixDQUFDOztBQXhKZSxZQUFJLEdBQVksS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQzNCLHFCQUFhLEdBQUcsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBOEozQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IE9XZWJDb20sIHtpQ29tUmVzcG9uc2V9IGZyb20gXCIuL09XZWJDb21cIjtcbmltcG9ydCBPV2ViQ29uZmlncywge3RDb25maWdMaXN0fSBmcm9tIFwiLi9PV2ViQ29uZmlnc1wiO1xuaW1wb3J0IE9XZWJDdXJyZW50VXNlciBmcm9tIFwiLi9PV2ViQ3VycmVudFVzZXJcIjtcbmltcG9ydCBPV2ViRGF0YVN0b3JlIGZyb20gXCIuL09XZWJEYXRhU3RvcmVcIjtcbmltcG9ydCBPV2ViRXZlbnQgZnJvbSBcIi4vT1dlYkV2ZW50XCI7XG5pbXBvcnQgT1dlYkZvcm1WYWxpZGF0b3IgZnJvbSBcIi4vT1dlYkZvcm1WYWxpZGF0b3JcIjtcbmltcG9ydCBPV2ViUm91dGVyIGZyb20gXCIuL09XZWJSb3V0ZXJcIjtcbmltcG9ydCBPV2ViU2VydmljZSBmcm9tIFwiLi9PV2ViU2VydmljZVwiO1xuaW1wb3J0IE9XZWJVcmwsIHt0VXJsTGlzdH0gZnJvbSBcIi4vT1dlYlVybFwiO1xuaW1wb3J0IE9XZWJWaWV3IGZyb20gXCIuL09XZWJWaWV3XCI7XG5pbXBvcnQgT1dlYkRhdGUgZnJvbSBcIi4vcGx1Z2lucy9PV2ViRGF0ZVwiO1xuaW1wb3J0IFV0aWxzIGZyb20gXCIuL3V0aWxzL1V0aWxzXCI7XG5cbmNvbnN0IG5vb3AgPSAoKSA9PiB7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBhYnN0cmFjdCBjbGFzcyBPV2ViQXBwIGV4dGVuZHMgT1dlYkV2ZW50IHtcblxuXHRzdGF0aWMgcmVhZG9ubHkgU0VMRiAgICAgICAgICA9IFV0aWxzLmlkKCk7XG5cdHN0YXRpYyByZWFkb25seSBFVlRfQVBQX1JFQURZID0gVXRpbHMuaWQoKTtcblxuXHRyZWFkb25seSB2aWV3OiBPV2ViVmlldztcblx0cmVhZG9ubHkgbHM6IE9XZWJEYXRhU3RvcmU7XG5cdHJlYWRvbmx5IHJvdXRlcjogT1dlYlJvdXRlcjtcblx0cmVhZG9ubHkgdXNlcjogT1dlYkN1cnJlbnRVc2VyO1xuXHRyZWFkb25seSBjb25maWdzOiBPV2ViQ29uZmlncztcblx0cmVhZG9ubHkgdXJsOiBPV2ViVXJsO1xuXHRyZWFkb25seSBzZXJ2aWNlczogeyBba2V5OiBzdHJpbmddOiBPV2ViU2VydmljZTxhbnk+IH0gPSB7fTtcblxuXHRwcm90ZWN0ZWQgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhcHBfbmFtZTogc3RyaW5nLCBhcHBfY29uZmlnX2xpc3Q6IHRDb25maWdMaXN0LCBhcHBfdXJsX2xpc3Q6IHRVcmxMaXN0KSB7XG5cdFx0c3VwZXIoKTtcblx0XHR0aGlzLmxzICAgICAgID0gbmV3IE9XZWJEYXRhU3RvcmUodGhpcyk7XG5cdFx0dGhpcy5jb25maWdzICA9IG5ldyBPV2ViQ29uZmlncyh0aGlzLCBhcHBfY29uZmlnX2xpc3QpO1xuXHRcdHRoaXMudXJsICAgICAgPSBuZXcgT1dlYlVybCh0aGlzLCBhcHBfdXJsX2xpc3QpO1xuXHRcdHRoaXMudXNlciAgICAgPSBuZXcgT1dlYkN1cnJlbnRVc2VyKHRoaXMpO1xuXHRcdHRoaXMudmlldyAgICAgPSBuZXcgT1dlYlZpZXcoKTtcblx0XHRsZXQgYmFzZV91cmwgID0gdGhpcy5jb25maWdzLmdldChcIk9XX0FQUF9MT0NBTF9CQVNFX1VSTFwiKSxcblx0XHRcdGhhc2hfbW9kZSA9IGZhbHNlICE9PSB0aGlzLmNvbmZpZ3MuZ2V0KFwiT1dfQVBQX1JPVVRFUl9IQVNIX01PREVcIik7XG5cdFx0dGhpcy5yb3V0ZXIgICA9IG5ldyBPV2ViUm91dGVyKGJhc2VfdXJsLCBoYXNoX21vZGUpO1xuXHR9XG5cblx0Z2V0QXBwTmFtZSgpOiBzdHJpbmcge1xuXHRcdHJldHVybiB0aGlzLmFwcF9uYW1lO1xuXHR9XG5cblx0aXNNb2JpbGVBcHAoKTogYm9vbGVhbiB7XG5cdFx0cmV0dXJuIFwiY29yZG92YVwiIGluIHdpbmRvdztcblx0fVxuXG5cdHN0YXJ0KCk6IHRoaXMge1xuXHRcdGNvbnNvbGUubG9nKFwiW09XZWJBcHBdIGFwcCBzdGFydGVkIVwiKTtcblx0XHR0aGlzLnRyaWdnZXIoT1dlYkFwcC5FVlRfQVBQX1JFQURZKTtcblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdGdldFNlcnZpY2U8VCA9IGFueT4oc2VydmljZV9uYW1lOiBzdHJpbmcpOiBPV2ViU2VydmljZTxUPiB8IHVuZGVmaW5lZCB7XG5cdFx0cmV0dXJuIHRoaXMuc2VydmljZXNbc2VydmljZV9uYW1lXTtcblx0fVxuXG5cdHJlZ2lzdGVyU2VydmljZTxUIGV4dGVuZHMgT1dlYlNlcnZpY2U8YW55Pj4oc2VydmljZTogVCk6IHRoaXMge1xuXG5cdFx0bGV0IHNlcnZpY2VfbmFtZSA9IHNlcnZpY2UuZ2V0TmFtZSgpO1xuXG5cdFx0aWYgKHRoaXMuc2VydmljZXNbc2VydmljZV9uYW1lXSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBBIHNlcnZpY2Ugd2l0aCB0aGUgbmFtZSBcIiR7c2VydmljZV9uYW1lfVwiIGFscmVhZHkgZGVmaW5lZC5gKTtcblx0XHR9XG5cblx0XHR0aGlzLnNlcnZpY2VzW3NlcnZpY2VfbmFtZV0gPSBzZXJ2aWNlO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRnZXRGb3JtVmFsaWRhdG9yKGZvcm06IEhUTUxGb3JtRWxlbWVudCwgcmVxdWlyZWQ6IEFycmF5PHN0cmluZz4gPSBbXSwgZXhjbHVkZWQ6IEFycmF5PHN0cmluZz4gPSBbXSwgY2hlY2tBbGw6IGJvb2xlYW4gPSBmYWxzZSkge1xuXHRcdHJldHVybiBuZXcgT1dlYkZvcm1WYWxpZGF0b3IodGhpcywgZm9ybSwgcmVxdWlyZWQsIGV4Y2x1ZGVkLCBjaGVja0FsbCk7XG5cdH1cblxuXHRmb3JjZUxvZ2luKCkge1xuXHRcdHRoaXMubHMuY2xlYXIoKTtcblx0XHR0aGlzLnNob3dMb2dpblBhZ2UoKTtcblx0fVxuXG5cdHJlbG9hZEFwcCgpIHtcblx0XHQvLyBUT0RPOiBpbnN0ZWFkIG9mIHJlbG9hZGluZyB0aGUgY3VycmVudCBsb2NhdGlvbiwgZmluZCBhIHdheSB0byBicm93c2UgdG8gd2ViIGFwcCBlbnRyeSBwb2ludFxuXHRcdC8vIGZvciBhbmRyb2lkICYgaW9zIHJlc3RhcnQgdGhlIGFwcFxuXHRcdC8vIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQodHJ1ZSk7XG5cdFx0dGhpcy5zaG93SG9tZVBhZ2UoKTtcblx0fVxuXG5cdGRlc3Ryb3lBcHAoKSB7XG5cdFx0Ly8gZXJhc2UgZGF0YVxuXHRcdHRoaXMubHMuY2xlYXIoKTtcblx0XHR0aGlzLnJlbG9hZEFwcCgpO1xuXHR9XG5cblx0Y2xvc2VBcHAoKSB7XG5cdFx0Ly8gY29yZG92YVxuXHRcdGlmICh3aW5kb3cubmF2aWdhdG9yICYmICh3aW5kb3cubmF2aWdhdG9yIGFzIGFueSkuYXBwKSB7XG5cdFx0XHQod2luZG93Lm5hdmlnYXRvciBhcyBhbnkpLmFwcC5leGl0QXBwKCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHdpbmRvdy5jbG9zZSgpO1xuXHRcdH1cblx0fVxuXG5cdHNlc3Npb25BY3RpdmUoKTogYm9vbGVhbiB7XG5cdFx0bGV0IG5vdyAgICA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7Ly8gbWlsbGlzZWNvbmRzXG5cdFx0bGV0IGhvdXIgICA9IDYwICogNjA7Ly8gc2Vjb25kc1xuXHRcdGxldCBleHBpcmUgPSB0aGlzLnVzZXIuZ2V0U2Vzc2lvbkV4cGlyZSgpIC0gaG91cjsvLyBzZWNvbmRzXG5cdFx0cmV0dXJuIChleHBpcmUgKiAxMDAwKSA+IG5vdztcblx0fVxuXG5cdHVzZXJWZXJpZmllZCgpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gQm9vbGVhbih0aGlzLnVzZXIuZ2V0Q3VycmVudFVzZXIoKSAmJiB0aGlzLnNlc3Npb25BY3RpdmUoKSk7XG5cdH1cblxuXHRyZXF1ZXN0UHJvbWlzZShtZXRob2Q6IHN0cmluZywgdXJsOiBzdHJpbmcsIGRhdGE6IGFueSwgZnJlZXplOiBib29sZWFuID0gZmFsc2UpOiBQcm9taXNlPGlDb21SZXNwb25zZT4ge1xuXHRcdGxldCBtID0gdGhpcztcblx0XHRyZXR1cm4gbmV3IFByb21pc2U8aUNvbVJlc3BvbnNlPihmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG5cdFx0XHRtLnJlcXVlc3QobWV0aG9kLCB1cmwsIGRhdGEsIHJlc29sdmUsIHJlamVjdCwgZnJlZXplKTtcblx0XHR9KTtcblx0fVxuXG5cdHJlcXVlc3QobWV0aG9kOiBzdHJpbmcsIHVybDogc3RyaW5nLCBkYXRhOiBhbnksIHN1Y2Nlc3M6IChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB2b2lkID0gbm9vcCwgZmFpbDogKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHZvaWQgPSBub29wLCBmcmVlemU6IGJvb2xlYW4gPSBmYWxzZSk6IE9XZWJDb20ge1xuXHRcdGxldCBhcHAgPSB0aGlzO1xuXG5cdFx0aWYgKGZyZWV6ZSkge1xuXHRcdFx0YXBwLnZpZXcuZnJlZXplKCk7XG5cdFx0fVxuXG5cdFx0bGV0IG9wdGlvbnMgPSB7XG5cdFx0XHR1cmwgICAgICAgIDogdXJsLFxuXHRcdFx0bWV0aG9kICAgICA6IG1ldGhvZCxcblx0XHRcdGRhdGEgICAgICAgOiBkYXRhLFxuXHRcdFx0YmFkTmV3c1Nob3c6IGZhbHNlXG5cdFx0fTtcblxuXHRcdGxldCBjb20gPSBuZXcgT1dlYkNvbSh0aGlzLCBvcHRpb25zKTtcblx0XHRjb20ub24oT1dlYkNvbS5FVlRfQ09NX1JFUVVFU1RfU1VDQ0VTUywgKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHtcblx0XHRcdC8vIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuXHRcdFx0aWYgKGZyZWV6ZSkge1xuXHRcdFx0XHRhcHAudmlldy51bmZyZWV6ZSgpO1xuXHRcdFx0fVxuXG5cdFx0XHRzdWNjZXNzKHJlc3BvbnNlKTtcblx0XHRcdC8vIH0sIDEwMDApO1xuXHRcdH0pLm9uKE9XZWJDb20uRVZUX0NPTV9SRVFVRVNUX0VSUk9SLCAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0aWYgKHJlc3BvbnNlW1wibXNnXCJdID09PSBcIk9aX0VSUk9SX1lPVV9BUkVfTk9UX0FETUlOXCIpIHtcblx0XHRcdFx0YXBwLmRlc3Ryb3lBcHAoKTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKGZyZWV6ZSkge1xuXHRcdFx0XHRhcHAudmlldy51bmZyZWV6ZSgpO1xuXHRcdFx0fVxuXG5cdFx0XHRmYWlsKHJlc3BvbnNlKTtcblx0XHR9KS5vbihPV2ViQ29tLkVWVF9DT01fTkVUV09SS19FUlJPUiwgKCkgPT4ge1xuXHRcdFx0aWYgKGZyZWV6ZSkge1xuXHRcdFx0XHRhcHAudmlldy51bmZyZWV6ZSgpO1xuXHRcdFx0fVxuXHRcdFx0bGV0IHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UgPSB7XG5cdFx0XHRcdFwiZXJyb3JcIjogMSxcblx0XHRcdFx0XCJtc2dcIiAgOiBcIk9aX0VSUk9SX1JFUVVFU1RfRkFJTFwiLFxuXHRcdFx0XHRcInV0aW1lXCI6IE9XZWJEYXRlLnRpbWVzdGFtcCgpXG5cdFx0XHR9O1xuXG5cdFx0XHRyZXNwb25zZS5uZXRlcnJvciA9IHRydWU7XG5cblx0XHRcdGZhaWwocmVzcG9uc2UpO1xuXHRcdH0pLnNlbmQoKTtcblxuXHRcdHJldHVybiBjb207XG5cdH1cblxuXHRhYnN0cmFjdCBzaG93SG9tZVBhZ2UoKTogdGhpc1xuXG5cdGFic3RyYWN0IHNob3dMb2dpblBhZ2UoKTogdGhpc1xuXG5cdGFic3RyYWN0IHNob3dTaWduVXBQYWdlKCk6IHRoaXNcbn07XG4iXX0=