import { Utils, OWebCustomError } from "./oweb";
let formValidators = {};
export class OWebFormError extends OWebCustomError {
    constructor() {
        super(...arguments);
        this.__oweb_form_error = true;
    }
}
export default class OWebFormValidator {
    constructor(app_context, form, required = [], excluded = [], checkAll = false) {
        this.app_context = app_context;
        this.form = form;
        this.required = required;
        this.excluded = excluded;
        this.checkAll = checkAll;
        this.validatorsMap = {};
        this.errorList = [];
        if (!form || form.nodeName !== "FORM") {
            throw new Error("[OWebFormValidator] a valid form element is required.");
        }
        let m = this;
        this.form = form;
        this.formData = new FormData(this.form);
        let fo = this.form.querySelectorAll("[data-oweb-form-v]"); // return NodeList not Array of node (ex: in Firefox)
        (Utils.isArray(fo) ? fo : Utils.toArray(fo)).forEach((field) => {
            let name = field.getAttribute("name"), validator_name = field.getAttribute("data-oweb-form-v");
            if (name) {
                if (!formValidators[validator_name]) {
                    throw new Error(`[OWebFormValidator] validator "${validator_name}" is explicitly set for field "${name}" but is not defined.`);
                }
                m.validatorsMap[name] = validator_name;
            }
        });
    }
    getForm() {
        return this.form;
    }
    getAppContext() {
        return this.app_context;
    }
    getConfig(key) {
        return this.getAppContext().configs.get(key);
    }
    getFormData(fields) {
        if (Utils.isArray(fields)) {
            let formData = new FormData();
            for (let i = 0; i < fields.length; i++) {
                let field = fields[i];
                let values = this.getAllFields(field); //for checkboxes and others
                values.forEach((value) => {
                    formData.append(field, value);
                });
            }
            return formData;
        }
        return this.formData;
    }
    getField(name) {
        return this.formData.get(name);
    }
    setField(name, value) {
        this.formData.set(name, value);
        return this;
    }
    // for checkboxes and others
    getAllFields(name) {
        return this.formData.getAll(name);
    }
    getFieldDescription(name) {
        let field = this.form.querySelector("[name='" + name + "']"), description = name;
        if (field) {
            let id = field.getAttribute("id"), label, placeholder;
            if (id && (label = this.form.querySelector("label[for='" + id + "']"))) {
                description = label.textContent;
            }
            else if ((placeholder = field.getAttribute("placeholder")) && placeholder.trim().length) {
                description = placeholder;
            }
        }
        return description;
    }
    getErrors() {
        return this.errorList;
    }
    validate() {
        let context = this, c = -1, field_names = [], name;
        // empty error list
        context.errorList.splice(0);
        Utils.toArray(context.form.elements).forEach(function (i) {
            if (i.name !== undefined && field_names.indexOf(i.name) < 0) {
                field_names.push(i.name);
            }
        });
        while (name = field_names[++c]) {
            try {
                if (context.excluded.indexOf(name) < 0) {
                    let value = context.getField(name), validator_name = context.validatorsMap[name] || name, fn = formValidators[validator_name];
                    if (Utils.isNotEmpty(value)) {
                        if (Utils.isFunction(fn)) {
                            fn(value, name, context);
                        }
                        else {
                            console.warn("[OWebFormValidator] validator '%s' is not defined, field '%s' is then considered as safe.", validator_name, name);
                        }
                    }
                    else if (~context.required.indexOf(name)) {
                        this.assert(false, "OZ_FORM_CONTAINS_EMPTY_FIELD", { "label": context.getFieldDescription(name) });
                    }
                }
            }
            catch (e) {
                if (e.__oweb_form_error) {
                    this.errorList.push(e);
                    if (!this.checkAll) {
                        this.getAppContext().view.dialog({
                            type: "error",
                            text: e.message,
                            data: e.data
                        });
                        break;
                    }
                }
                else {
                    throw e;
                }
            }
        }
        return this.errorList.length === 0;
    }
    assert(assertion, message, data) {
        if (!assertion) {
            throw new OWebFormError(message, data);
        }
        return this;
    }
    static addFieldValidator(name, validator) {
        if (!Utils.isString(name)) {
            throw new TypeError("[OWebFormValidator] field name should be a valid string.");
        }
        if (!Utils.isFunction(validator)) {
            throw new TypeError("[OWebFormValidator] field validator should be a valid function.");
        }
        if (name in validator) {
            console.warn(`[OWebFormValidator] field "${name}" validator will be overwritten.`);
        }
        formValidators[name] = validator;
    }
    static addFieldValidators(map) {
        Utils.forEach(map, (fn, key) => {
            OWebFormValidator.addFieldValidator(key, fn);
        });
    }
}
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkZvcm1WYWxpZGF0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYkZvcm1WYWxpZGF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFVLEtBQUssRUFBRSxlQUFlLEVBQUMsTUFBTSxRQUFRLENBQUM7QUFJdkQsSUFBSSxjQUFjLEdBQXNDLEVBQUUsQ0FBQztBQUUzRCxNQUFNLG9CQUFxQixTQUFRLGVBQWU7SUFBbEQ7O1FBQ1Usc0JBQWlCLEdBQUcsSUFBSSxDQUFDO0lBQ25DLENBQUM7Q0FBQTtBQUVELE1BQU0sQ0FBQyxPQUFPO0lBS2IsWUFBNkIsV0FBb0IsRUFBbUIsSUFBcUIsRUFBbUIsV0FBMEIsRUFBRSxFQUFtQixXQUEwQixFQUFFLEVBQW1CLFdBQW9CLEtBQUs7UUFBdE0sZ0JBQVcsR0FBWCxXQUFXLENBQVM7UUFBbUIsU0FBSSxHQUFKLElBQUksQ0FBaUI7UUFBbUIsYUFBUSxHQUFSLFFBQVEsQ0FBb0I7UUFBbUIsYUFBUSxHQUFSLFFBQVEsQ0FBb0I7UUFBbUIsYUFBUSxHQUFSLFFBQVEsQ0FBaUI7UUFIM04sa0JBQWEsR0FBOEIsRUFBRSxDQUFDO1FBQzlDLGNBQVMsR0FBa0MsRUFBRSxDQUFDO1FBR3JELElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyxNQUFNLEVBQUU7WUFDdEMsTUFBTSxJQUFJLEtBQUssQ0FBQyx1REFBdUQsQ0FBQyxDQUFDO1NBQ3pFO1FBRUQsSUFBSSxDQUFDLEdBQVcsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxJQUFJLEdBQU8sSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3hDLElBQUksRUFBRSxHQUFVLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxDQUFBLHFEQUFxRDtRQUV0SCxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO1lBQzlELElBQUksSUFBSSxHQUFhLEtBQUssQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLEVBQzlDLGNBQWMsR0FBRyxLQUFLLENBQUMsWUFBWSxDQUFDLGtCQUFrQixDQUFDLENBQUM7WUFFekQsSUFBSSxJQUFJLEVBQUU7Z0JBQ1QsSUFBSSxDQUFDLGNBQWMsQ0FBQyxjQUFjLENBQUMsRUFBRTtvQkFDcEMsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQ0FBa0MsY0FBYyxrQ0FBbUMsSUFBSyx1QkFBdUIsQ0FBQyxDQUFDO2lCQUNqSTtnQkFFRCxDQUFDLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxHQUFHLGNBQWMsQ0FBQzthQUN2QztRQUNGLENBQUMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVELE9BQU87UUFDTixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDbEIsQ0FBQztJQUVELGFBQWE7UUFDWixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7SUFDekIsQ0FBQztJQUVELFNBQVMsQ0FBQyxHQUFXO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDOUMsQ0FBQztJQUVELFdBQVcsQ0FBQyxNQUFxQjtRQUVoQyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDMUIsSUFBSSxRQUFRLEdBQUcsSUFBSSxRQUFRLEVBQUUsQ0FBQztZQUM5QixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDdkMsSUFBSSxLQUFLLEdBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN2QixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUEsMkJBQTJCO2dCQUNqRSxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBVSxFQUFFLEVBQUU7b0JBQzdCLFFBQVEsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUMvQixDQUFDLENBQUMsQ0FBQzthQUNIO1lBRUQsT0FBTyxRQUFRLENBQUM7U0FDaEI7UUFFRCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDdEIsQ0FBQztJQUVELFFBQVEsQ0FBQyxJQUFZO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVELFFBQVEsQ0FBQyxJQUFZLEVBQUUsS0FBVTtRQUNoQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDL0IsT0FBTyxJQUFJLENBQUM7SUFDYixDQUFDO0lBRUQsNEJBQTRCO0lBQzVCLFlBQVksQ0FBQyxJQUFZO1FBQ3hCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVELG1CQUFtQixDQUFDLElBQVk7UUFDL0IsSUFBSSxLQUFLLEdBQWMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxHQUFHLElBQUksR0FBRyxJQUFJLENBQUMsRUFDdEUsV0FBVyxHQUFRLElBQUksQ0FBQztRQUV6QixJQUFJLEtBQUssRUFBRTtZQUNWLElBQUksRUFBRSxHQUFHLEtBQUssQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLFdBQVcsQ0FBQztZQUN0RCxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxhQUFhLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLEVBQUU7Z0JBQ3ZFLFdBQVcsR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDO2FBQ2hDO2lCQUFNLElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUU7Z0JBQzFGLFdBQVcsR0FBRyxXQUFXLENBQUM7YUFDMUI7U0FDRDtRQUVELE9BQU8sV0FBVyxDQUFDO0lBQ3BCLENBQUM7SUFFRCxTQUFTO1FBQ1IsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxRQUFRO1FBQ1AsSUFBSSxPQUFPLEdBQXNCLElBQUksRUFDcEMsQ0FBQyxHQUE0QixDQUFDLENBQUMsRUFDL0IsV0FBVyxHQUFrQixFQUFFLEVBQy9CLElBQUksQ0FBQztRQUVOLG1CQUFtQjtRQUNuQixPQUFPLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUU1QixLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQztZQUN2RCxJQUFJLENBQUMsQ0FBQyxJQUFJLEtBQUssU0FBUyxJQUFJLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDNUQsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDekI7UUFDRixDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sSUFBSSxHQUFHLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFO1lBQy9CLElBQUk7Z0JBQ0gsSUFBSSxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUU7b0JBQ3ZDLElBQUksS0FBSyxHQUFZLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQzFDLGNBQWMsR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksRUFDcEQsRUFBRSxHQUFlLGNBQWMsQ0FBQyxjQUFjLENBQUMsQ0FBQztvQkFFakQsSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxFQUFFO3dCQUM1QixJQUFJLEtBQUssQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLEVBQUU7NEJBQ3pCLEVBQUUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO3lCQUN6Qjs2QkFBTTs0QkFDTixPQUFPLENBQUMsSUFBSSxDQUFDLDJGQUEyRixFQUFFLGNBQWMsRUFBRSxJQUFJLENBQUMsQ0FBQzt5QkFDaEk7cUJBQ0Q7eUJBQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO3dCQUMzQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSw4QkFBOEIsRUFBRSxFQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLEVBQUMsQ0FBQyxDQUFDO3FCQUNqRztpQkFDRDthQUNEO1lBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQ1gsSUFBSSxDQUFDLENBQUMsaUJBQWlCLEVBQUU7b0JBRXhCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUV2QixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTt3QkFDbkIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7NEJBQ2hDLElBQUksRUFBRSxPQUFPOzRCQUNiLElBQUksRUFBRSxDQUFDLENBQUMsT0FBTzs0QkFDZixJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUk7eUJBQ1osQ0FBQyxDQUFDO3dCQUNILE1BQU07cUJBQ047aUJBRUQ7cUJBQU07b0JBQ04sTUFBTSxDQUFDLENBQUE7aUJBQ1A7YUFDRDtTQUNEO1FBRUQsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVELE1BQU0sQ0FBQyxTQUFjLEVBQUUsT0FBZSxFQUFFLElBQVM7UUFDaEQsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNmLE1BQU0sSUFBSSxhQUFhLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ3ZDO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDYixDQUFDO0lBRUQsTUFBTSxDQUFDLGlCQUFpQixDQUFDLElBQVksRUFBRSxTQUF5QjtRQUUvRCxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUMxQixNQUFNLElBQUksU0FBUyxDQUFDLDBEQUEwRCxDQUFDLENBQUM7U0FDaEY7UUFFRCxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUNqQyxNQUFNLElBQUksU0FBUyxDQUFDLGlFQUFpRSxDQUFDLENBQUM7U0FDdkY7UUFFRCxJQUFJLElBQUksSUFBSSxTQUFTLEVBQUU7WUFDdEIsT0FBTyxDQUFDLElBQUksQ0FBQyw4QkFBOEIsSUFBSSxrQ0FBa0MsQ0FBQyxDQUFDO1NBQ25GO1FBRUQsY0FBYyxDQUFDLElBQUksQ0FBQyxHQUFHLFNBQVMsQ0FBQztJQUNsQyxDQUFDO0lBRUQsTUFBTSxDQUFDLGtCQUFrQixDQUFDLEdBQXNDO1FBQy9ELEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBa0IsRUFBRSxHQUFXLEVBQUUsRUFBRTtZQUN0RCxpQkFBaUIsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDOUMsQ0FBQyxDQUFDLENBQUM7SUFDSixDQUFDO0NBQ0Q7QUFBQSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtPV2ViQXBwLCBVdGlscywgT1dlYkN1c3RvbUVycm9yfSBmcm9tIFwiLi9vd2ViXCI7XG5cbmV4cG9ydCB0eXBlIHRGb3JtVmFsaWRhdG9yID0gKHZhbHVlOiBhbnksIG5hbWU6IHN0cmluZywgY29udGV4dDogT1dlYkZvcm1WYWxpZGF0b3IpID0+IHZvaWQ7XG5cbmxldCBmb3JtVmFsaWRhdG9yczogeyBba2V5OiBzdHJpbmddOiB0Rm9ybVZhbGlkYXRvciB9ID0ge307XG5cbmV4cG9ydCBjbGFzcyBPV2ViRm9ybUVycm9yIGV4dGVuZHMgT1dlYkN1c3RvbUVycm9yIHtcblx0cmVhZG9ubHkgX19vd2ViX2Zvcm1fZXJyb3IgPSB0cnVlO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViRm9ybVZhbGlkYXRvciB7XG5cdHByaXZhdGUgcmVhZG9ubHkgZm9ybURhdGE6IEZvcm1EYXRhO1xuXHRwcml2YXRlIHZhbGlkYXRvcnNNYXA6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0gPSB7fTtcblx0cHJpdmF0ZSBlcnJvckxpc3Q6IE9XZWJGb3JtRXJyb3JbXSAgICAgICAgICAgICAgID0gW107XG5cblx0Y29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhcHBfY29udGV4dDogT1dlYkFwcCwgcHJpdmF0ZSByZWFkb25seSBmb3JtOiBIVE1MRm9ybUVsZW1lbnQsIHByaXZhdGUgcmVhZG9ubHkgcmVxdWlyZWQ6IEFycmF5PHN0cmluZz4gPSBbXSwgcHJpdmF0ZSByZWFkb25seSBleGNsdWRlZDogQXJyYXk8c3RyaW5nPiA9IFtdLCBwcml2YXRlIHJlYWRvbmx5IGNoZWNrQWxsOiBib29sZWFuID0gZmFsc2UpIHtcblx0XHRpZiAoIWZvcm0gfHwgZm9ybS5ub2RlTmFtZSAhPT0gXCJGT1JNXCIpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihcIltPV2ViRm9ybVZhbGlkYXRvcl0gYSB2YWxpZCBmb3JtIGVsZW1lbnQgaXMgcmVxdWlyZWQuXCIpO1xuXHRcdH1cblxuXHRcdGxldCBtICAgICAgICAgPSB0aGlzO1xuXHRcdHRoaXMuZm9ybSAgICAgPSBmb3JtO1xuXHRcdHRoaXMuZm9ybURhdGEgPSBuZXcgRm9ybURhdGEodGhpcy5mb3JtKTtcblx0XHRsZXQgZm8gICAgICAgID0gdGhpcy5mb3JtLnF1ZXJ5U2VsZWN0b3JBbGwoXCJbZGF0YS1vd2ViLWZvcm0tdl1cIik7Ly8gcmV0dXJuIE5vZGVMaXN0IG5vdCBBcnJheSBvZiBub2RlIChleDogaW4gRmlyZWZveClcblxuXHRcdChVdGlscy5pc0FycmF5KGZvKSA/IGZvIDogVXRpbHMudG9BcnJheShmbykpLmZvckVhY2goKGZpZWxkKSA9PiB7XG5cdFx0XHRsZXQgbmFtZSAgICAgICAgICAgPSBmaWVsZC5nZXRBdHRyaWJ1dGUoXCJuYW1lXCIpLFxuXHRcdFx0XHR2YWxpZGF0b3JfbmFtZSA9IGZpZWxkLmdldEF0dHJpYnV0ZShcImRhdGEtb3dlYi1mb3JtLXZcIik7XG5cblx0XHRcdGlmIChuYW1lKSB7XG5cdFx0XHRcdGlmICghZm9ybVZhbGlkYXRvcnNbdmFsaWRhdG9yX25hbWVdKSB7XG5cdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKGBbT1dlYkZvcm1WYWxpZGF0b3JdIHZhbGlkYXRvciBcIiR7dmFsaWRhdG9yX25hbWV9XCIgaXMgZXhwbGljaXRseSBzZXQgZm9yIGZpZWxkIFwiJHsgbmFtZSB9XCIgYnV0IGlzIG5vdCBkZWZpbmVkLmApO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0bS52YWxpZGF0b3JzTWFwW25hbWVdID0gdmFsaWRhdG9yX25hbWU7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblxuXHRnZXRGb3JtKCk6IEhUTUxGb3JtRWxlbWVudCB7XG5cdFx0cmV0dXJuIHRoaXMuZm9ybTtcblx0fVxuXG5cdGdldEFwcENvbnRleHQoKTogT1dlYkFwcCB7XG5cdFx0cmV0dXJuIHRoaXMuYXBwX2NvbnRleHQ7XG5cdH1cblxuXHRnZXRDb25maWcoa2V5OiBzdHJpbmcpOiBhbnkge1xuXHRcdHJldHVybiB0aGlzLmdldEFwcENvbnRleHQoKS5jb25maWdzLmdldChrZXkpO1xuXHR9XG5cblx0Z2V0Rm9ybURhdGEoZmllbGRzOiBBcnJheTxzdHJpbmc+KTogRm9ybURhdGEge1xuXG5cdFx0aWYgKFV0aWxzLmlzQXJyYXkoZmllbGRzKSkge1xuXHRcdFx0bGV0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG5cdFx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGZpZWxkcy5sZW5ndGg7IGkrKykge1xuXHRcdFx0XHRsZXQgZmllbGQgID0gZmllbGRzW2ldO1xuXHRcdFx0XHRsZXQgdmFsdWVzID0gdGhpcy5nZXRBbGxGaWVsZHMoZmllbGQpOy8vZm9yIGNoZWNrYm94ZXMgYW5kIG90aGVyc1xuXHRcdFx0XHR2YWx1ZXMuZm9yRWFjaCgodmFsdWU6IGFueSkgPT4ge1xuXHRcdFx0XHRcdGZvcm1EYXRhLmFwcGVuZChmaWVsZCwgdmFsdWUpO1xuXHRcdFx0XHR9KTtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIGZvcm1EYXRhO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzLmZvcm1EYXRhO1xuXHR9XG5cblx0Z2V0RmllbGQobmFtZTogc3RyaW5nKTogYW55IHtcblx0XHRyZXR1cm4gdGhpcy5mb3JtRGF0YS5nZXQobmFtZSk7XG5cdH1cblxuXHRzZXRGaWVsZChuYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpOiB0aGlzIHtcblx0XHR0aGlzLmZvcm1EYXRhLnNldChuYW1lLCB2YWx1ZSk7XG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvLyBmb3IgY2hlY2tib3hlcyBhbmQgb3RoZXJzXG5cdGdldEFsbEZpZWxkcyhuYW1lOiBzdHJpbmcpOiBhbnkge1xuXHRcdHJldHVybiB0aGlzLmZvcm1EYXRhLmdldEFsbChuYW1lKTtcblx0fVxuXG5cdGdldEZpZWxkRGVzY3JpcHRpb24obmFtZTogc3RyaW5nKTogc3RyaW5nIHtcblx0XHRsZXQgZmllbGQgICAgICAgICAgICA9IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKFwiW25hbWU9J1wiICsgbmFtZSArIFwiJ11cIiksXG5cdFx0XHRkZXNjcmlwdGlvbjogYW55ID0gbmFtZTtcblxuXHRcdGlmIChmaWVsZCkge1xuXHRcdFx0bGV0IGlkID0gZmllbGQuZ2V0QXR0cmlidXRlKFwiaWRcIiksIGxhYmVsLCBwbGFjZWhvbGRlcjtcblx0XHRcdGlmIChpZCAmJiAobGFiZWwgPSB0aGlzLmZvcm0ucXVlcnlTZWxlY3RvcihcImxhYmVsW2Zvcj0nXCIgKyBpZCArIFwiJ11cIikpKSB7XG5cdFx0XHRcdGRlc2NyaXB0aW9uID0gbGFiZWwudGV4dENvbnRlbnQ7XG5cdFx0XHR9IGVsc2UgaWYgKChwbGFjZWhvbGRlciA9IGZpZWxkLmdldEF0dHJpYnV0ZShcInBsYWNlaG9sZGVyXCIpKSAmJiBwbGFjZWhvbGRlci50cmltKCkubGVuZ3RoKSB7XG5cdFx0XHRcdGRlc2NyaXB0aW9uID0gcGxhY2Vob2xkZXI7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGRlc2NyaXB0aW9uO1xuXHR9XG5cblx0Z2V0RXJyb3JzKCk6IEFycmF5PE9XZWJGb3JtRXJyb3I+IHtcblx0XHRyZXR1cm4gdGhpcy5lcnJvckxpc3Q7XG5cdH1cblxuXHR2YWxpZGF0ZSgpOiBib29sZWFuIHtcblx0XHRsZXQgY29udGV4dCAgICAgICAgICAgICAgICAgICAgPSB0aGlzLFxuXHRcdFx0YyAgICAgICAgICAgICAgICAgICAgICAgICAgPSAtMSxcblx0XHRcdGZpZWxkX25hbWVzOiBBcnJheTxzdHJpbmc+ID0gW10sXG5cdFx0XHRuYW1lO1xuXG5cdFx0Ly8gZW1wdHkgZXJyb3IgbGlzdFxuXHRcdGNvbnRleHQuZXJyb3JMaXN0LnNwbGljZSgwKTtcblxuXHRcdFV0aWxzLnRvQXJyYXkoY29udGV4dC5mb3JtLmVsZW1lbnRzKS5mb3JFYWNoKGZ1bmN0aW9uIChpKSB7XG5cdFx0XHRpZiAoaS5uYW1lICE9PSB1bmRlZmluZWQgJiYgZmllbGRfbmFtZXMuaW5kZXhPZihpLm5hbWUpIDwgMCkge1xuXHRcdFx0XHRmaWVsZF9uYW1lcy5wdXNoKGkubmFtZSk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cblx0XHR3aGlsZSAobmFtZSA9IGZpZWxkX25hbWVzWysrY10pIHtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdGlmIChjb250ZXh0LmV4Y2x1ZGVkLmluZGV4T2YobmFtZSkgPCAwKSB7XG5cdFx0XHRcdFx0bGV0IHZhbHVlICAgICAgICAgID0gY29udGV4dC5nZXRGaWVsZChuYW1lKSxcblx0XHRcdFx0XHRcdHZhbGlkYXRvcl9uYW1lID0gY29udGV4dC52YWxpZGF0b3JzTWFwW25hbWVdIHx8IG5hbWUsXG5cdFx0XHRcdFx0XHRmbiAgICAgICAgICAgICA9IGZvcm1WYWxpZGF0b3JzW3ZhbGlkYXRvcl9uYW1lXTtcblxuXHRcdFx0XHRcdGlmIChVdGlscy5pc05vdEVtcHR5KHZhbHVlKSkge1xuXHRcdFx0XHRcdFx0aWYgKFV0aWxzLmlzRnVuY3Rpb24oZm4pKSB7XG5cdFx0XHRcdFx0XHRcdGZuKHZhbHVlLCBuYW1lLCBjb250ZXh0KTtcblx0XHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRcdGNvbnNvbGUud2FybihcIltPV2ViRm9ybVZhbGlkYXRvcl0gdmFsaWRhdG9yICclcycgaXMgbm90IGRlZmluZWQsIGZpZWxkICclcycgaXMgdGhlbiBjb25zaWRlcmVkIGFzIHNhZmUuXCIsIHZhbGlkYXRvcl9uYW1lLCBuYW1lKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9IGVsc2UgaWYgKH5jb250ZXh0LnJlcXVpcmVkLmluZGV4T2YobmFtZSkpIHtcblx0XHRcdFx0XHRcdHRoaXMuYXNzZXJ0KGZhbHNlLCBcIk9aX0ZPUk1fQ09OVEFJTlNfRU1QVFlfRklFTERcIiwge1wibGFiZWxcIjogY29udGV4dC5nZXRGaWVsZERlc2NyaXB0aW9uKG5hbWUpfSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRcdGlmIChlLl9fb3dlYl9mb3JtX2Vycm9yKSB7XG5cblx0XHRcdFx0XHR0aGlzLmVycm9yTGlzdC5wdXNoKGUpO1xuXG5cdFx0XHRcdFx0aWYgKCF0aGlzLmNoZWNrQWxsKSB7XG5cdFx0XHRcdFx0XHR0aGlzLmdldEFwcENvbnRleHQoKS52aWV3LmRpYWxvZyh7XG5cdFx0XHRcdFx0XHRcdHR5cGU6IFwiZXJyb3JcIixcblx0XHRcdFx0XHRcdFx0dGV4dDogZS5tZXNzYWdlLFxuXHRcdFx0XHRcdFx0XHRkYXRhOiBlLmRhdGFcblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0dGhyb3cgZVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuZXJyb3JMaXN0Lmxlbmd0aCA9PT0gMDtcblx0fVxuXG5cdGFzc2VydChhc3NlcnRpb246IGFueSwgbWVzc2FnZTogc3RyaW5nLCBkYXRhPzoge30pOiB0aGlzIHtcblx0XHRpZiAoIWFzc2VydGlvbikge1xuXHRcdFx0dGhyb3cgbmV3IE9XZWJGb3JtRXJyb3IobWVzc2FnZSwgZGF0YSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRzdGF0aWMgYWRkRmllbGRWYWxpZGF0b3IobmFtZTogc3RyaW5nLCB2YWxpZGF0b3I6IHRGb3JtVmFsaWRhdG9yKTogdm9pZCB7XG5cblx0XHRpZiAoIVV0aWxzLmlzU3RyaW5nKG5hbWUpKSB7XG5cdFx0XHR0aHJvdyBuZXcgVHlwZUVycm9yKFwiW09XZWJGb3JtVmFsaWRhdG9yXSBmaWVsZCBuYW1lIHNob3VsZCBiZSBhIHZhbGlkIHN0cmluZy5cIik7XG5cdFx0fVxuXG5cdFx0aWYgKCFVdGlscy5pc0Z1bmN0aW9uKHZhbGlkYXRvcikpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoXCJbT1dlYkZvcm1WYWxpZGF0b3JdIGZpZWxkIHZhbGlkYXRvciBzaG91bGQgYmUgYSB2YWxpZCBmdW5jdGlvbi5cIik7XG5cdFx0fVxuXG5cdFx0aWYgKG5hbWUgaW4gdmFsaWRhdG9yKSB7XG5cdFx0XHRjb25zb2xlLndhcm4oYFtPV2ViRm9ybVZhbGlkYXRvcl0gZmllbGQgXCIke25hbWV9XCIgdmFsaWRhdG9yIHdpbGwgYmUgb3ZlcndyaXR0ZW4uYCk7XG5cdFx0fVxuXG5cdFx0Zm9ybVZhbGlkYXRvcnNbbmFtZV0gPSB2YWxpZGF0b3I7XG5cdH1cblxuXHRzdGF0aWMgYWRkRmllbGRWYWxpZGF0b3JzKG1hcDogeyBba2V5OiBzdHJpbmddOiB0Rm9ybVZhbGlkYXRvciB9KTogdm9pZCB7XG5cdFx0VXRpbHMuZm9yRWFjaChtYXAsIChmbjogdEZvcm1WYWxpZGF0b3IsIGtleTogc3RyaW5nKSA9PiB7XG5cdFx0XHRPV2ViRm9ybVZhbGlkYXRvci5hZGRGaWVsZFZhbGlkYXRvcihrZXksIGZuKTtcblx0XHR9KTtcblx0fVxufTsiXX0=