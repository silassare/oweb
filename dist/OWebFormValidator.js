"use strict";
import OWebCustomError from "./OWebCustomError";
import Utils from "./utils/Utils";
let formValidators = {};
export default class OWebFormValidator {
    constructor(app_context, form, required = [], excluded = [], checkAll = false) {
        this.app_context = app_context;
        this.form = form;
        this.required = required;
        this.excluded = excluded;
        this.checkAll = checkAll;
        this.validatorsMap = {};
        this.errorList = [];
        if (!form || form.nodeName !== "FORM") {
            throw new Error("[OWebFormValidator] a valid form element is required.");
        }
        let m = this;
        this.form = form;
        this.formData = new FormData(this.form);
        let fo = this.form.querySelectorAll("[data-oweb-form-v]"); // return NodeList not Array of node (ex: in Firefox)
        (Utils.isArray(fo) ? fo : Utils.toArray(fo)).forEach((field) => {
            let name = field.getAttribute("name"), validator_name = field.getAttribute("data-oweb-form-v");
            if (name) {
                if (!formValidators[validator_name]) {
                    throw new Error(`[OWebFormValidator] validator "${validator_name}" is explicitly set for field "${name}" but is not defined.`);
                }
                m.validatorsMap[name] = validator_name;
            }
        });
    }
    getForm() {
        return this.form;
    }
    getAppContext() {
        return this.app_context;
    }
    getConfig(key) {
        return this.getAppContext().configs.get(key);
    }
    getFormData(fields) {
        if (Utils.isArray(fields)) {
            let formData = new FormData();
            for (let i = 0; i < fields.length; i++) {
                let field = fields[i];
                let values = this.getAllFields(field); //for checkboxes and others
                values.forEach((value) => {
                    formData.append(field, value);
                });
            }
            return formData;
        }
        return this.formData;
    }
    getField(name) {
        return this.formData.get(name);
    }
    setField(name, value) {
        this.formData.set(name, value);
        return this;
    }
    // for checkboxes and others
    getAllFields(name) {
        return this.formData.getAll(name);
    }
    getFieldDescription(name) {
        let field = this.form.querySelector("[name='" + name + "']"), description = name;
        if (field) {
            let id = field.getAttribute("id"), label, placeholder;
            if (id && (label = this.form.querySelector("label[for='" + id + "']"))) {
                description = label.textContent;
            }
            else if ((placeholder = field.getAttribute("placeholder")) && placeholder.trim().length) {
                description = placeholder;
            }
        }
        return description;
    }
    getErrors() {
        return this.errorList;
    }
    validate() {
        let context = this, c = -1, field_names = [], name;
        // empty error list
        context.errorList.splice(0);
        Utils.toArray(context.form.elements).forEach(function (i) {
            if (i.name !== undefined && field_names.indexOf(i.name) < 0) {
                field_names.push(i.name);
            }
        });
        while ((this.checkAll || !this.errorList.length) && (name = field_names[++c])) {
            try {
                if (context.excluded.indexOf(name) < 0) {
                    let value = context.getField(name), validator_name = context.validatorsMap[name] || name, fn = formValidators[validator_name];
                    if (~context.required.indexOf(name)) {
                        this.assert(Utils.isNotEmpty(value), "OZ_FORM_CONTAINS_EMPTY_FIELD", { "label": context.getFieldDescription(name) });
                    }
                    if (Utils.isFunction(fn)) {
                        fn(value, name, context);
                    }
                    else {
                        console.warn("[OWebFormValidator] validator '%s' is not defined, field '%s' is then considered as safe.", validator_name, name);
                    }
                }
            }
            catch (e) {
                if (context.catchable(e)) {
                    throw e;
                }
            }
        }
        return this.errorList.length === 0;
    }
    assert(assertion, message, data) {
        if (!assertion) {
            throw new OWebCustomError(message, data);
        }
        return this;
    }
    catchable(e) {
        if (e instanceof OWebCustomError) {
            if (this.checkAll) {
                this.errorList.push(e);
            }
            else {
                this.getAppContext().view.dialog({
                    type: "error",
                    text: e.message,
                    data: e.getData()
                });
            }
            return true;
        }
        return false;
    }
    static addFieldValidator(name, validator) {
        if (!Utils.isString(name)) {
            throw new TypeError("[OWebFormValidator] field name should be a valid string.");
        }
        if (!Utils.isFunction(validator)) {
            throw new TypeError("[OWebFormValidator] field validator should be a valid function.");
        }
        if (name in validator) {
            console.warn(`[OWebFormValidator] field "${name}" validator will be overwritten.`);
        }
        formValidators[name] = validator;
    }
    static addFieldValidators(map) {
        Utils.forEach(map, (fn, key) => {
            OWebFormValidator.addFieldValidator(key, fn);
        });
    }
}
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkZvcm1WYWxpZGF0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYkZvcm1WYWxpZGF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDO0FBRWIsT0FBTyxlQUFlLE1BQU0sbUJBQW1CLENBQUM7QUFDaEQsT0FBTyxLQUFLLE1BQU0sZUFBZSxDQUFDO0FBSWxDLElBQUksY0FBYyxHQUFzQyxFQUFFLENBQUM7QUFFM0QsTUFBTSxDQUFDLE9BQU87SUFLYixZQUE2QixXQUFvQixFQUFtQixJQUFxQixFQUFtQixXQUEwQixFQUFFLEVBQW1CLFdBQTBCLEVBQUUsRUFBbUIsV0FBb0IsS0FBSztRQUF0TSxnQkFBVyxHQUFYLFdBQVcsQ0FBUztRQUFtQixTQUFJLEdBQUosSUFBSSxDQUFpQjtRQUFtQixhQUFRLEdBQVIsUUFBUSxDQUFvQjtRQUFtQixhQUFRLEdBQVIsUUFBUSxDQUFvQjtRQUFtQixhQUFRLEdBQVIsUUFBUSxDQUFpQjtRQUgzTixrQkFBYSxHQUE4QixFQUFFLENBQUM7UUFDOUMsY0FBUyxHQUFrQyxFQUFFLENBQUM7UUFHckQsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLE1BQU0sRUFBRTtZQUN0QyxNQUFNLElBQUksS0FBSyxDQUFDLHVEQUF1RCxDQUFDLENBQUM7U0FDekU7UUFFRCxJQUFJLENBQUMsR0FBVyxJQUFJLENBQUM7UUFDckIsSUFBSSxDQUFDLElBQUksR0FBTyxJQUFJLENBQUM7UUFDckIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDeEMsSUFBSSxFQUFFLEdBQVUsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUEscURBQXFEO1FBRXRILENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMs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T1dlYkFwcCBmcm9tIFwiLi9PV2ViQXBwXCI7XG5pbXBvcnQgT1dlYkN1c3RvbUVycm9yIGZyb20gXCIuL09XZWJDdXN0b21FcnJvclwiO1xuaW1wb3J0IFV0aWxzIGZyb20gXCIuL3V0aWxzL1V0aWxzXCI7XG5cbmV4cG9ydCB0eXBlIHRGb3JtVmFsaWRhdG9yID0gKHZhbHVlOiBhbnksIG5hbWU6IHN0cmluZywgY29udGV4dDogT1dlYkZvcm1WYWxpZGF0b3IpID0+IHZvaWQ7XG5cbmxldCBmb3JtVmFsaWRhdG9yczogeyBba2V5OiBzdHJpbmddOiB0Rm9ybVZhbGlkYXRvciB9ID0ge307XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJGb3JtVmFsaWRhdG9yIHtcblx0cHJpdmF0ZSByZWFkb25seSBmb3JtRGF0YTogRm9ybURhdGE7XG5cdHByaXZhdGUgdmFsaWRhdG9yc01hcDogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9O1xuXHRwcml2YXRlIGVycm9yTGlzdDogT1dlYkN1c3RvbUVycm9yW10gICAgICAgICAgICAgPSBbXTtcblxuXHRjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGFwcF9jb250ZXh0OiBPV2ViQXBwLCBwcml2YXRlIHJlYWRvbmx5IGZvcm06IEhUTUxGb3JtRWxlbWVudCwgcHJpdmF0ZSByZWFkb25seSByZXF1aXJlZDogQXJyYXk8c3RyaW5nPiA9IFtdLCBwcml2YXRlIHJlYWRvbmx5IGV4Y2x1ZGVkOiBBcnJheTxzdHJpbmc+ID0gW10sIHByaXZhdGUgcmVhZG9ubHkgY2hlY2tBbGw6IGJvb2xlYW4gPSBmYWxzZSkge1xuXHRcdGlmICghZm9ybSB8fCBmb3JtLm5vZGVOYW1lICE9PSBcIkZPUk1cIikge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFwiW09XZWJGb3JtVmFsaWRhdG9yXSBhIHZhbGlkIGZvcm0gZWxlbWVudCBpcyByZXF1aXJlZC5cIik7XG5cdFx0fVxuXG5cdFx0bGV0IG0gICAgICAgICA9IHRoaXM7XG5cdFx0dGhpcy5mb3JtICAgICA9IGZvcm07XG5cdFx0dGhpcy5mb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSh0aGlzLmZvcm0pO1xuXHRcdGxldCBmbyAgICAgICAgPSB0aGlzLmZvcm0ucXVlcnlTZWxlY3RvckFsbChcIltkYXRhLW93ZWItZm9ybS12XVwiKTsvLyByZXR1cm4gTm9kZUxpc3Qgbm90IEFycmF5IG9mIG5vZGUgKGV4OiBpbiBGaXJlZm94KVxuXG5cdFx0KFV0aWxzLmlzQXJyYXkoZm8pID8gZm8gOiBVdGlscy50b0FycmF5KGZvKSkuZm9yRWFjaCgoZmllbGQpID0+IHtcblx0XHRcdGxldCBuYW1lICAgICAgICAgICA9IGZpZWxkLmdldEF0dHJpYnV0ZShcIm5hbWVcIiksXG5cdFx0XHRcdHZhbGlkYXRvcl9uYW1lID0gZmllbGQuZ2V0QXR0cmlidXRlKFwiZGF0YS1vd2ViLWZvcm0tdlwiKTtcblxuXHRcdFx0aWYgKG5hbWUpIHtcblx0XHRcdFx0aWYgKCFmb3JtVmFsaWRhdG9yc1t2YWxpZGF0b3JfbmFtZV0pIHtcblx0XHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoYFtPV2ViRm9ybVZhbGlkYXRvcl0gdmFsaWRhdG9yIFwiJHt2YWxpZGF0b3JfbmFtZX1cIiBpcyBleHBsaWNpdGx5IHNldCBmb3IgZmllbGQgXCIkeyBuYW1lIH1cIiBidXQgaXMgbm90IGRlZmluZWQuYCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRtLnZhbGlkYXRvcnNNYXBbbmFtZV0gPSB2YWxpZGF0b3JfbmFtZTtcblx0XHRcdH1cblx0XHR9KTtcblx0fVxuXG5cdGdldEZvcm0oKTogSFRNTEZvcm1FbGVtZW50IHtcblx0XHRyZXR1cm4gdGhpcy5mb3JtO1xuXHR9XG5cblx0Z2V0QXBwQ29udGV4dCgpOiBPV2ViQXBwIHtcblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dDtcblx0fVxuXG5cdGdldENvbmZpZyhrZXk6IHN0cmluZyk6IGFueSB7XG5cdFx0cmV0dXJuIHRoaXMuZ2V0QXBwQ29udGV4dCgpLmNvbmZpZ3MuZ2V0KGtleSk7XG5cdH1cblxuXHRnZXRGb3JtRGF0YShmaWVsZHM6IEFycmF5PHN0cmluZz4pOiBGb3JtRGF0YSB7XG5cblx0XHRpZiAoVXRpbHMuaXNBcnJheShmaWVsZHMpKSB7XG5cdFx0XHRsZXQgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcblx0XHRcdGZvciAobGV0IGkgPSAwOyBpIDwgZmllbGRzLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRcdGxldCBmaWVsZCAgPSBmaWVsZHNbaV07XG5cdFx0XHRcdGxldCB2YWx1ZXMgPSB0aGlzLmdldEFsbEZpZWxkcyhmaWVsZCk7Ly9mb3IgY2hlY2tib3hlcyBhbmQgb3RoZXJzXG5cdFx0XHRcdHZhbHVlcy5mb3JFYWNoKCh2YWx1ZTogYW55KSA9PiB7XG5cdFx0XHRcdFx0Zm9ybURhdGEuYXBwZW5kKGZpZWxkLCB2YWx1ZSk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gZm9ybURhdGE7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuZm9ybURhdGE7XG5cdH1cblxuXHRnZXRGaWVsZChuYW1lOiBzdHJpbmcpOiBhbnkge1xuXHRcdHJldHVybiB0aGlzLmZvcm1EYXRhLmdldChuYW1lKTtcblx0fVxuXG5cdHNldEZpZWxkKG5hbWU6IHN0cmluZywgdmFsdWU6IGFueSk6IHRoaXMge1xuXHRcdHRoaXMuZm9ybURhdGEuc2V0KG5hbWUsIHZhbHVlKTtcblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdC8vIGZvciBjaGVja2JveGVzIGFuZCBvdGhlcnNcblx0Z2V0QWxsRmllbGRzKG5hbWU6IHN0cmluZyk6IGFueSB7XG5cdFx0cmV0dXJuIHRoaXMuZm9ybURhdGEuZ2V0QWxsKG5hbWUpO1xuXHR9XG5cblx0Z2V0RmllbGREZXNjcmlwdGlvbihuYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuXHRcdGxldCBmaWVsZCAgICAgICAgICAgID0gdGhpcy5mb3JtLnF1ZXJ5U2VsZWN0b3IoXCJbbmFtZT0nXCIgKyBuYW1lICsgXCInXVwiKSxcblx0XHRcdGRlc2NyaXB0aW9uOiBhbnkgPSBuYW1lO1xuXG5cdFx0aWYgKGZpZWxkKSB7XG5cdFx0XHRsZXQgaWQgPSBmaWVsZC5nZXRBdHRyaWJ1dGUoXCJpZFwiKSwgbGFiZWwsIHBsYWNlaG9sZGVyO1xuXHRcdFx0aWYgKGlkICYmIChsYWJlbCA9IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKFwibGFiZWxbZm9yPSdcIiArIGlkICsgXCInXVwiKSkpIHtcblx0XHRcdFx0ZGVzY3JpcHRpb24gPSBsYWJlbC50ZXh0Q29udGVudDtcblx0XHRcdH0gZWxzZSBpZiAoKHBsYWNlaG9sZGVyID0gZmllbGQuZ2V0QXR0cmlidXRlKFwicGxhY2Vob2xkZXJcIikpICYmIHBsYWNlaG9sZGVyLnRyaW0oKS5sZW5ndGgpIHtcblx0XHRcdFx0ZGVzY3JpcHRpb24gPSBwbGFjZWhvbGRlcjtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gZGVzY3JpcHRpb247XG5cdH1cblxuXHRnZXRFcnJvcnMoKTogQXJyYXk8T1dlYkN1c3RvbUVycm9yPiB7XG5cdFx0cmV0dXJuIHRoaXMuZXJyb3JMaXN0O1xuXHR9XG5cblx0dmFsaWRhdGUoKTogYm9vbGVhbiB7XG5cdFx0bGV0IGNvbnRleHQgICAgICAgICAgICAgICAgICAgID0gdGhpcyxcblx0XHRcdGMgICAgICAgICAgICAgICAgICAgICAgICAgID0gLTEsXG5cdFx0XHRmaWVsZF9uYW1lczogQXJyYXk8c3RyaW5nPiA9IFtdLFxuXHRcdFx0bmFtZTtcblxuXHRcdC8vIGVtcHR5IGVycm9yIGxpc3Rcblx0XHRjb250ZXh0LmVycm9yTGlzdC5zcGxpY2UoMCk7XG5cblx0XHRVdGlscy50b0FycmF5KGNvbnRleHQuZm9ybS5lbGVtZW50cykuZm9yRWFjaChmdW5jdGlvbiAoaSkge1xuXHRcdFx0aWYgKGkubmFtZSAhPT0gdW5kZWZpbmVkICYmIGZpZWxkX25hbWVzLmluZGV4T2YoaS5uYW1lKSA8IDApIHtcblx0XHRcdFx0ZmllbGRfbmFtZXMucHVzaChpLm5hbWUpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXG5cdFx0d2hpbGUgKCh0aGlzLmNoZWNrQWxsIHx8ICF0aGlzLmVycm9yTGlzdC5sZW5ndGgpICYmIChuYW1lID0gZmllbGRfbmFtZXNbKytjXSkpIHtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdGlmIChjb250ZXh0LmV4Y2x1ZGVkLmluZGV4T2YobmFtZSkgPCAwKSB7XG5cdFx0XHRcdFx0bGV0IHZhbHVlICAgICAgICAgID0gY29udGV4dC5nZXRGaWVsZChuYW1lKSxcblx0XHRcdFx0XHRcdHZhbGlkYXRvcl9uYW1lID0gY29udGV4dC52YWxpZGF0b3JzTWFwW25hbWVdIHx8IG5hbWUsXG5cdFx0XHRcdFx0XHRmbiAgICAgICAgICAgICA9IGZvcm1WYWxpZGF0b3JzW3ZhbGlkYXRvcl9uYW1lXTtcblxuXHRcdFx0XHRcdGlmICh+Y29udGV4dC5yZXF1aXJlZC5pbmRleE9mKG5hbWUpKSB7XG5cdFx0XHRcdFx0XHR0aGlzLmFzc2VydChVdGlscy5pc05vdEVtcHR5KHZhbHVlKSwgXCJPWl9GT1JNX0NPTlRBSU5TX0VNUFRZX0ZJRUxEXCIsIHtcImxhYmVsXCI6IGNvbnRleHQuZ2V0RmllbGREZXNjcmlwdGlvbihuYW1lKX0pO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGlmIChVdGlscy5pc0Z1bmN0aW9uKGZuKSkge1xuXHRcdFx0XHRcdFx0Zm4odmFsdWUsIG5hbWUsIGNvbnRleHQpO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRjb25zb2xlLndhcm4oXCJbT1dlYkZvcm1WYWxpZGF0b3JdIHZhbGlkYXRvciAnJXMnIGlzIG5vdCBkZWZpbmVkLCBmaWVsZCAnJXMnIGlzIHRoZW4gY29uc2lkZXJlZCBhcyBzYWZlLlwiLCB2YWxpZGF0b3JfbmFtZSwgbmFtZSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRcdGlmIChjb250ZXh0LmNhdGNoYWJsZShlKSkge1xuXHRcdFx0XHRcdHRocm93IGU7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5lcnJvckxpc3QubGVuZ3RoID09PSAwO1xuXHR9XG5cblx0YXNzZXJ0KGFzc2VydGlvbjogYW55LCBtZXNzYWdlOiBzdHJpbmcsIGRhdGE/OiB7fSk6IHRoaXMge1xuXHRcdGlmICghYXNzZXJ0aW9uKSB7XG5cdFx0XHR0aHJvdyBuZXcgT1dlYkN1c3RvbUVycm9yKG1lc3NhZ2UsIGRhdGEpO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHByaXZhdGUgY2F0Y2hhYmxlKGU6IGFueSk6IGJvb2xlYW4ge1xuXHRcdGlmIChlIGluc3RhbmNlb2YgT1dlYkN1c3RvbUVycm9yKSB7XG5cdFx0XHRpZiAodGhpcy5jaGVja0FsbCkge1xuXHRcdFx0XHR0aGlzLmVycm9yTGlzdC5wdXNoKGUpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGhpcy5nZXRBcHBDb250ZXh0KCkudmlldy5kaWFsb2coe1xuXHRcdFx0XHRcdHR5cGU6IFwiZXJyb3JcIixcblx0XHRcdFx0XHR0ZXh0OiBlLm1lc3NhZ2UsXG5cdFx0XHRcdFx0ZGF0YTogZS5nZXREYXRhKClcblx0XHRcdFx0fSk7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiB0cnVlO1xuXHRcdH1cblxuXHRcdHJldHVybiBmYWxzZTtcblx0fVxuXG5cdHN0YXRpYyBhZGRGaWVsZFZhbGlkYXRvcihuYW1lOiBzdHJpbmcsIHZhbGlkYXRvcjogdEZvcm1WYWxpZGF0b3IpOiB2b2lkIHtcblxuXHRcdGlmICghVXRpbHMuaXNTdHJpbmcobmFtZSkpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoXCJbT1dlYkZvcm1WYWxpZGF0b3JdIGZpZWxkIG5hbWUgc2hvdWxkIGJlIGEgdmFsaWQgc3RyaW5nLlwiKTtcblx0XHR9XG5cblx0XHRpZiAoIVV0aWxzLmlzRnVuY3Rpb24odmFsaWRhdG9yKSkge1xuXHRcdFx0dGhyb3cgbmV3IFR5cGVFcnJvcihcIltPV2ViRm9ybVZhbGlkYXRvcl0gZmllbGQgdmFsaWRhdG9yIHNob3VsZCBiZSBhIHZhbGlkIGZ1bmN0aW9uLlwiKTtcblx0XHR9XG5cblx0XHRpZiAobmFtZSBpbiB2YWxpZGF0b3IpIHtcblx0XHRcdGNvbnNvbGUud2FybihgW09XZWJGb3JtVmFsaWRhdG9yXSBmaWVsZCBcIiR7bmFtZX1cIiB2YWxpZGF0b3Igd2lsbCBiZSBvdmVyd3JpdHRlbi5gKTtcblx0XHR9XG5cblx0XHRmb3JtVmFsaWRhdG9yc1tuYW1lXSA9IHZhbGlkYXRvcjtcblx0fVxuXG5cdHN0YXRpYyBhZGRGaWVsZFZhbGlkYXRvcnMobWFwOiB7IFtrZXk6IHN0cmluZ106IHRGb3JtVmFsaWRhdG9yIH0pOiB2b2lkIHtcblx0XHRVdGlscy5mb3JFYWNoKG1hcCwgKGZuOiB0Rm9ybVZhbGlkYXRvciwga2V5OiBzdHJpbmcpID0+IHtcblx0XHRcdE9XZWJGb3JtVmFsaWRhdG9yLmFkZEZpZWxkVmFsaWRhdG9yKGtleSwgZm4pO1xuXHRcdH0pO1xuXHR9XG59OyJdfQ==