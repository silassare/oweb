import { stringPlaceholderReplace } from '../utils';
const SERVICE_URL_FORMAT = ':host/:service', SERVICE_ENTITY_FORMAT = ':host/:service/:id', SERVICE_ENTITY_RELATION_FORMAT = ':host/:service/:id/:relation';
const apiCache = {};
export const getApiForHost = function getApiForHost(url) {
    for (const apiHost in apiCache) {
        if (url.startsWith(apiHost)) {
            return apiCache[apiHost];
        }
    }
    return undefined;
};
export default class OZone {
    _appContext;
    apiHost;
    /**
     * OZone constructor.
     *
     * @param _appContext
     */
    constructor(_appContext) {
        this._appContext = _appContext;
        this.apiHost = _appContext.configs
            .get('OZ_API_BASE_URL')
            .replace(/\/$/g, '');
    }
    /**
     * Create new ozone api instance or get from cache
     *
     */
    static instantiate(_appContext) {
        const apiHost = _appContext.configs.get('OZ_API_BASE_URL');
        if (!(apiHost in apiCache)) {
            apiCache[apiHost] = new OZone(_appContext);
        }
        return apiCache[apiHost];
    }
    /**
     * Makes a request.
     *
     * @param url The request url
     * @param options The request options
     */
    request(url, options = {}) {
        const _this = this, api = getApiForHost(url);
        if (api) {
            if (!options.headers) {
                options.headers = {};
            }
            if (this._appContext.configs.get('OZ_API_ALLOW_REAL_METHOD_HEADER')) {
                const realMethod = (options.method || 'get').toUpperCase(), replaceMethods = ['PATCH', 'PUT', 'DELETE'], realMethodHeader = this._appContext.configs.get('OZ_API_REAL_METHOD_HEADER_NAME');
                // we update request method
                if (~replaceMethods.indexOf(realMethod)) {
                    options.headers[realMethodHeader] = realMethod;
                    options.method = 'POST';
                }
            }
            const headerName = this._appContext.configs.get('OZ_API_KEY_HEADER_NAME');
            if (!options.headers[headerName]) {
                options.headers[headerName] =
                    this._appContext.configs.get('OZ_API_KEY');
            }
            if (!options.isGoodNews) {
                options.isGoodNews = (json) => {
                    return Boolean(json && json.error === 0);
                };
            }
            if (!options.errorResponseToDialog) {
                options.errorResponseToDialog = (response) => {
                    const json = response.json;
                    return json
                        ? { text: json.msg, data: json.data }
                        : { text: 'OZ_ERROR_NETWORK' };
                };
            }
        }
        const o = this._appContext.request(url, options);
        o.onResponse(function responseHandler(response) {
            const { json } = response;
            if (json && json.stime) {
                _this._appContext.user.setSessionExpire(json.stime);
            }
            if (json && json.stoken) {
                _this._appContext.user.setSessionToken(json.stoken);
            }
        });
        return o;
    }
    /**
     * Returns the service URI.
     *
     * @param serviceName The service name.
     */
    getServiceURI(serviceName) {
        return stringPlaceholderReplace(SERVICE_URL_FORMAT, {
            host: this.apiHost,
            service: serviceName,
        });
    }
    /**
     * Returns an absolute uri string.
     *
     * @param serviceName The service name.
     * @param path The path.
     */
    toAbsoluteURI(serviceName, path) {
        return this.getServiceURI(serviceName) + '/' + path.replace(/^\/+/, '');
    }
    /**
     * Returns entity URI.
     *
     * @param serviceName The service name.
     * @param id The entity id.
     */
    getItemURI(serviceName, id) {
        return stringPlaceholderReplace(SERVICE_ENTITY_FORMAT, {
            host: this.apiHost,
            service: serviceName,
            id,
        });
    }
    /**
     * Returns entity relation URI.
     *
     * @param serviceName The service name.
     * @param id The entity id.
     * @param relation The relation name.
     */
    getItemRelationURI(serviceName, id, relation) {
        return stringPlaceholderReplace(SERVICE_ENTITY_RELATION_FORMAT, {
            host: this.apiHost,
            service: serviceName,
            id,
            relation,
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1pvbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvb3pvbmUvT1pvbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sVUFBVSxDQUFDO0FBS3BELE1BQU0sa0JBQWtCLEdBQUcsZ0JBQWdCLEVBQzFDLHFCQUFxQixHQUFHLG9CQUFvQixFQUM1Qyw4QkFBOEIsR0FBRyw4QkFBOEIsQ0FBQztBQUVqRSxNQUFNLFFBQVEsR0FFVixFQUFFLENBQUM7QUFFUCxNQUFNLENBQUMsTUFBTSxhQUFhLEdBQUcsU0FBUyxhQUFhLENBQ2xELEdBQVc7SUFFWCxLQUFLLE1BQU0sT0FBTyxJQUFJLFFBQVEsRUFBRTtRQUMvQixJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDNUIsT0FBTyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDekI7S0FDRDtJQUVELE9BQU8sU0FBUyxDQUFDO0FBQ2xCLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxPQUFPLE9BQU8sS0FBSztJQVFLO0lBUGIsT0FBTyxDQUFTO0lBRWpDOzs7O09BSUc7SUFDSCxZQUE4QixXQUFvQjtRQUFwQixnQkFBVyxHQUFYLFdBQVcsQ0FBUztRQUNqRCxJQUFJLENBQUMsT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPO2FBQ2hDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQzthQUN0QixPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7SUFFRDs7O09BR0c7SUFDSCxNQUFNLENBQUMsV0FBVyxDQUFDLFdBQW9CO1FBQ3RDLE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFFM0QsSUFBSSxDQUFDLENBQUMsT0FBTyxJQUFJLFFBQVEsQ0FBQyxFQUFFO1lBQzNCLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxJ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QWUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDcEQ7UUFDRixDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sQ0FBQyxDQUFDO0lBQ1YsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxhQUFhLENBQUMsV0FBbUI7UUFDaEMsT0FBTyx3QkFBd0IsQ0FBQyxrQkFBa0IsRUFBRTtZQUNuRCxJQUFJLEVBQUUsSUFBSSxDQUFDLE9BQU87WUFDbEIsT0FBTyxFQUFFLFdBQVc7U0FDcEIsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsYUFBYSxDQUFDLFdBQW1CLEVBQUUsSUFBWTtRQUM5QyxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3pFLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILFVBQVUsQ0FBQyxXQUFtQixFQUFFLEVBQW1CO1FBQ2xELE9BQU8sd0JBQXdCLENBQUMscUJBQXFCLEVBQUU7WUFDdEQsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPO1lBQ2xCLE9BQU8sRUFBRSxXQUFXO1lBQ3BCLEVBQUU7U0FDRixDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQ7Ozs7OztPQU1HO0lBQ0gsa0JBQWtCLENBQ2pCLFdBQW1CLEVBQ25CLEVBQVUsRUFDVixRQUFnQjtRQUVoQixPQUFPLHdCQUF3QixDQUFDLDhCQUE4QixFQUFFO1lBQy9ELElBQUksRUFBRSxJQUFJLENBQUMsT0FBTztZQUNsQixPQUFPLEVBQUUsV0FBVztZQUNwQixFQUFFO1lBQ0YsUUFBUTtTQUNSLENBQUMsQ0FBQztJQUNKLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHN0cmluZ1BsYWNlaG9sZGVyUmVwbGFjZSB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IE9OZXRSZXF1ZXN0T3B0aW9ucyB9IGZyb20gJy4uL09XZWJOZXQnO1xuaW1wb3J0IE9XZWJYSFIgZnJvbSAnLi4vT1dlYlhIUic7XG5pbXBvcnQgeyBPQXBpUmVzcG9uc2UsIE9XZWJBcHAgfSBmcm9tICcuLi9vd2ViJztcblxuY29uc3QgU0VSVklDRV9VUkxfRk9STUFUID0gJzpob3N0LzpzZXJ2aWNlJyxcblx0U0VSVklDRV9FTlRJVFlfRk9STUFUID0gJzpob3N0LzpzZXJ2aWNlLzppZCcsXG5cdFNFUlZJQ0VfRU5USVRZX1JFTEFUSU9OX0ZPUk1BVCA9ICc6aG9zdC86c2VydmljZS86aWQvOnJlbGF0aW9uJztcblxuY29uc3QgYXBpQ2FjaGU6IHtcblx0W2FwaUhvc3Q6IHN0cmluZ106IE9ab25lO1xufSA9IHt9O1xuXG5leHBvcnQgY29uc3QgZ2V0QXBpRm9ySG9zdCA9IGZ1bmN0aW9uIGdldEFwaUZvckhvc3QoXG5cdHVybDogc3RyaW5nXG4pOiBPWm9uZSB8IHVuZGVmaW5lZCB7XG5cdGZvciAoY29uc3QgYXBpSG9zdCBpbiBhcGlDYWNoZSkge1xuXHRcdGlmICh1cmwuc3RhcnRzV2l0aChhcGlIb3N0KSkge1xuXHRcdFx0cmV0dXJuIGFwaUNhY2hlW2FwaUhvc3RdO1xuXHRcdH1cblx0fVxuXG5cdHJldHVybiB1bmRlZmluZWQ7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPWm9uZSB7XG5cdHByaXZhdGUgcmVhZG9ubHkgYXBpSG9zdDogc3RyaW5nO1xuXG5cdC8qKlxuXHQgKiBPWm9uZSBjb25zdHJ1Y3Rvci5cblx0ICpcblx0ICogQHBhcmFtIF9hcHBDb250ZXh0XG5cdCAqL1xuXHRwcm90ZWN0ZWQgY29uc3RydWN0b3IocHJpdmF0ZSBfYXBwQ29udGV4dDogT1dlYkFwcCkge1xuXHRcdHRoaXMuYXBpSG9zdCA9IF9hcHBDb250ZXh0LmNvbmZpZ3Ncblx0XHRcdC5nZXQoJ09aX0FQSV9CQVNFX1VSTCcpXG5cdFx0XHQucmVwbGFjZSgvXFwvJC9nLCAnJyk7XG5cdH1cblxuXHQvKipcblx0ICogQ3JlYXRlIG5ldyBvem9uZSBhcGkgaW5zdGFuY2Ugb3IgZ2V0IGZyb20gY2FjaGVcblx0ICpcblx0ICovXG5cdHN0YXRpYyBpbnN0YW50aWF0ZShfYXBwQ29udGV4dDogT1dlYkFwcCk6IE9ab25lIHtcblx0XHRjb25zdCBhcGlIb3N0ID0gX2FwcENvbnRleHQuY29uZmlncy5nZXQoJ09aX0FQSV9CQVNFX1VSTCcpO1xuXG5cdFx0aWYgKCEoYXBpSG9zdCBpbiBhcGlDYWNoZSkpIHtcblx0XHRcdGFwaUNhY2hlW2FwaUhvc3RdID0gbmV3IE9ab25lKF9hcHBDb250ZXh0KTtcblx0XHR9XG5cblx0XHRyZXR1cm4gYXBpQ2FjaGVbYXBpSG9zdF07XG5cdH1cblxuXHQvKipcblx0ICogTWFrZXMgYSByZXF1ZXN0LlxuXHQgKlxuXHQgKiBAcGFyYW0gdXJsIFRoZSByZXF1ZXN0IHVybFxuXHQgKiBAcGFyYW0gb3B0aW9ucyBUaGUgcmVxdWVzdCBvcHRpb25zXG5cdCAqL1xuXHRyZXF1ZXN0PFJlc3BvbnNlIGV4dGVuZHMgT0FwaVJlc3BvbnNlPGFueT4+KFxuXHRcdHVybDogc3RyaW5nLFxuXHRcdG9wdGlvbnM6IFBhcnRpYWw8T05ldFJlcXVlc3RPcHRpb25zPFJlc3BvbnNlPj4gPSB7fVxuXHQpOiBPV2ViWEhSPFJlc3BvbnNlPiB7XG5cdFx0Y29uc3QgX3RoaXMgPSB0aGlzLFxuXHRcdFx0YXBpID0gZ2V0QXBpRm9ySG9zdCh1cmwpO1xuXG5cdFx0aWYgKGFwaSkge1xuXHRcdFx0aWYgKCFvcHRpb25zLmhlYWRlcnMpIHtcblx0XHRcdFx0b3B0aW9ucy5oZWFkZXJzID0ge307XG5cdFx0XHR9XG5cblx0XHRcdGlmICh0aGlzLl9hcHBDb250ZXh0LmNvbmZpZ3MuZ2V0KCdPWl9BUElfQUxMT1dfUkVBTF9NRVRIT0RfSEVBREVSJykpIHtcblx0XHRcdFx0Y29uc3QgcmVhbE1ldGhvZCA9IChvcHRpb25zLm1ldGhvZCB8fCAnZ2V0JykudG9VcHBlckNhc2UoKSxcblx0XHRcdFx0XHRyZXBsYWNlTWV0aG9kcyA9IFsnUEFUQ0gnLCAnUFVUJywgJ0RFTEVURSddLFxuXHRcdFx0XHRcdHJlYWxNZXRob2RIZWFkZXIgPSB0aGlzLl9hcHBDb250ZXh0LmNvbmZpZ3MuZ2V0KFxuXHRcdFx0XHRcdFx0J09aX0FQSV9SRUFMX01FVEhPRF9IRUFERVJfTkFNRSdcblx0XHRcdFx0XHQpO1xuXG5cdFx0XHRcdC8vIHdlIHVwZGF0ZSByZXF1ZXN0IG1ldGhvZFxuXHRcdFx0XHRpZiAofnJlcGxhY2VNZXRob2RzLmluZGV4T2YocmVhbE1ldGhvZCkpIHtcblx0XHRcdFx0XHRvcHRpb25zLmhlYWRlcnNbcmVhbE1ldGhvZEhlYWRlcl0gPSByZWFsTWV0aG9kO1xuXHRcdFx0XHRcdG9wdGlvbnMubWV0aG9kID0gJ1BPU1QnO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IGhlYWRlck5hbWUgPSB0aGlzLl9hcHBDb250ZXh0LmNvbmZpZ3MuZ2V0KCdPWl9BUElfS0VZX0hFQURFUl9OQU1FJyk7XG5cblx0XHRcdGlmICghb3B0aW9ucy5oZWFkZXJzW2hlYWRlck5hbWVdKSB7XG5cdFx0XHRcdG9wdGlvbnMuaGVhZGVyc1toZWFkZXJOYW1lXSA9XG5cdFx0XHRcdFx0dGhpcy5fYXBwQ29udGV4dC5jb25maWdzLmdldCgnT1pfQVBJX0tFWScpO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoIW9wdGlvbnMuaXNHb29kTmV3cykge1xuXHRcdFx0XHRvcHRpb25zLmlzR29vZE5ld3MgPSAoanNvbik6IGJvb2xlYW4gPT4ge1xuXHRcdFx0XHRcdHJldHVybiBCb29sZWFuKGpzb24gJiYganNvbi5lcnJvciA9PT0gMCk7XG5cdFx0XHRcdH07XG5cdFx0XHR9XG5cdFx0XHRpZiAoIW9wdGlvbnMuZXJyb3JSZXNwb25zZVRvRGlhbG9nKSB7XG5cdFx0XHRcdG9wdGlvbnMuZXJyb3JSZXNwb25zZVRvRGlhbG9nID0gKHJlc3BvbnNlKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QganNvbiA9IHJlc3BvbnNlLmpzb247XG5cdFx0XHRcdFx0cmV0dXJuIGpzb25cblx0XHRcdFx0XHRcdD8geyB0ZXh0OiBqc29uLm1zZywgZGF0YToganNvbi5kYXRhIH1cblx0XHRcdFx0XHRcdDogeyB0ZXh0OiAnT1pfRVJST1JfTkVUV09SSycgfTtcblx0XHRcdFx0fTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRjb25zdCBvID0gdGhpcy5fYXBwQ29udGV4dC5yZXF1ZXN0PFJlc3BvbnNlPih1cmwsIG9wdGlvbnMpO1xuXG5cdFx0by5vblJlc3BvbnNlKGZ1bmN0aW9uIHJlc3BvbnNlSGFuZGxlcihyZXNwb25zZSkge1xuXHRcdFx0Y29uc3QgeyBqc29uIH0gPSByZXNwb25zZTtcblx0XHRcdGlmIChqc29uICYmIGpzb24uc3RpbWUpIHtcblx0XHRcdFx0X3RoaXMuX2FwcENvbnRleHQudXNlci5zZXRTZXNzaW9uRXhwaXJlKGpzb24uc3RpbWUpO1xuXHRcdFx0fVxuXHRcdFx0aWYgKGpzb24gJiYganNvbi5zdG9rZW4pIHtcblx0XHRcdFx0X3RoaXMuX2FwcENvbnRleHQudXNlci5zZXRTZXNzaW9uVG9rZW4oanNvbi5zdG9rZW4pO1xuXHRcdFx0fVxuXHRcdH0pO1xuXG5cdFx0cmV0dXJuIG87XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgc2VydmljZSBVUkkuXG5cdCAqXG5cdCAqIEBwYXJhbSBzZXJ2aWNlTmFtZSBUaGUgc2VydmljZSBuYW1lLlxuXHQgKi9cblx0Z2V0U2VydmljZVVSSShzZXJ2aWNlTmFtZTogc3RyaW5nKTogc3RyaW5nIHtcblx0XHRyZXR1cm4gc3RyaW5nUGxhY2Vob2xkZXJSZXBsYWNlKFNFUlZJQ0VfVVJMX0ZPUk1BVCwge1xuXHRcdFx0aG9zdDogdGhpcy5hcGlIb3N0LFxuXHRcdFx0c2VydmljZTogc2VydmljZU5hbWUsXG5cdFx0fSk7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyBhbiBhYnNvbHV0ZSB1cmkgc3RyaW5nLlxuXHQgKlxuXHQgKiBAcGFyYW0gc2VydmljZU5hbWUgVGhlIHNlcnZpY2UgbmFtZS5cblx0ICogQHBhcmFtIHBhdGggVGhlIHBhdGguXG5cdCAqL1xuXHR0b0Fic29sdXRlVVJJKHNlcnZpY2VOYW1lOiBzdHJpbmcsIHBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG5cdFx0cmV0dXJuIHRoaXMuZ2V0U2VydmljZVVSSShzZXJ2aWNlTmFtZSkgKyAnLycgKyBwYXRoLnJlcGxhY2UoL15cXC8rLywgJycpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgZW50aXR5IFVSSS5cblx0ICpcblx0ICogQHBhcmFtIHNlcnZpY2VOYW1lIFRoZSBzZXJ2aWNlIG5hbWUuXG5cdCAqIEBwYXJhbSBpZCBUaGUgZW50aXR5IGlkLlxuXHQgKi9cblx0Z2V0SXRlbVVSSShzZXJ2aWNlTmFtZTogc3RyaW5nLCBpZDogc3RyaW5nIHwgbnVtYmVyKTogc3RyaW5nIHtcblx0XHRyZXR1cm4gc3RyaW5nUGxhY2Vob2xkZXJSZXBsYWNlKFNFUlZJQ0VfRU5USVRZX0ZPUk1BVCwge1xuXHRcdFx0aG9zdDogdGhpcy5hcGlIb3N0LFxuXHRcdFx0c2VydmljZTogc2VydmljZU5hbWUsXG5cdFx0XHRpZCxcblx0XHR9KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIGVudGl0eSByZWxhdGlvbiBVUkkuXG5cdCAqXG5cdCAqIEBwYXJhbSBzZXJ2aWNlTmFtZSBUaGUgc2VydmljZSBuYW1lLlxuXHQgKiBAcGFyYW0gaWQgVGhlIGVudGl0eSBpZC5cblx0ICogQHBhcmFtIHJlbGF0aW9uIFRoZSByZWxhdGlvbiBuYW1lLlxuXHQgKi9cblx0Z2V0SXRlbVJlbGF0aW9uVVJJKFxuXHRcdHNlcnZpY2VOYW1lOiBzdHJpbmcsXG5cdFx0aWQ6IHN0cmluZyxcblx0XHRyZWxhdGlvbjogc3RyaW5nXG5cdCk6IHN0cmluZyB7XG5cdFx0cmV0dXJuIHN0cmluZ1BsYWNlaG9sZGVyUmVwbGFjZShTRVJWSUNFX0VOVElUWV9SRUxBVElPTl9GT1JNQVQsIHtcblx0XHRcdGhvc3Q6IHRoaXMuYXBpSG9zdCxcblx0XHRcdHNlcnZpY2U6IHNlcnZpY2VOYW1lLFxuXHRcdFx0aWQsXG5cdFx0XHRyZWxhdGlvbixcblx0XHR9KTtcblx0fVxufVxuIl19