import { logger, stringPlaceholderReplace } from '../utils';
import OWebXHR from '../OWebXHR';
const SERVICE_URL_FORMAT = ':host/:service', SERVICE_ENTITY_FORMAT = ':host/:service/:id', SERVICE_ENTITY_RELATION_FORMAT = ':host/:service/:id/:relation';
const apiCache = {};
export const getApiForHost = function (url) {
    for (const apiHost in apiCache) {
        if (url.startsWith(apiHost)) {
            return apiCache[apiHost];
        }
    }
    return undefined;
};
export default class OZone {
    /**
     * OZone constructor.
     *
     * @param _appContext
     */
    constructor(_appContext) {
        this._appContext = _appContext;
        this.apiHost = _appContext.configs.get('OZ_API_BASE_URL').replace(/\/$/g, '');
    }
    /**
     * Create new ozone api instance or get from cache
     *
     */
    static instantiate(_appContext) {
        const apiHost = _appContext.configs.get('OZ_API_BASE_URL');
        if (!(apiHost in apiCache)) {
            apiCache[apiHost] = new OZone(_appContext);
        }
        return apiCache[apiHost];
    }
    /**
     * Makes a request.
     *
     * @param url The request url
     * @param options The request options
     */
    request(url, options) {
        logger.debug('[OZone][NET] new request', url, options);
        const _this = this, api = getApiForHost(url), event = function (type) {
            return function () {
                logger.debug('[OZone][NET] event %s', type, url, options);
            };
        };
        if (api) {
            if (!options.headers) {
                options.headers = {};
            }
            if (this._appContext.configs.get('OZ_API_ALLOW_REAL_METHOD_HEADER')) {
                const realMethod = (options.method || 'get').toUpperCase(), replaceMethods = ['PATCH', 'PUT', 'DELETE'], realMethodHeader = this._appContext.configs.get('OZ_API_REAL_METHOD_HEADER_NAME');
                // we update request method
                if (~replaceMethods.indexOf(realMethod)) {
                    options.headers[realMethodHeader] = realMethod;
                    options.method = 'POST';
                }
            }
            const headerName = this._appContext.configs.get('OZ_API_KEY_HEADER_NAME');
            if (!options.headers[headerName]) {
                options.headers[headerName] = this._appContext.configs.get('OZ_API_KEY');
            }
            if (!options.isGoodNews) {
                options.isGoodNews = (json) => {
                    return Boolean(json && json.error === 0);
                };
            }
            if (!options.serverErrorInfo) {
                options.serverErrorInfo = (response) => {
                    const json = response.json;
                    return { text: json.msg, data: json.data };
                };
            }
        }
        const o = new OWebXHR(url, {
            withCredentials: true,
            ...options,
        });
        o.onFinish(event('onFinished'))
            .onError(event('onError'))
            .onFail(event('onFailed'))
            .onHttpError(event('onHttpError'))
            .onHttpSuccess(event('onHttpSuccess'))
            .onGoodNews(event('onGoodNews'))
            .onBadNews(event('onBadNews'))
            .onDownloadProgress(event('onDownloadProgress'))
            .onUploadProgress(event('onUploadProgress'))
            .onResponse(event('onResponse'))
            .onResponse(function (response) {
            const { json } = response;
            if (json.stime) {
                _this._appContext.user.setSessionExpire(json.stime);
            }
            if (json.stoken) {
                _this._appContext.user.setSessionToken(json.stoken);
            }
        });
        return o;
    }
    /**
     * Returns the service URI.
     *
     * @param service The service name.
     */
    getServiceURI(service) {
        return stringPlaceholderReplace(SERVICE_URL_FORMAT, {
            host: this.apiHost,
            service,
        });
    }
    /**
     * Returns entity URI.
     *
     * @param service The service name.
     * @param id The entity id.
     */
    getItemURI(service, id) {
        return stringPlaceholderReplace(SERVICE_ENTITY_FORMAT, {
            host: this.apiHost,
            service, id,
        });
    }
    /**
     * Returns entity relation URI.
     *
     * @param service The service name.
     * @param id The entity id.
     * @param relation The relation name.
     */
    getItemRelationURI(service, id, relation) {
        return stringPlaceholderReplace(SERVICE_ENTITY_RELATION_FORMAT, {
            host: this.apiHost,
            service, id, relation,
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1pvbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvb3pvbmUvT1pvbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLE1BQU0sRUFBRSx3QkFBd0IsRUFBQyxNQUFNLFVBQVUsQ0FBQztBQUUxRCxPQUFPLE9BQU8sTUFBTSxZQUFZLENBQUM7QUFHakMsTUFBTSxrQkFBa0IsR0FBZSxnQkFBZ0IsRUFDcEQscUJBQXFCLEdBQVksb0JBQW9CLEVBQ3JELDhCQUE4QixHQUFHLDhCQUE4QixDQUFDO0FBRW5FLE1BQU0sUUFBUSxHQUVWLEVBQUUsQ0FBQztBQUVQLE1BQU0sQ0FBQyxNQUFNLGFBQWEsR0FBRyxVQUFVLEdBQVc7SUFDakQsS0FBSyxNQUFNLE9BQU8sSUFBSSxRQUFRLEVBQUU7UUFDL0IsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQzVCLE9BQU8sUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ3pCO0tBQ0Q7SUFFRCxPQUFPLFNBQVMsQ0FBQztBQUNsQixDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsT0FBTyxPQUFPLEtBQUs7SUFHekI7Ozs7T0FJRztJQUNILFlBQThCLFdBQW9CO1FBQXBCLGdCQUFXLEdBQVgsV0FBVyxDQUFTO1FBQ2pELElBQUksQ0FBQyxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQy9FLENBQUM7SUFFRDs7O09BR0c7SUFDSCxNQUFNLENBQUMsV0FBVyxDQUFDLFdBQW9CO1FBQ3RDLE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFFM0QsSUFBSSxDQUFDLENBQUMsT0FBTyxJQUFJLFFBQVEsQ0FBQyxFQUFFO1lBQzNCLFFBQVEsQ0FBQyxPQUFPLENB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Q0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNILGtCQUFrQixDQUFDLE9BQWUsRUFBRSxFQUFVLEVBQUUsUUFBZ0I7UUFDL0QsT0FBTyx3QkFBd0IsQ0FBQyw4QkFBOEIsRUFBRTtZQUMvRCxJQUFJLEVBQUUsSUFBSSxDQUFDLE9BQU87WUFDbEIsT0FBTyxFQUFFLEVBQUUsRUFBRSxRQUFRO1NBQ3JCLENBQUMsQ0FBQztJQUNKLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7bG9nZ2VyLCBzdHJpbmdQbGFjZWhvbGRlclJlcGxhY2V9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7T05ldFJlcXVlc3RPcHRpb25zfSBmcm9tICcuLi9PV2ViTmV0JztcbmltcG9ydCBPV2ViWEhSIGZyb20gJy4uL09XZWJYSFInO1xuaW1wb3J0IHtPQXBpSlNPTiwgT1dlYkFwcH0gZnJvbSAnLi4vb3dlYic7XG5cbmNvbnN0IFNFUlZJQ0VfVVJMX0ZPUk1BVCAgICAgICAgICAgICA9ICc6aG9zdC86c2VydmljZScsXG5cdCAgU0VSVklDRV9FTlRJVFlfRk9STUFUICAgICAgICAgID0gJzpob3N0LzpzZXJ2aWNlLzppZCcsXG5cdCAgU0VSVklDRV9FTlRJVFlfUkVMQVRJT05fRk9STUFUID0gJzpob3N0LzpzZXJ2aWNlLzppZC86cmVsYXRpb24nO1xuXG5jb25zdCBhcGlDYWNoZToge1xuXHRbYXBpSG9zdDogc3RyaW5nXTogT1pvbmU7XG59ID0ge307XG5cbmV4cG9ydCBjb25zdCBnZXRBcGlGb3JIb3N0ID0gZnVuY3Rpb24gKHVybDogc3RyaW5nKTogT1pvbmUgfCB1bmRlZmluZWQge1xuXHRmb3IgKGNvbnN0IGFwaUhvc3QgaW4gYXBpQ2FjaGUpIHtcblx0XHRpZiAodXJsLnN0YXJ0c1dpdGgoYXBpSG9zdCkpIHtcblx0XHRcdHJldHVybiBhcGlDYWNoZVthcGlIb3N0XTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gdW5kZWZpbmVkO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT1pvbmUge1xuXHRwcml2YXRlIHJlYWRvbmx5IGFwaUhvc3Q6IHN0cmluZztcblxuXHQvKipcblx0ICogT1pvbmUgY29uc3RydWN0b3IuXG5cdCAqXG5cdCAqIEBwYXJhbSBfYXBwQ29udGV4dFxuXHQgKi9cblx0cHJvdGVjdGVkIGNvbnN0cnVjdG9yKHByaXZhdGUgX2FwcENvbnRleHQ6IE9XZWJBcHApIHtcblx0XHR0aGlzLmFwaUhvc3QgPSBfYXBwQ29udGV4dC5jb25maWdzLmdldCgnT1pfQVBJX0JBU0VfVVJMJykucmVwbGFjZSgvXFwvJC9nLCAnJyk7XG5cdH1cblxuXHQvKipcblx0ICogQ3JlYXRlIG5ldyBvem9uZSBhcGkgaW5zdGFuY2Ugb3IgZ2V0IGZyb20gY2FjaGVcblx0ICpcblx0ICovXG5cdHN0YXRpYyBpbnN0YW50aWF0ZShfYXBwQ29udGV4dDogT1dlYkFwcCk6IE9ab25lIHtcblx0XHRjb25zdCBhcGlIb3N0ID0gX2FwcENvbnRleHQuY29uZmlncy5nZXQoJ09aX0FQSV9CQVNFX1VSTCcpO1xuXG5cdFx0aWYgKCEoYXBpSG9zdCBpbiBhcGlDYWNoZSkpIHtcblx0XHRcdGFwaUNhY2hlW2FwaUhvc3RdID0gbmV3IE9ab25lKF9hcHBDb250ZXh0KTtcblx0XHR9XG5cblx0XHRyZXR1cm4gYXBpQ2FjaGVbYXBpSG9zdF07XG5cdH1cblxuXHQvKipcblx0ICogTWFrZXMgYSByZXF1ZXN0LlxuXHQgKlxuXHQgKiBAcGFyYW0gdXJsIFRoZSByZXF1ZXN0IHVybFxuXHQgKiBAcGFyYW0gb3B0aW9ucyBUaGUgcmVxdWVzdCBvcHRpb25zXG5cdCAqL1xuXHRyZXF1ZXN0PFIgZXh0ZW5kcyBPQXBpSlNPTjxhbnk+Pihcblx0XHR1cmw6IHN0cmluZyxcblx0XHRvcHRpb25zOiBQYXJ0aWFsPE9OZXRSZXF1ZXN0T3B0aW9uczxSPj4sXG5cdCk6IE9XZWJYSFI8Uj4ge1xuXHRcdGxvZ2dlci5kZWJ1ZygnW09ab25lXVtORVRdIG5ldyByZXF1ZXN0JywgdXJsLCBvcHRpb25zKTtcblxuXHRcdGNvbnN0IF90aGlzID0gdGhpcyxcblx0XHRcdCAgYXBpICAgPSBnZXRBcGlGb3JIb3N0KHVybCksXG5cdFx0XHQgIGV2ZW50ID0gZnVuY3Rpb24gKHR5cGU6IHN0cmluZykge1xuXHRcdFx0XHQgIHJldHVybiBmdW5jdGlvbiAoKTogdm9pZCB7XG5cdFx0XHRcdFx0ICBsb2dnZXIuZGVidWcoJ1tPWm9uZV1bTkVUXSBldmVudCAlcycsIHR5cGUsIHVybCwgb3B0aW9ucyk7XG5cdFx0XHRcdCAgfTtcblx0XHRcdCAgfTtcblxuXHRcdGlmIChhcGkpIHtcblx0XHRcdGlmICghb3B0aW9ucy5oZWFkZXJzKSB7XG5cdFx0XHRcdG9wdGlvbnMuaGVhZGVycyA9IHt9O1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAodGhpcy5fYXBwQ29udGV4dC5jb25maWdzLmdldCgnT1pfQVBJX0FMTE9XX1JFQUxfTUVUSE9EX0hFQURFUicpKSB7XG5cdFx0XHRcdGNvbnN0IHJlYWxNZXRob2QgICAgICAgPSAob3B0aW9ucy5tZXRob2QgfHwgJ2dldCcpLnRvVXBwZXJDYXNlKCksXG5cdFx0XHRcdFx0ICByZXBsYWNlTWV0aG9kcyAgID0gWydQQVRDSCcsICdQVVQnLCAnREVMRVRFJ10sXG5cdFx0XHRcdFx0ICByZWFsTWV0aG9kSGVhZGVyID0gdGhpcy5fYXBwQ29udGV4dC5jb25maWdzLmdldCgnT1pfQVBJX1JFQUxfTUVUSE9EX0hFQURFUl9OQU1FJyk7XG5cblx0XHRcdFx0Ly8gd2UgdXBkYXRlIHJlcXVlc3QgbWV0aG9kXG5cdFx0XHRcdGlmICh+cmVwbGFjZU1ldGhvZHMuaW5kZXhPZihyZWFsTWV0aG9kKSkge1xuXHRcdFx0XHRcdG9wdGlvbnMuaGVhZGVyc1tyZWFsTWV0aG9kSGVhZGVyXSA9IHJlYWxNZXRob2Q7XG5cdFx0XHRcdFx0b3B0aW9ucy5tZXRob2QgICAgICAgICAgICAgICAgICAgID0gJ1BPU1QnO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IGhlYWRlck5hbWUgPSB0aGlzLl9hcHBDb250ZXh0LmNvbmZpZ3MuZ2V0KCdPWl9BUElfS0VZX0hFQURFUl9OQU1FJyk7XG5cblx0XHRcdGlmICghb3B0aW9ucy5oZWFkZXJzW2hlYWRlck5hbWVdKSB7XG5cdFx0XHRcdG9wdGlvbnMuaGVhZGVyc1toZWFkZXJOYW1lXSA9IHRoaXMuX2FwcENvbnRleHQuY29uZmlncy5nZXQoJ09aX0FQSV9LRVknKTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKCFvcHRpb25zLmlzR29vZE5ld3MpIHtcblx0XHRcdFx0b3B0aW9ucy5pc0dvb2ROZXdzID0gKGpzb24pOiBib29sZWFuID0+IHtcblx0XHRcdFx0XHRyZXR1cm4gQm9vbGVhbihqc29uICYmIGpzb24uZXJyb3IgPT09IDApO1xuXHRcdFx0XHR9O1xuXHRcdFx0fVxuXHRcdFx0aWYgKCFvcHRpb25zLnNlcnZlckVycm9ySW5mbykge1xuXHRcdFx0XHRvcHRpb25zLnNlcnZlckVycm9ySW5mbyA9IChyZXNwb25zZSkgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IGpzb24gPSByZXNwb25zZS5qc29uIGFzIGFueSBhcyBPQXBpSlNPTjxhbnk+O1xuXHRcdFx0XHRcdHJldHVybiB7dGV4dDoganNvbi5tc2csIGRhdGE6IGpzb24uZGF0YX07XG5cdFx0XHRcdH07XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0Y29uc3QgbyA9IG5ldyBPV2ViWEhSPFI+KHVybCwge1xuXHRcdFx0d2l0aENyZWRlbnRpYWxzOiB0cnVlLFxuXHRcdFx0Li4ub3B0aW9ucyxcblx0XHR9KTtcblxuXHRcdG8ub25GaW5pc2goZXZlbnQoJ29uRmluaXNoZWQnKSlcblx0XHQgLm9uRXJyb3IoZXZlbnQoJ29uRXJyb3InKSlcblx0XHQgLm9uRmFpbChldmVudCgnb25GYWlsZWQnKSlcblx0XHQgLm9uSHR0cEVycm9yKGV2ZW50KCdvbkh0dHBFcnJvcicpKVxuXHRcdCAub25IdHRwU3VjY2VzcyhldmVudCgnb25IdHRwU3VjY2VzcycpKVxuXHRcdCAub25Hb29kTmV3cyhldmVudCgnb25Hb29kTmV3cycpKVxuXHRcdCAub25CYWROZXdzKGV2ZW50KCdvbkJhZE5ld3MnKSlcblx0XHQgLm9uRG93bmxvYWRQcm9ncmVzcyhldmVudCgnb25Eb3dubG9hZFByb2dyZXNzJykpXG5cdFx0IC5vblVwbG9hZFByb2dyZXNzKGV2ZW50KCdvblVwbG9hZFByb2dyZXNzJykpXG5cdFx0IC5vblJlc3BvbnNlKGV2ZW50KCdvblJlc3BvbnNlJykpXG5cdFx0IC5vblJlc3BvbnNlKGZ1bmN0aW9uIChyZXNwb25zZSkge1xuXHRcdFx0IGNvbnN0IHtqc29ufSA9IHJlc3BvbnNlO1xuXHRcdFx0IGlmIChqc29uLnN0aW1lKSB7XG5cdFx0XHRcdCBfdGhpcy5fYXBwQ29udGV4dC51c2VyLnNldFNlc3Npb25FeHBpcmUoanNvbi5zdGltZSk7XG5cdFx0XHQgfVxuXHRcdFx0IGlmIChqc29uLnN0b2tlbikge1xuXHRcdFx0XHQgX3RoaXMuX2FwcENvbnRleHQudXNlci5zZXRTZXNzaW9uVG9rZW4oanNvbi5zdG9rZW4pO1xuXHRcdFx0IH1cblx0XHQgfSk7XG5cblx0XHRyZXR1cm4gbztcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHRoZSBzZXJ2aWNlIFVSSS5cblx0ICpcblx0ICogQHBhcmFtIHNlcnZpY2UgVGhlIHNlcnZpY2UgbmFtZS5cblx0ICovXG5cdGdldFNlcnZpY2VVUkkoc2VydmljZTogc3RyaW5nKTogc3RyaW5nIHtcblx0XHRyZXR1cm4gc3RyaW5nUGxhY2Vob2xkZXJSZXBsYWNlKFNFUlZJQ0VfVVJMX0ZPUk1BVCwge1xuXHRcdFx0aG9zdDogdGhpcy5hcGlIb3N0LFxuXHRcdFx0c2VydmljZSxcblx0XHR9KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIGVudGl0eSBVUkkuXG5cdCAqXG5cdCAqIEBwYXJhbSBzZXJ2aWNlIFRoZSBzZXJ2aWNlIG5hbWUuXG5cdCAqIEBwYXJhbSBpZCBUaGUgZW50aXR5IGlkLlxuXHQgKi9cblx0Z2V0SXRlbVVSSShzZXJ2aWNlOiBzdHJpbmcsIGlkOiBzdHJpbmcgfCBudW1iZXIpOiBzdHJpbmcge1xuXHRcdHJldHVybiBzdHJpbmdQbGFjZWhvbGRlclJlcGxhY2UoU0VSVklDRV9FTlRJVFlfRk9STUFULCB7XG5cdFx0XHRob3N0OiB0aGlzLmFwaUhvc3QsXG5cdFx0XHRzZXJ2aWNlLCBpZCxcblx0XHR9KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIGVudGl0eSByZWxhdGlvbiBVUkkuXG5cdCAqXG5cdCAqIEBwYXJhbSBzZXJ2aWNlIFRoZSBzZXJ2aWNlIG5hbWUuXG5cdCAqIEBwYXJhbSBpZCBUaGUgZW50aXR5IGlkLlxuXHQgKiBAcGFyYW0gcmVsYXRpb24gVGhlIHJlbGF0aW9uIG5hbWUuXG5cdCAqL1xuXHRnZXRJdGVtUmVsYXRpb25VUkkoc2VydmljZTogc3RyaW5nLCBpZDogc3RyaW5nLCByZWxhdGlvbjogc3RyaW5nKTogc3RyaW5nIHtcblx0XHRyZXR1cm4gc3RyaW5nUGxhY2Vob2xkZXJSZXBsYWNlKFNFUlZJQ0VfRU5USVRZX1JFTEFUSU9OX0ZPUk1BVCwge1xuXHRcdFx0aG9zdDogdGhpcy5hcGlIb3N0LFxuXHRcdFx0c2VydmljZSwgaWQsIHJlbGF0aW9uLFxuXHRcdH0pO1xuXHR9XG59Il19