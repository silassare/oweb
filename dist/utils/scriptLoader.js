"use strict";
import Utils from "./Utils";
let document = window.document;
let isOldIE = /MSIE\s([5-9]\.0)/.test(navigator.userAgent);
if (typeof document !== "object" || typeof document.createElement !== "function") {
    throw new Error("scriptLoader is for web use only");
}
let batchLoad = function (list, then, disable_cache = false) {
    let total = list.length;
    let failed = [];
    let done = [];
    let counter = 0;
    let updateCount = (success, src) => {
        counter++;
        (success ? done : failed).push(src);
        if (counter === total) {
            Utils.callback(then, [!failed.length, done, failed]);
        }
    };
    for (let i = 0; i < total; i++) {
        let src = list[i][0];
        let fn = list[i][1];
        if (typeof fn === "function" && !fn()) {
            continue;
        }
        tryLoad(src, (src) => {
            updateCount(true, src);
        }, (src) => {
            updateCount(false, src);
        }, disable_cache);
    }
};
let noCache = function (url) {
    let _random = function () {
        return String(Math.random()).substring(2);
    };
    try {
        let u = new URL(url, window.location.href);
        u.searchParams.set("nocache", _random());
        url = u.href;
    }
    catch (e) {
        console.error("unable to disable caching on file", url, e);
    }
    return url;
};
let tryLoad = function (src, then, fail, disable_cache = false) {
    if (!document.querySelector("script[load-path='" + src + "']")) {
        if (disable_cache) {
            src = noCache(src);
        }
        let script = document.createElement("script");
        script.src = src;
        script.async = false;
        script.type = "text/javascript";
        script.onload = function () {
            Utils.callback(then, [src]);
        };
        script.onerror = function () {
            script.parentNode.removeChild(script);
            Utils.callback(fail, [src]);
        };
        script.setAttribute("load-path", src);
        document.body.appendChild(script);
        //ie9 hack: to force script execution in order
        //since ie9 does not suport script.async  = false;
        //https://github.com/h5bp/lazyweb-requests/issues/42#issue-1382146
        if (isOldIE) {
            document.body.appendChild(document.createElement("script"));
        }
    }
    else {
        Utils.callback(then, [src]);
    }
};
export default {
    noCache,
    tryLoad,
    batchLoad
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NyaXB0TG9hZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWxzL3NjcmlwdExvYWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7QUFFYixPQUFPLEtBQUssTUFBTSxTQUFTLENBQUM7QUFFNUIsSUFBSSxRQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQztBQUMvQixJQUFJLE9BQU8sR0FBSSxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBRTVELElBQUksT0FBTyxRQUFRLEtBQUssUUFBUSxJQUFJLE9BQU8sUUFBUSxDQUFDLGFBQWEsS0FBSyxVQUFVLEVBQUU7SUFDakYsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO0NBQ3BEO0FBTUQsSUFBSSxTQUFTLEdBQUcsVUFBVSxJQUFtQixFQUFFLElBQWUsRUFBRSxnQkFBeUIsS0FBSztJQUM3RixJQUFJLEtBQUssR0FBbUIsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN4QyxJQUFJLE1BQU0sR0FBa0IsRUFBRSxDQUFDO0lBQy9CLElBQUksSUFBSSxHQUFvQixFQUFFLENBQUM7SUFDL0IsSUFBSSxPQUFPLEdBQWlCLENBQUMsQ0FBQztJQUM5QixJQUFJLFdBQVcsR0FBYSxDQUFDLE9BQWdCLEVBQUUsR0FBVyxFQUFFLEVBQUU7UUFDN0QsT0FBTyxFQUFFLENBQUM7UUFDVixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFcEMsSUFBSSxPQUFPLEtBQUssS0FBSyxFQUFFO1lBQ3RCLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO1NBQ3JEO0lBQ0YsQ0FBQyxD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