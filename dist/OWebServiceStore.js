import { GoblEntity } from 'gobl-utils-ts';
import OWebService from './OWebService';
import Utils from './utils/Utils';
const getId = (item) => item.singlePKValue(), escapeRegExp = (str) => str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
const _with = (target, key, item) => {
    return { ...target, [key]: item };
}, _without = (target, key) => {
    delete target[key];
    return { ...target };
};
export default class OWebServiceStore extends OWebService {
    constructor(app_context, entity, service_name) {
        super(app_context, service_name);
        this.entity = entity;
        this.items = {};
        this.relations = {};
    }
    getItem(id, relations = '', then, fail, freeze = true, load_cache_first = false, dialog = true) {
        let ctx = this, app = this.app_context;
        return ctx.getRequest(id, relations, (response, fromCache) => {
            ctx.addItemToList(response.data.item, response.data.relations);
            then && then(response, fromCache);
        }, response => {
            dialog && app.view.dialog(response);
            fail && fail(response);
        }, freeze, load_cache_first);
    }
    getAllItems(options = {}, then, fail, freeze = true, force_cache = true, dialog = true) {
        let ctx = this, app = this.app_context;
        return ctx.getAllRequest(options, (response, fromCache) => {
            ctx.addItemsToList(response.data.items, response.data.relations);
            then && then(response, fromCache);
        }, response => {
            dialog && app.view.dialog(response);
            fail && fail(response);
        }, freeze, force_cache);
    }
    addItem(data, then, fail, freeze = true, dialog = true) {
        let ctx = this, app = this.app_context;
        return ctx.addRequest(data, result => {
            ctx.addCreated(result);
            then && then(result);
        }, response => {
            dialog && app.view.dialog(response);
            fail && fail(response);
        }, freeze);
    }
    updateItem(item, then, fail, freeze = true, dialog = true) {
        let ctx = this, app = this.app_context, id = getId(item);
        if (!item.isSaved()) {
            let diff = item.toObject(true);
            item.isSaving(true);
            return ctx.updateRequest(id, diff, result => {
                item.isSaving(false);
                ctx.setSaved(item, result);
                then && then(result);
            }, response => {
                item.isSaving(false);
                dialog && app.view.dialog(response);
                fail && fail(response);
            }, freeze);
        }
        console.error('Not modified ->', item);
        return false;
    }
    deleteItem(item, then, fail, freeze = true, dialog = true) {
        let ctx = this, app = this.app_context, id = getId(item);
        item.isDeleting(true);
        return ctx.deleteRequest(id, result => {
            item.isDeleting(false);
            ctx.setDeleted(result);
            then && then(result);
        }, response => {
            item.isDeleting(false);
            dialog && app.view.dialog(response);
            fail && fail(response);
        }, freeze);
    }
    addItemsToList(items, relations = {}) {
        let ctx = this;
        let list = (Utils.isPlainObject(items)
            ? Object.values(items)
            : items || []);
        list.forEach(item => {
            let itemId = getId(item);
            ctx.safelyAddItem(item);
            if (!ctx.relations[itemId]) {
                ctx.relations = _with(ctx.relations, itemId, {});
            }
            for (let rel in relations) {
                if (relations.hasOwnProperty(rel)) {
                    let data = relations[rel];
                    if (data[itemId]) {
                        ctx.relations[itemId] = _with(ctx.relations[itemId], rel, data[itemId]);
                    }
                }
            }
        });
    }
    addItemToList(item, relations = {}) {
        let ctx = this, itemId = getId(item);
        ctx.safelyAddItem(item);
        if (!ctx.relations[itemId]) {
            ctx.relations = _with(ctx.relations, itemId, {});
        }
        for (let rel in relations) {
            if (relations.hasOwnProperty(rel)) {
                ctx.relations[itemId] = _with(ctx.relations[itemId], rel, relations[rel]);
            }
        }
    }
    safelyAddItem(item) {
        let key = getId(item), cachedItem = this.items[key];
        if (cachedItem) {
            cachedItem.doHydrate(item.toObject(), true);
        }
        else {
            this.items = _with(this.items, key, item);
        }
        return this;
    }
    setSaved(target, response) {
        let item = response.data.item;
        target.doHydrate(item.toObject(), true);
        this.safelyAddItem(target);
    }
    addCreated(response) {
        this.safelyAddItem(response.data.item);
    }
    setDeleted(response) {
        let item = response.data.item;
        this.items = _without(this.items, getId(item));
    }
    itemRelation(item, relation) {
        let id = getId(item);
        return this.relations[id] && this.relations[id][relation];
    }
    identify(id, checkCache = true) {
        let item = this.items[id], c;
        if (item)
            return item;
        if (checkCache) {
            c = GoblEntity.subCache(this.entity.name);
            return c && c[id];
        }
        return undefined;
    }
    list(ids = []) {
        let list = [], len = ids.length;
        if (len) {
            for (let i = 0; i < len; i++) {
                let id = ids[i], item = this.identify(id);
                if (item) {
                    list.push(item);
                }
            }
        }
        else {
            for (let key in this.items) {
                if (Object.prototype.hasOwnProperty.call(this.items, key)) {
                    list.push(this.items[key]);
                }
            }
        }
        return list;
    }
    orderBy(orderFn) {
        let keys = Object.keys(this.items);
        return keys.map(key => this.items[key]).sort(orderFn);
    }
    orderByValueOf(column) {
        return this.orderBy((a, b) => {
            return a[column] - b[column];
        });
    }
    select(list = this.list(), predicate, max = Infinity) {
        let result = [], len = list.length;
        for (let i = 0; i < len && result.length < max; i++) {
            if (predicate(list[i], i)) {
                result.push(list[i]);
            }
        }
        return result;
    }
    search(list = this.list(), search, stringBuilder) {
        if (!(search = search.trim()).length) {
            return list;
        }
        let reg = new RegExp(escapeRegExp(search), 'i');
        return list.filter((item, index) => {
            let v = stringBuilder(item, index);
            return reg.test(v);
        });
    }
    totalCount() {
        return Object.keys(this.items).length;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlNlcnZpY2VTdG9yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViU2VydmljZVN0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQXNCLE1BQU0sZUFBZSxDQUFDO0FBQy9ELE9BQU8sV0FXTixNQUFNLGVBQWUsQ0FBQztBQUd2QixPQUFPLEtBQUssTUFBTSxlQUFlLENBQUM7QUFJbEMsTUFBTSxLQUFLLEdBQUcsQ0FBQyxJQUF3QixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLEVBQy9ELFlBQVksR0FBRyxDQUFDLEdBQVcsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxxQkFBcUIsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUU1RSxNQUFNLEtBQUssR0FBRyxDQUFDLE1BQVcsRUFBRSxHQUFvQixFQUFFLElBQVMsRUFBRSxFQUFFO0lBQzdELE9BQU8sRUFBRSxHQUFHLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDO0FBQ25DLENBQUMsRUFDRCxRQUFRLEdBQUcsQ0FBQyxNQUFXLEVBQUUsR0FBb0IsRUFBRSxFQUFFO0lBQ2hELE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ25CLE9BQU8sRUFBRSxHQUFHLE1BQU0sRUFBRSxDQUFDO0FBQ3RCLENBQUMsQ0FBQztBQUVILE1BQU0sQ0FBQyxPQUFPLE9BQU8sZ0JBRW5CLFNBQVEsV0FBYztJQUl2QixZQUNDLFdBQW9CLEVBQ0gsTUFBaUMsRUFDbEQsWUFBb0I7UUFFcEIsS0FBSyxDQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUhoQixXQUFNLEdBQU4sTUFBTSxDQUEyQjtRQUx6QyxVQUFLLEdBQXlCLEVBQUUsQ0FBQztRQUNqQyxjQUFTLEdBQTJCLEVBQUUsQ0FBQztJQVFqRCxDQUFDO0lBRUQsT0FBTyxDQUNOLEVBQVUsRUFDVixZQUFvQixF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QUMsQ0FBQztRQUVoRCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFTLEVBQUUsS0FBYSxFQUFFLEVBQUU7WUFDL0MsSUFBSSxDQUFDLEdBQUcsYUFBYSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNuQyxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEIsQ0FBQyxDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQsVUFBVTtRQUNULE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQ3ZDLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEdvYmxFbnRpdHksIEdvYmxTaW5nbGVQS0VudGl0eSB9IGZyb20gJ2dvYmwtdXRpbHMtdHMnO1xuaW1wb3J0IE9XZWJTZXJ2aWNlLCB7XG5cdHRTZXJ2aWNlR2V0U3VjY2Vzcyxcblx0dFNlcnZpY2VGYWlsLFxuXHR0U2VydmljZUFkZFN1Y2Nlc3MsXG5cdHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnMsXG5cdHRTZXJ2aWNlR2V0QWxsU3VjY2Vzcyxcblx0dFNlcnZpY2VVcGRhdGVTdWNjZXNzLFxuXHR0U2VydmljZURlbGV0ZVN1Y2Nlc3MsXG5cdGlTZXJ2aWNlVXBkYXRlUmVzcG9uc2UsXG5cdGlTZXJ2aWNlQWRkUmVzcG9uc2UsXG5cdGlTZXJ2aWNlRGVsZXRlUmVzcG9uc2UsXG59IGZyb20gJy4vT1dlYlNlcnZpY2UnO1xuaW1wb3J0IE9XZWJBcHAgZnJvbSAnLi9PV2ViQXBwJztcbmltcG9ydCBPV2ViQ29tIGZyb20gJy4vT1dlYkNvbSc7XG5pbXBvcnQgVXRpbHMgZnJvbSAnLi91dGlscy9VdGlscyc7XG5cbmV4cG9ydCB0eXBlIHRFbnRpdGllc09yZGVyQnlDYjxUPiA9IChhOiBULCBiOiBUKSA9PiBudW1iZXI7XG5cbmNvbnN0IGdldElkID0gKGl0ZW06IEdvYmxTaW5nbGVQS0VudGl0eSkgPT4gaXRlbS5zaW5nbGVQS1ZhbHVlKCksXG5cdGVzY2FwZVJlZ0V4cCA9IChzdHI6IHN0cmluZykgPT4gc3RyLnJlcGxhY2UoL1suKis/XiR7fSgpfFtcXF1cXFxcXS9nLCAnXFxcXCQmJyk7XG5cbmNvbnN0IF93aXRoID0gKHRhcmdldDogYW55LCBrZXk6IHN0cmluZyB8IG51bWJlciwgaXRlbTogYW55KSA9PiB7XG5cdFx0cmV0dXJuIHsgLi4udGFyZ2V0LCBba2V5XTogaXRlbSB9O1xuXHR9LFxuXHRfd2l0aG91dCA9ICh0YXJnZXQ6IGFueSwga2V5OiBzdHJpbmcgfCBudW1iZXIpID0+IHtcblx0XHRkZWxldGUgdGFyZ2V0W2tleV07XG5cdFx0cmV0dXJuIHsgLi4udGFyZ2V0IH07XG5cdH07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJTZXJ2aWNlU3RvcmU8XG5cdFQgZXh0ZW5kcyBHb2JsU2luZ2xlUEtFbnRpdHlcbj4gZXh0ZW5kcyBPV2ViU2VydmljZTxUPiB7XG5cdHByb3RlY3RlZCBpdGVtczogeyBba2V5OiBzdHJpbmddOiBUIH0gPSB7fTtcblx0cHJvdGVjdGVkIHJlbGF0aW9uczogeyBba2V5OiBzdHJpbmddOiBhbnkgfSA9IHt9O1xuXG5cdGNvbnN0cnVjdG9yKFxuXHRcdGFwcF9jb250ZXh0OiBPV2ViQXBwLFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgZW50aXR5OiB0eXBlb2YgR29ibFNpbmdsZVBLRW50aXR5LFxuXHRcdHNlcnZpY2VfbmFtZTogc3RyaW5nXG5cdCkge1xuXHRcdHN1cGVyKGFwcF9jb250ZXh0LCBzZXJ2aWNlX25hbWUpO1xuXHR9XG5cblx0Z2V0SXRlbShcblx0XHRpZDogc3RyaW5nLFxuXHRcdHJlbGF0aW9uczogc3RyaW5nID0gJycsXG5cdFx0dGhlbj86IHRTZXJ2aWNlR2V0U3VjY2VzczxUPixcblx0XHRmYWlsPzogdFNlcnZpY2VGYWlsLFxuXHRcdGZyZWV6ZTogYm9vbGVhbiA9IHRydWUsXG5cdFx0bG9hZF9jYWNoZV9maXJzdDogYm9vbGVhbiA9IGZhbHNlLFxuXHRcdGRpYWxvZzogYm9vbGVhbiA9IHRydWVcblx0KTogT1dlYkNvbSB7XG5cdFx0bGV0IGN0eCA9IHRoaXMsXG5cdFx0XHRhcHAgPSB0aGlzLmFwcF9jb250ZXh0O1xuXHRcdHJldHVybiBjdHguZ2V0UmVxdWVzdChcblx0XHRcdGlkLFxuXHRcdFx0cmVsYXRpb25zLFxuXHRcdFx0KHJlc3BvbnNlLCBmcm9tQ2FjaGUpID0+IHtcblx0XHRcdFx0Y3R4LmFkZEl0ZW1Ub0xpc3QocmVzcG9uc2UuZGF0YS5pdGVtLCByZXNwb25zZS5kYXRhLnJlbGF0aW9ucyk7XG5cdFx0XHRcdHRoZW4gJiYgdGhlbihyZXNwb25zZSwgZnJvbUNhY2hlKTtcblx0XHRcdH0sXG5cdFx0XHRyZXNwb25zZSA9PiB7XG5cdFx0XHRcdGRpYWxvZyAmJiBhcHAudmlldy5kaWFsb2cocmVzcG9uc2UpO1xuXHRcdFx0XHRmYWlsICYmIGZhaWwocmVzcG9uc2UpO1xuXHRcdFx0fSxcblx0XHRcdGZyZWV6ZSxcblx0XHRcdGxvYWRfY2FjaGVfZmlyc3Rcblx0XHQpO1xuXHR9XG5cblx0Z2V0QWxsSXRlbXMoXG5cdFx0b3B0aW9uczogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucyA9IHt9LFxuXHRcdHRoZW4/OiB0U2VydmljZUdldEFsbFN1Y2Nlc3M8VD4sXG5cdFx0ZmFpbD86IHRTZXJ2aWNlRmFpbCxcblx0XHRmcmVlemU6IGJvb2xlYW4gPSB0cnVlLFxuXHRcdGZvcmNlX2NhY2hlOiBib29sZWFuID0gdHJ1ZSxcblx0XHRkaWFsb2c6IGJvb2xlYW4gPSB0cnVlXG5cdCk6IE9XZWJDb20ge1xuXHRcdGxldCBjdHggPSB0aGlzLFxuXHRcdFx0YXBwID0gdGhpcy5hcHBfY29udGV4dDtcblx0XHRyZXR1cm4gY3R4LmdldEFsbFJlcXVlc3QoXG5cdFx0XHRvcHRpb25zLFxuXHRcdFx0KHJlc3BvbnNlLCBmcm9tQ2FjaGUpID0+IHtcblx0XHRcdFx0Y3R4LmFkZEl0ZW1zVG9MaXN0KFxuXHRcdFx0XHRcdHJlc3BvbnNlLmRhdGEuaXRlbXMsXG5cdFx0XHRcdFx0cmVzcG9uc2UuZGF0YS5yZWxhdGlvbnNcblx0XHRcdFx0KTtcblx0XHRcdFx0dGhlbiAmJiB0aGVuKHJlc3BvbnNlLCBmcm9tQ2FjaGUpO1xuXHRcdFx0fSxcblx0XHRcdHJlc3BvbnNlID0+IHtcblx0XHRcdFx0ZGlhbG9nICYmIGFwcC52aWV3LmRpYWxvZyhyZXNwb25zZSk7XG5cdFx0XHRcdGZhaWwgJiYgZmFpbChyZXNwb25zZSk7XG5cdFx0XHR9LFxuXHRcdFx0ZnJlZXplLFxuXHRcdFx0Zm9yY2VfY2FjaGVcblx0XHQpO1xuXHR9XG5cblx0YWRkSXRlbShcblx0XHRkYXRhOiBhbnksXG5cdFx0dGhlbj86IHRTZXJ2aWNlQWRkU3VjY2VzczxUPixcblx0XHRmYWlsPzogdFNlcnZpY2VGYWlsLFxuXHRcdGZyZWV6ZTogYm9vbGVhbiA9IHRydWUsXG5cdFx0ZGlhbG9nOiBib29sZWFuID0gdHJ1ZVxuXHQpOiBPV2ViQ29tIHtcblx0XHRsZXQgY3R4ID0gdGhpcyxcblx0XHRcdGFwcCA9IHRoaXMuYXBwX2NvbnRleHQ7XG5cdFx0cmV0dXJuIGN0eC5hZGRSZXF1ZXN0KFxuXHRcdFx0ZGF0YSxcblx0XHRcdHJlc3VsdCA9PiB7XG5cdFx0XHRcdGN0eC5hZGRDcmVhdGVkKHJlc3VsdCk7XG5cdFx0XHRcdHRoZW4gJiYgdGhlbihyZXN1bHQpO1xuXHRcdFx0fSxcblx0XHRcdHJlc3BvbnNlID0+IHtcblx0XHRcdFx0ZGlhbG9nICYmIGFwcC52aWV3LmRpYWxvZyhyZXNwb25zZSk7XG5cdFx0XHRcdGZhaWwgJiYgZmFpbChyZXNwb25zZSk7XG5cdFx0XHR9LFxuXHRcdFx0ZnJlZXplXG5cdFx0KTtcblx0fVxuXG5cdHVwZGF0ZUl0ZW0oXG5cdFx0aXRlbTogVCxcblx0XHR0aGVuPzogdFNlcnZpY2VVcGRhdGVTdWNjZXNzPFQ+LFxuXHRcdGZhaWw/OiB0U2VydmljZUZhaWwsXG5cdFx0ZnJlZXplOiBib29sZWFuID0gdHJ1ZSxcblx0XHRkaWFsb2c6IGJvb2xlYW4gPSB0cnVlXG5cdCk6IE9XZWJDb20gfCBmYWxzZSB7XG5cdFx0bGV0IGN0eCA9IHRoaXMsXG5cdFx0XHRhcHAgPSB0aGlzLmFwcF9jb250ZXh0LFxuXHRcdFx0aWQgPSBnZXRJZChpdGVtKTtcblxuXHRcdGlmICghaXRlbS5pc1NhdmVkKCkpIHtcblx0XHRcdGxldCBkaWZmID0gaXRlbS50b09iamVjdCh0cnVlKTtcblxuXHRcdFx0aXRlbS5pc1NhdmluZyh0cnVlKTtcblxuXHRcdFx0cmV0dXJuIGN0eC51cGRhdGVSZXF1ZXN0KFxuXHRcdFx0XHRpZCxcblx0XHRcdFx0ZGlmZixcblx0XHRcdFx0cmVzdWx0ID0+IHtcblx0XHRcdFx0XHRpdGVtLmlzU2F2aW5nKGZhbHNlKTtcblx0XHRcdFx0XHRjdHguc2V0U2F2ZWQoaXRlbSwgcmVzdWx0KTtcblx0XHRcdFx0XHR0aGVuICYmIHRoZW4ocmVzdWx0KTtcblx0XHRcdFx0fSxcblx0XHRcdFx0cmVzcG9uc2UgPT4ge1xuXHRcdFx0XHRcdGl0ZW0uaXNTYXZpbmcoZmFsc2UpO1xuXHRcdFx0XHRcdGRpYWxvZyAmJiBhcHAudmlldy5kaWFsb2cocmVzcG9uc2UpO1xuXHRcdFx0XHRcdGZhaWwgJiYgZmFpbChyZXNwb25zZSk7XG5cdFx0XHRcdH0sXG5cdFx0XHRcdGZyZWV6ZVxuXHRcdFx0KTtcblx0XHR9XG5cblx0XHRjb25zb2xlLmVycm9yKCdOb3QgbW9kaWZpZWQgLT4nLCBpdGVtKTtcblx0XHRyZXR1cm4gZmFsc2U7XG5cdH1cblxuXHRkZWxldGVJdGVtKFxuXHRcdGl0ZW06IFQsXG5cdFx0dGhlbj86IHRTZXJ2aWNlRGVsZXRlU3VjY2VzczxUPixcblx0XHRmYWlsPzogdFNlcnZpY2VGYWlsLFxuXHRcdGZyZWV6ZTogYm9vbGVhbiA9IHRydWUsXG5cdFx0ZGlhbG9nOiBib29sZWFuID0gdHJ1ZVxuXHQpOiBPV2ViQ29tIHtcblx0XHRsZXQgY3R4ID0gdGhpcyxcblx0XHRcdGFwcCA9IHRoaXMuYXBwX2NvbnRleHQsXG5cdFx0XHRpZCA9IGdldElkKGl0ZW0pO1xuXG5cdFx0aXRlbS5pc0RlbGV0aW5nKHRydWUpO1xuXHRcdHJldHVybiBjdHguZGVsZXRlUmVxdWVzdChcblx0XHRcdGlkLFxuXHRcdFx0cmVzdWx0ID0+IHtcblx0XHRcdFx0aXRlbS5pc0RlbGV0aW5nKGZhbHNlKTtcblx0XHRcdFx0Y3R4LnNldERlbGV0ZWQocmVzdWx0KTtcblx0XHRcdFx0dGhlbiAmJiB0aGVuKHJlc3VsdCk7XG5cdFx0XHR9LFxuXHRcdFx0cmVzcG9uc2UgPT4ge1xuXHRcdFx0XHRpdGVtLmlzRGVsZXRpbmcoZmFsc2UpO1xuXHRcdFx0XHRkaWFsb2cgJiYgYXBwLnZpZXcuZGlhbG9nKHJlc3BvbnNlKTtcblx0XHRcdFx0ZmFpbCAmJiBmYWlsKHJlc3BvbnNlKTtcblx0XHRcdH0sXG5cdFx0XHRmcmVlemVcblx0XHQpO1xuXHR9XG5cblx0YWRkSXRlbXNUb0xpc3QoaXRlbXM6IFRbXSB8IHsgW2tleTogc3RyaW5nXTogVCB9LCByZWxhdGlvbnM6IGFueSA9IHt9KSB7XG5cdFx0bGV0IGN0eCA9IHRoaXM7XG5cdFx0bGV0IGxpc3Q6IFRbXSA9IChVdGlscy5pc1BsYWluT2JqZWN0KGl0ZW1zKVxuXHRcdFx0PyBPYmplY3QudmFsdWVzKGl0ZW1zKVxuXHRcdFx0OiBpdGVtcyB8fCBbXSkgYXMgVFtdO1xuXG5cdFx0bGlzdC5mb3JFYWNoKGl0ZW0gPT4ge1xuXHRcdFx0bGV0IGl0ZW1JZCA9IGdldElkKGl0ZW0pO1xuXG5cdFx0XHRjdHguc2FmZWx5QWRkSXRlbShpdGVtKTtcblxuXHRcdFx0aWYgKCFjdHgucmVsYXRpb25zW2l0ZW1JZF0pIHtcblx0XHRcdFx0Y3R4LnJlbGF0aW9ucyA9IF93aXRoKGN0eC5yZWxhdGlvbnMsIGl0ZW1JZCwge30pO1xuXHRcdFx0fVxuXG5cdFx0XHRmb3IgKGxldCByZWwgaW4gcmVsYXRpb25zKSB7XG5cdFx0XHRcdGlmIChyZWxhdGlvbnMuaGFzT3duUHJvcGVydHkocmVsKSkge1xuXHRcdFx0XHRcdGxldCBkYXRhID0gcmVsYXRpb25zW3JlbF07XG5cblx0XHRcdFx0XHRpZiAoZGF0YVtpdGVtSWRdKSB7XG5cdFx0XHRcdFx0XHRjdHgucmVsYXRpb25zW2l0ZW1JZF0gPSBfd2l0aChcblx0XHRcdFx0XHRcdFx0Y3R4LnJlbGF0aW9uc1tpdGVtSWRdLFxuXHRcdFx0XHRcdFx0XHRyZWwsXG5cdFx0XHRcdFx0XHRcdGRhdGFbaXRlbUlkXVxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9KTtcblx0fVxuXG5cdGFkZEl0ZW1Ub0xpc3QoaXRlbTogVCwgcmVsYXRpb25zOiBhbnkgPSB7fSkge1xuXHRcdGxldCBjdHggPSB0aGlzLFxuXHRcdFx0aXRlbUlkID0gZ2V0SWQoaXRlbSk7XG5cblx0XHRjdHguc2FmZWx5QWRkSXRlbShpdGVtKTtcblxuXHRcdGlmICghY3R4LnJlbGF0aW9uc1tpdGVtSWRdKSB7XG5cdFx0XHRjdHgucmVsYXRpb25zID0gX3dpdGgoY3R4LnJlbGF0aW9ucywgaXRlbUlkLCB7fSk7XG5cdFx0fVxuXG5cdFx0Zm9yIChsZXQgcmVsIGluIHJlbGF0aW9ucykge1xuXHRcdFx0aWYgKHJlbGF0aW9ucy5oYXNPd25Qcm9wZXJ0eShyZWwpKSB7XG5cdFx0XHRcdGN0eC5yZWxhdGlvbnNbaXRlbUlkXSA9IF93aXRoKFxuXHRcdFx0XHRcdGN0eC5yZWxhdGlvbnNbaXRlbUlkXSxcblx0XHRcdFx0XHRyZWwsXG5cdFx0XHRcdFx0cmVsYXRpb25zW3JlbF1cblx0XHRcdFx0KTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIHNhZmVseUFkZEl0ZW0oaXRlbTogVCkge1xuXHRcdGxldCBrZXkgPSBnZXRJZChpdGVtKSxcblx0XHRcdGNhY2hlZEl0ZW0gPSB0aGlzLml0ZW1zW2tleV07XG5cblx0XHRpZiAoY2FjaGVkSXRlbSkge1xuXHRcdFx0Y2FjaGVkSXRlbS5kb0h5ZHJhdGUoaXRlbS50b09iamVjdCgpLCB0cnVlKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5pdGVtcyA9IF93aXRoKHRoaXMuaXRlbXMsIGtleSwgaXRlbSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRzZXRTYXZlZCh0YXJnZXQ6IFQsIHJlc3BvbnNlOiBpU2VydmljZVVwZGF0ZVJlc3BvbnNlPFQ+KSB7XG5cdFx0bGV0IGl0ZW0gPSByZXNwb25zZS5kYXRhLml0ZW07XG5cblx0XHR0YXJnZXQuZG9IeWRyYXRlKGl0ZW0udG9PYmplY3QoKSwgdHJ1ZSk7XG5cblx0XHR0aGlzLnNhZmVseUFkZEl0ZW0odGFyZ2V0KTtcblx0fVxuXG5cdGFkZENyZWF0ZWQocmVzcG9uc2U6IGlTZXJ2aWNlQWRkUmVzcG9uc2U8VD4pIHtcblx0XHR0aGlzLnNhZmVseUFkZEl0ZW0ocmVzcG9uc2UuZGF0YS5pdGVtKTtcblx0fVxuXG5cdHNldERlbGV0ZWQocmVzcG9uc2U6IGlTZXJ2aWNlRGVsZXRlUmVzcG9uc2U8VD4pIHtcblx0XHRsZXQgaXRlbSA9IHJlc3BvbnNlLmRhdGEuaXRlbTtcblx0XHR0aGlzLml0ZW1zID0gX3dpdGhvdXQodGhpcy5pdGVtcywgZ2V0SWQoaXRlbSkpO1xuXHR9XG5cblx0aXRlbVJlbGF0aW9uPFo+KGl0ZW06IFQsIHJlbGF0aW9uOiBzdHJpbmcpOiBaIHwgdW5kZWZpbmVkIHtcblx0XHRsZXQgaWQgPSBnZXRJZChpdGVtKTtcblx0XHRyZXR1cm4gdGhpcy5yZWxhdGlvbnNbaWRdICYmIHRoaXMucmVsYXRpb25zW2lkXVtyZWxhdGlvbl07XG5cdH1cblxuXHRpZGVudGlmeShpZDogc3RyaW5nLCBjaGVja0NhY2hlOiBib29sZWFuID0gdHJ1ZSk6IFQgfCB1bmRlZmluZWQge1xuXHRcdGxldCBpdGVtID0gdGhpcy5pdGVtc1tpZF0sXG5cdFx0XHRjO1xuXG5cdFx0aWYgKGl0ZW0pIHJldHVybiBpdGVtO1xuXG5cdFx0aWYgKGNoZWNrQ2FjaGUpIHtcblx0XHRcdGMgPSA8YW55PkdvYmxFbnRpdHkuc3ViQ2FjaGUodGhpcy5lbnRpdHkubmFtZSk7XG5cblx0XHRcdHJldHVybiBjICYmIGNbaWRdO1xuXHRcdH1cblxuXHRcdHJldHVybiB1bmRlZmluZWQ7XG5cdH1cblxuXHRsaXN0KGlkczogc3RyaW5nW10gPSBbXSkge1xuXHRcdGxldCBsaXN0OiBUW10gPSBbXSxcblx0XHRcdGxlbiA9IGlkcy5sZW5ndGg7XG5cdFx0aWYgKGxlbikge1xuXHRcdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykge1xuXHRcdFx0XHRsZXQgaWQgPSBpZHNbaV0sXG5cdFx0XHRcdFx0aXRlbSA9IHRoaXMuaWRlbnRpZnkoaWQpO1xuXHRcdFx0XHRpZiAoaXRlbSkge1xuXHRcdFx0XHRcdGxpc3QucHVzaChpdGVtKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH0gZWxzZSB7XG5cdFx0XHRmb3IgKGxldCBrZXkgaW4gdGhpcy5pdGVtcykge1xuXHRcdFx0XHRpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMuaXRlbXMsIGtleSkpIHtcblx0XHRcdFx0XHRsaXN0LnB1c2godGhpcy5pdGVtc1trZXldKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiBsaXN0O1xuXHR9XG5cblx0b3JkZXJCeShvcmRlckZuOiB0RW50aXRpZXNPcmRlckJ5Q2I8VD4pOiBUW10ge1xuXHRcdGxldCBrZXlzID0gT2JqZWN0LmtleXModGhpcy5pdGVtcyk7XG5cblx0XHRyZXR1cm4ga2V5cy5tYXAoa2V5ID0+IHRoaXMuaXRlbXNba2V5XSkuc29ydChvcmRlckZuKTtcblx0fVxuXG5cdG9yZGVyQnlWYWx1ZU9mKGNvbHVtbjogc3RyaW5nKTogVFtdIHtcblx0XHRyZXR1cm4gdGhpcy5vcmRlckJ5KChhOiBhbnksIGI6IGFueSkgPT4ge1xuXHRcdFx0cmV0dXJuIGFbY29sdW1uXSAtIGJbY29sdW1uXTtcblx0XHR9KTtcblx0fVxuXG5cdHNlbGVjdChcblx0XHRsaXN0OiBUW10gPSB0aGlzLmxpc3QoKSxcblx0XHRwcmVkaWNhdGU6ICh2YWx1ZTogVCwgaW5kZXg6IG51bWJlcikgPT4gYm9vbGVhbixcblx0XHRtYXggPSBJbmZpbml0eVxuXHQpOiBUW10ge1xuXHRcdGxldCByZXN1bHQ6IFRbXSA9IFtdLFxuXHRcdFx0bGVuID0gbGlzdC5sZW5ndGg7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGxlbiAmJiByZXN1bHQubGVuZ3RoIDwgbWF4OyBpKyspIHtcblx0XHRcdGlmIChwcmVkaWNhdGUobGlzdFtpXSwgaSkpIHtcblx0XHRcdFx0cmVzdWx0LnB1c2gobGlzdFtpXSk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHJlc3VsdDtcblx0fVxuXG5cdHNlYXJjaChcblx0XHRsaXN0OiBUW10gPSB0aGlzLmxpc3QoKSxcblx0XHRzZWFyY2g6IHN0cmluZyxcblx0XHRzdHJpbmdCdWlsZGVyOiAodmFsdWU6IFQsIGluZGV4OiBudW1iZXIpID0+IHN0cmluZ1xuXHQpOiBUW10ge1xuXHRcdGlmICghKHNlYXJjaCA9IHNlYXJjaC50cmltKCkpLmxlbmd0aCkge1xuXHRcdFx0cmV0dXJuIGxpc3Q7XG5cdFx0fVxuXG5cdFx0bGV0IHJlZyA9IG5ldyBSZWdFeHAoZXNjYXBlUmVnRXhwKHNlYXJjaCksICdpJyk7XG5cblx0XHRyZXR1cm4gbGlzdC5maWx0ZXIoKGl0ZW06IGFueSwgaW5kZXg6IG51bWJlcikgPT4ge1xuXHRcdFx0bGV0IHYgPSBzdHJpbmdCdWlsZGVyKGl0ZW0sIGluZGV4KTtcblx0XHRcdHJldHVybiByZWcudGVzdCh2KTtcblx0XHR9KTtcblx0fVxuXG5cdHRvdGFsQ291bnQoKTogbnVtYmVyIHtcblx0XHRyZXR1cm4gT2JqZWN0LmtleXModGhpcy5pdGVtcykubGVuZ3RoO1xuXHR9XG59XG4iXX0=