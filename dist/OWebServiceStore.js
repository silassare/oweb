import { GoblEntity } from 'gobl-utils-ts';
import OWebService from './OWebService';
import Utils from './utils/Utils';
const getId = (item) => item.singlePKValue();
const _with = (target, key, item) => {
    return { ...target, [key]: item };
}, _without = (target, key) => {
    delete target[key];
    return { ...target };
};
export default class OWebServiceStore extends OWebService {
    constructor(app_context, entity, service_name) {
        super(app_context, service_name);
        this.entity = entity;
        this.items = {};
        this.relations = {};
    }
    getItem(id, relations = '', then, fail, freeze = true, load_cache_first = false, dialog = true) {
        let ctx = this, app = this.app_context;
        return ctx.getRequest(id, relations, (response, fromCache) => {
            ctx.addItemToList(response.data.item, response.data.relations);
            then && then(response, fromCache);
        }, response => {
            dialog && app.view.dialog(response);
            fail && fail(response);
        }, freeze, load_cache_first);
    }
    getAllItems(options = {}, then, fail, freeze = true, force_cache = true, dialog = true) {
        let ctx = this, app = this.app_context;
        return ctx.getAllRequest(options, (response, fromCache) => {
            ctx.addItemsToList(response.data.items, response.data.relations);
            then && then(response, fromCache);
        }, response => {
            dialog && app.view.dialog(response);
            fail && fail(response);
        }, freeze, force_cache);
    }
    addItem(data, then, fail, freeze = true, dialog = true) {
        let ctx = this, app = this.app_context;
        return ctx.addRequest(data, result => {
            ctx.addCreated(result);
            then && then(result);
        }, response => {
            dialog && app.view.dialog(response);
            fail && fail(response);
        }, freeze);
    }
    updateItem(item, then, fail, freeze = true, dialog = true) {
        let ctx = this, app = this.app_context, id = getId(item);
        if (!item.isSaved()) {
            let diff = item.toObject(true);
            item.isSaving(true);
            return ctx.updateRequest(id, diff, result => {
                item.isSaving(false);
                ctx.setSaved(item, result);
                then && then(result);
            }, response => {
                item.isSaving(false);
                dialog && app.view.dialog(response);
                fail && fail(response);
            }, freeze);
        }
        console.error('Not modified ->', item);
        return false;
    }
    deleteItem(item, then, fail, freeze = true, dialog = true) {
        let ctx = this, app = this.app_context, id = getId(item);
        item.isDeleting(true);
        return ctx.deleteRequest(id, result => {
            item.isDeleting(false);
            ctx.setDeleted(result);
            then && then(result);
        }, response => {
            item.isDeleting(false);
            dialog && app.view.dialog(response);
            fail && fail(response);
        }, freeze);
    }
    addItemsToList(items, relations = {}) {
        let ctx = this;
        let list = (Utils.isPlainObject(items)
            ? Object.values(items)
            : items || []);
        list.forEach(item => {
            let itemId = getId(item);
            ctx.safelyAddItem(item);
            if (!ctx.relations[itemId]) {
                ctx.relations = _with(ctx.relations, itemId, {});
            }
            for (let rel in relations) {
                if (relations.hasOwnProperty(rel)) {
                    let data = relations[rel];
                    if (data[itemId]) {
                        ctx.relations[itemId] = _with(ctx.relations[itemId], rel, data[itemId]);
                    }
                }
            }
        });
    }
    addItemToList(item, relations = {}) {
        let ctx = this, itemId = getId(item);
        ctx.safelyAddItem(item);
        if (!ctx.relations[itemId]) {
            ctx.relations = _with(ctx.relations, itemId, {});
        }
        for (let rel in relations) {
            if (relations.hasOwnProperty(rel)) {
                ctx.relations[itemId] = _with(ctx.relations[itemId], rel, relations[rel]);
            }
        }
    }
    safelyAddItem(item) {
        let key = getId(item), cachedItem = this.items[key];
        if (cachedItem) {
            cachedItem.doHydrate(item.toObject(), true);
        }
        else {
            this.items = _with(this.items, key, item);
        }
        return this;
    }
    setSaved(target, response) {
        let item = response.data.item;
        target.doHydrate(item.toObject(), true);
        this.safelyAddItem(target);
    }
    addCreated(response) {
        this.safelyAddItem(response.data.item);
    }
    setDeleted(response) {
        let item = response.data.item;
        this.items = _without(this.items, getId(item));
    }
    itemRelation(item, relation) {
        let id = getId(item);
        return this.relations[id] && this.relations[id][relation];
    }
    identify(id, checkCache = true) {
        let item = this.items[id], c;
        if (item)
            return item;
        if (checkCache) {
            c = GoblEntity.subCache(this.entity.name);
            return c && c[id];
        }
        return undefined;
    }
    list(ids = []) {
        let list = [], len = ids.length;
        if (len) {
            for (let i = 0; i < len; i++) {
                let id = ids[i], item = this.identify(id);
                if (item) {
                    list.push(item);
                }
            }
        }
        else {
            for (let key in this.items) {
                if (Object.prototype.hasOwnProperty.call(this.items, key)) {
                    list.push(this.items[key]);
                }
            }
        }
        return list;
    }
    orderBy(orderFn) {
        let keys = Object.keys(this.items);
        return keys.map(key => this.items[key]).sort(orderFn);
    }
    orderByValueOf(column) {
        return this.orderBy((a, b) => {
            return a[column] - b[column];
        });
    }
    select(list = this.list(), predicate, max = Infinity) {
        let result = [], len = list.length;
        for (let i = 0; i < len && result.length < max; i++) {
            if (predicate(list[i], i)) {
                result.push(list[i]);
            }
        }
        return result;
    }
    search(list = this.list(), search, stringBuilder) {
        if (!(search = search.trim()).length) {
            return list;
        }
        let reg = new RegExp(Utils.escapeRegExp(search), 'i');
        return list.filter((item, index) => {
            let v = stringBuilder(item, index);
            return reg.test(v);
        });
    }
    totalCount() {
        return Object.keys(this.items).length;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlNlcnZpY2VTdG9yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViU2VydmljZVN0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQXNCLE1BQU0sZUFBZSxDQUFDO0FBQy9ELE9BQU8sV0FXTixNQUFNLGVBQWUsQ0FBQztBQUd2QixPQUFPLEtBQUssTUFBTSxlQUFlLENBQUM7QUFJbEMsTUFBTSxLQUFLLEdBQUcsQ0FBQyxJQUF3QixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7QUFFakUsTUFBTSxLQUFLLEdBQUcsQ0FBQyxNQUFXLEVBQUUsR0FBb0IsRUFBRSxJQUFTLEVBQUUsRUFBRTtJQUM3RCxPQUFPLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQztBQUNuQyxDQUFDLEVBQ0QsUUFBUSxHQUFHLENBQUMsTUFBVyxFQUFFLEdBQW9CLEVBQUUsRUFBRTtJQUNoRCxPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNuQixPQUFPLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQztBQUN0QixDQUFDLENBQUM7QUFFSCxNQUFNLENBQUMsT0FBTyxPQUFPLGdCQUVuQixTQUFRLFdBQWM7SUFJdkIsWUFDQyxXQUFvQixFQUNILE1BQWlDLEVBQ2xELFlBQW9CO1FBRXBCLEtBQUssQ0FBQyxXQUFXLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFIaEIsV0FBTSxHQUFOLE1BQU0sQ0FBMkI7UUFMekMsVUFBSyxHQUF5QixFQUFFLENBQUM7UUFDakMsY0FBUyxHQUEyQixFQUFFLENBQUM7SUFRakQsQ0FBQztJQUVELE9BQU8sQ0FDTixFQUFVLEVBQ1YsWUFBb0IsRUFBRSxFQUN0QixJQUE0QixFQUM1QixJQUFtQixFQUNuQixTQUFrQixJQUFJLEVBQ3RCLG1CQUE0QixLQUFLLEVBQ2pDLFNBQWtCLElBQUk7UUFF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QyxJQUFJLENBQUMsR0FBRyxhQUFhLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ25DLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwQixDQUFDLENBQUMsQ0FBQztJQUNKLENBQUM7SUFFRCxVQUFVO1FBQ1QsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDdkMsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgR29ibEVudGl0eSwgR29ibFNpbmdsZVBLRW50aXR5IH0gZnJvbSAnZ29ibC11dGlscy10cyc7XG5pbXBvcnQgT1dlYlNlcnZpY2UsIHtcblx0dFNlcnZpY2VHZXRTdWNjZXNzLFxuXHR0U2VydmljZUZhaWwsXG5cdHRTZXJ2aWNlQWRkU3VjY2Vzcyxcblx0dFNlcnZpY2VSZXF1ZXN0T3B0aW9ucyxcblx0dFNlcnZpY2VHZXRBbGxTdWNjZXNzLFxuXHR0U2VydmljZVVwZGF0ZVN1Y2Nlc3MsXG5cdHRTZXJ2aWNlRGVsZXRlU3VjY2Vzcyxcblx0aVNlcnZpY2VVcGRhdGVSZXNwb25zZSxcblx0aVNlcnZpY2VBZGRSZXNwb25zZSxcblx0aVNlcnZpY2VEZWxldGVSZXNwb25zZSxcbn0gZnJvbSAnLi9PV2ViU2VydmljZSc7XG5pbXBvcnQgT1dlYkFwcCBmcm9tICcuL09XZWJBcHAnO1xuaW1wb3J0IE9XZWJDb20gZnJvbSAnLi9PV2ViQ29tJztcbmltcG9ydCBVdGlscyBmcm9tICcuL3V0aWxzL1V0aWxzJztcblxuZXhwb3J0IHR5cGUgdEVudGl0aWVzT3JkZXJCeUNiPFQ+ID0gKGE6IFQsIGI6IFQpID0+IG51bWJlcjtcblxuY29uc3QgZ2V0SWQgPSAoaXRlbTogR29ibFNpbmdsZVBLRW50aXR5KSA9PiBpdGVtLnNpbmdsZVBLVmFsdWUoKTtcblxuY29uc3QgX3dpdGggPSAodGFyZ2V0OiBhbnksIGtleTogc3RyaW5nIHwgbnVtYmVyLCBpdGVtOiBhbnkpID0+IHtcblx0XHRyZXR1cm4geyAuLi50YXJnZXQsIFtrZXldOiBpdGVtIH07XG5cdH0sXG5cdF93aXRob3V0ID0gKHRhcmdldDogYW55LCBrZXk6IHN0cmluZyB8IG51bWJlcikgPT4ge1xuXHRcdGRlbGV0ZSB0YXJnZXRba2V5XTtcblx0XHRyZXR1cm4geyAuLi50YXJnZXQgfTtcblx0fTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT1dlYlNlcnZpY2VTdG9yZTxcblx0VCBleHRlbmRzIEdvYmxTaW5nbGVQS0VudGl0eVxuPiBleHRlbmRzIE9XZWJTZXJ2aWNlPFQ+IHtcblx0cHJvdGVjdGVkIGl0ZW1zOiB7IFtrZXk6IHN0cmluZ106IFQgfSA9IHt9O1xuXHRwcm90ZWN0ZWQgcmVsYXRpb25zOiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge307XG5cblx0Y29uc3RydWN0b3IoXG5cdFx0YXBwX2NvbnRleHQ6IE9XZWJBcHAsXG5cdFx0cHJpdmF0ZSByZWFkb25seSBlbnRpdHk6IHR5cGVvZiBHb2JsU2luZ2xlUEtFbnRpdHksXG5cdFx0c2VydmljZV9uYW1lOiBzdHJpbmdcblx0KSB7XG5cdFx0c3VwZXIoYXBwX2NvbnRleHQsIHNlcnZpY2VfbmFtZSk7XG5cdH1cblxuXHRnZXRJdGVtKFxuXHRcdGlkOiBzdHJpbmcsXG5cdFx0cmVsYXRpb25zOiBzdHJpbmcgPSAnJyxcblx0XHR0aGVuPzogdFNlcnZpY2VHZXRTdWNjZXNzPFQ+LFxuXHRcdGZhaWw/OiB0U2VydmljZUZhaWwsXG5cdFx0ZnJlZXplOiBib29sZWFuID0gdHJ1ZSxcblx0XHRsb2FkX2NhY2hlX2ZpcnN0OiBib29sZWFuID0gZmFsc2UsXG5cdFx0ZGlhbG9nOiBib29sZWFuID0gdHJ1ZVxuXHQpOiBPV2ViQ29tIHtcblx0XHRsZXQgY3R4ID0gdGhpcyxcblx0XHRcdGFwcCA9IHRoaXMuYXBwX2NvbnRleHQ7XG5cdFx0cmV0dXJuIGN0eC5nZXRSZXF1ZXN0KFxuXHRcdFx0aWQsXG5cdFx0XHRyZWxhdGlvbnMsXG5cdFx0XHQocmVzcG9uc2UsIGZyb21DYWNoZSkgPT4ge1xuXHRcdFx0XHRjdHguYWRkSXRlbVRvTGlzdChyZXNwb25zZS5kYXRhLml0ZW0sIHJlc3BvbnNlLmRhdGEucmVsYXRpb25zKTtcblx0XHRcdFx0dGhlbiAmJiB0aGVuKHJlc3BvbnNlLCBmcm9tQ2FjaGUpO1xuXHRcdFx0fSxcblx0XHRcdHJlc3BvbnNlID0+IHtcblx0XHRcdFx0ZGlhbG9nICYmIGFwcC52aWV3LmRpYWxvZyhyZXNwb25zZSk7XG5cdFx0XHRcdGZhaWwgJiYgZmFpbChyZXNwb25zZSk7XG5cdFx0XHR9LFxuXHRcdFx0ZnJlZXplLFxuXHRcdFx0bG9hZF9jYWNoZV9maXJzdFxuXHRcdCk7XG5cdH1cblxuXHRnZXRBbGxJdGVtcyhcblx0XHRvcHRpb25zOiB0U2VydmljZVJlcXVlc3RPcHRpb25zID0ge30sXG5cdFx0dGhlbj86IHRTZXJ2aWNlR2V0QWxsU3VjY2VzczxUPixcblx0XHRmYWlsPzogdFNlcnZpY2VGYWlsLFxuXHRcdGZyZWV6ZTogYm9vbGVhbiA9IHRydWUsXG5cdFx0Zm9yY2VfY2FjaGU6IGJvb2xlYW4gPSB0cnVlLFxuXHRcdGRpYWxvZzogYm9vbGVhbiA9IHRydWVcblx0KTogT1dlYkNvbSB7XG5cdFx0bGV0IGN0eCA9IHRoaXMsXG5cdFx0XHRhcHAgPSB0aGlzLmFwcF9jb250ZXh0O1xuXHRcdHJldHVybiBjdHguZ2V0QWxsUmVxdWVzdChcblx0XHRcdG9wdGlvbnMsXG5cdFx0XHQocmVzcG9uc2UsIGZyb21DYWNoZSkgPT4ge1xuXHRcdFx0XHRjdHguYWRkSXRlbXNUb0xpc3QoXG5cdFx0XHRcdFx0cmVzcG9uc2UuZGF0YS5pdGVtcyxcblx0XHRcdFx0XHRyZXNwb25zZS5kYXRhLnJlbGF0aW9uc1xuXHRcdFx0XHQpO1xuXHRcdFx0XHR0aGVuICYmIHRoZW4ocmVzcG9uc2UsIGZyb21DYWNoZSk7XG5cdFx0XHR9LFxuXHRcdFx0cmVzcG9uc2UgPT4ge1xuXHRcdFx0XHRkaWFsb2cgJiYgYXBwLnZpZXcuZGlhbG9nKHJlc3BvbnNlKTtcblx0XHRcdFx0ZmFpbCAmJiBmYWlsKHJlc3BvbnNlKTtcblx0XHRcdH0sXG5cdFx0XHRmcmVlemUsXG5cdFx0XHRmb3JjZV9jYWNoZVxuXHRcdCk7XG5cdH1cblxuXHRhZGRJdGVtKFxuXHRcdGRhdGE6IGFueSxcblx0XHR0aGVuPzogdFNlcnZpY2VBZGRTdWNjZXNzPFQ+LFxuXHRcdGZhaWw/OiB0U2VydmljZUZhaWwsXG5cdFx0ZnJlZXplOiBib29sZWFuID0gdHJ1ZSxcblx0XHRkaWFsb2c6IGJvb2xlYW4gPSB0cnVlXG5cdCk6IE9XZWJDb20ge1xuXHRcdGxldCBjdHggPSB0aGlzLFxuXHRcdFx0YXBwID0gdGhpcy5hcHBfY29udGV4dDtcblx0XHRyZXR1cm4gY3R4LmFkZFJlcXVlc3QoXG5cdFx0XHRkYXRhLFxuXHRcdFx0cmVzdWx0ID0+IHtcblx0XHRcdFx0Y3R4LmFkZENyZWF0ZWQocmVzdWx0KTtcblx0XHRcdFx0dGhlbiAmJiB0aGVuKHJlc3VsdCk7XG5cdFx0XHR9LFxuXHRcdFx0cmVzcG9uc2UgPT4ge1xuXHRcdFx0XHRkaWFsb2cgJiYgYXBwLnZpZXcuZGlhbG9nKHJlc3BvbnNlKTtcblx0XHRcdFx0ZmFpbCAmJiBmYWlsKHJlc3BvbnNlKTtcblx0XHRcdH0sXG5cdFx0XHRmcmVlemVcblx0XHQpO1xuXHR9XG5cblx0dXBkYXRlSXRlbShcblx0XHRpdGVtOiBULFxuXHRcdHRoZW4/OiB0U2VydmljZVVwZGF0ZVN1Y2Nlc3M8VD4sXG5cdFx0ZmFpbD86IHRTZXJ2aWNlRmFpbCxcblx0XHRmcmVlemU6IGJvb2xlYW4gPSB0cnVlLFxuXHRcdGRpYWxvZzogYm9vbGVhbiA9IHRydWVcblx0KTogT1dlYkNvbSB8IGZhbHNlIHtcblx0XHRsZXQgY3R4ID0gdGhpcyxcblx0XHRcdGFwcCA9IHRoaXMuYXBwX2NvbnRleHQsXG5cdFx0XHRpZCA9IGdldElkKGl0ZW0pO1xuXG5cdFx0aWYgKCFpdGVtLmlzU2F2ZWQoKSkge1xuXHRcdFx0bGV0IGRpZmYgPSBpdGVtLnRvT2JqZWN0KHRydWUpO1xuXG5cdFx0XHRpdGVtLmlzU2F2aW5nKHRydWUpO1xuXG5cdFx0XHRyZXR1cm4gY3R4LnVwZGF0ZVJlcXVlc3QoXG5cdFx0XHRcdGlkLFxuXHRcdFx0XHRkaWZmLFxuXHRcdFx0XHRyZXN1bHQgPT4ge1xuXHRcdFx0XHRcdGl0ZW0uaXNTYXZpbmcoZmFsc2UpO1xuXHRcdFx0XHRcdGN0eC5zZXRTYXZlZChpdGVtLCByZXN1bHQpO1xuXHRcdFx0XHRcdHRoZW4gJiYgdGhlbihyZXN1bHQpO1xuXHRcdFx0XHR9LFxuXHRcdFx0XHRyZXNwb25zZSA9PiB7XG5cdFx0XHRcdFx0aXRlbS5pc1NhdmluZyhmYWxzZSk7XG5cdFx0XHRcdFx0ZGlhbG9nICYmIGFwcC52aWV3LmRpYWxvZyhyZXNwb25zZSk7XG5cdFx0XHRcdFx0ZmFpbCAmJiBmYWlsKHJlc3BvbnNlKTtcblx0XHRcdFx0fSxcblx0XHRcdFx0ZnJlZXplXG5cdFx0XHQpO1xuXHRcdH1cblxuXHRcdGNvbnNvbGUuZXJyb3IoJ05vdCBtb2RpZmllZCAtPicsIGl0ZW0pO1xuXHRcdHJldHVybiBmYWxzZTtcblx0fVxuXG5cdGRlbGV0ZUl0ZW0oXG5cdFx0aXRlbTogVCxcblx0XHR0aGVuPzogdFNlcnZpY2VEZWxldGVTdWNjZXNzPFQ+LFxuXHRcdGZhaWw/OiB0U2VydmljZUZhaWwsXG5cdFx0ZnJlZXplOiBib29sZWFuID0gdHJ1ZSxcblx0XHRkaWFsb2c6IGJvb2xlYW4gPSB0cnVlXG5cdCk6IE9XZWJDb20ge1xuXHRcdGxldCBjdHggPSB0aGlzLFxuXHRcdFx0YXBwID0gdGhpcy5hcHBfY29udGV4dCxcblx0XHRcdGlkID0gZ2V0SWQoaXRlbSk7XG5cblx0XHRpdGVtLmlzRGVsZXRpbmcodHJ1ZSk7XG5cdFx0cmV0dXJuIGN0eC5kZWxldGVSZXF1ZXN0KFxuXHRcdFx0aWQsXG5cdFx0XHRyZXN1bHQgPT4ge1xuXHRcdFx0XHRpdGVtLmlzRGVsZXRpbmcoZmFsc2UpO1xuXHRcdFx0XHRjdHguc2V0RGVsZXRlZChyZXN1bHQpO1xuXHRcdFx0XHR0aGVuICYmIHRoZW4ocmVzdWx0KTtcblx0XHRcdH0sXG5cdFx0XHRyZXNwb25zZSA9PiB7XG5cdFx0XHRcdGl0ZW0uaXNEZWxldGluZyhmYWxzZSk7XG5cdFx0XHRcdGRpYWxvZyAmJiBhcHAudmlldy5kaWFsb2cocmVzcG9uc2UpO1xuXHRcdFx0XHRmYWlsICYmIGZhaWwocmVzcG9uc2UpO1xuXHRcdFx0fSxcblx0XHRcdGZyZWV6ZVxuXHRcdCk7XG5cdH1cblxuXHRhZGRJdGVtc1RvTGlzdChpdGVtczogVFtdIHwgeyBba2V5OiBzdHJpbmddOiBUIH0sIHJlbGF0aW9uczogYW55ID0ge30pIHtcblx0XHRsZXQgY3R4ID0gdGhpcztcblx0XHRsZXQgbGlzdDogVFtdID0gKFV0aWxzLmlzUGxhaW5PYmplY3QoaXRlbXMpXG5cdFx0XHQ/IE9iamVjdC52YWx1ZXMoaXRlbXMpXG5cdFx0XHQ6IGl0ZW1zIHx8IFtdKSBhcyBUW107XG5cblx0XHRsaXN0LmZvckVhY2goaXRlbSA9PiB7XG5cdFx0XHRsZXQgaXRlbUlkID0gZ2V0SWQoaXRlbSk7XG5cblx0XHRcdGN0eC5zYWZlbHlBZGRJdGVtKGl0ZW0pO1xuXG5cdFx0XHRpZiAoIWN0eC5yZWxhdGlvbnNbaXRlbUlkXSkge1xuXHRcdFx0XHRjdHgucmVsYXRpb25zID0gX3dpdGgoY3R4LnJlbGF0aW9ucywgaXRlbUlkLCB7fSk7XG5cdFx0XHR9XG5cblx0XHRcdGZvciAobGV0IHJlbCBpbiByZWxhdGlvbnMpIHtcblx0XHRcdFx0aWYgKHJlbGF0aW9ucy5oYXNPd25Qcm9wZXJ0eShyZWwpKSB7XG5cdFx0XHRcdFx0bGV0IGRhdGEgPSByZWxhdGlvbnNbcmVsXTtcblxuXHRcdFx0XHRcdGlmIChkYXRhW2l0ZW1JZF0pIHtcblx0XHRcdFx0XHRcdGN0eC5yZWxhdGlvbnNbaXRlbUlkXSA9IF93aXRoKFxuXHRcdFx0XHRcdFx0XHRjdHgucmVsYXRpb25zW2l0ZW1JZF0sXG5cdFx0XHRcdFx0XHRcdHJlbCxcblx0XHRcdFx0XHRcdFx0ZGF0YVtpdGVtSWRdXG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG5cblx0YWRkSXRlbVRvTGlzdChpdGVtOiBULCByZWxhdGlvbnM6IGFueSA9IHt9KSB7XG5cdFx0bGV0IGN0eCA9IHRoaXMsXG5cdFx0XHRpdGVtSWQgPSBnZXRJZChpdGVtKTtcblxuXHRcdGN0eC5zYWZlbHlBZGRJdGVtKGl0ZW0pO1xuXG5cdFx0aWYgKCFjdHgucmVsYXRpb25zW2l0ZW1JZF0pIHtcblx0XHRcdGN0eC5yZWxhdGlvbnMgPSBfd2l0aChjdHgucmVsYXRpb25zLCBpdGVtSWQsIHt9KTtcblx0XHR9XG5cblx0XHRmb3IgKGxldCByZWwgaW4gcmVsYXRpb25zKSB7XG5cdFx0XHRpZiAocmVsYXRpb25zLmhhc093blByb3BlcnR5KHJlbCkpIHtcblx0XHRcdFx0Y3R4LnJlbGF0aW9uc1tpdGVtSWRdID0gX3dpdGgoXG5cdFx0XHRcdFx0Y3R4LnJlbGF0aW9uc1tpdGVtSWRdLFxuXHRcdFx0XHRcdHJlbCxcblx0XHRcdFx0XHRyZWxhdGlvbnNbcmVsXVxuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgc2FmZWx5QWRkSXRlbShpdGVtOiBUKSB7XG5cdFx0bGV0IGtleSA9IGdldElkKGl0ZW0pLFxuXHRcdFx0Y2FjaGVkSXRlbSA9IHRoaXMuaXRlbXNba2V5XTtcblxuXHRcdGlmIChjYWNoZWRJdGVtKSB7XG5cdFx0XHRjYWNoZWRJdGVtLmRvSHlkcmF0ZShpdGVtLnRvT2JqZWN0KCksIHRydWUpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR0aGlzLml0ZW1zID0gX3dpdGgodGhpcy5pdGVtcywga2V5LCBpdGVtKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHNldFNhdmVkKHRhcmdldDogVCwgcmVzcG9uc2U6IGlTZXJ2aWNlVXBkYXRlUmVzcG9uc2U8VD4pIHtcblx0XHRsZXQgaXRlbSA9IHJlc3BvbnNlLmRhdGEuaXRlbTtcblxuXHRcdHRhcmdldC5kb0h5ZHJhdGUoaXRlbS50b09iamVjdCgpLCB0cnVlKTtcblxuXHRcdHRoaXMuc2FmZWx5QWRkSXRlbSh0YXJnZXQpO1xuXHR9XG5cblx0YWRkQ3JlYXRlZChyZXNwb25zZTogaVNlcnZpY2VBZGRSZXNwb25zZTxUPikge1xuXHRcdHRoaXMuc2FmZWx5QWRkSXRlbShyZXNwb25zZS5kYXRhLml0ZW0pO1xuXHR9XG5cblx0c2V0RGVsZXRlZChyZXNwb25zZTogaVNlcnZpY2VEZWxldGVSZXNwb25zZTxUPikge1xuXHRcdGxldCBpdGVtID0gcmVzcG9uc2UuZGF0YS5pdGVtO1xuXHRcdHRoaXMuaXRlbXMgPSBfd2l0aG91dCh0aGlzLml0ZW1zLCBnZXRJZChpdGVtKSk7XG5cdH1cblxuXHRpdGVtUmVsYXRpb248Wj4oaXRlbTogVCwgcmVsYXRpb246IHN0cmluZyk6IFogfCB1bmRlZmluZWQge1xuXHRcdGxldCBpZCA9IGdldElkKGl0ZW0pO1xuXHRcdHJldHVybiB0aGlzLnJlbGF0aW9uc1tpZF0gJiYgdGhpcy5yZWxhdGlvbnNbaWRdW3JlbGF0aW9uXTtcblx0fVxuXG5cdGlkZW50aWZ5KGlkOiBzdHJpbmcsIGNoZWNrQ2FjaGU6IGJvb2xlYW4gPSB0cnVlKTogVCB8IHVuZGVmaW5lZCB7XG5cdFx0bGV0IGl0ZW0gPSB0aGlzLml0ZW1zW2lkXSxcblx0XHRcdGM7XG5cblx0XHRpZiAoaXRlbSkgcmV0dXJuIGl0ZW07XG5cblx0XHRpZiAoY2hlY2tDYWNoZSkge1xuXHRcdFx0YyA9IDxhbnk+R29ibEVudGl0eS5zdWJDYWNoZSh0aGlzLmVudGl0eS5uYW1lKTtcblxuXHRcdFx0cmV0dXJuIGMgJiYgY1tpZF07XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHVuZGVmaW5lZDtcblx0fVxuXG5cdGxpc3QoaWRzOiBzdHJpbmdbXSA9IFtdKSB7XG5cdFx0bGV0IGxpc3Q6IFRbXSA9IFtdLFxuXHRcdFx0bGVuID0gaWRzLmxlbmd0aDtcblx0XHRpZiAobGVuKSB7XG5cdFx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7XG5cdFx0XHRcdGxldCBpZCA9IGlkc1tpXSxcblx0XHRcdFx0XHRpdGVtID0gdGhpcy5pZGVudGlmeShpZCk7XG5cdFx0XHRcdGlmIChpdGVtKSB7XG5cdFx0XHRcdFx0bGlzdC5wdXNoKGl0ZW0pO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fSBlbHNlIHtcblx0XHRcdGZvciAobGV0IGtleSBpbiB0aGlzLml0ZW1zKSB7XG5cdFx0XHRcdGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcy5pdGVtcywga2V5KSkge1xuXHRcdFx0XHRcdGxpc3QucHVzaCh0aGlzLml0ZW1zW2tleV0pO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGxpc3Q7XG5cdH1cblxuXHRvcmRlckJ5KG9yZGVyRm46IHRFbnRpdGllc09yZGVyQnlDYjxUPik6IFRbXSB7XG5cdFx0bGV0IGtleXMgPSBPYmplY3Qua2V5cyh0aGlzLml0ZW1zKTtcblxuXHRcdHJldHVybiBrZXlzLm1hcChrZXkgPT4gdGhpcy5pdGVtc1trZXldKS5zb3J0KG9yZGVyRm4pO1xuXHR9XG5cblx0b3JkZXJCeVZhbHVlT2YoY29sdW1uOiBzdHJpbmcpOiBUW10ge1xuXHRcdHJldHVybiB0aGlzLm9yZGVyQnkoKGE6IGFueSwgYjogYW55KSA9PiB7XG5cdFx0XHRyZXR1cm4gYVtjb2x1bW5dIC0gYltjb2x1bW5dO1xuXHRcdH0pO1xuXHR9XG5cblx0c2VsZWN0KFxuXHRcdGxpc3Q6IFRbXSA9IHRoaXMubGlzdCgpLFxuXHRcdHByZWRpY2F0ZTogKHZhbHVlOiBULCBpbmRleDogbnVtYmVyKSA9PiBib29sZWFuLFxuXHRcdG1heCA9IEluZmluaXR5XG5cdCk6IFRbXSB7XG5cdFx0bGV0IHJlc3VsdDogVFtdID0gW10sXG5cdFx0XHRsZW4gPSBsaXN0Lmxlbmd0aDtcblxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgbGVuICYmIHJlc3VsdC5sZW5ndGggPCBtYXg7IGkrKykge1xuXHRcdFx0aWYgKHByZWRpY2F0ZShsaXN0W2ldLCBpKSkge1xuXHRcdFx0XHRyZXN1bHQucHVzaChsaXN0W2ldKTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gcmVzdWx0O1xuXHR9XG5cblx0c2VhcmNoKFxuXHRcdGxpc3Q6IFRbXSA9IHRoaXMubGlzdCgpLFxuXHRcdHNlYXJjaDogc3RyaW5nLFxuXHRcdHN0cmluZ0J1aWxkZXI6ICh2YWx1ZTogVCwgaW5kZXg6IG51bWJlcikgPT4gc3RyaW5nXG5cdCk6IFRbXSB7XG5cdFx0aWYgKCEoc2VhcmNoID0gc2VhcmNoLnRyaW0oKSkubGVuZ3RoKSB7XG5cdFx0XHRyZXR1cm4gbGlzdDtcblx0XHR9XG5cblx0XHRsZXQgcmVnID0gbmV3IFJlZ0V4cChVdGlscy5lc2NhcGVSZWdFeHAoc2VhcmNoKSwgJ2knKTtcblxuXHRcdHJldHVybiBsaXN0LmZpbHRlcigoaXRlbTogYW55LCBpbmRleDogbnVtYmVyKSA9PiB7XG5cdFx0XHRsZXQgdiA9IHN0cmluZ0J1aWxkZXIoaXRlbSwgaW5kZXgpO1xuXHRcdFx0cmV0dXJuIHJlZy50ZXN0KHYpO1xuXHRcdH0pO1xuXHR9XG5cblx0dG90YWxDb3VudCgpOiBudW1iZXIge1xuXHRcdHJldHVybiBPYmplY3Qua2V5cyh0aGlzLml0ZW1zKS5sZW5ndGg7XG5cdH1cbn1cbiJdfQ==