import { getEntityCache, GoblEntity } from 'gobl-utils-ts';
import { escapeRegExp, isPlainObject } from './utils';
import OWebService from './OWebService';
const getId = (item) => item.singlePKValue();
const _with = (target, key, item) => {
    return { ...target, [key]: item };
};
const defaultServiceDataStore = function defaultServiceDataStore() {
    let items = {};
    const o = {
        add(item) {
            const id = getId(item);
            id in items ? o.update(item) : (items[id] = item);
            return o;
        },
        get(id) {
            return items[id];
        },
        update(item) {
            const id = getId(item);
            if (items[id]) {
                items[id].doHydrate(item.toObject(false), true);
            }
            return o;
        },
        remove(id) {
            delete items[id];
            return o;
        },
        all() {
            return Object.values(items);
        },
        filter(filterFn) {
            return Object.values(items).filter(filterFn);
        },
        relationServiceResolver() {
            return undefined;
        },
        clear() {
            items = {};
            return this;
        },
    };
    return o;
};
export default class OWebServiceStore extends OWebService {
    entity;
    store;
    relations = {};
    /**
     * OWebServiceStore constructor.
     *
     * @param _appContext
     * @param entity
     * @param service
     */
    constructor(_appContext, entity, service, store) {
        super(_appContext, service);
        this.entity = entity;
        this.store = store || defaultServiceDataStore();
    }
    /**
     * Creates request to get an item by id.
     *
     * @param id The item id.
     * @param relations The relations to retrieve.
     */
    getItem(id, relations = '') {
        const ctx = this;
        return super
            .getItem(id, relations)
            .onGoodNews(function goodNewsHandler(response) {
            ctx.addItemToList(response.json.data.item, response.json.data.relations);
        });
    }
    /**
     * Creates request to get items list.
     *
     * @param options
     */
    getItems(options = {}) {
        const ctx = this;
        return super
            .getItems(options)
            .onGoodNews(function goodNewsHandler(response) {
            ctx.addItemsToList(response.json.data.items, response.json.data.relations);
        });
    }
    /**
     * Creates request to add new item.
     *
     * @param data
     */
    addItem(data) {
        const ctx = this;
        return super.addItem(data).onGoodNews(function goodNewsHandler(response) {
            ctx.addCreated(response.json);
        });
    }
    /**
     * Creates update request for a given item.
     *
     * @param item
     */
    updateItem(item, formData = null) {
        const ctx = this;
        let id, target;
        if (item instanceof GoblEntity) {
            id = getId(item);
            target = item;
        }
        else {
            id = item;
            target = this.identify(id);
        }
        const diff = formData ? formData : target ? target.toObject(true) : {};
        target && target.isSaving(true);
        return super
            .updateItem(id, diff)
            .onGoodNews(function goodNewsHandler(response) {
            target && ctx.setSaved(target, response.json);
        })
            .onFinish(function finishHandler() {
            target && target.isSaving(false);
        });
    }
    /**
     * Creates a delete request for a given item.
     *
     * @param item
     */
    deleteItem(item) {
        const ctx = this;
        let id, target;
        if (item instanceof GoblEntity) {
            id = getId(item);
            target = item;
        }
        else {
            id = item;
            target = this.identify(id);
        }
        target && target.isDeleting(true);
        return super
            .deleteItem(id)
            .onGoodNews(function goodNewsHandler(response) {
            ctx.setDeleted(response.json);
        })
            .onFinish(function finishHandler() {
            target && target.isDeleting(false);
        });
    }
    /**
     * Adds a list of items to this store list.
     *
     * @param items
     * @param relations
     */
    addItemsToList(items, relations = {}) {
        const ctx = this, list = (isPlainObject(items) ? Object.values(items) : items || []);
        list.forEach((item) => {
            const itemId = getId(item);
            ctx.safelyAddItem(item);
            if (!ctx.relations[itemId]) {
                ctx.relations = _with(ctx.relations, itemId, {});
            }
            for (const rel in relations) {
                if (Object.prototype.hasOwnProperty.call(relations, rel)) {
                    const data = relations[rel];
                    if (data[itemId]) {
                        ctx.relations[itemId] = _with(ctx.relations[itemId], rel, data[itemId]);
                    }
                }
            }
        });
    }
    /**
     * Adds a given item and its relations to this store.
     *
     * @param item
     * @param relations
     */
    addItemToList(item, relations = {}) {
        const ctx = this, itemId = getId(item);
        ctx.safelyAddItem(item);
        if (!ctx.relations[itemId]) {
            ctx.relations = _with(ctx.relations, itemId, {});
        }
        for (const rel in relations) {
            if (Object.prototype.hasOwnProperty.call(relations, rel)) {
                ctx.relations[itemId] = _with(ctx.relations[itemId], rel, relations[rel]);
            }
        }
    }
    /**
     * Safely add item to this store.
     *
     * @param item
     * @private
     */
    safelyAddItem(item) {
        const id = getId(item), cachedItem = this.store.get(id);
        if (cachedItem) {
            item = cachedItem.doHydrate(item.toObject(), true);
        }
        return this.store.add(item);
    }
    /**
     * Modify successfully saved item state and data.
     *
     * @param target
     * @param response
     * @private
     */
    setSaved(target, response) {
        const item = response.data.item;
        target.doHydrate(item.toObject(), true);
        return this.store.add(target);
    }
    /**
     * Adds a newly created item to this store.
     *
     * @param response
     */
    addCreated(response) {
        return this.safelyAddItem(response.data.item);
    }
    /**
     * Removes a given item from this store when deleted.
     *
     * @param response
     */
    setDeleted(response) {
        return this.store.remove(getId(response.data.item));
    }
    /**
     * Identify a given item in this store by its id.
     *
     * @param id
     * @param checkCacheForMissing
     */
    identify(id, checkCacheForMissing = true) {
        const item = this.store.get(id);
        if (item)
            return item;
        if (checkCacheForMissing) {
            const cache = getEntityCache(this.entity.name);
            return cache && cache[id];
        }
        return undefined;
    }
    /**
     * Gets this store items list.
     */
    list(ids = [], checkCacheForMissing = true) {
        const len = ids.length;
        if (!len) {
            return this.store.all();
        }
        const list = [];
        for (let i = 0; i < len; i++) {
            const id = ids[i], item = this.identify(id, checkCacheForMissing);
            if (item) {
                list.push(item);
            }
        }
        return list;
    }
    /**
     * Filter items in this store or in a given list.
     *
     * @param list
     * @param predicate
     * @param max
     */
    filter(list = this.list(), predicate, max = Infinity) {
        const result = [], len = list.length;
        for (let i = 0; i < len && result.length < max; i++) {
            if (predicate(list[i])) {
                result.push(list[i]);
            }
        }
        return result;
    }
    /**
     * Select some items in this store.
     *
     * @alias filter
     *
     * @param list
     * @param predicate
     * @param max
     */
    select(list = this.list(), predicate, max = Infinity) {
        return this.filter(list, predicate, max);
    }
    /**
     * Search items in this store or in a given items list.
     *
     * @param list
     * @param search
     * @param stringBuilder
     */
    search(list = this.list(), search, stringBuilder) {
        if (!(search = search.trim()).length) {
            return list;
        }
        const reg = new RegExp(escapeRegExp(search), 'i');
        return list.filter((item) => {
            const v = stringBuilder(item);
            return reg.test(v);
        });
    }
    /**
     * Gets a given item relations.
     *
     * @param item
     * @param relation
     */
    itemRelation(item, relation) {
        const id = getId(item);
        return this.relations[id] && this.relations[id][relation];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlNlcnZpY2VTdG9yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViU2VydmljZVN0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQUUsVUFBVSxFQUFzQixNQUFNLGVBQWUsQ0FBQztBQVUvRSxPQUFPLEVBQUUsWUFBWSxFQUFFLGFBQWEsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUN0RCxPQUFPLFdBQVcsTUFBTSxlQUFlLENBQUM7QUFLeEMsTUFBTSxLQUFLLEdBQUcsQ0FBQyxJQUF3QixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7QUFFakUsTUFBTSxLQUFLLEdBQUcsQ0FBQyxNQUFXLEVBQUUsR0FBb0IsRUFBRSxJQUFTLEVBQUUsRUFBRTtJQUM5RCxPQUFPLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQztBQUNuQyxDQUFDLENBQUM7QUFlRixNQUFNLHVCQUF1QixHQUFHLFNBQVMsdUJBQXVCO0lBRy9ELElBQUksS0FBSyxHQUF5QixFQUFFLENBQUM7SUFDckMsTUFBTSxDQUFDLEdBQXlCO1FBQy9CLEdBQUcsQ0FBQyxJQUFPO1lBQ1YsTUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3ZCLEVBQUUsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO1lBQ2xELE9BQU8sQ0FBQyxDQUFDO1FBQ1YsQ0FBQztRQUNELEdBQUcsQ0FBQyxFQUFVO1lBQ2IsT0FBTyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbEIsQ0FBQztRQUNELE1BQU0sQ0FBQyxJQUFPO1lBQ2IsTUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLElB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RUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDM0QsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2V0RW50aXR5Q2FjaGUsIEdvYmxFbnRpdHksIEdvYmxTaW5nbGVQS0VudGl0eSB9IGZyb20gJ2dvYmwtdXRpbHMtdHMnO1xuaW1wb3J0IHtcblx0T0FwaUFkZFJlc3BvbnNlLFxuXHRPQXBpRGVsZXRlUmVzcG9uc2UsXG5cdE9BcGlVcGRhdGVSZXNwb25zZSxcblx0T0FwaVNlcnZpY2VSZXF1ZXN0T3B0aW9ucyxcblx0T0FwaUdldEFsbFJlc3BvbnNlLFxuXHRPQXBpR2V0UmVzcG9uc2UsXG59IGZyb20gJy4vb3pvbmUnO1xuaW1wb3J0IE9XZWJBcHAgZnJvbSAnLi9PV2ViQXBwJztcbmltcG9ydCB7IGVzY2FwZVJlZ0V4cCwgaXNQbGFpbk9iamVjdCB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IE9XZWJTZXJ2aWNlIGZyb20gJy4vT1dlYlNlcnZpY2UnO1xuaW1wb3J0IE9XZWJYSFIgZnJvbSAnLi9PV2ViWEhSJztcbmltcG9ydCB7IE9XZWJGb3JtRGF0YSB9IGZyb20gJy4vT1dlYkZvcm0nO1xuaW1wb3J0IHsgT05ldFJlcXVlc3RCb2R5IH0gZnJvbSAnLi9PV2ViTmV0JztcblxuY29uc3QgZ2V0SWQgPSAoaXRlbTogR29ibFNpbmdsZVBLRW50aXR5KSA9PiBpdGVtLnNpbmdsZVBLVmFsdWUoKTtcblxuY29uc3QgX3dpdGggPSAodGFyZ2V0OiBhbnksIGtleTogc3RyaW5nIHwgbnVtYmVyLCBpdGVtOiBhbnkpID0+IHtcblx0cmV0dXJuIHsgLi4udGFyZ2V0LCBba2V5XTogaXRlbSB9O1xufTtcblxuaW50ZXJmYWNlIE9TZXJ2aWNlRGF0YVN0b3JlPFQgZXh0ZW5kcyBHb2JsU2luZ2xlUEtFbnRpdHk+IHtcblx0YWRkKGl0ZW06IFQpOiB0aGlzO1xuXHRnZXQoaWQ6IHN0cmluZyk6IFQgfCB1bmRlZmluZWQ7XG5cdHVwZGF0ZShpdGVtOiBUKTogdGhpcztcblx0cmVtb3ZlKGlkOiBzdHJpbmcpOiB0aGlzO1xuXHRhbGwoKTogVFtdO1xuXHRjbGVhcigpOiB0aGlzO1xuXHRmaWx0ZXIoZmlsdGVyRm46IChlbnRyeTogVCkgPT4gYm9vbGVhbik6IFRbXTtcblx0cmVsYXRpb25TZXJ2aWNlUmVzb2x2ZXI8UiBleHRlbmRzIEdvYmxTaW5nbGVQS0VudGl0eT4oXG5cdFx0cmVsYXRpb246IHN0cmluZ1xuXHQpOiB1bmRlZmluZWQgfCBPV2ViU2VydmljZVN0b3JlPFI+O1xufVxuXG5jb25zdCBkZWZhdWx0U2VydmljZURhdGFTdG9yZSA9IGZ1bmN0aW9uIGRlZmF1bHRTZXJ2aWNlRGF0YVN0b3JlPFxuXHRUIGV4dGVuZHMgR29ibFNpbmdsZVBLRW50aXR5XG4+KCk6IE9TZXJ2aWNlRGF0YVN0b3JlPFQ+IHtcblx0bGV0IGl0ZW1zOiB7IFtrZXk6IHN0cmluZ106IFQgfSA9IHt9O1xuXHRjb25zdCBvOiBPU2VydmljZURhdGFTdG9yZTxUPiA9IHtcblx0XHRhZGQoaXRlbTogVCkge1xuXHRcdFx0Y29uc3QgaWQgPSBnZXRJZChpdGVtKTtcblx0XHRcdGlkIGluIGl0ZW1zID8gby51cGRhdGUoaXRlbSkgOiAoaXRlbXNbaWRdID0gaXRlbSk7XG5cdFx0XHRyZXR1cm4gbztcblx0XHR9LFxuXHRcdGdldChpZDogc3RyaW5nKTogVCB8IHVuZGVmaW5lZCB7XG5cdFx0XHRyZXR1cm4gaXRlbXNbaWRdO1xuXHRcdH0sXG5cdFx0dXBkYXRlKGl0ZW06IFQpIHtcblx0XHRcdGNvbnN0IGlkID0gZ2V0SWQoaXRlbSk7XG5cdFx0XHRpZiAoaXRlbXNbaWRdKSB7XG5cdFx0XHRcdGl0ZW1zW2lkXS5kb0h5ZHJhdGUoaXRlbS50b09iamVjdChmYWxzZSksIHRydWUpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gbztcblx0XHR9LFxuXHRcdHJlbW92ZShpZDogc3RyaW5nKSB7XG5cdFx0XHRkZWxldGUgaXRlbXNbaWRdO1xuXHRcdFx0cmV0dXJuIG87XG5cdFx0fSxcblx0XHRhbGwoKTogVFtdIHtcblx0XHRcdHJldHVybiBPYmplY3QudmFsdWVzKGl0ZW1zKTtcblx0XHR9LFxuXHRcdGZpbHRlcihmaWx0ZXJGbjogKGVudHJ5OiBUKSA9PiBib29sZWFuKTogVFtdIHtcblx0XHRcdHJldHVybiBPYmplY3QudmFsdWVzKGl0ZW1zKS5maWx0ZXIoZmlsdGVyRm4pO1xuXHRcdH0sXG5cdFx0cmVsYXRpb25TZXJ2aWNlUmVzb2x2ZXI8UiBleHRlbmRzIEdvYmxTaW5nbGVQS0VudGl0eT4oKTpcblx0XHRcdHwgdW5kZWZpbmVkXG5cdFx0XHR8IE9XZWJTZXJ2aWNlU3RvcmU8Uj4ge1xuXHRcdFx0cmV0dXJuIHVuZGVmaW5lZDtcblx0XHR9LFxuXHRcdGNsZWFyKCkge1xuXHRcdFx0aXRlbXMgPSB7fTtcblx0XHRcdHJldHVybiB0aGlzO1xuXHRcdH0sXG5cdH07XG5cblx0cmV0dXJuIG87XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViU2VydmljZVN0b3JlPFxuXHRUIGV4dGVuZHMgR29ibFNpbmdsZVBLRW50aXR5XG4+IGV4dGVuZHMgT1dlYlNlcnZpY2U8VD4ge1xuXHRwcm90ZWN0ZWQgc3RvcmU6IE9TZXJ2aWNlRGF0YVN0b3JlPFQ+O1xuXHRwcm90ZWN0ZWQgcmVsYXRpb25zOiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge307XG5cblx0LyoqXG5cdCAqIE9XZWJTZXJ2aWNlU3RvcmUgY29uc3RydWN0b3IuXG5cdCAqXG5cdCAqIEBwYXJhbSBfYXBwQ29udGV4dFxuXHQgKiBAcGFyYW0gZW50aXR5XG5cdCAqIEBwYXJhbSBzZXJ2aWNlXG5cdCAqL1xuXHRjb25zdHJ1Y3Rvcihcblx0XHRfYXBwQ29udGV4dDogT1dlYkFwcCxcblx0XHRwcml2YXRlIHJlYWRvbmx5IGVudGl0eTogdHlwZW9mIEdvYmxTaW5nbGVQS0VudGl0eSxcblx0XHRzZXJ2aWNlOiBzdHJpbmcsXG5cdFx0c3RvcmU/OiBPU2VydmljZURhdGFTdG9yZTxUPlxuXHQpIHtcblx0XHRzdXBlcihfYXBwQ29udGV4dCwgc2VydmljZSk7XG5cblx0XHR0aGlzLnN0b3JlID0gc3RvcmUgfHwgZGVmYXVsdFNlcnZpY2VEYXRhU3RvcmU8VD4oKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBDcmVhdGVzIHJlcXVlc3QgdG8gZ2V0IGFuIGl0ZW0gYnkgaWQuXG5cdCAqXG5cdCAqIEBwYXJhbSBpZCBUaGUgaXRlbSBpZC5cblx0ICogQHBhcmFtIHJlbGF0aW9ucyBUaGUgcmVsYXRpb25zIHRvIHJldHJpZXZlLlxuXHQgKi9cblx0Z2V0SXRlbShpZDogc3RyaW5nLCByZWxhdGlvbnMgPSAnJyk6IE9XZWJYSFI8T0FwaUdldFJlc3BvbnNlPFQ+PiB7XG5cdFx0Y29uc3QgY3R4ID0gdGhpcztcblxuXHRcdHJldHVybiBzdXBlclxuXHRcdFx0LmdldEl0ZW0oaWQsIHJlbGF0aW9ucylcblx0XHRcdC5vbkdvb2ROZXdzKGZ1bmN0aW9uIGdvb2ROZXdzSGFuZGxlcihyZXNwb25zZSkge1xuXHRcdFx0XHRjdHguYWRkSXRlbVRvTGlzdChcblx0XHRcdFx0XHRyZXNwb25zZS5qc29uLmRhdGEuaXRlbSxcblx0XHRcdFx0XHRyZXNwb25zZS5qc29uLmRhdGEucmVsYXRpb25zXG5cdFx0XHRcdCk7XG5cdFx0XHR9KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBDcmVhdGVzIHJlcXVlc3QgdG8gZ2V0IGl0ZW1zIGxpc3QuXG5cdCAqXG5cdCAqIEBwYXJhbSBvcHRpb25zXG5cdCAqL1xuXHRnZXRJdGVtcyhcblx0XHRvcHRpb25zOiBPQXBpU2VydmljZVJlcXVlc3RPcHRpb25zID0ge31cblx0KTogT1dlYlhIUjxPQXBpR2V0QWxsUmVzcG9uc2U8VD4+IHtcblx0XHRjb25zdCBjdHggPSB0aGlzO1xuXG5cdFx0cmV0dXJuIHN1cGVyXG5cdFx0XHQuZ2V0SXRlbXMob3B0aW9ucylcblx0XHRcdC5vbkdvb2ROZXdzKGZ1bmN0aW9uIGdvb2ROZXdzSGFuZGxlcihyZXNwb25zZSkge1xuXHRcdFx0XHRjdHguYWRkSXRlbXNUb0xpc3QoXG5cdFx0XHRcdFx0cmVzcG9uc2UuanNvbi5kYXRhLml0ZW1zLFxuXHRcdFx0XHRcdHJlc3BvbnNlLmpzb24uZGF0YS5yZWxhdGlvbnNcblx0XHRcdFx0KTtcblx0XHRcdH0pO1xuXHR9XG5cblx0LyoqXG5cdCAqIENyZWF0ZXMgcmVxdWVzdCB0byBhZGQgbmV3IGl0ZW0uXG5cdCAqXG5cdCAqIEBwYXJhbSBkYXRhXG5cdCAqL1xuXHRhZGRJdGVtKGRhdGE6IE9XZWJGb3JtRGF0YSk6IE9XZWJYSFI8T0FwaUFkZFJlc3BvbnNlPFQ+PiB7XG5cdFx0Y29uc3QgY3R4ID0gdGhpcztcblx0XHRyZXR1cm4gc3VwZXIuYWRkSXRlbShkYXRhKS5vbkdvb2ROZXdzKGZ1bmN0aW9uIGdvb2ROZXdzSGFuZGxlcihyZXNwb25zZSkge1xuXHRcdFx0Y3R4LmFkZENyZWF0ZWQocmVzcG9uc2UuanNvbik7XG5cdFx0fSk7XG5cdH1cblxuXHQvKipcblx0ICogQ3JlYXRlcyB1cGRhdGUgcmVxdWVzdCBmb3IgYSBnaXZlbiBpdGVtLlxuXHQgKlxuXHQgKiBAcGFyYW0gaXRlbVxuXHQgKi9cblx0dXBkYXRlSXRlbShcblx0XHRpdGVtOiBUIHwgc3RyaW5nLFxuXHRcdGZvcm1EYXRhOiBPTmV0UmVxdWVzdEJvZHkgfCBudWxsID0gbnVsbFxuXHQpOiBPV2ViWEhSPE9BcGlVcGRhdGVSZXNwb25zZTxUPj4ge1xuXHRcdGNvbnN0IGN0eCA9IHRoaXM7XG5cdFx0bGV0IGlkLCB0YXJnZXQ6IFQgfCB1bmRlZmluZWQ7XG5cblx0XHRpZiAoaXRlbSBpbnN0YW5jZW9mIEdvYmxFbnRpdHkpIHtcblx0XHRcdGlkID0gZ2V0SWQoaXRlbSk7XG5cdFx0XHR0YXJnZXQgPSBpdGVtO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRpZCA9IGl0ZW07XG5cdFx0XHR0YXJnZXQgPSB0aGlzLmlkZW50aWZ5KGlkKTtcblx0XHR9XG5cblx0XHRjb25zdCBkaWZmID0gZm9ybURhdGEgPyBmb3JtRGF0YSA6IHRhcmdldCA/IHRhcmdldC50b09iamVjdCh0cnVlKSA6IHt9O1xuXG5cdFx0dGFyZ2V0ICYmIHRhcmdldC5pc1NhdmluZyh0cnVlKTtcblxuXHRcdHJldHVybiBzdXBlclxuXHRcdFx0LnVwZGF0ZUl0ZW0oaWQsIGRpZmYpXG5cdFx0XHQub25Hb29kTmV3cyhmdW5jdGlvbiBnb29kTmV3c0hhbmRsZXIocmVzcG9uc2UpIHtcblx0XHRcdFx0dGFyZ2V0ICYmIGN0eC5zZXRTYXZlZCh0YXJnZXQsIHJlc3BvbnNlLmpzb24pO1xuXHRcdFx0fSlcblx0XHRcdC5vbkZpbmlzaChmdW5jdGlvbiBmaW5pc2hIYW5kbGVyKCkge1xuXHRcdFx0XHR0YXJnZXQgJiYgdGFyZ2V0LmlzU2F2aW5nKGZhbHNlKTtcblx0XHRcdH0pO1xuXHR9XG5cblx0LyoqXG5cdCAqIENyZWF0ZXMgYSBkZWxldGUgcmVxdWVzdCBmb3IgYSBnaXZlbiBpdGVtLlxuXHQgKlxuXHQgKiBAcGFyYW0gaXRlbVxuXHQgKi9cblx0ZGVsZXRlSXRlbShpdGVtOiBUIHwgc3RyaW5nKTogT1dlYlhIUjxPQXBpRGVsZXRlUmVzcG9uc2U8VD4+IHtcblx0XHRjb25zdCBjdHggPSB0aGlzO1xuXHRcdGxldCBpZCwgdGFyZ2V0OiBUIHwgdW5kZWZpbmVkO1xuXG5cdFx0aWYgKGl0ZW0gaW5zdGFuY2VvZiBHb2JsRW50aXR5KSB7XG5cdFx0XHRpZCA9IGdldElkKGl0ZW0pO1xuXHRcdFx0dGFyZ2V0ID0gaXRlbTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0aWQgPSBpdGVtO1xuXHRcdFx0dGFyZ2V0ID0gdGhpcy5pZGVudGlmeShpZCk7XG5cdFx0fVxuXG5cdFx0dGFyZ2V0ICYmIHRhcmdldC5pc0RlbGV0aW5nKHRydWUpO1xuXG5cdFx0cmV0dXJuIHN1cGVyXG5cdFx0XHQuZGVsZXRlSXRlbShpZClcblx0XHRcdC5vbkdvb2ROZXdzKGZ1bmN0aW9uIGdvb2ROZXdzSGFuZGxlcihyZXNwb25zZSkge1xuXHRcdFx0XHRjdHguc2V0RGVsZXRlZChyZXNwb25zZS5qc29uKTtcblx0XHRcdH0pXG5cdFx0XHQub25GaW5pc2goZnVuY3Rpb24gZmluaXNoSGFuZGxlcigpIHtcblx0XHRcdFx0dGFyZ2V0ICYmIHRhcmdldC5pc0RlbGV0aW5nKGZhbHNlKTtcblx0XHRcdH0pO1xuXHR9XG5cblx0LyoqXG5cdCAqIEFkZHMgYSBsaXN0IG9mIGl0ZW1zIHRvIHRoaXMgc3RvcmUgbGlzdC5cblx0ICpcblx0ICogQHBhcmFtIGl0ZW1zXG5cdCAqIEBwYXJhbSByZWxhdGlvbnNcblx0ICovXG5cdGFkZEl0ZW1zVG9MaXN0KGl0ZW1zOiBUW10gfCBSZWNvcmQ8c3RyaW5nLCBUPiwgcmVsYXRpb25zOiBhbnkgPSB7fSk6IHZvaWQge1xuXHRcdGNvbnN0IGN0eCA9IHRoaXMsXG5cdFx0XHRsaXN0OiBUW10gPSAoXG5cdFx0XHRcdGlzUGxhaW5PYmplY3QoaXRlbXMpID8gT2JqZWN0LnZhbHVlcyhpdGVtcykgOiBpdGVtcyB8fCBbXVxuXHRcdFx0KSBhcyBUW107XG5cblx0XHRsaXN0LmZvckVhY2goKGl0ZW0pID0+IHtcblx0XHRcdGNvbnN0IGl0ZW1JZCA9IGdldElkKGl0ZW0pO1xuXG5cdFx0XHRjdHguc2FmZWx5QWRkSXRlbShpdGVtKTtcblxuXHRcdFx0aWYgKCFjdHgucmVsYXRpb25zW2l0ZW1JZF0pIHtcblx0XHRcdFx0Y3R4LnJlbGF0aW9ucyA9IF93aXRoKGN0eC5yZWxhdGlvbnMsIGl0ZW1JZCwge30pO1xuXHRcdFx0fVxuXG5cdFx0XHRmb3IgKGNvbnN0IHJlbCBpbiByZWxhdGlvbnMpIHtcblx0XHRcdFx0aWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChyZWxhdGlvbnMsIHJlbCkpIHtcblx0XHRcdFx0XHRjb25zdCBkYXRhID0gcmVsYXRpb25zW3JlbF07XG5cblx0XHRcdFx0XHRpZiAoZGF0YVtpdGVtSWRdKSB7XG5cdFx0XHRcdFx0XHRjdHgucmVsYXRpb25zW2l0ZW1JZF0gPSBfd2l0aChcblx0XHRcdFx0XHRcdFx0Y3R4LnJlbGF0aW9uc1tpdGVtSWRdLFxuXHRcdFx0XHRcdFx0XHRyZWwsXG5cdFx0XHRcdFx0XHRcdGRhdGFbaXRlbUlkXVxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBBZGRzIGEgZ2l2ZW4gaXRlbSBhbmQgaXRzIHJlbGF0aW9ucyB0byB0aGlzIHN0b3JlLlxuXHQgKlxuXHQgKiBAcGFyYW0gaXRlbVxuXHQgKiBAcGFyYW0gcmVsYXRpb25zXG5cdCAqL1xuXHRhZGRJdGVtVG9MaXN0KGl0ZW06IFQsIHJlbGF0aW9uczogYW55ID0ge30pOiB2b2lkIHtcblx0XHRjb25zdCBjdHggPSB0aGlzLFxuXHRcdFx0aXRlbUlkID0gZ2V0SWQoaXRlbSk7XG5cblx0XHRjdHguc2FmZWx5QWRkSXRlbShpdGVtKTtcblxuXHRcdGlmICghY3R4LnJlbGF0aW9uc1tpdGVtSWRdKSB7XG5cdFx0XHRjdHgucmVsYXRpb25zID0gX3dpdGgoY3R4LnJlbGF0aW9ucywgaXRlbUlkLCB7fSk7XG5cdFx0fVxuXG5cdFx0Zm9yIChjb25zdCByZWwgaW4gcmVsYXRpb25zKSB7XG5cdFx0XHRpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHJlbGF0aW9ucywgcmVsKSkge1xuXHRcdFx0XHRjdHgucmVsYXRpb25zW2l0ZW1JZF0gPSBfd2l0aChcblx0XHRcdFx0XHRjdHgucmVsYXRpb25zW2l0ZW1JZF0sXG5cdFx0XHRcdFx0cmVsLFxuXHRcdFx0XHRcdHJlbGF0aW9uc1tyZWxdXG5cdFx0XHRcdCk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG5cblx0LyoqXG5cdCAqIFNhZmVseSBhZGQgaXRlbSB0byB0aGlzIHN0b3JlLlxuXHQgKlxuXHQgKiBAcGFyYW0gaXRlbVxuXHQgKiBAcHJpdmF0ZVxuXHQgKi9cblx0cHJpdmF0ZSBzYWZlbHlBZGRJdGVtKGl0ZW06IFQpIHtcblx0XHRjb25zdCBpZCA9IGdldElkKGl0ZW0pLFxuXHRcdFx0Y2FjaGVkSXRlbSA9IHRoaXMuc3RvcmUuZ2V0KGlkKTtcblxuXHRcdGlmIChjYWNoZWRJdGVtKSB7XG5cdFx0XHRpdGVtID0gY2FjaGVkSXRlbS5kb0h5ZHJhdGUoaXRlbS50b09iamVjdCgpLCB0cnVlKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5zdG9yZS5hZGQoaXRlbSk7XG5cdH1cblxuXHQvKipcblx0ICogTW9kaWZ5IHN1Y2Nlc3NmdWxseSBzYXZlZCBpdGVtIHN0YXRlIGFuZCBkYXRhLlxuXHQgKlxuXHQgKiBAcGFyYW0gdGFyZ2V0XG5cdCAqIEBwYXJhbSByZXNwb25zZVxuXHQgKiBAcHJpdmF0ZVxuXHQgKi9cblx0cHJpdmF0ZSBzZXRTYXZlZCh0YXJnZXQ6IFQsIHJlc3BvbnNlOiBPQXBpVXBkYXRlUmVzcG9uc2U8VD4pIHtcblx0XHRjb25zdCBpdGVtID0gcmVzcG9uc2UuZGF0YS5pdGVtO1xuXG5cdFx0dGFyZ2V0LmRvSHlkcmF0ZShpdGVtLnRvT2JqZWN0KCksIHRydWUpO1xuXG5cdFx0cmV0dXJuIHRoaXMuc3RvcmUuYWRkKHRhcmdldCk7XG5cdH1cblxuXHQvKipcblx0ICogQWRkcyBhIG5ld2x5IGNyZWF0ZWQgaXRlbSB0byB0aGlzIHN0b3JlLlxuXHQgKlxuXHQgKiBAcGFyYW0gcmVzcG9uc2Vcblx0ICovXG5cdHByaXZhdGUgYWRkQ3JlYXRlZChyZXNwb25zZTogT0FwaUFkZFJlc3BvbnNlPFQ+KSB7XG5cdFx0cmV0dXJuIHRoaXMuc2FmZWx5QWRkSXRlbShyZXNwb25zZS5kYXRhLml0ZW0pO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJlbW92ZXMgYSBnaXZlbiBpdGVtIGZyb20gdGhpcyBzdG9yZSB3aGVuIGRlbGV0ZWQuXG5cdCAqXG5cdCAqIEBwYXJhbSByZXNwb25zZVxuXHQgKi9cblx0cHJpdmF0ZSBzZXREZWxldGVkKHJlc3BvbnNlOiBPQXBpRGVsZXRlUmVzcG9uc2U8VD4pIHtcblx0XHRyZXR1cm4gdGhpcy5zdG9yZS5yZW1vdmUoZ2V0SWQocmVzcG9uc2UuZGF0YS5pdGVtKSk7XG5cdH1cblxuXHQvKipcblx0ICogSWRlbnRpZnkgYSBnaXZlbiBpdGVtIGluIHRoaXMgc3RvcmUgYnkgaXRzIGlkLlxuXHQgKlxuXHQgKiBAcGFyYW0gaWRcblx0ICogQHBhcmFtIGNoZWNrQ2FjaGVGb3JNaXNzaW5nXG5cdCAqL1xuXHRpZGVudGlmeShpZDogc3RyaW5nLCBjaGVja0NhY2hlRm9yTWlzc2luZyA9IHRydWUpOiBUIHwgdW5kZWZpbmVkIHtcblx0XHRjb25zdCBpdGVtID0gdGhpcy5zdG9yZS5nZXQoaWQpO1xuXG5cdFx0aWYgKGl0ZW0pIHJldHVybiBpdGVtO1xuXG5cdFx0aWYgKGNoZWNrQ2FjaGVGb3JNaXNzaW5nKSB7XG5cdFx0XHRjb25zdCBjYWNoZSA9IGdldEVudGl0eUNhY2hlKHRoaXMuZW50aXR5Lm5hbWUpIGFzIGFueTtcblx0XHRcdHJldHVybiBjYWNoZSAmJiBjYWNoZVtpZF07XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHVuZGVmaW5lZDtcblx0fVxuXG5cdC8qKlxuXHQgKiBHZXRzIHRoaXMgc3RvcmUgaXRlbXMgbGlzdC5cblx0ICovXG5cdGxpc3QoaWRzOiBzdHJpbmdbXSA9IFtdLCBjaGVja0NhY2hlRm9yTWlzc2luZyA9IHRydWUpOiBUW10ge1xuXHRcdGNvbnN0IGxlbiA9IGlkcy5sZW5ndGg7XG5cblx0XHRpZiAoIWxlbikge1xuXHRcdFx0cmV0dXJuIHRoaXMuc3RvcmUuYWxsKCk7XG5cdFx0fVxuXG5cdFx0Y29uc3QgbGlzdDogVFtdID0gW107XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7XG5cdFx0XHRjb25zdCBpZCA9IGlkc1tpXSxcblx0XHRcdFx0aXRlbSA9IHRoaXMuaWRlbnRpZnkoaWQsIGNoZWNrQ2FjaGVGb3JNaXNzaW5nKTtcblx0XHRcdGlmIChpdGVtKSB7XG5cdFx0XHRcdGxpc3QucHVzaChpdGVtKTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gbGlzdDtcblx0fVxuXG5cdC8qKlxuXHQgKiBGaWx0ZXIgaXRlbXMgaW4gdGhpcyBzdG9yZSBvciBpbiBhIGdpdmVuIGxpc3QuXG5cdCAqXG5cdCAqIEBwYXJhbSBsaXN0XG5cdCAqIEBwYXJhbSBwcmVkaWNhdGVcblx0ICogQHBhcmFtIG1heFxuXHQgKi9cblx0ZmlsdGVyKFxuXHRcdGxpc3Q6IFRbXSA9IHRoaXMubGlzdCgpLFxuXHRcdHByZWRpY2F0ZTogKHZhbHVlOiBUKSA9PiBib29sZWFuLFxuXHRcdG1heCA9IEluZmluaXR5XG5cdCk6IFRbXSB7XG5cdFx0Y29uc3QgcmVzdWx0OiBUW10gPSBbXSxcblx0XHRcdGxlbiA9IGxpc3QubGVuZ3RoO1xuXG5cdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBsZW4gJiYgcmVzdWx0Lmxlbmd0aCA8IG1heDsgaSsrKSB7XG5cdFx0XHRpZiAocHJlZGljYXRlKGxpc3RbaV0pKSB7XG5cdFx0XHRcdHJlc3VsdC5wdXNoKGxpc3RbaV0pO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiByZXN1bHQ7XG5cdH1cblxuXHQvKipcblx0ICogU2VsZWN0IHNvbWUgaXRlbXMgaW4gdGhpcyBzdG9yZS5cblx0ICpcblx0ICogQGFsaWFzIGZpbHRlclxuXHQgKlxuXHQgKiBAcGFyYW0gbGlzdFxuXHQgKiBAcGFyYW0gcHJlZGljYXRlXG5cdCAqIEBwYXJhbSBtYXhcblx0ICovXG5cdHNlbGVjdChcblx0XHRsaXN0OiBUW10gPSB0aGlzLmxpc3QoKSxcblx0XHRwcmVkaWNhdGU6ICh2YWx1ZTogVCkgPT4gYm9vbGVhbixcblx0XHRtYXggPSBJbmZpbml0eVxuXHQpOiBUW10ge1xuXHRcdHJldHVybiB0aGlzLmZpbHRlcihsaXN0LCBwcmVkaWNhdGUsIG1heCk7XG5cdH1cblxuXHQvKipcblx0ICogU2VhcmNoIGl0ZW1zIGluIHRoaXMgc3RvcmUgb3IgaW4gYSBnaXZlbiBpdGVtcyBsaXN0LlxuXHQgKlxuXHQgKiBAcGFyYW0gbGlzdFxuXHQgKiBAcGFyYW0gc2VhcmNoXG5cdCAqIEBwYXJhbSBzdHJpbmdCdWlsZGVyXG5cdCAqL1xuXHRzZWFyY2goXG5cdFx0bGlzdDogVFtdID0gdGhpcy5saXN0KCksXG5cdFx0c2VhcmNoOiBzdHJpbmcsXG5cdFx0c3RyaW5nQnVpbGRlcjogKHZhbHVlOiBUKSA9PiBzdHJpbmdcblx0KTogVFtdIHtcblx0XHRpZiAoIShzZWFyY2ggPSBzZWFyY2gudHJpbSgpKS5sZW5ndGgpIHtcblx0XHRcdHJldHVybiBsaXN0O1xuXHRcdH1cblxuXHRcdGNvbnN0IHJlZyA9IG5ldyBSZWdFeHAoZXNjYXBlUmVnRXhwKHNlYXJjaCksICdpJyk7XG5cblx0XHRyZXR1cm4gbGlzdC5maWx0ZXIoKGl0ZW06IGFueSkgPT4ge1xuXHRcdFx0Y29uc3QgdiA9IHN0cmluZ0J1aWxkZXIoaXRlbSk7XG5cdFx0XHRyZXR1cm4gcmVnLnRlc3Qodik7XG5cdFx0fSk7XG5cdH1cblx0LyoqXG5cdCAqIEdldHMgYSBnaXZlbiBpdGVtIHJlbGF0aW9ucy5cblx0ICpcblx0ICogQHBhcmFtIGl0ZW1cblx0ICogQHBhcmFtIHJlbGF0aW9uXG5cdCAqL1xuXHRpdGVtUmVsYXRpb248Wj4oaXRlbTogVCwgcmVsYXRpb246IHN0cmluZyk6IFogfCB1bmRlZmluZWQge1xuXHRcdGNvbnN0IGlkID0gZ2V0SWQoaXRlbSk7XG5cdFx0cmV0dXJuIHRoaXMucmVsYXRpb25zW2lkXSAmJiB0aGlzLnJlbGF0aW9uc1tpZF1bcmVsYXRpb25dO1xuXHR9XG59XG4iXX0=