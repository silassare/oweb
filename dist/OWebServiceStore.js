import { GoblEntity } from 'gobl-utils-ts';
import OWebService from './OWebService';
import Utils from './utils/Utils';
const getId = (item) => item.singlePKValue();
const _with = (target, key, item) => {
    return { ...target, [key]: item };
}, _without = (target, key) => {
    delete target[key];
    return { ...target };
};
export default class OWebServiceStore extends OWebService {
    constructor(app_context, entity, service_name, persistent_cache = false) {
        super(app_context, service_name, persistent_cache);
        this.entity = entity;
        this.items = {};
        this.relations = {};
    }
    getItem(id, relations = '', then, fail, freeze = true, load_cache_first = false, dialog = true) {
        let ctx = this, app = this.app_context;
        return ctx.getRequest(id, relations, (response, fromCache) => {
            ctx.addItemToList(response.data.item, response.data.relations);
            then && then(response, fromCache);
        }, response => {
            dialog && app.view.dialog(response);
            fail && fail(response);
        }, freeze, load_cache_first);
    }
    getAllItems(options = {}, then, fail, freeze = true, force_cache = true, dialog = true) {
        let ctx = this, app = this.app_context;
        return ctx.getAllRequest(options, (response, fromCache) => {
            ctx.addItemsToList(response.data.items, response.data.relations);
            then && then(response, fromCache);
        }, response => {
            dialog && app.view.dialog(response);
            fail && fail(response);
        }, freeze, force_cache);
    }
    addItem(data, then, fail, freeze = true, dialog = true) {
        let ctx = this, app = this.app_context;
        return ctx.addRequest(data, result => {
            ctx.addCreated(result);
            then && then(result);
        }, response => {
            dialog && app.view.dialog(response);
            fail && fail(response);
        }, freeze);
    }
    updateItem(item, then, fail, freeze = true, dialog = true) {
        let ctx = this, app = this.app_context, id = getId(item);
        if (!item.isSaved()) {
            let diff = item.toObject(true);
            item.isSaving(true);
            return ctx.updateRequest(id, diff, result => {
                item.isSaving(false);
                ctx.setSaved(item, result);
                then && then(result);
            }, response => {
                item.isSaving(false);
                dialog && app.view.dialog(response);
                fail && fail(response);
            }, freeze);
        }
        console.error('Not modified ->', item);
        return false;
    }
    deleteItem(item, then, fail, freeze = true, dialog = true) {
        let ctx = this, app = this.app_context, id = getId(item);
        item.isDeleting(true);
        return ctx.deleteRequest(id, result => {
            item.isDeleting(false);
            ctx.setDeleted(result);
            then && then(result);
        }, response => {
            item.isDeleting(false);
            dialog && app.view.dialog(response);
            fail && fail(response);
        }, freeze);
    }
    addItemsToList(items, relations = {}) {
        let ctx = this;
        let list = (Utils.isPlainObject(items)
            ? Object.values(items)
            : items || []);
        list.forEach(item => {
            let itemId = getId(item);
            ctx.safelyAddItem(item);
            if (!ctx.relations[itemId]) {
                ctx.relations = _with(ctx.relations, itemId, {});
            }
            for (let rel in relations) {
                if (relations.hasOwnProperty(rel)) {
                    let data = relations[rel];
                    if (data[itemId]) {
                        ctx.relations[itemId] = _with(ctx.relations[itemId], rel, data[itemId]);
                    }
                }
            }
        });
    }
    addItemToList(item, relations = {}) {
        let ctx = this, itemId = getId(item);
        ctx.safelyAddItem(item);
        if (!ctx.relations[itemId]) {
            ctx.relations = _with(ctx.relations, itemId, {});
        }
        for (let rel in relations) {
            if (relations.hasOwnProperty(rel)) {
                ctx.relations[itemId] = _with(ctx.relations[itemId], rel, relations[rel]);
            }
        }
    }
    safelyAddItem(item) {
        let key = getId(item), cachedItem = this.items[key];
        if (cachedItem) {
            cachedItem.doHydrate(item.toObject(), true);
        }
        else {
            this.items = _with(this.items, key, item);
        }
        return this;
    }
    setSaved(target, response) {
        let item = response.data.item;
        target.doHydrate(item.toObject(), true);
        this.safelyAddItem(target);
    }
    addCreated(response) {
        this.safelyAddItem(response.data.item);
    }
    setDeleted(response) {
        let item = response.data.item;
        this.items = _without(this.items, getId(item));
    }
    itemRelation(item, relation) {
        let id = getId(item);
        return this.relations[id] && this.relations[id][relation];
    }
    identify(id, checkCache = true) {
        let item = this.items[id], c;
        if (item)
            return item;
        if (checkCache) {
            c = GoblEntity.subCache(this.entity.name);
            return c && c[id];
        }
        return undefined;
    }
    list(ids = []) {
        let list = [], len = ids.length;
        if (len) {
            for (let i = 0; i < len; i++) {
                let id = ids[i], item = this.identify(id);
                if (item) {
                    list.push(item);
                }
            }
        }
        else {
            for (let key in this.items) {
                if (Object.prototype.hasOwnProperty.call(this.items, key)) {
                    list.push(this.items[key]);
                }
            }
        }
        return list;
    }
    orderBy(orderFn) {
        let keys = Object.keys(this.items);
        return keys.map(key => this.items[key]).sort(orderFn);
    }
    orderByValueOf(column) {
        return this.orderBy((a, b) => {
            return a[column] - b[column];
        });
    }
    select(list = this.list(), predicate, max = Infinity) {
        let result = [], len = list.length;
        for (let i = 0; i < len && result.length < max; i++) {
            if (predicate(list[i], i)) {
                result.push(list[i]);
            }
        }
        return result;
    }
    search(list = this.list(), search, stringBuilder) {
        if (!(search = search.trim()).length) {
            return list;
        }
        let reg = new RegExp(Utils.escapeRegExp(search), 'i');
        return list.filter((item, index) => {
            let v = stringBuilder(item, index);
            return reg.test(v);
        });
    }
    totalCount() {
        return Object.keys(this.items).length;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlNlcnZpY2VTdG9yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViU2VydmljZVN0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQXNCLE1BQU0sZUFBZSxDQUFDO0FBQy9ELE9BQU8sV0FXTixNQUFNLGVBQWUsQ0FBQztBQUd2QixPQUFPLEtBQUssTUFBTSxlQUFlLENBQUM7QUFJbEMsTUFBTSxLQUFLLEdBQUcsQ0FBQyxJQUF3QixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7QUFFakUsTUFBTSxLQUFLLEdBQUcsQ0FBQyxNQUFXLEVBQUUsR0FBb0IsRUFBRSxJQUFTLEVBQUUsRUFBRTtJQUM3RCxPQUFPLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQztBQUNuQyxDQUFDLEVBQ0QsUUFBUSxHQUFHLENBQUMsTUFBVyxFQUFFLEdBQW9CLEVBQUUsRUFBRTtJQUNoRCxPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNuQixPQUFPLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQztBQUN0QixDQUFDLENBQUM7QUFFSCxNQUFNLENBQUMsT0FBTyxPQUFPLGdCQUVuQixTQUFRLFdBQWM7SUFJdkIsWUFDQyxXQUFvQixFQUNILE1BQWlDLEVBQ2xELFlBQW9CLEVBQ3BCLG1CQUE0QixLQUFLO1FBRWpDLEtBQUssQ0FBQyxXQUFXLEVBQUUsWUFBWSxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFKbEMsV0FBTSxHQUFOLE1BQU0sQ0FBMkI7UUFMekMsVUFBSyxHQUF5QixFQUFFLENBQUM7UUFDakMsY0FBUyxHQUEyQixFQUFFLENBQUM7SUFTakQsQ0FBQztJQUVELE9BQU8sQ0FDTixFQUFVLEVBQ1YsWUFBb0IsRUFBRSxFQUN0QixJQUE0QixFQUM1QixJQUFtQixFQUNuQixTQUFrQixJQUFJLEVBQ3RCLG1C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LElBQVMsRUFBRSxLQUFhLEVBQUUsRUFBRTtZQUMvQyxJQUFJLENBQUMsR0FBRyxhQUFhLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ25DLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwQixDQUFDLENBQUMsQ0FBQztJQUNKLENBQUM7SUFFRCxVQUFVO1FBQ1QsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDdkMsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgR29ibEVudGl0eSwgR29ibFNpbmdsZVBLRW50aXR5IH0gZnJvbSAnZ29ibC11dGlscy10cyc7XG5pbXBvcnQgT1dlYlNlcnZpY2UsIHtcblx0dFNlcnZpY2VHZXRTdWNjZXNzLFxuXHR0U2VydmljZUZhaWwsXG5cdHRTZXJ2aWNlQWRkU3VjY2Vzcyxcblx0dFNlcnZpY2VSZXF1ZXN0T3B0aW9ucyxcblx0dFNlcnZpY2VHZXRBbGxTdWNjZXNzLFxuXHR0U2VydmljZVVwZGF0ZVN1Y2Nlc3MsXG5cdHRTZXJ2aWNlRGVsZXRlU3VjY2Vzcyxcblx0aVNlcnZpY2VVcGRhdGVSZXNwb25zZSxcblx0aVNlcnZpY2VBZGRSZXNwb25zZSxcblx0aVNlcnZpY2VEZWxldGVSZXNwb25zZSxcbn0gZnJvbSAnLi9PV2ViU2VydmljZSc7XG5pbXBvcnQgT1dlYkFwcCBmcm9tICcuL09XZWJBcHAnO1xuaW1wb3J0IE9XZWJDb20gZnJvbSAnLi9PV2ViQ29tJztcbmltcG9ydCBVdGlscyBmcm9tICcuL3V0aWxzL1V0aWxzJztcblxuZXhwb3J0IHR5cGUgdEVudGl0aWVzT3JkZXJCeUNiPFQ+ID0gKGE6IFQsIGI6IFQpID0+IG51bWJlcjtcblxuY29uc3QgZ2V0SWQgPSAoaXRlbTogR29ibFNpbmdsZVBLRW50aXR5KSA9PiBpdGVtLnNpbmdsZVBLVmFsdWUoKTtcblxuY29uc3QgX3dpdGggPSAodGFyZ2V0OiBhbnksIGtleTogc3RyaW5nIHwgbnVtYmVyLCBpdGVtOiBhbnkpID0+IHtcblx0XHRyZXR1cm4geyAuLi50YXJnZXQsIFtrZXldOiBpdGVtIH07XG5cdH0sXG5cdF93aXRob3V0ID0gKHRhcmdldDogYW55LCBrZXk6IHN0cmluZyB8IG51bWJlcikgPT4ge1xuXHRcdGRlbGV0ZSB0YXJnZXRba2V5XTtcblx0XHRyZXR1cm4geyAuLi50YXJnZXQgfTtcblx0fTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT1dlYlNlcnZpY2VTdG9yZTxcblx0VCBleHRlbmRzIEdvYmxTaW5nbGVQS0VudGl0eVxuPiBleHRlbmRzIE9XZWJTZXJ2aWNlPFQ+IHtcblx0cHJvdGVjdGVkIGl0ZW1zOiB7IFtrZXk6IHN0cmluZ106IFQgfSA9IHt9O1xuXHRwcm90ZWN0ZWQgcmVsYXRpb25zOiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge307XG5cblx0Y29uc3RydWN0b3IoXG5cdFx0YXBwX2NvbnRleHQ6IE9XZWJBcHAsXG5cdFx0cHJpdmF0ZSByZWFkb25seSBlbnRpdHk6IHR5cGVvZiBHb2JsU2luZ2xlUEtFbnRpdHksXG5cdFx0c2VydmljZV9uYW1lOiBzdHJpbmcsXG5cdFx0cGVyc2lzdGVudF9jYWNoZTogYm9vbGVhbiA9IGZhbHNlXG5cdCkge1xuXHRcdHN1cGVyKGFwcF9jb250ZXh0LCBzZXJ2aWNlX25hbWUsIHBlcnNpc3RlbnRfY2FjaGUpO1xuXHR9XG5cblx0Z2V0SXRlbShcblx0XHRpZDogc3RyaW5nLFxuXHRcdHJlbGF0aW9uczogc3RyaW5nID0gJycsXG5cdFx0dGhlbj86IHRTZXJ2aWNlR2V0U3VjY2VzczxUPixcblx0XHRmYWlsPzogdFNlcnZpY2VGYWlsLFxuXHRcdGZyZWV6ZTogYm9vbGVhbiA9IHRydWUsXG5cdFx0bG9hZF9jYWNoZV9maXJzdDogYm9vbGVhbiA9IGZhbHNlLFxuXHRcdGRpYWxvZzogYm9vbGVhbiA9IHRydWVcblx0KTogT1dlYkNvbSB7XG5cdFx0bGV0IGN0eCA9IHRoaXMsXG5cdFx0XHRhcHAgPSB0aGlzLmFwcF9jb250ZXh0O1xuXHRcdHJldHVybiBjdHguZ2V0UmVxdWVzdChcblx0XHRcdGlkLFxuXHRcdFx0cmVsYXRpb25zLFxuXHRcdFx0KHJlc3BvbnNlLCBmcm9tQ2FjaGUpID0+IHtcblx0XHRcdFx0Y3R4LmFkZEl0ZW1Ub0xpc3QocmVzcG9uc2UuZGF0YS5pdGVtLCByZXNwb25zZS5kYXRhLnJlbGF0aW9ucyk7XG5cdFx0XHRcdHRoZW4gJiYgdGhlbihyZXNwb25zZSwgZnJvbUNhY2hlKTtcblx0XHRcdH0sXG5cdFx0XHRyZXNwb25zZSA9PiB7XG5cdFx0XHRcdGRpYWxvZyAmJiBhcHAudmlldy5kaWFsb2cocmVzcG9uc2UpO1xuXHRcdFx0XHRmYWlsICYmIGZhaWwocmVzcG9uc2UpO1xuXHRcdFx0fSxcblx0XHRcdGZyZWV6ZSxcblx0XHRcdGxvYWRfY2FjaGVfZmlyc3Rcblx0XHQpO1xuXHR9XG5cblx0Z2V0QWxsSXRlbXMoXG5cdFx0b3B0aW9uczogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucyA9IHt9LFxuXHRcdHRoZW4/OiB0U2VydmljZUdldEFsbFN1Y2Nlc3M8VD4sXG5cdFx0ZmFpbD86IHRTZXJ2aWNlRmFpbCxcblx0XHRmcmVlemU6IGJvb2xlYW4gPSB0cnVlLFxuXHRcdGZvcmNlX2NhY2hlOiBib29sZWFuID0gdHJ1ZSxcblx0XHRkaWFsb2c6IGJvb2xlYW4gPSB0cnVlXG5cdCk6IE9XZWJDb20ge1xuXHRcdGxldCBjdHggPSB0aGlzLFxuXHRcdFx0YXBwID0gdGhpcy5hcHBfY29udGV4dDtcblx0XHRyZXR1cm4gY3R4LmdldEFsbFJlcXVlc3QoXG5cdFx0XHRvcHRpb25zLFxuXHRcdFx0KHJlc3BvbnNlLCBmcm9tQ2FjaGUpID0+IHtcblx0XHRcdFx0Y3R4LmFkZEl0ZW1zVG9MaXN0KFxuXHRcdFx0XHRcdHJlc3BvbnNlLmRhdGEuaXRlbXMsXG5cdFx0XHRcdFx0cmVzcG9uc2UuZGF0YS5yZWxhdGlvbnNcblx0XHRcdFx0KTtcblx0XHRcdFx0dGhlbiAmJiB0aGVuKHJlc3BvbnNlLCBmcm9tQ2FjaGUpO1xuXHRcdFx0fSxcblx0XHRcdHJlc3BvbnNlID0+IHtcblx0XHRcdFx0ZGlhbG9nICYmIGFwcC52aWV3LmRpYWxvZyhyZXNwb25zZSk7XG5cdFx0XHRcdGZhaWwgJiYgZmFpbChyZXNwb25zZSk7XG5cdFx0XHR9LFxuXHRcdFx0ZnJlZXplLFxuXHRcdFx0Zm9yY2VfY2FjaGVcblx0XHQpO1xuXHR9XG5cblx0YWRkSXRlbShcblx0XHRkYXRhOiBhbnksXG5cdFx0dGhlbj86IHRTZXJ2aWNlQWRkU3VjY2VzczxUPixcblx0XHRmYWlsPzogdFNlcnZpY2VGYWlsLFxuXHRcdGZyZWV6ZTogYm9vbGVhbiA9IHRydWUsXG5cdFx0ZGlhbG9nOiBib29sZWFuID0gdHJ1ZVxuXHQpOiBPV2ViQ29tIHtcblx0XHRsZXQgY3R4ID0gdGhpcyxcblx0XHRcdGFwcCA9IHRoaXMuYXBwX2NvbnRleHQ7XG5cdFx0cmV0dXJuIGN0eC5hZGRSZXF1ZXN0KFxuXHRcdFx0ZGF0YSxcblx0XHRcdHJlc3VsdCA9PiB7XG5cdFx0XHRcdGN0eC5hZGRDcmVhdGVkKHJlc3VsdCk7XG5cdFx0XHRcdHRoZW4gJiYgdGhlbihyZXN1bHQpO1xuXHRcdFx0fSxcblx0XHRcdHJlc3BvbnNlID0+IHtcblx0XHRcdFx0ZGlhbG9nICYmIGFwcC52aWV3LmRpYWxvZyhyZXNwb25zZSk7XG5cdFx0XHRcdGZhaWwgJiYgZmFpbChyZXNwb25zZSk7XG5cdFx0XHR9LFxuXHRcdFx0ZnJlZXplXG5cdFx0KTtcblx0fVxuXG5cdHVwZGF0ZUl0ZW0oXG5cdFx0aXRlbTogVCxcblx0XHR0aGVuPzogdFNlcnZpY2VVcGRhdGVTdWNjZXNzPFQ+LFxuXHRcdGZhaWw/OiB0U2VydmljZUZhaWwsXG5cdFx0ZnJlZXplOiBib29sZWFuID0gdHJ1ZSxcblx0XHRkaWFsb2c6IGJvb2xlYW4gPSB0cnVlXG5cdCk6IE9XZWJDb20gfCBmYWxzZSB7XG5cdFx0bGV0IGN0eCA9IHRoaXMsXG5cdFx0XHRhcHAgPSB0aGlzLmFwcF9jb250ZXh0LFxuXHRcdFx0aWQgPSBnZXRJZChpdGVtKTtcblxuXHRcdGlmICghaXRlbS5pc1NhdmVkKCkpIHtcblx0XHRcdGxldCBkaWZmID0gaXRlbS50b09iamVjdCh0cnVlKTtcblxuXHRcdFx0aXRlbS5pc1NhdmluZyh0cnVlKTtcblxuXHRcdFx0cmV0dXJuIGN0eC51cGRhdGVSZXF1ZXN0KFxuXHRcdFx0XHRpZCxcblx0XHRcdFx0ZGlmZixcblx0XHRcdFx0cmVzdWx0ID0+IHtcblx0XHRcdFx0XHRpdGVtLmlzU2F2aW5nKGZhbHNlKTtcblx0XHRcdFx0XHRjdHguc2V0U2F2ZWQoaXRlbSwgcmVzdWx0KTtcblx0XHRcdFx0XHR0aGVuICYmIHRoZW4ocmVzdWx0KTtcblx0XHRcdFx0fSxcblx0XHRcdFx0cmVzcG9uc2UgPT4ge1xuXHRcdFx0XHRcdGl0ZW0uaXNTYXZpbmcoZmFsc2UpO1xuXHRcdFx0XHRcdGRpYWxvZyAmJiBhcHAudmlldy5kaWFsb2cocmVzcG9uc2UpO1xuXHRcdFx0XHRcdGZhaWwgJiYgZmFpbChyZXNwb25zZSk7XG5cdFx0XHRcdH0sXG5cdFx0XHRcdGZyZWV6ZVxuXHRcdFx0KTtcblx0XHR9XG5cblx0XHRjb25zb2xlLmVycm9yKCdOb3QgbW9kaWZpZWQgLT4nLCBpdGVtKTtcblx0XHRyZXR1cm4gZmFsc2U7XG5cdH1cblxuXHRkZWxldGVJdGVtKFxuXHRcdGl0ZW06IFQsXG5cdFx0dGhlbj86IHRTZXJ2aWNlRGVsZXRlU3VjY2VzczxUPixcblx0XHRmYWlsPzogdFNlcnZpY2VGYWlsLFxuXHRcdGZyZWV6ZTogYm9vbGVhbiA9IHRydWUsXG5cdFx0ZGlhbG9nOiBib29sZWFuID0gdHJ1ZVxuXHQpOiBPV2ViQ29tIHtcblx0XHRsZXQgY3R4ID0gdGhpcyxcblx0XHRcdGFwcCA9IHRoaXMuYXBwX2NvbnRleHQsXG5cdFx0XHRpZCA9IGdldElkKGl0ZW0pO1xuXG5cdFx0aXRlbS5pc0RlbGV0aW5nKHRydWUpO1xuXHRcdHJldHVybiBjdHguZGVsZXRlUmVxdWVzdChcblx0XHRcdGlkLFxuXHRcdFx0cmVzdWx0ID0+IHtcblx0XHRcdFx0aXRlbS5pc0RlbGV0aW5nKGZhbHNlKTtcblx0XHRcdFx0Y3R4LnNldERlbGV0ZWQocmVzdWx0KTtcblx0XHRcdFx0dGhlbiAmJiB0aGVuKHJlc3VsdCk7XG5cdFx0XHR9LFxuXHRcdFx0cmVzcG9uc2UgPT4ge1xuXHRcdFx0XHRpdGVtLmlzRGVsZXRpbmcoZmFsc2UpO1xuXHRcdFx0XHRkaWFsb2cgJiYgYXBwLnZpZXcuZGlhbG9nKHJlc3BvbnNlKTtcblx0XHRcdFx0ZmFpbCAmJiBmYWlsKHJlc3BvbnNlKTtcblx0XHRcdH0sXG5cdFx0XHRmcmVlemVcblx0XHQpO1xuXHR9XG5cblx0YWRkSXRlbXNUb0xpc3QoaXRlbXM6IFRbXSB8IHsgW2tleTogc3RyaW5nXTogVCB9LCByZWxhdGlvbnM6IGFueSA9IHt9KSB7XG5cdFx0bGV0IGN0eCA9IHRoaXM7XG5cdFx0bGV0IGxpc3Q6IFRbXSA9IChVdGlscy5pc1BsYWluT2JqZWN0KGl0ZW1zKVxuXHRcdFx0PyBPYmplY3QudmFsdWVzKGl0ZW1zKVxuXHRcdFx0OiBpdGVtcyB8fCBbXSkgYXMgVFtdO1xuXG5cdFx0bGlzdC5mb3JFYWNoKGl0ZW0gPT4ge1xuXHRcdFx0bGV0IGl0ZW1JZCA9IGdldElkKGl0ZW0pO1xuXG5cdFx0XHRjdHguc2FmZWx5QWRkSXRlbShpdGVtKTtcblxuXHRcdFx0aWYgKCFjdHgucmVsYXRpb25zW2l0ZW1JZF0pIHtcblx0XHRcdFx0Y3R4LnJlbGF0aW9ucyA9IF93aXRoKGN0eC5yZWxhdGlvbnMsIGl0ZW1JZCwge30pO1xuXHRcdFx0fVxuXG5cdFx0XHRmb3IgKGxldCByZWwgaW4gcmVsYXRpb25zKSB7XG5cdFx0XHRcdGlmIChyZWxhdGlvbnMuaGFzT3duUHJvcGVydHkocmVsKSkge1xuXHRcdFx0XHRcdGxldCBkYXRhID0gcmVsYXRpb25zW3JlbF07XG5cblx0XHRcdFx0XHRpZiAoZGF0YVtpdGVtSWRdKSB7XG5cdFx0XHRcdFx0XHRjdHgucmVsYXRpb25zW2l0ZW1JZF0gPSBfd2l0aChcblx0XHRcdFx0XHRcdFx0Y3R4LnJlbGF0aW9uc1tpdGVtSWRdLFxuXHRcdFx0XHRcdFx0XHRyZWwsXG5cdFx0XHRcdFx0XHRcdGRhdGFbaXRlbUlkXVxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9KTtcblx0fVxuXG5cdGFkZEl0ZW1Ub0xpc3QoaXRlbTogVCwgcmVsYXRpb25zOiBhbnkgPSB7fSkge1xuXHRcdGxldCBjdHggPSB0aGlzLFxuXHRcdFx0aXRlbUlkID0gZ2V0SWQoaXRlbSk7XG5cblx0XHRjdHguc2FmZWx5QWRkSXRlbShpdGVtKTtcblxuXHRcdGlmICghY3R4LnJlbGF0aW9uc1tpdGVtSWRdKSB7XG5cdFx0XHRjdHgucmVsYXRpb25zID0gX3dpdGgoY3R4LnJlbGF0aW9ucywgaXRlbUlkLCB7fSk7XG5cdFx0fVxuXG5cdFx0Zm9yIChsZXQgcmVsIGluIHJlbGF0aW9ucykge1xuXHRcdFx0aWYgKHJlbGF0aW9ucy5oYXNPd25Qcm9wZXJ0eShyZWwpKSB7XG5cdFx0XHRcdGN0eC5yZWxhdGlvbnNbaXRlbUlkXSA9IF93aXRoKFxuXHRcdFx0XHRcdGN0eC5yZWxhdGlvbnNbaXRlbUlkXSxcblx0XHRcdFx0XHRyZWwsXG5cdFx0XHRcdFx0cmVsYXRpb25zW3JlbF1cblx0XHRcdFx0KTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIHNhZmVseUFkZEl0ZW0oaXRlbTogVCkge1xuXHRcdGxldCBrZXkgPSBnZXRJZChpdGVtKSxcblx0XHRcdGNhY2hlZEl0ZW0gPSB0aGlzLml0ZW1zW2tleV07XG5cblx0XHRpZiAoY2FjaGVkSXRlbSkge1xuXHRcdFx0Y2FjaGVkSXRlbS5kb0h5ZHJhdGUoaXRlbS50b09iamVjdCgpLCB0cnVlKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5pdGVtcyA9IF93aXRoKHRoaXMuaXRlbXMsIGtleSwgaXRlbSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRzZXRTYXZlZCh0YXJnZXQ6IFQsIHJlc3BvbnNlOiBpU2VydmljZVVwZGF0ZVJlc3BvbnNlPFQ+KSB7XG5cdFx0bGV0IGl0ZW0gPSByZXNwb25zZS5kYXRhLml0ZW07XG5cblx0XHR0YXJnZXQuZG9IeWRyYXRlKGl0ZW0udG9PYmplY3QoKSwgdHJ1ZSk7XG5cblx0XHR0aGlzLnNhZmVseUFkZEl0ZW0odGFyZ2V0KTtcblx0fVxuXG5cdGFkZENyZWF0ZWQocmVzcG9uc2U6IGlTZXJ2aWNlQWRkUmVzcG9uc2U8VD4pIHtcblx0XHR0aGlzLnNhZmVseUFkZEl0ZW0ocmVzcG9uc2UuZGF0YS5pdGVtKTtcblx0fVxuXG5cdHNldERlbGV0ZWQocmVzcG9uc2U6IGlTZXJ2aWNlRGVsZXRlUmVzcG9uc2U8VD4pIHtcblx0XHRsZXQgaXRlbSA9IHJlc3BvbnNlLmRhdGEuaXRlbTtcblx0XHR0aGlzLml0ZW1zID0gX3dpdGhvdXQodGhpcy5pdGVtcywgZ2V0SWQoaXRlbSkpO1xuXHR9XG5cblx0aXRlbVJlbGF0aW9uPFo+KGl0ZW06IFQsIHJlbGF0aW9uOiBzdHJpbmcpOiBaIHwgdW5kZWZpbmVkIHtcblx0XHRsZXQgaWQgPSBnZXRJZChpdGVtKTtcblx0XHRyZXR1cm4gdGhpcy5yZWxhdGlvbnNbaWRdICYmIHRoaXMucmVsYXRpb25zW2lkXVtyZWxhdGlvbl07XG5cdH1cblxuXHRpZGVudGlmeShpZDogc3RyaW5nLCBjaGVja0NhY2hlOiBib29sZWFuID0gdHJ1ZSk6IFQgfCB1bmRlZmluZWQge1xuXHRcdGxldCBpdGVtID0gdGhpcy5pdGVtc1tpZF0sXG5cdFx0XHRjO1xuXG5cdFx0aWYgKGl0ZW0pIHJldHVybiBpdGVtO1xuXG5cdFx0aWYgKGNoZWNrQ2FjaGUpIHtcblx0XHRcdGMgPSA8YW55PkdvYmxFbnRpdHkuc3ViQ2FjaGUodGhpcy5lbnRpdHkubmFtZSk7XG5cblx0XHRcdHJldHVybiBjICYmIGNbaWRdO1xuXHRcdH1cblxuXHRcdHJldHVybiB1bmRlZmluZWQ7XG5cdH1cblxuXHRsaXN0KGlkczogc3RyaW5nW10gPSBbXSkge1xuXHRcdGxldCBsaXN0OiBUW10gPSBbXSxcblx0XHRcdGxlbiA9IGlkcy5sZW5ndGg7XG5cdFx0aWYgKGxlbikge1xuXHRcdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykge1xuXHRcdFx0XHRsZXQgaWQgPSBpZHNbaV0sXG5cdFx0XHRcdFx0aXRlbSA9IHRoaXMuaWRlbnRpZnkoaWQpO1xuXHRcdFx0XHRpZiAoaXRlbSkge1xuXHRcdFx0XHRcdGxpc3QucHVzaChpdGVtKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH0gZWxzZSB7XG5cdFx0XHRmb3IgKGxldCBrZXkgaW4gdGhpcy5pdGVtcykge1xuXHRcdFx0XHRpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMuaXRlbXMsIGtleSkpIHtcblx0XHRcdFx0XHRsaXN0LnB1c2godGhpcy5pdGVtc1trZXldKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiBsaXN0O1xuXHR9XG5cblx0b3JkZXJCeShvcmRlckZuOiB0RW50aXRpZXNPcmRlckJ5Q2I8VD4pOiBUW10ge1xuXHRcdGxldCBrZXlzID0gT2JqZWN0LmtleXModGhpcy5pdGVtcyk7XG5cblx0XHRyZXR1cm4ga2V5cy5tYXAoa2V5ID0+IHRoaXMuaXRlbXNba2V5XSkuc29ydChvcmRlckZuKTtcblx0fVxuXG5cdG9yZGVyQnlWYWx1ZU9mKGNvbHVtbjogc3RyaW5nKTogVFtdIHtcblx0XHRyZXR1cm4gdGhpcy5vcmRlckJ5KChhOiBhbnksIGI6IGFueSkgPT4ge1xuXHRcdFx0cmV0dXJuIGFbY29sdW1uXSAtIGJbY29sdW1uXTtcblx0XHR9KTtcblx0fVxuXG5cdHNlbGVjdChcblx0XHRsaXN0OiBUW10gPSB0aGlzLmxpc3QoKSxcblx0XHRwcmVkaWNhdGU6ICh2YWx1ZTogVCwgaW5kZXg6IG51bWJlcikgPT4gYm9vbGVhbixcblx0XHRtYXggPSBJbmZpbml0eVxuXHQpOiBUW10ge1xuXHRcdGxldCByZXN1bHQ6IFRbXSA9IFtdLFxuXHRcdFx0bGVuID0gbGlzdC5sZW5ndGg7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGxlbiAmJiByZXN1bHQubGVuZ3RoIDwgbWF4OyBpKyspIHtcblx0XHRcdGlmIChwcmVkaWNhdGUobGlzdFtpXSwgaSkpIHtcblx0XHRcdFx0cmVzdWx0LnB1c2gobGlzdFtpXSk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHJlc3VsdDtcblx0fVxuXG5cdHNlYXJjaChcblx0XHRsaXN0OiBUW10gPSB0aGlzLmxpc3QoKSxcblx0XHRzZWFyY2g6IHN0cmluZyxcblx0XHRzdHJpbmdCdWlsZGVyOiAodmFsdWU6IFQsIGluZGV4OiBudW1iZXIpID0+IHN0cmluZ1xuXHQpOiBUW10ge1xuXHRcdGlmICghKHNlYXJjaCA9IHNlYXJjaC50cmltKCkpLmxlbmd0aCkge1xuXHRcdFx0cmV0dXJuIGxpc3Q7XG5cdFx0fVxuXG5cdFx0bGV0IHJlZyA9IG5ldyBSZWdFeHAoVXRpbHMuZXNjYXBlUmVnRXhwKHNlYXJjaCksICdpJyk7XG5cblx0XHRyZXR1cm4gbGlzdC5maWx0ZXIoKGl0ZW06IGFueSwgaW5kZXg6IG51bWJlcikgPT4ge1xuXHRcdFx0bGV0IHYgPSBzdHJpbmdCdWlsZGVyKGl0ZW0sIGluZGV4KTtcblx0XHRcdHJldHVybiByZWcudGVzdCh2KTtcblx0XHR9KTtcblx0fVxuXG5cdHRvdGFsQ291bnQoKTogbnVtYmVyIHtcblx0XHRyZXR1cm4gT2JqZWN0LmtleXModGhpcy5pdGVtcykubGVuZ3RoO1xuXHR9XG59XG4iXX0=