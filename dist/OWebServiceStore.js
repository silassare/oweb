import { getEntityCache } from 'gobl-utils-ts';
import OWebService from './OWebService';
import { escapeRegExp, isPlainObject, _error } from './utils/Utils';
const getId = (item) => item.singlePKValue();
const _with = (target, key, item) => {
    return { ...target, [key]: item };
}, _without = (target, key) => {
    delete target[key];
    return { ...target };
};
export default class OWebServiceStore extends OWebService {
    constructor(appContext, entity, service) {
        super(appContext, service);
        this.entity = entity;
        this.items = {};
        this.relations = {};
    }
    getItem(id, relations = '') {
        const ctx = this;
        return ctx
            .getRequest(id, relations)
            .onGoodNews(function (response) {
            ctx.addItemToList(response.json.data.item, response.json.data.relations);
        })
            .send();
    }
    getAllItems(options = {}) {
        const ctx = this;
        return ctx
            .getAllRequest(options)
            .onGoodNews(function (response) {
            ctx.addItemsToList(response.json.data.items, response.json.data.relations);
        })
            .send();
    }
    addItem(data) {
        const ctx = this;
        return ctx
            .addRequest(data)
            .onGoodNews(function (response) {
            ctx.addCreated(response.json);
        })
            .send();
    }
    updateItem(item, freeze = true) {
        const ctx = this, id = getId(item);
        if (!item.isSaved()) {
            const diff = item.toObject(true);
            item.isSaving(true);
            return ctx
                .updateRequest(id, diff)
                .onGoodNews(function (response) {
                ctx.setSaved(item, response.json);
            })
                .onFinished(function () {
                item.isSaving(false);
            })
                .send();
        }
        _error('not updated', item);
        return false;
    }
    deleteItem(item) {
        const ctx = this, id = getId(item);
        item.isDeleting(true);
        return ctx
            .deleteRequest(id)
            .onGoodNews(function (response) {
            ctx.setDeleted(response.json);
        })
            .onFinished(function () {
            item.isDeleting(false);
        })
            .send();
    }
    addItemsToList(items, relations = {}) {
        const ctx = this, list = (isPlainObject(items)
            ? Object.values(items)
            : items || []);
        list.forEach((item) => {
            const itemId = getId(item);
            ctx.safelyAddItem(item);
            if (!ctx.relations[itemId]) {
                ctx.relations = _with(ctx.relations, itemId, {});
            }
            for (const rel in relations) {
                if (relations.hasOwnProperty(rel)) {
                    const data = relations[rel];
                    if (data[itemId]) {
                        ctx.relations[itemId] = _with(ctx.relations[itemId], rel, data[itemId]);
                    }
                }
            }
        });
    }
    addItemToList(item, relations = {}) {
        const ctx = this, itemId = getId(item);
        ctx.safelyAddItem(item);
        if (!ctx.relations[itemId]) {
            ctx.relations = _with(ctx.relations, itemId, {});
        }
        for (const rel in relations) {
            if (relations.hasOwnProperty(rel)) {
                ctx.relations[itemId] = _with(ctx.relations[itemId], rel, relations[rel]);
            }
        }
    }
    safelyAddItem(item) {
        const key = getId(item), cachedItem = this.items[key];
        if (cachedItem) {
            cachedItem.doHydrate(item.toObject(), true);
        }
        else {
            this.items = _with(this.items, key, item);
        }
        return this;
    }
    setSaved(target, response) {
        const item = response.data.item;
        target.doHydrate(item.toObject(), true);
        this.safelyAddItem(target);
    }
    addCreated(response) {
        this.safelyAddItem(response.data.item);
    }
    setDeleted(response) {
        const item = response.data.item;
        this.items = _without(this.items, getId(item));
    }
    itemRelation(item, relation) {
        const id = getId(item);
        return this.relations[id] && this.relations[id][relation];
    }
    identify(id, checkCache = true) {
        const item = this.items[id];
        let c;
        if (item)
            return item;
        if (checkCache) {
            c = getEntityCache(this.entity.name);
            return c && c[id];
        }
        return undefined;
    }
    list(ids = []) {
        const list = [], len = ids.length;
        if (len) {
            for (let i = 0; i < len; i++) {
                const id = ids[i], item = this.identify(id);
                if (item) {
                    list.push(item);
                }
            }
        }
        else {
            for (const key in this.items) {
                if (Object.prototype.hasOwnProperty.call(this.items, key)) {
                    list.push(this.items[key]);
                }
            }
        }
        return list;
    }
    orderBy(orderFn) {
        const keys = Object.keys(this.items);
        return keys.map((key) => this.items[key]).sort(orderFn);
    }
    orderByValueOf(column) {
        return this.orderBy((a, b) => {
            return a[column] - b[column];
        });
    }
    select(list = this.list(), predicate, max = Infinity) {
        const result = [], len = list.length;
        for (let i = 0; i < len && result.length < max; i++) {
            if (predicate(list[i], i)) {
                result.push(list[i]);
            }
        }
        return result;
    }
    search(list = this.list(), search, stringBuilder) {
        if (!(search = search.trim()).length) {
            return list;
        }
        const reg = new RegExp(escapeRegExp(search), 'i');
        return list.filter((item, index) => {
            const v = stringBuilder(item, index);
            return reg.test(v);
        });
    }
    totalCount() {
        return Object.keys(this.items).length;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlNlcnZpY2VTdG9yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViU2VydmljZVN0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBc0IsY0FBYyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25FLE9BQU8sV0FLTixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsWUFBWSxFQUFFLGFBQWEsRUFBUSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFJMUUsTUFBTSxLQUFLLEdBQUcsQ0FBQyxJQUF3QixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7QUFFakUsTUFBTSxLQUFLLEdBQUcsQ0FBQyxNQUFXLEVBQUUsR0FBb0IsRUFBRSxJQUFTLEVBQUUsRUFBRTtJQUM3RCxPQUFPLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQztBQUNuQyxDQUFDLEVBQ0QsUUFBUSxHQUFHLENBQUMsTUFBVyxFQUFFLEdBQW9CLEVBQUUsRUFBRTtJQUNoRCxPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNuQixPQUFPLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQztBQUN0QixDQUFDLENBQUM7QUFFSCxNQUFNLENBQUMsT0FBTyxPQUFPLGdCQUVuQixTQUFRLFdBQWM7SUFJdkIsWUFDQyxVQUFtQixFQUNGLE1BQWlDLEVBQ2xELE9BQWU7UUFFZixLQUFLLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBSFYsV0FBTSxHQUFOLE1BQU0sQ0FBMkI7UUFMekMsVUFBSyxHQUF5QixFQUFFLENBQUM7UUFDakMsY0FBUyxHQUEyQixFQUFFLENBQUM7SUFRakQsQ0FBQztJQUVELE9BQU8sQ0FBQyxFQUFVLEVBQUUsWUFBb0IsRUFBRTtRQUN6QyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUM7UUFFakIsT0FBTyxHQUFHO2FBQ1Is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RUFBRSxDQUFDLEdBQUcsR0FBRyxJQUFJLE1BQU0sQ0FBQyxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ3BELElBQUksU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRTtnQkFDMUIsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUNyQjtTQUNEO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDZixDQUFDO0lBRUQsTUFBTSxDQUNMLE9BQVksSUFBSSxDQUFDLElBQUksRUFBRSxFQUN2QixNQUFjLEVBQ2QsYUFBa0Q7UUFFbEQsSUFBSSxDQUFDLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRTtZQUNyQyxPQUFPLElBQUksQ0FBQztTQUNaO1FBRUQsTUFBTSxHQUFHLEdBQUcsSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBRWxELE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQVMsRUFBRSxLQUFhLEVBQUUsRUFBRTtZQUMvQyxNQUFNLENBQUMsR0FBRyxhQUFhLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3JDLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwQixDQUFDLENBQUMsQ0FBQztJQUNKLENBQUM7SUFFRCxVQUFVO1FBQ1QsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDdkMsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgR29ibFNpbmdsZVBLRW50aXR5LCBnZXRFbnRpdHlDYWNoZSB9IGZyb20gJ2dvYmwtdXRpbHMtdHMnO1xuaW1wb3J0IE9XZWJTZXJ2aWNlLCB7XG5cdElTZXJ2aWNlQWRkUmVzcG9uc2UsXG5cdElTZXJ2aWNlRGVsZXRlUmVzcG9uc2UsXG5cdElTZXJ2aWNlVXBkYXRlUmVzcG9uc2UsXG5cdElTZXJ2aWNlUmVxdWVzdE9wdGlvbnMsXG59IGZyb20gJy4vT1dlYlNlcnZpY2UnO1xuaW1wb3J0IE9XZWJBcHAgZnJvbSAnLi9PV2ViQXBwJztcbmltcG9ydCB7IGVzY2FwZVJlZ0V4cCwgaXNQbGFpbk9iamVjdCwgbm9vcCwgX2Vycm9yIH0gZnJvbSAnLi91dGlscy9VdGlscyc7XG5cbmV4cG9ydCB0eXBlIHRFbnRpdGllc09yZGVyQnlDYjxUPiA9IChhOiBULCBiOiBUKSA9PiBudW1iZXI7XG5cbmNvbnN0IGdldElkID0gKGl0ZW06IEdvYmxTaW5nbGVQS0VudGl0eSkgPT4gaXRlbS5zaW5nbGVQS1ZhbHVlKCk7XG5cbmNvbnN0IF93aXRoID0gKHRhcmdldDogYW55LCBrZXk6IHN0cmluZyB8IG51bWJlciwgaXRlbTogYW55KSA9PiB7XG5cdFx0cmV0dXJuIHsgLi4udGFyZ2V0LCBba2V5XTogaXRlbSB9O1xuXHR9LFxuXHRfd2l0aG91dCA9ICh0YXJnZXQ6IGFueSwga2V5OiBzdHJpbmcgfCBudW1iZXIpID0+IHtcblx0XHRkZWxldGUgdGFyZ2V0W2tleV07XG5cdFx0cmV0dXJuIHsgLi4udGFyZ2V0IH07XG5cdH07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJTZXJ2aWNlU3RvcmU8XG5cdFQgZXh0ZW5kcyBHb2JsU2luZ2xlUEtFbnRpdHlcbj4gZXh0ZW5kcyBPV2ViU2VydmljZTxUPiB7XG5cdHByb3RlY3RlZCBpdGVtczogeyBba2V5OiBzdHJpbmddOiBUIH0gPSB7fTtcblx0cHJvdGVjdGVkIHJlbGF0aW9uczogeyBba2V5OiBzdHJpbmddOiBhbnkgfSA9IHt9O1xuXG5cdGNvbnN0cnVjdG9yKFxuXHRcdGFwcENvbnRleHQ6IE9XZWJBcHAsXG5cdFx0cHJpdmF0ZSByZWFkb25seSBlbnRpdHk6IHR5cGVvZiBHb2JsU2luZ2xlUEtFbnRpdHksXG5cdFx0c2VydmljZTogc3RyaW5nLFxuXHQpIHtcblx0XHRzdXBlcihhcHBDb250ZXh0LCBzZXJ2aWNlKTtcblx0fVxuXG5cdGdldEl0ZW0oaWQ6IHN0cmluZywgcmVsYXRpb25zOiBzdHJpbmcgPSAnJykge1xuXHRcdGNvbnN0IGN0eCA9IHRoaXM7XG5cblx0XHRyZXR1cm4gY3R4XG5cdFx0XHQuZ2V0UmVxdWVzdChpZCwgcmVsYXRpb25zKVxuXHRcdFx0Lm9uR29vZE5ld3MoZnVuY3Rpb24gKHJlc3BvbnNlKSB7XG5cdFx0XHRcdGN0eC5hZGRJdGVtVG9MaXN0KFxuXHRcdFx0XHRcdHJlc3BvbnNlLmpzb24hLmRhdGEuaXRlbSxcblx0XHRcdFx0XHRyZXNwb25zZS5qc29uIS5kYXRhLnJlbGF0aW9ucyxcblx0XHRcdFx0KTtcblx0XHRcdH0pXG5cdFx0XHQuc2VuZCgpO1xuXHR9XG5cblx0Z2V0QWxsSXRlbXMob3B0aW9uczogSVNlcnZpY2VSZXF1ZXN0T3B0aW9ucyA9IHt9KSB7XG5cdFx0Y29uc3QgY3R4ID0gdGhpcztcblxuXHRcdHJldHVybiBjdHhcblx0XHRcdC5nZXRBbGxSZXF1ZXN0KG9wdGlvbnMpXG5cdFx0XHQub25Hb29kTmV3cyhmdW5jdGlvbiAocmVzcG9uc2UpIHtcblx0XHRcdFx0Y3R4LmFkZEl0ZW1zVG9MaXN0KFxuXHRcdFx0XHRcdHJlc3BvbnNlLmpzb24hLmRhdGEuaXRlbXMsXG5cdFx0XHRcdFx0cmVzcG9uc2UuanNvbiEuZGF0YS5yZWxhdGlvbnMsXG5cdFx0XHRcdCk7XG5cdFx0XHR9KVxuXHRcdFx0LnNlbmQoKTtcblx0fVxuXG5cdGFkZEl0ZW0oZGF0YTogYW55KSB7XG5cdFx0Y29uc3QgY3R4ID0gdGhpcztcblx0XHRyZXR1cm4gY3R4XG5cdFx0XHQuYWRkUmVxdWVzdChkYXRhKVxuXHRcdFx0Lm9uR29vZE5ld3MoZnVuY3Rpb24gKHJlc3BvbnNlKSB7XG5cdFx0XHRcdGN0eC5hZGRDcmVhdGVkKHJlc3BvbnNlLmpzb24hKTtcblx0XHRcdH0pXG5cdFx0XHQuc2VuZCgpO1xuXHR9XG5cblx0dXBkYXRlSXRlbShpdGVtOiBULCBmcmVlemU6IGJvb2xlYW4gPSB0cnVlKSB7XG5cdFx0Y29uc3QgY3R4ID0gdGhpcyxcblx0XHRcdGlkID0gZ2V0SWQoaXRlbSk7XG5cblx0XHRpZiAoIWl0ZW0uaXNTYXZlZCgpKSB7XG5cdFx0XHRjb25zdCBkaWZmID0gaXRlbS50b09iamVjdCh0cnVlKTtcblxuXHRcdFx0aXRlbS5pc1NhdmluZyh0cnVlKTtcblxuXHRcdFx0cmV0dXJuIGN0eFxuXHRcdFx0XHQudXBkYXRlUmVxdWVzdChpZCwgZGlmZilcblx0XHRcdFx0Lm9uR29vZE5ld3MoZnVuY3Rpb24gKHJlc3BvbnNlKSB7XG5cdFx0XHRcdFx0Y3R4LnNldFNhdmVkKGl0ZW0sIHJlc3BvbnNlLmpzb24hKTtcblx0XHRcdFx0fSlcblx0XHRcdFx0Lm9uRmluaXNoZWQoZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRcdGl0ZW0uaXNTYXZpbmcoZmFsc2UpO1xuXHRcdFx0XHR9KVxuXHRcdFx0XHQuc2VuZCgpO1xuXHRcdH1cblxuXHRcdF9lcnJvcignbm90IHVwZGF0ZWQnLCBpdGVtKTtcblx0XHRyZXR1cm4gZmFsc2U7XG5cdH1cblxuXHRkZWxldGVJdGVtKGl0ZW06IFQpIHtcblx0XHRjb25zdCBjdHggPSB0aGlzLFxuXHRcdFx0aWQgPSBnZXRJZChpdGVtKTtcblxuXHRcdGl0ZW0uaXNEZWxldGluZyh0cnVlKTtcblxuXHRcdHJldHVybiBjdHhcblx0XHRcdC5kZWxldGVSZXF1ZXN0KGlkKVxuXHRcdFx0Lm9uR29vZE5ld3MoZnVuY3Rpb24gKHJlc3BvbnNlKSB7XG5cdFx0XHRcdGN0eC5zZXREZWxldGVkKHJlc3BvbnNlLmpzb24hKTtcblx0XHRcdH0pXG5cdFx0XHQub25GaW5pc2hlZChmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGl0ZW0uaXNEZWxldGluZyhmYWxzZSk7XG5cdFx0XHR9KVxuXHRcdFx0LnNlbmQoKTtcblx0fVxuXG5cdGFkZEl0ZW1zVG9MaXN0KGl0ZW1zOiBUW10gfCB7IFtrZXk6IHN0cmluZ106IFQgfSwgcmVsYXRpb25zOiBhbnkgPSB7fSkge1xuXHRcdGNvbnN0IGN0eCA9IHRoaXMsXG5cdFx0XHRsaXN0OiBUW10gPSAoaXNQbGFpbk9iamVjdChpdGVtcylcblx0XHRcdFx0PyBPYmplY3QudmFsdWVzKGl0ZW1zKVxuXHRcdFx0XHQ6IGl0ZW1zIHx8IFtdKSBhcyBUW107XG5cblx0XHRsaXN0LmZvckVhY2goKGl0ZW0pID0+IHtcblx0XHRcdGNvbnN0IGl0ZW1JZCA9IGdldElkKGl0ZW0pO1xuXG5cdFx0XHRjdHguc2FmZWx5QWRkSXRlbShpdGVtKTtcblxuXHRcdFx0aWYgKCFjdHgucmVsYXRpb25zW2l0ZW1JZF0pIHtcblx0XHRcdFx0Y3R4LnJlbGF0aW9ucyA9IF93aXRoKGN0eC5yZWxhdGlvbnMsIGl0ZW1JZCwge30pO1xuXHRcdFx0fVxuXG5cdFx0XHRmb3IgKGNvbnN0IHJlbCBpbiByZWxhdGlvbnMpIHtcblx0XHRcdFx0aWYgKHJlbGF0aW9ucy5oYXNPd25Qcm9wZXJ0eShyZWwpKSB7XG5cdFx0XHRcdFx0Y29uc3QgZGF0YSA9IHJlbGF0aW9uc1tyZWxdO1xuXG5cdFx0XHRcdFx0aWYgKGRhdGFbaXRlbUlkXSkge1xuXHRcdFx0XHRcdFx0Y3R4LnJlbGF0aW9uc1tpdGVtSWRdID0gX3dpdGgoXG5cdFx0XHRcdFx0XHRcdGN0eC5yZWxhdGlvbnNbaXRlbUlkXSxcblx0XHRcdFx0XHRcdFx0cmVsLFxuXHRcdFx0XHRcdFx0XHRkYXRhW2l0ZW1JZF0sXG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG5cblx0YWRkSXRlbVRvTGlzdChpdGVtOiBULCByZWxhdGlvbnM6IGFueSA9IHt9KSB7XG5cdFx0Y29uc3QgY3R4ID0gdGhpcyxcblx0XHRcdGl0ZW1JZCA9IGdldElkKGl0ZW0pO1xuXG5cdFx0Y3R4LnNhZmVseUFkZEl0ZW0oaXRlbSk7XG5cblx0XHRpZiAoIWN0eC5yZWxhdGlvbnNbaXRlbUlkXSkge1xuXHRcdFx0Y3R4LnJlbGF0aW9ucyA9IF93aXRoKGN0eC5yZWxhdGlvbnMsIGl0ZW1JZCwge30pO1xuXHRcdH1cblxuXHRcdGZvciAoY29uc3QgcmVsIGluIHJlbGF0aW9ucykge1xuXHRcdFx0aWYgKHJlbGF0aW9ucy5oYXNPd25Qcm9wZXJ0eShyZWwpKSB7XG5cdFx0XHRcdGN0eC5yZWxhdGlvbnNbaXRlbUlkXSA9IF93aXRoKFxuXHRcdFx0XHRcdGN0eC5yZWxhdGlvbnNbaXRlbUlkXSxcblx0XHRcdFx0XHRyZWwsXG5cdFx0XHRcdFx0cmVsYXRpb25zW3JlbF0sXG5cdFx0XHRcdCk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG5cblx0cHJpdmF0ZSBzYWZlbHlBZGRJdGVtKGl0ZW06IFQpIHtcblx0XHRjb25zdCBrZXkgPSBnZXRJZChpdGVtKSxcblx0XHRcdGNhY2hlZEl0ZW0gPSB0aGlzLml0ZW1zW2tleV07XG5cblx0XHRpZiAoY2FjaGVkSXRlbSkge1xuXHRcdFx0Y2FjaGVkSXRlbS5kb0h5ZHJhdGUoaXRlbS50b09iamVjdCgpLCB0cnVlKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5pdGVtcyA9IF93aXRoKHRoaXMuaXRlbXMsIGtleSwgaXRlbSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRzZXRTYXZlZCh0YXJnZXQ6IFQsIHJlc3BvbnNlOiBJU2VydmljZVVwZGF0ZVJlc3BvbnNlPFQ+KSB7XG5cdFx0Y29uc3QgaXRlbSA9IHJlc3BvbnNlLmRhdGEuaXRlbTtcblxuXHRcdHRhcmdldC5kb0h5ZHJhdGUoaXRlbS50b09iamVjdCgpLCB0cnVlKTtcblxuXHRcdHRoaXMuc2FmZWx5QWRkSXRlbSh0YXJnZXQpO1xuXHR9XG5cblx0YWRkQ3JlYXRlZChyZXNwb25zZTogSVNlcnZpY2VBZGRSZXNwb25zZTxUPikge1xuXHRcdHRoaXMuc2FmZWx5QWRkSXRlbShyZXNwb25zZS5kYXRhLml0ZW0pO1xuXHR9XG5cblx0c2V0RGVsZXRlZChyZXNwb25zZTogSVNlcnZpY2VEZWxldGVSZXNwb25zZTxUPikge1xuXHRcdGNvbnN0IGl0ZW0gPSByZXNwb25zZS5kYXRhLml0ZW07XG5cdFx0dGhpcy5pdGVtcyA9IF93aXRob3V0KHRoaXMuaXRlbXMsIGdldElkKGl0ZW0pKTtcblx0fVxuXG5cdGl0ZW1SZWxhdGlvbjxaPihpdGVtOiBULCByZWxhdGlvbjogc3RyaW5nKTogWiB8IHVuZGVmaW5lZCB7XG5cdFx0Y29uc3QgaWQgPSBnZXRJZChpdGVtKTtcblx0XHRyZXR1cm4gdGhpcy5yZWxhdGlvbnNbaWRdICYmIHRoaXMucmVsYXRpb25zW2lkXVtyZWxhdGlvbl07XG5cdH1cblxuXHRpZGVudGlmeShpZDogc3RyaW5nLCBjaGVja0NhY2hlOiBib29sZWFuID0gdHJ1ZSk6IFQgfCB1bmRlZmluZWQge1xuXHRcdGNvbnN0IGl0ZW0gPSB0aGlzLml0ZW1zW2lkXTtcblx0XHRsZXQgYztcblxuXHRcdGlmIChpdGVtKSByZXR1cm4gaXRlbTtcblxuXHRcdGlmIChjaGVja0NhY2hlKSB7XG5cdFx0XHRjID0gZ2V0RW50aXR5Q2FjaGUodGhpcy5lbnRpdHkubmFtZSkgYXMgYW55O1xuXG5cdFx0XHRyZXR1cm4gYyAmJiBjW2lkXTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdW5kZWZpbmVkO1xuXHR9XG5cblx0bGlzdChpZHM6IHN0cmluZ1tdID0gW10pIHtcblx0XHRjb25zdCBsaXN0OiBUW10gPSBbXSxcblx0XHRcdGxlbiA9IGlkcy5sZW5ndGg7XG5cdFx0aWYgKGxlbikge1xuXHRcdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkrKykge1xuXHRcdFx0XHRjb25zdCBpZCA9IGlkc1tpXSxcblx0XHRcdFx0XHRpdGVtID0gdGhpcy5pZGVudGlmeShpZCk7XG5cdFx0XHRcdGlmIChpdGVtKSB7XG5cdFx0XHRcdFx0bGlzdC5wdXNoKGl0ZW0pO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fSBlbHNlIHtcblx0XHRcdGZvciAoY29uc3Qga2V5IGluIHRoaXMuaXRlbXMpIHtcblx0XHRcdFx0aWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLml0ZW1zLCBrZXkpKSB7XG5cdFx0XHRcdFx0bGlzdC5wdXNoKHRoaXMuaXRlbXNba2V5XSk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gbGlzdDtcblx0fVxuXG5cdG9yZGVyQnkob3JkZXJGbjogdEVudGl0aWVzT3JkZXJCeUNiPFQ+KTogVFtdIHtcblx0XHRjb25zdCBrZXlzID0gT2JqZWN0LmtleXModGhpcy5pdGVtcyk7XG5cblx0XHRyZXR1cm4ga2V5cy5tYXAoKGtleSkgPT4gdGhpcy5pdGVtc1trZXldKS5zb3J0KG9yZGVyRm4pO1xuXHR9XG5cblx0b3JkZXJCeVZhbHVlT2YoY29sdW1uOiBzdHJpbmcpOiBUW10ge1xuXHRcdHJldHVybiB0aGlzLm9yZGVyQnkoKGE6IGFueSwgYjogYW55KSA9PiB7XG5cdFx0XHRyZXR1cm4gYVtjb2x1bW5dIC0gYltjb2x1bW5dO1xuXHRcdH0pO1xuXHR9XG5cblx0c2VsZWN0KFxuXHRcdGxpc3Q6IFRbXSA9IHRoaXMubGlzdCgpLFxuXHRcdHByZWRpY2F0ZTogKHZhbHVlOiBULCBpbmRleDogbnVtYmVyKSA9PiBib29sZWFuLFxuXHRcdG1heCA9IEluZmluaXR5LFxuXHQpOiBUW10ge1xuXHRcdGNvbnN0IHJlc3VsdDogVFtdID0gW10sXG5cdFx0XHRsZW4gPSBsaXN0Lmxlbmd0aDtcblxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgbGVuICYmIHJlc3VsdC5sZW5ndGggPCBtYXg7IGkrKykge1xuXHRcdFx0aWYgKHByZWRpY2F0ZShsaXN0W2ldLCBpKSkge1xuXHRcdFx0XHRyZXN1bHQucHVzaChsaXN0W2ldKTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gcmVzdWx0O1xuXHR9XG5cblx0c2VhcmNoKFxuXHRcdGxpc3Q6IFRbXSA9IHRoaXMubGlzdCgpLFxuXHRcdHNlYXJjaDogc3RyaW5nLFxuXHRcdHN0cmluZ0J1aWxkZXI6ICh2YWx1ZTogVCwgaW5kZXg6IG51bWJlcikgPT4gc3RyaW5nLFxuXHQpOiBUW10ge1xuXHRcdGlmICghKHNlYXJjaCA9IHNlYXJjaC50cmltKCkpLmxlbmd0aCkge1xuXHRcdFx0cmV0dXJuIGxpc3Q7XG5cdFx0fVxuXG5cdFx0Y29uc3QgcmVnID0gbmV3IFJlZ0V4cChlc2NhcGVSZWdFeHAoc2VhcmNoKSwgJ2knKTtcblxuXHRcdHJldHVybiBsaXN0LmZpbHRlcigoaXRlbTogYW55LCBpbmRleDogbnVtYmVyKSA9PiB7XG5cdFx0XHRjb25zdCB2ID0gc3RyaW5nQnVpbGRlcihpdGVtLCBpbmRleCk7XG5cdFx0XHRyZXR1cm4gcmVnLnRlc3Qodik7XG5cdFx0fSk7XG5cdH1cblxuXHR0b3RhbENvdW50KCk6IG51bWJlciB7XG5cdFx0cmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuaXRlbXMpLmxlbmd0aDtcblx0fVxufVxuIl19