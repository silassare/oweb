import { getEntityCache } from 'gobl-utils-ts';
import { escapeRegExp, isPlainObject, logger } from './utils/Utils';
import OWebService from './OWebService';
const getId = (item) => item.singlePKValue();
const _with = (target, key, item) => {
    return { ...target, [key]: item };
}, _without = (target, key) => {
    delete target[key];
    return { ...target };
};
export default class OWebServiceStore extends OWebService {
    constructor(appContext, entity, service) {
        super(appContext, service);
        this.entity = entity;
        this.items = {};
        this.relations = {};
    }
    getItem(id, relations = '') {
        const ctx = this;
        return ctx
            .getRequest(id, relations)
            .onGoodNews(function (response) {
            ctx.addItemToList(response.json.data.item, response.json.data.relations);
        })
            .send();
    }
    getAllItems(options = {}) {
        const ctx = this;
        return ctx
            .getAllRequest(options)
            .onGoodNews(function (response) {
            ctx.addItemsToList(response.json.data.items, response.json.data.relations);
        })
            .send();
    }
    addItem(data) {
        const ctx = this;
        return ctx
            .addRequest(data)
            .onGoodNews(function (response) {
            ctx.addCreated(response.json);
        })
            .send();
    }
    updateItem(item, freeze = true) {
        const ctx = this, id = getId(item);
        if (!item.isSaved()) {
            const diff = item.toObject(true);
            item.isSaving(true);
            return ctx
                .updateRequest(id, diff)
                .onGoodNews(function (response) {
                ctx.setSaved(item, response.json);
            })
                .onFinished(function () {
                item.isSaving(false);
            })
                .send();
        }
        logger.error('not updated', item);
        return false;
    }
    deleteItem(item) {
        const ctx = this, id = getId(item);
        item.isDeleting(true);
        return ctx
            .deleteRequest(id)
            .onGoodNews(function (response) {
            ctx.setDeleted(response.json);
        })
            .onFinished(function () {
            item.isDeleting(false);
        })
            .send();
    }
    addItemsToList(items, relations = {}) {
        const ctx = this, list = (isPlainObject(items)
            ? Object.values(items)
            : items || []);
        list.forEach((item) => {
            const itemId = getId(item);
            ctx.safelyAddItem(item);
            if (!ctx.relations[itemId]) {
                ctx.relations = _with(ctx.relations, itemId, {});
            }
            for (const rel in relations) {
                if (relations.hasOwnProperty(rel)) {
                    const data = relations[rel];
                    if (data[itemId]) {
                        ctx.relations[itemId] = _with(ctx.relations[itemId], rel, data[itemId]);
                    }
                }
            }
        });
    }
    addItemToList(item, relations = {}) {
        const ctx = this, itemId = getId(item);
        ctx.safelyAddItem(item);
        if (!ctx.relations[itemId]) {
            ctx.relations = _with(ctx.relations, itemId, {});
        }
        for (const rel in relations) {
            if (relations.hasOwnProperty(rel)) {
                ctx.relations[itemId] = _with(ctx.relations[itemId], rel, relations[rel]);
            }
        }
    }
    safelyAddItem(item) {
        const key = getId(item), cachedItem = this.items[key];
        if (cachedItem) {
            cachedItem.doHydrate(item.toObject(), true);
        }
        else {
            this.items = _with(this.items, key, item);
        }
        return this;
    }
    setSaved(target, response) {
        const item = response.data.item;
        target.doHydrate(item.toObject(), true);
        this.safelyAddItem(target);
    }
    addCreated(response) {
        this.safelyAddItem(response.data.item);
    }
    setDeleted(response) {
        const item = response.data.item;
        this.items = _without(this.items, getId(item));
    }
    itemRelation(item, relation) {
        const id = getId(item);
        return this.relations[id] && this.relations[id][relation];
    }
    identify(id, checkCache = true) {
        const item = this.items[id];
        let c;
        if (item)
            return item;
        if (checkCache) {
            c = getEntityCache(this.entity.name);
            return c && c[id];
        }
        return undefined;
    }
    list(ids = []) {
        const list = [], len = ids.length;
        if (len) {
            for (let i = 0; i < len; i++) {
                const id = ids[i], item = this.identify(id);
                if (item) {
                    list.push(item);
                }
            }
        }
        else {
            for (const key in this.items) {
                if (Object.prototype.hasOwnProperty.call(this.items, key)) {
                    list.push(this.items[key]);
                }
            }
        }
        return list;
    }
    orderBy(orderFn) {
        const keys = Object.keys(this.items);
        return keys.map((key) => this.items[key]).sort(orderFn);
    }
    orderByValueOf(column) {
        return this.orderBy((a, b) => {
            return a[column] - b[column];
        });
    }
    select(list = this.list(), predicate, max = Infinity) {
        const result = [], len = list.length;
        for (let i = 0; i < len && result.length < max; i++) {
            if (predicate(list[i], i)) {
                result.push(list[i]);
            }
        }
        return result;
    }
    search(list = this.list(), search, stringBuilder) {
        if (!(search = search.trim()).length) {
            return list;
        }
        const reg = new RegExp(escapeRegExp(search), 'i');
        return list.filter((item, index) => {
            const v = stringBuilder(item, index);
            return reg.test(v);
        });
    }
    totalCount() {
        return Object.keys(this.items).length;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlNlcnZpY2VTdG9yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViU2VydmljZVN0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBc0IsY0FBYyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBUW5FLE9BQU8sRUFBRSxZQUFZLEVBQUUsYUFBYSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNwRSxPQUFPLFdBQVcsTUFBTSxlQUFlLENBQUM7QUFJeEMsTUFBTSxLQUFLLEdBQUcsQ0FBQyxJQUF3QixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7QUFFakUsTUFBTSxLQUFLLEdBQUcsQ0FBQyxNQUFXLEVBQUUsR0FBb0IsRUFBRSxJQUFTLEVBQUUsRUFBRTtJQUM3RCxPQUFPLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQztBQUNuQyxDQUFDLEVBQ0QsUUFBUSxHQUFHLENBQUMsTUFBVyxFQUFFLEdBQW9CLEVBQUUsRUFBRTtJQUNoRCxPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNuQixPQUFPLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQztBQUN0QixDQUFDLENBQUM7QUFFSCxNQUFNLENBQUMsT0FBTyxPQUFPLGdCQUVuQixTQUFRLFdBQWM7SUFJdkIsWUFDQyxVQUFtQixFQUNGLE1BQWlDLEVBQ2xELE9BQWU7UUFFZixLQUFLLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBSFYsV0FBTSxHQUFOLE1BQU0sQ0FBMkI7UUFMekMsVUFBSyxHQUF5QixFQUFFLENBQUM7UUFDakMsY0FBUyxHQUEyQixFQUFFLENBQUM7SUFRakQsQ0FBQztJQUVELE9BQU8sQ0FBQyxFQUFVLEVBQUUsWUFBb0IsRUFBRTtRQUN6QyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUM7UUFFakIsT0FBTyxHQUFHO2FBQ1Is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R0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsSUFBSSxNQUFNLENBQUMsTUFBTSxHQUFHLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNwRCxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUU7Z0JBQzFCLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDckI7U0FDRDtRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2YsQ0FBQztJQUVELE1BQU0sQ0FDTCxPQUFZLElBQUksQ0FBQyxJQUFJLEVBQUUsRUFDdkIsTUFBYyxFQUNkLGFBQWtEO1FBRWxELElBQUksQ0FBQyxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUU7WUFDckMsT0FBTyxJQUFJLENBQUM7U0FDWjtRQUVELE1BQU0sR0FBRyxHQUFHLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUVsRCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFTLEVBQUUsS0FBYSxFQUFFLEVBQUU7WUFDL0MsTUFBTSxDQUFDLEdBQUcsYUFBYSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNyQyxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEIsQ0FBQyxDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQsVUFBVTtRQUNULE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQ3ZDLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEdvYmxTaW5nbGVQS0VudGl0eSwgZ2V0RW50aXR5Q2FjaGUgfSBmcm9tICdnb2JsLXV0aWxzLXRzJztcbmltcG9ydCB7XG5cdElPWm9uZUFwaUFkZFJlc3BvbnNlLFxuXHRJT1pvbmVBcGlEZWxldGVSZXNwb25zZSxcblx0SU9ab25lQXBpVXBkYXRlUmVzcG9uc2UsXG5cdElPWm9uZUFwaVJlcXVlc3RPcHRpb25zLFxufSBmcm9tICcuL296b25lJztcbmltcG9ydCBPV2ViQXBwIGZyb20gJy4vT1dlYkFwcCc7XG5pbXBvcnQgeyBlc2NhcGVSZWdFeHAsIGlzUGxhaW5PYmplY3QsIGxvZ2dlciB9IGZyb20gJy4vdXRpbHMvVXRpbHMnO1xuaW1wb3J0IE9XZWJTZXJ2aWNlIGZyb20gJy4vT1dlYlNlcnZpY2UnO1xuXG5leHBvcnQgdHlwZSB0RW50aXRpZXNPcmRlckJ5Q2I8VD4gPSAoYTogVCwgYjogVCkgPT4gbnVtYmVyO1xuXG5jb25zdCBnZXRJZCA9IChpdGVtOiBHb2JsU2luZ2xlUEtFbnRpdHkpID0+IGl0ZW0uc2luZ2xlUEtWYWx1ZSgpO1xuXG5jb25zdCBfd2l0aCA9ICh0YXJnZXQ6IGFueSwga2V5OiBzdHJpbmcgfCBudW1iZXIsIGl0ZW06IGFueSkgPT4ge1xuXHRcdHJldHVybiB7IC4uLnRhcmdldCwgW2tleV06IGl0ZW0gfTtcblx0fSxcblx0X3dpdGhvdXQgPSAodGFyZ2V0OiBhbnksIGtleTogc3RyaW5nIHwgbnVtYmVyKSA9PiB7XG5cdFx0ZGVsZXRlIHRhcmdldFtrZXldO1xuXHRcdHJldHVybiB7IC4uLnRhcmdldCB9O1xuXHR9O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViU2VydmljZVN0b3JlPFxuXHRUIGV4dGVuZHMgR29ibFNpbmdsZVBLRW50aXR5XG4+IGV4dGVuZHMgT1dlYlNlcnZpY2U8VD4ge1xuXHRwcm90ZWN0ZWQgaXRlbXM6IHsgW2tleTogc3RyaW5nXTogVCB9ID0ge307XG5cdHByb3RlY3RlZCByZWxhdGlvbnM6IHsgW2tleTogc3RyaW5nXTogYW55IH0gPSB7fTtcblxuXHRjb25zdHJ1Y3Rvcihcblx0XHRhcHBDb250ZXh0OiBPV2ViQXBwLFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgZW50aXR5OiB0eXBlb2YgR29ibFNpbmdsZVBLRW50aXR5LFxuXHRcdHNlcnZpY2U6IHN0cmluZyxcblx0KSB7XG5cdFx0c3VwZXIoYXBwQ29udGV4dCwgc2VydmljZSk7XG5cdH1cblxuXHRnZXRJdGVtKGlkOiBzdHJpbmcsIHJlbGF0aW9uczogc3RyaW5nID0gJycpIHtcblx0XHRjb25zdCBjdHggPSB0aGlzO1xuXG5cdFx0cmV0dXJuIGN0eFxuXHRcdFx0LmdldFJlcXVlc3QoaWQsIHJlbGF0aW9ucylcblx0XHRcdC5vbkdvb2ROZXdzKGZ1bmN0aW9uIChyZXNwb25zZSkge1xuXHRcdFx0XHRjdHguYWRkSXRlbVRvTGlzdChcblx0XHRcdFx0XHRyZXNwb25zZS5qc29uIS5kYXRhLml0ZW0sXG5cdFx0XHRcdFx0cmVzcG9uc2UuanNvbiEuZGF0YS5yZWxhdGlvbnMsXG5cdFx0XHRcdCk7XG5cdFx0XHR9KVxuXHRcdFx0LnNlbmQoKTtcblx0fVxuXG5cdGdldEFsbEl0ZW1zKG9wdGlvbnM6IElPWm9uZUFwaVJlcXVlc3RPcHRpb25zID0ge30pIHtcblx0XHRjb25zdCBjdHggPSB0aGlzO1xuXG5cdFx0cmV0dXJuIGN0eFxuXHRcdFx0LmdldEFsbFJlcXVlc3Qob3B0aW9ucylcblx0XHRcdC5vbkdvb2ROZXdzKGZ1bmN0aW9uIChyZXNwb25zZSkge1xuXHRcdFx0XHRjdHguYWRkSXRlbXNUb0xpc3QoXG5cdFx0XHRcdFx0cmVzcG9uc2UuanNvbiEuZGF0YS5pdGVtcyxcblx0XHRcdFx0XHRyZXNwb25zZS5qc29uIS5kYXRhLnJlbGF0aW9ucyxcblx0XHRcdFx0KTtcblx0XHRcdH0pXG5cdFx0XHQuc2VuZCgpO1xuXHR9XG5cblx0YWRkSXRlbShkYXRhOiBhbnkpIHtcblx0XHRjb25zdCBjdHggPSB0aGlzO1xuXHRcdHJldHVybiBjdHhcblx0XHRcdC5hZGRSZXF1ZXN0KGRhdGEpXG5cdFx0XHQub25Hb29kTmV3cyhmdW5jdGlvbiAocmVzcG9uc2UpIHtcblx0XHRcdFx0Y3R4LmFkZENyZWF0ZWQocmVzcG9uc2UuanNvbiEpO1xuXHRcdFx0fSlcblx0XHRcdC5zZW5kKCk7XG5cdH1cblxuXHR1cGRhdGVJdGVtKGl0ZW06IFQsIGZyZWV6ZTogYm9vbGVhbiA9IHRydWUpIHtcblx0XHRjb25zdCBjdHggPSB0aGlzLFxuXHRcdFx0aWQgPSBnZXRJZChpdGVtKTtcblxuXHRcdGlmICghaXRlbS5pc1NhdmVkKCkpIHtcblx0XHRcdGNvbnN0IGRpZmYgPSBpdGVtLnRvT2JqZWN0KHRydWUpO1xuXG5cdFx0XHRpdGVtLmlzU2F2aW5nKHRydWUpO1xuXG5cdFx0XHRyZXR1cm4gY3R4XG5cdFx0XHRcdC51cGRhdGVSZXF1ZXN0KGlkLCBkaWZmKVxuXHRcdFx0XHQub25Hb29kTmV3cyhmdW5jdGlvbiAocmVzcG9uc2UpIHtcblx0XHRcdFx0XHRjdHguc2V0U2F2ZWQoaXRlbSwgcmVzcG9uc2UuanNvbiEpO1xuXHRcdFx0XHR9KVxuXHRcdFx0XHQub25GaW5pc2hlZChmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdFx0aXRlbS5pc1NhdmluZyhmYWxzZSk7XG5cdFx0XHRcdH0pXG5cdFx0XHRcdC5zZW5kKCk7XG5cdFx0fVxuXG5cdFx0bG9nZ2VyLmVycm9yKCdub3QgdXBkYXRlZCcsIGl0ZW0pO1xuXG5cdFx0cmV0dXJuIGZhbHNlO1xuXHR9XG5cblx0ZGVsZXRlSXRlbShpdGVtOiBUKSB7XG5cdFx0Y29uc3QgY3R4ID0gdGhpcyxcblx0XHRcdGlkID0gZ2V0SWQoaXRlbSk7XG5cblx0XHRpdGVtLmlzRGVsZXRpbmcodHJ1ZSk7XG5cblx0XHRyZXR1cm4gY3R4XG5cdFx0XHQuZGVsZXRlUmVxdWVzdChpZClcblx0XHRcdC5vbkdvb2ROZXdzKGZ1bmN0aW9uIChyZXNwb25zZSkge1xuXHRcdFx0XHRjdHguc2V0RGVsZXRlZChyZXNwb25zZS5qc29uISk7XG5cdFx0XHR9KVxuXHRcdFx0Lm9uRmluaXNoZWQoZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRpdGVtLmlzRGVsZXRpbmcoZmFsc2UpO1xuXHRcdFx0fSlcblx0XHRcdC5zZW5kKCk7XG5cdH1cblxuXHRhZGRJdGVtc1RvTGlzdChpdGVtczogVFtdIHwgeyBba2V5OiBzdHJpbmddOiBUIH0sIHJlbGF0aW9uczogYW55ID0ge30pIHtcblx0XHRjb25zdCBjdHggPSB0aGlzLFxuXHRcdFx0bGlzdDogVFtdID0gKGlzUGxhaW5PYmplY3QoaXRlbXMpXG5cdFx0XHRcdD8gT2JqZWN0LnZhbHVlcyhpdGVtcylcblx0XHRcdFx0OiBpdGVtcyB8fCBbXSkgYXMgVFtdO1xuXG5cdFx0bGlzdC5mb3JFYWNoKChpdGVtKSA9PiB7XG5cdFx0XHRjb25zdCBpdGVtSWQgPSBnZXRJZChpdGVtKTtcblxuXHRcdFx0Y3R4LnNhZmVseUFkZEl0ZW0oaXRlbSk7XG5cblx0XHRcdGlmICghY3R4LnJlbGF0aW9uc1tpdGVtSWRdKSB7XG5cdFx0XHRcdGN0eC5yZWxhdGlvbnMgPSBfd2l0aChjdHgucmVsYXRpb25zLCBpdGVtSWQsIHt9KTtcblx0XHRcdH1cblxuXHRcdFx0Zm9yIChjb25zdCByZWwgaW4gcmVsYXRpb25zKSB7XG5cdFx0XHRcdGlmIChyZWxhdGlvbnMuaGFzT3duUHJvcGVydHkocmVsKSkge1xuXHRcdFx0XHRcdGNvbnN0IGRhdGEgPSByZWxhdGlvbnNbcmVsXTtcblxuXHRcdFx0XHRcdGlmIChkYXRhW2l0ZW1JZF0pIHtcblx0XHRcdFx0XHRcdGN0eC5yZWxhdGlvbnNbaXRlbUlkXSA9IF93aXRoKFxuXHRcdFx0XHRcdFx0XHRjdHgucmVsYXRpb25zW2l0ZW1JZF0sXG5cdFx0XHRcdFx0XHRcdHJlbCxcblx0XHRcdFx0XHRcdFx0ZGF0YVtpdGVtSWRdLFxuXHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9KTtcblx0fVxuXG5cdGFkZEl0ZW1Ub0xpc3QoaXRlbTogVCwgcmVsYXRpb25zOiBhbnkgPSB7fSkge1xuXHRcdGNvbnN0IGN0eCA9IHRoaXMsXG5cdFx0XHRpdGVtSWQgPSBnZXRJZChpdGVtKTtcblxuXHRcdGN0eC5zYWZlbHlBZGRJdGVtKGl0ZW0pO1xuXG5cdFx0aWYgKCFjdHgucmVsYXRpb25zW2l0ZW1JZF0pIHtcblx0XHRcdGN0eC5yZWxhdGlvbnMgPSBfd2l0aChjdHgucmVsYXRpb25zLCBpdGVtSWQsIHt9KTtcblx0XHR9XG5cblx0XHRmb3IgKGNvbnN0IHJlbCBpbiByZWxhdGlvbnMpIHtcblx0XHRcdGlmIChyZWxhdGlvbnMuaGFzT3duUHJvcGVydHkocmVsKSkge1xuXHRcdFx0XHRjdHgucmVsYXRpb25zW2l0ZW1JZF0gPSBfd2l0aChcblx0XHRcdFx0XHRjdHgucmVsYXRpb25zW2l0ZW1JZF0sXG5cdFx0XHRcdFx0cmVsLFxuXHRcdFx0XHRcdHJlbGF0aW9uc1tyZWxdLFxuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgc2FmZWx5QWRkSXRlbShpdGVtOiBUKSB7XG5cdFx0Y29uc3Qga2V5ID0gZ2V0SWQoaXRlbSksXG5cdFx0XHRjYWNoZWRJdGVtID0gdGhpcy5pdGVtc1trZXldO1xuXG5cdFx0aWYgKGNhY2hlZEl0ZW0pIHtcblx0XHRcdGNhY2hlZEl0ZW0uZG9IeWRyYXRlKGl0ZW0udG9PYmplY3QoKSwgdHJ1ZSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRoaXMuaXRlbXMgPSBfd2l0aCh0aGlzLml0ZW1zLCBrZXksIGl0ZW0pO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0c2V0U2F2ZWQodGFyZ2V0OiBULCByZXNwb25zZTogSU9ab25lQXBpVXBkYXRlUmVzcG9uc2U8VD4pIHtcblx0XHRjb25zdCBpdGVtID0gcmVzcG9uc2UuZGF0YS5pdGVtO1xuXG5cdFx0dGFyZ2V0LmRvSHlkcmF0ZShpdGVtLnRvT2JqZWN0KCksIHRydWUpO1xuXG5cdFx0dGhpcy5zYWZlbHlBZGRJdGVtKHRhcmdldCk7XG5cdH1cblxuXHRhZGRDcmVhdGVkKHJlc3BvbnNlOiBJT1pvbmVBcGlBZGRSZXNwb25zZTxUPikge1xuXHRcdHRoaXMuc2FmZWx5QWRkSXRlbShyZXNwb25zZS5kYXRhLml0ZW0pO1xuXHR9XG5cblx0c2V0RGVsZXRlZChyZXNwb25zZTogSU9ab25lQXBpRGVsZXRlUmVzcG9uc2U8VD4pIHtcblx0XHRjb25zdCBpdGVtID0gcmVzcG9uc2UuZGF0YS5pdGVtO1xuXHRcdHRoaXMuaXRlbXMgPSBfd2l0aG91dCh0aGlzLml0ZW1zLCBnZXRJZChpdGVtKSk7XG5cdH1cblxuXHRpdGVtUmVsYXRpb248Wj4oaXRlbTogVCwgcmVsYXRpb246IHN0cmluZyk6IFogfCB1bmRlZmluZWQge1xuXHRcdGNvbnN0IGlkID0gZ2V0SWQoaXRlbSk7XG5cdFx0cmV0dXJuIHRoaXMucmVsYXRpb25zW2lkXSAmJiB0aGlzLnJlbGF0aW9uc1tpZF1bcmVsYXRpb25dO1xuXHR9XG5cblx0aWRlbnRpZnkoaWQ6IHN0cmluZywgY2hlY2tDYWNoZTogYm9vbGVhbiA9IHRydWUpOiBUIHwgdW5kZWZpbmVkIHtcblx0XHRjb25zdCBpdGVtID0gdGhpcy5pdGVtc1tpZF07XG5cdFx0bGV0IGM7XG5cblx0XHRpZiAoaXRlbSkgcmV0dXJuIGl0ZW07XG5cblx0XHRpZiAoY2hlY2tDYWNoZSkge1xuXHRcdFx0YyA9IGdldEVudGl0eUNhY2hlKHRoaXMuZW50aXR5Lm5hbWUpIGFzIGFueTtcblxuXHRcdFx0cmV0dXJuIGMgJiYgY1tpZF07XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHVuZGVmaW5lZDtcblx0fVxuXG5cdGxpc3QoaWRzOiBzdHJpbmdbXSA9IFtdKSB7XG5cdFx0Y29uc3QgbGlzdDogVFtdID0gW10sXG5cdFx0XHRsZW4gPSBpZHMubGVuZ3RoO1xuXHRcdGlmIChsZW4pIHtcblx0XHRcdGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHtcblx0XHRcdFx0Y29uc3QgaWQgPSBpZHNbaV0sXG5cdFx0XHRcdFx0aXRlbSA9IHRoaXMuaWRlbnRpZnkoaWQpO1xuXHRcdFx0XHRpZiAoaXRlbSkge1xuXHRcdFx0XHRcdGxpc3QucHVzaChpdGVtKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH0gZWxzZSB7XG5cdFx0XHRmb3IgKGNvbnN0IGtleSBpbiB0aGlzLml0ZW1zKSB7XG5cdFx0XHRcdGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcy5pdGVtcywga2V5KSkge1xuXHRcdFx0XHRcdGxpc3QucHVzaCh0aGlzLml0ZW1zW2tleV0pO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGxpc3Q7XG5cdH1cblxuXHRvcmRlckJ5KG9yZGVyRm46IHRFbnRpdGllc09yZGVyQnlDYjxUPik6IFRbXSB7XG5cdFx0Y29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuaXRlbXMpO1xuXG5cdFx0cmV0dXJuIGtleXMubWFwKChrZXkpID0+IHRoaXMuaXRlbXNba2V5XSkuc29ydChvcmRlckZuKTtcblx0fVxuXG5cdG9yZGVyQnlWYWx1ZU9mKGNvbHVtbjogc3RyaW5nKTogVFtdIHtcblx0XHRyZXR1cm4gdGhpcy5vcmRlckJ5KChhOiBhbnksIGI6IGFueSkgPT4ge1xuXHRcdFx0cmV0dXJuIGFbY29sdW1uXSAtIGJbY29sdW1uXTtcblx0XHR9KTtcblx0fVxuXG5cdHNlbGVjdChcblx0XHRsaXN0OiBUW10gPSB0aGlzLmxpc3QoKSxcblx0XHRwcmVkaWNhdGU6ICh2YWx1ZTogVCwgaW5kZXg6IG51bWJlcikgPT4gYm9vbGVhbixcblx0XHRtYXggPSBJbmZpbml0eSxcblx0KTogVFtdIHtcblx0XHRjb25zdCByZXN1bHQ6IFRbXSA9IFtdLFxuXHRcdFx0bGVuID0gbGlzdC5sZW5ndGg7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGxlbiAmJiByZXN1bHQubGVuZ3RoIDwgbWF4OyBpKyspIHtcblx0XHRcdGlmIChwcmVkaWNhdGUobGlzdFtpXSwgaSkpIHtcblx0XHRcdFx0cmVzdWx0LnB1c2gobGlzdFtpXSk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHJlc3VsdDtcblx0fVxuXG5cdHNlYXJjaChcblx0XHRsaXN0OiBUW10gPSB0aGlzLmxpc3QoKSxcblx0XHRzZWFyY2g6IHN0cmluZyxcblx0XHRzdHJpbmdCdWlsZGVyOiAodmFsdWU6IFQsIGluZGV4OiBudW1iZXIpID0+IHN0cmluZyxcblx0KTogVFtdIHtcblx0XHRpZiAoIShzZWFyY2ggPSBzZWFyY2gudHJpbSgpKS5sZW5ndGgpIHtcblx0XHRcdHJldHVybiBsaXN0O1xuXHRcdH1cblxuXHRcdGNvbnN0IHJlZyA9IG5ldyBSZWdFeHAoZXNjYXBlUmVnRXhwKHNlYXJjaCksICdpJyk7XG5cblx0XHRyZXR1cm4gbGlzdC5maWx0ZXIoKGl0ZW06IGFueSwgaW5kZXg6IG51bWJlcikgPT4ge1xuXHRcdFx0Y29uc3QgdiA9IHN0cmluZ0J1aWxkZXIoaXRlbSwgaW5kZXgpO1xuXHRcdFx0cmV0dXJuIHJlZy50ZXN0KHYpO1xuXHRcdH0pO1xuXHR9XG5cblx0dG90YWxDb3VudCgpOiBudW1iZXIge1xuXHRcdHJldHVybiBPYmplY3Qua2V5cyh0aGlzLml0ZW1zKS5sZW5ndGg7XG5cdH1cbn1cbiJdfQ==