import { GoblEntity } from 'gobl-utils-ts';
import OWebService from './OWebService';
import { escapeRegExp, isPlainObject, noop } from './utils/Utils';
const getId = (item) => item.singlePKValue();
const _with = (target, key, item) => {
    return { ...target, [key]: item };
}, _without = (target, key) => {
    delete target[key];
    return { ...target };
};
export default class OWebServiceStore extends OWebService {
    constructor(appContext, entity, serviceName, persistentCache = false) {
        super(appContext, serviceName, persistentCache);
        this.entity = entity;
        this.items = {};
        this.relations = {};
    }
    getItem(id, relations = '', then, fail, freeze = true, loadCacheFirst = false) {
        const ctx = this;
        return ctx.getRequest(id, relations, (response, fromCache) => {
            ctx.addItemToList(response.data.item, response.data.relations);
            then && then(response, fromCache);
        }, fail || noop, freeze, loadCacheFirst);
    }
    getAllItems(options = {}, then, fail, freeze = true, forceCache = true) {
        const ctx = this;
        return ctx.getAllRequest(options, (response, fromCache) => {
            ctx.addItemsToList(response.data.items, response.data.relations);
            then && then(response, fromCache);
        }, fail || noop, freeze, forceCache);
    }
    addItem(data, then, fail, freeze = true) {
        const ctx = this;
        return ctx.addRequest(data, (result) => {
            ctx.addCreated(result);
            then && then(result);
        }, fail || noop, freeze);
    }
    updateItem(item, then, fail, freeze = true) {
        const ctx = this, id = getId(item);
        if (!item.isSaved()) {
            const diff = item.toObject(true);
            item.isSaving(true);
            return ctx.updateRequest(id, diff, (result) => {
                item.isSaving(false);
                ctx.setSaved(item, result);
                then && then(result);
            }, (response, com) => {
                item.isSaving(false);
                fail && fail(response, com);
            }, freeze);
        }
        console.error('Not modified ->', item);
        return false;
    }
    deleteItem(item, then, fail, freeze = true) {
        const ctx = this, id = getId(item);
        item.isDeleting(true);
        return ctx.deleteRequest(id, (result) => {
            item.isDeleting(false);
            ctx.setDeleted(result);
            then && then(result);
        }, (response, com) => {
            item.isDeleting(false);
            fail && fail(response, com);
        }, freeze);
    }
    addItemsToList(items, relations = {}) {
        const ctx = this, list = (isPlainObject(items)
            ? Object.values(items)
            : items || []);
        list.forEach((item) => {
            const itemId = getId(item);
            ctx.safelyAddItem(item);
            if (!ctx.relations[itemId]) {
                ctx.relations = _with(ctx.relations, itemId, {});
            }
            for (const rel in relations) {
                if (relations.hasOwnProperty(rel)) {
                    const data = relations[rel];
                    if (data[itemId]) {
                        ctx.relations[itemId] = _with(ctx.relations[itemId], rel, data[itemId]);
                    }
                }
            }
        });
    }
    addItemToList(item, relations = {}) {
        const ctx = this, itemId = getId(item);
        ctx.safelyAddItem(item);
        if (!ctx.relations[itemId]) {
            ctx.relations = _with(ctx.relations, itemId, {});
        }
        for (const rel in relations) {
            if (relations.hasOwnProperty(rel)) {
                ctx.relations[itemId] = _with(ctx.relations[itemId], rel, relations[rel]);
            }
        }
    }
    safelyAddItem(item) {
        const key = getId(item), cachedItem = this.items[key];
        if (cachedItem) {
            cachedItem.doHydrate(item.toObject(), true);
        }
        else {
            this.items = _with(this.items, key, item);
        }
        return this;
    }
    setSaved(target, response) {
        const item = response.data.item;
        target.doHydrate(item.toObject(), true);
        this.safelyAddItem(target);
    }
    addCreated(response) {
        this.safelyAddItem(response.data.item);
    }
    setDeleted(response) {
        const item = response.data.item;
        this.items = _without(this.items, getId(item));
    }
    itemRelation(item, relation) {
        const id = getId(item);
        return this.relations[id] && this.relations[id][relation];
    }
    identify(id, checkCache = true) {
        const item = this.items[id];
        let c;
        if (item)
            return item;
        if (checkCache) {
            c = GoblEntity.subCache(this.entity.name);
            return c && c[id];
        }
        return undefined;
    }
    list(ids = []) {
        const list = [], len = ids.length;
        if (len) {
            for (let i = 0; i < len; i++) {
                const id = ids[i], item = this.identify(id);
                if (item) {
                    list.push(item);
                }
            }
        }
        else {
            for (const key in this.items) {
                if (Object.prototype.hasOwnProperty.call(this.items, key)) {
                    list.push(this.items[key]);
                }
            }
        }
        return list;
    }
    orderBy(orderFn) {
        const keys = Object.keys(this.items);
        return keys.map((key) => this.items[key]).sort(orderFn);
    }
    orderByValueOf(column) {
        return this.orderBy((a, b) => {
            return a[column] - b[column];
        });
    }
    select(list = this.list(), predicate, max = Infinity) {
        const result = [], len = list.length;
        for (let i = 0; i < len && result.length < max; i++) {
            if (predicate(list[i], i)) {
                result.push(list[i]);
            }
        }
        return result;
    }
    search(list = this.list(), search, stringBuilder) {
        if (!(search = search.trim()).length) {
            return list;
        }
        const reg = new RegExp(escapeRegExp(search), 'i');
        return list.filter((item, index) => {
            const v = stringBuilder(item, index);
            return reg.test(v);
        });
    }
    totalCount() {
        return Object.keys(this.items).length;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlNlcnZpY2VTdG9yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9PV2ViU2VydmljZVN0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQXNCLE1BQU0sZUFBZSxDQUFDO0FBQy9ELE9BQU8sV0FXTixNQUFNLGVBQWUsQ0FBQztBQUd2QixPQUFPLEVBQUUsWUFBWSxFQUFFLGFBQWEsRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFJbEUsTUFBTSxLQUFLLEdBQUcsQ0FBQyxJQUF3QixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7QUFFakUsTUFBTSxLQUFLLEdBQUcsQ0FBQyxNQUFXLEVBQUUsR0FBb0IsRUFBRSxJQUFTLEVBQUUsRUFBRTtJQUM3RCxPQUFPLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQztBQUNuQyxDQUFDLEVBQ0QsUUFBUSxHQUFHLENBQUMsTUFBVyxFQUFFLEdBQW9CLEVBQUUsRUFBRTtJQUNoRCxPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNuQixPQUFPLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQztBQUN0QixDQUFDLENBQUM7QUFFSCxNQUFNLENBQUMsT0FBTyxPQUFPLGdCQUVuQixTQUFRLFdBQWM7SUFJdkIsWUFDQyxVQUFtQixFQUNGLE1BQWlDLEVBQ2xELFdBQW1CLEVBQ25CLGtCQUEyQixLQUFLO1FBRWhDLEtBQUssQ0FBQyxVQUFVLEVBQUUsV0FBVyxFQUFFLGVBQWUsQ0FBQyxDQUFDO1FBSi9CLFdBQU0sR0FBTixNQUFNLENBQTJCO1FBTHpDLFVBQUssR0FBeUIsRUFBRSxDQUFDO1FBQ2pDLGNBQVMsR0FBMkIsRUFBRSxDQUFDO0lBU2pELENBQUM7SUFFRCxPQUFPLENBQ04sRUFBVSxFQUNWLFlBQW9CLEVBQUUsRUFDdEIsSUFBNEIsRUFDNUIsSUFB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QU0sQ0FBQztJQUNmLENBQUM7SUFFRCxNQUFNLENBQ0wsT0FBWSxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQ3ZCLE1BQWMsRUFDZCxhQUFrRDtRQUVsRCxJQUFJLENBQUMsQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFO1lBQ3JDLE9BQU8sSUFBSSxDQUFDO1NBQ1o7UUFFRCxNQUFNLEdBQUcsR0FBRyxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFFbEQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBUyxFQUFFLEtBQWEsRUFBRSxFQUFFO1lBQy9DLE1BQU0sQ0FBQyxHQUFHLGFBQWEsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDckMsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3BCLENBQUMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVELFVBQVU7UUFDVCxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUN2QyxDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBHb2JsRW50aXR5LCBHb2JsU2luZ2xlUEtFbnRpdHkgfSBmcm9tICdnb2JsLXV0aWxzLXRzJztcbmltcG9ydCBPV2ViU2VydmljZSwge1xuXHRJU2VydmljZUFkZFJlc3BvbnNlLFxuXHRJU2VydmljZURlbGV0ZVJlc3BvbnNlLFxuXHRJU2VydmljZVVwZGF0ZVJlc3BvbnNlLFxuXHR0U2VydmljZUFkZFN1Y2Nlc3MsXG5cdHRTZXJ2aWNlRGVsZXRlU3VjY2Vzcyxcblx0dFNlcnZpY2VGYWlsLFxuXHR0U2VydmljZUdldEFsbFN1Y2Nlc3MsXG5cdHRTZXJ2aWNlR2V0U3VjY2Vzcyxcblx0dFNlcnZpY2VSZXF1ZXN0T3B0aW9ucyxcblx0dFNlcnZpY2VVcGRhdGVTdWNjZXNzLFxufSBmcm9tICcuL09XZWJTZXJ2aWNlJztcbmltcG9ydCBPV2ViQXBwIGZyb20gJy4vT1dlYkFwcCc7XG5pbXBvcnQgT1dlYkNvbSBmcm9tICcuL09XZWJDb20nO1xuaW1wb3J0IHsgZXNjYXBlUmVnRXhwLCBpc1BsYWluT2JqZWN0LCBub29wIH0gZnJvbSAnLi91dGlscy9VdGlscyc7XG5cbmV4cG9ydCB0eXBlIHRFbnRpdGllc09yZGVyQnlDYjxUPiA9IChhOiBULCBiOiBUKSA9PiBudW1iZXI7XG5cbmNvbnN0IGdldElkID0gKGl0ZW06IEdvYmxTaW5nbGVQS0VudGl0eSkgPT4gaXRlbS5zaW5nbGVQS1ZhbHVlKCk7XG5cbmNvbnN0IF93aXRoID0gKHRhcmdldDogYW55LCBrZXk6IHN0cmluZyB8IG51bWJlciwgaXRlbTogYW55KSA9PiB7XG5cdFx0cmV0dXJuIHsgLi4udGFyZ2V0LCBba2V5XTogaXRlbSB9O1xuXHR9LFxuXHRfd2l0aG91dCA9ICh0YXJnZXQ6IGFueSwga2V5OiBzdHJpbmcgfCBudW1iZXIpID0+IHtcblx0XHRkZWxldGUgdGFyZ2V0W2tleV07XG5cdFx0cmV0dXJuIHsgLi4udGFyZ2V0IH07XG5cdH07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJTZXJ2aWNlU3RvcmU8XG5cdFQgZXh0ZW5kcyBHb2JsU2luZ2xlUEtFbnRpdHlcbj4gZXh0ZW5kcyBPV2ViU2VydmljZTxUPiB7XG5cdHByb3RlY3RlZCBpdGVtczogeyBba2V5OiBzdHJpbmddOiBUIH0gPSB7fTtcblx0cHJvdGVjdGVkIHJlbGF0aW9uczogeyBba2V5OiBzdHJpbmddOiBhbnkgfSA9IHt9O1xuXG5cdGNvbnN0cnVjdG9yKFxuXHRcdGFwcENvbnRleHQ6IE9XZWJBcHAsXG5cdFx0cHJpdmF0ZSByZWFkb25seSBlbnRpdHk6IHR5cGVvZiBHb2JsU2luZ2xlUEtFbnRpdHksXG5cdFx0c2VydmljZU5hbWU6IHN0cmluZyxcblx0XHRwZXJzaXN0ZW50Q2FjaGU6IGJvb2xlYW4gPSBmYWxzZSxcblx0KSB7XG5cdFx0c3VwZXIoYXBwQ29udGV4dCwgc2VydmljZU5hbWUsIHBlcnNpc3RlbnRDYWNoZSk7XG5cdH1cblxuXHRnZXRJdGVtKFxuXHRcdGlkOiBzdHJpbmcsXG5cdFx0cmVsYXRpb25zOiBzdHJpbmcgPSAnJyxcblx0XHR0aGVuPzogdFNlcnZpY2VHZXRTdWNjZXNzPFQ+LFxuXHRcdGZhaWw/OiB0U2VydmljZUZhaWwsXG5cdFx0ZnJlZXplOiBib29sZWFuID0gdHJ1ZSxcblx0XHRsb2FkQ2FjaGVGaXJzdDogYm9vbGVhbiA9IGZhbHNlLFxuXHQpOiBPV2ViQ29tIHtcblx0XHRjb25zdCBjdHggPSB0aGlzO1xuXHRcdHJldHVybiBjdHguZ2V0UmVxdWVzdChcblx0XHRcdGlkLFxuXHRcdFx0cmVsYXRpb25zLFxuXHRcdFx0KHJlc3BvbnNlLCBmcm9tQ2FjaGUpID0+IHtcblx0XHRcdFx0Y3R4LmFkZEl0ZW1Ub0xpc3QocmVzcG9uc2UuZGF0YS5pdGVtLCByZXNwb25zZS5kYXRhLnJlbGF0aW9ucyk7XG5cdFx0XHRcdHRoZW4gJiYgdGhlbihyZXNwb25zZSwgZnJvbUNhY2hlKTtcblx0XHRcdH0sXG5cdFx0XHRmYWlsIHx8IG5vb3AsXG5cdFx0XHRmcmVlemUsXG5cdFx0XHRsb2FkQ2FjaGVGaXJzdCxcblx0XHQpO1xuXHR9XG5cblx0Z2V0QWxsSXRlbXMoXG5cdFx0b3B0aW9uczogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucyA9IHt9LFxuXHRcdHRoZW4/OiB0U2VydmljZUdldEFsbFN1Y2Nlc3M8VD4sXG5cdFx0ZmFpbD86IHRTZXJ2aWNlRmFpbCxcblx0XHRmcmVlemU6IGJvb2xlYW4gPSB0cnVlLFxuXHRcdGZvcmNlQ2FjaGU6IGJvb2xlYW4gPSB0cnVlLFxuXHQpOiBPV2ViQ29tIHtcblx0XHRjb25zdCBjdHggPSB0aGlzO1xuXHRcdHJldHVybiBjdHguZ2V0QWxsUmVxdWVzdChcblx0XHRcdG9wdGlvbnMsXG5cdFx0XHQocmVzcG9uc2UsIGZyb21DYWNoZSkgPT4ge1xuXHRcdFx0XHRjdHguYWRkSXRlbXNUb0xpc3QoXG5cdFx0XHRcdFx0cmVzcG9uc2UuZGF0YS5pdGVtcyxcblx0XHRcdFx0XHRyZXNwb25zZS5kYXRhLnJlbGF0aW9ucyxcblx0XHRcdFx0KTtcblx0XHRcdFx0dGhlbiAmJiB0aGVuKHJlc3BvbnNlLCBmcm9tQ2FjaGUpO1xuXHRcdFx0fSxcblx0XHRcdGZhaWwgfHwgbm9vcCxcblx0XHRcdGZyZWV6ZSxcblx0XHRcdGZvcmNlQ2FjaGUsXG5cdFx0KTtcblx0fVxuXG5cdGFkZEl0ZW0oXG5cdFx0ZGF0YTogYW55LFxuXHRcdHRoZW4/OiB0U2VydmljZUFkZFN1Y2Nlc3M8VD4sXG5cdFx0ZmFpbD86IHRTZXJ2aWNlRmFpbCxcblx0XHRmcmVlemU6IGJvb2xlYW4gPSB0cnVlLFxuXHQpOiBPV2ViQ29tIHtcblx0XHRjb25zdCBjdHggPSB0aGlzO1xuXHRcdHJldHVybiBjdHguYWRkUmVxdWVzdChcblx0XHRcdGRhdGEsXG5cdFx0XHQocmVzdWx0KSA9PiB7XG5cdFx0XHRcdGN0eC5hZGRDcmVhdGVkKHJlc3VsdCk7XG5cdFx0XHRcdHRoZW4gJiYgdGhlbihyZXN1bHQpO1xuXHRcdFx0fSxcblx0XHRcdGZhaWwgfHwgbm9vcCxcblx0XHRcdGZyZWV6ZSxcblx0XHQpO1xuXHR9XG5cblx0dXBkYXRlSXRlbShcblx0XHRpdGVtOiBULFxuXHRcdHRoZW4/OiB0U2VydmljZVVwZGF0ZVN1Y2Nlc3M8VD4sXG5cdFx0ZmFpbD86IHRTZXJ2aWNlRmFpbCxcblx0XHRmcmVlemU6IGJvb2xlYW4gPSB0cnVlLFxuXHQpOiBPV2ViQ29tIHwgZmFsc2Uge1xuXHRcdGNvbnN0IGN0eCA9IHRoaXMsXG5cdFx0XHRpZCA9IGdldElkKGl0ZW0pO1xuXG5cdFx0aWYgKCFpdGVtLmlzU2F2ZWQoKSkge1xuXHRcdFx0Y29uc3QgZGlmZiA9IGl0ZW0udG9PYmplY3QodHJ1ZSk7XG5cblx0XHRcdGl0ZW0uaXNTYXZpbmcodHJ1ZSk7XG5cblx0XHRcdHJldHVybiBjdHgudXBkYXRlUmVxdWVzdChcblx0XHRcdFx0aWQsXG5cdFx0XHRcdGRpZmYsXG5cdFx0XHRcdChyZXN1bHQpID0+IHtcblx0XHRcdFx0XHRpdGVtLmlzU2F2aW5nKGZhbHNlKTtcblx0XHRcdFx0XHRjdHguc2V0U2F2ZWQoaXRlbSwgcmVzdWx0KTtcblx0XHRcdFx0XHR0aGVuICYmIHRoZW4ocmVzdWx0KTtcblx0XHRcdFx0fSxcblx0XHRcdFx0KHJlc3BvbnNlLCBjb20pID0+IHtcblx0XHRcdFx0XHRpdGVtLmlzU2F2aW5nKGZhbHNlKTtcblx0XHRcdFx0XHRmYWlsICYmIGZhaWwocmVzcG9uc2UsIGNvbSk7XG5cdFx0XHRcdH0sXG5cdFx0XHRcdGZyZWV6ZSxcblx0XHRcdCk7XG5cdFx0fVxuXG5cdFx0Y29uc29sZS5lcnJvcignTm90IG1vZGlmaWVkIC0+JywgaXRlbSk7XG5cdFx0cmV0dXJuIGZhbHNlO1xuXHR9XG5cblx0ZGVsZXRlSXRlbShcblx0XHRpdGVtOiBULFxuXHRcdHRoZW4/OiB0U2VydmljZURlbGV0ZVN1Y2Nlc3M8VD4sXG5cdFx0ZmFpbD86IHRTZXJ2aWNlRmFpbCxcblx0XHRmcmVlemU6IGJvb2xlYW4gPSB0cnVlLFxuXHQpOiBPV2ViQ29tIHtcblx0XHRjb25zdCBjdHggPSB0aGlzLFxuXHRcdFx0aWQgPSBnZXRJZChpdGVtKTtcblxuXHRcdGl0ZW0uaXNEZWxldGluZyh0cnVlKTtcblx0XHRyZXR1cm4gY3R4LmRlbGV0ZVJlcXVlc3QoXG5cdFx0XHRpZCxcblx0XHRcdChyZXN1bHQpID0+IHtcblx0XHRcdFx0aXRlbS5pc0RlbGV0aW5nKGZhbHNlKTtcblx0XHRcdFx0Y3R4LnNldERlbGV0ZWQocmVzdWx0KTtcblx0XHRcdFx0dGhlbiAmJiB0aGVuKHJlc3VsdCk7XG5cdFx0XHR9LFxuXHRcdFx0KHJlc3BvbnNlLCBjb20pID0+IHtcblx0XHRcdFx0aXRlbS5pc0RlbGV0aW5nKGZhbHNlKTtcblx0XHRcdFx0ZmFpbCAmJiBmYWlsKHJlc3BvbnNlLCBjb20pO1xuXHRcdFx0fSxcblx0XHRcdGZyZWV6ZSxcblx0XHQpO1xuXHR9XG5cblx0YWRkSXRlbXNUb0xpc3QoaXRlbXM6IFRbXSB8IHsgW2tleTogc3RyaW5nXTogVCB9LCByZWxhdGlvbnM6IGFueSA9IHt9KSB7XG5cdFx0Y29uc3QgY3R4ID0gdGhpcyxcblx0XHRcdGxpc3Q6IFRbXSA9IChpc1BsYWluT2JqZWN0KGl0ZW1zKVxuXHRcdFx0XHQ/IE9iamVjdC52YWx1ZXMoaXRlbXMpXG5cdFx0XHRcdDogaXRlbXMgfHwgW10pIGFzIFRbXTtcblxuXHRcdGxpc3QuZm9yRWFjaCgoaXRlbSkgPT4ge1xuXHRcdFx0Y29uc3QgaXRlbUlkID0gZ2V0SWQoaXRlbSk7XG5cblx0XHRcdGN0eC5zYWZlbHlBZGRJdGVtKGl0ZW0pO1xuXG5cdFx0XHRpZiAoIWN0eC5yZWxhdGlvbnNbaXRlbUlkXSkge1xuXHRcdFx0XHRjdHgucmVsYXRpb25zID0gX3dpdGgoY3R4LnJlbGF0aW9ucywgaXRlbUlkLCB7fSk7XG5cdFx0XHR9XG5cblx0XHRcdGZvciAoY29uc3QgcmVsIGluIHJlbGF0aW9ucykge1xuXHRcdFx0XHRpZiAocmVsYXRpb25zLmhhc093blByb3BlcnR5KHJlbCkpIHtcblx0XHRcdFx0XHRjb25zdCBkYXRhID0gcmVsYXRpb25zW3JlbF07XG5cblx0XHRcdFx0XHRpZiAoZGF0YVtpdGVtSWRdKSB7XG5cdFx0XHRcdFx0XHRjdHgucmVsYXRpb25zW2l0ZW1JZF0gPSBfd2l0aChcblx0XHRcdFx0XHRcdFx0Y3R4LnJlbGF0aW9uc1tpdGVtSWRdLFxuXHRcdFx0XHRcdFx0XHRyZWwsXG5cdFx0XHRcdFx0XHRcdGRhdGFbaXRlbUlkXSxcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblxuXHRhZGRJdGVtVG9MaXN0KGl0ZW06IFQsIHJlbGF0aW9uczogYW55ID0ge30pIHtcblx0XHRjb25zdCBjdHggPSB0aGlzLFxuXHRcdFx0aXRlbUlkID0gZ2V0SWQoaXRlbSk7XG5cblx0XHRjdHguc2FmZWx5QWRkSXRlbShpdGVtKTtcblxuXHRcdGlmICghY3R4LnJlbGF0aW9uc1tpdGVtSWRdKSB7XG5cdFx0XHRjdHgucmVsYXRpb25zID0gX3dpdGgoY3R4LnJlbGF0aW9ucywgaXRlbUlkLCB7fSk7XG5cdFx0fVxuXG5cdFx0Zm9yIChjb25zdCByZWwgaW4gcmVsYXRpb25zKSB7XG5cdFx0XHRpZiAocmVsYXRpb25zLmhhc093blByb3BlcnR5KHJlbCkpIHtcblx0XHRcdFx0Y3R4LnJlbGF0aW9uc1tpdGVtSWRdID0gX3dpdGgoXG5cdFx0XHRcdFx0Y3R4LnJlbGF0aW9uc1tpdGVtSWRdLFxuXHRcdFx0XHRcdHJlbCxcblx0XHRcdFx0XHRyZWxhdGlvbnNbcmVsXSxcblx0XHRcdFx0KTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIHNhZmVseUFkZEl0ZW0oaXRlbTogVCkge1xuXHRcdGNvbnN0IGtleSA9IGdldElkKGl0ZW0pLFxuXHRcdFx0Y2FjaGVkSXRlbSA9IHRoaXMuaXRlbXNba2V5XTtcblxuXHRcdGlmIChjYWNoZWRJdGVtKSB7XG5cdFx0XHRjYWNoZWRJdGVtLmRvSHlkcmF0ZShpdGVtLnRvT2JqZWN0KCksIHRydWUpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR0aGlzLml0ZW1zID0gX3dpdGgodGhpcy5pdGVtcywga2V5LCBpdGVtKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdHNldFNhdmVkKHRhcmdldDogVCwgcmVzcG9uc2U6IElTZXJ2aWNlVXBkYXRlUmVzcG9uc2U8VD4pIHtcblx0XHRjb25zdCBpdGVtID0gcmVzcG9uc2UuZGF0YS5pdGVtO1xuXG5cdFx0dGFyZ2V0LmRvSHlkcmF0ZShpdGVtLnRvT2JqZWN0KCksIHRydWUpO1xuXG5cdFx0dGhpcy5zYWZlbHlBZGRJdGVtKHRhcmdldCk7XG5cdH1cblxuXHRhZGRDcmVhdGVkKHJlc3BvbnNlOiBJU2VydmljZUFkZFJlc3BvbnNlPFQ+KSB7XG5cdFx0dGhpcy5zYWZlbHlBZGRJdGVtKHJlc3BvbnNlLmRhdGEuaXRlbSk7XG5cdH1cblxuXHRzZXREZWxldGVkKHJlc3BvbnNlOiBJU2VydmljZURlbGV0ZVJlc3BvbnNlPFQ+KSB7XG5cdFx0Y29uc3QgaXRlbSA9IHJlc3BvbnNlLmRhdGEuaXRlbTtcblx0XHR0aGlzLml0ZW1zID0gX3dpdGhvdXQodGhpcy5pdGVtcywgZ2V0SWQoaXRlbSkpO1xuXHR9XG5cblx0aXRlbVJlbGF0aW9uPFo+KGl0ZW06IFQsIHJlbGF0aW9uOiBzdHJpbmcpOiBaIHwgdW5kZWZpbmVkIHtcblx0XHRjb25zdCBpZCA9IGdldElkKGl0ZW0pO1xuXHRcdHJldHVybiB0aGlzLnJlbGF0aW9uc1tpZF0gJiYgdGhpcy5yZWxhdGlvbnNbaWRdW3JlbGF0aW9uXTtcblx0fVxuXG5cdGlkZW50aWZ5KGlkOiBzdHJpbmcsIGNoZWNrQ2FjaGU6IGJvb2xlYW4gPSB0cnVlKTogVCB8IHVuZGVmaW5lZCB7XG5cdFx0Y29uc3QgaXRlbSA9IHRoaXMuaXRlbXNbaWRdO1xuXHRcdGxldCBjO1xuXG5cdFx0aWYgKGl0ZW0pIHJldHVybiBpdGVtO1xuXG5cdFx0aWYgKGNoZWNrQ2FjaGUpIHtcblx0XHRcdGMgPSBHb2JsRW50aXR5LnN1YkNhY2hlKHRoaXMuZW50aXR5Lm5hbWUpIGFzIGFueTtcblxuXHRcdFx0cmV0dXJuIGMgJiYgY1tpZF07XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHVuZGVmaW5lZDtcblx0fVxuXG5cdGxpc3QoaWRzOiBzdHJpbmdbXSA9IFtdKSB7XG5cdFx0Y29uc3QgbGlzdDogVFtdID0gW10sXG5cdFx0XHRsZW4gPSBpZHMubGVuZ3RoO1xuXHRcdGlmIChsZW4pIHtcblx0XHRcdGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHtcblx0XHRcdFx0Y29uc3QgaWQgPSBpZHNbaV0sXG5cdFx0XHRcdFx0aXRlbSA9IHRoaXMuaWRlbnRpZnkoaWQpO1xuXHRcdFx0XHRpZiAoaXRlbSkge1xuXHRcdFx0XHRcdGxpc3QucHVzaChpdGVtKTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH0gZWxzZSB7XG5cdFx0XHRmb3IgKGNvbnN0IGtleSBpbiB0aGlzLml0ZW1zKSB7XG5cdFx0XHRcdGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcy5pdGVtcywga2V5KSkge1xuXHRcdFx0XHRcdGxpc3QucHVzaCh0aGlzLml0ZW1zW2tleV0pO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGxpc3Q7XG5cdH1cblxuXHRvcmRlckJ5KG9yZGVyRm46IHRFbnRpdGllc09yZGVyQnlDYjxUPik6IFRbXSB7XG5cdFx0Y29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuaXRlbXMpO1xuXG5cdFx0cmV0dXJuIGtleXMubWFwKChrZXkpID0+IHRoaXMuaXRlbXNba2V5XSkuc29ydChvcmRlckZuKTtcblx0fVxuXG5cdG9yZGVyQnlWYWx1ZU9mKGNvbHVtbjogc3RyaW5nKTogVFtdIHtcblx0XHRyZXR1cm4gdGhpcy5vcmRlckJ5KChhOiBhbnksIGI6IGFueSkgPT4ge1xuXHRcdFx0cmV0dXJuIGFbY29sdW1uXSAtIGJbY29sdW1uXTtcblx0XHR9KTtcblx0fVxuXG5cdHNlbGVjdChcblx0XHRsaXN0OiBUW10gPSB0aGlzLmxpc3QoKSxcblx0XHRwcmVkaWNhdGU6ICh2YWx1ZTogVCwgaW5kZXg6IG51bWJlcikgPT4gYm9vbGVhbixcblx0XHRtYXggPSBJbmZpbml0eSxcblx0KTogVFtdIHtcblx0XHRjb25zdCByZXN1bHQ6IFRbXSA9IFtdLFxuXHRcdFx0bGVuID0gbGlzdC5sZW5ndGg7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGxlbiAmJiByZXN1bHQubGVuZ3RoIDwgbWF4OyBpKyspIHtcblx0XHRcdGlmIChwcmVkaWNhdGUobGlzdFtpXSwgaSkpIHtcblx0XHRcdFx0cmVzdWx0LnB1c2gobGlzdFtpXSk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHJlc3VsdDtcblx0fVxuXG5cdHNlYXJjaChcblx0XHRsaXN0OiBUW10gPSB0aGlzLmxpc3QoKSxcblx0XHRzZWFyY2g6IHN0cmluZyxcblx0XHRzdHJpbmdCdWlsZGVyOiAodmFsdWU6IFQsIGluZGV4OiBudW1iZXIpID0+IHN0cmluZyxcblx0KTogVFtdIHtcblx0XHRpZiAoIShzZWFyY2ggPSBzZWFyY2gudHJpbSgpKS5sZW5ndGgpIHtcblx0XHRcdHJldHVybiBsaXN0O1xuXHRcdH1cblxuXHRcdGNvbnN0IHJlZyA9IG5ldyBSZWdFeHAoZXNjYXBlUmVnRXhwKHNlYXJjaCksICdpJyk7XG5cblx0XHRyZXR1cm4gbGlzdC5maWx0ZXIoKGl0ZW06IGFueSwgaW5kZXg6IG51bWJlcikgPT4ge1xuXHRcdFx0Y29uc3QgdiA9IHN0cmluZ0J1aWxkZXIoaXRlbSwgaW5kZXgpO1xuXHRcdFx0cmV0dXJuIHJlZy50ZXN0KHYpO1xuXHRcdH0pO1xuXHR9XG5cblx0dG90YWxDb3VudCgpOiBudW1iZXIge1xuXHRcdHJldHVybiBPYmplY3Qua2V5cyh0aGlzLml0ZW1zKS5sZW5ndGg7XG5cdH1cbn1cbiJdfQ==