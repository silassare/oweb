import OWebEvent from './OWebEvent';
import { forEach } from './utils';
const _hasExpired = (data) => {
    const now = Date.now(), expire = data.expire;
    return expire !== -1 && now <= expire;
};
export default class OWebKeyStorage extends OWebEvent {
    _appContext;
    tagName;
    persistent;
    _maxLifeTime;
    _store;
    constructor(_appContext, tagName, persistent = true, maxLifeTime = Infinity) {
        super();
        this._appContext = _appContext;
        this.tagName = tagName;
        this.persistent = persistent;
        const m = this;
        this._store = _appContext.ls.get(this.tagName) || {};
        this._maxLifeTime = maxLifeTime * 1000;
        _appContext.ls.onClear(() => {
            m._store = {};
        });
        this._clearExpired();
    }
    getStoreData() {
        const items = {};
        this._clearExpired();
        forEach(this._store, (data, key) => {
            items[key] = data.value;
        });
        return items;
    }
    getItem(key) {
        let data = this._store[key];
        if (data !== undefined) {
            data = _hasExpired(data) ? this.removeItem(key) && null : data.value;
        }
        return data;
    }
    setItem(key, value) {
        this._store[key] = {
            value,
            expire: this._maxLifeTime === Infinity ? -1 : Date.now() + this._maxLifeTime,
        };
        return this._save();
    }
    removeItem(key) {
        if (key in this._store) {
            delete this._store[key];
        }
        return this._save();
    }
    _save() {
        if (this.persistent) {
            this._appContext.ls.set(this.tagName, this._store);
        }
        return this;
    }
    clear() {
        this._store = {};
        return this._save();
    }
    _clearExpired() {
        const s = this;
        let modified = false;
        forEach(this._store, (data, key) => {
            if (_hasExpired(data)) {
                modified = true;
                delete s._store[key];
            }
        });
        modified && this._save();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYktleVN0b3JhZ2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYktleVN0b3JhZ2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxTQUFTLE1BQU0sYUFBYSxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFRbEMsTUFBTSxXQUFXLEdBQUcsQ0FBQyxJQUFjLEVBQVcsRUFBRTtJQUMvQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEVBQ3JCLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3RCLE9BQU8sTUFBTSxLQUFLLENBQUMsQ0FBQyxJQUFJLEdBQUcsSUFBSSxNQUFNLENBQUM7QUFDdkMsQ0FBQyxDQUFDO0FBRUYsTUFBTSxDQUFDLE9BQU8sT0FBTyxjQUFlLFNBQVEsU0FBUztJQVdsQztJQUNBO0lBQ1Q7SUFaUSxZQUFZLENBQVM7SUFDOUIsTUFBTSxDQUE4QjtJQVE1QyxZQUNrQixXQUFvQixFQUNwQixPQUFlLEVBQ3hCLGFBQXNCLElBQUksRUFDbEMsV0FBVyxHQUFHLFFBQVE7UUFFdEIsS0FBSyxFQUFFLENBQUM7UUFMUyxnQkFBVyxHQUFYLFdBQVcsQ0FBUztRQUNwQixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBQ3hCLGVBQVUsR0FBVixVQUFVLENBQWdCO1FBS2xDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQztRQUNmLElBQUksQ0FBQyxNQUFNLEdBQUcsV0FBVyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNyRCxJQUFJLENBQUMsWUFBWSxHQUFHLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFFdkMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFO1lBQzNCLENBQUMsQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ2YsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdEIsQ0FBQztJQUtELFlBQVk7UUFDWCxNQUFNLEtBQUssR0FBK0IsRUFBRSxDQUFDO1FBRTdDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUVyQixPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUNsQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUN6QixDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sS0FBSyxDQUFDO0lBQ2QsQ0FBQztJQU9ELE9BQU8sQ0FBQyxHQUFXO1FBQ2xCLElBQUksSUFBSSxHQUFhLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFdEMsSUFBSSxJQUFJLEtBQUssU0FBUyxFQUFFO1lBQ3ZCLElBQUksR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO1NBQ3JFO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDYixDQUFDO0lBU0QsT0FBTyxDQUFDLEdBQVcsRUFBRSxLQUFpQjtRQUNyQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHO1lBQ2xCLEtBQUs7WUFDTCxNQUFNLEVBQ0wsSUFBSSxDQUFDLFlBQVksS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLFlBQVk7U0FDckUsQ0FBQztRQUVGLE9BQU8sSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3JCLENBQUM7SUFPRCxVQUFVLENBQUMsR0FBVztRQUNyQixJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ3ZCLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUN4QjtRQUVELE9BQU8sSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3JCLENBQUM7SUFLTyxLQUFLO1FBQ1osSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ3BCLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNuRDtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztJQUtELEtBQUs7UUFDSixJQUFJLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNqQixPQUFPLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNyQixDQUFDO0lBT08sYUFBYTtRQUNwQixNQUFNLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDZixJQUFJLFFBQVEsR0FBRyxLQUFLLENBQUM7UUFDckIsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLEVBQUU7WUFDbEMsSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQ3RCLFFBQVEsR0FBRyxJQUFJLENBQUM7Z0JBQ2hCLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUNyQjtRQUNGLENBQUMsQ0FBQyxDQUFDO1FBRUgsUUFBUSxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUMxQixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT1dlYkFwcCBmcm9tICcuL09XZWJBcHAnO1xuaW1wb3J0IE9XZWJFdmVudCBmcm9tICcuL09XZWJFdmVudCc7XG5pbXBvcnQgeyBmb3JFYWNoIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgeyBPSlNPTlZhbHVlIH0gZnJvbSAnLi9PV2ViRGF0YVN0b3JlJztcblxudHlwZSBPS2V5RGF0YSA9IHtcblx0dmFsdWU6IGFueTtcblx0ZXhwaXJlOiBudW1iZXI7XG59O1xuXG5jb25zdCBfaGFzRXhwaXJlZCA9IChkYXRhOiBPS2V5RGF0YSk6IGJvb2xlYW4gPT4ge1xuXHRjb25zdCBub3cgPSBEYXRlLm5vdygpLFxuXHRcdGV4cGlyZSA9IGRhdGEuZXhwaXJlO1xuXHRyZXR1cm4gZXhwaXJlICE9PSAtMSAmJiBub3cgPD0gZXhwaXJlO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT1dlYktleVN0b3JhZ2UgZXh0ZW5kcyBPV2ViRXZlbnQge1xuXHRwcml2YXRlIHJlYWRvbmx5IF9tYXhMaWZlVGltZTogbnVtYmVyO1xuXHRwcml2YXRlIF9zdG9yZTogeyBba2V5OiBzdHJpbmddOiBPS2V5RGF0YSB9O1xuXG5cdC8qKlxuXHQgKiBAcGFyYW0gX2FwcENvbnRleHQgVGhlIGFwcCBjb250ZXh0LlxuXHQgKiBAcGFyYW0gdGFnTmFtZSBUaGUga2V5IHN0b3JhZ2UgbmFtZS5cblx0ICogQHBhcmFtIHBlcnNpc3RlbnQgVHJ1ZSB0byBwZXJzaXN0cyB0aGUga2V5IHN0b3JhZ2UgZGF0YS5cblx0ICogQHBhcmFtIG1heExpZmVUaW1lIFRoZSBkdXJhdGlvbiBpbiBzZWNvbmRzIHVudGlsIGtleSBkYXRhIGRlbGV0aW9uLlxuXHQgKi9cblx0Y29uc3RydWN0b3IoXG5cdFx0cHJpdmF0ZSByZWFkb25seSBfYXBwQ29udGV4dDogT1dlYkFwcCxcblx0XHRwcml2YXRlIHJlYWRvbmx5IHRhZ05hbWU6IHN0cmluZyxcblx0XHRwcml2YXRlIHBlcnNpc3RlbnQ6IGJvb2xlYW4gPSB0cnVlLFxuXHRcdG1heExpZmVUaW1lID0gSW5maW5pdHlcblx0KSB7XG5cdFx0c3VwZXIoKTtcblxuXHRcdGNvbnN0IG0gPSB0aGlzO1xuXHRcdHRoaXMuX3N0b3JlID0gX2FwcENvbnRleHQubHMuZ2V0KHRoaXMudGFnTmFtZSkgfHwge307XG5cdFx0dGhpcy5fbWF4TGlmZVRpbWUgPSBtYXhMaWZlVGltZSAqIDEwMDA7XG5cblx0XHRfYXBwQ29udGV4dC5scy5vbkNsZWFyKCgpID0+IHtcblx0XHRcdG0uX3N0b3JlID0ge307XG5cdFx0fSk7XG5cblx0XHR0aGlzLl9jbGVhckV4cGlyZWQoKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHRoZSBrZXkgc3RvcmFnZSBkYXRhLlxuXHQgKi9cblx0Z2V0U3RvcmVEYXRhKCk6IFJlY29yZDxzdHJpbmcsIE9KU09OVmFsdWU+IHtcblx0XHRjb25zdCBpdGVtczogUmVjb3JkPHN0cmluZywgT0pTT05WYWx1ZT4gPSB7fTtcblxuXHRcdHRoaXMuX2NsZWFyRXhwaXJlZCgpO1xuXG5cdFx0Zm9yRWFjaCh0aGlzLl9zdG9yZSwgKGRhdGEsIGtleSkgPT4ge1xuXHRcdFx0aXRlbXNba2V5XSA9IGRhdGEudmFsdWU7XG5cdFx0fSk7XG5cblx0XHRyZXR1cm4gaXRlbXM7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyBhIGdpdmVuIGtleSB2YWx1ZS5cblx0ICpcblx0ICogQHBhcmFtIGtleSBUaGUga2V5IG5hbWUuXG5cdCAqL1xuXHRnZXRJdGVtKGtleTogc3RyaW5nKTogT0pTT05WYWx1ZSB8IG51bGwge1xuXHRcdGxldCBkYXRhOiBPS2V5RGF0YSA9IHRoaXMuX3N0b3JlW2tleV07XG5cblx0XHRpZiAoZGF0YSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRkYXRhID0gX2hhc0V4cGlyZWQoZGF0YSkgPyB0aGlzLnJlbW92ZUl0ZW0oa2V5KSAmJiBudWxsIDogZGF0YS52YWx1ZTtcblx0XHR9XG5cblx0XHRyZXR1cm4gZGF0YTtcblx0fVxuXG5cdC8qKlxuXHQgKiBTZXRzIGFuIGl0ZW0gdG8gdGhlIGtleSBzdG9yYWdlLlxuXHQgKlxuXHQgKiBAcGFyYW0ga2V5IFRoZSBrZXkgbmFtZS5cblx0ICogQHBhcmFtIHZhbHVlIFRoZSBrZXkgdmFsdWUuXG5cdCAqL1xuXG5cdHNldEl0ZW0oa2V5OiBzdHJpbmcsIHZhbHVlOiBPSlNPTlZhbHVlKTogdGhpcyB7XG5cdFx0dGhpcy5fc3RvcmVba2V5XSA9IHtcblx0XHRcdHZhbHVlLFxuXHRcdFx0ZXhwaXJlOlxuXHRcdFx0XHR0aGlzLl9tYXhMaWZlVGltZSA9PT0gSW5maW5pdHkgPyAtMSA6IERhdGUubm93KCkgKyB0aGlzLl9tYXhMaWZlVGltZSxcblx0XHR9O1xuXG5cdFx0cmV0dXJuIHRoaXMuX3NhdmUoKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZW1vdmVzIGl0ZW0gZnJvbSB0aGUga2V5IHN0b3JhZ2UuXG5cdCAqXG5cdCAqIEBwYXJhbSBrZXkgVGhlIGl0ZW0ga2V5IG5hbWUuXG5cdCAqL1xuXHRyZW1vdmVJdGVtKGtleTogc3RyaW5nKTogdGhpcyB7XG5cdFx0aWYgKGtleSBpbiB0aGlzLl9zdG9yZSkge1xuXHRcdFx0ZGVsZXRlIHRoaXMuX3N0b3JlW2tleV07XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuX3NhdmUoKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBTYXZlIHRoZSBrZXkgc3RvcmFnZS5cblx0ICovXG5cdHByaXZhdGUgX3NhdmUoKTogdGhpcyB7XG5cdFx0aWYgKHRoaXMucGVyc2lzdGVudCkge1xuXHRcdFx0dGhpcy5fYXBwQ29udGV4dC5scy5zZXQodGhpcy50YWdOYW1lLCB0aGlzLl9zdG9yZSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogQ2xlYXIgdGhlIGtleSBzdG9yYWdlLlxuXHQgKi9cblx0Y2xlYXIoKTogdGhpcyB7XG5cdFx0dGhpcy5fc3RvcmUgPSB7fTtcblx0XHRyZXR1cm4gdGhpcy5fc2F2ZSgpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEhlbHBlciB0byBjbGVhciBhbGwgZXhwaXJlZCB2YWx1ZSBmcm9tIHRoZSBrZXkgc3RvcmFnZS5cblx0ICpcblx0ICogQHByaXZhdGVcblx0ICovXG5cdHByaXZhdGUgX2NsZWFyRXhwaXJlZCgpIHtcblx0XHRjb25zdCBzID0gdGhpcztcblx0XHRsZXQgbW9kaWZpZWQgPSBmYWxzZTtcblx0XHRmb3JFYWNoKHRoaXMuX3N0b3JlLCAoZGF0YSwga2V5KSA9PiB7XG5cdFx0XHRpZiAoX2hhc0V4cGlyZWQoZGF0YSkpIHtcblx0XHRcdFx0bW9kaWZpZWQgPSB0cnVlO1xuXHRcdFx0XHRkZWxldGUgcy5fc3RvcmVba2V5XTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdG1vZGlmaWVkICYmIHRoaXMuX3NhdmUoKTtcblx0fVxufVxuIl19