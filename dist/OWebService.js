"use strict";
import Utils from "./utils/Utils";
import OWebKeyStorage from "./OWebKeyStorage";
const uri_service = ":api_url/:service_name", uri_entity = ":api_url/:service_name/:id", uri_entity_relation = ":api_url/:service_name/:id/:relation";
let toKey = function (query_params) {
    let key = JSON.stringify(query_params).replace(/[^a-z0-9]/ig, "");
    return key.length ? key : "no-params";
};
export default class OWebService {
    constructor(app_context, service_name) {
        this.app_context = app_context;
        let s_url = app_context.configs.get("OZ_API_BASE_URL")
            .replace(/\/$/g, "");
        this._base_data = { api_url: s_url, service_name: service_name };
        this._key_store = new OWebKeyStorage(app_context, "services:" + service_name);
    }
    getServiceURI() {
        return Utils.stringKeyReplace(uri_service, this._base_data);
    }
    getItemURI(id) {
        let data = Utils.assign({ id: id }, this._base_data);
        return Utils.stringKeyReplace(uri_entity, data);
    }
    getItemRelationURI(id, relation) {
        let data = Utils.assign({ id: id, relation: relation }, this._base_data);
        return Utils.stringKeyReplace(uri_entity_relation, data);
    }
    getCacheManager() {
        return this._key_store;
    }
    add(formData, success, fail, freeze = false) {
        let url = this.getServiceURI();
        return this.app_context.request("POST", url, formData, (response) => {
            success(response["data"]);
        }, fail, freeze);
    }
    delete(id, success, fail, freeze = false) {
        let m = this, url = this.getItemURI(id);
        return this.app_context.request("DELETE", url, null, (response) => {
            m.getCacheManager().removeItem(id);
            success(response["data"]);
        }, fail, freeze);
    }
    update(id, formData, success, fail, freeze = false) {
        let url = this.getItemURI(id);
        return this.app_context.request("PATCH", url, formData, (response) => {
            success(response["data"]);
        }, fail, freeze);
    }
    deleteAll(options, success, fail, freeze = false) {
        let url = this.getServiceURI(), filters = options.filters, request_data = {};
        if (typeof options["max"] === "number") { // will be ignored by O'Zone
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") { // will be ignored by O'Zone
            request_data["page"] = options["page"];
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        return this.app_context.request("DELETE", url, request_data, (response) => {
            success(response["data"]);
        }, fail, freeze);
    }
    updateAll(options, formData, success, fail, freeze = false) {
        let url = this.getServiceURI(), filters = options.filters, request_data = {
            data: formData
        };
        if (typeof options["max"] === "number") { // will be ignored by O'Zone
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") { // will be ignored by O'Zone
            request_data["page"] = options["page"];
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        return this.app_context.request("PATCH", url, request_data, (response) => {
            success(response["data"]);
        }, fail, freeze);
    }
    get(id, relations = "", success, fail, freeze = false, load_cache_first = false) {
        let m = this, url = this.getItemURI(id), data = null, cache_id = id;
        if (relations.length) {
            data = { relations };
        }
        if (load_cache_first) {
            let tmp_data = m.getCacheManager().getItem(cache_id);
            if (tmp_data) {
                success(tmp_data, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, data, (response) => {
            let data = response["data"];
            m.getCacheManager().setItem(id, data);
            success(data, false);
        }, (response) => {
            let data = m.getCacheManager().getItem(cache_id);
            if (data) {
                success(data, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
    getAll(options, success, fail, freeze = false, force_cache = false, load_cache_first = false) {
        let m = this, url = this.getServiceURI(), filters = options["filters"], request_data = {};
        if (typeof options["max"] === "number") {
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") {
            request_data["page"] = options["page"];
        }
        if (typeof options.relations === "string") {
            request_data["relations"] = options.relations;
        }
        if (typeof options.order_by === "string") {
            request_data["order_by"] = options.order_by;
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        let cache_id = toKey(request_data);
        if (force_cache && load_cache_first) {
            let tmp_data = m.getCacheManager().getItem(cache_id);
            if (tmp_data && tmp_data.items &&
                Object.keys(tmp_data.items).length) {
                success(tmp_data, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, request_data, (response) => {
            let data = response["data"];
            force_cache && m.getCacheManager().setItem(cache_id, data);
            success(data, false);
        }, (response) => {
            let data;
            if (force_cache &&
                (data = m.getCacheManager().getItem(cache_id))) {
                success(data, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
    getRelation(id, relation, success, fail, freeze = false, force_cache = false, load_cache_first = false) {
        let m = this, url = this.getItemRelationURI(id, relation);
        let cache_id = toKey({ id, relation });
        if (force_cache && load_cache_first) {
            let tmp_data = this.getCacheManager().getItem(cache_id);
            if (tmp_data && tmp_data.relations && tmp_data.relations[relation]) {
                success(tmp_data, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, {}, function (response) {
            let data = response["data"];
            force_cache && m.getCacheManager().setItem(cache_id, data);
            success(data, false);
        }, function (response) {
            let data;
            if (force_cache &&
                (data = m.getCacheManager().getItem(cache_id))) {
                success(data, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
    getRelationItems(id, relation, options, success, fail, freeze = false, force_cache = false, load_cache_first = false) {
        let m = this, url = this.getItemRelationURI(id, relation), filters = options["filters"], request_data = {};
        if (typeof options["max"] === "number") {
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") {
            request_data["page"] = options["page"];
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        let cache_id = toKey(Utils.assign({ relation: relation }, request_data));
        if (force_cache && load_cache_first) {
            let tmp_data = this.getCacheManager().getItem(cache_id);
            if (tmp_data && tmp_data.relations && tmp_data.relations[relation]) {
                success(tmp_data, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, request_data, function (response) {
            let data = response["data"];
            force_cache && m.getCacheManager().setItem(cache_id, data);
            success(data, false);
        }, function (response) {
            let data;
            if (force_cache &&
                (data = m.getCacheManager().getItem(cache_id))) {
                success(data, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYlNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDO0FBR2IsT0FBTyxLQUFLLE1BQU0sZUFBZSxDQUFDO0FBQ2xDLE9BQU8sY0FBYyxNQUFNLGtCQUFrQixDQUFDO0FBbUY5QyxNQUFNLFdBQVcsR0FBVyx3QkFBd0IsRUFDakQsVUFBVSxHQUFZLDRCQUE0QixFQUNsRCxtQkFBbUIsR0FBRyxzQ0FBc0MsQ0FBQztBQUVoRSxJQUFJLEtBQUssR0FBRyxVQUFVLFlBQWlCO0lBQ3RDLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNsRSxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDO0FBQ3ZDLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxPQUFPO0lBSWIsWUFBNkIsV0FBb0IsRUFBRSxZQUFvQjtRQUExQyxnQkFBVyxHQUFYLFdBQVcsQ0FBUztRQUVoRCxJQUFJLEtBQUssR0FBUyxXQUFXLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQzthQUMxRCxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBQyxPQUFPLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksY0FBYyxDQUFDLFdBQVcsRUFBRSxXQUFXLEdBQUcsWUFBWSxDQUFDLENBQUM7SUFFL0UsQ0FBQztJQUVELGFBQWE7UUFDWixPQUFPLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFD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QVEsR0FBb0MsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUV6RixJQUFJLFFBQVEsSUFBSSxRQUFRLENBQUMsU0FBUyxJQUFJLFFBQVEsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLEVBQUU7Z0JBQ25FLE9BQU8sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQ3hCLE1BQU0sR0FBRyxLQUFLLENBQUM7YUFDZjtTQUNEO1FBRUQsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLFlBQVksRUFBRSxVQUFVLFFBQXNCO1lBQ3pGLElBQUksSUFBSSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUM1QixXQUFXLElBQUksQ0FBQyxDQUFDLGVBQWUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFFM0QsT0FBTyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN0QixDQUFDLEVBQUUsVUFBVSxRQUFzQjtZQUNsQyxJQUFJLElBQUksQ0FBQztZQUNULElBQUksV0FBVztnQkFDZCxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUU7Z0JBQ2hELE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDcEI7aUJBQU07Z0JBQ04sSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ2Y7UUFDRixDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDWixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IE9XZWJBcHAgZnJvbSBcIi4vT1dlYkFwcFwiO1xuaW1wb3J0IFV0aWxzIGZyb20gXCIuL3V0aWxzL1V0aWxzXCI7XG5pbXBvcnQgT1dlYktleVN0b3JhZ2UgZnJvbSBcIi4vT1dlYktleVN0b3JhZ2VcIjtcbmltcG9ydCBPV2ViQ29tLCB7dENvbVJlc3BvbnNlfSBmcm9tIFwiLi9PV2ViQ29tXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VBZGREYXRhPFQ+IHtcblx0aXRlbTogVCxcblx0cmVsYXRpb25zPzoge1xuXHRcdFtrZXk6IHN0cmluZ106IGFueVxuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VHZXREYXRhPFQ+IHtcblx0aXRlbTogVCxcblx0cmVsYXRpb25zPzoge1xuXHRcdFtrZXk6IHN0cmluZ106IGFueVxuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VHZXRBbGxEYXRhPFQ+IHtcblx0aXRlbXM6IFRbXSxcblx0bWF4PzogbnVtYmVyLFxuXHRwYWdlPzogbnVtYmVyLFxuXHR0b3RhbD86IG51bWJlcixcblx0cmVsYXRpb25zPzoge1xuXHRcdFtrZXk6IHN0cmluZ106IGFueVxuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VVcGRhdGVEYXRhPFQ+IHtcblx0aXRlbTogVCxcblx0cmVsYXRpb25zPzoge1xuXHRcdFtrZXk6IHN0cmluZ106IGFueVxuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VVcGRhdGVBbGxEYXRhIHtcblx0YWZmZWN0ZWQ6IG51bWJlclxufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlTZXJ2aWNlRGVsZXRlRGF0YTxUPiB7XG5cdGl0ZW06IFRcbn1cblxuZXhwb3J0IGludGVyZmFjZSBpU2VydmljZURlbGV0ZUFsbERhdGE8VD4ge1xuXHRhZmZlY3RlZDogbnVtYmVyXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VHZXRSZWxhdGlvbkl0ZW1zRGF0YTxUPiB7XG5cdGl0ZW1zOiBUW10sXG5cdG1heD86IG51bWJlcixcblx0cGFnZT86IG51bWJlcixcblx0dG90YWw/OiBudW1iZXIsXG5cdHJlbGF0aW9uczoge1xuXHRcdFtrZXk6IHN0cmluZ106IGFueVxuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VHZXRSZWxhdGlvbkl0ZW1EYXRhPFQ+IHtcblx0aXRlbTogVCxcblx0cmVsYXRpb25zPzoge1xuXHRcdFtrZXk6IHN0cmluZ106IGFueVxuXHR9XG59XG5cbmV4cG9ydCB0eXBlIHRTZXJ2aWNlQWRkU3VjY2VzczxUPiA9IChyZXNwb25zZTogaVNlcnZpY2VBZGREYXRhPFQ+KSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgdFNlcnZpY2VVcGRhdGVTdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZVVwZGF0ZURhdGE8VD4pID0+IHZvaWQ7XG5leHBvcnQgdHlwZSB0U2VydmljZVVwZGF0ZUFsbFN1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlVXBkYXRlQWxsRGF0YSkgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIHRTZXJ2aWNlRGVsZXRlU3VjY2VzczxUPiA9IChyZXNwb25zZTogaVNlcnZpY2VEZWxldGVEYXRhPFQ+KSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgdFNlcnZpY2VEZWxldGVBbGxTdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZURlbGV0ZUFsbERhdGE8VD4pID0+IHZvaWQ7XG5leHBvcnQgdHlwZSB0U2VydmljZUdldFN1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlR2V0RGF0YTxUPiwgZnJvbUNhY2hlOiBib29sZWFuKSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgdFNlcnZpY2VHZXRBbGxTdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZUdldEFsbERhdGE8VD4sIGZyb21DYWNoZTogYm9vbGVhbikgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIHRTZXJ2aWNlR2V0UmVsYXRpb25TdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZUdldFJlbGF0aW9uSXRlbURhdGE8VD4sIGZyb21DYWNoZTogYm9vbGVhbikgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIHRTZXJ2aWNlR2V0UmVsYXRpb25JdGVtc1N1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlR2V0UmVsYXRpb25JdGVtc0RhdGE8VD4sIGZyb21DYWNoZTogYm9vbGVhbikgPT4gdm9pZDtcblxuZXhwb3J0IHR5cGUgdFNlcnZpY2VGYWlsID0gKHJlc3BvbnNlOiB0Q29tUmVzcG9uc2UpID0+IHZvaWQ7XG5cbmV4cG9ydCB0eXBlIHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnMgPSB7XG5cdG1heD86IG51bWJlcixcblx0cGFnZT86IG51bWJlcixcblx0ZmlsdGVycz86IGFueSxcblx0cmVsYXRpb25zPzogc3RyaW5nLFxuXHRvcmRlcl9ieT86IHN0cmluZ1xufTtcblxuY29uc3QgdXJpX3NlcnZpY2UgICAgICAgICA9IFwiOmFwaV91cmwvOnNlcnZpY2VfbmFtZVwiLFxuXHQgIHVyaV9lbnRpdHkgICAgICAgICAgPSBcIjphcGlfdXJsLzpzZXJ2aWNlX25hbWUvOmlkXCIsXG5cdCAgdXJpX2VudGl0eV9yZWxhdGlvbiA9IFwiOmFwaV91cmwvOnNlcnZpY2VfbmFtZS86aWQvOnJlbGF0aW9uXCI7XG5cbmxldCB0b0tleSA9IGZ1bmN0aW9uIChxdWVyeV9wYXJhbXM6IGFueSkge1xuXHRsZXQga2V5ID0gSlNPTi5zdHJpbmdpZnkocXVlcnlfcGFyYW1zKS5yZXBsYWNlKC9bXmEtejAtOV0vaWcsIFwiXCIpO1xuXHRyZXR1cm4ga2V5Lmxlbmd0aCA/IGtleSA6IFwibm8tcGFyYW1zXCI7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViU2VydmljZTxUPiB7XG5cdHByaXZhdGUgcmVhZG9ubHkgX2tleV9zdG9yZTogT1dlYktleVN0b3JhZ2U7XG5cdHByaXZhdGUgcmVhZG9ubHkgX2Jhc2VfZGF0YTogeyBhcGlfdXJsOiBhbnk7IHNlcnZpY2VfbmFtZTogc3RyaW5nIH07XG5cblx0Y29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhcHBfY29udGV4dDogT1dlYkFwcCwgc2VydmljZV9uYW1lOiBzdHJpbmcpIHtcblxuXHRcdGxldCBzX3VybCAgICAgICA9IGFwcF9jb250ZXh0LmNvbmZpZ3MuZ2V0KFwiT1pfQVBJX0JBU0VfVVJMXCIpXG5cdFx0XHQucmVwbGFjZSgvXFwvJC9nLCBcIlwiKTtcblx0XHR0aGlzLl9iYXNlX2RhdGEgPSB7YXBpX3VybDogc191cmwsIHNlcnZpY2VfbmFtZTogc2VydmljZV9uYW1lfTtcblx0XHR0aGlzLl9rZXlfc3RvcmUgPSBuZXcgT1dlYktleVN0b3JhZ2UoYXBwX2NvbnRleHQsIFwic2VydmljZXM6XCIgKyBzZXJ2aWNlX25hbWUpO1xuXG5cdH1cblxuXHRnZXRTZXJ2aWNlVVJJKCkge1xuXHRcdHJldHVybiBVdGlscy5zdHJpbmdLZXlSZXBsYWNlKHVyaV9zZXJ2aWNlLCB0aGlzLl9iYXNlX2RhdGEpO1xuXHR9XG5cblx0Z2V0SXRlbVVSSShpZDogYW55KTogc3RyaW5nIHtcblx0XHRsZXQgZGF0YSA9IFV0aWxzLmFzc2lnbih7aWQ6IGlkfSwgdGhpcy5fYmFzZV9kYXRhKTtcblx0XHRyZXR1cm4gVXRpbHMuc3RyaW5nS2V5UmVwbGFjZSh1cmlfZW50aXR5LCBkYXRhKTtcblx0fVxuXG5cdGdldEl0ZW1SZWxhdGlvblVSSShpZDogc3RyaW5nLCByZWxhdGlvbjogc3RyaW5nKTogc3RyaW5nIHtcblx0XHRsZXQgZGF0YSA9IFV0aWxzLmFzc2lnbih7aWQ6IGlkLCByZWxhdGlvbjogcmVsYXRpb259LCB0aGlzLl9iYXNlX2RhdGEpO1xuXHRcdHJldHVybiBVdGlscy5zdHJpbmdLZXlSZXBsYWNlKHVyaV9lbnRpdHlfcmVsYXRpb24sIGRhdGEpO1xuXHR9XG5cblx0Z2V0Q2FjaGVNYW5hZ2VyKCk6IE9XZWJLZXlTdG9yYWdlIHtcblx0XHRyZXR1cm4gdGhpcy5fa2V5X3N0b3JlO1xuXHR9XG5cblx0YWRkKGZvcm1EYXRhOiBhbnksIHN1Y2Nlc3M6IHRTZXJ2aWNlQWRkU3VjY2VzczxUPiwgZmFpbDogdFNlcnZpY2VGYWlsLCBmcmVlemU6IGJvb2xlYW4gPSBmYWxzZSk6IE9XZWJDb20ge1xuXHRcdGxldCB1cmwgPSB0aGlzLmdldFNlcnZpY2VVUkkoKTtcblxuXHRcdHJldHVybiB0aGlzLmFwcF9jb250ZXh0LnJlcXVlc3QoXCJQT1NUXCIsIHVybCwgZm9ybURhdGEsIChyZXNwb25zZTogdENvbVJlc3BvbnNlKSA9PiB7XG5cdFx0XHRzdWNjZXNzKHJlc3BvbnNlW1wiZGF0YVwiXSk7XG5cdFx0fSwgZmFpbCwgZnJlZXplKTtcblx0fVxuXG5cdGRlbGV0ZShpZDogc3RyaW5nLCBzdWNjZXNzOiB0U2VydmljZURlbGV0ZVN1Y2Nlc3M8VD4sIGZhaWw6IHRTZXJ2aWNlRmFpbCwgZnJlZXplOiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgbSAgID0gdGhpcyxcblx0XHRcdHVybCA9IHRoaXMuZ2V0SXRlbVVSSShpZCk7XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiREVMRVRFXCIsIHVybCwgbnVsbCwgKHJlc3BvbnNlOiB0Q29tUmVzcG9uc2UpID0+IHtcblx0XHRcdG0uZ2V0Q2FjaGVNYW5hZ2VyKCkucmVtb3ZlSXRlbShpZCk7XG5cdFx0XHRzdWNjZXNzKHJlc3BvbnNlW1wiZGF0YVwiXSk7XG5cdFx0fSwgZmFpbCwgZnJlZXplKTtcblx0fVxuXG5cdHVwZGF0ZShpZDogc3RyaW5nLCBmb3JtRGF0YTogYW55LCBzdWNjZXNzOiB0U2VydmljZVVwZGF0ZVN1Y2Nlc3M8VD4sIGZhaWw6IHRTZXJ2aWNlRmFpbCwgZnJlZXplOiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgdXJsID0gdGhpcy5nZXRJdGVtVVJJKGlkKTtcblxuXHRcdHJldHVybiB0aGlzLmFwcF9jb250ZXh0LnJlcXVlc3QoXCJQQVRDSFwiLCB1cmwsIGZvcm1EYXRhLCAocmVzcG9uc2U6IHRDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0c3VjY2VzcyhyZXNwb25zZVtcImRhdGFcIl0pO1xuXHRcdH0sIGZhaWwsIGZyZWV6ZSk7XG5cdH1cblxuXHRkZWxldGVBbGwob3B0aW9uczogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucywgc3VjY2VzczogdFNlcnZpY2VEZWxldGVBbGxTdWNjZXNzPFQ+LCBmYWlsOiB0U2VydmljZUZhaWwsIGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlKTogT1dlYkNvbSB7XG5cdFx0bGV0IHVybCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IHRoaXMuZ2V0U2VydmljZVVSSSgpLFxuXHRcdFx0ZmlsdGVycyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gb3B0aW9ucy5maWx0ZXJzLFxuXHRcdFx0cmVxdWVzdF9kYXRhOiB0U2VydmljZVJlcXVlc3RPcHRpb25zID0ge307XG5cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbXCJtYXhcIl0gPT09IFwibnVtYmVyXCIpIHsvLyB3aWxsIGJlIGlnbm9yZWQgYnkgTydab25lXG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJtYXhcIl0gPSBvcHRpb25zW1wibWF4XCJdO1xuXHRcdH1cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbXCJwYWdlXCJdID09PSBcIm51bWJlclwiKSB7Ly8gd2lsbCBiZSBpZ25vcmVkIGJ5IE8nWm9uZVxuXHRcdFx0cmVxdWVzdF9kYXRhW1wicGFnZVwiXSA9IG9wdGlvbnNbXCJwYWdlXCJdO1xuXHRcdH1cblxuXHRcdGlmIChVdGlscy5pc1BsYWluT2JqZWN0KGZpbHRlcnMpKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJmaWx0ZXJzXCJdID0gZmlsdGVycztcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiREVMRVRFXCIsIHVybCwgcmVxdWVzdF9kYXRhLCAocmVzcG9uc2U6IHRDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0c3VjY2VzcyhyZXNwb25zZVtcImRhdGFcIl0pO1xuXHRcdH0sIGZhaWwsIGZyZWV6ZSk7XG5cdH1cblxuXHR1cGRhdGVBbGwob3B0aW9uczogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucywgZm9ybURhdGE6IGFueSwgc3VjY2VzczogdFNlcnZpY2VVcGRhdGVBbGxTdWNjZXNzPFQ+LCBmYWlsOiB0U2VydmljZUZhaWwsIGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlKTogT1dlYkNvbSB7XG5cdFx0bGV0IHVybCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSB0aGlzLmdldFNlcnZpY2VVUkkoKSxcblx0XHRcdGZpbHRlcnMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBvcHRpb25zLmZpbHRlcnMsXG5cdFx0XHRyZXF1ZXN0X2RhdGE6IHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnMgJiB7IGRhdGE6IGFueSB9ID0ge1xuXHRcdFx0XHRkYXRhOiBmb3JtRGF0YVxuXHRcdFx0fTtcblxuXHRcdGlmICh0eXBlb2Ygb3B0aW9uc1tcIm1heFwiXSA9PT0gXCJudW1iZXJcIikgey8vIHdpbGwgYmUgaWdub3JlZCBieSBPJ1pvbmVcblx0XHRcdHJlcXVlc3RfZGF0YVtcIm1heFwiXSA9IG9wdGlvbnNbXCJtYXhcIl07XG5cdFx0fVxuXHRcdGlmICh0eXBlb2Ygb3B0aW9uc1tcInBhZ2VcIl0gPT09IFwibnVtYmVyXCIpIHsvLyB3aWxsIGJlIGlnbm9yZWQgYnkgTydab25lXG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJwYWdlXCJdID0gb3B0aW9uc1tcInBhZ2VcIl07XG5cdFx0fVxuXG5cdFx0aWYgKFV0aWxzLmlzUGxhaW5PYmplY3QoZmlsdGVycykpIHtcblx0XHRcdHJlcXVlc3RfZGF0YVtcImZpbHRlcnNcIl0gPSBmaWx0ZXJzO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzLmFwcF9jb250ZXh0LnJlcXVlc3QoXCJQQVRDSFwiLCB1cmwsIHJlcXVlc3RfZGF0YSwgKHJlc3BvbnNlOiB0Q29tUmVzcG9uc2UpID0+IHtcblx0XHRcdHN1Y2Nlc3MocmVzcG9uc2VbXCJkYXRhXCJdKTtcblx0XHR9LCBmYWlsLCBmcmVlemUpO1xuXHR9XG5cblx0Z2V0KGlkOiBzdHJpbmcsIHJlbGF0aW9uczogc3RyaW5nID0gXCJcIiwgc3VjY2VzczogdFNlcnZpY2VHZXRTdWNjZXNzPFQ+LCBmYWlsOiB0U2VydmljZUZhaWwsIGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlLCBsb2FkX2NhY2hlX2ZpcnN0OiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgbSAgICAgICAgID0gdGhpcyxcblx0XHRcdHVybCAgICAgICA9IHRoaXMuZ2V0SXRlbVVSSShpZCksXG5cdFx0XHRkYXRhOiBhbnkgPSBudWxsLFxuXHRcdFx0Y2FjaGVfaWQgID0gaWQ7XG5cblx0XHRpZiAocmVsYXRpb25zLmxlbmd0aCkge1xuXHRcdFx0ZGF0YSA9IHtyZWxhdGlvbnN9O1xuXHRcdH1cblxuXHRcdGlmIChsb2FkX2NhY2hlX2ZpcnN0KSB7XG5cdFx0XHRsZXQgdG1wX2RhdGEgPSBtLmdldENhY2hlTWFuYWdlcigpLmdldEl0ZW0oY2FjaGVfaWQpO1xuXG5cdFx0XHRpZiAodG1wX2RhdGEpIHtcblx0XHRcdFx0c3VjY2Vzcyh0bXBfZGF0YSwgdHJ1ZSk7XG5cdFx0XHRcdGZyZWV6ZSA9IGZhbHNlO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzLmFwcF9jb250ZXh0LnJlcXVlc3QoXCJHRVRcIiwgdXJsLCBkYXRhLCAocmVzcG9uc2U6IHRDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0bGV0IGRhdGEgPSByZXNwb25zZVtcImRhdGFcIl07XG5cdFx0XHRtLmdldENhY2hlTWFuYWdlcigpLnNldEl0ZW0oaWQsIGRhdGEpO1xuXHRcdFx0c3VjY2VzcyhkYXRhLCBmYWxzZSk7XG5cdFx0fSwgKHJlc3BvbnNlOiB0Q29tUmVzcG9uc2UpID0+IHtcblx0XHRcdGxldCBkYXRhID0gbS5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKTtcblxuXHRcdFx0aWYgKGRhdGEpIHtcblx0XHRcdFx0c3VjY2VzcyhkYXRhLCB0cnVlKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGZhaWwocmVzcG9uc2UpO1xuXHRcdFx0fVxuXHRcdH0sIGZyZWV6ZSk7XG5cblx0fVxuXG5cdGdldEFsbChvcHRpb25zOiB0U2VydmljZVJlcXVlc3RPcHRpb25zLCBzdWNjZXNzOiB0U2VydmljZUdldEFsbFN1Y2Nlc3M8VD4sIGZhaWw6IHRTZXJ2aWNlRmFpbCwgZnJlZXplOiBib29sZWFuID0gZmFsc2UsIGZvcmNlX2NhY2hlOiBib29sZWFuID0gZmFsc2UsIGxvYWRfY2FjaGVfZmlyc3Q6IGJvb2xlYW4gPSBmYWxzZSk6IE9XZWJDb20ge1xuXHRcdGxldCBtICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSB0aGlzLFxuXHRcdFx0dXJsICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gdGhpcy5nZXRTZXJ2aWNlVVJJKCksXG5cdFx0XHRmaWx0ZXJzICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBvcHRpb25zW1wiZmlsdGVyc1wiXSxcblx0XHRcdHJlcXVlc3RfZGF0YTogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucyA9IHt9O1xuXG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zW1wibWF4XCJdID09PSBcIm51bWJlclwiKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJtYXhcIl0gPSBvcHRpb25zW1wibWF4XCJdO1xuXHRcdH1cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbXCJwYWdlXCJdID09PSBcIm51bWJlclwiKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJwYWdlXCJdID0gb3B0aW9uc1tcInBhZ2VcIl07XG5cdFx0fVxuXG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zLnJlbGF0aW9ucyA9PT0gXCJzdHJpbmdcIikge1xuXHRcdFx0cmVxdWVzdF9kYXRhW1wicmVsYXRpb25zXCJdID0gb3B0aW9ucy5yZWxhdGlvbnNcblx0XHR9XG5cblx0XHRpZiAodHlwZW9mIG9wdGlvbnMub3JkZXJfYnkgPT09IFwic3RyaW5nXCIpIHtcblx0XHRcdHJlcXVlc3RfZGF0YVtcIm9yZGVyX2J5XCJdID0gb3B0aW9ucy5vcmRlcl9ieVxuXHRcdH1cblxuXHRcdGlmIChVdGlscy5pc1BsYWluT2JqZWN0KGZpbHRlcnMpKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJmaWx0ZXJzXCJdID0gZmlsdGVycztcblx0XHR9XG5cblx0XHRsZXQgY2FjaGVfaWQgPSB0b0tleShyZXF1ZXN0X2RhdGEpO1xuXG5cdFx0aWYgKGZvcmNlX2NhY2hlICYmIGxvYWRfY2FjaGVfZmlyc3QpIHtcblx0XHRcdGxldCB0bXBfZGF0YSA9IG0uZ2V0Q2FjaGVNYW5hZ2VyKCkuZ2V0SXRlbShjYWNoZV9pZCk7XG5cblx0XHRcdGlmICh0bXBfZGF0YSAmJiB0bXBfZGF0YS5pdGVtcyAmJlxuXHRcdFx0XHRPYmplY3Qua2V5cyh0bXBfZGF0YS5pdGVtcykubGVuZ3RoKSB7XG5cdFx0XHRcdHN1Y2Nlc3ModG1wX2RhdGEsIHRydWUpO1xuXHRcdFx0XHRmcmVlemUgPSBmYWxzZTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiR0VUXCIsIHVybCwgcmVxdWVzdF9kYXRhLCAocmVzcG9uc2U6IHRDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0bGV0IGRhdGEgPSByZXNwb25zZVtcImRhdGFcIl07XG5cdFx0XHRmb3JjZV9jYWNoZSAmJiBtLmdldENhY2hlTWFuYWdlcigpLnNldEl0ZW0oY2FjaGVfaWQsIGRhdGEpO1xuXHRcdFx0c3VjY2VzcyhkYXRhLCBmYWxzZSk7XG5cdFx0fSwgKHJlc3BvbnNlOiB0Q29tUmVzcG9uc2UpID0+IHtcblx0XHRcdGxldCBkYXRhO1xuXHRcdFx0aWYgKGZvcmNlX2NhY2hlICYmXG5cdFx0XHRcdChkYXRhID0gbS5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKSkpIHtcblx0XHRcdFx0c3VjY2VzcyhkYXRhLCB0cnVlKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGZhaWwocmVzcG9uc2UpO1xuXHRcdFx0fVxuXHRcdH0sIGZyZWV6ZSk7XG5cblx0fVxuXG5cdGdldFJlbGF0aW9uPFI+KGlkOiBzdHJpbmcsIHJlbGF0aW9uOiBzdHJpbmcsIHN1Y2Nlc3M6IHRTZXJ2aWNlR2V0UmVsYXRpb25TdWNjZXNzPFI+LCBmYWlsOiB0U2VydmljZUZhaWwsIGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlLCBmb3JjZV9jYWNoZTogYm9vbGVhbiA9IGZhbHNlLCBsb2FkX2NhY2hlX2ZpcnN0OiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgbSAgID0gdGhpcyxcblx0XHRcdHVybCA9IHRoaXMuZ2V0SXRlbVJlbGF0aW9uVVJJKGlkLCByZWxhdGlvbik7XG5cblx0XHRsZXQgY2FjaGVfaWQgPSB0b0tleSh7aWQsIHJlbGF0aW9ufSk7XG5cblx0XHRpZiAoZm9yY2VfY2FjaGUgJiYgbG9hZF9jYWNoZV9maXJzdCkge1xuXHRcdFx0bGV0IHRtcF9kYXRhID0gPGlTZXJ2aWNlR2V0UmVsYXRpb25JdGVtRGF0YTxSPj50aGlzLmdldENhY2hlTWFuYWdlcigpLmdldEl0ZW0oY2FjaGVfaWQpO1xuXG5cdFx0XHRpZiAodG1wX2RhdGEgJiYgdG1wX2RhdGEucmVsYXRpb25zICYmIHRtcF9kYXRhLnJlbGF0aW9uc1tyZWxhdGlvbl0pIHtcblx0XHRcdFx0c3VjY2Vzcyh0bXBfZGF0YSwgdHJ1ZSk7XG5cdFx0XHRcdGZyZWV6ZSA9IGZhbHNlO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzLmFwcF9jb250ZXh0LnJlcXVlc3QoXCJHRVRcIiwgdXJsLCB7fSwgZnVuY3Rpb24gKHJlc3BvbnNlOiB0Q29tUmVzcG9uc2UpIHtcblx0XHRcdGxldCBkYXRhID0gcmVzcG9uc2VbXCJkYXRhXCJdO1xuXHRcdFx0Zm9yY2VfY2FjaGUgJiYgbS5nZXRDYWNoZU1hbmFnZXIoKS5zZXRJdGVtKGNhY2hlX2lkLCBkYXRhKTtcblx0XHRcdHN1Y2Nlc3MoZGF0YSwgZmFsc2UpO1xuXHRcdH0sIGZ1bmN0aW9uIChyZXNwb25zZTogdENvbVJlc3BvbnNlKSB7XG5cdFx0XHRsZXQgZGF0YTtcblx0XHRcdGlmIChmb3JjZV9jYWNoZSAmJlxuXHRcdFx0XHQoZGF0YSA9IG0uZ2V0Q2FjaGVNYW5hZ2VyKCkuZ2V0SXRlbShjYWNoZV9pZCkpKSB7XG5cdFx0XHRcdHN1Y2Nlc3MoZGF0YSwgdHJ1ZSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRmYWlsKHJlc3BvbnNlKTtcblx0XHRcdH1cblx0XHR9LCBmcmVlemUpO1xuXHR9XG5cblx0Z2V0UmVsYXRpb25JdGVtczxSPihpZDogc3RyaW5nLCByZWxhdGlvbjogc3RyaW5nLCBvcHRpb25zOiB0U2VydmljZVJlcXVlc3RPcHRpb25zLCBzdWNjZXNzOiB0U2VydmljZUdldFJlbGF0aW9uSXRlbXNTdWNjZXNzPFI+LCBmYWlsOiB0U2VydmljZUZhaWwsIGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlLCBmb3JjZV9jYWNoZTogYm9vbGVhbiA9IGZhbHNlLCBsb2FkX2NhY2hlX2ZpcnN0OiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgbSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gdGhpcyxcblx0XHRcdHVybCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IHRoaXMuZ2V0SXRlbVJlbGF0aW9uVVJJKGlkLCByZWxhdGlvbiksXG5cdFx0XHRmaWx0ZXJzICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBvcHRpb25zW1wiZmlsdGVyc1wiXSxcblx0XHRcdHJlcXVlc3RfZGF0YTogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucyA9IHt9O1xuXG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zW1wibWF4XCJdID09PSBcIm51bWJlclwiKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJtYXhcIl0gPSBvcHRpb25zW1wibWF4XCJdO1xuXHRcdH1cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbXCJwYWdlXCJdID09PSBcIm51bWJlclwiKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJwYWdlXCJdID0gb3B0aW9uc1tcInBhZ2VcIl07XG5cdFx0fVxuXG5cdFx0aWYgKFV0aWxzLmlzUGxhaW5PYmplY3QoZmlsdGVycykpIHtcblx0XHRcdHJlcXVlc3RfZGF0YVtcImZpbHRlcnNcIl0gPSBmaWx0ZXJzO1xuXHRcdH1cblxuXHRcdGxldCBjYWNoZV9pZCA9IHRvS2V5KFV0aWxzLmFzc2lnbih7cmVsYXRpb246IHJlbGF0aW9ufSwgcmVxdWVzdF9kYXRhKSk7XG5cblx0XHRpZiAoZm9yY2VfY2FjaGUgJiYgbG9hZF9jYWNoZV9maXJzdCkge1xuXHRcdFx0bGV0IHRtcF9kYXRhID0gPGlTZXJ2aWNlR2V0UmVsYXRpb25JdGVtc0RhdGE8Uj4+dGhpcy5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKTtcblxuXHRcdFx0aWYgKHRtcF9kYXRhICYmIHRtcF9kYXRhLnJlbGF0aW9ucyAmJiB0bXBfZGF0YS5yZWxhdGlvbnNbcmVsYXRpb25dKSB7XG5cdFx0XHRcdHN1Y2Nlc3ModG1wX2RhdGEsIHRydWUpO1xuXHRcdFx0XHRmcmVlemUgPSBmYWxzZTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiR0VUXCIsIHVybCwgcmVxdWVzdF9kYXRhLCBmdW5jdGlvbiAocmVzcG9uc2U6IHRDb21SZXNwb25zZSkge1xuXHRcdFx0bGV0IGRhdGEgPSByZXNwb25zZVtcImRhdGFcIl07XG5cdFx0XHRmb3JjZV9jYWNoZSAmJiBtLmdldENhY2hlTWFuYWdlcigpLnNldEl0ZW0oY2FjaGVfaWQsIGRhdGEpO1xuXG5cdFx0XHRzdWNjZXNzKGRhdGEsIGZhbHNlKTtcblx0XHR9LCBmdW5jdGlvbiAocmVzcG9uc2U6IHRDb21SZXNwb25zZSkge1xuXHRcdFx0bGV0IGRhdGE7XG5cdFx0XHRpZiAoZm9yY2VfY2FjaGUgJiZcblx0XHRcdFx0KGRhdGEgPSBtLmdldENhY2hlTWFuYWdlcigpLmdldEl0ZW0oY2FjaGVfaWQpKSkge1xuXHRcdFx0XHRzdWNjZXNzKGRhdGEsIHRydWUpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0ZmFpbChyZXNwb25zZSk7XG5cdFx0XHR9XG5cdFx0fSwgZnJlZXplKTtcblx0fVxufSJdfQ==