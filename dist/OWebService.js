import { OWebKeyStorage, Utils } from "./oweb";
const uri_service = ":api_url/:service_name", uri_entity = ":api_url/:service_name/:id", uri_entity_relation = ":api_url/:service_name/:id/:relation";
let toKey = function (query_params) {
    let key = JSON.stringify(query_params).replace(/[^a-z0-9]/ig, "");
    return key.length ? key : "no-params";
};
export default class OWebService {
    constructor(app_context, service_name) {
        this.app_context = app_context;
        let s_url = app_context.configs.get("OZ_API_BASE_URL")
            .replace(/\/$/g, "");
        this._base_data = { api_url: s_url, service_name: service_name };
        this._key_store = new OWebKeyStorage(app_context, "services:" + service_name);
    }
    getName() {
        return this._base_data.service_name;
    }
    getServiceURI() {
        return Utils.stringKeyReplace(uri_service, this._base_data);
    }
    getItemURI(id) {
        let data = Utils.assign({ id: id }, this._base_data);
        return Utils.stringKeyReplace(uri_entity, data);
    }
    getItemRelationURI(id, relation) {
        let data = Utils.assign({ id: id, relation: relation }, this._base_data);
        return Utils.stringKeyReplace(uri_entity_relation, data);
    }
    getCacheManager() {
        return this._key_store;
    }
    add(formData, success, fail, freeze = false) {
        let url = this.getServiceURI();
        return this.app_context.request("POST", url, formData, (response) => {
            success(response);
        }, fail, freeze);
    }
    delete(id, success, fail, freeze = false) {
        let m = this, url = this.getItemURI(id);
        return this.app_context.request("DELETE", url, null, (response) => {
            m.getCacheManager().removeItem(id);
            success(response);
        }, fail, freeze);
    }
    update(id, formData, success, fail, freeze = false) {
        let url = this.getItemURI(id);
        return this.app_context.request("PATCH", url, formData, (response) => {
            success(response);
        }, fail, freeze);
    }
    deleteAll(options, success, fail, freeze = false) {
        let url = this.getServiceURI(), filters = options.filters, request_data = {};
        if (typeof options["max"] === "number") { // will be ignored by O'Zone
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") { // will be ignored by O'Zone
            request_data["page"] = options["page"];
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        return this.app_context.request("DELETE", url, request_data, (response) => {
            success(response);
        }, fail, freeze);
    }
    updateAll(options, formData, success, fail, freeze = false) {
        let url = this.getServiceURI(), filters = options.filters, request_data = { data: formData };
        if (typeof options["max"] === "number") { // will be ignored by O'Zone
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") { // will be ignored by O'Zone
            request_data["page"] = options["page"];
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        return this.app_context.request("PATCH", url, request_data, (response) => {
            success(response);
        }, fail, freeze);
    }
    get(id, relations = "", success, fail, freeze = false, load_cache_first = false) {
        let m = this, url = this.getItemURI(id), data = null, cache_id = id, __cached;
        if (relations.length) {
            data = { relations };
        }
        if (load_cache_first) {
            __cached = m.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, data, (response) => {
            m.getCacheManager().setItem(id, response);
            success(response, false);
        }, (response) => {
            if ((__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
    getAll(options, success, fail, freeze = false, force_cache = false, load_cache_first = false) {
        let m = this, url = this.getServiceURI(), filters = options["filters"], request_data = {}, __cached;
        if (typeof options["max"] === "number") {
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") {
            request_data["page"] = options["page"];
        }
        if (typeof options.relations === "string") {
            request_data["relations"] = options.relations;
        }
        if (typeof options.order_by === "string") {
            request_data["order_by"] = options.order_by;
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        let cache_id = toKey(request_data);
        if (force_cache && load_cache_first) {
            __cached = m.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, request_data, (response) => {
            force_cache && m.getCacheManager().setItem(cache_id, response);
            success(response, false);
        }, (response) => {
            if (force_cache && (__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
    getRelation(id, relation, success, fail, freeze = false, force_cache = false, load_cache_first = false) {
        let m = this, url = this.getItemRelationURI(id, relation), cache_id = toKey({ id, relation }), __cached;
        if (force_cache && load_cache_first) {
            __cached = this.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, {}, function (response) {
            force_cache && m.getCacheManager().setItem(cache_id, response);
            success(response, false);
        }, function (response) {
            if (force_cache && (__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
    getRelationItems(id, relation, options, success, fail, freeze = false, force_cache = false, load_cache_first = false) {
        let m = this, url = this.getItemRelationURI(id, relation), filters = options["filters"], request_data = {};
        if (typeof options["max"] === "number") {
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") {
            request_data["page"] = options["page"];
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        let cache_id = toKey(Utils.assign({ relation: relation }, request_data)), __cached;
        if (force_cache && load_cache_first) {
            __cached = this.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, request_data, function (response) {
            force_cache && m.getCacheManager().setItem(cache_id, response);
            success(response, false);
        }, function (response) {
            if (force_cache && (__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYlNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFVLGNBQWMsRUFBeUIsS0FBSyxFQUFDLE1BQU0sUUFBUSxDQUFDO0FBb0c3RSxNQUFNLFdBQVcsR0FBVyx3QkFBd0IsRUFDakQsVUFBVSxHQUFZLDRCQUE0QixFQUNsRCxtQkFBbUIsR0FBRyxzQ0FBc0MsQ0FBQztBQUVoRSxJQUFJLEtBQUssR0FBRyxVQUFVLFlBQWlCO0lBQ3RDLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNsRSxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDO0FBQ3ZDLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxPQUFPO0lBSWIsWUFBK0IsV0FBb0IsRUFBRSxZQUFvQjtRQUExQyxnQkFBVyxHQUFYLFdBQVcsQ0FBUztRQUVsRCxJQUFJLEtBQUssR0FBUyxXQUFXLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQzthQUMxRCxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBQyxPQUFPLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksY0FBYyxDQUFDLFdBQVcsRUFBRSxXQUFXLEdBQUcsWUFBWSxDQUFDLENBQUM7SUFFL0UsQ0FBQztJQUVELE9BQU87UUFDTixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDO0lBQ3JDLENBQUM7SUFFRCxhQUFhO1FBQ1osT0FBTyxLQUFLLENBQUMsZ0JBQWdCLENBQUMs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QUNqQyxDQUFDLEVBQUUsVUFBVSxRQUFzQjtZQUNsQyxJQUFJLFdBQVcsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUU7Z0JBQ3RFLE9BQU8sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDeEI7aUJBQU07Z0JBQ04sSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ2Y7UUFDRixDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDWixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge09XZWJBcHAsIE9XZWJLZXlTdG9yYWdlLCBPV2ViQ29tLCBpQ29tUmVzcG9uc2UsIFV0aWxzfSBmcm9tIFwiLi9vd2ViXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VBZGRSZXNwb25zZTxUPiBleHRlbmRzIGlDb21SZXNwb25zZSB7XG5cdGRhdGE6IHtcblx0XHRpdGVtOiBULFxuXHRcdHJlbGF0aW9ucz86IHtcblx0XHRcdFtrZXk6IHN0cmluZ106IGFueVxuXHRcdH1cblx0fVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlTZXJ2aWNlR2V0UmVzcG9uc2U8VD4gIGV4dGVuZHMgaUNvbVJlc3BvbnNlIHtcblx0ZGF0YToge1xuXHRcdGl0ZW06IFQsXG5cdFx0cmVsYXRpb25zPzoge1xuXHRcdFx0W2tleTogc3RyaW5nXTogYW55XG5cdFx0fVxuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VHZXRBbGxSZXNwb25zZTxUPiAgZXh0ZW5kcyBpQ29tUmVzcG9uc2Uge1xuXHRkYXRhOiB7XG5cdFx0aXRlbXM6IFRbXSxcblx0XHRtYXg/OiBudW1iZXIsXG5cdFx0cGFnZT86IG51bWJlcixcblx0XHR0b3RhbD86IG51bWJlcixcblx0XHRyZWxhdGlvbnM/OiB7XG5cdFx0XHRba2V5OiBzdHJpbmddOiBhbnlcblx0XHR9XG5cdH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBpU2VydmljZVVwZGF0ZVJlc3BvbnNlPFQ+ICBleHRlbmRzIGlDb21SZXNwb25zZSB7XG5cdGRhdGE6IHtcblx0XHRpdGVtOiBULFxuXHRcdHJlbGF0aW9ucz86IHtcblx0XHRcdFtrZXk6IHN0cmluZ106IGFueVxuXHRcdH1cblx0fVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlTZXJ2aWNlVXBkYXRlQWxsRGF0YSBleHRlbmRzIGlDb21SZXNwb25zZSB7XG5cdGRhdGE6IHtcblx0XHRhZmZlY3RlZDogbnVtYmVyXG5cdH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBpU2VydmljZURlbGV0ZVJlc3BvbnNlPFQ+ICBleHRlbmRzIGlDb21SZXNwb25zZSB7XG5cdGRhdGE6IHtcblx0XHRpdGVtOiBUXG5cdH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBpU2VydmljZURlbGV0ZUFsbFJlc3BvbnNlPFQ+ICBleHRlbmRzIGlDb21SZXNwb25zZSB7XG5cdGRhdGE6IHtcblx0XHRhZmZlY3RlZDogbnVtYmVyXG5cdH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBpU2VydmljZUdldFJlbGF0aW9uSXRlbXNSZXNwb25zZTxUPiAgZXh0ZW5kcyBpQ29tUmVzcG9uc2Uge1xuXHRkYXRhOiB7XG5cdFx0aXRlbXM6IFRbXSxcblx0XHRtYXg/OiBudW1iZXIsXG5cdFx0cGFnZT86IG51bWJlcixcblx0XHR0b3RhbD86IG51bWJlcixcblx0XHRyZWxhdGlvbnM6IHtcblx0XHRcdFtrZXk6IHN0cmluZ106IGFueVxuXHRcdH1cblx0fVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlTZXJ2aWNlR2V0UmVsYXRpb25JdGVtUmVzcG9uc2U8VD4gIGV4dGVuZHMgaUNvbVJlc3BvbnNlIHtcblx0ZGF0YToge1xuXHRcdGl0ZW06IFQsXG5cdFx0cmVsYXRpb25zPzoge1xuXHRcdFx0W2tleTogc3RyaW5nXTogYW55XG5cdFx0fVxuXHR9XG59XG5cbmV4cG9ydCB0eXBlIHRTZXJ2aWNlQWRkU3VjY2VzczxUPiA9IChyZXNwb25zZTogaVNlcnZpY2VBZGRSZXNwb25zZTxUPikgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIHRTZXJ2aWNlVXBkYXRlU3VjY2VzczxUPiA9IChyZXNwb25zZTogaVNlcnZpY2VVcGRhdGVSZXNwb25zZTxUPikgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIHRTZXJ2aWNlVXBkYXRlQWxsU3VjY2VzczxUPiA9IChyZXNwb25zZTogaVNlcnZpY2VVcGRhdGVBbGxEYXRhKSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgdFNlcnZpY2VEZWxldGVTdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZURlbGV0ZVJlc3BvbnNlPFQ+KSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgdFNlcnZpY2VEZWxldGVBbGxTdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZURlbGV0ZUFsbFJlc3BvbnNlPFQ+KSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgdFNlcnZpY2VHZXRTdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZUdldFJlc3BvbnNlPFQ+LCBmcm9tQ2FjaGU6IGJvb2xlYW4pID0+IHZvaWQ7XG5leHBvcnQgdHlwZSB0U2VydmljZUdldEFsbFN1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlR2V0QWxsUmVzcG9uc2U8VD4sIGZyb21DYWNoZTogYm9vbGVhbikgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIHRTZXJ2aWNlR2V0UmVsYXRpb25TdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZUdldFJlbGF0aW9uSXRlbVJlc3BvbnNlPFQ+LCBmcm9tQ2FjaGU6IGJvb2xlYW4pID0+IHZvaWQ7XG5leHBvcnQgdHlwZSB0U2VydmljZUdldFJlbGF0aW9uSXRlbXNTdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZUdldFJlbGF0aW9uSXRlbXNSZXNwb25zZTxUPiwgZnJvbUNhY2hlOiBib29sZWFuKSA9PiB2b2lkO1xuXG5leHBvcnQgdHlwZSB0U2VydmljZUZhaWwgPSAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4gdm9pZDtcblxuZXhwb3J0IHR5cGUgdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucyA9IHtcblx0bWF4PzogbnVtYmVyLFxuXHRwYWdlPzogbnVtYmVyLFxuXHRmaWx0ZXJzPzogYW55LFxuXHRyZWxhdGlvbnM/OiBzdHJpbmcsXG5cdG9yZGVyX2J5Pzogc3RyaW5nXG59O1xuXG5jb25zdCB1cmlfc2VydmljZSAgICAgICAgID0gXCI6YXBpX3VybC86c2VydmljZV9uYW1lXCIsXG5cdCAgdXJpX2VudGl0eSAgICAgICAgICA9IFwiOmFwaV91cmwvOnNlcnZpY2VfbmFtZS86aWRcIixcblx0ICB1cmlfZW50aXR5X3JlbGF0aW9uID0gXCI6YXBpX3VybC86c2VydmljZV9uYW1lLzppZC86cmVsYXRpb25cIjtcblxubGV0IHRvS2V5ID0gZnVuY3Rpb24gKHF1ZXJ5X3BhcmFtczogYW55KSB7XG5cdGxldCBrZXkgPSBKU09OLnN0cmluZ2lmeShxdWVyeV9wYXJhbXMpLnJlcGxhY2UoL1teYS16MC05XS9pZywgXCJcIik7XG5cdHJldHVybiBrZXkubGVuZ3RoID8ga2V5IDogXCJuby1wYXJhbXNcIjtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJTZXJ2aWNlPFQ+IHtcblx0cHJpdmF0ZSByZWFkb25seSBfa2V5X3N0b3JlOiBPV2ViS2V5U3RvcmFnZTtcblx0cHJpdmF0ZSByZWFkb25seSBfYmFzZV9kYXRhOiB7IGFwaV91cmw6IGFueTsgc2VydmljZV9uYW1lOiBzdHJpbmcgfTtcblxuXHRjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgcmVhZG9ubHkgYXBwX2NvbnRleHQ6IE9XZWJBcHAsIHNlcnZpY2VfbmFtZTogc3RyaW5nKSB7XG5cblx0XHRsZXQgc191cmwgICAgICAgPSBhcHBfY29udGV4dC5jb25maWdzLmdldChcIk9aX0FQSV9CQVNFX1VSTFwiKVxuXHRcdFx0LnJlcGxhY2UoL1xcLyQvZywgXCJcIik7XG5cdFx0dGhpcy5fYmFzZV9kYXRhID0ge2FwaV91cmw6IHNfdXJsLCBzZXJ2aWNlX25hbWU6IHNlcnZpY2VfbmFtZX07XG5cdFx0dGhpcy5fa2V5X3N0b3JlID0gbmV3IE9XZWJLZXlTdG9yYWdlKGFwcF9jb250ZXh0LCBcInNlcnZpY2VzOlwiICsgc2VydmljZV9uYW1lKTtcblxuXHR9XG5cblx0Z2V0TmFtZSgpOiBzdHJpbmcge1xuXHRcdHJldHVybiB0aGlzLl9iYXNlX2RhdGEuc2VydmljZV9uYW1lO1xuXHR9XG5cblx0Z2V0U2VydmljZVVSSSgpIHtcblx0XHRyZXR1cm4gVXRpbHMuc3RyaW5nS2V5UmVwbGFjZSh1cmlfc2VydmljZSwgdGhpcy5fYmFzZV9kYXRhKTtcblx0fVxuXG5cdGdldEl0ZW1VUkkoaWQ6IGFueSk6IHN0cmluZyB7XG5cdFx0bGV0IGRhdGEgPSBVdGlscy5hc3NpZ24oe2lkOiBpZH0sIHRoaXMuX2Jhc2VfZGF0YSk7XG5cdFx0cmV0dXJuIFV0aWxzLnN0cmluZ0tleVJlcGxhY2UodXJpX2VudGl0eSwgZGF0YSk7XG5cdH1cblxuXHRnZXRJdGVtUmVsYXRpb25VUkkoaWQ6IHN0cmluZywgcmVsYXRpb246IHN0cmluZyk6IHN0cmluZyB7XG5cdFx0bGV0IGRhdGEgPSBVdGlscy5hc3NpZ24oe2lkOiBpZCwgcmVsYXRpb246IHJlbGF0aW9ufSwgdGhpcy5fYmFzZV9kYXRhKTtcblx0XHRyZXR1cm4gVXRpbHMuc3RyaW5nS2V5UmVwbGFjZSh1cmlfZW50aXR5X3JlbGF0aW9uLCBkYXRhKTtcblx0fVxuXG5cdGdldENhY2hlTWFuYWdlcigpOiBPV2ViS2V5U3RvcmFnZSB7XG5cdFx0cmV0dXJuIHRoaXMuX2tleV9zdG9yZTtcblx0fVxuXG5cdGFkZChmb3JtRGF0YTogYW55LCBzdWNjZXNzOiB0U2VydmljZUFkZFN1Y2Nlc3M8VD4sIGZhaWw6IHRTZXJ2aWNlRmFpbCwgZnJlZXplOiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgdXJsID0gdGhpcy5nZXRTZXJ2aWNlVVJJKCk7XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiUE9TVFwiLCB1cmwsIGZvcm1EYXRhLCAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0c3VjY2VzcyhyZXNwb25zZSBhcyBhbnkpO1xuXHRcdH0sIGZhaWwsIGZyZWV6ZSk7XG5cdH1cblxuXHRkZWxldGUoaWQ6IHN0cmluZywgc3VjY2VzczogdFNlcnZpY2VEZWxldGVTdWNjZXNzPFQ+LCBmYWlsOiB0U2VydmljZUZhaWwsIGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlKTogT1dlYkNvbSB7XG5cdFx0bGV0IG0gICA9IHRoaXMsXG5cdFx0XHR1cmwgPSB0aGlzLmdldEl0ZW1VUkkoaWQpO1xuXG5cdFx0cmV0dXJuIHRoaXMuYXBwX2NvbnRleHQucmVxdWVzdChcIkRFTEVURVwiLCB1cmwsIG51bGwsIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB7XG5cdFx0XHRtLmdldENhY2hlTWFuYWdlcigpLnJlbW92ZUl0ZW0oaWQpO1xuXHRcdFx0c3VjY2VzcyhyZXNwb25zZSBhcyBhbnkpO1xuXHRcdH0sIGZhaWwsIGZyZWV6ZSk7XG5cdH1cblxuXHR1cGRhdGUoaWQ6IHN0cmluZywgZm9ybURhdGE6IGFueSwgc3VjY2VzczogdFNlcnZpY2VVcGRhdGVTdWNjZXNzPFQ+LCBmYWlsOiB0U2VydmljZUZhaWwsIGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlKTogT1dlYkNvbSB7XG5cdFx0bGV0IHVybCA9IHRoaXMuZ2V0SXRlbVVSSShpZCk7XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiUEFUQ0hcIiwgdXJsLCBmb3JtRGF0YSwgKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHtcblx0XHRcdHN1Y2Nlc3MocmVzcG9uc2UgYXMgYW55KTtcblx0XHR9LCBmYWlsLCBmcmVlemUpO1xuXHR9XG5cblx0ZGVsZXRlQWxsKG9wdGlvbnM6IHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnMsIHN1Y2Nlc3M6IHRTZXJ2aWNlRGVsZXRlQWxsU3VjY2VzczxUPiwgZmFpbDogdFNlcnZpY2VGYWlsLCBmcmVlemU6IGJvb2xlYW4gPSBmYWxzZSk6IE9XZWJDb20ge1xuXHRcdGxldCB1cmwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSB0aGlzLmdldFNlcnZpY2VVUkkoKSxcblx0XHRcdGZpbHRlcnMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IG9wdGlvbnMuZmlsdGVycyxcblx0XHRcdHJlcXVlc3RfZGF0YTogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucyA9IHt9O1xuXG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zW1wibWF4XCJdID09PSBcIm51bWJlclwiKSB7Ly8gd2lsbCBiZSBpZ25vcmVkIGJ5IE8nWm9uZVxuXHRcdFx0cmVxdWVzdF9kYXRhW1wibWF4XCJdID0gb3B0aW9uc1tcIm1heFwiXTtcblx0XHR9XG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zW1wicGFnZVwiXSA9PT0gXCJudW1iZXJcIikgey8vIHdpbGwgYmUgaWdub3JlZCBieSBPJ1pvbmVcblx0XHRcdHJlcXVlc3RfZGF0YVtcInBhZ2VcIl0gPSBvcHRpb25zW1wicGFnZVwiXTtcblx0XHR9XG5cblx0XHRpZiAoVXRpbHMuaXNQbGFpbk9iamVjdChmaWx0ZXJzKSkge1xuXHRcdFx0cmVxdWVzdF9kYXRhW1wiZmlsdGVyc1wiXSA9IGZpbHRlcnM7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuYXBwX2NvbnRleHQucmVxdWVzdChcIkRFTEVURVwiLCB1cmwsIHJlcXVlc3RfZGF0YSwgKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHtcblx0XHRcdHN1Y2Nlc3MocmVzcG9uc2UgYXMgYW55KTtcblx0XHR9LCBmYWlsLCBmcmVlemUpO1xuXHR9XG5cblx0dXBkYXRlQWxsKG9wdGlvbnM6IHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnMsIGZvcm1EYXRhOiBhbnksIHN1Y2Nlc3M6IHRTZXJ2aWNlVXBkYXRlQWxsU3VjY2VzczxUPiwgZmFpbDogdFNlcnZpY2VGYWlsLCBmcmVlemU6IGJvb2xlYW4gPSBmYWxzZSk6IE9XZWJDb20ge1xuXHRcdGxldCB1cmwgICAgICAgICAgICAgICAgID0gdGhpcy5nZXRTZXJ2aWNlVVJJKCksXG5cdFx0XHRmaWx0ZXJzICAgICAgICAgICAgID0gb3B0aW9ucy5maWx0ZXJzLFxuXHRcdFx0cmVxdWVzdF9kYXRhOiB0U2VydmljZVJlcXVlc3RPcHRpb25zXG5cdFx0XHRcdCYgeyBkYXRhOiBhbnkgfSA9IHtkYXRhOiBmb3JtRGF0YX07XG5cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbXCJtYXhcIl0gPT09IFwibnVtYmVyXCIpIHsvLyB3aWxsIGJlIGlnbm9yZWQgYnkgTydab25lXG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJtYXhcIl0gPSBvcHRpb25zW1wibWF4XCJdO1xuXHRcdH1cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbXCJwYWdlXCJdID09PSBcIm51bWJlclwiKSB7Ly8gd2lsbCBiZSBpZ25vcmVkIGJ5IE8nWm9uZVxuXHRcdFx0cmVxdWVzdF9kYXRhW1wicGFnZVwiXSA9IG9wdGlvbnNbXCJwYWdlXCJdO1xuXHRcdH1cblxuXHRcdGlmIChVdGlscy5pc1BsYWluT2JqZWN0KGZpbHRlcnMpKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJmaWx0ZXJzXCJdID0gZmlsdGVycztcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiUEFUQ0hcIiwgdXJsLCByZXF1ZXN0X2RhdGEsIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB7XG5cdFx0XHRzdWNjZXNzKHJlc3BvbnNlIGFzIGFueSk7XG5cdFx0fSwgZmFpbCwgZnJlZXplKTtcblx0fVxuXG5cdGdldChpZDogc3RyaW5nLCByZWxhdGlvbnM6IHN0cmluZyA9IFwiXCIsIHN1Y2Nlc3M6IHRTZXJ2aWNlR2V0U3VjY2VzczxUPiwgZmFpbDogdFNlcnZpY2VGYWlsLCBmcmVlemU6IGJvb2xlYW4gPSBmYWxzZSwgbG9hZF9jYWNoZV9maXJzdDogYm9vbGVhbiA9IGZhbHNlKTogT1dlYkNvbSB7XG5cdFx0bGV0IG0gICAgICAgICA9IHRoaXMsXG5cdFx0XHR1cmwgICAgICAgPSB0aGlzLmdldEl0ZW1VUkkoaWQpLFxuXHRcdFx0ZGF0YTogYW55ID0gbnVsbCxcblx0XHRcdGNhY2hlX2lkICA9IGlkLCBfX2NhY2hlZDtcblxuXHRcdGlmIChyZWxhdGlvbnMubGVuZ3RoKSB7XG5cdFx0XHRkYXRhID0ge3JlbGF0aW9uc307XG5cdFx0fVxuXG5cdFx0aWYgKGxvYWRfY2FjaGVfZmlyc3QpIHtcblx0XHRcdF9fY2FjaGVkID0gbS5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKTtcblxuXHRcdFx0aWYgKF9fY2FjaGVkKSB7XG5cdFx0XHRcdHN1Y2Nlc3MoX19jYWNoZWQsIHRydWUpO1xuXHRcdFx0XHRmcmVlemUgPSBmYWxzZTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiR0VUXCIsIHVybCwgZGF0YSwgKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHtcblx0XHRcdG0uZ2V0Q2FjaGVNYW5hZ2VyKCkuc2V0SXRlbShpZCwgcmVzcG9uc2UpO1xuXHRcdFx0c3VjY2VzcyhyZXNwb25zZSBhcyBhbnksIGZhbHNlKTtcblx0XHR9LCAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXG5cdFx0XHRpZiAoKF9fY2FjaGVkID0gbS5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKSkpIHtcblx0XHRcdFx0c3VjY2VzcyhfX2NhY2hlZCwgdHJ1ZSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRmYWlsKHJlc3BvbnNlKTtcblx0XHRcdH1cblx0XHR9LCBmcmVlemUpO1xuXG5cdH1cblxuXHRnZXRBbGwob3B0aW9uczogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucywgc3VjY2VzczogdFNlcnZpY2VHZXRBbGxTdWNjZXNzPFQ+LCBmYWlsOiB0U2VydmljZUZhaWwsIGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlLCBmb3JjZV9jYWNoZTogYm9vbGVhbiA9IGZhbHNlLCBsb2FkX2NhY2hlX2ZpcnN0OiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgbSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gdGhpcyxcblx0XHRcdHVybCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IHRoaXMuZ2V0U2VydmljZVVSSSgpLFxuXHRcdFx0ZmlsdGVycyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gb3B0aW9uc1tcImZpbHRlcnNcIl0sXG5cdFx0XHRyZXF1ZXN0X2RhdGE6IHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnMgPSB7fSxcblx0XHRcdF9fY2FjaGVkO1xuXG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zW1wibWF4XCJdID09PSBcIm51bWJlclwiKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJtYXhcIl0gPSBvcHRpb25zW1wibWF4XCJdO1xuXHRcdH1cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbXCJwYWdlXCJdID09PSBcIm51bWJlclwiKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJwYWdlXCJdID0gb3B0aW9uc1tcInBhZ2VcIl07XG5cdFx0fVxuXG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zLnJlbGF0aW9ucyA9PT0gXCJzdHJpbmdcIikge1xuXHRcdFx0cmVxdWVzdF9kYXRhW1wicmVsYXRpb25zXCJdID0gb3B0aW9ucy5yZWxhdGlvbnNcblx0XHR9XG5cblx0XHRpZiAodHlwZW9mIG9wdGlvbnMub3JkZXJfYnkgPT09IFwic3RyaW5nXCIpIHtcblx0XHRcdHJlcXVlc3RfZGF0YVtcIm9yZGVyX2J5XCJdID0gb3B0aW9ucy5vcmRlcl9ieVxuXHRcdH1cblxuXHRcdGlmIChVdGlscy5pc1BsYWluT2JqZWN0KGZpbHRlcnMpKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJmaWx0ZXJzXCJdID0gZmlsdGVycztcblx0XHR9XG5cblx0XHRsZXQgY2FjaGVfaWQgPSB0b0tleShyZXF1ZXN0X2RhdGEpO1xuXG5cdFx0aWYgKGZvcmNlX2NhY2hlICYmIGxvYWRfY2FjaGVfZmlyc3QpIHtcblx0XHRcdF9fY2FjaGVkID0gbS5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKTtcblxuXHRcdFx0aWYgKF9fY2FjaGVkKSB7XG5cdFx0XHRcdHN1Y2Nlc3MoX19jYWNoZWQsIHRydWUpO1xuXHRcdFx0XHRmcmVlemUgPSBmYWxzZTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiR0VUXCIsIHVybCwgcmVxdWVzdF9kYXRhLCAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0Zm9yY2VfY2FjaGUgJiYgbS5nZXRDYWNoZU1hbmFnZXIoKS5zZXRJdGVtKGNhY2hlX2lkLCByZXNwb25zZSk7XG5cdFx0XHRzdWNjZXNzKHJlc3BvbnNlIGFzIGFueSwgZmFsc2UpO1xuXHRcdH0sIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB7XG5cdFx0XHRpZiAoZm9yY2VfY2FjaGUgJiYgKF9fY2FjaGVkID0gbS5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKSkpIHtcblx0XHRcdFx0c3VjY2VzcyhfX2NhY2hlZCwgdHJ1ZSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRmYWlsKHJlc3BvbnNlKTtcblx0XHRcdH1cblx0XHR9LCBmcmVlemUpO1xuXG5cdH1cblxuXHRnZXRSZWxhdGlvbjxSPihpZDogc3RyaW5nLCByZWxhdGlvbjogc3RyaW5nLCBzdWNjZXNzOiB0U2VydmljZUdldFJlbGF0aW9uU3VjY2VzczxSPiwgZmFpbDogdFNlcnZpY2VGYWlsLCBmcmVlemU6IGJvb2xlYW4gPSBmYWxzZSwgZm9yY2VfY2FjaGU6IGJvb2xlYW4gPSBmYWxzZSwgbG9hZF9jYWNoZV9maXJzdDogYm9vbGVhbiA9IGZhbHNlKTogT1dlYkNvbSB7XG5cdFx0bGV0IG0gICAgICAgID0gdGhpcyxcblx0XHRcdHVybCAgICAgID0gdGhpcy5nZXRJdGVtUmVsYXRpb25VUkkoaWQsIHJlbGF0aW9uKSxcblx0XHRcdGNhY2hlX2lkID0gdG9LZXkoe2lkLCByZWxhdGlvbn0pLCBfX2NhY2hlZDtcblxuXHRcdGlmIChmb3JjZV9jYWNoZSAmJiBsb2FkX2NhY2hlX2ZpcnN0KSB7XG5cdFx0XHRfX2NhY2hlZCA9IHRoaXMuZ2V0Q2FjaGVNYW5hZ2VyKCkuZ2V0SXRlbShjYWNoZV9pZCk7XG5cblx0XHRcdGlmIChfX2NhY2hlZCkge1xuXHRcdFx0XHRzdWNjZXNzKF9fY2FjaGVkLCB0cnVlKTtcblx0XHRcdFx0ZnJlZXplID0gZmFsc2U7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuYXBwX2NvbnRleHQucmVxdWVzdChcIkdFVFwiLCB1cmwsIHt9LCBmdW5jdGlvbiAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkge1xuXHRcdFx0Zm9yY2VfY2FjaGUgJiYgbS5nZXRDYWNoZU1hbmFnZXIoKS5zZXRJdGVtKGNhY2hlX2lkLCByZXNwb25zZSk7XG5cdFx0XHRzdWNjZXNzKHJlc3BvbnNlIGFzIGFueSwgZmFsc2UpO1xuXHRcdH0sIGZ1bmN0aW9uIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSB7XG5cdFx0XHRpZiAoZm9yY2VfY2FjaGUgJiYgKF9fY2FjaGVkID0gbS5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKSkpIHtcblx0XHRcdFx0c3VjY2VzcyhfX2NhY2hlZCwgdHJ1ZSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRmYWlsKHJlc3BvbnNlKTtcblx0XHRcdH1cblx0XHR9LCBmcmVlemUpO1xuXHR9XG5cblx0Z2V0UmVsYXRpb25JdGVtczxSPihpZDogc3RyaW5nLCByZWxhdGlvbjogc3RyaW5nLCBvcHRpb25zOiB0U2VydmljZVJlcXVlc3RPcHRpb25zLCBzdWNjZXNzOiB0U2VydmljZUdldFJlbGF0aW9uSXRlbXNTdWNjZXNzPFI+LCBmYWlsOiB0U2VydmljZUZhaWwsIGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlLCBmb3JjZV9jYWNoZTogYm9vbGVhbiA9IGZhbHNlLCBsb2FkX2NhY2hlX2ZpcnN0OiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgbSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gdGhpcyxcblx0XHRcdHVybCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IHRoaXMuZ2V0SXRlbVJlbGF0aW9uVVJJKGlkLCByZWxhdGlvbiksXG5cdFx0XHRmaWx0ZXJzICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBvcHRpb25zW1wiZmlsdGVyc1wiXSxcblx0XHRcdHJlcXVlc3RfZGF0YTogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucyA9IHt9O1xuXG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zW1wibWF4XCJdID09PSBcIm51bWJlclwiKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJtYXhcIl0gPSBvcHRpb25zW1wibWF4XCJdO1xuXHRcdH1cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbXCJwYWdlXCJdID09PSBcIm51bWJlclwiKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJwYWdlXCJdID0gb3B0aW9uc1tcInBhZ2VcIl07XG5cdFx0fVxuXG5cdFx0aWYgKFV0aWxzLmlzUGxhaW5PYmplY3QoZmlsdGVycykpIHtcblx0XHRcdHJlcXVlc3RfZGF0YVtcImZpbHRlcnNcIl0gPSBmaWx0ZXJzO1xuXHRcdH1cblxuXHRcdGxldCBjYWNoZV9pZCA9IHRvS2V5KFV0aWxzLmFzc2lnbih7cmVsYXRpb246IHJlbGF0aW9ufSwgcmVxdWVzdF9kYXRhKSksXG5cdFx0XHRfX2NhY2hlZDtcblxuXHRcdGlmIChmb3JjZV9jYWNoZSAmJiBsb2FkX2NhY2hlX2ZpcnN0KSB7XG5cdFx0XHRfX2NhY2hlZCA9IDxpU2VydmljZUdldFJlbGF0aW9uSXRlbXNSZXNwb25zZTxSPj50aGlzLmdldENhY2hlTWFuYWdlcigpLmdldEl0ZW0oY2FjaGVfaWQpO1xuXG5cdFx0XHRpZiAoX19jYWNoZWQpIHtcblx0XHRcdFx0c3VjY2VzcyhfX2NhY2hlZCwgdHJ1ZSk7XG5cdFx0XHRcdGZyZWV6ZSA9IGZhbHNlO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzLmFwcF9jb250ZXh0LnJlcXVlc3QoXCJHRVRcIiwgdXJsLCByZXF1ZXN0X2RhdGEsIGZ1bmN0aW9uIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSB7XG5cblx0XHRcdGZvcmNlX2NhY2hlICYmIG0uZ2V0Q2FjaGVNYW5hZ2VyKCkuc2V0SXRlbShjYWNoZV9pZCwgcmVzcG9uc2UpO1xuXG5cdFx0XHRzdWNjZXNzKHJlc3BvbnNlIGFzIGFueSwgZmFsc2UpO1xuXHRcdH0sIGZ1bmN0aW9uIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSB7XG5cdFx0XHRpZiAoZm9yY2VfY2FjaGUgJiYgKF9fY2FjaGVkID0gbS5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKSkpIHtcblx0XHRcdFx0c3VjY2VzcyhfX2NhY2hlZCwgdHJ1ZSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRmYWlsKHJlc3BvbnNlKTtcblx0XHRcdH1cblx0XHR9LCBmcmVlemUpO1xuXHR9XG59Il19