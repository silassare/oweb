import OWebKeyStorage from "./OWebKeyStorage";
import Utils from "./utils/Utils";
const uri_service = ":api_url/:service_name", uri_entity = ":api_url/:service_name/:id", uri_entity_relation = ":api_url/:service_name/:id/:relation";
let toKey = function (query_params) {
    let key = JSON.stringify(query_params).replace(/[^a-z0-9]/ig, "");
    return key.length ? key : "no-params";
};
export default class OWebService {
    /**
     * @param app_context The app context.
     * @param service_name The service name.
     */
    constructor(app_context, service_name) {
        this.app_context = app_context;
        let s_url = app_context.configs.get("OZ_API_BASE_URL")
            .replace(/\/$/g, "");
        this._base_data = { api_url: s_url, service_name: service_name };
        this._key_store = new OWebKeyStorage(app_context, "services:" + service_name);
    }
    /**
     * Returns the service name.
     */
    getName() {
        return this._base_data.service_name;
    }
    /**
     * Returns the service URI.
     */
    getServiceURI() {
        return Utils.stringKeyReplace(uri_service, this._base_data);
    }
    /**
     * Returns entity URI.
     *
     * @param id The entity id.
     */
    getItemURI(id) {
        let data = Utils.assign({ id: id }, this._base_data);
        return Utils.stringKeyReplace(uri_entity, data);
    }
    /**
     * Returns entity relation URI.
     *
     * @param id The entity id.
     * @param relation The relation name.
     */
    getItemRelationURI(id, relation) {
        let data = Utils.assign({ id: id, relation: relation }, this._base_data);
        return Utils.stringKeyReplace(uri_entity_relation, data);
    }
    /**
     * Cache manager getter.
     */
    getCacheManager() {
        return this._key_store;
    }
    /**
     * Adds an entity.
     *
     * @param formData
     * @param success
     * @param fail
     * @param freeze
     */
    add(formData, success, fail, freeze = false) {
        let url = this.getServiceURI(), request_data = { data: formData };
        return this.app_context.request("POST", url, request_data, (response) => {
            success(response);
        }, fail, freeze);
    }
    /**
     * Deletes the entity with the given id.
     *
     * @param id The entity id.
     * @param success
     * @param fail
     * @param freeze
     */
    delete(id, success, fail, freeze = false) {
        let m = this, url = this.getItemURI(id);
        return this.app_context.request("DELETE", url, null, (response) => {
            m.getCacheManager().removeItem(id);
            success(response);
        }, fail, freeze);
    }
    /**
     * Updates the entity with the given id.
     *
     * @param id The entity id.
     * @param formData
     * @param success
     * @param fail
     * @param freeze
     */
    update(id, formData, success, fail, freeze = false) {
        let url = this.getItemURI(id), request_data = { data: formData };
        return this.app_context.request("PATCH", url, request_data, (response) => {
            success(response);
        }, fail, freeze);
    }
    /**
     * Deletes all entities.
     *
     * @param options
     * @param success
     * @param fail
     * @param freeze
     */
    deleteAll(options, success, fail, freeze = false) {
        let url = this.getServiceURI(), filters = options.filters, request_data = {};
        if (typeof options["max"] === "number") { // will be ignored by O'Zone
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") { // will be ignored by O'Zone
            request_data["page"] = options["page"];
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        return this.app_context.request("DELETE", url, request_data, (response) => {
            success(response);
        }, fail, freeze);
    }
    /**
     * Updates all entities.
     *
     * @param options
     * @param formData
     * @param success
     * @param fail
     * @param freeze
     */
    updateAll(options, formData, success, fail, freeze = false) {
        let url = this.getServiceURI(), filters = options.filters, request_data = { data: formData };
        if (typeof options["max"] === "number") { // will be ignored by O'Zone
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") { // will be ignored by O'Zone
            request_data["page"] = options["page"];
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        return this.app_context.request("PATCH", url, request_data, (response) => {
            success(response);
        }, fail, freeze);
    }
    /**
     * Gets an entity with the given id.
     *
     * All requested relations names are joined with `|`.
     * example: `relation1|relation2|relationX`.
     *
     * @param id The entity id.
     * @param relations The relations string.
     * @param success
     * @param fail
     * @param freeze
     * @param load_cache_first
     */
    get(id, relations = "", success, fail, freeze = false, load_cache_first = false) {
        let m = this, url = this.getItemURI(id), cache_id = id, data = {}, __cached;
        if (relations.length) {
            data.relations = relations;
        }
        if (load_cache_first) {
            __cached = m.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, data, (response) => {
            m.getCacheManager().setItem(id, response);
            success(response, false);
        }, (response) => {
            if ((__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
    /**
     * Gets all entities.
     *
     * @param options
     * @param success
     * @param fail
     * @param freeze
     * @param force_cache
     * @param load_cache_first
     */
    getAll(options, success, fail, freeze = false, force_cache = false, load_cache_first = false) {
        let m = this, url = this.getServiceURI(), filters = options["filters"], request_data = {}, __cached;
        if (typeof options["max"] === "number") {
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") {
            request_data["page"] = options["page"];
        }
        if (typeof options.relations === "string") {
            request_data["relations"] = options.relations;
        }
        if (typeof options.collection === "string") {
            request_data["collection"] = options.collection;
        }
        if (typeof options.order_by === "string") {
            request_data["order_by"] = options.order_by;
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        let cache_id = toKey(request_data);
        if (force_cache && load_cache_first) {
            __cached = m.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, request_data, (response) => {
            force_cache && m.getCacheManager().setItem(cache_id, response);
            success(response, false);
        }, (response) => {
            if (force_cache && (__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
    /**
     * Gets a single item relation for a given entity id.
     *
     * @param id The entity id.
     * @param relation The relation name
     * @param success
     * @param fail
     * @param freeze
     * @param force_cache
     * @param load_cache_first
     */
    getRelation(id, relation, success, fail, freeze = false, force_cache = false, load_cache_first = false) {
        let m = this, url = this.getItemRelationURI(id, relation), cache_id = toKey({ id, relation }), __cached;
        if (force_cache && load_cache_first) {
            __cached = this.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, {}, function (response) {
            force_cache && m.getCacheManager().setItem(cache_id, response);
            success(response, false);
        }, function (response) {
            if (force_cache && (__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
    /**
     * Gets multiple items relation for a given entity id.
     *
     * @param id The entity id.
     * @param relation The relation name.
     * @param options
     * @param success
     * @param fail
     * @param freeze
     * @param force_cache
     * @param load_cache_first
     */
    getRelationItems(id, relation, options, success, fail, freeze = false, force_cache = false, load_cache_first = false) {
        let m = this, url = this.getItemRelationURI(id, relation), filters = options["filters"], request_data = {};
        if (typeof options["max"] === "number") {
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") {
            request_data["page"] = options["page"];
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        let cache_id = toKey(Utils.assign({ relation: relation }, request_data)), __cached;
        if (force_cache && load_cache_first) {
            __cached = this.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, request_data, function (response) {
            force_cache && m.getCacheManager().setItem(cache_id, response);
            success(response, false);
        }, function (response) {
            if (force_cache && (__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYlNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxjQUFjLE1BQU0sa0JBQWtCLENBQUM7QUFDOUMsT0FBTyxLQUFLLE1BQU0sZUFBZSxDQUFDO0FBc0dsQyxNQUFNLFdBQVcsR0FBVyx3QkFBd0IsRUFDakQsVUFBVSxHQUFZLDRCQUE0QixFQUNsRCxtQkFBbUIsR0FBRyxzQ0FBc0MsQ0FBQztBQUVoRSxJQUFJLEtBQUssR0FBRyxVQUFVLFlBQWlCO0lBQ3RDLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNsRSxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDO0FBQ3ZDLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxPQUFPO0lBSWI7OztPQUdHO0lBQ0gsWUFBK0IsV0FBb0IsRUFBRSxZQUFvQjtRQUExQyxnQkFBVyxHQUFYLFdBQVcsQ0FBUztRQUVsRCxJQUFJLEtBQUssR0FBUyxXQUFXLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQzthQUNuRCxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQzdCLElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBQyxPQUFPLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksY0FBYyxDQUFDLFdBQVcsRUFBRSxXQUFXLEdBQUcsWUFBWSxDQUFDLENBQUM7SUFFL0UsQ0FBQztJQUVEOztPQUVHO0lBQ0gsT0FBTztRQUNOLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUM7SUFDckMsQ0FBQztJQUVEOztP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QUUsWUFBWSxDQUFDLENBQUMsRUFDckUsUUFBUSxDQUFDO1FBRVYsSUFBSSxXQUFXLElBQUksZ0JBQWdCLEVBQUU7WUFDcEMsUUFBUSxHQUF3QyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRXpGLElBQUksUUFBUSxFQUFFO2dCQUNiLE9BQU8sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQ3hCLE1BQU0sR0FBRyxLQUFLLENBQUM7YUFDZjtTQUNEO1FBRUQsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLFlBQVksRUFBRSxVQUFVLFFBQXNCO1lBRXpGLFdBQVcsSUFBSSxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUUvRCxPQUFPLENBQUMsUUFBZSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2pDLENBQUMsRUFBRSxVQUFVLFFBQXNCO1lBQ2xDLElBQUksV0FBVyxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRTtnQkFDdEUsT0FBTyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQzthQUN4QjtpQkFBTTtnQkFDTixJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDZjtRQUNGLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNaLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBPV2ViQXBwIGZyb20gXCIuL09XZWJBcHBcIjtcbmltcG9ydCBPV2ViQ29tLCB7aUNvbVJlc3BvbnNlfSBmcm9tIFwiLi9PV2ViQ29tXCI7XG5pbXBvcnQgT1dlYktleVN0b3JhZ2UgZnJvbSBcIi4vT1dlYktleVN0b3JhZ2VcIjtcbmltcG9ydCBVdGlscyBmcm9tIFwiLi91dGlscy9VdGlsc1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIGlTZXJ2aWNlQWRkUmVzcG9uc2U8VD4gZXh0ZW5kcyBpQ29tUmVzcG9uc2Uge1xuXHRkYXRhOiB7XG5cdFx0aXRlbTogVCxcblx0XHRyZWxhdGlvbnM/OiB7XG5cdFx0XHRba2V5OiBzdHJpbmddOiBhbnlcblx0XHR9XG5cdH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBpU2VydmljZUdldFJlc3BvbnNlPFQ+ICBleHRlbmRzIGlDb21SZXNwb25zZSB7XG5cdGRhdGE6IHtcblx0XHRpdGVtOiBULFxuXHRcdHJlbGF0aW9ucz86IHtcblx0XHRcdFtrZXk6IHN0cmluZ106IGFueVxuXHRcdH1cblx0fVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlTZXJ2aWNlR2V0QWxsUmVzcG9uc2U8VD4gIGV4dGVuZHMgaUNvbVJlc3BvbnNlIHtcblx0ZGF0YToge1xuXHRcdGl0ZW1zOiBUW10sXG5cdFx0bWF4PzogbnVtYmVyLFxuXHRcdHBhZ2U/OiBudW1iZXIsXG5cdFx0dG90YWw/OiBudW1iZXIsXG5cdFx0cmVsYXRpb25zPzoge1xuXHRcdFx0W2tleTogc3RyaW5nXTogYW55XG5cdFx0fVxuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VVcGRhdGVSZXNwb25zZTxUPiAgZXh0ZW5kcyBpQ29tUmVzcG9uc2Uge1xuXHRkYXRhOiB7XG5cdFx0aXRlbTogVCxcblx0XHRyZWxhdGlvbnM/OiB7XG5cdFx0XHRba2V5OiBzdHJpbmddOiBhbnlcblx0XHR9XG5cdH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBpU2VydmljZVVwZGF0ZUFsbERhdGEgZXh0ZW5kcyBpQ29tUmVzcG9uc2Uge1xuXHRkYXRhOiB7XG5cdFx0YWZmZWN0ZWQ6IG51bWJlclxuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VEZWxldGVSZXNwb25zZTxUPiAgZXh0ZW5kcyBpQ29tUmVzcG9uc2Uge1xuXHRkYXRhOiB7XG5cdFx0aXRlbTogVFxuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VEZWxldGVBbGxSZXNwb25zZTxUPiAgZXh0ZW5kcyBpQ29tUmVzcG9uc2Uge1xuXHRkYXRhOiB7XG5cdFx0YWZmZWN0ZWQ6IG51bWJlclxuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VHZXRSZWxhdGlvbkl0ZW1zUmVzcG9uc2U8VD4gIGV4dGVuZHMgaUNvbVJlc3BvbnNlIHtcblx0ZGF0YToge1xuXHRcdGl0ZW1zOiBUW10sXG5cdFx0bWF4PzogbnVtYmVyLFxuXHRcdHBhZ2U/OiBudW1iZXIsXG5cdFx0dG90YWw/OiBudW1iZXIsXG5cdFx0cmVsYXRpb25zOiB7XG5cdFx0XHRba2V5OiBzdHJpbmddOiBhbnlcblx0XHR9XG5cdH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBpU2VydmljZUdldFJlbGF0aW9uSXRlbVJlc3BvbnNlPFQ+ICBleHRlbmRzIGlDb21SZXNwb25zZSB7XG5cdGRhdGE6IHtcblx0XHRpdGVtOiBULFxuXHRcdHJlbGF0aW9ucz86IHtcblx0XHRcdFtrZXk6IHN0cmluZ106IGFueVxuXHRcdH1cblx0fVxufVxuXG5leHBvcnQgdHlwZSB0U2VydmljZUFkZFN1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlQWRkUmVzcG9uc2U8VD4pID0+IHZvaWQ7XG5leHBvcnQgdHlwZSB0U2VydmljZVVwZGF0ZVN1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlVXBkYXRlUmVzcG9uc2U8VD4pID0+IHZvaWQ7XG5leHBvcnQgdHlwZSB0U2VydmljZVVwZGF0ZUFsbFN1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlVXBkYXRlQWxsRGF0YSkgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIHRTZXJ2aWNlRGVsZXRlU3VjY2VzczxUPiA9IChyZXNwb25zZTogaVNlcnZpY2VEZWxldGVSZXNwb25zZTxUPikgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIHRTZXJ2aWNlRGVsZXRlQWxsU3VjY2VzczxUPiA9IChyZXNwb25zZTogaVNlcnZpY2VEZWxldGVBbGxSZXNwb25zZTxUPikgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIHRTZXJ2aWNlR2V0U3VjY2VzczxUPiA9IChyZXNwb25zZTogaVNlcnZpY2VHZXRSZXNwb25zZTxUPiwgZnJvbUNhY2hlOiBib29sZWFuKSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgdFNlcnZpY2VHZXRBbGxTdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZUdldEFsbFJlc3BvbnNlPFQ+LCBmcm9tQ2FjaGU6IGJvb2xlYW4pID0+IHZvaWQ7XG5leHBvcnQgdHlwZSB0U2VydmljZUdldFJlbGF0aW9uU3VjY2VzczxUPiA9IChyZXNwb25zZTogaVNlcnZpY2VHZXRSZWxhdGlvbkl0ZW1SZXNwb25zZTxUPiwgZnJvbUNhY2hlOiBib29sZWFuKSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgdFNlcnZpY2VHZXRSZWxhdGlvbkl0ZW1zU3VjY2VzczxUPiA9IChyZXNwb25zZTogaVNlcnZpY2VHZXRSZWxhdGlvbkl0ZW1zUmVzcG9uc2U8VD4sIGZyb21DYWNoZTogYm9vbGVhbikgPT4gdm9pZDtcblxuZXhwb3J0IHR5cGUgdFNlcnZpY2VGYWlsID0gKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHZvaWQ7XG5cbmV4cG9ydCB0eXBlIHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnMgPSB7XG5cdGRhdGE/OiBhbnksXG5cdGZpbHRlcnM/OiBhbnksXG5cdHJlbGF0aW9ucz86IHN0cmluZyxcblx0Y29sbGVjdGlvbj86IHN0cmluZyxcblx0b3JkZXJfYnk/OiBzdHJpbmcsXG5cdG1heD86IG51bWJlcixcblx0cGFnZT86IG51bWJlclxufTtcblxuY29uc3QgdXJpX3NlcnZpY2UgICAgICAgICA9IFwiOmFwaV91cmwvOnNlcnZpY2VfbmFtZVwiLFxuXHQgIHVyaV9lbnRpdHkgICAgICAgICAgPSBcIjphcGlfdXJsLzpzZXJ2aWNlX25hbWUvOmlkXCIsXG5cdCAgdXJpX2VudGl0eV9yZWxhdGlvbiA9IFwiOmFwaV91cmwvOnNlcnZpY2VfbmFtZS86aWQvOnJlbGF0aW9uXCI7XG5cbmxldCB0b0tleSA9IGZ1bmN0aW9uIChxdWVyeV9wYXJhbXM6IGFueSkge1xuXHRsZXQga2V5ID0gSlNPTi5zdHJpbmdpZnkocXVlcnlfcGFyYW1zKS5yZXBsYWNlKC9bXmEtejAtOV0vaWcsIFwiXCIpO1xuXHRyZXR1cm4ga2V5Lmxlbmd0aCA/IGtleSA6IFwibm8tcGFyYW1zXCI7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViU2VydmljZTxUPiB7XG5cdHByaXZhdGUgcmVhZG9ubHkgX2tleV9zdG9yZTogT1dlYktleVN0b3JhZ2U7XG5cdHByaXZhdGUgcmVhZG9ubHkgX2Jhc2VfZGF0YTogeyBhcGlfdXJsOiBhbnk7IHNlcnZpY2VfbmFtZTogc3RyaW5nIH07XG5cblx0LyoqXG5cdCAqIEBwYXJhbSBhcHBfY29udGV4dCBUaGUgYXBwIGNvbnRleHQuXG5cdCAqIEBwYXJhbSBzZXJ2aWNlX25hbWUgVGhlIHNlcnZpY2UgbmFtZS5cblx0ICovXG5cdGNvbnN0cnVjdG9yKHByb3RlY3RlZCByZWFkb25seSBhcHBfY29udGV4dDogT1dlYkFwcCwgc2VydmljZV9uYW1lOiBzdHJpbmcpIHtcblxuXHRcdGxldCBzX3VybCAgICAgICA9IGFwcF9jb250ZXh0LmNvbmZpZ3MuZ2V0KFwiT1pfQVBJX0JBU0VfVVJMXCIpXG5cdFx0XHRcdFx0XHRcdFx0XHQgLnJlcGxhY2UoL1xcLyQvZywgXCJcIik7XG5cdFx0dGhpcy5fYmFzZV9kYXRhID0ge2FwaV91cmw6IHNfdXJsLCBzZXJ2aWNlX25hbWU6IHNlcnZpY2VfbmFtZX07XG5cdFx0dGhpcy5fa2V5X3N0b3JlID0gbmV3IE9XZWJLZXlTdG9yYWdlKGFwcF9jb250ZXh0LCBcInNlcnZpY2VzOlwiICsgc2VydmljZV9uYW1lKTtcblxuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgdGhlIHNlcnZpY2UgbmFtZS5cblx0ICovXG5cdGdldE5hbWUoKTogc3RyaW5nIHtcblx0XHRyZXR1cm4gdGhpcy5fYmFzZV9kYXRhLnNlcnZpY2VfbmFtZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHRoZSBzZXJ2aWNlIFVSSS5cblx0ICovXG5cdGdldFNlcnZpY2VVUkkoKSB7XG5cdFx0cmV0dXJuIFV0aWxzLnN0cmluZ0tleVJlcGxhY2UodXJpX3NlcnZpY2UsIHRoaXMuX2Jhc2VfZGF0YSk7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyBlbnRpdHkgVVJJLlxuXHQgKlxuXHQgKiBAcGFyYW0gaWQgVGhlIGVudGl0eSBpZC5cblx0ICovXG5cdGdldEl0ZW1VUkkoaWQ6IGFueSk6IHN0cmluZyB7XG5cdFx0bGV0IGRhdGEgPSBVdGlscy5hc3NpZ24oe2lkOiBpZH0sIHRoaXMuX2Jhc2VfZGF0YSk7XG5cdFx0cmV0dXJuIFV0aWxzLnN0cmluZ0tleVJlcGxhY2UodXJpX2VudGl0eSwgZGF0YSk7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyBlbnRpdHkgcmVsYXRpb24gVVJJLlxuXHQgKlxuXHQgKiBAcGFyYW0gaWQgVGhlIGVudGl0eSBpZC5cblx0ICogQHBhcmFtIHJlbGF0aW9uIFRoZSByZWxhdGlvbiBuYW1lLlxuXHQgKi9cblx0Z2V0SXRlbVJlbGF0aW9uVVJJKGlkOiBzdHJpbmcsIHJlbGF0aW9uOiBzdHJpbmcpOiBzdHJpbmcge1xuXHRcdGxldCBkYXRhID0gVXRpbHMuYXNzaWduKHtpZDogaWQsIHJlbGF0aW9uOiByZWxhdGlvbn0sIHRoaXMuX2Jhc2VfZGF0YSk7XG5cdFx0cmV0dXJuIFV0aWxzLnN0cmluZ0tleVJlcGxhY2UodXJpX2VudGl0eV9yZWxhdGlvbiwgZGF0YSk7XG5cdH1cblxuXHQvKipcblx0ICogQ2FjaGUgbWFuYWdlciBnZXR0ZXIuXG5cdCAqL1xuXHRnZXRDYWNoZU1hbmFnZXIoKTogT1dlYktleVN0b3JhZ2Uge1xuXHRcdHJldHVybiB0aGlzLl9rZXlfc3RvcmU7XG5cdH1cblxuXHQvKipcblx0ICogQWRkcyBhbiBlbnRpdHkuXG5cdCAqXG5cdCAqIEBwYXJhbSBmb3JtRGF0YVxuXHQgKiBAcGFyYW0gc3VjY2Vzc1xuXHQgKiBAcGFyYW0gZmFpbFxuXHQgKiBAcGFyYW0gZnJlZXplXG5cdCAqL1xuXHRhZGQoZm9ybURhdGE6IGFueSwgc3VjY2VzczogdFNlcnZpY2VBZGRTdWNjZXNzPFQ+LCBmYWlsOiB0U2VydmljZUZhaWwsIGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlKTogT1dlYkNvbSB7XG5cdFx0bGV0IHVybCA9IHRoaXMuZ2V0U2VydmljZVVSSSgpLFxuXHRcdFx0cmVxdWVzdF9kYXRhOiB0U2VydmljZVJlcXVlc3RPcHRpb25zID0ge2RhdGE6IGZvcm1EYXRhfTtcblxuXHRcdHJldHVybiB0aGlzLmFwcF9jb250ZXh0LnJlcXVlc3QoXCJQT1NUXCIsIHVybCwgcmVxdWVzdF9kYXRhLCAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0c3VjY2VzcyhyZXNwb25zZSBhcyBhbnkpO1xuXHRcdH0sIGZhaWwsIGZyZWV6ZSk7XG5cdH1cblxuXHQvKipcblx0ICogRGVsZXRlcyB0aGUgZW50aXR5IHdpdGggdGhlIGdpdmVuIGlkLlxuXHQgKlxuXHQgKiBAcGFyYW0gaWQgVGhlIGVudGl0eSBpZC5cblx0ICogQHBhcmFtIHN1Y2Nlc3Ncblx0ICogQHBhcmFtIGZhaWxcblx0ICogQHBhcmFtIGZyZWV6ZVxuXHQgKi9cblx0ZGVsZXRlKGlkOiBzdHJpbmcsIHN1Y2Nlc3M6IHRTZXJ2aWNlRGVsZXRlU3VjY2VzczxUPiwgZmFpbDogdFNlcnZpY2VGYWlsLCBmcmVlemU6IGJvb2xlYW4gPSBmYWxzZSk6IE9XZWJDb20ge1xuXHRcdGxldCBtICAgPSB0aGlzLFxuXHRcdFx0dXJsID0gdGhpcy5nZXRJdGVtVVJJKGlkKTtcblxuXHRcdHJldHVybiB0aGlzLmFwcF9jb250ZXh0LnJlcXVlc3QoXCJERUxFVEVcIiwgdXJsLCBudWxsLCAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0bS5nZXRDYWNoZU1hbmFnZXIoKS5yZW1vdmVJdGVtKGlkKTtcblx0XHRcdHN1Y2Nlc3MocmVzcG9uc2UgYXMgYW55KTtcblx0XHR9LCBmYWlsLCBmcmVlemUpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFVwZGF0ZXMgdGhlIGVudGl0eSB3aXRoIHRoZSBnaXZlbiBpZC5cblx0ICpcblx0ICogQHBhcmFtIGlkIFRoZSBlbnRpdHkgaWQuXG5cdCAqIEBwYXJhbSBmb3JtRGF0YVxuXHQgKiBAcGFyYW0gc3VjY2Vzc1xuXHQgKiBAcGFyYW0gZmFpbFxuXHQgKiBAcGFyYW0gZnJlZXplXG5cdCAqL1xuXHR1cGRhdGUoaWQ6IHN0cmluZywgZm9ybURhdGE6IGFueSwgc3VjY2VzczogdFNlcnZpY2VVcGRhdGVTdWNjZXNzPFQ+LCBmYWlsOiB0U2VydmljZUZhaWwsIGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlKTogT1dlYkNvbSB7XG5cdFx0bGV0IHVybCA9IHRoaXMuZ2V0SXRlbVVSSShpZCksXG5cdFx0XHRyZXF1ZXN0X2RhdGE6IHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnMgPSB7ZGF0YTogZm9ybURhdGF9O1xuXG5cdFx0cmV0dXJuIHRoaXMuYXBwX2NvbnRleHQucmVxdWVzdChcIlBBVENIXCIsIHVybCwgcmVxdWVzdF9kYXRhLCAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0c3VjY2VzcyhyZXNwb25zZSBhcyBhbnkpO1xuXHRcdH0sIGZhaWwsIGZyZWV6ZSk7XG5cdH1cblxuXHQvKipcblx0ICogRGVsZXRlcyBhbGwgZW50aXRpZXMuXG5cdCAqXG5cdCAqIEBwYXJhbSBvcHRpb25zXG5cdCAqIEBwYXJhbSBzdWNjZXNzXG5cdCAqIEBwYXJhbSBmYWlsXG5cdCAqIEBwYXJhbSBmcmVlemVcblx0ICovXG5cdGRlbGV0ZUFsbChvcHRpb25zOiB0U2VydmljZVJlcXVlc3RPcHRpb25zLCBzdWNjZXNzOiB0U2VydmljZURlbGV0ZUFsbFN1Y2Nlc3M8VD4sIGZhaWw6IHRTZXJ2aWNlRmFpbCwgZnJlZXplOiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgdXJsICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gdGhpcy5nZXRTZXJ2aWNlVVJJKCksXG5cdFx0XHRmaWx0ZXJzICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBvcHRpb25zLmZpbHRlcnMsXG5cdFx0XHRyZXF1ZXN0X2RhdGE6IHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnMgPSB7fTtcblxuXHRcdGlmICh0eXBlb2Ygb3B0aW9uc1tcIm1heFwiXSA9PT0gXCJudW1iZXJcIikgey8vIHdpbGwgYmUgaWdub3JlZCBieSBPJ1pvbmVcblx0XHRcdHJlcXVlc3RfZGF0YVtcIm1heFwiXSA9IG9wdGlvbnNbXCJtYXhcIl07XG5cdFx0fVxuXHRcdGlmICh0eXBlb2Ygb3B0aW9uc1tcInBhZ2VcIl0gPT09IFwibnVtYmVyXCIpIHsvLyB3aWxsIGJlIGlnbm9yZWQgYnkgTydab25lXG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJwYWdlXCJdID0gb3B0aW9uc1tcInBhZ2VcIl07XG5cdFx0fVxuXG5cdFx0aWYgKFV0aWxzLmlzUGxhaW5PYmplY3QoZmlsdGVycykpIHtcblx0XHRcdHJlcXVlc3RfZGF0YVtcImZpbHRlcnNcIl0gPSBmaWx0ZXJzO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzLmFwcF9jb250ZXh0LnJlcXVlc3QoXCJERUxFVEVcIiwgdXJsLCByZXF1ZXN0X2RhdGEsIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB7XG5cdFx0XHRzdWNjZXNzKHJlc3BvbnNlIGFzIGFueSk7XG5cdFx0fSwgZmFpbCwgZnJlZXplKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBVcGRhdGVzIGFsbCBlbnRpdGllcy5cblx0ICpcblx0ICogQHBhcmFtIG9wdGlvbnNcblx0ICogQHBhcmFtIGZvcm1EYXRhXG5cdCAqIEBwYXJhbSBzdWNjZXNzXG5cdCAqIEBwYXJhbSBmYWlsXG5cdCAqIEBwYXJhbSBmcmVlemVcblx0ICovXG5cdHVwZGF0ZUFsbChvcHRpb25zOiB0U2VydmljZVJlcXVlc3RPcHRpb25zLCBmb3JtRGF0YTogYW55LCBzdWNjZXNzOiB0U2VydmljZVVwZGF0ZUFsbFN1Y2Nlc3M8VD4sIGZhaWw6IHRTZXJ2aWNlRmFpbCwgZnJlZXplOiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgdXJsICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gdGhpcy5nZXRTZXJ2aWNlVVJJKCksXG5cdFx0XHRmaWx0ZXJzICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBvcHRpb25zLmZpbHRlcnMsXG5cdFx0XHRyZXF1ZXN0X2RhdGE6IHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnMgPSB7ZGF0YTogZm9ybURhdGF9O1xuXG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zW1wibWF4XCJdID09PSBcIm51bWJlclwiKSB7Ly8gd2lsbCBiZSBpZ25vcmVkIGJ5IE8nWm9uZVxuXHRcdFx0cmVxdWVzdF9kYXRhW1wibWF4XCJdID0gb3B0aW9uc1tcIm1heFwiXTtcblx0XHR9XG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zW1wicGFnZVwiXSA9PT0gXCJudW1iZXJcIikgey8vIHdpbGwgYmUgaWdub3JlZCBieSBPJ1pvbmVcblx0XHRcdHJlcXVlc3RfZGF0YVtcInBhZ2VcIl0gPSBvcHRpb25zW1wicGFnZVwiXTtcblx0XHR9XG5cblx0XHRpZiAoVXRpbHMuaXNQbGFpbk9iamVjdChmaWx0ZXJzKSkge1xuXHRcdFx0cmVxdWVzdF9kYXRhW1wiZmlsdGVyc1wiXSA9IGZpbHRlcnM7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuYXBwX2NvbnRleHQucmVxdWVzdChcIlBBVENIXCIsIHVybCwgcmVxdWVzdF9kYXRhLCAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0c3VjY2VzcyhyZXNwb25zZSBhcyBhbnkpO1xuXHRcdH0sIGZhaWwsIGZyZWV6ZSk7XG5cdH1cblxuXHQvKipcblx0ICogR2V0cyBhbiBlbnRpdHkgd2l0aCB0aGUgZ2l2ZW4gaWQuXG5cdCAqXG5cdCAqIEFsbCByZXF1ZXN0ZWQgcmVsYXRpb25zIG5hbWVzIGFyZSBqb2luZWQgd2l0aCBgfGAuXG5cdCAqIGV4YW1wbGU6IGByZWxhdGlvbjF8cmVsYXRpb24yfHJlbGF0aW9uWGAuXG5cdCAqXG5cdCAqIEBwYXJhbSBpZCBUaGUgZW50aXR5IGlkLlxuXHQgKiBAcGFyYW0gcmVsYXRpb25zIFRoZSByZWxhdGlvbnMgc3RyaW5nLlxuXHQgKiBAcGFyYW0gc3VjY2Vzc1xuXHQgKiBAcGFyYW0gZmFpbFxuXHQgKiBAcGFyYW0gZnJlZXplXG5cdCAqIEBwYXJhbSBsb2FkX2NhY2hlX2ZpcnN0XG5cdCAqL1xuXHRnZXQoaWQ6IHN0cmluZywgcmVsYXRpb25zOiBzdHJpbmcgPSBcIlwiLCBzdWNjZXNzOiB0U2VydmljZUdldFN1Y2Nlc3M8VD4sIGZhaWw6IHRTZXJ2aWNlRmFpbCwgZnJlZXplOiBib29sZWFuID0gZmFsc2UsIGxvYWRfY2FjaGVfZmlyc3Q6IGJvb2xlYW4gPSBmYWxzZSk6IE9XZWJDb20ge1xuXHRcdGxldCBtICAgICAgICAgPSB0aGlzLFxuXHRcdFx0dXJsICAgICAgID0gdGhpcy5nZXRJdGVtVVJJKGlkKSxcblx0XHRcdGNhY2hlX2lkICA9IGlkLFxuXHRcdFx0ZGF0YTogYW55ID0ge30sIF9fY2FjaGVkO1xuXG5cdFx0aWYgKHJlbGF0aW9ucy5sZW5ndGgpIHtcblx0XHRcdGRhdGEucmVsYXRpb25zID0gcmVsYXRpb25zO1xuXHRcdH1cblxuXHRcdGlmIChsb2FkX2NhY2hlX2ZpcnN0KSB7XG5cdFx0XHRfX2NhY2hlZCA9IG0uZ2V0Q2FjaGVNYW5hZ2VyKCkuZ2V0SXRlbShjYWNoZV9pZCk7XG5cblx0XHRcdGlmIChfX2NhY2hlZCkge1xuXHRcdFx0XHRzdWNjZXNzKF9fY2FjaGVkLCB0cnVlKTtcblx0XHRcdFx0ZnJlZXplID0gZmFsc2U7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuYXBwX2NvbnRleHQucmVxdWVzdChcIkdFVFwiLCB1cmwsIGRhdGEsIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB7XG5cdFx0XHRtLmdldENhY2hlTWFuYWdlcigpLnNldEl0ZW0oaWQsIHJlc3BvbnNlKTtcblx0XHRcdHN1Y2Nlc3MocmVzcG9uc2UgYXMgYW55LCBmYWxzZSk7XG5cdFx0fSwgKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHtcblxuXHRcdFx0aWYgKChfX2NhY2hlZCA9IG0uZ2V0Q2FjaGVNYW5hZ2VyKCkuZ2V0SXRlbShjYWNoZV9pZCkpKSB7XG5cdFx0XHRcdHN1Y2Nlc3MoX19jYWNoZWQsIHRydWUpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0ZmFpbChyZXNwb25zZSk7XG5cdFx0XHR9XG5cdFx0fSwgZnJlZXplKTtcblxuXHR9XG5cblx0LyoqXG5cdCAqIEdldHMgYWxsIGVudGl0aWVzLlxuXHQgKlxuXHQgKiBAcGFyYW0gb3B0aW9uc1xuXHQgKiBAcGFyYW0gc3VjY2Vzc1xuXHQgKiBAcGFyYW0gZmFpbFxuXHQgKiBAcGFyYW0gZnJlZXplXG5cdCAqIEBwYXJhbSBmb3JjZV9jYWNoZVxuXHQgKiBAcGFyYW0gbG9hZF9jYWNoZV9maXJzdFxuXHQgKi9cblx0Z2V0QWxsKG9wdGlvbnM6IHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnMsIHN1Y2Nlc3M6IHRTZXJ2aWNlR2V0QWxsU3VjY2VzczxUPiwgZmFpbDogdFNlcnZpY2VGYWlsLCBmcmVlemU6IGJvb2xlYW4gPSBmYWxzZSwgZm9yY2VfY2FjaGU6IGJvb2xlYW4gPSBmYWxzZSwgbG9hZF9jYWNoZV9maXJzdDogYm9vbGVhbiA9IGZhbHNlKTogT1dlYkNvbSB7XG5cdFx0bGV0IG0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IHRoaXMsXG5cdFx0XHR1cmwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSB0aGlzLmdldFNlcnZpY2VVUkkoKSxcblx0XHRcdGZpbHRlcnMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IG9wdGlvbnNbXCJmaWx0ZXJzXCJdLFxuXHRcdFx0cmVxdWVzdF9kYXRhOiB0U2VydmljZVJlcXVlc3RPcHRpb25zID0ge30sXG5cdFx0XHRfX2NhY2hlZDtcblxuXHRcdGlmICh0eXBlb2Ygb3B0aW9uc1tcIm1heFwiXSA9PT0gXCJudW1iZXJcIikge1xuXHRcdFx0cmVxdWVzdF9kYXRhW1wibWF4XCJdID0gb3B0aW9uc1tcIm1heFwiXTtcblx0XHR9XG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zW1wicGFnZVwiXSA9PT0gXCJudW1iZXJcIikge1xuXHRcdFx0cmVxdWVzdF9kYXRhW1wicGFnZVwiXSA9IG9wdGlvbnNbXCJwYWdlXCJdO1xuXHRcdH1cblxuXHRcdGlmICh0eXBlb2Ygb3B0aW9ucy5yZWxhdGlvbnMgPT09IFwic3RyaW5nXCIpIHtcblx0XHRcdHJlcXVlc3RfZGF0YVtcInJlbGF0aW9uc1wiXSA9IG9wdGlvbnMucmVsYXRpb25zXG5cdFx0fVxuXHRcdGlmICh0eXBlb2Ygb3B0aW9ucy5jb2xsZWN0aW9uID09PSBcInN0cmluZ1wiKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJjb2xsZWN0aW9uXCJdID0gb3B0aW9ucy5jb2xsZWN0aW9uXG5cdFx0fVxuXG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zLm9yZGVyX2J5ID09PSBcInN0cmluZ1wiKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJvcmRlcl9ieVwiXSA9IG9wdGlvbnMub3JkZXJfYnlcblx0XHR9XG5cblx0XHRpZiAoVXRpbHMuaXNQbGFpbk9iamVjdChmaWx0ZXJzKSkge1xuXHRcdFx0cmVxdWVzdF9kYXRhW1wiZmlsdGVyc1wiXSA9IGZpbHRlcnM7XG5cdFx0fVxuXG5cdFx0bGV0IGNhY2hlX2lkID0gdG9LZXkocmVxdWVzdF9kYXRhKTtcblxuXHRcdGlmIChmb3JjZV9jYWNoZSAmJiBsb2FkX2NhY2hlX2ZpcnN0KSB7XG5cdFx0XHRfX2NhY2hlZCA9IG0uZ2V0Q2FjaGVNYW5hZ2VyKCkuZ2V0SXRlbShjYWNoZV9pZCk7XG5cblx0XHRcdGlmIChfX2NhY2hlZCkge1xuXHRcdFx0XHRzdWNjZXNzKF9fY2FjaGVkLCB0cnVlKTtcblx0XHRcdFx0ZnJlZXplID0gZmFsc2U7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuYXBwX2NvbnRleHQucmVxdWVzdChcIkdFVFwiLCB1cmwsIHJlcXVlc3RfZGF0YSwgKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHtcblx0XHRcdGZvcmNlX2NhY2hlICYmIG0uZ2V0Q2FjaGVNYW5hZ2VyKCkuc2V0SXRlbShjYWNoZV9pZCwgcmVzcG9uc2UpO1xuXHRcdFx0c3VjY2VzcyhyZXNwb25zZSBhcyBhbnksIGZhbHNlKTtcblx0XHR9LCAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0aWYgKGZvcmNlX2NhY2hlICYmIChfX2NhY2hlZCA9IG0uZ2V0Q2FjaGVNYW5hZ2VyKCkuZ2V0SXRlbShjYWNoZV9pZCkpKSB7XG5cdFx0XHRcdHN1Y2Nlc3MoX19jYWNoZWQsIHRydWUpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0ZmFpbChyZXNwb25zZSk7XG5cdFx0XHR9XG5cdFx0fSwgZnJlZXplKTtcblxuXHR9XG5cblx0LyoqXG5cdCAqIEdldHMgYSBzaW5nbGUgaXRlbSByZWxhdGlvbiBmb3IgYSBnaXZlbiBlbnRpdHkgaWQuXG5cdCAqXG5cdCAqIEBwYXJhbSBpZCBUaGUgZW50aXR5IGlkLlxuXHQgKiBAcGFyYW0gcmVsYXRpb24gVGhlIHJlbGF0aW9uIG5hbWVcblx0ICogQHBhcmFtIHN1Y2Nlc3Ncblx0ICogQHBhcmFtIGZhaWxcblx0ICogQHBhcmFtIGZyZWV6ZVxuXHQgKiBAcGFyYW0gZm9yY2VfY2FjaGVcblx0ICogQHBhcmFtIGxvYWRfY2FjaGVfZmlyc3Rcblx0ICovXG5cdGdldFJlbGF0aW9uPFI+KGlkOiBzdHJpbmcsIHJlbGF0aW9uOiBzdHJpbmcsIHN1Y2Nlc3M6IHRTZXJ2aWNlR2V0UmVsYXRpb25TdWNjZXNzPFI+LCBmYWlsOiB0U2VydmljZUZhaWwsIGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlLCBmb3JjZV9jYWNoZTogYm9vbGVhbiA9IGZhbHNlLCBsb2FkX2NhY2hlX2ZpcnN0OiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgbSAgICAgICAgPSB0aGlzLFxuXHRcdFx0dXJsICAgICAgPSB0aGlzLmdldEl0ZW1SZWxhdGlvblVSSShpZCwgcmVsYXRpb24pLFxuXHRcdFx0Y2FjaGVfaWQgPSB0b0tleSh7aWQsIHJlbGF0aW9ufSksIF9fY2FjaGVkO1xuXG5cdFx0aWYgKGZvcmNlX2NhY2hlICYmIGxvYWRfY2FjaGVfZmlyc3QpIHtcblx0XHRcdF9fY2FjaGVkID0gdGhpcy5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKTtcblxuXHRcdFx0aWYgKF9fY2FjaGVkKSB7XG5cdFx0XHRcdHN1Y2Nlc3MoX19jYWNoZWQsIHRydWUpO1xuXHRcdFx0XHRmcmVlemUgPSBmYWxzZTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiR0VUXCIsIHVybCwge30sIGZ1bmN0aW9uIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSB7XG5cdFx0XHRmb3JjZV9jYWNoZSAmJiBtLmdldENhY2hlTWFuYWdlcigpLnNldEl0ZW0oY2FjaGVfaWQsIHJlc3BvbnNlKTtcblx0XHRcdHN1Y2Nlc3MocmVzcG9uc2UgYXMgYW55LCBmYWxzZSk7XG5cdFx0fSwgZnVuY3Rpb24gKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpIHtcblx0XHRcdGlmIChmb3JjZV9jYWNoZSAmJiAoX19jYWNoZWQgPSBtLmdldENhY2hlTWFuYWdlcigpLmdldEl0ZW0oY2FjaGVfaWQpKSkge1xuXHRcdFx0XHRzdWNjZXNzKF9fY2FjaGVkLCB0cnVlKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGZhaWwocmVzcG9uc2UpO1xuXHRcdFx0fVxuXHRcdH0sIGZyZWV6ZSk7XG5cdH1cblxuXHQvKipcblx0ICogR2V0cyBtdWx0aXBsZSBpdGVtcyByZWxhdGlvbiBmb3IgYSBnaXZlbiBlbnRpdHkgaWQuXG5cdCAqXG5cdCAqIEBwYXJhbSBpZCBUaGUgZW50aXR5IGlkLlxuXHQgKiBAcGFyYW0gcmVsYXRpb24gVGhlIHJlbGF0aW9uIG5hbWUuXG5cdCAqIEBwYXJhbSBvcHRpb25zXG5cdCAqIEBwYXJhbSBzdWNjZXNzXG5cdCAqIEBwYXJhbSBmYWlsXG5cdCAqIEBwYXJhbSBmcmVlemVcblx0ICogQHBhcmFtIGZvcmNlX2NhY2hlXG5cdCAqIEBwYXJhbSBsb2FkX2NhY2hlX2ZpcnN0XG5cdCAqL1xuXHRnZXRSZWxhdGlvbkl0ZW1zPFI+KGlkOiBzdHJpbmcsIHJlbGF0aW9uOiBzdHJpbmcsIG9wdGlvbnM6IHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnMsIHN1Y2Nlc3M6IHRTZXJ2aWNlR2V0UmVsYXRpb25JdGVtc1N1Y2Nlc3M8Uj4sIGZhaWw6IHRTZXJ2aWNlRmFpbCwgZnJlZXplOiBib29sZWFuID0gZmFsc2UsIGZvcmNlX2NhY2hlOiBib29sZWFuID0gZmFsc2UsIGxvYWRfY2FjaGVfZmlyc3Q6IGJvb2xlYW4gPSBmYWxzZSk6IE9XZWJDb20ge1xuXHRcdGxldCBtICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSB0aGlzLFxuXHRcdFx0dXJsICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gdGhpcy5nZXRJdGVtUmVsYXRpb25VUkkoaWQsIHJlbGF0aW9uKSxcblx0XHRcdGZpbHRlcnMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IG9wdGlvbnNbXCJmaWx0ZXJzXCJdLFxuXHRcdFx0cmVxdWVzdF9kYXRhOiB0U2VydmljZVJlcXVlc3RPcHRpb25zID0ge307XG5cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbXCJtYXhcIl0gPT09IFwibnVtYmVyXCIpIHtcblx0XHRcdHJlcXVlc3RfZGF0YVtcIm1heFwiXSA9IG9wdGlvbnNbXCJtYXhcIl07XG5cdFx0fVxuXHRcdGlmICh0eXBlb2Ygb3B0aW9uc1tcInBhZ2VcIl0gPT09IFwibnVtYmVyXCIpIHtcblx0XHRcdHJlcXVlc3RfZGF0YVtcInBhZ2VcIl0gPSBvcHRpb25zW1wicGFnZVwiXTtcblx0XHR9XG5cblx0XHRpZiAoVXRpbHMuaXNQbGFpbk9iamVjdChmaWx0ZXJzKSkge1xuXHRcdFx0cmVxdWVzdF9kYXRhW1wiZmlsdGVyc1wiXSA9IGZpbHRlcnM7XG5cdFx0fVxuXG5cdFx0bGV0IGNhY2hlX2lkID0gdG9LZXkoVXRpbHMuYXNzaWduKHtyZWxhdGlvbjogcmVsYXRpb259LCByZXF1ZXN0X2RhdGEpKSxcblx0XHRcdF9fY2FjaGVkO1xuXG5cdFx0aWYgKGZvcmNlX2NhY2hlICYmIGxvYWRfY2FjaGVfZmlyc3QpIHtcblx0XHRcdF9fY2FjaGVkID0gPGlTZXJ2aWNlR2V0UmVsYXRpb25JdGVtc1Jlc3BvbnNlPFI+PnRoaXMuZ2V0Q2FjaGVNYW5hZ2VyKCkuZ2V0SXRlbShjYWNoZV9pZCk7XG5cblx0XHRcdGlmIChfX2NhY2hlZCkge1xuXHRcdFx0XHRzdWNjZXNzKF9fY2FjaGVkLCB0cnVlKTtcblx0XHRcdFx0ZnJlZXplID0gZmFsc2U7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuYXBwX2NvbnRleHQucmVxdWVzdChcIkdFVFwiLCB1cmwsIHJlcXVlc3RfZGF0YSwgZnVuY3Rpb24gKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpIHtcblxuXHRcdFx0Zm9yY2VfY2FjaGUgJiYgbS5nZXRDYWNoZU1hbmFnZXIoKS5zZXRJdGVtKGNhY2hlX2lkLCByZXNwb25zZSk7XG5cblx0XHRcdHN1Y2Nlc3MocmVzcG9uc2UgYXMgYW55LCBmYWxzZSk7XG5cdFx0fSwgZnVuY3Rpb24gKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpIHtcblx0XHRcdGlmIChmb3JjZV9jYWNoZSAmJiAoX19jYWNoZWQgPSBtLmdldENhY2hlTWFuYWdlcigpLmdldEl0ZW0oY2FjaGVfaWQpKSkge1xuXHRcdFx0XHRzdWNjZXNzKF9fY2FjaGVkLCB0cnVlKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGZhaWwocmVzcG9uc2UpO1xuXHRcdFx0fVxuXHRcdH0sIGZyZWV6ZSk7XG5cdH1cbn0iXX0=