import OWebKeyStorage from './OWebKeyStorage';
import Utils from './utils/Utils';
const uri_service = ':api_url/:service_name', uri_entity = ':api_url/:service_name/:id', uri_entity_relation = ':api_url/:service_name/:id/:relation';
let toKey = function (query_params) {
    let key = JSON.stringify(query_params).replace(/[^a-z0-9]/gi, '');
    return key.length ? key : 'no-params';
};
export default class OWebService {
    /**
     * @param app_context The app context.
     * @param service_name The service name.
     * @param persistent_cache To enable persistence data caching.
     */
    constructor(app_context, service_name, persistent_cache = false) {
        this.app_context = app_context;
        let s_url = app_context.configs.get('OZ_API_BASE_URL').replace(/\/$/g, '');
        this._base_data = { api_url: s_url, service_name: service_name };
        this._key_store = new OWebKeyStorage(app_context, 'services:' + service_name, persistent_cache);
    }
    /**
     * Returns the service name.
     */
    getName() {
        return this._base_data.service_name;
    }
    /**
     * Returns the service URI.
     */
    getServiceURI() {
        return Utils.stringKeyReplace(uri_service, this._base_data);
    }
    /**
     * Returns entity URI.
     *
     * @param id The entity id.
     */
    getItemURI(id) {
        let data = Utils.assign({ id: id }, this._base_data);
        return Utils.stringKeyReplace(uri_entity, data);
    }
    /**
     * Returns entity relation URI.
     *
     * @param id The entity id.
     * @param relation The relation name.
     */
    getItemRelationURI(id, relation) {
        let data = Utils.assign({ id: id, relation: relation }, this._base_data);
        return Utils.stringKeyReplace(uri_entity_relation, data);
    }
    /**
     * Cache manager getter.
     */
    getCacheManager() {
        return this._key_store;
    }
    /**
     * Adds an entity.
     *
     * @param formData
     * @param success
     * @param fail
     * @param freeze
     */
    addRequest(formData, success, fail, freeze = false) {
        let url = this.getServiceURI(), req_options = formData;
        return this.app_context.request('POST', url, req_options, (response) => {
            success(response);
        }, fail, freeze);
    }
    /**
     * Deletes the entity with the given id.
     *
     * @param id The entity id.
     * @param success
     * @param fail
     * @param freeze
     */
    deleteRequest(id, success, fail, freeze = false) {
        let m = this, url = this.getItemURI(id);
        return this.app_context.request('DELETE', url, null, (response) => {
            m.getCacheManager().removeItem(id);
            success(response);
        }, fail, freeze);
    }
    /**
     * Updates the entity with the given id.
     *
     * @param id The entity id.
     * @param formData
     * @param success
     * @param fail
     * @param freeze
     */
    updateRequest(id, formData, success, fail, freeze = false) {
        let url = this.getItemURI(id), req_options = formData;
        return this.app_context.request('PATCH', url, req_options, (response) => {
            success(response);
        }, fail, freeze);
    }
    /**
     * Deletes all entities.
     *
     * @param options
     * @param success
     * @param fail
     * @param freeze
     */
    deleteAllRequest(options, success, fail, freeze = false) {
        let url = this.getServiceURI(), filters = options.filters, req_options = {};
        if (typeof options['max'] === 'number') {
            // will be ignored by O'Zone
            req_options['max'] = options['max'];
        }
        if (typeof options['page'] === 'number') {
            // will be ignored by O'Zone
            req_options['page'] = options['page'];
        }
        if (Utils.isPlainObject(filters)) {
            req_options['filters'] = filters;
        }
        return this.app_context.request('DELETE', url, req_options, (response) => {
            success(response);
        }, fail, freeze);
    }
    /**
     * Updates all entities.
     *
     * @param options
     * @param formData
     * @param success
     * @param fail
     * @param freeze
     */
    updateAllRequest(options, formData, success, fail, freeze = false) {
        let url = this.getServiceURI(), filters = options.filters, req_options = formData;
        if (typeof options['max'] === 'number') {
            // will be ignored by O'Zone
            req_options['max'] = options['max'];
        }
        if (typeof options['page'] === 'number') {
            // will be ignored by O'Zone
            req_options['page'] = options['page'];
        }
        if (Utils.isPlainObject(filters)) {
            req_options['filters'] = filters;
        }
        return this.app_context.request('PATCH', url, req_options, (response) => {
            success(response);
        }, fail, freeze);
    }
    /**
     * Gets an entity with the given id.
     *
     * All requested relations names are joined with `|`.
     * example: `relation1|relation2|relationX`.
     *
     * @param id The entity id.
     * @param relations The relations string.
     * @param success
     * @param fail
     * @param freeze
     * @param load_cache_first
     */
    getRequest(id, relations = '', success, fail, freeze = false, load_cache_first = false) {
        let m = this, url = this.getItemURI(id), cache_id = id, data = {}, __cached;
        if (relations.length) {
            data.relations = relations;
        }
        if (load_cache_first) {
            __cached = m.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request('GET', url, data, (response) => {
            m.getCacheManager().setItem(id, response);
            success(response, false);
        }, (response) => {
            if ((__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
    /**
     * Gets all entities.
     *
     * @param options
     * @param success
     * @param fail
     * @param freeze
     * @param force_cache
     * @param load_cache_first
     */
    getAllRequest(options, success, fail, freeze = false, force_cache = false, load_cache_first = false) {
        let m = this, url = this.getServiceURI(), filters = options['filters'], req_options = {}, __cached;
        if (typeof options['max'] === 'number') {
            req_options['max'] = options['max'];
        }
        if (typeof options['page'] === 'number') {
            req_options['page'] = options['page'];
        }
        if (typeof options.relations === 'string') {
            req_options['relations'] = options.relations;
        }
        if (typeof options.collection === 'string') {
            req_options['collection'] = options.collection;
        }
        if (typeof options.order_by === 'string') {
            req_options['order_by'] = options.order_by;
        }
        if (Utils.isPlainObject(filters)) {
            req_options['filters'] = filters;
        }
        let cache_id = toKey(req_options);
        if (force_cache && load_cache_first) {
            __cached = m.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request('GET', url, req_options, (response) => {
            force_cache && m.getCacheManager().setItem(cache_id, response);
            success(response, false);
        }, (response) => {
            if (force_cache && (__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
    /**
     * Gets a single item relation for a given entity id.
     *
     * @param id The entity id.
     * @param relation The relation name
     * @param success
     * @param fail
     * @param freeze
     * @param force_cache
     * @param load_cache_first
     */
    getRelationRequest(id, relation, success, fail, freeze = false, force_cache = false, load_cache_first = false) {
        let m = this, url = this.getItemRelationURI(id, relation), cache_id = toKey({ id, relation }), __cached;
        if (force_cache && load_cache_first) {
            __cached = this.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request('GET', url, {}, function (response) {
            force_cache && m.getCacheManager().setItem(cache_id, response);
            success(response, false);
        }, function (response) {
            if (force_cache && (__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
    /**
     * Gets multiple items relation for a given entity id.
     *
     * @param id The entity id.
     * @param relation The relation name.
     * @param options
     * @param success
     * @param fail
     * @param freeze
     * @param force_cache
     * @param load_cache_first
     */
    getRelationItemsRequest(id, relation, options, success, fail, freeze = false, force_cache = false, load_cache_first = false) {
        let m = this, url = this.getItemRelationURI(id, relation), filters = options['filters'], req_options = {};
        if (typeof options['max'] === 'number') {
            req_options['max'] = options['max'];
        }
        if (typeof options['page'] === 'number') {
            req_options['page'] = options['page'];
        }
        if (Utils.isPlainObject(filters)) {
            req_options['filters'] = filters;
        }
        let cache_id = toKey(Utils.assign({ relation: relation }, req_options)), __cached;
        if (force_cache && load_cache_first) {
            __cached = this.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request('GET', url, req_options, function (response) {
            force_cache && m.getCacheManager().setItem(cache_id, response);
            success(response, false);
        }, function (response) {
            if (force_cache && (__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYlNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxjQUFjLE1BQU0sa0JBQWtCLENBQUM7QUFDOUMsT0FBTyxLQUFLLE1BQU0sZUFBZSxDQUFDO0FBZ0lsQyxNQUFNLFdBQVcsR0FBVyx3QkFBd0IsRUFDakQsVUFBVSxHQUFZLDRCQUE0QixFQUNsRCxtQkFBbUIsR0FBRyxzQ0FBc0MsQ0FBQztBQUVoRSxJQUFJLEtBQUssR0FBRyxVQUFVLFlBQWlCO0lBQ3RDLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNsRSxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDO0FBQ3ZDLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxPQUFPLE9BQU8sV0FBVztJQUkvQjs7OztPQUlHO0lBQ0gsWUFBK0IsV0FBb0IsRUFBRSxZQUFvQixFQUFFLG1CQUE0QixLQUFLO1FBQTdFLGdCQUFXLEdBQVgsV0FBVyxDQUFTO1FBQ2xELElBQUksS0FBSyxHQUFTLFdBQVcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNqRixJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUFDLENBQUM7UUFDL0QsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLGNBQWMsQ0FBQyxXQUFXLEVBQUUsV0FBVyxHQUFHLFlBQVksRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO0lBQ2pHLENBQUM7SUFFRDs7T0FFRztJQUNILE9BQU87UUFDTixPQUFPLElBQUksQ0FB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QyxRQUFRLEVBQUUsUUFBUSxFQUFDLEVBQUUsV0FBVyxDQUFDLENBQUMsRUFDcEUsUUFBUSxDQUFDO1FBRVYsSUFBSSxXQUFXLElBQUksZ0JBQWdCLEVBQUU7WUFDcEMsUUFBUSxHQUF3QyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRXpGLElBQUksUUFBUSxFQUFFO2dCQUNiLE9BQU8sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQ3hCLE1BQU0sR0FBRyxLQUFLLENBQUM7YUFDZjtTQUNEO1FBRUQsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FDOUIsS0FBSyxFQUNMLEdBQUcsRUFDSCxXQUFXLEVBQ1gsVUFBVSxRQUFzQjtZQUMvQixXQUFXLElBQUksQ0FBQyxDQUFDLGVBQWUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFFL0QsT0FBTyxDQUFDLFFBQWUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNqQyxDQUFDLEVBQ0QsVUFBVSxRQUFzQjtZQUMvQixJQUFJLFdBQVcsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUU7Z0JBQ3RFLE9BQU8sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDeEI7aUJBQU07Z0JBQ04sSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ2Y7UUFDRixDQUFDLEVBQ0QsTUFBTSxDQUNOLENBQUM7SUFDSCxDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT1dlYkFwcCBmcm9tICcuL09XZWJBcHAnO1xuaW1wb3J0IE9XZWJDb20sIHtpQ29tUmVzcG9uc2V9IGZyb20gJy4vT1dlYkNvbSc7XG5pbXBvcnQgT1dlYktleVN0b3JhZ2UgZnJvbSAnLi9PV2ViS2V5U3RvcmFnZSc7XG5pbXBvcnQgVXRpbHMgZnJvbSAnLi91dGlscy9VdGlscyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VBZGRSZXNwb25zZTxUPiBleHRlbmRzIGlDb21SZXNwb25zZSB7XG5cdGRhdGE6IHtcblx0XHRpdGVtOiBUO1xuXHRcdHJlbGF0aW9ucz86IHtcblx0XHRcdFtrZXk6IHN0cmluZ106IGFueTtcblx0XHR9O1xuXHR9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlTZXJ2aWNlR2V0UmVzcG9uc2U8VD4gZXh0ZW5kcyBpQ29tUmVzcG9uc2Uge1xuXHRkYXRhOiB7XG5cdFx0aXRlbTogVDtcblx0XHRyZWxhdGlvbnM/OiB7XG5cdFx0XHRba2V5OiBzdHJpbmddOiBhbnk7XG5cdFx0fTtcblx0fTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBpU2VydmljZUdldEFsbFJlc3BvbnNlPFQ+IGV4dGVuZHMgaUNvbVJlc3BvbnNlIHtcblx0ZGF0YToge1xuXHRcdGl0ZW1zOiBUW107XG5cdFx0bWF4PzogbnVtYmVyO1xuXHRcdHBhZ2U/OiBudW1iZXI7XG5cdFx0dG90YWw/OiBudW1iZXI7XG5cdFx0cmVsYXRpb25zPzoge1xuXHRcdFx0W2tleTogc3RyaW5nXTogYW55O1xuXHRcdH07XG5cdH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VVcGRhdGVSZXNwb25zZTxUPiBleHRlbmRzIGlDb21SZXNwb25zZSB7XG5cdGRhdGE6IHtcblx0XHRpdGVtOiBUO1xuXHRcdHJlbGF0aW9ucz86IHtcblx0XHRcdFtrZXk6IHN0cmluZ106IGFueTtcblx0XHR9O1xuXHR9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlTZXJ2aWNlVXBkYXRlQWxsRGF0YSBleHRlbmRzIGlDb21SZXNwb25zZSB7XG5cdGRhdGE6IHtcblx0XHRhZmZlY3RlZDogbnVtYmVyO1xuXHR9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlTZXJ2aWNlRGVsZXRlUmVzcG9uc2U8VD4gZXh0ZW5kcyBpQ29tUmVzcG9uc2Uge1xuXHRkYXRhOiB7XG5cdFx0aXRlbTogVDtcblx0fTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBpU2VydmljZURlbGV0ZUFsbFJlc3BvbnNlPFQ+IGV4dGVuZHMgaUNvbVJlc3BvbnNlIHtcblx0ZGF0YToge1xuXHRcdGFmZmVjdGVkOiBudW1iZXI7XG5cdH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VHZXRSZWxhdGlvbkl0ZW1zUmVzcG9uc2U8VD4gZXh0ZW5kcyBpQ29tUmVzcG9uc2Uge1xuXHRkYXRhOiB7XG5cdFx0aXRlbXM6IFRbXTtcblx0XHRtYXg/OiBudW1iZXI7XG5cdFx0cGFnZT86IG51bWJlcjtcblx0XHR0b3RhbD86IG51bWJlcjtcblx0XHRyZWxhdGlvbnM6IHtcblx0XHRcdFtrZXk6IHN0cmluZ106IGFueTtcblx0XHR9O1xuXHR9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlTZXJ2aWNlR2V0UmVsYXRpb25JdGVtUmVzcG9uc2U8VD4gZXh0ZW5kcyBpQ29tUmVzcG9uc2Uge1xuXHRkYXRhOiB7XG5cdFx0aXRlbTogVDtcblx0XHRyZWxhdGlvbnM/OiB7XG5cdFx0XHRba2V5OiBzdHJpbmddOiBhbnk7XG5cdFx0fTtcblx0fTtcbn1cblxuZXhwb3J0IHR5cGUgdFNlcnZpY2VBZGRTdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZUFkZFJlc3BvbnNlPFQ+KSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgdFNlcnZpY2VVcGRhdGVTdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZVVwZGF0ZVJlc3BvbnNlPFQ+KSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgdFNlcnZpY2VVcGRhdGVBbGxTdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZVVwZGF0ZUFsbERhdGEpID0+IHZvaWQ7XG5leHBvcnQgdHlwZSB0U2VydmljZURlbGV0ZVN1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlRGVsZXRlUmVzcG9uc2U8VD4pID0+IHZvaWQ7XG5leHBvcnQgdHlwZSB0U2VydmljZURlbGV0ZUFsbFN1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlRGVsZXRlQWxsUmVzcG9uc2U8VD4pID0+IHZvaWQ7XG5leHBvcnQgdHlwZSB0U2VydmljZUdldFN1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlR2V0UmVzcG9uc2U8VD4sIGZyb21DYWNoZTogYm9vbGVhbikgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIHRTZXJ2aWNlR2V0QWxsU3VjY2VzczxUPiA9IChyZXNwb25zZTogaVNlcnZpY2VHZXRBbGxSZXNwb25zZTxUPiwgZnJvbUNhY2hlOiBib29sZWFuKSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgdFNlcnZpY2VHZXRSZWxhdGlvblN1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlR2V0UmVsYXRpb25JdGVtUmVzcG9uc2U8VD4sIGZyb21DYWNoZTogYm9vbGVhbikgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIHRTZXJ2aWNlR2V0UmVsYXRpb25JdGVtc1N1Y2Nlc3M8VD4gPSAoXG5cdHJlc3BvbnNlOiBpU2VydmljZUdldFJlbGF0aW9uSXRlbXNSZXNwb25zZTxUPixcblx0ZnJvbUNhY2hlOiBib29sZWFuXG4pID0+IHZvaWQ7XG5cbmV4cG9ydCB0eXBlIHRTZXJ2aWNlRmFpbCA9IChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgdEZpbHRlckNvbmRpdGlvbiA9IFwiZXFcIlxuXHR8IFwibmVxXCJcblx0fCBcImx0XCJcblx0fCBcImx0ZVwiXG5cdHwgXCJndFwiXG5cdHwgXCJndGVcIlxuXHR8IFwiaW5cIlxuXHR8IFwibm90X2luXCJcblx0fCBcImlzX251bGxcIlxuXHR8IFwiaXNfbm90X251bGxcIlxuXHR8IFwibGlrZVwiXG5cdHwgXCJub3RfbGlrZVwiO1xuXG5leHBvcnQgdHlwZSB0RmlsdGVyID0ge1xuXHQwOiB0RmlsdGVyQ29uZGl0aW9uLFxuXHQxOiBzdHJpbmcgfCBzdHJpbmdbXSB8IG51bWJlcixcblx0Mj86IFwib3JcIiB8IFwiYW5kXCJcbn0gfCB7XG5cdDA6IFwiaXNfbnVsbFwiIHwgXCJpc19ub3RfbnVsbFwiLFxuXHQxPzogXCJvclwiIHwgXCJhbmRcIlxufTtcblxuZXhwb3J0IHR5cGUgdEZpbHRlcnNNYXAgPSB7IFtrZXk6IHN0cmluZ106IHRGaWx0ZXJbXSB9O1xuXG5leHBvcnQgdHlwZSB0U2VydmljZVJlcXVlc3RPcHRpb25zID0ge1xuXHRkYXRhPzogYW55O1xuXHRmaWx0ZXJzPzogdEZpbHRlcnNNYXA7XG5cdHJlbGF0aW9ucz86IHN0cmluZztcblx0Y29sbGVjdGlvbj86IHN0cmluZztcblx0b3JkZXJfYnk/OiBzdHJpbmc7XG5cdG1heD86IG51bWJlcjtcblx0cGFnZT86IG51bWJlcjtcbn07XG5cbmNvbnN0IHVyaV9zZXJ2aWNlICAgICAgICAgPSAnOmFwaV91cmwvOnNlcnZpY2VfbmFtZScsXG5cdCAgdXJpX2VudGl0eSAgICAgICAgICA9ICc6YXBpX3VybC86c2VydmljZV9uYW1lLzppZCcsXG5cdCAgdXJpX2VudGl0eV9yZWxhdGlvbiA9ICc6YXBpX3VybC86c2VydmljZV9uYW1lLzppZC86cmVsYXRpb24nO1xuXG5sZXQgdG9LZXkgPSBmdW5jdGlvbiAocXVlcnlfcGFyYW1zOiBhbnkpIHtcblx0bGV0IGtleSA9IEpTT04uc3RyaW5naWZ5KHF1ZXJ5X3BhcmFtcykucmVwbGFjZSgvW15hLXowLTldL2dpLCAnJyk7XG5cdHJldHVybiBrZXkubGVuZ3RoID8ga2V5IDogJ25vLXBhcmFtcyc7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViU2VydmljZTxUPiB7XG5cdHByaXZhdGUgcmVhZG9ubHkgX2tleV9zdG9yZTogT1dlYktleVN0b3JhZ2U7XG5cdHByaXZhdGUgcmVhZG9ubHkgX2Jhc2VfZGF0YTogeyBhcGlfdXJsOiBhbnk7IHNlcnZpY2VfbmFtZTogc3RyaW5nIH07XG5cblx0LyoqXG5cdCAqIEBwYXJhbSBhcHBfY29udGV4dCBUaGUgYXBwIGNvbnRleHQuXG5cdCAqIEBwYXJhbSBzZXJ2aWNlX25hbWUgVGhlIHNlcnZpY2UgbmFtZS5cblx0ICogQHBhcmFtIHBlcnNpc3RlbnRfY2FjaGUgVG8gZW5hYmxlIHBlcnNpc3RlbmNlIGRhdGEgY2FjaGluZy5cblx0ICovXG5cdGNvbnN0cnVjdG9yKHByb3RlY3RlZCByZWFkb25seSBhcHBfY29udGV4dDogT1dlYkFwcCwgc2VydmljZV9uYW1lOiBzdHJpbmcsIHBlcnNpc3RlbnRfY2FjaGU6IGJvb2xlYW4gPSBmYWxzZSkge1xuXHRcdGxldCBzX3VybCAgICAgICA9IGFwcF9jb250ZXh0LmNvbmZpZ3MuZ2V0KCdPWl9BUElfQkFTRV9VUkwnKS5yZXBsYWNlKC9cXC8kL2csICcnKTtcblx0XHR0aGlzLl9iYXNlX2RhdGEgPSB7YXBpX3VybDogc191cmwsIHNlcnZpY2VfbmFtZTogc2VydmljZV9uYW1lfTtcblx0XHR0aGlzLl9rZXlfc3RvcmUgPSBuZXcgT1dlYktleVN0b3JhZ2UoYXBwX2NvbnRleHQsICdzZXJ2aWNlczonICsgc2VydmljZV9uYW1lLCBwZXJzaXN0ZW50X2NhY2hlKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHRoZSBzZXJ2aWNlIG5hbWUuXG5cdCAqL1xuXHRnZXROYW1lKCk6IHN0cmluZyB7XG5cdFx0cmV0dXJuIHRoaXMuX2Jhc2VfZGF0YS5zZXJ2aWNlX25hbWU7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgc2VydmljZSBVUkkuXG5cdCAqL1xuXHRnZXRTZXJ2aWNlVVJJKCkge1xuXHRcdHJldHVybiBVdGlscy5zdHJpbmdLZXlSZXBsYWNlKHVyaV9zZXJ2aWNlLCB0aGlzLl9iYXNlX2RhdGEpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgZW50aXR5IFVSSS5cblx0ICpcblx0ICogQHBhcmFtIGlkIFRoZSBlbnRpdHkgaWQuXG5cdCAqL1xuXHRnZXRJdGVtVVJJKGlkOiBhbnkpOiBzdHJpbmcge1xuXHRcdGxldCBkYXRhID0gVXRpbHMuYXNzaWduKHtpZDogaWR9LCB0aGlzLl9iYXNlX2RhdGEpO1xuXHRcdHJldHVybiBVdGlscy5zdHJpbmdLZXlSZXBsYWNlKHVyaV9lbnRpdHksIGRhdGEpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgZW50aXR5IHJlbGF0aW9uIFVSSS5cblx0ICpcblx0ICogQHBhcmFtIGlkIFRoZSBlbnRpdHkgaWQuXG5cdCAqIEBwYXJhbSByZWxhdGlvbiBUaGUgcmVsYXRpb24gbmFtZS5cblx0ICovXG5cdGdldEl0ZW1SZWxhdGlvblVSSShpZDogc3RyaW5nLCByZWxhdGlvbjogc3RyaW5nKTogc3RyaW5nIHtcblx0XHRsZXQgZGF0YSA9IFV0aWxzLmFzc2lnbih7aWQ6IGlkLCByZWxhdGlvbjogcmVsYXRpb259LCB0aGlzLl9iYXNlX2RhdGEpO1xuXHRcdHJldHVybiBVdGlscy5zdHJpbmdLZXlSZXBsYWNlKHVyaV9lbnRpdHlfcmVsYXRpb24sIGRhdGEpO1xuXHR9XG5cblx0LyoqXG5cdCAqIENhY2hlIG1hbmFnZXIgZ2V0dGVyLlxuXHQgKi9cblx0Z2V0Q2FjaGVNYW5hZ2VyKCk6IE9XZWJLZXlTdG9yYWdlIHtcblx0XHRyZXR1cm4gdGhpcy5fa2V5X3N0b3JlO1xuXHR9XG5cblx0LyoqXG5cdCAqIEFkZHMgYW4gZW50aXR5LlxuXHQgKlxuXHQgKiBAcGFyYW0gZm9ybURhdGFcblx0ICogQHBhcmFtIHN1Y2Nlc3Ncblx0ICogQHBhcmFtIGZhaWxcblx0ICogQHBhcmFtIGZyZWV6ZVxuXHQgKi9cblx0YWRkUmVxdWVzdChmb3JtRGF0YTogYW55LCBzdWNjZXNzOiB0U2VydmljZUFkZFN1Y2Nlc3M8VD4sIGZhaWw6IHRTZXJ2aWNlRmFpbCwgZnJlZXplOiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgdXJsICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSB0aGlzLmdldFNlcnZpY2VVUkkoKSxcblx0XHRcdHJlcV9vcHRpb25zOiB0U2VydmljZVJlcXVlc3RPcHRpb25zID0gZm9ybURhdGE7XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFxuXHRcdFx0J1BPU1QnLFxuXHRcdFx0dXJsLFxuXHRcdFx0cmVxX29wdGlvbnMsXG5cdFx0XHQocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0XHRzdWNjZXNzKHJlc3BvbnNlIGFzIGFueSk7XG5cdFx0XHR9LFxuXHRcdFx0ZmFpbCxcblx0XHRcdGZyZWV6ZVxuXHRcdCk7XG5cdH1cblxuXHQvKipcblx0ICogRGVsZXRlcyB0aGUgZW50aXR5IHdpdGggdGhlIGdpdmVuIGlkLlxuXHQgKlxuXHQgKiBAcGFyYW0gaWQgVGhlIGVudGl0eSBpZC5cblx0ICogQHBhcmFtIHN1Y2Nlc3Ncblx0ICogQHBhcmFtIGZhaWxcblx0ICogQHBhcmFtIGZyZWV6ZVxuXHQgKi9cblx0ZGVsZXRlUmVxdWVzdChpZDogc3RyaW5nLCBzdWNjZXNzOiB0U2VydmljZURlbGV0ZVN1Y2Nlc3M8VD4sIGZhaWw6IHRTZXJ2aWNlRmFpbCwgZnJlZXplOiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgbSAgID0gdGhpcyxcblx0XHRcdHVybCA9IHRoaXMuZ2V0SXRlbVVSSShpZCk7XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFxuXHRcdFx0J0RFTEVURScsXG5cdFx0XHR1cmwsXG5cdFx0XHRudWxsLFxuXHRcdFx0KHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHtcblx0XHRcdFx0bS5nZXRDYWNoZU1hbmFnZXIoKS5yZW1vdmVJdGVtKGlkKTtcblx0XHRcdFx0c3VjY2VzcyhyZXNwb25zZSBhcyBhbnkpO1xuXHRcdFx0fSxcblx0XHRcdGZhaWwsXG5cdFx0XHRmcmVlemVcblx0XHQpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFVwZGF0ZXMgdGhlIGVudGl0eSB3aXRoIHRoZSBnaXZlbiBpZC5cblx0ICpcblx0ICogQHBhcmFtIGlkIFRoZSBlbnRpdHkgaWQuXG5cdCAqIEBwYXJhbSBmb3JtRGF0YVxuXHQgKiBAcGFyYW0gc3VjY2Vzc1xuXHQgKiBAcGFyYW0gZmFpbFxuXHQgKiBAcGFyYW0gZnJlZXplXG5cdCAqL1xuXHR1cGRhdGVSZXF1ZXN0KFxuXHRcdGlkOiBzdHJpbmcsXG5cdFx0Zm9ybURhdGE6IGFueSxcblx0XHRzdWNjZXNzOiB0U2VydmljZVVwZGF0ZVN1Y2Nlc3M8VD4sXG5cdFx0ZmFpbDogdFNlcnZpY2VGYWlsLFxuXHRcdGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlXG5cdCk6IE9XZWJDb20ge1xuXHRcdGxldCB1cmwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IHRoaXMuZ2V0SXRlbVVSSShpZCksXG5cdFx0XHRyZXFfb3B0aW9uczogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucyA9IGZvcm1EYXRhO1xuXG5cdFx0cmV0dXJuIHRoaXMuYXBwX2NvbnRleHQucmVxdWVzdChcblx0XHRcdCdQQVRDSCcsXG5cdFx0XHR1cmwsXG5cdFx0XHRyZXFfb3B0aW9ucyxcblx0XHRcdChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB7XG5cdFx0XHRcdHN1Y2Nlc3MocmVzcG9uc2UgYXMgYW55KTtcblx0XHRcdH0sXG5cdFx0XHRmYWlsLFxuXHRcdFx0ZnJlZXplXG5cdFx0KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBEZWxldGVzIGFsbCBlbnRpdGllcy5cblx0ICpcblx0ICogQHBhcmFtIG9wdGlvbnNcblx0ICogQHBhcmFtIHN1Y2Nlc3Ncblx0ICogQHBhcmFtIGZhaWxcblx0ICogQHBhcmFtIGZyZWV6ZVxuXHQgKi9cblx0ZGVsZXRlQWxsUmVxdWVzdChcblx0XHRvcHRpb25zOiB0U2VydmljZVJlcXVlc3RPcHRpb25zLFxuXHRcdHN1Y2Nlc3M6IHRTZXJ2aWNlRGVsZXRlQWxsU3VjY2VzczxUPixcblx0XHRmYWlsOiB0U2VydmljZUZhaWwsXG5cdFx0ZnJlZXplOiBib29sZWFuID0gZmFsc2Vcblx0KTogT1dlYkNvbSB7XG5cdFx0bGV0IHVybCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gdGhpcy5nZXRTZXJ2aWNlVVJJKCksXG5cdFx0XHRmaWx0ZXJzICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IG9wdGlvbnMuZmlsdGVycyxcblx0XHRcdHJlcV9vcHRpb25zOiB0U2VydmljZVJlcXVlc3RPcHRpb25zID0ge307XG5cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbJ21heCddID09PSAnbnVtYmVyJykge1xuXHRcdFx0Ly8gd2lsbCBiZSBpZ25vcmVkIGJ5IE8nWm9uZVxuXHRcdFx0cmVxX29wdGlvbnNbJ21heCddID0gb3B0aW9uc1snbWF4J107XG5cdFx0fVxuXHRcdGlmICh0eXBlb2Ygb3B0aW9uc1sncGFnZSddID09PSAnbnVtYmVyJykge1xuXHRcdFx0Ly8gd2lsbCBiZSBpZ25vcmVkIGJ5IE8nWm9uZVxuXHRcdFx0cmVxX29wdGlvbnNbJ3BhZ2UnXSA9IG9wdGlvbnNbJ3BhZ2UnXTtcblx0XHR9XG5cblx0XHRpZiAoVXRpbHMuaXNQbGFpbk9iamVjdChmaWx0ZXJzKSkge1xuXHRcdFx0cmVxX29wdGlvbnNbJ2ZpbHRlcnMnXSA9IGZpbHRlcnM7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuYXBwX2NvbnRleHQucmVxdWVzdChcblx0XHRcdCdERUxFVEUnLFxuXHRcdFx0dXJsLFxuXHRcdFx0cmVxX29wdGlvbnMsXG5cdFx0XHQocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0XHRzdWNjZXNzKHJlc3BvbnNlIGFzIGFueSk7XG5cdFx0XHR9LFxuXHRcdFx0ZmFpbCxcblx0XHRcdGZyZWV6ZVxuXHRcdCk7XG5cdH1cblxuXHQvKipcblx0ICogVXBkYXRlcyBhbGwgZW50aXRpZXMuXG5cdCAqXG5cdCAqIEBwYXJhbSBvcHRpb25zXG5cdCAqIEBwYXJhbSBmb3JtRGF0YVxuXHQgKiBAcGFyYW0gc3VjY2Vzc1xuXHQgKiBAcGFyYW0gZmFpbFxuXHQgKiBAcGFyYW0gZnJlZXplXG5cdCAqL1xuXHR1cGRhdGVBbGxSZXF1ZXN0KFxuXHRcdG9wdGlvbnM6IHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnMsXG5cdFx0Zm9ybURhdGE6IGFueSxcblx0XHRzdWNjZXNzOiB0U2VydmljZVVwZGF0ZUFsbFN1Y2Nlc3M8VD4sXG5cdFx0ZmFpbDogdFNlcnZpY2VGYWlsLFxuXHRcdGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlXG5cdCk6IE9XZWJDb20ge1xuXHRcdGxldCB1cmwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IHRoaXMuZ2V0U2VydmljZVVSSSgpLFxuXHRcdFx0ZmlsdGVycyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBvcHRpb25zLmZpbHRlcnMsXG5cdFx0XHRyZXFfb3B0aW9uczogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucyA9IGZvcm1EYXRhO1xuXG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zWydtYXgnXSA9PT0gJ251bWJlcicpIHtcblx0XHRcdC8vIHdpbGwgYmUgaWdub3JlZCBieSBPJ1pvbmVcblx0XHRcdHJlcV9vcHRpb25zWydtYXgnXSA9IG9wdGlvbnNbJ21heCddO1xuXHRcdH1cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbJ3BhZ2UnXSA9PT0gJ251bWJlcicpIHtcblx0XHRcdC8vIHdpbGwgYmUgaWdub3JlZCBieSBPJ1pvbmVcblx0XHRcdHJlcV9vcHRpb25zWydwYWdlJ10gPSBvcHRpb25zWydwYWdlJ107XG5cdFx0fVxuXG5cdFx0aWYgKFV0aWxzLmlzUGxhaW5PYmplY3QoZmlsdGVycykpIHtcblx0XHRcdHJlcV9vcHRpb25zWydmaWx0ZXJzJ10gPSBmaWx0ZXJzO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzLmFwcF9jb250ZXh0LnJlcXVlc3QoXG5cdFx0XHQnUEFUQ0gnLFxuXHRcdFx0dXJsLFxuXHRcdFx0cmVxX29wdGlvbnMsXG5cdFx0XHQocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0XHRzdWNjZXNzKHJlc3BvbnNlIGFzIGFueSk7XG5cdFx0XHR9LFxuXHRcdFx0ZmFpbCxcblx0XHRcdGZyZWV6ZVxuXHRcdCk7XG5cdH1cblxuXHQvKipcblx0ICogR2V0cyBhbiBlbnRpdHkgd2l0aCB0aGUgZ2l2ZW4gaWQuXG5cdCAqXG5cdCAqIEFsbCByZXF1ZXN0ZWQgcmVsYXRpb25zIG5hbWVzIGFyZSBqb2luZWQgd2l0aCBgfGAuXG5cdCAqIGV4YW1wbGU6IGByZWxhdGlvbjF8cmVsYXRpb24yfHJlbGF0aW9uWGAuXG5cdCAqXG5cdCAqIEBwYXJhbSBpZCBUaGUgZW50aXR5IGlkLlxuXHQgKiBAcGFyYW0gcmVsYXRpb25zIFRoZSByZWxhdGlvbnMgc3RyaW5nLlxuXHQgKiBAcGFyYW0gc3VjY2Vzc1xuXHQgKiBAcGFyYW0gZmFpbFxuXHQgKiBAcGFyYW0gZnJlZXplXG5cdCAqIEBwYXJhbSBsb2FkX2NhY2hlX2ZpcnN0XG5cdCAqL1xuXHRnZXRSZXF1ZXN0KFxuXHRcdGlkOiBzdHJpbmcsXG5cdFx0cmVsYXRpb25zOiBzdHJpbmcgICAgICAgICA9ICcnLFxuXHRcdHN1Y2Nlc3M6IHRTZXJ2aWNlR2V0U3VjY2VzczxUPixcblx0XHRmYWlsOiB0U2VydmljZUZhaWwsXG5cdFx0ZnJlZXplOiBib29sZWFuICAgICAgICAgICA9IGZhbHNlLFxuXHRcdGxvYWRfY2FjaGVfZmlyc3Q6IGJvb2xlYW4gPSBmYWxzZVxuXHQpOiBPV2ViQ29tIHtcblx0XHRsZXQgbSAgICAgICAgID0gdGhpcyxcblx0XHRcdHVybCAgICAgICA9IHRoaXMuZ2V0SXRlbVVSSShpZCksXG5cdFx0XHRjYWNoZV9pZCAgPSBpZCxcblx0XHRcdGRhdGE6IGFueSA9IHt9LFxuXHRcdFx0X19jYWNoZWQ7XG5cblx0XHRpZiAocmVsYXRpb25zLmxlbmd0aCkge1xuXHRcdFx0ZGF0YS5yZWxhdGlvbnMgPSByZWxhdGlvbnM7XG5cdFx0fVxuXG5cdFx0aWYgKGxvYWRfY2FjaGVfZmlyc3QpIHtcblx0XHRcdF9fY2FjaGVkID0gbS5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKTtcblxuXHRcdFx0aWYgKF9fY2FjaGVkKSB7XG5cdFx0XHRcdHN1Y2Nlc3MoX19jYWNoZWQsIHRydWUpO1xuXHRcdFx0XHRmcmVlemUgPSBmYWxzZTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFxuXHRcdFx0J0dFVCcsXG5cdFx0XHR1cmwsXG5cdFx0XHRkYXRhLFxuXHRcdFx0KHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHtcblx0XHRcdFx0bS5nZXRDYWNoZU1hbmFnZXIoKS5zZXRJdGVtKGlkLCByZXNwb25zZSk7XG5cdFx0XHRcdHN1Y2Nlc3MocmVzcG9uc2UgYXMgYW55LCBmYWxzZSk7XG5cdFx0XHR9LFxuXHRcdFx0KHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHtcblx0XHRcdFx0aWYgKChfX2NhY2hlZCA9IG0uZ2V0Q2FjaGVNYW5hZ2VyKCkuZ2V0SXRlbShjYWNoZV9pZCkpKSB7XG5cdFx0XHRcdFx0c3VjY2VzcyhfX2NhY2hlZCwgdHJ1ZSk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0ZmFpbChyZXNwb25zZSk7XG5cdFx0XHRcdH1cblx0XHRcdH0sXG5cdFx0XHRmcmVlemVcblx0XHQpO1xuXHR9XG5cblx0LyoqXG5cdCAqIEdldHMgYWxsIGVudGl0aWVzLlxuXHQgKlxuXHQgKiBAcGFyYW0gb3B0aW9uc1xuXHQgKiBAcGFyYW0gc3VjY2Vzc1xuXHQgKiBAcGFyYW0gZmFpbFxuXHQgKiBAcGFyYW0gZnJlZXplXG5cdCAqIEBwYXJhbSBmb3JjZV9jYWNoZVxuXHQgKiBAcGFyYW0gbG9hZF9jYWNoZV9maXJzdFxuXHQgKi9cblx0Z2V0QWxsUmVxdWVzdChcblx0XHRvcHRpb25zOiB0U2VydmljZVJlcXVlc3RPcHRpb25zLFxuXHRcdHN1Y2Nlc3M6IHRTZXJ2aWNlR2V0QWxsU3VjY2VzczxUPixcblx0XHRmYWlsOiB0U2VydmljZUZhaWwsXG5cdFx0ZnJlZXplOiBib29sZWFuICAgICAgICAgICA9IGZhbHNlLFxuXHRcdGZvcmNlX2NhY2hlOiBib29sZWFuICAgICAgPSBmYWxzZSxcblx0XHRsb2FkX2NhY2hlX2ZpcnN0OiBib29sZWFuID0gZmFsc2Vcblx0KTogT1dlYkNvbSB7XG5cdFx0bGV0IG0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gdGhpcyxcblx0XHRcdHVybCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gdGhpcy5nZXRTZXJ2aWNlVVJJKCksXG5cdFx0XHRmaWx0ZXJzICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IG9wdGlvbnNbJ2ZpbHRlcnMnXSxcblx0XHRcdHJlcV9vcHRpb25zOiB0U2VydmljZVJlcXVlc3RPcHRpb25zID0ge30sXG5cdFx0XHRfX2NhY2hlZDtcblxuXHRcdGlmICh0eXBlb2Ygb3B0aW9uc1snbWF4J10gPT09ICdudW1iZXInKSB7XG5cdFx0XHRyZXFfb3B0aW9uc1snbWF4J10gPSBvcHRpb25zWydtYXgnXTtcblx0XHR9XG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zWydwYWdlJ10gPT09ICdudW1iZXInKSB7XG5cdFx0XHRyZXFfb3B0aW9uc1sncGFnZSddID0gb3B0aW9uc1sncGFnZSddO1xuXHRcdH1cblxuXHRcdGlmICh0eXBlb2Ygb3B0aW9ucy5yZWxhdGlvbnMgPT09ICdzdHJpbmcnKSB7XG5cdFx0XHRyZXFfb3B0aW9uc1sncmVsYXRpb25zJ10gPSBvcHRpb25zLnJlbGF0aW9ucztcblx0XHR9XG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zLmNvbGxlY3Rpb24gPT09ICdzdHJpbmcnKSB7XG5cdFx0XHRyZXFfb3B0aW9uc1snY29sbGVjdGlvbiddID0gb3B0aW9ucy5jb2xsZWN0aW9uO1xuXHRcdH1cblxuXHRcdGlmICh0eXBlb2Ygb3B0aW9ucy5vcmRlcl9ieSA9PT0gJ3N0cmluZycpIHtcblx0XHRcdHJlcV9vcHRpb25zWydvcmRlcl9ieSddID0gb3B0aW9ucy5vcmRlcl9ieTtcblx0XHR9XG5cblx0XHRpZiAoVXRpbHMuaXNQbGFpbk9iamVjdChmaWx0ZXJzKSkge1xuXHRcdFx0cmVxX29wdGlvbnNbJ2ZpbHRlcnMnXSA9IGZpbHRlcnM7XG5cdFx0fVxuXG5cdFx0bGV0IGNhY2hlX2lkID0gdG9LZXkocmVxX29wdGlvbnMpO1xuXG5cdFx0aWYgKGZvcmNlX2NhY2hlICYmIGxvYWRfY2FjaGVfZmlyc3QpIHtcblx0XHRcdF9fY2FjaGVkID0gbS5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKTtcblxuXHRcdFx0aWYgKF9fY2FjaGVkKSB7XG5cdFx0XHRcdHN1Y2Nlc3MoX19jYWNoZWQsIHRydWUpO1xuXHRcdFx0XHRmcmVlemUgPSBmYWxzZTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFxuXHRcdFx0J0dFVCcsXG5cdFx0XHR1cmwsXG5cdFx0XHRyZXFfb3B0aW9ucyxcblx0XHRcdChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB7XG5cdFx0XHRcdGZvcmNlX2NhY2hlICYmIG0uZ2V0Q2FjaGVNYW5hZ2VyKCkuc2V0SXRlbShjYWNoZV9pZCwgcmVzcG9uc2UpO1xuXHRcdFx0XHRzdWNjZXNzKHJlc3BvbnNlIGFzIGFueSwgZmFsc2UpO1xuXHRcdFx0fSxcblx0XHRcdChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB7XG5cdFx0XHRcdGlmIChmb3JjZV9jYWNoZSAmJiAoX19jYWNoZWQgPSBtLmdldENhY2hlTWFuYWdlcigpLmdldEl0ZW0oY2FjaGVfaWQpKSkge1xuXHRcdFx0XHRcdHN1Y2Nlc3MoX19jYWNoZWQsIHRydWUpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdGZhaWwocmVzcG9uc2UpO1xuXHRcdFx0XHR9XG5cdFx0XHR9LFxuXHRcdFx0ZnJlZXplXG5cdFx0KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBHZXRzIGEgc2luZ2xlIGl0ZW0gcmVsYXRpb24gZm9yIGEgZ2l2ZW4gZW50aXR5IGlkLlxuXHQgKlxuXHQgKiBAcGFyYW0gaWQgVGhlIGVudGl0eSBpZC5cblx0ICogQHBhcmFtIHJlbGF0aW9uIFRoZSByZWxhdGlvbiBuYW1lXG5cdCAqIEBwYXJhbSBzdWNjZXNzXG5cdCAqIEBwYXJhbSBmYWlsXG5cdCAqIEBwYXJhbSBmcmVlemVcblx0ICogQHBhcmFtIGZvcmNlX2NhY2hlXG5cdCAqIEBwYXJhbSBsb2FkX2NhY2hlX2ZpcnN0XG5cdCAqL1xuXHRnZXRSZWxhdGlvblJlcXVlc3Q8Uj4oXG5cdFx0aWQ6IHN0cmluZyxcblx0XHRyZWxhdGlvbjogc3RyaW5nLFxuXHRcdHN1Y2Nlc3M6IHRTZXJ2aWNlR2V0UmVsYXRpb25TdWNjZXNzPFI+LFxuXHRcdGZhaWw6IHRTZXJ2aWNlRmFpbCxcblx0XHRmcmVlemU6IGJvb2xlYW4gICAgICAgICAgID0gZmFsc2UsXG5cdFx0Zm9yY2VfY2FjaGU6IGJvb2xlYW4gICAgICA9IGZhbHNlLFxuXHRcdGxvYWRfY2FjaGVfZmlyc3Q6IGJvb2xlYW4gPSBmYWxzZVxuXHQpOiBPV2ViQ29tIHtcblx0XHRsZXQgbSAgICAgICAgPSB0aGlzLFxuXHRcdFx0dXJsICAgICAgPSB0aGlzLmdldEl0ZW1SZWxhdGlvblVSSShpZCwgcmVsYXRpb24pLFxuXHRcdFx0Y2FjaGVfaWQgPSB0b0tleSh7aWQsIHJlbGF0aW9ufSksXG5cdFx0XHRfX2NhY2hlZDtcblxuXHRcdGlmIChmb3JjZV9jYWNoZSAmJiBsb2FkX2NhY2hlX2ZpcnN0KSB7XG5cdFx0XHRfX2NhY2hlZCA9IHRoaXMuZ2V0Q2FjaGVNYW5hZ2VyKCkuZ2V0SXRlbShjYWNoZV9pZCk7XG5cblx0XHRcdGlmIChfX2NhY2hlZCkge1xuXHRcdFx0XHRzdWNjZXNzKF9fY2FjaGVkLCB0cnVlKTtcblx0XHRcdFx0ZnJlZXplID0gZmFsc2U7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuYXBwX2NvbnRleHQucmVxdWVzdChcblx0XHRcdCdHRVQnLFxuXHRcdFx0dXJsLFxuXHRcdFx0e30sXG5cdFx0XHRmdW5jdGlvbiAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkge1xuXHRcdFx0XHRmb3JjZV9jYWNoZSAmJiBtLmdldENhY2hlTWFuYWdlcigpLnNldEl0ZW0oY2FjaGVfaWQsIHJlc3BvbnNlKTtcblx0XHRcdFx0c3VjY2VzcyhyZXNwb25zZSBhcyBhbnksIGZhbHNlKTtcblx0XHRcdH0sXG5cdFx0XHRmdW5jdGlvbiAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkge1xuXHRcdFx0XHRpZiAoZm9yY2VfY2FjaGUgJiYgKF9fY2FjaGVkID0gbS5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKSkpIHtcblx0XHRcdFx0XHRzdWNjZXNzKF9fY2FjaGVkLCB0cnVlKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRmYWlsKHJlc3BvbnNlKTtcblx0XHRcdFx0fVxuXHRcdFx0fSxcblx0XHRcdGZyZWV6ZVxuXHRcdCk7XG5cdH1cblxuXHQvKipcblx0ICogR2V0cyBtdWx0aXBsZSBpdGVtcyByZWxhdGlvbiBmb3IgYSBnaXZlbiBlbnRpdHkgaWQuXG5cdCAqXG5cdCAqIEBwYXJhbSBpZCBUaGUgZW50aXR5IGlkLlxuXHQgKiBAcGFyYW0gcmVsYXRpb24gVGhlIHJlbGF0aW9uIG5hbWUuXG5cdCAqIEBwYXJhbSBvcHRpb25zXG5cdCAqIEBwYXJhbSBzdWNjZXNzXG5cdCAqIEBwYXJhbSBmYWlsXG5cdCAqIEBwYXJhbSBmcmVlemVcblx0ICogQHBhcmFtIGZvcmNlX2NhY2hlXG5cdCAqIEBwYXJhbSBsb2FkX2NhY2hlX2ZpcnN0XG5cdCAqL1xuXHRnZXRSZWxhdGlvbkl0ZW1zUmVxdWVzdDxSPihcblx0XHRpZDogc3RyaW5nLFxuXHRcdHJlbGF0aW9uOiBzdHJpbmcsXG5cdFx0b3B0aW9uczogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucyxcblx0XHRzdWNjZXNzOiB0U2VydmljZUdldFJlbGF0aW9uSXRlbXNTdWNjZXNzPFI+LFxuXHRcdGZhaWw6IHRTZXJ2aWNlRmFpbCxcblx0XHRmcmVlemU6IGJvb2xlYW4gICAgICAgICAgID0gZmFsc2UsXG5cdFx0Zm9yY2VfY2FjaGU6IGJvb2xlYW4gICAgICA9IGZhbHNlLFxuXHRcdGxvYWRfY2FjaGVfZmlyc3Q6IGJvb2xlYW4gPSBmYWxzZVxuXHQpOiBPV2ViQ29tIHtcblx0XHRsZXQgbSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSB0aGlzLFxuXHRcdFx0dXJsICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSB0aGlzLmdldEl0ZW1SZWxhdGlvblVSSShpZCwgcmVsYXRpb24pLFxuXHRcdFx0ZmlsdGVycyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBvcHRpb25zWydmaWx0ZXJzJ10sXG5cdFx0XHRyZXFfb3B0aW9uczogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucyA9IHt9O1xuXG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zWydtYXgnXSA9PT0gJ251bWJlcicpIHtcblx0XHRcdHJlcV9vcHRpb25zWydtYXgnXSA9IG9wdGlvbnNbJ21heCddO1xuXHRcdH1cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbJ3BhZ2UnXSA9PT0gJ251bWJlcicpIHtcblx0XHRcdHJlcV9vcHRpb25zWydwYWdlJ10gPSBvcHRpb25zWydwYWdlJ107XG5cdFx0fVxuXG5cdFx0aWYgKFV0aWxzLmlzUGxhaW5PYmplY3QoZmlsdGVycykpIHtcblx0XHRcdHJlcV9vcHRpb25zWydmaWx0ZXJzJ10gPSBmaWx0ZXJzO1xuXHRcdH1cblxuXHRcdGxldCBjYWNoZV9pZCA9IHRvS2V5KFV0aWxzLmFzc2lnbih7cmVsYXRpb246IHJlbGF0aW9ufSwgcmVxX29wdGlvbnMpKSxcblx0XHRcdF9fY2FjaGVkO1xuXG5cdFx0aWYgKGZvcmNlX2NhY2hlICYmIGxvYWRfY2FjaGVfZmlyc3QpIHtcblx0XHRcdF9fY2FjaGVkID0gPGlTZXJ2aWNlR2V0UmVsYXRpb25JdGVtc1Jlc3BvbnNlPFI+PnRoaXMuZ2V0Q2FjaGVNYW5hZ2VyKCkuZ2V0SXRlbShjYWNoZV9pZCk7XG5cblx0XHRcdGlmIChfX2NhY2hlZCkge1xuXHRcdFx0XHRzdWNjZXNzKF9fY2FjaGVkLCB0cnVlKTtcblx0XHRcdFx0ZnJlZXplID0gZmFsc2U7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuYXBwX2NvbnRleHQucmVxdWVzdChcblx0XHRcdCdHRVQnLFxuXHRcdFx0dXJsLFxuXHRcdFx0cmVxX29wdGlvbnMsXG5cdFx0XHRmdW5jdGlvbiAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkge1xuXHRcdFx0XHRmb3JjZV9jYWNoZSAmJiBtLmdldENhY2hlTWFuYWdlcigpLnNldEl0ZW0oY2FjaGVfaWQsIHJlc3BvbnNlKTtcblxuXHRcdFx0XHRzdWNjZXNzKHJlc3BvbnNlIGFzIGFueSwgZmFsc2UpO1xuXHRcdFx0fSxcblx0XHRcdGZ1bmN0aW9uIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSB7XG5cdFx0XHRcdGlmIChmb3JjZV9jYWNoZSAmJiAoX19jYWNoZWQgPSBtLmdldENhY2hlTWFuYWdlcigpLmdldEl0ZW0oY2FjaGVfaWQpKSkge1xuXHRcdFx0XHRcdHN1Y2Nlc3MoX19jYWNoZWQsIHRydWUpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdGZhaWwocmVzcG9uc2UpO1xuXHRcdFx0XHR9XG5cdFx0XHR9LFxuXHRcdFx0ZnJlZXplXG5cdFx0KTtcblx0fVxufVxuIl19