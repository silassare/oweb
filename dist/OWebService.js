import OWebKeyStorage from "./OWebKeyStorage";
import Utils from "./utils/Utils";
const uri_service = ":api_url/:service_name", uri_entity = ":api_url/:service_name/:id", uri_entity_relation = ":api_url/:service_name/:id/:relation";
let toKey = function (query_params) {
    let key = JSON.stringify(query_params).replace(/[^a-z0-9]/ig, "");
    return key.length ? key : "no-params";
};
export default class OWebService {
    /**
     * @param app_context The app context.
     * @param service_name The service name.
     */
    constructor(app_context, service_name) {
        this.app_context = app_context;
        let s_url = app_context.configs.get("OZ_API_BASE_URL")
            .replace(/\/$/g, "");
        this._base_data = { api_url: s_url, service_name: service_name };
        this._key_store = new OWebKeyStorage(app_context, "services:" + service_name);
    }
    /**
     * Returns the service name.
     */
    getName() {
        return this._base_data.service_name;
    }
    /**
     * Returns the service URI.
     */
    getServiceURI() {
        return Utils.stringKeyReplace(uri_service, this._base_data);
    }
    /**
     * Returns entity URI.
     *
     * @param id The entity id.
     */
    getItemURI(id) {
        let data = Utils.assign({ id: id }, this._base_data);
        return Utils.stringKeyReplace(uri_entity, data);
    }
    /**
     * Returns entity relation URI.
     *
     * @param id The entity id.
     * @param relation The relation name.
     */
    getItemRelationURI(id, relation) {
        let data = Utils.assign({ id: id, relation: relation }, this._base_data);
        return Utils.stringKeyReplace(uri_entity_relation, data);
    }
    /**
     * Cache manager getter.
     */
    getCacheManager() {
        return this._key_store;
    }
    /**
     * Adds an entity.
     *
     * @param formData
     * @param success
     * @param fail
     * @param freeze
     */
    add(formData, success, fail, freeze = false) {
        let url = this.getServiceURI();
        return this.app_context.request("POST", url, formData, (response) => {
            success(response);
        }, fail, freeze);
    }
    /**
     * Delete the entity with the given id.
     *
     * @param id The entity id.
     * @param success
     * @param fail
     * @param freeze
     */
    delete(id, success, fail, freeze = false) {
        let m = this, url = this.getItemURI(id);
        return this.app_context.request("DELETE", url, null, (response) => {
            m.getCacheManager().removeItem(id);
            success(response);
        }, fail, freeze);
    }
    /**
     * Update the entity with the given id.
     *
     * @param id The entity id.
     * @param formData
     * @param success
     * @param fail
     * @param freeze
     */
    update(id, formData, success, fail, freeze = false) {
        let url = this.getItemURI(id);
        return this.app_context.request("PATCH", url, formData, (response) => {
            success(response);
        }, fail, freeze);
    }
    /**
     * Delete all entities.
     *
     * @param options
     * @param success
     * @param fail
     * @param freeze
     */
    deleteAll(options, success, fail, freeze = false) {
        let url = this.getServiceURI(), filters = options.filters, request_data = {};
        if (typeof options["max"] === "number") { // will be ignored by O'Zone
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") { // will be ignored by O'Zone
            request_data["page"] = options["page"];
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        return this.app_context.request("DELETE", url, request_data, (response) => {
            success(response);
        }, fail, freeze);
    }
    /**
     * Update all entities.
     *
     * @param options
     * @param formData
     * @param success
     * @param fail
     * @param freeze
     */
    updateAll(options, formData, success, fail, freeze = false) {
        let url = this.getServiceURI(), filters = options.filters, request_data = { data: formData };
        if (typeof options["max"] === "number") { // will be ignored by O'Zone
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") { // will be ignored by O'Zone
            request_data["page"] = options["page"];
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        return this.app_context.request("PATCH", url, request_data, (response) => {
            success(response);
        }, fail, freeze);
    }
    /**
     * Gets an entity with the given id.
     *
     * All requested relations names are joined with `|`.
     * example: `relation1|relation2|relationX`.
     *
     * @param id The entity id.
     * @param relations The relations string.
     * @param success
     * @param fail
     * @param freeze
     * @param load_cache_first
     */
    get(id, relations = "", success, fail, freeze = false, load_cache_first = false) {
        let m = this, url = this.getItemURI(id), cache_id = id, data = {}, __cached;
        if (relations.length) {
            data.relations = relations;
        }
        if (load_cache_first) {
            __cached = m.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, data, (response) => {
            m.getCacheManager().setItem(id, response);
            success(response, false);
        }, (response) => {
            if ((__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
    /**
     * Gets all entities.
     *
     * @param options
     * @param success
     * @param fail
     * @param freeze
     * @param force_cache
     * @param load_cache_first
     */
    getAll(options, success, fail, freeze = false, force_cache = false, load_cache_first = false) {
        let m = this, url = this.getServiceURI(), filters = options["filters"], request_data = {}, __cached;
        if (typeof options["max"] === "number") {
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") {
            request_data["page"] = options["page"];
        }
        if (typeof options.relations === "string") {
            request_data["relations"] = options.relations;
        }
        if (typeof options.collection === "string") {
            request_data["collection"] = options.collection;
        }
        if (typeof options.order_by === "string") {
            request_data["order_by"] = options.order_by;
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        let cache_id = toKey(request_data);
        if (force_cache && load_cache_first) {
            __cached = m.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, request_data, (response) => {
            force_cache && m.getCacheManager().setItem(cache_id, response);
            success(response, false);
        }, (response) => {
            if (force_cache && (__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
    /**
     * Gets a single item relation for a given entity id.
     *
     * @param id The entity id.
     * @param relation The relation name
     * @param success
     * @param fail
     * @param freeze
     * @param force_cache
     * @param load_cache_first
     */
    getRelation(id, relation, success, fail, freeze = false, force_cache = false, load_cache_first = false) {
        let m = this, url = this.getItemRelationURI(id, relation), cache_id = toKey({ id, relation }), __cached;
        if (force_cache && load_cache_first) {
            __cached = this.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, {}, function (response) {
            force_cache && m.getCacheManager().setItem(cache_id, response);
            success(response, false);
        }, function (response) {
            if (force_cache && (__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
    /**
     * Gets multiple items relation for a given entity id.
     *
     * @param id The entity id.
     * @param relation The relation name.
     * @param options
     * @param success
     * @param fail
     * @param freeze
     * @param force_cache
     * @param load_cache_first
     */
    getRelationItems(id, relation, options, success, fail, freeze = false, force_cache = false, load_cache_first = false) {
        let m = this, url = this.getItemRelationURI(id, relation), filters = options["filters"], request_data = {};
        if (typeof options["max"] === "number") {
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") {
            request_data["page"] = options["page"];
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        let cache_id = toKey(Utils.assign({ relation: relation }, request_data)), __cached;
        if (force_cache && load_cache_first) {
            __cached = this.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, request_data, function (response) {
            force_cache && m.getCacheManager().setItem(cache_id, response);
            success(response, false);
        }, function (response) {
            if (force_cache && (__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYlNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxjQUFjLE1BQU0sa0JBQWtCLENBQUM7QUFDOUMsT0FBTyxLQUFLLE1BQU0sZUFBZSxDQUFDO0FBcUdsQyxNQUFNLFdBQVcsR0FBVyx3QkFBd0IsRUFDakQsVUFBVSxHQUFZLDRCQUE0QixFQUNsRCxtQkFBbUIsR0FBRyxzQ0FBc0MsQ0FBQztBQUVoRSxJQUFJLEtBQUssR0FBRyxVQUFVLFlBQWlCO0lBQ3RDLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNsRSxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDO0FBQ3ZDLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxPQUFPO0lBSWI7OztPQUdHO0lBQ0gsWUFBK0IsV0FBb0IsRUFBRSxZQUFvQjtRQUExQyxnQkFBVyxHQUFYLFdBQVcsQ0FBUztRQUVsRCxJQUFJLEtBQUssR0FBUyxXQUFXLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQzthQUNuRCxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQzdCLElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBQyxPQUFPLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksY0FBYyxDQUFDLFdBQVcsRUFBRSxXQUFXLEdBQUcsWUFBWSxDQUFDLENBQUM7SUFFL0UsQ0FBQztJQUVEOztPQUVHO0lBQ0gsT0FBTztRQUNOLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUM7SUFDckMsQ0FBQztJQUVEOztP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SSxDQUFDLGVBQWUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUV6RixJQUFJLFFBQVEsRUFBRTtnQkFDYixPQUFPLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUN4QixNQUFNLEdBQUcsS0FBSyxDQUFDO2FBQ2Y7U0FDRDtRQUVELE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxZQUFZLEVBQUUsVUFBVSxRQUFzQjtZQUV6RixXQUFXLElBQUksQ0FBQyxDQUFDLGVBQWUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFFL0QsT0FBTyxDQUFDLFFBQWUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNqQyxDQUFDLEVBQUUsVUFBVSxRQUFzQjtZQUNsQyxJQUFJLFdBQVcsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUU7Z0JBQ3RFLE9BQU8sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDeEI7aUJBQU07Z0JBQ04sSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ2Y7UUFDRixDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDWixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT1dlYkFwcCBmcm9tIFwiLi9PV2ViQXBwXCI7XG5pbXBvcnQgT1dlYkNvbSwge2lDb21SZXNwb25zZX0gZnJvbSBcIi4vT1dlYkNvbVwiO1xuaW1wb3J0IE9XZWJLZXlTdG9yYWdlIGZyb20gXCIuL09XZWJLZXlTdG9yYWdlXCI7XG5pbXBvcnQgVXRpbHMgZnJvbSBcIi4vdXRpbHMvVXRpbHNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBpU2VydmljZUFkZFJlc3BvbnNlPFQ+IGV4dGVuZHMgaUNvbVJlc3BvbnNlIHtcblx0ZGF0YToge1xuXHRcdGl0ZW06IFQsXG5cdFx0cmVsYXRpb25zPzoge1xuXHRcdFx0W2tleTogc3RyaW5nXTogYW55XG5cdFx0fVxuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VHZXRSZXNwb25zZTxUPiAgZXh0ZW5kcyBpQ29tUmVzcG9uc2Uge1xuXHRkYXRhOiB7XG5cdFx0aXRlbTogVCxcblx0XHRyZWxhdGlvbnM/OiB7XG5cdFx0XHRba2V5OiBzdHJpbmddOiBhbnlcblx0XHR9XG5cdH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBpU2VydmljZUdldEFsbFJlc3BvbnNlPFQ+ICBleHRlbmRzIGlDb21SZXNwb25zZSB7XG5cdGRhdGE6IHtcblx0XHRpdGVtczogVFtdLFxuXHRcdG1heD86IG51bWJlcixcblx0XHRwYWdlPzogbnVtYmVyLFxuXHRcdHRvdGFsPzogbnVtYmVyLFxuXHRcdHJlbGF0aW9ucz86IHtcblx0XHRcdFtrZXk6IHN0cmluZ106IGFueVxuXHRcdH1cblx0fVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlTZXJ2aWNlVXBkYXRlUmVzcG9uc2U8VD4gIGV4dGVuZHMgaUNvbVJlc3BvbnNlIHtcblx0ZGF0YToge1xuXHRcdGl0ZW06IFQsXG5cdFx0cmVsYXRpb25zPzoge1xuXHRcdFx0W2tleTogc3RyaW5nXTogYW55XG5cdFx0fVxuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VVcGRhdGVBbGxEYXRhIGV4dGVuZHMgaUNvbVJlc3BvbnNlIHtcblx0ZGF0YToge1xuXHRcdGFmZmVjdGVkOiBudW1iZXJcblx0fVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlTZXJ2aWNlRGVsZXRlUmVzcG9uc2U8VD4gIGV4dGVuZHMgaUNvbVJlc3BvbnNlIHtcblx0ZGF0YToge1xuXHRcdGl0ZW06IFRcblx0fVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlTZXJ2aWNlRGVsZXRlQWxsUmVzcG9uc2U8VD4gIGV4dGVuZHMgaUNvbVJlc3BvbnNlIHtcblx0ZGF0YToge1xuXHRcdGFmZmVjdGVkOiBudW1iZXJcblx0fVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlTZXJ2aWNlR2V0UmVsYXRpb25JdGVtc1Jlc3BvbnNlPFQ+ICBleHRlbmRzIGlDb21SZXNwb25zZSB7XG5cdGRhdGE6IHtcblx0XHRpdGVtczogVFtdLFxuXHRcdG1heD86IG51bWJlcixcblx0XHRwYWdlPzogbnVtYmVyLFxuXHRcdHRvdGFsPzogbnVtYmVyLFxuXHRcdHJlbGF0aW9uczoge1xuXHRcdFx0W2tleTogc3RyaW5nXTogYW55XG5cdFx0fVxuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VHZXRSZWxhdGlvbkl0ZW1SZXNwb25zZTxUPiAgZXh0ZW5kcyBpQ29tUmVzcG9uc2Uge1xuXHRkYXRhOiB7XG5cdFx0aXRlbTogVCxcblx0XHRyZWxhdGlvbnM/OiB7XG5cdFx0XHRba2V5OiBzdHJpbmddOiBhbnlcblx0XHR9XG5cdH1cbn1cblxuZXhwb3J0IHR5cGUgdFNlcnZpY2VBZGRTdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZUFkZFJlc3BvbnNlPFQ+KSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgdFNlcnZpY2VVcGRhdGVTdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZVVwZGF0ZVJlc3BvbnNlPFQ+KSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgdFNlcnZpY2VVcGRhdGVBbGxTdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZVVwZGF0ZUFsbERhdGEpID0+IHZvaWQ7XG5leHBvcnQgdHlwZSB0U2VydmljZURlbGV0ZVN1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlRGVsZXRlUmVzcG9uc2U8VD4pID0+IHZvaWQ7XG5leHBvcnQgdHlwZSB0U2VydmljZURlbGV0ZUFsbFN1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlRGVsZXRlQWxsUmVzcG9uc2U8VD4pID0+IHZvaWQ7XG5leHBvcnQgdHlwZSB0U2VydmljZUdldFN1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlR2V0UmVzcG9uc2U8VD4sIGZyb21DYWNoZTogYm9vbGVhbikgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIHRTZXJ2aWNlR2V0QWxsU3VjY2VzczxUPiA9IChyZXNwb25zZTogaVNlcnZpY2VHZXRBbGxSZXNwb25zZTxUPiwgZnJvbUNhY2hlOiBib29sZWFuKSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgdFNlcnZpY2VHZXRSZWxhdGlvblN1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlR2V0UmVsYXRpb25JdGVtUmVzcG9uc2U8VD4sIGZyb21DYWNoZTogYm9vbGVhbikgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIHRTZXJ2aWNlR2V0UmVsYXRpb25JdGVtc1N1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlR2V0UmVsYXRpb25JdGVtc1Jlc3BvbnNlPFQ+LCBmcm9tQ2FjaGU6IGJvb2xlYW4pID0+IHZvaWQ7XG5cbmV4cG9ydCB0eXBlIHRTZXJ2aWNlRmFpbCA9IChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB2b2lkO1xuXG5leHBvcnQgdHlwZSB0U2VydmljZVJlcXVlc3RPcHRpb25zID0ge1xuXHRtYXg/OiBudW1iZXIsXG5cdHBhZ2U/OiBudW1iZXIsXG5cdGZpbHRlcnM/OiBhbnksXG5cdHJlbGF0aW9ucz86IHN0cmluZyxcblx0Y29sbGVjdGlvbj86IHN0cmluZyxcblx0b3JkZXJfYnk/OiBzdHJpbmdcbn07XG5cbmNvbnN0IHVyaV9zZXJ2aWNlICAgICAgICAgPSBcIjphcGlfdXJsLzpzZXJ2aWNlX25hbWVcIixcblx0ICB1cmlfZW50aXR5ICAgICAgICAgID0gXCI6YXBpX3VybC86c2VydmljZV9uYW1lLzppZFwiLFxuXHQgIHVyaV9lbnRpdHlfcmVsYXRpb24gPSBcIjphcGlfdXJsLzpzZXJ2aWNlX25hbWUvOmlkLzpyZWxhdGlvblwiO1xuXG5sZXQgdG9LZXkgPSBmdW5jdGlvbiAocXVlcnlfcGFyYW1zOiBhbnkpIHtcblx0bGV0IGtleSA9IEpTT04uc3RyaW5naWZ5KHF1ZXJ5X3BhcmFtcykucmVwbGFjZSgvW15hLXowLTldL2lnLCBcIlwiKTtcblx0cmV0dXJuIGtleS5sZW5ndGggPyBrZXkgOiBcIm5vLXBhcmFtc1wiO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT1dlYlNlcnZpY2U8VD4ge1xuXHRwcml2YXRlIHJlYWRvbmx5IF9rZXlfc3RvcmU6IE9XZWJLZXlTdG9yYWdlO1xuXHRwcml2YXRlIHJlYWRvbmx5IF9iYXNlX2RhdGE6IHsgYXBpX3VybDogYW55OyBzZXJ2aWNlX25hbWU6IHN0cmluZyB9O1xuXG5cdC8qKlxuXHQgKiBAcGFyYW0gYXBwX2NvbnRleHQgVGhlIGFwcCBjb250ZXh0LlxuXHQgKiBAcGFyYW0gc2VydmljZV9uYW1lIFRoZSBzZXJ2aWNlIG5hbWUuXG5cdCAqL1xuXHRjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgcmVhZG9ubHkgYXBwX2NvbnRleHQ6IE9XZWJBcHAsIHNlcnZpY2VfbmFtZTogc3RyaW5nKSB7XG5cblx0XHRsZXQgc191cmwgICAgICAgPSBhcHBfY29udGV4dC5jb25maWdzLmdldChcIk9aX0FQSV9CQVNFX1VSTFwiKVxuXHRcdFx0XHRcdFx0XHRcdFx0IC5yZXBsYWNlKC9cXC8kL2csIFwiXCIpO1xuXHRcdHRoaXMuX2Jhc2VfZGF0YSA9IHthcGlfdXJsOiBzX3VybCwgc2VydmljZV9uYW1lOiBzZXJ2aWNlX25hbWV9O1xuXHRcdHRoaXMuX2tleV9zdG9yZSA9IG5ldyBPV2ViS2V5U3RvcmFnZShhcHBfY29udGV4dCwgXCJzZXJ2aWNlczpcIiArIHNlcnZpY2VfbmFtZSk7XG5cblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIHRoZSBzZXJ2aWNlIG5hbWUuXG5cdCAqL1xuXHRnZXROYW1lKCk6IHN0cmluZyB7XG5cdFx0cmV0dXJuIHRoaXMuX2Jhc2VfZGF0YS5zZXJ2aWNlX25hbWU7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyB0aGUgc2VydmljZSBVUkkuXG5cdCAqL1xuXHRnZXRTZXJ2aWNlVVJJKCkge1xuXHRcdHJldHVybiBVdGlscy5zdHJpbmdLZXlSZXBsYWNlKHVyaV9zZXJ2aWNlLCB0aGlzLl9iYXNlX2RhdGEpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgZW50aXR5IFVSSS5cblx0ICpcblx0ICogQHBhcmFtIGlkIFRoZSBlbnRpdHkgaWQuXG5cdCAqL1xuXHRnZXRJdGVtVVJJKGlkOiBhbnkpOiBzdHJpbmcge1xuXHRcdGxldCBkYXRhID0gVXRpbHMuYXNzaWduKHtpZDogaWR9LCB0aGlzLl9iYXNlX2RhdGEpO1xuXHRcdHJldHVybiBVdGlscy5zdHJpbmdLZXlSZXBsYWNlKHVyaV9lbnRpdHksIGRhdGEpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgZW50aXR5IHJlbGF0aW9uIFVSSS5cblx0ICpcblx0ICogQHBhcmFtIGlkIFRoZSBlbnRpdHkgaWQuXG5cdCAqIEBwYXJhbSByZWxhdGlvbiBUaGUgcmVsYXRpb24gbmFtZS5cblx0ICovXG5cdGdldEl0ZW1SZWxhdGlvblVSSShpZDogc3RyaW5nLCByZWxhdGlvbjogc3RyaW5nKTogc3RyaW5nIHtcblx0XHRsZXQgZGF0YSA9IFV0aWxzLmFzc2lnbih7aWQ6IGlkLCByZWxhdGlvbjogcmVsYXRpb259LCB0aGlzLl9iYXNlX2RhdGEpO1xuXHRcdHJldHVybiBVdGlscy5zdHJpbmdLZXlSZXBsYWNlKHVyaV9lbnRpdHlfcmVsYXRpb24sIGRhdGEpO1xuXHR9XG5cblx0LyoqXG5cdCAqIENhY2hlIG1hbmFnZXIgZ2V0dGVyLlxuXHQgKi9cblx0Z2V0Q2FjaGVNYW5hZ2VyKCk6IE9XZWJLZXlTdG9yYWdlIHtcblx0XHRyZXR1cm4gdGhpcy5fa2V5X3N0b3JlO1xuXHR9XG5cblx0LyoqXG5cdCAqIEFkZHMgYW4gZW50aXR5LlxuXHQgKlxuXHQgKiBAcGFyYW0gZm9ybURhdGFcblx0ICogQHBhcmFtIHN1Y2Nlc3Ncblx0ICogQHBhcmFtIGZhaWxcblx0ICogQHBhcmFtIGZyZWV6ZVxuXHQgKi9cblx0YWRkKGZvcm1EYXRhOiBhbnksIHN1Y2Nlc3M6IHRTZXJ2aWNlQWRkU3VjY2VzczxUPiwgZmFpbDogdFNlcnZpY2VGYWlsLCBmcmVlemU6IGJvb2xlYW4gPSBmYWxzZSk6IE9XZWJDb20ge1xuXHRcdGxldCB1cmwgPSB0aGlzLmdldFNlcnZpY2VVUkkoKTtcblxuXHRcdHJldHVybiB0aGlzLmFwcF9jb250ZXh0LnJlcXVlc3QoXCJQT1NUXCIsIHVybCwgZm9ybURhdGEsIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB7XG5cdFx0XHRzdWNjZXNzKHJlc3BvbnNlIGFzIGFueSk7XG5cdFx0fSwgZmFpbCwgZnJlZXplKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBEZWxldGUgdGhlIGVudGl0eSB3aXRoIHRoZSBnaXZlbiBpZC5cblx0ICpcblx0ICogQHBhcmFtIGlkIFRoZSBlbnRpdHkgaWQuXG5cdCAqIEBwYXJhbSBzdWNjZXNzXG5cdCAqIEBwYXJhbSBmYWlsXG5cdCAqIEBwYXJhbSBmcmVlemVcblx0ICovXG5cdGRlbGV0ZShpZDogc3RyaW5nLCBzdWNjZXNzOiB0U2VydmljZURlbGV0ZVN1Y2Nlc3M8VD4sIGZhaWw6IHRTZXJ2aWNlRmFpbCwgZnJlZXplOiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgbSAgID0gdGhpcyxcblx0XHRcdHVybCA9IHRoaXMuZ2V0SXRlbVVSSShpZCk7XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiREVMRVRFXCIsIHVybCwgbnVsbCwgKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHtcblx0XHRcdG0uZ2V0Q2FjaGVNYW5hZ2VyKCkucmVtb3ZlSXRlbShpZCk7XG5cdFx0XHRzdWNjZXNzKHJlc3BvbnNlIGFzIGFueSk7XG5cdFx0fSwgZmFpbCwgZnJlZXplKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBVcGRhdGUgdGhlIGVudGl0eSB3aXRoIHRoZSBnaXZlbiBpZC5cblx0ICpcblx0ICogQHBhcmFtIGlkIFRoZSBlbnRpdHkgaWQuXG5cdCAqIEBwYXJhbSBmb3JtRGF0YVxuXHQgKiBAcGFyYW0gc3VjY2Vzc1xuXHQgKiBAcGFyYW0gZmFpbFxuXHQgKiBAcGFyYW0gZnJlZXplXG5cdCAqL1xuXHR1cGRhdGUoaWQ6IHN0cmluZywgZm9ybURhdGE6IGFueSwgc3VjY2VzczogdFNlcnZpY2VVcGRhdGVTdWNjZXNzPFQ+LCBmYWlsOiB0U2VydmljZUZhaWwsIGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlKTogT1dlYkNvbSB7XG5cdFx0bGV0IHVybCA9IHRoaXMuZ2V0SXRlbVVSSShpZCk7XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiUEFUQ0hcIiwgdXJsLCBmb3JtRGF0YSwgKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHtcblx0XHRcdHN1Y2Nlc3MocmVzcG9uc2UgYXMgYW55KTtcblx0XHR9LCBmYWlsLCBmcmVlemUpO1xuXHR9XG5cblx0LyoqXG5cdCAqIERlbGV0ZSBhbGwgZW50aXRpZXMuXG5cdCAqXG5cdCAqIEBwYXJhbSBvcHRpb25zXG5cdCAqIEBwYXJhbSBzdWNjZXNzXG5cdCAqIEBwYXJhbSBmYWlsXG5cdCAqIEBwYXJhbSBmcmVlemVcblx0ICovXG5cdGRlbGV0ZUFsbChvcHRpb25zOiB0U2VydmljZVJlcXVlc3RPcHRpb25zLCBzdWNjZXNzOiB0U2VydmljZURlbGV0ZUFsbFN1Y2Nlc3M8VD4sIGZhaWw6IHRTZXJ2aWNlRmFpbCwgZnJlZXplOiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgdXJsICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gdGhpcy5nZXRTZXJ2aWNlVVJJKCksXG5cdFx0XHRmaWx0ZXJzICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBvcHRpb25zLmZpbHRlcnMsXG5cdFx0XHRyZXF1ZXN0X2RhdGE6IHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnMgPSB7fTtcblxuXHRcdGlmICh0eXBlb2Ygb3B0aW9uc1tcIm1heFwiXSA9PT0gXCJudW1iZXJcIikgey8vIHdpbGwgYmUgaWdub3JlZCBieSBPJ1pvbmVcblx0XHRcdHJlcXVlc3RfZGF0YVtcIm1heFwiXSA9IG9wdGlvbnNbXCJtYXhcIl07XG5cdFx0fVxuXHRcdGlmICh0eXBlb2Ygb3B0aW9uc1tcInBhZ2VcIl0gPT09IFwibnVtYmVyXCIpIHsvLyB3aWxsIGJlIGlnbm9yZWQgYnkgTydab25lXG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJwYWdlXCJdID0gb3B0aW9uc1tcInBhZ2VcIl07XG5cdFx0fVxuXG5cdFx0aWYgKFV0aWxzLmlzUGxhaW5PYmplY3QoZmlsdGVycykpIHtcblx0XHRcdHJlcXVlc3RfZGF0YVtcImZpbHRlcnNcIl0gPSBmaWx0ZXJzO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzLmFwcF9jb250ZXh0LnJlcXVlc3QoXCJERUxFVEVcIiwgdXJsLCByZXF1ZXN0X2RhdGEsIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB7XG5cdFx0XHRzdWNjZXNzKHJlc3BvbnNlIGFzIGFueSk7XG5cdFx0fSwgZmFpbCwgZnJlZXplKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBVcGRhdGUgYWxsIGVudGl0aWVzLlxuXHQgKlxuXHQgKiBAcGFyYW0gb3B0aW9uc1xuXHQgKiBAcGFyYW0gZm9ybURhdGFcblx0ICogQHBhcmFtIHN1Y2Nlc3Ncblx0ICogQHBhcmFtIGZhaWxcblx0ICogQHBhcmFtIGZyZWV6ZVxuXHQgKi9cblx0dXBkYXRlQWxsKG9wdGlvbnM6IHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnMsIGZvcm1EYXRhOiBhbnksIHN1Y2Nlc3M6IHRTZXJ2aWNlVXBkYXRlQWxsU3VjY2VzczxUPiwgZmFpbDogdFNlcnZpY2VGYWlsLCBmcmVlemU6IGJvb2xlYW4gPSBmYWxzZSk6IE9XZWJDb20ge1xuXHRcdGxldCB1cmwgICAgICAgICAgICAgICAgID0gdGhpcy5nZXRTZXJ2aWNlVVJJKCksXG5cdFx0XHRmaWx0ZXJzICAgICAgICAgICAgID0gb3B0aW9ucy5maWx0ZXJzLFxuXHRcdFx0cmVxdWVzdF9kYXRhOiB0U2VydmljZVJlcXVlc3RPcHRpb25zXG5cdFx0XHRcdCYgeyBkYXRhOiBhbnkgfSA9IHtkYXRhOiBmb3JtRGF0YX07XG5cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbXCJtYXhcIl0gPT09IFwibnVtYmVyXCIpIHsvLyB3aWxsIGJlIGlnbm9yZWQgYnkgTydab25lXG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJtYXhcIl0gPSBvcHRpb25zW1wibWF4XCJdO1xuXHRcdH1cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbXCJwYWdlXCJdID09PSBcIm51bWJlclwiKSB7Ly8gd2lsbCBiZSBpZ25vcmVkIGJ5IE8nWm9uZVxuXHRcdFx0cmVxdWVzdF9kYXRhW1wicGFnZVwiXSA9IG9wdGlvbnNbXCJwYWdlXCJdO1xuXHRcdH1cblxuXHRcdGlmIChVdGlscy5pc1BsYWluT2JqZWN0KGZpbHRlcnMpKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJmaWx0ZXJzXCJdID0gZmlsdGVycztcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiUEFUQ0hcIiwgdXJsLCByZXF1ZXN0X2RhdGEsIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB7XG5cdFx0XHRzdWNjZXNzKHJlc3BvbnNlIGFzIGFueSk7XG5cdFx0fSwgZmFpbCwgZnJlZXplKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBHZXRzIGFuIGVudGl0eSB3aXRoIHRoZSBnaXZlbiBpZC5cblx0ICpcblx0ICogQWxsIHJlcXVlc3RlZCByZWxhdGlvbnMgbmFtZXMgYXJlIGpvaW5lZCB3aXRoIGB8YC5cblx0ICogZXhhbXBsZTogYHJlbGF0aW9uMXxyZWxhdGlvbjJ8cmVsYXRpb25YYC5cblx0ICpcblx0ICogQHBhcmFtIGlkIFRoZSBlbnRpdHkgaWQuXG5cdCAqIEBwYXJhbSByZWxhdGlvbnMgVGhlIHJlbGF0aW9ucyBzdHJpbmcuXG5cdCAqIEBwYXJhbSBzdWNjZXNzXG5cdCAqIEBwYXJhbSBmYWlsXG5cdCAqIEBwYXJhbSBmcmVlemVcblx0ICogQHBhcmFtIGxvYWRfY2FjaGVfZmlyc3Rcblx0ICovXG5cdGdldChpZDogc3RyaW5nLCByZWxhdGlvbnM6IHN0cmluZyA9IFwiXCIsIHN1Y2Nlc3M6IHRTZXJ2aWNlR2V0U3VjY2VzczxUPiwgZmFpbDogdFNlcnZpY2VGYWlsLCBmcmVlemU6IGJvb2xlYW4gPSBmYWxzZSwgbG9hZF9jYWNoZV9maXJzdDogYm9vbGVhbiA9IGZhbHNlKTogT1dlYkNvbSB7XG5cdFx0bGV0IG0gICAgICAgICA9IHRoaXMsXG5cdFx0XHR1cmwgICAgICAgPSB0aGlzLmdldEl0ZW1VUkkoaWQpLFxuXHRcdFx0Y2FjaGVfaWQgID0gaWQsXG5cdFx0XHRkYXRhOiBhbnkgPSB7fSwgX19jYWNoZWQ7XG5cblx0XHRpZiAocmVsYXRpb25zLmxlbmd0aCkge1xuXHRcdFx0ZGF0YS5yZWxhdGlvbnMgPSByZWxhdGlvbnM7XG5cdFx0fVxuXG5cdFx0aWYgKGxvYWRfY2FjaGVfZmlyc3QpIHtcblx0XHRcdF9fY2FjaGVkID0gbS5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKTtcblxuXHRcdFx0aWYgKF9fY2FjaGVkKSB7XG5cdFx0XHRcdHN1Y2Nlc3MoX19jYWNoZWQsIHRydWUpO1xuXHRcdFx0XHRmcmVlemUgPSBmYWxzZTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiR0VUXCIsIHVybCwgZGF0YSwgKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHtcblx0XHRcdG0uZ2V0Q2FjaGVNYW5hZ2VyKCkuc2V0SXRlbShpZCwgcmVzcG9uc2UpO1xuXHRcdFx0c3VjY2VzcyhyZXNwb25zZSBhcyBhbnksIGZhbHNlKTtcblx0XHR9LCAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXG5cdFx0XHRpZiAoKF9fY2FjaGVkID0gbS5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKSkpIHtcblx0XHRcdFx0c3VjY2VzcyhfX2NhY2hlZCwgdHJ1ZSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRmYWlsKHJlc3BvbnNlKTtcblx0XHRcdH1cblx0XHR9LCBmcmVlemUpO1xuXG5cdH1cblxuXHQvKipcblx0ICogR2V0cyBhbGwgZW50aXRpZXMuXG5cdCAqXG5cdCAqIEBwYXJhbSBvcHRpb25zXG5cdCAqIEBwYXJhbSBzdWNjZXNzXG5cdCAqIEBwYXJhbSBmYWlsXG5cdCAqIEBwYXJhbSBmcmVlemVcblx0ICogQHBhcmFtIGZvcmNlX2NhY2hlXG5cdCAqIEBwYXJhbSBsb2FkX2NhY2hlX2ZpcnN0XG5cdCAqL1xuXHRnZXRBbGwob3B0aW9uczogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucywgc3VjY2VzczogdFNlcnZpY2VHZXRBbGxTdWNjZXNzPFQ+LCBmYWlsOiB0U2VydmljZUZhaWwsIGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlLCBmb3JjZV9jYWNoZTogYm9vbGVhbiA9IGZhbHNlLCBsb2FkX2NhY2hlX2ZpcnN0OiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgbSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gdGhpcyxcblx0XHRcdHVybCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IHRoaXMuZ2V0U2VydmljZVVSSSgpLFxuXHRcdFx0ZmlsdGVycyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gb3B0aW9uc1tcImZpbHRlcnNcIl0sXG5cdFx0XHRyZXF1ZXN0X2RhdGE6IHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnMgPSB7fSxcblx0XHRcdF9fY2FjaGVkO1xuXG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zW1wibWF4XCJdID09PSBcIm51bWJlclwiKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJtYXhcIl0gPSBvcHRpb25zW1wibWF4XCJdO1xuXHRcdH1cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbXCJwYWdlXCJdID09PSBcIm51bWJlclwiKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJwYWdlXCJdID0gb3B0aW9uc1tcInBhZ2VcIl07XG5cdFx0fVxuXG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zLnJlbGF0aW9ucyA9PT0gXCJzdHJpbmdcIikge1xuXHRcdFx0cmVxdWVzdF9kYXRhW1wicmVsYXRpb25zXCJdID0gb3B0aW9ucy5yZWxhdGlvbnNcblx0XHR9XG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zLmNvbGxlY3Rpb24gPT09IFwic3RyaW5nXCIpIHtcblx0XHRcdHJlcXVlc3RfZGF0YVtcImNvbGxlY3Rpb25cIl0gPSBvcHRpb25zLmNvbGxlY3Rpb25cblx0XHR9XG5cblx0XHRpZiAodHlwZW9mIG9wdGlvbnMub3JkZXJfYnkgPT09IFwic3RyaW5nXCIpIHtcblx0XHRcdHJlcXVlc3RfZGF0YVtcIm9yZGVyX2J5XCJdID0gb3B0aW9ucy5vcmRlcl9ieVxuXHRcdH1cblxuXHRcdGlmIChVdGlscy5pc1BsYWluT2JqZWN0KGZpbHRlcnMpKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJmaWx0ZXJzXCJdID0gZmlsdGVycztcblx0XHR9XG5cblx0XHRsZXQgY2FjaGVfaWQgPSB0b0tleShyZXF1ZXN0X2RhdGEpO1xuXG5cdFx0aWYgKGZvcmNlX2NhY2hlICYmIGxvYWRfY2FjaGVfZmlyc3QpIHtcblx0XHRcdF9fY2FjaGVkID0gbS5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKTtcblxuXHRcdFx0aWYgKF9fY2FjaGVkKSB7XG5cdFx0XHRcdHN1Y2Nlc3MoX19jYWNoZWQsIHRydWUpO1xuXHRcdFx0XHRmcmVlemUgPSBmYWxzZTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiR0VUXCIsIHVybCwgcmVxdWVzdF9kYXRhLCAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0Zm9yY2VfY2FjaGUgJiYgbS5nZXRDYWNoZU1hbmFnZXIoKS5zZXRJdGVtKGNhY2hlX2lkLCByZXNwb25zZSk7XG5cdFx0XHRzdWNjZXNzKHJlc3BvbnNlIGFzIGFueSwgZmFsc2UpO1xuXHRcdH0sIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB7XG5cdFx0XHRpZiAoZm9yY2VfY2FjaGUgJiYgKF9fY2FjaGVkID0gbS5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKSkpIHtcblx0XHRcdFx0c3VjY2VzcyhfX2NhY2hlZCwgdHJ1ZSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRmYWlsKHJlc3BvbnNlKTtcblx0XHRcdH1cblx0XHR9LCBmcmVlemUpO1xuXG5cdH1cblxuXHQvKipcblx0ICogR2V0cyBhIHNpbmdsZSBpdGVtIHJlbGF0aW9uIGZvciBhIGdpdmVuIGVudGl0eSBpZC5cblx0ICpcblx0ICogQHBhcmFtIGlkIFRoZSBlbnRpdHkgaWQuXG5cdCAqIEBwYXJhbSByZWxhdGlvbiBUaGUgcmVsYXRpb24gbmFtZVxuXHQgKiBAcGFyYW0gc3VjY2Vzc1xuXHQgKiBAcGFyYW0gZmFpbFxuXHQgKiBAcGFyYW0gZnJlZXplXG5cdCAqIEBwYXJhbSBmb3JjZV9jYWNoZVxuXHQgKiBAcGFyYW0gbG9hZF9jYWNoZV9maXJzdFxuXHQgKi9cblx0Z2V0UmVsYXRpb248Uj4oaWQ6IHN0cmluZywgcmVsYXRpb246IHN0cmluZywgc3VjY2VzczogdFNlcnZpY2VHZXRSZWxhdGlvblN1Y2Nlc3M8Uj4sIGZhaWw6IHRTZXJ2aWNlRmFpbCwgZnJlZXplOiBib29sZWFuID0gZmFsc2UsIGZvcmNlX2NhY2hlOiBib29sZWFuID0gZmFsc2UsIGxvYWRfY2FjaGVfZmlyc3Q6IGJvb2xlYW4gPSBmYWxzZSk6IE9XZWJDb20ge1xuXHRcdGxldCBtICAgICAgICA9IHRoaXMsXG5cdFx0XHR1cmwgICAgICA9IHRoaXMuZ2V0SXRlbVJlbGF0aW9uVVJJKGlkLCByZWxhdGlvbiksXG5cdFx0XHRjYWNoZV9pZCA9IHRvS2V5KHtpZCwgcmVsYXRpb259KSwgX19jYWNoZWQ7XG5cblx0XHRpZiAoZm9yY2VfY2FjaGUgJiYgbG9hZF9jYWNoZV9maXJzdCkge1xuXHRcdFx0X19jYWNoZWQgPSB0aGlzLmdldENhY2hlTWFuYWdlcigpLmdldEl0ZW0oY2FjaGVfaWQpO1xuXG5cdFx0XHRpZiAoX19jYWNoZWQpIHtcblx0XHRcdFx0c3VjY2VzcyhfX2NhY2hlZCwgdHJ1ZSk7XG5cdFx0XHRcdGZyZWV6ZSA9IGZhbHNlO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzLmFwcF9jb250ZXh0LnJlcXVlc3QoXCJHRVRcIiwgdXJsLCB7fSwgZnVuY3Rpb24gKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpIHtcblx0XHRcdGZvcmNlX2NhY2hlICYmIG0uZ2V0Q2FjaGVNYW5hZ2VyKCkuc2V0SXRlbShjYWNoZV9pZCwgcmVzcG9uc2UpO1xuXHRcdFx0c3VjY2VzcyhyZXNwb25zZSBhcyBhbnksIGZhbHNlKTtcblx0XHR9LCBmdW5jdGlvbiAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkge1xuXHRcdFx0aWYgKGZvcmNlX2NhY2hlICYmIChfX2NhY2hlZCA9IG0uZ2V0Q2FjaGVNYW5hZ2VyKCkuZ2V0SXRlbShjYWNoZV9pZCkpKSB7XG5cdFx0XHRcdHN1Y2Nlc3MoX19jYWNoZWQsIHRydWUpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0ZmFpbChyZXNwb25zZSk7XG5cdFx0XHR9XG5cdFx0fSwgZnJlZXplKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBHZXRzIG11bHRpcGxlIGl0ZW1zIHJlbGF0aW9uIGZvciBhIGdpdmVuIGVudGl0eSBpZC5cblx0ICpcblx0ICogQHBhcmFtIGlkIFRoZSBlbnRpdHkgaWQuXG5cdCAqIEBwYXJhbSByZWxhdGlvbiBUaGUgcmVsYXRpb24gbmFtZS5cblx0ICogQHBhcmFtIG9wdGlvbnNcblx0ICogQHBhcmFtIHN1Y2Nlc3Ncblx0ICogQHBhcmFtIGZhaWxcblx0ICogQHBhcmFtIGZyZWV6ZVxuXHQgKiBAcGFyYW0gZm9yY2VfY2FjaGVcblx0ICogQHBhcmFtIGxvYWRfY2FjaGVfZmlyc3Rcblx0ICovXG5cdGdldFJlbGF0aW9uSXRlbXM8Uj4oaWQ6IHN0cmluZywgcmVsYXRpb246IHN0cmluZywgb3B0aW9uczogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucywgc3VjY2VzczogdFNlcnZpY2VHZXRSZWxhdGlvbkl0ZW1zU3VjY2VzczxSPiwgZmFpbDogdFNlcnZpY2VGYWlsLCBmcmVlemU6IGJvb2xlYW4gPSBmYWxzZSwgZm9yY2VfY2FjaGU6IGJvb2xlYW4gPSBmYWxzZSwgbG9hZF9jYWNoZV9maXJzdDogYm9vbGVhbiA9IGZhbHNlKTogT1dlYkNvbSB7XG5cdFx0bGV0IG0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IHRoaXMsXG5cdFx0XHR1cmwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSB0aGlzLmdldEl0ZW1SZWxhdGlvblVSSShpZCwgcmVsYXRpb24pLFxuXHRcdFx0ZmlsdGVycyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gb3B0aW9uc1tcImZpbHRlcnNcIl0sXG5cdFx0XHRyZXF1ZXN0X2RhdGE6IHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnMgPSB7fTtcblxuXHRcdGlmICh0eXBlb2Ygb3B0aW9uc1tcIm1heFwiXSA9PT0gXCJudW1iZXJcIikge1xuXHRcdFx0cmVxdWVzdF9kYXRhW1wibWF4XCJdID0gb3B0aW9uc1tcIm1heFwiXTtcblx0XHR9XG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zW1wicGFnZVwiXSA9PT0gXCJudW1iZXJcIikge1xuXHRcdFx0cmVxdWVzdF9kYXRhW1wicGFnZVwiXSA9IG9wdGlvbnNbXCJwYWdlXCJdO1xuXHRcdH1cblxuXHRcdGlmIChVdGlscy5pc1BsYWluT2JqZWN0KGZpbHRlcnMpKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJmaWx0ZXJzXCJdID0gZmlsdGVycztcblx0XHR9XG5cblx0XHRsZXQgY2FjaGVfaWQgPSB0b0tleShVdGlscy5hc3NpZ24oe3JlbGF0aW9uOiByZWxhdGlvbn0sIHJlcXVlc3RfZGF0YSkpLFxuXHRcdFx0X19jYWNoZWQ7XG5cblx0XHRpZiAoZm9yY2VfY2FjaGUgJiYgbG9hZF9jYWNoZV9maXJzdCkge1xuXHRcdFx0X19jYWNoZWQgPSA8aVNlcnZpY2VHZXRSZWxhdGlvbkl0ZW1zUmVzcG9uc2U8Uj4+dGhpcy5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKTtcblxuXHRcdFx0aWYgKF9fY2FjaGVkKSB7XG5cdFx0XHRcdHN1Y2Nlc3MoX19jYWNoZWQsIHRydWUpO1xuXHRcdFx0XHRmcmVlemUgPSBmYWxzZTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiR0VUXCIsIHVybCwgcmVxdWVzdF9kYXRhLCBmdW5jdGlvbiAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkge1xuXG5cdFx0XHRmb3JjZV9jYWNoZSAmJiBtLmdldENhY2hlTWFuYWdlcigpLnNldEl0ZW0oY2FjaGVfaWQsIHJlc3BvbnNlKTtcblxuXHRcdFx0c3VjY2VzcyhyZXNwb25zZSBhcyBhbnksIGZhbHNlKTtcblx0XHR9LCBmdW5jdGlvbiAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkge1xuXHRcdFx0aWYgKGZvcmNlX2NhY2hlICYmIChfX2NhY2hlZCA9IG0uZ2V0Q2FjaGVNYW5hZ2VyKCkuZ2V0SXRlbShjYWNoZV9pZCkpKSB7XG5cdFx0XHRcdHN1Y2Nlc3MoX19jYWNoZWQsIHRydWUpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0ZmFpbChyZXNwb25zZSk7XG5cdFx0XHR9XG5cdFx0fSwgZnJlZXplKTtcblx0fVxufSJdfQ==