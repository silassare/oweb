import OWebKeyStorage from "./OWebKeyStorage";
import Utils from "./utils/Utils";
const uri_service = ":api_url/:service_name", uri_entity = ":api_url/:service_name/:id", uri_entity_relation = ":api_url/:service_name/:id/:relation";
let toKey = function (query_params) {
    let key = JSON.stringify(query_params).replace(/[^a-z0-9]/ig, "");
    return key.length ? key : "no-params";
};
export default class OWebService {
    constructor(app_context, service_name) {
        this.app_context = app_context;
        let s_url = app_context.configs.get("OZ_API_BASE_URL")
            .replace(/\/$/g, "");
        this._base_data = { api_url: s_url, service_name: service_name };
        this._key_store = new OWebKeyStorage(app_context, "services:" + service_name);
    }
    getName() {
        return this._base_data.service_name;
    }
    getServiceURI() {
        return Utils.stringKeyReplace(uri_service, this._base_data);
    }
    getItemURI(id) {
        let data = Utils.assign({ id: id }, this._base_data);
        return Utils.stringKeyReplace(uri_entity, data);
    }
    getItemRelationURI(id, relation) {
        let data = Utils.assign({ id: id, relation: relation }, this._base_data);
        return Utils.stringKeyReplace(uri_entity_relation, data);
    }
    getCacheManager() {
        return this._key_store;
    }
    add(formData, success, fail, freeze = false) {
        let url = this.getServiceURI();
        return this.app_context.request("POST", url, formData, (response) => {
            success(response);
        }, fail, freeze);
    }
    delete(id, success, fail, freeze = false) {
        let m = this, url = this.getItemURI(id);
        return this.app_context.request("DELETE", url, null, (response) => {
            m.getCacheManager().removeItem(id);
            success(response);
        }, fail, freeze);
    }
    update(id, formData, success, fail, freeze = false) {
        let url = this.getItemURI(id);
        return this.app_context.request("PATCH", url, formData, (response) => {
            success(response);
        }, fail, freeze);
    }
    deleteAll(options, success, fail, freeze = false) {
        let url = this.getServiceURI(), filters = options.filters, request_data = {};
        if (typeof options["max"] === "number") { // will be ignored by O'Zone
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") { // will be ignored by O'Zone
            request_data["page"] = options["page"];
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        return this.app_context.request("DELETE", url, request_data, (response) => {
            success(response);
        }, fail, freeze);
    }
    updateAll(options, formData, success, fail, freeze = false) {
        let url = this.getServiceURI(), filters = options.filters, request_data = { data: formData };
        if (typeof options["max"] === "number") { // will be ignored by O'Zone
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") { // will be ignored by O'Zone
            request_data["page"] = options["page"];
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        return this.app_context.request("PATCH", url, request_data, (response) => {
            success(response);
        }, fail, freeze);
    }
    get(id, relations = "", success, fail, freeze = false, load_cache_first = false) {
        let m = this, url = this.getItemURI(id), data = null, cache_id = id, __cached;
        if (relations.length) {
            data = { relations };
        }
        if (load_cache_first) {
            __cached = m.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, data, (response) => {
            m.getCacheManager().setItem(id, response);
            success(response, false);
        }, (response) => {
            if ((__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
    getAll(options, success, fail, freeze = false, force_cache = false, load_cache_first = false) {
        let m = this, url = this.getServiceURI(), filters = options["filters"], request_data = {}, __cached;
        if (typeof options["max"] === "number") {
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") {
            request_data["page"] = options["page"];
        }
        if (typeof options.relations === "string") {
            request_data["relations"] = options.relations;
        }
        if (typeof options.collection === "string") {
            request_data["collection"] = options.collection;
        }
        if (typeof options.order_by === "string") {
            request_data["order_by"] = options.order_by;
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        let cache_id = toKey(request_data);
        if (force_cache && load_cache_first) {
            __cached = m.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, request_data, (response) => {
            force_cache && m.getCacheManager().setItem(cache_id, response);
            success(response, false);
        }, (response) => {
            if (force_cache && (__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
    getRelation(id, relation, success, fail, freeze = false, force_cache = false, load_cache_first = false) {
        let m = this, url = this.getItemRelationURI(id, relation), cache_id = toKey({ id, relation }), __cached;
        if (force_cache && load_cache_first) {
            __cached = this.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, {}, function (response) {
            force_cache && m.getCacheManager().setItem(cache_id, response);
            success(response, false);
        }, function (response) {
            if (force_cache && (__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
    getRelationItems(id, relation, options, success, fail, freeze = false, force_cache = false, load_cache_first = false) {
        let m = this, url = this.getItemRelationURI(id, relation), filters = options["filters"], request_data = {};
        if (typeof options["max"] === "number") {
            request_data["max"] = options["max"];
        }
        if (typeof options["page"] === "number") {
            request_data["page"] = options["page"];
        }
        if (Utils.isPlainObject(filters)) {
            request_data["filters"] = filters;
        }
        let cache_id = toKey(Utils.assign({ relation: relation }, request_data)), __cached;
        if (force_cache && load_cache_first) {
            __cached = this.getCacheManager().getItem(cache_id);
            if (__cached) {
                success(__cached, true);
                freeze = false;
            }
        }
        return this.app_context.request("GET", url, request_data, function (response) {
            force_cache && m.getCacheManager().setItem(cache_id, response);
            success(response, false);
        }, function (response) {
            if (force_cache && (__cached = m.getCacheManager().getItem(cache_id))) {
                success(__cached, true);
            }
            else {
                fail(response);
            }
        }, freeze);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYlNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYlNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxjQUFjLE1BQU0sa0JBQWtCLENBQUM7QUFDOUMsT0FBTyxLQUFLLE1BQU0sZUFBZSxDQUFDO0FBcUdsQyxNQUFNLFdBQVcsR0FBVyx3QkFBd0IsRUFDakQsVUFBVSxHQUFZLDRCQUE0QixFQUNsRCxtQkFBbUIsR0FBRyxzQ0FBc0MsQ0FBQztBQUVoRSxJQUFJLEtBQUssR0FBRyxVQUFVLFlBQWlCO0lBQ3RDLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNsRSxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDO0FBQ3ZDLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxPQUFPO0lBSWIsWUFBK0IsV0FBb0IsRUFBRSxZQUFvQjtRQUExQyxnQkFBVyxHQUFYLFdBQVcsQ0FBUztRQUVsRCxJQUFJLEtBQUssR0FBUyxXQUFXLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQzthQUMxRCxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBQyxPQUFPLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksY0FBYyxDQUFDLFdBQVcsRUFBRSxXQUFXLEdBQUcsWUFBWSxDQUFDLENBQUM7SUFFL0UsQ0FBQztJQUVELE9BQU87UUFDTixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDO0lBQ3JDLENBQUM7SUFFRCxhQUFhO1FBQ1osT0FBTyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUM3RCxDQUFDO0lBRUQsVUFBVSxDQUFDLEVBQU87UUFDakIsSUFBSSxJQUFJLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUMsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDbkQsT0FBTyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFRCxrQkFBa0IsQ0FBQyxFQUFVLEVBQUUsUUFBZ0I7UUFDOUMsSUFBSSxJQUFJLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBQyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN2RSxPQUFPLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxtQkFBbUIsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUMxRCxDQUFDO0lBRUQsZUFBZTtRQUNkLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQztJQUN4QixDQUFDO0lBRUQsR0FBRyxDQUFDLFFBQWEsRUFBRSxPQUE4QixFQUFFLElBQWtCLEVBQUUsU0FBa0IsS0FBSztRQUM3RixJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFFL0IsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxDQUFDLFFBQXNCLEVBQUUsRUFBRTtZQUNqRixPQUFPLENBQUMsUUFBZSxDQUFDLENBQUM7UUFDMUIsQ0FBQyxFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNsQixDQUFDO0lBRUQsTUFBTSxDQUFDLEVBQVUsRUFBRSxPQUFpQyxFQUFFLElBQWtCLEVBQUUsU0FBa0IsS0FBSztRQUNoRyxJQUFJLENBQUMsR0FBSyxJQUFJLEVBQ2IsR0FBRyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFM0IsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxDQUFDLFFBQXNCLEVBQUUsRUFBRTtZQUMvRSxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ25DLE9BQU8sQ0FBQyxRQUFlLENBQUMsQ0FBQztRQUMxQixDQUFDLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ2xCLENBQUM7SUFFRCxNQUFNLENBQUMsRUFBVSxFQUFFLFFBQWEsRUFBRSxPQUFpQyxFQUFFLElBQWtCLEVBQUUsU0FBa0IsS0FBSztRQUMvRyxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRTlCLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsQ0FBQyxRQUFzQixFQUFFLEVBQUU7WUFDbEYsT0FBTyxDQUFDLFFBQWUsQ0FBQyxDQUFDO1FBQzFCLENBQUMsRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDbEIsQ0FBQztJQUVELFNBQVMsQ0FBQyxPQUErQixFQUFFLE9BQW9DLEVBQUUsSUFBa0IsRUFBRSxTQUFrQixLQUFLO1FBQzNILElBQUksR0FBRyxHQUFvQyxJQUFJLENBQUMsYUFBYSxFQUFFLEVBQzlELE9BQU8sR0FBZ0MsT0FBTyxDQUFDLE9BQU8sRUFDdEQsWUFBWSxHQUEyQixFQUFFLENBQUM7UUFFM0MsSUFBSSxPQUFPLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxRQUFRLEVBQUUsRUFBQyw0QkFBNEI7WUFDcEUsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNyQztRQUNELElBQUksT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssUUFBUSxFQUFFLEVBQUMsNEJBQTRCO1lBQ3JFLFlBQVksQ0FBQyxNQUFNLENBQUMsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDdkM7UUFFRCxJQUFJLEtBQUssQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDakMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxHQUFHLE9BQU8sQ0FBQztTQUNsQztRQUVELE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRSxZQUFZLEVBQUUsQ0FBQyxRQUFzQixFQUFFLEVBQUU7WUFDdkYsT0FBTyxDQUFDLFFBQWUsQ0FBQyxDQUFDO1FBQzFCLENBQUMsRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDbEIsQ0FBQztJQUVELFNBQVMsQ0FBQyxPQUErQixFQUFFLFFBQWEsRUFBRSxPQUFvQyxFQUFFLElBQWtCLEVBQUUsU0FBa0IsS0FBSztRQUMxSSxJQUFJLEdBQUcsR0FBbUIsSUFBSSxDQUFDLGFBQWEsRUFBRSxFQUM3QyxPQUFPLEdBQWUsT0FBTyxDQUFDLE9BQU8sRUFDckMsWUFBWSxHQUNPLEVBQUMsSUFBSSxFQUFFLFFBQVEsRUFBQyxDQUFDO1FBRXJDLElBQUksT0FBTyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssUUFBUSxFQUFFLEVBQUMsNEJBQTRCO1lBQ3BFLFlBQVksQ0FBQyxLQUFLLENBQUMsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDckM7UUFDRCxJQUFJLE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLFFBQVEsRUFBRSxFQUFDLDRCQUE0QjtZQUNyRSxZQUFZLENBQUMsTUFBTSxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3ZDO1FBRUQsSUFBSSxLQUFLLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ2pDLFlBQVksQ0FBQyxTQUFTLENBQUMsR0FBRyxPQUFPLENBQUM7U0FDbEM7UUFFRCxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsWUFBWSxFQUFFLENBQUMsUUFBc0IsRUFBRSxFQUFFO1lBQ3RGLE9BQU8sQ0FBQyxRQUFlLENBQUMsQ0FBQztRQUMxQixDQUFDLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ2xCLENBQUM7SUFFRCxHQUFHLENBQUMsRUFBVSxFQUFFLFlBQW9CLEVBQUUsRUFBRSxPQUE4QixFQUFFLElBQWtCLEVBQUUsU0FBa0IsS0FBSyxFQUFFLG1CQUE0QixLQUFLO1FBQ3JKLElBQUksQ0FBQyxHQUFXLElBQUksRUFDbkIsR0FBRyxHQUFTLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLEVBQy9CLElBQUksR0FBUSxJQUFJLEVBQ2hCLFFBQVEsR0FBSSxFQUFFLEVBQUUsUUFBUSxDQUFDO1FBRTFCLElBQUksU0FBUyxDQUFDLE1BQU0sRUFBRTtZQUNyQixJQUFJLEdBQUcsRUFBQyxTQUFTLEVBQUMsQ0FBQztTQUNuQjtRQUVELElBQUksZ0JBQWdCLEVBQUU7WUFDckIsUUFBUSxHQUFHLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFakQsSUFBSSxRQUFRLEVBQUU7Z0JBQ2IsT0FBTyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDeEIsTUFBTSxHQUFHLEtBQUssQ0FBQzthQUNmO1NBQ0Q7UUFFRCxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUMsUUFBc0IsRUFBRSxFQUFFO1lBQzVFLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQzFDLE9BQU8sQ0FBQyxRQUFlLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDakMsQ0FBQyxFQUFFLENBQUMsUUFBc0IsRUFBRSxFQUFFO1lBRTdCLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLGVBQWUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFO2dCQUN2RCxPQUFPLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO2FBQ3hCO2lCQUFNO2dCQUNOLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUNmO1FBQ0YsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBRVosQ0FBQztJQUVELE1BQU0sQ0FBQyxPQUErQixFQUFFLE9BQWlDLEVBQUUsSUFBa0IsRUFBRSxTQUFrQixLQUFLLEVBQUUsY0FBdUIsS0FBSyxFQUFFLG1CQUE0QixLQUFLO1FBQ3RMLElBQUksQ0FBQyxHQUFzQyxJQUFJLEVBQzlDLEdBQUcsR0FBb0MsSUFBSSxDQUFDLGFBQWEsRUFBRSxFQUMzRCxPQUFPLEdBQWdDLE9BQU8sQ0FBQyxTQUFTLENBQUMsRUFDekQsWUFBWSxHQUEyQixFQUFFLEVBQ3pDLFFBQVEsQ0FBQztRQUVWLElBQUksT0FBTyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssUUFBUSxFQUFFO1lBQ3ZDLFlBQVksQ0FBQyxLQUFLLENBQUMsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDckM7UUFDRCxJQUFJLE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLFFBQVEsRUFBRTtZQUN4QyxZQUFZLENBQUMsTUFBTSxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3ZDO1FBRUQsSUFBSSxPQUFPLE9BQU8sQ0FBQyxTQUFTLEtBQUssUUFBUSxFQUFFO1lBQzFDLFlBQVksQ0FBQyxXQUFXLENBQUMsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFBO1NBQzdDO1FBQ0QsSUFBSSxPQUFPLE9BQU8sQ0FBQyxVQUFVLEtBQUssUUFBUSxFQUFFO1lBQzNDLFlBQVksQ0FBQyxZQUFZLENBQUMsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFBO1NBQy9DO1FBRUQsSUFBSSxPQUFPLE9BQU8sQ0FBQyxRQUFRLEtBQUssUUFBUSxFQUFFO1lBQ3pDLFlBQVksQ0FBQyxVQUFVLENBQUMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFBO1NBQzNDO1FBRUQsSUFBSSxLQUFLLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ2pDLFlBQVksQ0FBQyxTQUFTLENBQUMsR0FBRyxPQUFPLENBQUM7U0FDbEM7UUFFRCxJQUFJLFFBQVEsR0FBRyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFbkMsSUFBSSxXQUFXLElBQUksZ0JBQWdCLEVBQUU7WUFDcEMsUUFBUSxHQUFHLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFakQsSUFBSSxRQUFRLEVBQUU7Z0JBQ2IsT0FBTyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDeEIsTUFBTSxHQUFHLEtBQUssQ0FBQzthQUNmO1NBQ0Q7UUFFRCxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsWUFBWSxFQUFFLENBQUMsUUFBc0IsRUFBRSxFQUFFO1lBQ3BGLFdBQVcsSUFBSSxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUMvRCxPQUFPLENBQUMsUUFBZSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2pDLENBQUMsRUFBRSxDQUFDLFFBQXNCLEVBQUUsRUFBRTtZQUM3QixJQUFJLFdBQVcsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUU7Z0JBQ3RFLE9BQU8sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDeEI7aUJBQU07Z0JBQ04sSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ2Y7UUFDRixDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFFWixDQUFDO0lBRUQsV0FBVyxDQUFJLEVBQVUsRUFBRSxRQUFnQixFQUFFLE9BQXNDLEVBQUUsSUFBa0IsRUFBRSxTQUFrQixLQUFLLEVBQUUsY0FBdUIsS0FBSyxFQUFFLG1CQUE0QixLQUFLO1FBQ2hNLElBQUksQ0FBQyxHQUFVLElBQUksRUFDbEIsR0FBRyxHQUFRLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLEVBQUUsUUFBUSxDQUFDLEVBQ2hELFFBQVEsR0FBRyxLQUFLLENBQUMsRUFBQyxFQUFFLEVBQUUsUUFBUSxFQUFDLENBQUMsRUFBRSxRQUFRLENBQUM7UUFFNUMsSUFBSSxXQUFXLElBQUksZ0JBQWdCLEVBQUU7WUFDcEMsUUFBUSxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFcEQsSUFBSSxRQUFRLEVBQUU7Z0JBQ2IsT0FBTyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDeEIsTUFBTSxHQUFHLEtBQUssQ0FBQzthQUNmO1NBQ0Q7UUFFRCxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLFVBQVUsUUFBc0I7WUFDL0UsV0FBVyxJQUFJLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQy9ELE9BQU8sQ0FBQyxRQUFlLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDakMsQ0FBQyxFQUFFLFVBQVUsUUFBc0I7WUFDbEMsSUFBSSxXQUFXLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLGVBQWUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFO2dCQUN0RSxPQUFPLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO2FBQ3hCO2lCQUFNO2dCQUNOLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUNmO1FBQ0YsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ1osQ0FBQztJQUVELGdCQUFnQixDQUFJLEVBQVUsRUFBRSxRQUFnQixFQUFFLE9BQStCLEVBQUUsT0FBMkMsRUFBRSxJQUFrQixFQUFFLFNBQWtCLEtBQUssRUFBRSxjQUF1QixLQUFLLEVBQUUsbUJBQTRCLEtBQUs7UUFDM08sSUFBSSxDQUFDLEdBQXNDLElBQUksRUFDOUMsR0FBRyxHQUFvQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsRUFBRSxFQUFFLFFBQVEsQ0FBQyxFQUM1RSxPQUFPLEdBQWdDLE9BQU8sQ0FBQyxTQUFTLENBQUMsRUFDekQsWUFBWSxHQUEyQixFQUFFLENBQUM7UUFFM0MsSUFBSSxPQUFPLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxRQUFRLEVBQUU7WUFDdkMsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNyQztRQUNELElBQUksT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssUUFBUSxFQUFFO1lBQ3hDLFlBQVksQ0FBQyxNQUFNLENBQUMsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDdkM7UUFFRCxJQUFJLEtBQUssQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDakMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxHQUFHLE9BQU8sQ0FBQztTQUNsQztRQUVELElBQUksUUFBUSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUMsUUFBUSxFQUFFLFFBQVEsRUFBQyxFQUFFLFlBQVksQ0FBQyxDQUFDLEVBQ3JFLFFBQVEsQ0FBQztRQUVWLElBQUksV0FBVyxJQUFJLGdCQUFnQixFQUFFO1lBQ3BDLFFBQVEsR0FBd0MsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUV6RixJQUFJLFFBQVEsRUFBRTtnQkFDYixPQUFPLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUN4QixNQUFNLEdBQUcsS0FBSyxDQUFDO2FBQ2Y7U0FDRDtRQUVELE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxZQUFZLEVBQUUsVUFBVSxRQUFzQjtZQUV6RixXQUFXLElBQUksQ0FBQyxDQUFDLGVBQWUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFFL0QsT0FBTyxDQUFDLFFBQWUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNqQyxDQUFDLEVBQUUsVUFBVSxRQUFzQjtZQUNsQyxJQUFJLFdBQVcsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUU7Z0JBQ3RFLE9BQU8sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7YUFDeEI7aUJBQU07Z0JBQ04sSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ2Y7UUFDRixDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDWixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT1dlYkFwcCBmcm9tIFwiLi9PV2ViQXBwXCI7XG5pbXBvcnQgT1dlYkNvbSwge2lDb21SZXNwb25zZX0gZnJvbSBcIi4vT1dlYkNvbVwiO1xuaW1wb3J0IE9XZWJLZXlTdG9yYWdlIGZyb20gXCIuL09XZWJLZXlTdG9yYWdlXCI7XG5pbXBvcnQgVXRpbHMgZnJvbSBcIi4vdXRpbHMvVXRpbHNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBpU2VydmljZUFkZFJlc3BvbnNlPFQ+IGV4dGVuZHMgaUNvbVJlc3BvbnNlIHtcblx0ZGF0YToge1xuXHRcdGl0ZW06IFQsXG5cdFx0cmVsYXRpb25zPzoge1xuXHRcdFx0W2tleTogc3RyaW5nXTogYW55XG5cdFx0fVxuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VHZXRSZXNwb25zZTxUPiAgZXh0ZW5kcyBpQ29tUmVzcG9uc2Uge1xuXHRkYXRhOiB7XG5cdFx0aXRlbTogVCxcblx0XHRyZWxhdGlvbnM/OiB7XG5cdFx0XHRba2V5OiBzdHJpbmddOiBhbnlcblx0XHR9XG5cdH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBpU2VydmljZUdldEFsbFJlc3BvbnNlPFQ+ICBleHRlbmRzIGlDb21SZXNwb25zZSB7XG5cdGRhdGE6IHtcblx0XHRpdGVtczogVFtdLFxuXHRcdG1heD86IG51bWJlcixcblx0XHRwYWdlPzogbnVtYmVyLFxuXHRcdHRvdGFsPzogbnVtYmVyLFxuXHRcdHJlbGF0aW9ucz86IHtcblx0XHRcdFtrZXk6IHN0cmluZ106IGFueVxuXHRcdH1cblx0fVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlTZXJ2aWNlVXBkYXRlUmVzcG9uc2U8VD4gIGV4dGVuZHMgaUNvbVJlc3BvbnNlIHtcblx0ZGF0YToge1xuXHRcdGl0ZW06IFQsXG5cdFx0cmVsYXRpb25zPzoge1xuXHRcdFx0W2tleTogc3RyaW5nXTogYW55XG5cdFx0fVxuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VVcGRhdGVBbGxEYXRhIGV4dGVuZHMgaUNvbVJlc3BvbnNlIHtcblx0ZGF0YToge1xuXHRcdGFmZmVjdGVkOiBudW1iZXJcblx0fVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlTZXJ2aWNlRGVsZXRlUmVzcG9uc2U8VD4gIGV4dGVuZHMgaUNvbVJlc3BvbnNlIHtcblx0ZGF0YToge1xuXHRcdGl0ZW06IFRcblx0fVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlTZXJ2aWNlRGVsZXRlQWxsUmVzcG9uc2U8VD4gIGV4dGVuZHMgaUNvbVJlc3BvbnNlIHtcblx0ZGF0YToge1xuXHRcdGFmZmVjdGVkOiBudW1iZXJcblx0fVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIGlTZXJ2aWNlR2V0UmVsYXRpb25JdGVtc1Jlc3BvbnNlPFQ+ICBleHRlbmRzIGlDb21SZXNwb25zZSB7XG5cdGRhdGE6IHtcblx0XHRpdGVtczogVFtdLFxuXHRcdG1heD86IG51bWJlcixcblx0XHRwYWdlPzogbnVtYmVyLFxuXHRcdHRvdGFsPzogbnVtYmVyLFxuXHRcdHJlbGF0aW9uczoge1xuXHRcdFx0W2tleTogc3RyaW5nXTogYW55XG5cdFx0fVxuXHR9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgaVNlcnZpY2VHZXRSZWxhdGlvbkl0ZW1SZXNwb25zZTxUPiAgZXh0ZW5kcyBpQ29tUmVzcG9uc2Uge1xuXHRkYXRhOiB7XG5cdFx0aXRlbTogVCxcblx0XHRyZWxhdGlvbnM/OiB7XG5cdFx0XHRba2V5OiBzdHJpbmddOiBhbnlcblx0XHR9XG5cdH1cbn1cblxuZXhwb3J0IHR5cGUgdFNlcnZpY2VBZGRTdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZUFkZFJlc3BvbnNlPFQ+KSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgdFNlcnZpY2VVcGRhdGVTdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZVVwZGF0ZVJlc3BvbnNlPFQ+KSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgdFNlcnZpY2VVcGRhdGVBbGxTdWNjZXNzPFQ+ID0gKHJlc3BvbnNlOiBpU2VydmljZVVwZGF0ZUFsbERhdGEpID0+IHZvaWQ7XG5leHBvcnQgdHlwZSB0U2VydmljZURlbGV0ZVN1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlRGVsZXRlUmVzcG9uc2U8VD4pID0+IHZvaWQ7XG5leHBvcnQgdHlwZSB0U2VydmljZURlbGV0ZUFsbFN1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlRGVsZXRlQWxsUmVzcG9uc2U8VD4pID0+IHZvaWQ7XG5leHBvcnQgdHlwZSB0U2VydmljZUdldFN1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlR2V0UmVzcG9uc2U8VD4sIGZyb21DYWNoZTogYm9vbGVhbikgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIHRTZXJ2aWNlR2V0QWxsU3VjY2VzczxUPiA9IChyZXNwb25zZTogaVNlcnZpY2VHZXRBbGxSZXNwb25zZTxUPiwgZnJvbUNhY2hlOiBib29sZWFuKSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgdFNlcnZpY2VHZXRSZWxhdGlvblN1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlR2V0UmVsYXRpb25JdGVtUmVzcG9uc2U8VD4sIGZyb21DYWNoZTogYm9vbGVhbikgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIHRTZXJ2aWNlR2V0UmVsYXRpb25JdGVtc1N1Y2Nlc3M8VD4gPSAocmVzcG9uc2U6IGlTZXJ2aWNlR2V0UmVsYXRpb25JdGVtc1Jlc3BvbnNlPFQ+LCBmcm9tQ2FjaGU6IGJvb2xlYW4pID0+IHZvaWQ7XG5cbmV4cG9ydCB0eXBlIHRTZXJ2aWNlRmFpbCA9IChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB2b2lkO1xuXG5leHBvcnQgdHlwZSB0U2VydmljZVJlcXVlc3RPcHRpb25zID0ge1xuXHRtYXg/OiBudW1iZXIsXG5cdHBhZ2U/OiBudW1iZXIsXG5cdGZpbHRlcnM/OiBhbnksXG5cdHJlbGF0aW9ucz86IHN0cmluZyxcblx0Y29sbGVjdGlvbj86IHN0cmluZyxcblx0b3JkZXJfYnk/OiBzdHJpbmdcbn07XG5cbmNvbnN0IHVyaV9zZXJ2aWNlICAgICAgICAgPSBcIjphcGlfdXJsLzpzZXJ2aWNlX25hbWVcIixcblx0ICB1cmlfZW50aXR5ICAgICAgICAgID0gXCI6YXBpX3VybC86c2VydmljZV9uYW1lLzppZFwiLFxuXHQgIHVyaV9lbnRpdHlfcmVsYXRpb24gPSBcIjphcGlfdXJsLzpzZXJ2aWNlX25hbWUvOmlkLzpyZWxhdGlvblwiO1xuXG5sZXQgdG9LZXkgPSBmdW5jdGlvbiAocXVlcnlfcGFyYW1zOiBhbnkpIHtcblx0bGV0IGtleSA9IEpTT04uc3RyaW5naWZ5KHF1ZXJ5X3BhcmFtcykucmVwbGFjZSgvW15hLXowLTldL2lnLCBcIlwiKTtcblx0cmV0dXJuIGtleS5sZW5ndGggPyBrZXkgOiBcIm5vLXBhcmFtc1wiO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT1dlYlNlcnZpY2U8VD4ge1xuXHRwcml2YXRlIHJlYWRvbmx5IF9rZXlfc3RvcmU6IE9XZWJLZXlTdG9yYWdlO1xuXHRwcml2YXRlIHJlYWRvbmx5IF9iYXNlX2RhdGE6IHsgYXBpX3VybDogYW55OyBzZXJ2aWNlX25hbWU6IHN0cmluZyB9O1xuXG5cdGNvbnN0cnVjdG9yKHByb3RlY3RlZCByZWFkb25seSBhcHBfY29udGV4dDogT1dlYkFwcCwgc2VydmljZV9uYW1lOiBzdHJpbmcpIHtcblxuXHRcdGxldCBzX3VybCAgICAgICA9IGFwcF9jb250ZXh0LmNvbmZpZ3MuZ2V0KFwiT1pfQVBJX0JBU0VfVVJMXCIpXG5cdFx0XHQucmVwbGFjZSgvXFwvJC9nLCBcIlwiKTtcblx0XHR0aGlzLl9iYXNlX2RhdGEgPSB7YXBpX3VybDogc191cmwsIHNlcnZpY2VfbmFtZTogc2VydmljZV9uYW1lfTtcblx0XHR0aGlzLl9rZXlfc3RvcmUgPSBuZXcgT1dlYktleVN0b3JhZ2UoYXBwX2NvbnRleHQsIFwic2VydmljZXM6XCIgKyBzZXJ2aWNlX25hbWUpO1xuXG5cdH1cblxuXHRnZXROYW1lKCk6IHN0cmluZyB7XG5cdFx0cmV0dXJuIHRoaXMuX2Jhc2VfZGF0YS5zZXJ2aWNlX25hbWU7XG5cdH1cblxuXHRnZXRTZXJ2aWNlVVJJKCkge1xuXHRcdHJldHVybiBVdGlscy5zdHJpbmdLZXlSZXBsYWNlKHVyaV9zZXJ2aWNlLCB0aGlzLl9iYXNlX2RhdGEpO1xuXHR9XG5cblx0Z2V0SXRlbVVSSShpZDogYW55KTogc3RyaW5nIHtcblx0XHRsZXQgZGF0YSA9IFV0aWxzLmFzc2lnbih7aWQ6IGlkfSwgdGhpcy5fYmFzZV9kYXRhKTtcblx0XHRyZXR1cm4gVXRpbHMuc3RyaW5nS2V5UmVwbGFjZSh1cmlfZW50aXR5LCBkYXRhKTtcblx0fVxuXG5cdGdldEl0ZW1SZWxhdGlvblVSSShpZDogc3RyaW5nLCByZWxhdGlvbjogc3RyaW5nKTogc3RyaW5nIHtcblx0XHRsZXQgZGF0YSA9IFV0aWxzLmFzc2lnbih7aWQ6IGlkLCByZWxhdGlvbjogcmVsYXRpb259LCB0aGlzLl9iYXNlX2RhdGEpO1xuXHRcdHJldHVybiBVdGlscy5zdHJpbmdLZXlSZXBsYWNlKHVyaV9lbnRpdHlfcmVsYXRpb24sIGRhdGEpO1xuXHR9XG5cblx0Z2V0Q2FjaGVNYW5hZ2VyKCk6IE9XZWJLZXlTdG9yYWdlIHtcblx0XHRyZXR1cm4gdGhpcy5fa2V5X3N0b3JlO1xuXHR9XG5cblx0YWRkKGZvcm1EYXRhOiBhbnksIHN1Y2Nlc3M6IHRTZXJ2aWNlQWRkU3VjY2VzczxUPiwgZmFpbDogdFNlcnZpY2VGYWlsLCBmcmVlemU6IGJvb2xlYW4gPSBmYWxzZSk6IE9XZWJDb20ge1xuXHRcdGxldCB1cmwgPSB0aGlzLmdldFNlcnZpY2VVUkkoKTtcblxuXHRcdHJldHVybiB0aGlzLmFwcF9jb250ZXh0LnJlcXVlc3QoXCJQT1NUXCIsIHVybCwgZm9ybURhdGEsIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB7XG5cdFx0XHRzdWNjZXNzKHJlc3BvbnNlIGFzIGFueSk7XG5cdFx0fSwgZmFpbCwgZnJlZXplKTtcblx0fVxuXG5cdGRlbGV0ZShpZDogc3RyaW5nLCBzdWNjZXNzOiB0U2VydmljZURlbGV0ZVN1Y2Nlc3M8VD4sIGZhaWw6IHRTZXJ2aWNlRmFpbCwgZnJlZXplOiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgbSAgID0gdGhpcyxcblx0XHRcdHVybCA9IHRoaXMuZ2V0SXRlbVVSSShpZCk7XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiREVMRVRFXCIsIHVybCwgbnVsbCwgKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHtcblx0XHRcdG0uZ2V0Q2FjaGVNYW5hZ2VyKCkucmVtb3ZlSXRlbShpZCk7XG5cdFx0XHRzdWNjZXNzKHJlc3BvbnNlIGFzIGFueSk7XG5cdFx0fSwgZmFpbCwgZnJlZXplKTtcblx0fVxuXG5cdHVwZGF0ZShpZDogc3RyaW5nLCBmb3JtRGF0YTogYW55LCBzdWNjZXNzOiB0U2VydmljZVVwZGF0ZVN1Y2Nlc3M8VD4sIGZhaWw6IHRTZXJ2aWNlRmFpbCwgZnJlZXplOiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgdXJsID0gdGhpcy5nZXRJdGVtVVJJKGlkKTtcblxuXHRcdHJldHVybiB0aGlzLmFwcF9jb250ZXh0LnJlcXVlc3QoXCJQQVRDSFwiLCB1cmwsIGZvcm1EYXRhLCAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0c3VjY2VzcyhyZXNwb25zZSBhcyBhbnkpO1xuXHRcdH0sIGZhaWwsIGZyZWV6ZSk7XG5cdH1cblxuXHRkZWxldGVBbGwob3B0aW9uczogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucywgc3VjY2VzczogdFNlcnZpY2VEZWxldGVBbGxTdWNjZXNzPFQ+LCBmYWlsOiB0U2VydmljZUZhaWwsIGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlKTogT1dlYkNvbSB7XG5cdFx0bGV0IHVybCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IHRoaXMuZ2V0U2VydmljZVVSSSgpLFxuXHRcdFx0ZmlsdGVycyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gb3B0aW9ucy5maWx0ZXJzLFxuXHRcdFx0cmVxdWVzdF9kYXRhOiB0U2VydmljZVJlcXVlc3RPcHRpb25zID0ge307XG5cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbXCJtYXhcIl0gPT09IFwibnVtYmVyXCIpIHsvLyB3aWxsIGJlIGlnbm9yZWQgYnkgTydab25lXG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJtYXhcIl0gPSBvcHRpb25zW1wibWF4XCJdO1xuXHRcdH1cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbXCJwYWdlXCJdID09PSBcIm51bWJlclwiKSB7Ly8gd2lsbCBiZSBpZ25vcmVkIGJ5IE8nWm9uZVxuXHRcdFx0cmVxdWVzdF9kYXRhW1wicGFnZVwiXSA9IG9wdGlvbnNbXCJwYWdlXCJdO1xuXHRcdH1cblxuXHRcdGlmIChVdGlscy5pc1BsYWluT2JqZWN0KGZpbHRlcnMpKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJmaWx0ZXJzXCJdID0gZmlsdGVycztcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiREVMRVRFXCIsIHVybCwgcmVxdWVzdF9kYXRhLCAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0c3VjY2VzcyhyZXNwb25zZSBhcyBhbnkpO1xuXHRcdH0sIGZhaWwsIGZyZWV6ZSk7XG5cdH1cblxuXHR1cGRhdGVBbGwob3B0aW9uczogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucywgZm9ybURhdGE6IGFueSwgc3VjY2VzczogdFNlcnZpY2VVcGRhdGVBbGxTdWNjZXNzPFQ+LCBmYWlsOiB0U2VydmljZUZhaWwsIGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlKTogT1dlYkNvbSB7XG5cdFx0bGV0IHVybCAgICAgICAgICAgICAgICAgPSB0aGlzLmdldFNlcnZpY2VVUkkoKSxcblx0XHRcdGZpbHRlcnMgICAgICAgICAgICAgPSBvcHRpb25zLmZpbHRlcnMsXG5cdFx0XHRyZXF1ZXN0X2RhdGE6IHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnNcblx0XHRcdFx0JiB7IGRhdGE6IGFueSB9ID0ge2RhdGE6IGZvcm1EYXRhfTtcblxuXHRcdGlmICh0eXBlb2Ygb3B0aW9uc1tcIm1heFwiXSA9PT0gXCJudW1iZXJcIikgey8vIHdpbGwgYmUgaWdub3JlZCBieSBPJ1pvbmVcblx0XHRcdHJlcXVlc3RfZGF0YVtcIm1heFwiXSA9IG9wdGlvbnNbXCJtYXhcIl07XG5cdFx0fVxuXHRcdGlmICh0eXBlb2Ygb3B0aW9uc1tcInBhZ2VcIl0gPT09IFwibnVtYmVyXCIpIHsvLyB3aWxsIGJlIGlnbm9yZWQgYnkgTydab25lXG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJwYWdlXCJdID0gb3B0aW9uc1tcInBhZ2VcIl07XG5cdFx0fVxuXG5cdFx0aWYgKFV0aWxzLmlzUGxhaW5PYmplY3QoZmlsdGVycykpIHtcblx0XHRcdHJlcXVlc3RfZGF0YVtcImZpbHRlcnNcIl0gPSBmaWx0ZXJzO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzLmFwcF9jb250ZXh0LnJlcXVlc3QoXCJQQVRDSFwiLCB1cmwsIHJlcXVlc3RfZGF0YSwgKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHtcblx0XHRcdHN1Y2Nlc3MocmVzcG9uc2UgYXMgYW55KTtcblx0XHR9LCBmYWlsLCBmcmVlemUpO1xuXHR9XG5cblx0Z2V0KGlkOiBzdHJpbmcsIHJlbGF0aW9uczogc3RyaW5nID0gXCJcIiwgc3VjY2VzczogdFNlcnZpY2VHZXRTdWNjZXNzPFQ+LCBmYWlsOiB0U2VydmljZUZhaWwsIGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlLCBsb2FkX2NhY2hlX2ZpcnN0OiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgbSAgICAgICAgID0gdGhpcyxcblx0XHRcdHVybCAgICAgICA9IHRoaXMuZ2V0SXRlbVVSSShpZCksXG5cdFx0XHRkYXRhOiBhbnkgPSBudWxsLFxuXHRcdFx0Y2FjaGVfaWQgID0gaWQsIF9fY2FjaGVkO1xuXG5cdFx0aWYgKHJlbGF0aW9ucy5sZW5ndGgpIHtcblx0XHRcdGRhdGEgPSB7cmVsYXRpb25zfTtcblx0XHR9XG5cblx0XHRpZiAobG9hZF9jYWNoZV9maXJzdCkge1xuXHRcdFx0X19jYWNoZWQgPSBtLmdldENhY2hlTWFuYWdlcigpLmdldEl0ZW0oY2FjaGVfaWQpO1xuXG5cdFx0XHRpZiAoX19jYWNoZWQpIHtcblx0XHRcdFx0c3VjY2VzcyhfX2NhY2hlZCwgdHJ1ZSk7XG5cdFx0XHRcdGZyZWV6ZSA9IGZhbHNlO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzLmFwcF9jb250ZXh0LnJlcXVlc3QoXCJHRVRcIiwgdXJsLCBkYXRhLCAocmVzcG9uc2U6IGlDb21SZXNwb25zZSkgPT4ge1xuXHRcdFx0bS5nZXRDYWNoZU1hbmFnZXIoKS5zZXRJdGVtKGlkLCByZXNwb25zZSk7XG5cdFx0XHRzdWNjZXNzKHJlc3BvbnNlIGFzIGFueSwgZmFsc2UpO1xuXHRcdH0sIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB7XG5cblx0XHRcdGlmICgoX19jYWNoZWQgPSBtLmdldENhY2hlTWFuYWdlcigpLmdldEl0ZW0oY2FjaGVfaWQpKSkge1xuXHRcdFx0XHRzdWNjZXNzKF9fY2FjaGVkLCB0cnVlKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGZhaWwocmVzcG9uc2UpO1xuXHRcdFx0fVxuXHRcdH0sIGZyZWV6ZSk7XG5cblx0fVxuXG5cdGdldEFsbChvcHRpb25zOiB0U2VydmljZVJlcXVlc3RPcHRpb25zLCBzdWNjZXNzOiB0U2VydmljZUdldEFsbFN1Y2Nlc3M8VD4sIGZhaWw6IHRTZXJ2aWNlRmFpbCwgZnJlZXplOiBib29sZWFuID0gZmFsc2UsIGZvcmNlX2NhY2hlOiBib29sZWFuID0gZmFsc2UsIGxvYWRfY2FjaGVfZmlyc3Q6IGJvb2xlYW4gPSBmYWxzZSk6IE9XZWJDb20ge1xuXHRcdGxldCBtICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSB0aGlzLFxuXHRcdFx0dXJsICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gdGhpcy5nZXRTZXJ2aWNlVVJJKCksXG5cdFx0XHRmaWx0ZXJzICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBvcHRpb25zW1wiZmlsdGVyc1wiXSxcblx0XHRcdHJlcXVlc3RfZGF0YTogdFNlcnZpY2VSZXF1ZXN0T3B0aW9ucyA9IHt9LFxuXHRcdFx0X19jYWNoZWQ7XG5cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbXCJtYXhcIl0gPT09IFwibnVtYmVyXCIpIHtcblx0XHRcdHJlcXVlc3RfZGF0YVtcIm1heFwiXSA9IG9wdGlvbnNbXCJtYXhcIl07XG5cdFx0fVxuXHRcdGlmICh0eXBlb2Ygb3B0aW9uc1tcInBhZ2VcIl0gPT09IFwibnVtYmVyXCIpIHtcblx0XHRcdHJlcXVlc3RfZGF0YVtcInBhZ2VcIl0gPSBvcHRpb25zW1wicGFnZVwiXTtcblx0XHR9XG5cblx0XHRpZiAodHlwZW9mIG9wdGlvbnMucmVsYXRpb25zID09PSBcInN0cmluZ1wiKSB7XG5cdFx0XHRyZXF1ZXN0X2RhdGFbXCJyZWxhdGlvbnNcIl0gPSBvcHRpb25zLnJlbGF0aW9uc1xuXHRcdH1cblx0XHRpZiAodHlwZW9mIG9wdGlvbnMuY29sbGVjdGlvbiA9PT0gXCJzdHJpbmdcIikge1xuXHRcdFx0cmVxdWVzdF9kYXRhW1wiY29sbGVjdGlvblwiXSA9IG9wdGlvbnMuY29sbGVjdGlvblxuXHRcdH1cblxuXHRcdGlmICh0eXBlb2Ygb3B0aW9ucy5vcmRlcl9ieSA9PT0gXCJzdHJpbmdcIikge1xuXHRcdFx0cmVxdWVzdF9kYXRhW1wib3JkZXJfYnlcIl0gPSBvcHRpb25zLm9yZGVyX2J5XG5cdFx0fVxuXG5cdFx0aWYgKFV0aWxzLmlzUGxhaW5PYmplY3QoZmlsdGVycykpIHtcblx0XHRcdHJlcXVlc3RfZGF0YVtcImZpbHRlcnNcIl0gPSBmaWx0ZXJzO1xuXHRcdH1cblxuXHRcdGxldCBjYWNoZV9pZCA9IHRvS2V5KHJlcXVlc3RfZGF0YSk7XG5cblx0XHRpZiAoZm9yY2VfY2FjaGUgJiYgbG9hZF9jYWNoZV9maXJzdCkge1xuXHRcdFx0X19jYWNoZWQgPSBtLmdldENhY2hlTWFuYWdlcigpLmdldEl0ZW0oY2FjaGVfaWQpO1xuXG5cdFx0XHRpZiAoX19jYWNoZWQpIHtcblx0XHRcdFx0c3VjY2VzcyhfX2NhY2hlZCwgdHJ1ZSk7XG5cdFx0XHRcdGZyZWV6ZSA9IGZhbHNlO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzLmFwcF9jb250ZXh0LnJlcXVlc3QoXCJHRVRcIiwgdXJsLCByZXF1ZXN0X2RhdGEsIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSA9PiB7XG5cdFx0XHRmb3JjZV9jYWNoZSAmJiBtLmdldENhY2hlTWFuYWdlcigpLnNldEl0ZW0oY2FjaGVfaWQsIHJlc3BvbnNlKTtcblx0XHRcdHN1Y2Nlc3MocmVzcG9uc2UgYXMgYW55LCBmYWxzZSk7XG5cdFx0fSwgKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpID0+IHtcblx0XHRcdGlmIChmb3JjZV9jYWNoZSAmJiAoX19jYWNoZWQgPSBtLmdldENhY2hlTWFuYWdlcigpLmdldEl0ZW0oY2FjaGVfaWQpKSkge1xuXHRcdFx0XHRzdWNjZXNzKF9fY2FjaGVkLCB0cnVlKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGZhaWwocmVzcG9uc2UpO1xuXHRcdFx0fVxuXHRcdH0sIGZyZWV6ZSk7XG5cblx0fVxuXG5cdGdldFJlbGF0aW9uPFI+KGlkOiBzdHJpbmcsIHJlbGF0aW9uOiBzdHJpbmcsIHN1Y2Nlc3M6IHRTZXJ2aWNlR2V0UmVsYXRpb25TdWNjZXNzPFI+LCBmYWlsOiB0U2VydmljZUZhaWwsIGZyZWV6ZTogYm9vbGVhbiA9IGZhbHNlLCBmb3JjZV9jYWNoZTogYm9vbGVhbiA9IGZhbHNlLCBsb2FkX2NhY2hlX2ZpcnN0OiBib29sZWFuID0gZmFsc2UpOiBPV2ViQ29tIHtcblx0XHRsZXQgbSAgICAgICAgPSB0aGlzLFxuXHRcdFx0dXJsICAgICAgPSB0aGlzLmdldEl0ZW1SZWxhdGlvblVSSShpZCwgcmVsYXRpb24pLFxuXHRcdFx0Y2FjaGVfaWQgPSB0b0tleSh7aWQsIHJlbGF0aW9ufSksIF9fY2FjaGVkO1xuXG5cdFx0aWYgKGZvcmNlX2NhY2hlICYmIGxvYWRfY2FjaGVfZmlyc3QpIHtcblx0XHRcdF9fY2FjaGVkID0gdGhpcy5nZXRDYWNoZU1hbmFnZXIoKS5nZXRJdGVtKGNhY2hlX2lkKTtcblxuXHRcdFx0aWYgKF9fY2FjaGVkKSB7XG5cdFx0XHRcdHN1Y2Nlc3MoX19jYWNoZWQsIHRydWUpO1xuXHRcdFx0XHRmcmVlemUgPSBmYWxzZTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5hcHBfY29udGV4dC5yZXF1ZXN0KFwiR0VUXCIsIHVybCwge30sIGZ1bmN0aW9uIChyZXNwb25zZTogaUNvbVJlc3BvbnNlKSB7XG5cdFx0XHRmb3JjZV9jYWNoZSAmJiBtLmdldENhY2hlTWFuYWdlcigpLnNldEl0ZW0oY2FjaGVfaWQsIHJlc3BvbnNlKTtcblx0XHRcdHN1Y2Nlc3MocmVzcG9uc2UgYXMgYW55LCBmYWxzZSk7XG5cdFx0fSwgZnVuY3Rpb24gKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpIHtcblx0XHRcdGlmIChmb3JjZV9jYWNoZSAmJiAoX19jYWNoZWQgPSBtLmdldENhY2hlTWFuYWdlcigpLmdldEl0ZW0oY2FjaGVfaWQpKSkge1xuXHRcdFx0XHRzdWNjZXNzKF9fY2FjaGVkLCB0cnVlKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGZhaWwocmVzcG9uc2UpO1xuXHRcdFx0fVxuXHRcdH0sIGZyZWV6ZSk7XG5cdH1cblxuXHRnZXRSZWxhdGlvbkl0ZW1zPFI+KGlkOiBzdHJpbmcsIHJlbGF0aW9uOiBzdHJpbmcsIG9wdGlvbnM6IHRTZXJ2aWNlUmVxdWVzdE9wdGlvbnMsIHN1Y2Nlc3M6IHRTZXJ2aWNlR2V0UmVsYXRpb25JdGVtc1N1Y2Nlc3M8Uj4sIGZhaWw6IHRTZXJ2aWNlRmFpbCwgZnJlZXplOiBib29sZWFuID0gZmFsc2UsIGZvcmNlX2NhY2hlOiBib29sZWFuID0gZmFsc2UsIGxvYWRfY2FjaGVfZmlyc3Q6IGJvb2xlYW4gPSBmYWxzZSk6IE9XZWJDb20ge1xuXHRcdGxldCBtICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSB0aGlzLFxuXHRcdFx0dXJsICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gdGhpcy5nZXRJdGVtUmVsYXRpb25VUkkoaWQsIHJlbGF0aW9uKSxcblx0XHRcdGZpbHRlcnMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IG9wdGlvbnNbXCJmaWx0ZXJzXCJdLFxuXHRcdFx0cmVxdWVzdF9kYXRhOiB0U2VydmljZVJlcXVlc3RPcHRpb25zID0ge307XG5cblx0XHRpZiAodHlwZW9mIG9wdGlvbnNbXCJtYXhcIl0gPT09IFwibnVtYmVyXCIpIHtcblx0XHRcdHJlcXVlc3RfZGF0YVtcIm1heFwiXSA9IG9wdGlvbnNbXCJtYXhcIl07XG5cdFx0fVxuXHRcdGlmICh0eXBlb2Ygb3B0aW9uc1tcInBhZ2VcIl0gPT09IFwibnVtYmVyXCIpIHtcblx0XHRcdHJlcXVlc3RfZGF0YVtcInBhZ2VcIl0gPSBvcHRpb25zW1wicGFnZVwiXTtcblx0XHR9XG5cblx0XHRpZiAoVXRpbHMuaXNQbGFpbk9iamVjdChmaWx0ZXJzKSkge1xuXHRcdFx0cmVxdWVzdF9kYXRhW1wiZmlsdGVyc1wiXSA9IGZpbHRlcnM7XG5cdFx0fVxuXG5cdFx0bGV0IGNhY2hlX2lkID0gdG9LZXkoVXRpbHMuYXNzaWduKHtyZWxhdGlvbjogcmVsYXRpb259LCByZXF1ZXN0X2RhdGEpKSxcblx0XHRcdF9fY2FjaGVkO1xuXG5cdFx0aWYgKGZvcmNlX2NhY2hlICYmIGxvYWRfY2FjaGVfZmlyc3QpIHtcblx0XHRcdF9fY2FjaGVkID0gPGlTZXJ2aWNlR2V0UmVsYXRpb25JdGVtc1Jlc3BvbnNlPFI+PnRoaXMuZ2V0Q2FjaGVNYW5hZ2VyKCkuZ2V0SXRlbShjYWNoZV9pZCk7XG5cblx0XHRcdGlmIChfX2NhY2hlZCkge1xuXHRcdFx0XHRzdWNjZXNzKF9fY2FjaGVkLCB0cnVlKTtcblx0XHRcdFx0ZnJlZXplID0gZmFsc2U7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXMuYXBwX2NvbnRleHQucmVxdWVzdChcIkdFVFwiLCB1cmwsIHJlcXVlc3RfZGF0YSwgZnVuY3Rpb24gKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpIHtcblxuXHRcdFx0Zm9yY2VfY2FjaGUgJiYgbS5nZXRDYWNoZU1hbmFnZXIoKS5zZXRJdGVtKGNhY2hlX2lkLCByZXNwb25zZSk7XG5cblx0XHRcdHN1Y2Nlc3MocmVzcG9uc2UgYXMgYW55LCBmYWxzZSk7XG5cdFx0fSwgZnVuY3Rpb24gKHJlc3BvbnNlOiBpQ29tUmVzcG9uc2UpIHtcblx0XHRcdGlmIChmb3JjZV9jYWNoZSAmJiAoX19jYWNoZWQgPSBtLmdldENhY2hlTWFuYWdlcigpLmdldEl0ZW0oY2FjaGVfaWQpKSkge1xuXHRcdFx0XHRzdWNjZXNzKF9fY2FjaGVkLCB0cnVlKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGZhaWwocmVzcG9uc2UpO1xuXHRcdFx0fVxuXHRcdH0sIGZyZWV6ZSk7XG5cdH1cbn0iXX0=