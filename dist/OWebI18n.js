import Utils from "../src/utils/Utils";
import OWebEvent from "../src/OWebEvent";
const LANG_OBJECT = {};
const TOKEN_REG = /{\s*(@)?(?:([a-z-]{2,})\.)?([a-z_][a-z0-9_]*)\s*}/ig; // {name} | {@message} | {@fr.message}
const sample = {
    message: 'Hello World!',
    message_with_token: 'Hello {name}!',
    message_with_pluralize: 'one message ~ two messages ~ {n} messages',
    message_with_sub_message: '{@message_with_token} Welcome to our website.',
    message_with_sub_message_specific_lang: '{@fr.message_with_token} We speak french too!'
};
let parse = function (str) {
    let out = str.replace(/([\r\n"'])/g, "\\$1")
        .replace(TOKEN_REG, function (found, is_sub, lang, path) {
        let l, x;
        if (is_sub) {
            l = lang ? '"' + lang + '"' : 'l';
            x = `_("${path}", d, ${l})`;
        }
        else {
            x = 'd.' + path;
        }
        return '"+' + x + '+"';
    });
    return new Function('_', 'd', 'l', `return ["${out}"];`.replace(/\s?~\s?/g, '","'));
};
let _tmp = new Map, translate = function (key, data, pluralize = 0, lang) {
    let id = `${lang}:${key}`, message = key, format, fn;
    if (_tmp.has(id)) {
        fn = _tmp.get(id);
    }
    else if (LANG_OBJECT[lang] && (format = LANG_OBJECT[lang][key])) {
        _tmp.set(id, fn = parse(format));
    }
    if (fn) {
        let parts = fn(translate, data, lang), len = parts.length, index;
        if (typeof pluralize === 'function') {
            index = pluralize(data, parts);
        }
        else {
            index = pluralize;
        }
        index = Math.max(Math.min(index, len - 1), 0);
        message = parts[index];
    }
    return message;
};
export default class OWebI18n extends OWebEvent {
    constructor() {
        super(...arguments);
        this.defaultLangCode = "en";
    }
    /**
     * Sets default i18n lang code.
     *
     * @param lang The i18n lang code.
     */
    setDefaultLang(lang) {
        if (!LANG_OBJECT[lang]) {
            throw new Error(`[OWebLang] can't set default language, undefined language data for: ${lang}.`);
        }
        this.defaultLangCode = lang;
        return this;
    }
    /**
     * Returns i18n translation.
     *
     * @param key The i18n string key.
     * @param data The data to inject in translation process.
     * @param pluralize
     * @param lang The i18n lang code to use.
     */
    toHuman(key, data = {}, pluralize = 0, lang = this.defaultLangCode) {
        return translate(key, data, pluralize, lang);
    }
    /**
     * Sets i18n for HTMLElement
     *
     * @param el
     * @param options
     */
    el(el, options) {
        if (typeof options === 'string') {
            options = { text: options };
        }
        const { nodeName } = el, isInput = (nodeName === 'INPUT' || nodeName === 'TEXTAREA'), { text, placeholder, title, data = {}, lang = this.defaultLangCode, pluralize } = options;
        let str;
        if (text) {
            str = translate(text, data, pluralize, lang);
            if (!isInput) {
                el.innerHTML = str;
            }
            else {
                el.setAttribute("value", str);
            }
        }
        if (isInput && placeholder) {
            str = translate(placeholder, data, pluralize, lang);
            el.setAttribute('placeholder', str);
        }
        if (title) {
            str = translate(title, data, pluralize, lang);
            el.setAttribute('title', str);
        }
    }
    /**
     * Sets the i18n lang data.
     *
     * @param lang The i18n lang code
     * @param data The i18n lang data.
     */
    static loadLangData(lang, data) {
        if (!Utils.isString(lang)) {
            throw new TypeError("[OWebI18n] your lang name should be a valid string.");
        }
        if (!Utils.isPlainObject(data)) {
            throw new TypeError("[OWebI18n] your lang data should be a valid plain object.");
        }
        LANG_OBJECT[lang] = Utils.assign(LANG_OBJECT[lang] || {}, data);
        return this;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkkxOG4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYkkxOG4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLE1BQU0sb0JBQW9CLENBQUM7QUFDdkMsT0FBTyxTQUFTLE1BQU0sa0JBQWtCLENBQUM7QUFjekMsTUFBTSxXQUFXLEdBQXlDLEVBQUUsQ0FBQztBQUM3RCxNQUFNLFNBQVMsR0FBRyxxREFBcUQsQ0FBQyxDQUFDLHNDQUFzQztBQUUvRyxNQUFNLE1BQU0sR0FBRztJQUNkLE9BQU8sRUFBRSxjQUFjO0lBQ3ZCLGtCQUFrQixFQUFFLGVBQWU7SUFDbkMsc0JBQXNCLEVBQUUsMkNBQTJDO0lBQ25FLHdCQUF3QixFQUFFLCtDQUErQztJQUN6RSxzQ0FBc0MsRUFBRSwrQ0FBK0M7Q0FDdkYsQ0FBQztBQUVGLElBQUksS0FBSyxHQUFHLFVBQVUsR0FBVztJQUVoQyxJQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxNQUFNLENBQUM7U0FDMUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxVQUFVLEtBQUssRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUk7UUFDdEQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ1QsSUFBSSxNQUFNLEVBQUU7WUFDWCxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO1lBQ2xDLENBQUMsR0FBRyxNQUFPLElBQUssU0FBVSxDQUFFLEdBQUcsQ0FBQztTQUNoQzthQUFNO1lBQ04sQ0FBQyxHQUFHLElBQUksR0FBRyxJQUFJLENBQUM7U0FDaEI7UUFFRCxPQUFPLElBQUksR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDO0lBQ3hCLENBQUMsQ0FBQyxDQUFDO0lBRUosT0FBTyxJQUFJLFFBQVEsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxZQUFhLEdBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztBQUN2RixDQUFDLENBQUM7QUFFRixJQUFJLElBQUksR0FBRyxJQUFJLEdBQUcsRUFDakIsU0FBUyxHQUFHLFVBQVUsR0FBVyxFQUFFLElBQWUsRUFBRSxZQUE0QixDQUFDLEVBQUUsSUFBWTtJQUU5RixJQUFJLEVBQUUsR0FBRyxHQUFJLElBQUssSUFBSyxHQUFJLEVBQUUsRUFDNUIsT0FBTyxHQUFHLEdBQUcsRUFDYixNQUFNLEVBQ04sRUFBRSxDQUFDO0lBRUosSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFO1FBQ2pCLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0tBQ2xCO1NBQU0sSUFBSSxXQUFXLENBQUUsSUFBSSxDQUFFLElBQUksQ0FBQyxNQUFNLEdBQUcsV0FBVyxDQUFFLElBQUksQ0FBRSxDQUFFLEdBQUcsQ0FBRSxDQUFDLEVBQUU7UUFDeEUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0tBQ2pDO0lBRUQsSUFBSSxFQUFFLEVBQUU7UUFDUCxJQUFJLEtBQUssR0FBRyxFQUFFLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsRUFDcEMsR0FBRyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDO1FBRTNCLElBQUksT0FBTyxTQUFTLEtBQUssVUFBVSxFQUFFO1lBQ3BDLEtBQUssR0FBRyxTQUFTLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQy9CO2FBQU07WUFDTixLQUFLLEdBQUcsU0FBUyxDQUFDO1NBQ2xCO1FBRUQsS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzlDLE9BQU8sR0FBRyxLQUFLLENBQUUsS0FBSyxDQUFFLENBQUM7S0FDekI7SUFFRCxPQUFPLE9BQU8sQ0FBQztBQUNoQixDQUFDLENBQUM7QUFFSCxNQUFNLENBQUMsT0FBTyxlQUFnQixTQUFRLFNBQVM7SUFBL0M7O1FBQ0Msb0JBQWUsR0FBVyxJQUFJLENBQUM7SUF1RmhDLENBQUM7SUFyRkE7Ozs7T0FJRztJQUNILGNBQWMsQ0FBQyxJQUFZO1FBRTFCLElBQUksQ0FBQyxXQUFXLENBQUUsSUFBSSxDQUFFLEVBQUU7WUFDekIsTUFBTSxJQUFJLEtBQUssQ0FBQyx1RUFBd0UsSUFBSyxHQUFHLENBQUMsQ0FBQTtTQUNqRztRQUVELElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO1FBRTVCLE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztJQUVEOzs7Ozs7O09BT0c7SUFDSCxPQUFPLENBQUMsR0FBVyxFQUFFLE9BQWtCLEVBQUUsRUFBRSxZQUE0QixDQUFDLEVBQUUsT0FBZSxJQUFJLENBQUMsZUFBZTtRQUM1RyxPQUFPLFNBQVMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCxFQUFFLENBQUMsRUFBZSxFQUFFLE9BQThCO1FBRWpELElBQUksT0FBTyxPQUFPLEtBQUssUUFBUSxFQUFFO1lBQ2hDLE9BQU8sR0FBRyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsQ0FBQztTQUM1QjtRQUVELE1BQU0sRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLEVBQ3RCLE9BQU8sR0FBRyxDQUFDLFFBQVEsS0FBSyxPQUFPLElBQUksUUFBUSxLQUFLLFVBQVUsQ0FBQyxFQUMzRCxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFLElBQUksR0FBRyxFQUFFLEVBQUUsSUFBSSxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsU0FBUyxFQUFFLEdBQUcsT0FBTyxDQUFDO1FBQzNGLElBQUksR0FBRyxDQUFDO1FBRVIsSUFBSSxJQUFJLEVBQUU7WUFDVCxHQUFHLEdBQUcsU0FBUyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQzdDLElBQUksQ0FBQyxPQUFPLEVBQUU7Z0JBQ2IsRUFBRSxDQUFDLFNBQVMsR0FBRyxHQUFHLENBQUM7YUFDbkI7aUJBQU07Z0JBQ04sRUFBRSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7YUFDOUI7U0FDRDtRQUVELElBQUksT0FBTyxJQUFJLFdBQVcsRUFBRTtZQUMzQixHQUFHLEdBQUcsU0FBUyxDQUFDLFdBQVcsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ3BELEVBQUUsQ0FBQyxZQUFZLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQ3BDO1FBRUQsSUFBSSxLQUFLLEVBQUU7WUFDVixHQUFHLEdBQUcsU0FBUyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQzlDLEVBQUUsQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQzlCO0lBQ0YsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFZLEVBQUUsSUFBcUI7UUFFdEQsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDMUIsTUFBTSxJQUFJLFNBQVMsQ0FBQyxxREFBcUQsQ0FBQyxDQUFDO1NBQzNFO1FBRUQsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDL0IsTUFBTSxJQUFJLFNBQVMsQ0FBQywyREFBMkQsQ0FBQyxDQUFDO1NBQ2pGO1FBRUQsV0FBVyxDQUFFLElBQUksQ0FBRSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFFLElBQUksQ0FBRSxJQUFJLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVwRSxPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBVdGlscyBmcm9tIFwiLi4vc3JjL3V0aWxzL1V0aWxzXCI7XG5pbXBvcnQgT1dlYkV2ZW50IGZyb20gXCIuLi9zcmMvT1dlYkV2ZW50XCI7XG5cbmV4cG9ydCB0eXBlIHRJMThuRGVmaW5pdGlvbiA9IHsgWyBrZXk6IHN0cmluZyBdOiBhbnkgfTtcbmV4cG9ydCB0eXBlIHRJMThuRGF0YSA9IHsgWyBrZXk6IHN0cmluZyBdOiBhbnkgfTtcbmV4cG9ydCB0eXBlIHRJMThuT3B0aW9ucyA9IHtcblx0dGV4dD86IHN0cmluZyxcblx0cGxhY2Vob2xkZXI/OiBzdHJpbmcsXG5cdHRpdGxlPzogc3RyaW5nLFxuXHRsYW5nPzogc3RyaW5nLFxuXHRkYXRhPzogdEkxOG5EYXRhLFxuXHRwbHVyYWxpemU/OiB0STE4blBsdXJhbGl6ZVxufTtcbmV4cG9ydCB0eXBlIHRJMThuUGx1cmFsaXplID0gbnVtYmVyIHwgKChkYXRhOiB0STE4bkRhdGEsIHBhcnRzOiBzdHJpbmdbXSkgPT4gbnVtYmVyKTtcblxuY29uc3QgTEFOR19PQkpFQ1Q6IHsgWyBrZXk6IHN0cmluZyBdOiB0STE4bkRlZmluaXRpb24gfSA9IHt9O1xuY29uc3QgVE9LRU5fUkVHID0gL3tcXHMqKEApPyg/OihbYS16LV17Mix9KVxcLik/KFthLXpfXVthLXowLTlfXSopXFxzKn0vaWc7IC8vIHtuYW1lfSB8IHtAbWVzc2FnZX0gfCB7QGZyLm1lc3NhZ2V9XG5cbmNvbnN0IHNhbXBsZSA9IHtcblx0bWVzc2FnZTogJ0hlbGxvIFdvcmxkIScsXG5cdG1lc3NhZ2Vfd2l0aF90b2tlbjogJ0hlbGxvIHtuYW1lfSEnLFxuXHRtZXNzYWdlX3dpdGhfcGx1cmFsaXplOiAnb25lIG1lc3NhZ2UgfiB0d28gbWVzc2FnZXMgfiB7bn0gbWVzc2FnZXMnLFxuXHRtZXNzYWdlX3dpdGhfc3ViX21lc3NhZ2U6ICd7QG1lc3NhZ2Vfd2l0aF90b2tlbn0gV2VsY29tZSB0byBvdXIgd2Vic2l0ZS4nLFxuXHRtZXNzYWdlX3dpdGhfc3ViX21lc3NhZ2Vfc3BlY2lmaWNfbGFuZzogJ3tAZnIubWVzc2FnZV93aXRoX3Rva2VufSBXZSBzcGVhayBmcmVuY2ggdG9vISdcbn07XG5cbmxldCBwYXJzZSA9IGZ1bmN0aW9uIChzdHI6IHN0cmluZykge1xuXG5cdGxldCBvdXQgPSBzdHIucmVwbGFjZSgvKFtcXHJcXG5cIiddKS9nLCBcIlxcXFwkMVwiKVxuXHRcdC5yZXBsYWNlKFRPS0VOX1JFRywgZnVuY3Rpb24gKGZvdW5kLCBpc19zdWIsIGxhbmcsIHBhdGgpIHtcblx0XHRcdGxldCBsLCB4O1xuXHRcdFx0aWYgKGlzX3N1Yikge1xuXHRcdFx0XHRsID0gbGFuZyA/ICdcIicgKyBsYW5nICsgJ1wiJyA6ICdsJztcblx0XHRcdFx0eCA9IGBfKFwiJHsgcGF0aCB9XCIsIGQsICR7IGwgfSlgO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0eCA9ICdkLicgKyBwYXRoO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gJ1wiKycgKyB4ICsgJytcIic7XG5cdFx0fSk7XG5cblx0cmV0dXJuIG5ldyBGdW5jdGlvbignXycsICdkJywgJ2wnLCBgcmV0dXJuIFtcIiR7IG91dCB9XCJdO2AucmVwbGFjZSgvXFxzP35cXHM/L2csICdcIixcIicpKTtcbn07XG5cbmxldCBfdG1wID0gbmV3IE1hcCxcblx0dHJhbnNsYXRlID0gZnVuY3Rpb24gKGtleTogc3RyaW5nLCBkYXRhOiB0STE4bkRhdGEsIHBsdXJhbGl6ZTogdEkxOG5QbHVyYWxpemUgPSAwLCBsYW5nOiBzdHJpbmcpOiBzdHJpbmcge1xuXG5cdFx0bGV0IGlkID0gYCR7IGxhbmcgfTokeyBrZXkgfWAsXG5cdFx0XHRtZXNzYWdlID0ga2V5LFxuXHRcdFx0Zm9ybWF0LFxuXHRcdFx0Zm47XG5cblx0XHRpZiAoX3RtcC5oYXMoaWQpKSB7XG5cdFx0XHRmbiA9IF90bXAuZ2V0KGlkKTtcblx0XHR9IGVsc2UgaWYgKExBTkdfT0JKRUNUWyBsYW5nIF0gJiYgKGZvcm1hdCA9IExBTkdfT0JKRUNUWyBsYW5nIF1bIGtleSBdKSkge1xuXHRcdFx0X3RtcC5zZXQoaWQsIGZuID0gcGFyc2UoZm9ybWF0KSk7XG5cdFx0fVxuXG5cdFx0aWYgKGZuKSB7XG5cdFx0XHRsZXQgcGFydHMgPSBmbih0cmFuc2xhdGUsIGRhdGEsIGxhbmcpLFxuXHRcdFx0XHRsZW4gPSBwYXJ0cy5sZW5ndGgsIGluZGV4O1xuXG5cdFx0XHRpZiAodHlwZW9mIHBsdXJhbGl6ZSA9PT0gJ2Z1bmN0aW9uJykge1xuXHRcdFx0XHRpbmRleCA9IHBsdXJhbGl6ZShkYXRhLCBwYXJ0cyk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRpbmRleCA9IHBsdXJhbGl6ZTtcblx0XHRcdH1cblxuXHRcdFx0aW5kZXggPSBNYXRoLm1heChNYXRoLm1pbihpbmRleCwgbGVuIC0gMSksIDApO1xuXHRcdFx0bWVzc2FnZSA9IHBhcnRzWyBpbmRleCBdO1xuXHRcdH1cblxuXHRcdHJldHVybiBtZXNzYWdlO1xuXHR9O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViSTE4biBleHRlbmRzIE9XZWJFdmVudCB7XG5cdGRlZmF1bHRMYW5nQ29kZTogc3RyaW5nID0gXCJlblwiO1xuXG5cdC8qKlxuXHQgKiBTZXRzIGRlZmF1bHQgaTE4biBsYW5nIGNvZGUuXG5cdCAqXG5cdCAqIEBwYXJhbSBsYW5nIFRoZSBpMThuIGxhbmcgY29kZS5cblx0ICovXG5cdHNldERlZmF1bHRMYW5nKGxhbmc6IHN0cmluZykge1xuXG5cdFx0aWYgKCFMQU5HX09CSkVDVFsgbGFuZyBdKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYFtPV2ViTGFuZ10gY2FuJ3Qgc2V0IGRlZmF1bHQgbGFuZ3VhZ2UsIHVuZGVmaW5lZCBsYW5ndWFnZSBkYXRhIGZvcjogJHsgbGFuZyB9LmApXG5cdFx0fVxuXG5cdFx0dGhpcy5kZWZhdWx0TGFuZ0NvZGUgPSBsYW5nO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyBpMThuIHRyYW5zbGF0aW9uLlxuXHQgKlxuXHQgKiBAcGFyYW0ga2V5IFRoZSBpMThuIHN0cmluZyBrZXkuXG5cdCAqIEBwYXJhbSBkYXRhIFRoZSBkYXRhIHRvIGluamVjdCBpbiB0cmFuc2xhdGlvbiBwcm9jZXNzLlxuXHQgKiBAcGFyYW0gcGx1cmFsaXplXG5cdCAqIEBwYXJhbSBsYW5nIFRoZSBpMThuIGxhbmcgY29kZSB0byB1c2UuXG5cdCAqL1xuXHR0b0h1bWFuKGtleTogc3RyaW5nLCBkYXRhOiB0STE4bkRhdGEgPSB7fSwgcGx1cmFsaXplOiB0STE4blBsdXJhbGl6ZSA9IDAsIGxhbmc6IHN0cmluZyA9IHRoaXMuZGVmYXVsdExhbmdDb2RlKTogc3RyaW5nIHtcblx0XHRyZXR1cm4gdHJhbnNsYXRlKGtleSwgZGF0YSwgcGx1cmFsaXplLCBsYW5nKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBTZXRzIGkxOG4gZm9yIEhUTUxFbGVtZW50XG5cdCAqXG5cdCAqIEBwYXJhbSBlbFxuXHQgKiBAcGFyYW0gb3B0aW9uc1xuXHQgKi9cblx0ZWwoZWw6IEhUTUxFbGVtZW50LCBvcHRpb25zOiB0STE4bk9wdGlvbnMgfCBzdHJpbmcpIHtcblxuXHRcdGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHtcblx0XHRcdG9wdGlvbnMgPSB7IHRleHQ6IG9wdGlvbnMgfTtcblx0XHR9XG5cblx0XHRjb25zdCB7IG5vZGVOYW1lIH0gPSBlbCxcblx0XHRcdGlzSW5wdXQgPSAobm9kZU5hbWUgPT09ICdJTlBVVCcgfHwgbm9kZU5hbWUgPT09ICdURVhUQVJFQScpLFxuXHRcdFx0eyB0ZXh0LCBwbGFjZWhvbGRlciwgdGl0bGUsIGRhdGEgPSB7fSwgbGFuZyA9IHRoaXMuZGVmYXVsdExhbmdDb2RlLCBwbHVyYWxpemUgfSA9IG9wdGlvbnM7XG5cdFx0bGV0IHN0cjtcblxuXHRcdGlmICh0ZXh0KSB7XG5cdFx0XHRzdHIgPSB0cmFuc2xhdGUodGV4dCwgZGF0YSwgcGx1cmFsaXplLCBsYW5nKTtcblx0XHRcdGlmICghaXNJbnB1dCkge1xuXHRcdFx0XHRlbC5pbm5lckhUTUwgPSBzdHI7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRlbC5zZXRBdHRyaWJ1dGUoXCJ2YWx1ZVwiLCBzdHIpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGlmIChpc0lucHV0ICYmIHBsYWNlaG9sZGVyKSB7XG5cdFx0XHRzdHIgPSB0cmFuc2xhdGUocGxhY2Vob2xkZXIsIGRhdGEsIHBsdXJhbGl6ZSwgbGFuZyk7XG5cdFx0XHRlbC5zZXRBdHRyaWJ1dGUoJ3BsYWNlaG9sZGVyJywgc3RyKTtcblx0XHR9XG5cblx0XHRpZiAodGl0bGUpIHtcblx0XHRcdHN0ciA9IHRyYW5zbGF0ZSh0aXRsZSwgZGF0YSwgcGx1cmFsaXplLCBsYW5nKTtcblx0XHRcdGVsLnNldEF0dHJpYnV0ZSgndGl0bGUnLCBzdHIpO1xuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBTZXRzIHRoZSBpMThuIGxhbmcgZGF0YS5cblx0ICpcblx0ICogQHBhcmFtIGxhbmcgVGhlIGkxOG4gbGFuZyBjb2RlXG5cdCAqIEBwYXJhbSBkYXRhIFRoZSBpMThuIGxhbmcgZGF0YS5cblx0ICovXG5cdHN0YXRpYyBsb2FkTGFuZ0RhdGEobGFuZzogc3RyaW5nLCBkYXRhOiB0STE4bkRlZmluaXRpb24pIHtcblxuXHRcdGlmICghVXRpbHMuaXNTdHJpbmcobGFuZykpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoXCJbT1dlYkkxOG5dIHlvdXIgbGFuZyBuYW1lIHNob3VsZCBiZSBhIHZhbGlkIHN0cmluZy5cIik7XG5cdFx0fVxuXG5cdFx0aWYgKCFVdGlscy5pc1BsYWluT2JqZWN0KGRhdGEpKSB7XG5cdFx0XHR0aHJvdyBuZXcgVHlwZUVycm9yKFwiW09XZWJJMThuXSB5b3VyIGxhbmcgZGF0YSBzaG91bGQgYmUgYSB2YWxpZCBwbGFpbiBvYmplY3QuXCIpO1xuXHRcdH1cblxuXHRcdExBTkdfT0JKRUNUWyBsYW5nIF0gPSBVdGlscy5hc3NpZ24oTEFOR19PQkpFQ1RbIGxhbmcgXSB8fCB7fSwgZGF0YSk7XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxufVxuIl19