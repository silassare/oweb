import Utils from "../src/utils/Utils";
import OWebEvent from "../src/OWebEvent";
const LANG_OBJECT = {};
const TOKEN_REG = /{\s*(@)?(?:([a-z-]{2,})\.)?([a-z_][a-z0-9_]*)\s*}/ig; // {name} | {@message} | {@fr.message}
const sample = {
    message: 'Hello World!',
    message_with_token: 'Hello {name}!',
    message_with_pluralize: 'one message ~ two messages ~ {n} messages',
    message_with_sub_message: '{@message_with_token} Welcome to our website.',
    message_with_sub_message_specific_lang: '{@fr.message_with_token} We speak french too!'
};
let parse = function (str) {
    let out = str.replace(/([\r\n"'])/g, "\\$1")
        .replace(TOKEN_REG, function (found, is_sub, lang, path) {
        let l, x;
        if (is_sub) {
            l = lang ? '"' + lang + '"' : 'l';
            x = `_(d["${path}"] || "${path}", d, 0, ${l})`;
        }
        else {
            x = 'd.' + path;
        }
        return '"+' + x + '+"';
    });
    return new Function('_', 'd', 'l', `return ["${out}"];`.replace(/\s?~\s?/g, '","'));
};
let _tmp = new Map, translate = function (key, data, pluralize = 0, lang) {
    let id = `${lang}:${key}`, message = key, format, fn;
    if (_tmp.has(id)) {
        fn = _tmp.get(id);
    }
    else if (LANG_OBJECT[lang] && (format = LANG_OBJECT[lang][key])) {
        _tmp.set(id, fn = parse(format));
    }
    if (fn) {
        let parts = fn(translate, data, lang), len = parts.length, index;
        if (typeof pluralize === 'function') {
            index = pluralize(data, parts);
        }
        else {
            index = pluralize;
        }
        index = Math.max(Math.min(index, len - 1), 0);
        message = parts[index];
    }
    return message;
};
export default class OWebI18n extends OWebEvent {
    constructor() {
        super(...arguments);
        this.defaultLangCode = "en";
    }
    /**
     * Sets default i18n lang code.
     *
     * @param lang The i18n lang code.
     */
    setDefaultLang(lang) {
        if (!LANG_OBJECT[lang]) {
            throw new Error(`[OWebLang] can't set default language, undefined language data for: ${lang}.`);
        }
        this.defaultLangCode = lang;
        return this;
    }
    /**
     * Returns i18n translation.
     *
     * @param key The i18n string key.
     * @param data The data to inject in translation process.
     * @param pluralize
     * @param lang The i18n lang code to use.
     */
    toHuman(key, data = {}, pluralize = 0, lang = this.defaultLangCode) {
        if (typeof key !== 'string') {
            const opt = key;
            return translate(opt.text || '', opt.data || data, opt.pluralize || pluralize, opt.lang || lang);
        }
        return translate(key, data, pluralize, lang);
    }
    /**
     * Sets i18n for HTMLElement
     *
     * @param el
     * @param options
     */
    el(el, options) {
        if (typeof options === 'string') {
            options = { text: options };
        }
        const { nodeName } = el, isInput = (nodeName === 'INPUT' || nodeName === 'TEXTAREA'), { text, placeholder, title, data = {}, lang = this.defaultLangCode, pluralize } = options;
        let str;
        if (text) {
            str = translate(text, data, pluralize, lang);
            if (!isInput) {
                el.innerHTML = str;
            }
            else {
                el.setAttribute("value", str);
            }
        }
        if (isInput && placeholder) {
            str = translate(placeholder, data, pluralize, lang);
            el.setAttribute('placeholder', str);
        }
        if (title) {
            str = translate(title, data, pluralize, lang);
            el.setAttribute('title', str);
        }
    }
    /**
     * Sets the i18n lang data.
     *
     * @param lang The i18n lang code
     * @param data The i18n lang data.
     */
    static loadLangData(lang, data) {
        if (!Utils.isString(lang)) {
            throw new TypeError("[OWebI18n] your lang name should be a valid string.");
        }
        if (!Utils.isPlainObject(data)) {
            throw new TypeError("[OWebI18n] your lang data should be a valid plain object.");
        }
        LANG_OBJECT[lang] = Utils.assign(LANG_OBJECT[lang] || {}, data);
        return this;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkkxOG4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYkkxOG4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLE1BQU0sb0JBQW9CLENBQUM7QUFDdkMsT0FBTyxTQUFTLE1BQU0sa0JBQWtCLENBQUM7QUFnQnpDLE1BQU0sV0FBVyxHQUF1QyxFQUFFLENBQUM7QUFDM0QsTUFBTSxTQUFTLEdBQXlDLHFEQUFxRCxDQUFDLENBQUMsc0NBQXNDO0FBRXJKLE1BQU0sTUFBTSxHQUFHO0lBQ2QsT0FBTyxFQUFpQyxjQUFjO0lBQ3RELGtCQUFrQixFQUFzQixlQUFlO0lBQ3ZELHNCQUFzQixFQUFrQiwyQ0FBMkM7SUFDbkYsd0JBQXdCLEVBQWdCLCtDQUErQztJQUN2RixzQ0FBc0MsRUFBRSwrQ0FBK0M7Q0FDdkYsQ0FBQztBQUVGLElBQUksS0FBSyxHQUFHLFVBQVUsR0FBVztJQUVoQyxJQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxNQUFNLENBQUM7U0FDdkMsT0FBTyxDQUFDLFNBQVMsRUFBRSxVQUFVLEtBQUssRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUk7UUFDdEQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ1QsSUFBSSxNQUFNLEVBQUU7WUFDWCxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO1lBQ2xDLENBQUMsR0FBRyxRQUFRLElBQUksVUFBVSxJQUFJLFlBQVksQ0FBQyxHQUFHLENBQUM7U0FDL0M7YUFBTTtZQUNOLENBQUMsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDO1NBQ2hCO1FBRUQsT0FBTyxJQUFJLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQztJQUN4QixDQUFDLENBQUMsQ0FBQztJQUVQLE9BQU8sSUFBSSxRQUFRLENBQUMsR0FBRyxFQUFF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TSxJQUFJLFNBQVMsQ0FBQyxxREFBcUQsQ0FBQyxDQUFDO1NBQzNFO1FBRUQsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDL0IsTUFBTSxJQUFJLFNBQVMsQ0FBQywyREFBMkQsQ0FBQyxDQUFDO1NBQ2pGO1FBRUQsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVoRSxPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBVdGlscyBmcm9tIFwiLi4vc3JjL3V0aWxzL1V0aWxzXCI7XG5pbXBvcnQgT1dlYkV2ZW50IGZyb20gXCIuLi9zcmMvT1dlYkV2ZW50XCI7XG5cbmV4cG9ydCB0eXBlIHRJMThuRGVmaW5pdGlvbiA9IHsgW2tleTogc3RyaW5nXTogYW55IH07XG5leHBvcnQgdHlwZSB0STE4bkRhdGEgPSB7IFtrZXk6IHN0cmluZ106IGFueSB9O1xuZXhwb3J0IHR5cGUgdEkxOG5PcHRpb25zID0ge1xuXHR0ZXh0Pzogc3RyaW5nLFxuXHRwbGFjZWhvbGRlcj86IHN0cmluZyxcblx0dGl0bGU/OiBzdHJpbmcsXG5cdGxhbmc/OiBzdHJpbmcsXG5cdGRhdGE/OiB0STE4bkRhdGEsXG5cdHBsdXJhbGl6ZT86IHRJMThuUGx1cmFsaXplXG59O1xuZXhwb3J0IHR5cGUgdEkxOG4gPSB0STE4bk9wdGlvbnMgfCBzdHJpbmc7XG5cbmV4cG9ydCB0eXBlIHRJMThuUGx1cmFsaXplID0gbnVtYmVyIHwgKChkYXRhOiB0STE4bkRhdGEsIHBhcnRzOiBzdHJpbmdbXSkgPT4gbnVtYmVyKTtcblxuY29uc3QgTEFOR19PQkpFQ1Q6IHsgW2tleTogc3RyaW5nXTogdEkxOG5EZWZpbml0aW9uIH0gPSB7fTtcbmNvbnN0IFRPS0VOX1JFRyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gL3tcXHMqKEApPyg/OihbYS16LV17Mix9KVxcLik/KFthLXpfXVthLXowLTlfXSopXFxzKn0vaWc7IC8vIHtuYW1lfSB8IHtAbWVzc2FnZX0gfCB7QGZyLm1lc3NhZ2V9XG5cbmNvbnN0IHNhbXBsZSA9IHtcblx0bWVzc2FnZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICdIZWxsbyBXb3JsZCEnLFxuXHRtZXNzYWdlX3dpdGhfdG9rZW4gICAgICAgICAgICAgICAgICAgIDogJ0hlbGxvIHtuYW1lfSEnLFxuXHRtZXNzYWdlX3dpdGhfcGx1cmFsaXplICAgICAgICAgICAgICAgIDogJ29uZSBtZXNzYWdlIH4gdHdvIG1lc3NhZ2VzIH4ge259IG1lc3NhZ2VzJyxcblx0bWVzc2FnZV93aXRoX3N1Yl9tZXNzYWdlICAgICAgICAgICAgICA6ICd7QG1lc3NhZ2Vfd2l0aF90b2tlbn0gV2VsY29tZSB0byBvdXIgd2Vic2l0ZS4nLFxuXHRtZXNzYWdlX3dpdGhfc3ViX21lc3NhZ2Vfc3BlY2lmaWNfbGFuZzogJ3tAZnIubWVzc2FnZV93aXRoX3Rva2VufSBXZSBzcGVhayBmcmVuY2ggdG9vISdcbn07XG5cbmxldCBwYXJzZSA9IGZ1bmN0aW9uIChzdHI6IHN0cmluZykge1xuXG5cdGxldCBvdXQgPSBzdHIucmVwbGFjZSgvKFtcXHJcXG5cIiddKS9nLCBcIlxcXFwkMVwiKVxuXHRcdFx0XHQgLnJlcGxhY2UoVE9LRU5fUkVHLCBmdW5jdGlvbiAoZm91bmQsIGlzX3N1YiwgbGFuZywgcGF0aCkge1xuXHRcdFx0XHRcdCBsZXQgbCwgeDtcblx0XHRcdFx0XHQgaWYgKGlzX3N1Yikge1xuXHRcdFx0XHRcdFx0IGwgPSBsYW5nID8gJ1wiJyArIGxhbmcgKyAnXCInIDogJ2wnO1xuXHRcdFx0XHRcdFx0IHggPSBgXyhkW1wiJHtwYXRofVwiXSB8fCBcIiR7cGF0aH1cIiwgZCwgMCwgJHtsfSlgO1xuXHRcdFx0XHRcdCB9IGVsc2Uge1xuXHRcdFx0XHRcdFx0IHggPSAnZC4nICsgcGF0aDtcblx0XHRcdFx0XHQgfVxuXG5cdFx0XHRcdFx0IHJldHVybiAnXCIrJyArIHggKyAnK1wiJztcblx0XHRcdFx0IH0pO1xuXG5cdHJldHVybiBuZXcgRnVuY3Rpb24oJ18nLCAnZCcsICdsJywgYHJldHVybiBbXCIke291dH1cIl07YC5yZXBsYWNlKC9cXHM/flxccz8vZywgJ1wiLFwiJykpO1xufTtcblxubGV0IF90bXAgICAgICA9IG5ldyBNYXAsXG5cdHRyYW5zbGF0ZSA9IGZ1bmN0aW9uIChrZXk6IHN0cmluZywgZGF0YTogdEkxOG5EYXRhLCBwbHVyYWxpemU6IHRJMThuUGx1cmFsaXplID0gMCwgbGFuZzogc3RyaW5nKTogc3RyaW5nIHtcblx0XHRsZXQgaWQgICAgICA9IGAke2xhbmd9OiR7a2V5fWAsXG5cdFx0XHRtZXNzYWdlID0ga2V5LFxuXHRcdFx0Zm9ybWF0LFxuXHRcdFx0Zm47XG5cblx0XHRpZiAoX3RtcC5oYXMoaWQpKSB7XG5cdFx0XHRmbiA9IF90bXAuZ2V0KGlkKTtcblx0XHR9IGVsc2UgaWYgKExBTkdfT0JKRUNUW2xhbmddICYmIChmb3JtYXQgPSBMQU5HX09CSkVDVFtsYW5nXVtrZXldKSkge1xuXHRcdFx0X3RtcC5zZXQoaWQsIGZuID0gcGFyc2UoZm9ybWF0KSk7XG5cdFx0fVxuXG5cdFx0aWYgKGZuKSB7XG5cdFx0XHRsZXQgcGFydHMgPSBmbih0cmFuc2xhdGUsIGRhdGEsIGxhbmcpLFxuXHRcdFx0XHRsZW4gICA9IHBhcnRzLmxlbmd0aCwgaW5kZXg7XG5cblx0XHRcdGlmICh0eXBlb2YgcGx1cmFsaXplID09PSAnZnVuY3Rpb24nKSB7XG5cdFx0XHRcdGluZGV4ID0gcGx1cmFsaXplKGRhdGEsIHBhcnRzKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGluZGV4ID0gcGx1cmFsaXplO1xuXHRcdFx0fVxuXG5cdFx0XHRpbmRleCAgID0gTWF0aC5tYXgoTWF0aC5taW4oaW5kZXgsIGxlbiAtIDEpLCAwKTtcblx0XHRcdG1lc3NhZ2UgPSBwYXJ0c1tpbmRleF07XG5cdFx0fVxuXG5cdFx0cmV0dXJuIG1lc3NhZ2U7XG5cdH07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJJMThuIGV4dGVuZHMgT1dlYkV2ZW50IHtcblx0ZGVmYXVsdExhbmdDb2RlOiBzdHJpbmcgPSBcImVuXCI7XG5cblx0LyoqXG5cdCAqIFNldHMgZGVmYXVsdCBpMThuIGxhbmcgY29kZS5cblx0ICpcblx0ICogQHBhcmFtIGxhbmcgVGhlIGkxOG4gbGFuZyBjb2RlLlxuXHQgKi9cblx0c2V0RGVmYXVsdExhbmcobGFuZzogc3RyaW5nKSB7XG5cblx0XHRpZiAoIUxBTkdfT0JKRUNUW2xhbmddKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYFtPV2ViTGFuZ10gY2FuJ3Qgc2V0IGRlZmF1bHQgbGFuZ3VhZ2UsIHVuZGVmaW5lZCBsYW5ndWFnZSBkYXRhIGZvcjogJHtsYW5nfS5gKVxuXHRcdH1cblxuXHRcdHRoaXMuZGVmYXVsdExhbmdDb2RlID0gbGFuZztcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG5cblx0LyoqXG5cdCAqIFJldHVybnMgaTE4biB0cmFuc2xhdGlvbi5cblx0ICpcblx0ICogQHBhcmFtIGtleSBUaGUgaTE4biBzdHJpbmcga2V5LlxuXHQgKiBAcGFyYW0gZGF0YSBUaGUgZGF0YSB0byBpbmplY3QgaW4gdHJhbnNsYXRpb24gcHJvY2Vzcy5cblx0ICogQHBhcmFtIHBsdXJhbGl6ZVxuXHQgKiBAcGFyYW0gbGFuZyBUaGUgaTE4biBsYW5nIGNvZGUgdG8gdXNlLlxuXHQgKi9cblx0dG9IdW1hbihrZXk6IHRJMThuLCBkYXRhOiB0STE4bkRhdGEgPSB7fSwgcGx1cmFsaXplOiB0STE4blBsdXJhbGl6ZSA9IDAsIGxhbmc6IHN0cmluZyA9IHRoaXMuZGVmYXVsdExhbmdDb2RlKTogc3RyaW5nIHtcblx0XHRpZiAodHlwZW9mIGtleSAhPT0gJ3N0cmluZycpIHtcblx0XHRcdGNvbnN0IG9wdDogdEkxOG5PcHRpb25zID0ga2V5IGFzIGFueTtcblx0XHRcdHJldHVybiB0cmFuc2xhdGUob3B0LnRleHQgfHwgJycsIG9wdC5kYXRhIHx8IGRhdGEsIG9wdC5wbHVyYWxpemUgfHwgcGx1cmFsaXplLCBvcHQubGFuZyB8fCBsYW5nKVxuXHRcdH1cblxuXHRcdHJldHVybiB0cmFuc2xhdGUoa2V5LCBkYXRhLCBwbHVyYWxpemUsIGxhbmcpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFNldHMgaTE4biBmb3IgSFRNTEVsZW1lbnRcblx0ICpcblx0ICogQHBhcmFtIGVsXG5cdCAqIEBwYXJhbSBvcHRpb25zXG5cdCAqL1xuXHRlbChlbDogSFRNTEVsZW1lbnQsIG9wdGlvbnM6IHRJMThuKSB7XG5cblx0XHRpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7XG5cdFx0XHRvcHRpb25zID0ge3RleHQ6IG9wdGlvbnN9O1xuXHRcdH1cblxuXHRcdGNvbnN0IHtub2RlTmFtZX0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gZWwsXG5cdFx0XHQgIGlzSW5wdXQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gKG5vZGVOYW1lID09PSAnSU5QVVQnIHx8IG5vZGVOYW1lID09PSAnVEVYVEFSRUEnKSxcblx0XHRcdCAge3RleHQsIHBsYWNlaG9sZGVyLCB0aXRsZSwgZGF0YSA9IHt9LCBsYW5nID0gdGhpcy5kZWZhdWx0TGFuZ0NvZGUsIHBsdXJhbGl6ZX0gPSBvcHRpb25zO1xuXHRcdGxldCBzdHI7XG5cblx0XHRpZiAodGV4dCkge1xuXHRcdFx0c3RyID0gdHJhbnNsYXRlKHRleHQsIGRhdGEsIHBsdXJhbGl6ZSwgbGFuZyk7XG5cdFx0XHRpZiAoIWlzSW5wdXQpIHtcblx0XHRcdFx0ZWwuaW5uZXJIVE1MID0gc3RyO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0ZWwuc2V0QXR0cmlidXRlKFwidmFsdWVcIiwgc3RyKTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHRpZiAoaXNJbnB1dCAmJiBwbGFjZWhvbGRlcikge1xuXHRcdFx0c3RyID0gdHJhbnNsYXRlKHBsYWNlaG9sZGVyLCBkYXRhLCBwbHVyYWxpemUsIGxhbmcpO1xuXHRcdFx0ZWwuc2V0QXR0cmlidXRlKCdwbGFjZWhvbGRlcicsIHN0cik7XG5cdFx0fVxuXG5cdFx0aWYgKHRpdGxlKSB7XG5cdFx0XHRzdHIgPSB0cmFuc2xhdGUodGl0bGUsIGRhdGEsIHBsdXJhbGl6ZSwgbGFuZyk7XG5cdFx0XHRlbC5zZXRBdHRyaWJ1dGUoJ3RpdGxlJywgc3RyKTtcblx0XHR9XG5cdH1cblxuXHQvKipcblx0ICogU2V0cyB0aGUgaTE4biBsYW5nIGRhdGEuXG5cdCAqXG5cdCAqIEBwYXJhbSBsYW5nIFRoZSBpMThuIGxhbmcgY29kZVxuXHQgKiBAcGFyYW0gZGF0YSBUaGUgaTE4biBsYW5nIGRhdGEuXG5cdCAqL1xuXHRzdGF0aWMgbG9hZExhbmdEYXRhKGxhbmc6IHN0cmluZywgZGF0YTogdEkxOG5EZWZpbml0aW9uKSB7XG5cblx0XHRpZiAoIVV0aWxzLmlzU3RyaW5nKGxhbmcpKSB7XG5cdFx0XHR0aHJvdyBuZXcgVHlwZUVycm9yKFwiW09XZWJJMThuXSB5b3VyIGxhbmcgbmFtZSBzaG91bGQgYmUgYSB2YWxpZCBzdHJpbmcuXCIpO1xuXHRcdH1cblxuXHRcdGlmICghVXRpbHMuaXNQbGFpbk9iamVjdChkYXRhKSkge1xuXHRcdFx0dGhyb3cgbmV3IFR5cGVFcnJvcihcIltPV2ViSTE4bl0geW91ciBsYW5nIGRhdGEgc2hvdWxkIGJlIGEgdmFsaWQgcGxhaW4gb2JqZWN0LlwiKTtcblx0XHR9XG5cblx0XHRMQU5HX09CSkVDVFtsYW5nXSA9IFV0aWxzLmFzc2lnbihMQU5HX09CSkVDVFtsYW5nXSB8fCB7fSwgZGF0YSk7XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxufVxuIl19