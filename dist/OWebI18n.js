import Utils from "../src/utils/Utils";
import OWebEvent from "../src/OWebEvent";
const LANG_OBJECT = {};
const token_with_filter = /{\s*(@)?(?:([a-z-]{2,})\.)?([a-z_][a-z0-9_]*)\s*}/; // {name} | {@message} | {@fr.message}
const sample = {
    message: 'Hello World!',
    message_with_token: 'Hello {name}!',
    message_with_pluralize: 'one message ~ two messages ~ {n} messages',
    message_with_sub_message: '{@message_with_token} Welcome to our website.',
    message_with_sub_message_specific_lang: '{@fr.message_with_token} We speak french too!'
};
let parse = function (str) {
    let out = str.replace(/([\r\n"'])/g, "\\$1")
        .replace(token_with_filter, function (found, is_sub, lang, path) {
        let l, x;
        if (is_sub) {
            l = lang ? '"' + lang + '"' : 'l';
            x = `_("${path}", d, ${l})`;
        }
        else {
            x = 'd.' + path;
        }
        return '"+' + x + '+"';
    });
    return new Function('_', 'd', 'l', `return ["${out}"];`.replace(/\s?~\s?/g, '","'));
};
let _tmp = new Map, translate = function (lang_key, data, pluralize = 0, lang) {
    let key = lang + "." + lang_key, message = "undefined", fn;
    if (_tmp.has(key)) {
        fn = _tmp.get(key);
    }
    else if (LANG_OBJECT[lang] && (message = LANG_OBJECT[lang][lang_key])) {
        _tmp.set(key, fn = parse(message));
    }
    if (fn) {
        let parts = fn(translate, data, lang), len = parts.length, index;
        if (typeof pluralize === 'function') {
            index = pluralize(parts);
        }
        else {
            index = pluralize;
        }
        index = Math.max(Math.min(index, len - 1), 0);
        message = parts[index];
    }
    return message;
};
export default class OWebI18n extends OWebEvent {
    /**
     * @param app_context The app context.
     */
    constructor(app_context) {
        super();
        this.app_context = app_context;
        this.defaultLangCode = "en";
    }
    /**
     * Sets default i18n lang code.
     *
     * @param lang The i18n lang code.
     */
    setDefaultLang(lang) {
        if (!LANG_OBJECT[lang]) {
            throw new Error(`[OWebLang] can't set default language, undefined language data for: ${lang}.`);
        }
        this.defaultLangCode = lang;
        return this;
    }
    /**
     * Returns i18n translation.
     *
     * @param key The i18n string key.
     * @param data The data to inject in translation process.
     * @param pluralize
     * @param lang The i18n lang code to use.
     */
    toHuman(key, data = {}, pluralize = 0, lang = this.defaultLangCode) {
        return translate(key, data, pluralize, lang);
    }
    /**
     * Sets i18n for HTMLElement
     *
     * @param el
     * @param options
     */
    el(el, options) {
        if (typeof options === 'string') {
            options = { text: options };
        }
        const { nodeName } = el, isInput = (nodeName === 'INPUT' || nodeName === 'TEXTAREA'), { text, placeholder, title, data = {}, lang = this.defaultLangCode, pluralize } = options;
        let str;
        if (text) {
            str = translate(text, data, pluralize, lang);
            if (!isInput) {
                el.innerHTML = str;
            }
            else {
                el.setAttribute("value", str);
            }
        }
        if (isInput && placeholder) {
            str = translate(placeholder, data, pluralize, lang);
            el.setAttribute('placeholder', str);
        }
        if (title) {
            str = translate(title, data, pluralize, lang);
            el.setAttribute('title', str);
        }
    }
    /**
     * Sets the i18n lang data.
     *
     * @param lang The i18n lang code
     * @param data The i18n lang data.
     */
    static loadLangData(lang, data) {
        if (!Utils.isString(lang)) {
            throw new TypeError("[OWebI18n] your lang name should be a valid string.");
        }
        if (!Utils.isPlainObject(data)) {
            throw new TypeError("[OWebI18n] your lang data should be a valid plain object.");
        }
        LANG_OBJECT[lang] = Utils.assign(LANG_OBJECT[lang] || {}, data);
        return this;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkkxOG4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYkkxOG4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLE1BQU0sb0JBQW9CLENBQUM7QUFDdkMsT0FBTyxTQUFTLE1BQU0sa0JBQWtCLENBQUM7QUFlekMsTUFBTSxXQUFXLEdBQXVDLEVBQUUsQ0FBQztBQUMzRCxNQUFNLGlCQUFpQixHQUFpQyxtREFBbUQsQ0FBQyxDQUFDLHNDQUFzQztBQUVuSixNQUFNLE1BQU0sR0FBRztJQUNkLE9BQU8sRUFBaUMsY0FBYztJQUN0RCxrQkFBa0IsRUFBc0IsZUFBZTtJQUN2RCxzQkFBc0IsRUFBa0IsMkNBQTJDO0lBQ25GLHdCQUF3QixFQUFnQiwrQ0FBK0M7SUFDdkYsc0NBQXNDLEVBQUUsK0NBQStDO0NBQ3ZGLENBQUM7QUFFRixJQUFJLEtBQUssR0FBRyxVQUFVLEdBQVc7SUFFaEMsSUFBSSxHQUFHLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsTUFBTSxDQUFDO1NBQ3ZDLE9BQU8sQ0FBQyxpQkFBaUIsRUFBRSxVQUFVLEtBQUssRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUk7UUFDOUQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ1QsSUFBSSxNQUFNLEVBQUU7WUFDWCxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO1lBQ2xDLENBQUMsR0FBRyxNQUFNLElBQUksU0FBUyxDQUFDLEdBQUcsQ0FBQztTQUM1QjthQUFNO1lBQ04sQ0FBQyxHQUFHLElBQUksR0FBRyxJQUFJLENBQUM7U0FDaEI7UUFFRCxPQUFPLElBQUksR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDO0lBQ3hCLENBQUMsQ0FBQyxDQUFDO0lBRVAsT0FBTyxJQUFJLFFBQVEsQ0FBQyxHQUFHLEVBQUUsR0FBRyxF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TUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFaEUsT0FBTyxJQUFJLENBQUM7SUFDYixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgVXRpbHMgZnJvbSBcIi4uL3NyYy91dGlscy9VdGlsc1wiO1xuaW1wb3J0IE9XZWJFdmVudCBmcm9tIFwiLi4vc3JjL09XZWJFdmVudFwiO1xuaW1wb3J0IE9XZWJBcHAgZnJvbSBcIi4uL3NyYy9PV2ViQXBwXCI7XG5cbmV4cG9ydCB0eXBlIHRJMThuRGVmaW5pdGlvbiA9IHsgW2tleTogc3RyaW5nXTogYW55IH07XG5leHBvcnQgdHlwZSB0STE4bkRhdGEgPSB7IFtrZXk6IHN0cmluZ106IGFueSB9O1xuZXhwb3J0IHR5cGUgdEkxOG5PcHRpb25zID0ge1xuXHR0ZXh0Pzogc3RyaW5nLFxuXHRwbGFjZWhvbGRlcj86IHN0cmluZyxcblx0dGl0bGU/OiBzdHJpbmcsXG5cdGxhbmc/OiBzdHJpbmcsXG5cdGRhdGE/OiB0STE4bkRhdGEsXG5cdHBsdXJhbGl6ZT86IHRJMThuUGx1cmFsaXplXG59O1xuZXhwb3J0IHR5cGUgdEkxOG5QbHVyYWxpemUgPSBudW1iZXIgfCAoKHBhcnRzOiBzdHJpbmdbXSkgPT4gbnVtYmVyKTtcblxuY29uc3QgTEFOR19PQkpFQ1Q6IHsgW2tleTogc3RyaW5nXTogdEkxOG5EZWZpbml0aW9uIH0gPSB7fTtcbmNvbnN0IHRva2VuX3dpdGhfZmlsdGVyICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gL3tcXHMqKEApPyg/OihbYS16LV17Mix9KVxcLik/KFthLXpfXVthLXowLTlfXSopXFxzKn0vOyAvLyB7bmFtZX0gfCB7QG1lc3NhZ2V9IHwge0Bmci5tZXNzYWdlfVxuXG5jb25zdCBzYW1wbGUgPSB7XG5cdG1lc3NhZ2UgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnSGVsbG8gV29ybGQhJyxcblx0bWVzc2FnZV93aXRoX3Rva2VuICAgICAgICAgICAgICAgICAgICA6ICdIZWxsbyB7bmFtZX0hJyxcblx0bWVzc2FnZV93aXRoX3BsdXJhbGl6ZSAgICAgICAgICAgICAgICA6ICdvbmUgbWVzc2FnZSB+IHR3byBtZXNzYWdlcyB+IHtufSBtZXNzYWdlcycsXG5cdG1lc3NhZ2Vfd2l0aF9zdWJfbWVzc2FnZSAgICAgICAgICAgICAgOiAne0BtZXNzYWdlX3dpdGhfdG9rZW59IFdlbGNvbWUgdG8gb3VyIHdlYnNpdGUuJyxcblx0bWVzc2FnZV93aXRoX3N1Yl9tZXNzYWdlX3NwZWNpZmljX2xhbmc6ICd7QGZyLm1lc3NhZ2Vfd2l0aF90b2tlbn0gV2Ugc3BlYWsgZnJlbmNoIHRvbyEnXG59O1xuXG5sZXQgcGFyc2UgPSBmdW5jdGlvbiAoc3RyOiBzdHJpbmcpIHtcblxuXHRsZXQgb3V0ID0gc3RyLnJlcGxhY2UoLyhbXFxyXFxuXCInXSkvZywgXCJcXFxcJDFcIilcblx0XHRcdFx0IC5yZXBsYWNlKHRva2VuX3dpdGhfZmlsdGVyLCBmdW5jdGlvbiAoZm91bmQsIGlzX3N1YiwgbGFuZywgcGF0aCkge1xuXHRcdFx0XHRcdCBsZXQgbCwgeDtcblx0XHRcdFx0XHQgaWYgKGlzX3N1Yikge1xuXHRcdFx0XHRcdFx0IGwgPSBsYW5nID8gJ1wiJyArIGxhbmcgKyAnXCInIDogJ2wnO1xuXHRcdFx0XHRcdFx0IHggPSBgXyhcIiR7cGF0aH1cIiwgZCwgJHtsfSlgO1xuXHRcdFx0XHRcdCB9IGVsc2Uge1xuXHRcdFx0XHRcdFx0IHggPSAnZC4nICsgcGF0aDtcblx0XHRcdFx0XHQgfVxuXG5cdFx0XHRcdFx0IHJldHVybiAnXCIrJyArIHggKyAnK1wiJztcblx0XHRcdFx0IH0pO1xuXG5cdHJldHVybiBuZXcgRnVuY3Rpb24oJ18nLCAnZCcsICdsJywgYHJldHVybiBbXCIke291dH1cIl07YC5yZXBsYWNlKC9cXHM/flxccz8vZywgJ1wiLFwiJykpO1xufTtcblxubGV0IF90bXAgICAgICA9IG5ldyBNYXAsXG5cdHRyYW5zbGF0ZSA9IGZ1bmN0aW9uIChsYW5nX2tleTogc3RyaW5nLCBkYXRhOiB0STE4bkRhdGEsIHBsdXJhbGl6ZTogdEkxOG5QbHVyYWxpemUgPSAwLCBsYW5nOiBzdHJpbmcpOiBzdHJpbmcge1xuXG5cdFx0bGV0IGtleSAgICAgPSBsYW5nICsgXCIuXCIgKyBsYW5nX2tleSxcblx0XHRcdG1lc3NhZ2UgPSBcInVuZGVmaW5lZFwiLFxuXHRcdFx0Zm47XG5cblx0XHRpZiAoX3RtcC5oYXMoa2V5KSkge1xuXHRcdFx0Zm4gPSBfdG1wLmdldChrZXkpO1xuXHRcdH0gZWxzZSBpZiAoTEFOR19PQkpFQ1RbbGFuZ10gJiYgKG1lc3NhZ2UgPSBMQU5HX09CSkVDVFtsYW5nXVtsYW5nX2tleV0pKSB7XG5cdFx0XHRfdG1wLnNldChrZXksIGZuID0gcGFyc2UobWVzc2FnZSkpO1xuXHRcdH1cblxuXHRcdGlmIChmbikge1xuXHRcdFx0bGV0IHBhcnRzID0gZm4odHJhbnNsYXRlLCBkYXRhLCBsYW5nKSxcblx0XHRcdFx0bGVuICAgPSBwYXJ0cy5sZW5ndGgsIGluZGV4O1xuXG5cdFx0XHRpZiAodHlwZW9mIHBsdXJhbGl6ZSA9PT0gJ2Z1bmN0aW9uJykge1xuXHRcdFx0XHRpbmRleCA9IHBsdXJhbGl6ZShwYXJ0cyk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRpbmRleCA9IHBsdXJhbGl6ZTtcblx0XHRcdH1cblxuXHRcdFx0aW5kZXggICA9IE1hdGgubWF4KE1hdGgubWluKGluZGV4LCBsZW4gLSAxKSwgMCk7XG5cdFx0XHRtZXNzYWdlID0gcGFydHNbaW5kZXhdO1xuXHRcdH1cblxuXHRcdHJldHVybiBtZXNzYWdlO1xuXHR9O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViSTE4biBleHRlbmRzIE9XZWJFdmVudCB7XG5cdGRlZmF1bHRMYW5nQ29kZTogc3RyaW5nID0gXCJlblwiO1xuXG5cdC8qKlxuXHQgKiBAcGFyYW0gYXBwX2NvbnRleHQgVGhlIGFwcCBjb250ZXh0LlxuXHQgKi9cblx0Y29uc3RydWN0b3IocHJpdmF0ZSBhcHBfY29udGV4dDogT1dlYkFwcCkge1xuXHRcdHN1cGVyKCk7XG5cdH1cblxuXHQvKipcblx0ICogU2V0cyBkZWZhdWx0IGkxOG4gbGFuZyBjb2RlLlxuXHQgKlxuXHQgKiBAcGFyYW0gbGFuZyBUaGUgaTE4biBsYW5nIGNvZGUuXG5cdCAqL1xuXHRzZXREZWZhdWx0TGFuZyhsYW5nOiBzdHJpbmcpIHtcblxuXHRcdGlmICghTEFOR19PQkpFQ1RbbGFuZ10pIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihgW09XZWJMYW5nXSBjYW4ndCBzZXQgZGVmYXVsdCBsYW5ndWFnZSwgdW5kZWZpbmVkIGxhbmd1YWdlIGRhdGEgZm9yOiAke2xhbmd9LmApXG5cdFx0fVxuXG5cdFx0dGhpcy5kZWZhdWx0TGFuZ0NvZGUgPSBsYW5nO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyBpMThuIHRyYW5zbGF0aW9uLlxuXHQgKlxuXHQgKiBAcGFyYW0ga2V5IFRoZSBpMThuIHN0cmluZyBrZXkuXG5cdCAqIEBwYXJhbSBkYXRhIFRoZSBkYXRhIHRvIGluamVjdCBpbiB0cmFuc2xhdGlvbiBwcm9jZXNzLlxuXHQgKiBAcGFyYW0gcGx1cmFsaXplXG5cdCAqIEBwYXJhbSBsYW5nIFRoZSBpMThuIGxhbmcgY29kZSB0byB1c2UuXG5cdCAqL1xuXHR0b0h1bWFuKGtleTogc3RyaW5nLCBkYXRhOiB0STE4bkRhdGEgPSB7fSwgcGx1cmFsaXplOiB0STE4blBsdXJhbGl6ZSA9IDAsIGxhbmc6IHN0cmluZyA9IHRoaXMuZGVmYXVsdExhbmdDb2RlKTogc3RyaW5nIHtcblx0XHRyZXR1cm4gdHJhbnNsYXRlKGtleSwgZGF0YSwgcGx1cmFsaXplLCBsYW5nKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBTZXRzIGkxOG4gZm9yIEhUTUxFbGVtZW50XG5cdCAqXG5cdCAqIEBwYXJhbSBlbFxuXHQgKiBAcGFyYW0gb3B0aW9uc1xuXHQgKi9cblx0ZWwoZWw6IEhUTUxFbGVtZW50LCBvcHRpb25zOiB0STE4bk9wdGlvbnMgfCBzdHJpbmcpIHtcblxuXHRcdGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHtcblx0XHRcdG9wdGlvbnMgPSB7dGV4dDogb3B0aW9uc307XG5cdFx0fVxuXG5cdFx0Y29uc3Qge25vZGVOYW1lfSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBlbCxcblx0XHRcdCAgaXNJbnB1dCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSAobm9kZU5hbWUgPT09ICdJTlBVVCcgfHwgbm9kZU5hbWUgPT09ICdURVhUQVJFQScpLFxuXHRcdFx0ICB7dGV4dCwgcGxhY2Vob2xkZXIsIHRpdGxlLCBkYXRhID0ge30sIGxhbmcgPSB0aGlzLmRlZmF1bHRMYW5nQ29kZSwgcGx1cmFsaXplfSA9IG9wdGlvbnM7XG5cdFx0bGV0IHN0cjtcblxuXHRcdGlmICh0ZXh0KSB7XG5cdFx0XHRzdHIgPSB0cmFuc2xhdGUodGV4dCwgZGF0YSwgcGx1cmFsaXplLCBsYW5nKTtcblx0XHRcdGlmICghaXNJbnB1dCkge1xuXHRcdFx0XHRlbC5pbm5lckhUTUwgPSBzdHI7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRlbC5zZXRBdHRyaWJ1dGUoXCJ2YWx1ZVwiLCBzdHIpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGlmIChpc0lucHV0ICYmIHBsYWNlaG9sZGVyKSB7XG5cdFx0XHRzdHIgPSB0cmFuc2xhdGUocGxhY2Vob2xkZXIsIGRhdGEsIHBsdXJhbGl6ZSwgbGFuZyk7XG5cdFx0XHRlbC5zZXRBdHRyaWJ1dGUoJ3BsYWNlaG9sZGVyJywgc3RyKTtcblx0XHR9XG5cblx0XHRpZiAodGl0bGUpIHtcblx0XHRcdHN0ciA9IHRyYW5zbGF0ZSh0aXRsZSwgZGF0YSwgcGx1cmFsaXplLCBsYW5nKTtcblx0XHRcdGVsLnNldEF0dHJpYnV0ZSgndGl0bGUnLCBzdHIpO1xuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBTZXRzIHRoZSBpMThuIGxhbmcgZGF0YS5cblx0ICpcblx0ICogQHBhcmFtIGxhbmcgVGhlIGkxOG4gbGFuZyBjb2RlXG5cdCAqIEBwYXJhbSBkYXRhIFRoZSBpMThuIGxhbmcgZGF0YS5cblx0ICovXG5cdHN0YXRpYyBsb2FkTGFuZ0RhdGEobGFuZzogc3RyaW5nLCBkYXRhOiB0STE4bkRlZmluaXRpb24pIHtcblxuXHRcdGlmICghVXRpbHMuaXNTdHJpbmcobGFuZykpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoXCJbT1dlYkkxOG5dIHlvdXIgbGFuZyBuYW1lIHNob3VsZCBiZSBhIHZhbGlkIHN0cmluZy5cIik7XG5cdFx0fVxuXG5cdFx0aWYgKCFVdGlscy5pc1BsYWluT2JqZWN0KGRhdGEpKSB7XG5cdFx0XHR0aHJvdyBuZXcgVHlwZUVycm9yKFwiW09XZWJJMThuXSB5b3VyIGxhbmcgZGF0YSBzaG91bGQgYmUgYSB2YWxpZCBwbGFpbiBvYmplY3QuXCIpO1xuXHRcdH1cblxuXHRcdExBTkdfT0JKRUNUW2xhbmddID0gVXRpbHMuYXNzaWduKExBTkdfT0JKRUNUW2xhbmddIHx8IHt9LCBkYXRhKTtcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG59Il19