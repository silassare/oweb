import OWebEvent from './OWebEvent';
import { assign, isPlainObject, isString } from './utils';
const LANG_OBJECT = {};
const TOKEN_REG = /{\s*(@)?(?:([a-z-]{2,}):)?([a-z_][a-z0-9_]*(?:\.[a-z_][a-z0-9_]*)*)\s*}/gi;
const parse = function parser(str) {
    const out = str
        .replace(/([\r\n"'])/g, '\\$1')
        .replace(TOKEN_REG, function stringChunkReplacer(_found, isSub, lang, path) {
        let l, x;
        if (isSub) {
            l = lang ? '"' + lang + '"' : 'l';
            x = `_(d["${path}"] || "${path}", d, 0, ${l})`;
        }
        else {
            x = 'd.' + path;
        }
        return '"+' + x + '+"';
    });
    return new Function('_', 'd', 'l', `return ["${out}"];`.replace(/\s?~\s?/g, '","'));
};
const getKey = function getKey(key, langData) {
    const parts = (key || '').split('.');
    let message = langData;
    for (let i = 0; i < parts.length; i++) {
        if (message === undefined || message === null) {
            return undefined;
        }
        message = message[parts[i]] || undefined;
    }
    return message;
};
const _tmp = new Map(), translate = function translate(key, data, pluralize = 0, lang) {
    const id = `${lang}:${key}`;
    let message = key, format, fn;
    if (_tmp.has(id)) {
        fn = _tmp.get(id);
    }
    else if (LANG_OBJECT[lang] && (format = getKey(key, LANG_OBJECT[lang]))) {
        _tmp.set(id, (fn = parse(format)));
    }
    if (fn) {
        const parts = fn(translate, data, lang), len = parts.length;
        let index;
        if (typeof pluralize === 'function') {
            index = pluralize(data, parts);
        }
        else {
            index = pluralize;
        }
        index = Math.max(Math.min(index, len - 1), 0);
        message = parts[index];
    }
    return message;
};
export default class OWebI18n extends OWebEvent {
    defaultLangCode = 'en';
    setDefaultLang(lang) {
        if (!LANG_OBJECT[lang]) {
            throw new Error(`[OWebLang] can't set default language, undefined language data for: ${lang}.`);
        }
        this.defaultLangCode = lang;
        return this;
    }
    toHuman(key, data = {}, pluralize = 0, lang = this.defaultLangCode) {
        if (typeof key !== 'string') {
            const opt = key;
            return translate(opt.text || '', opt.data || data, opt.pluralize || pluralize, opt.lang || lang);
        }
        return translate(key, data, pluralize, lang);
    }
    el(el, options) {
        if (typeof options === 'string') {
            options = { text: options };
        }
        const { nodeName } = el, isInput = nodeName === 'INPUT' || nodeName === 'TEXTAREA', { text, placeholder, title, data = {}, lang = this.defaultLangCode, pluralize, } = options;
        let str;
        if (text) {
            str = translate(text, data, pluralize, lang);
            if (!isInput) {
                el.innerHTML = str;
            }
            else {
                el.setAttribute('value', str);
            }
        }
        if (isInput && placeholder) {
            str = translate(placeholder, data, pluralize, lang);
            el.setAttribute('placeholder', str);
        }
        if (title) {
            str = translate(title, data, pluralize, lang);
            el.setAttribute('title', str);
        }
    }
    static loadLangData(lang, data) {
        if (!isString(lang)) {
            throw new TypeError('[OWebI18n] your lang name should be a valid string.');
        }
        if (!isPlainObject(data)) {
            throw new TypeError('[OWebI18n] your lang data should be a valid plain object.');
        }
        LANG_OBJECT[lang] = assign(LANG_OBJECT[lang] || {}, data);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkkxOG4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYkkxOG4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxTQUFTLE1BQU0sYUFBYSxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxNQUFNLEVBQUUsYUFBYSxFQUFFLFFBQVEsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQTJCMUQsTUFBTSxXQUFXLEdBQXVDLEVBQUUsQ0FBQztBQUUzRCxNQUFNLFNBQVMsR0FDZCwyRUFBMkUsQ0FBQztBQWtCN0UsTUFBTSxLQUFLLEdBQUcsU0FBUyxNQUFNLENBQUMsR0FBVztJQUN4QyxNQUFNLEdBQUcsR0FBRyxHQUFHO1NBQ2IsT0FBTyxDQUFDLGFBQWEsRUFBRSxNQUFNLENBQUM7U0FDOUIsT0FBTyxDQUNQLFNBQVMsRUFDVCxTQUFTLG1CQUFtQixDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUk7UUFDckQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ1QsSUFBSSxLQUFLLEVBQUU7WUFDVixDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO1lBQ2xDLENBQUMsR0FBRyxRQUFRLElBQUksVUFBVSxJQUFJLFlBQVksQ0FBQyxHQUFHLENBQUM7U0FDL0M7YUFBTTtZQUNOLENBQUMsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDO1NBQ2hCO1FBRUQsT0FBTyxJQUFJLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQztJQUN4QixDQUFDLENBQ0QsQ0FBQztJQUVILE9BQU8sSUFBSSxRQUFRLENBQ2xCLEdBQUcsRUFDSCxHQUFHLEVBQ0gsR0FBRyxFQUNILFlBQVksR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsQ0FDL0MsQ0FBQztBQUNILENBQUMsQ0FBQztBQUNGLE1BQU0sTUFBTSxHQUFH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RSxHQUFHLENBQUMsQ0FBQztTQUNwQztRQUVELElBQUksS0FBSyxFQUFFO1lBQ1YsR0FBRyxHQUFHLFNBQVMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUM5QyxFQUFFLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQztTQUM5QjtJQUNGLENBQUM7SUFRRCxNQUFNLENBQUMsWUFBWSxDQUFDLElBQVksRUFBRSxJQUFxQjtRQUN0RCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3BCLE1BQU0sSUFBSSxTQUFTLENBQ2xCLHFEQUFxRCxDQUNyRCxDQUFDO1NBQ0Y7UUFFRCxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ3pCLE1BQU0sSUFBSSxTQUFTLENBQ2xCLDJEQUEyRCxDQUMzRCxDQUFDO1NBQ0Y7UUFFRCxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDM0QsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IE9XZWJFdmVudCBmcm9tICcuL09XZWJFdmVudCc7XG5pbXBvcnQgeyBhc3NpZ24sIGlzUGxhaW5PYmplY3QsIGlzU3RyaW5nIH0gZnJvbSAnLi91dGlscyc7XG5cbmV4cG9ydCB0eXBlIE9JMThuRGVmaW5pdGlvbiA9IHsgW2tleTogc3RyaW5nXTogYW55IH07XG5leHBvcnQgdHlwZSBPSTE4bkRhdGEgPSB7IFtrZXk6IHN0cmluZ106IGFueSB9O1xuZXhwb3J0IHR5cGUgT0kxOG5PcHRpb25zID0ge1xuXHR0ZXh0Pzogc3RyaW5nO1xuXHRsYW5nPzogc3RyaW5nO1xuXHRkYXRhPzogT0kxOG5EYXRhO1xuXHRwbHVyYWxpemU/OiBPSTE4blBsdXJhbGl6ZTtcbn07XG5leHBvcnQgdHlwZSBPSTE4biA9IE9JMThuT3B0aW9ucyB8IHN0cmluZztcblxuZXhwb3J0IHR5cGUgT0kxOG5FbGVtZW50ID1cblx0fCBzdHJpbmdcblx0fCB7XG5cdFx0XHR0ZXh0Pzogc3RyaW5nO1xuXHRcdFx0cGxhY2Vob2xkZXI/OiBzdHJpbmc7XG5cdFx0XHR0aXRsZT86IHN0cmluZztcblx0XHRcdGxhbmc/OiBzdHJpbmc7XG5cdFx0XHRkYXRhPzogT0kxOG5EYXRhO1xuXHRcdFx0cGx1cmFsaXplPzogT0kxOG5QbHVyYWxpemU7XG5cdCAgfTtcblxuZXhwb3J0IHR5cGUgT0kxOG5QbHVyYWxpemUgPVxuXHR8IG51bWJlclxuXHR8ICgoZGF0YTogT0kxOG5EYXRhLCBwYXJ0czogc3RyaW5nW10pID0+IG51bWJlcik7XG5cbmNvbnN0IExBTkdfT0JKRUNUOiB7IFtrZXk6IHN0cmluZ106IE9JMThuRGVmaW5pdGlvbiB9ID0ge307XG4vLyB7bmFtZX0gfCB7QG1lc3NhZ2V9IHwge0BhcHAubmFtZX0gfCB7QGZyOm1lc3NhZ2V9IHwge0BmcjphcHAubmFtZX1cbmNvbnN0IFRPS0VOX1JFRyA9XG5cdC97XFxzKihAKT8oPzooW2Etei1dezIsfSk6KT8oW2Etel9dW2EtejAtOV9dKig/OlxcLlthLXpfXVthLXowLTlfXSopKilcXHMqfS9naTtcblxuLyoqXG4gKiBgYGBqc1xuICpcbiAqIGNvbnN0IHNhbXBsZXMgPSB7XG4gKiAgbWVzc2FnZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICdIZWxsbyBXb3JsZCEnLFxuICogIG1lc3NhZ2Vfd2l0aF90b2tlbiAgICAgICAgICAgICAgICAgICAgOiAnSGVsbG8ge25hbWV9IScsXG4gKiAgbWVzc2FnZV93aXRoX3BsdXJhbGl6ZSAgICAgICAgICAgICAgICA6ICdvbmUgbWVzc2FnZSB+IHR3byBtZXNzYWdlcyB+IHtufSBtZXNzYWdlcycsXG4gKiAgbWVzc2FnZV93aXRoX3N1Yl9tZXNzYWdlICAgICAgICAgICAgICA6ICd7QG1lc3NhZ2Vfd2l0aF90b2tlbn0gV2VsY29tZSB0byBvdXIgd2Vic2l0ZS4nLFxuICogIG1lc3NhZ2Vfd2l0aF9zdWJfbWVzc2FnZV9kZWVwICAgICAgICAgOiAnQXBwIG5hbWUgaXM6IHtAYXBwLm5hbWV9LicsXG4gKiAgbWVzc2FnZV93aXRoX3N1Yl9tZXNzYWdlX3NwZWNpZmljX2xhbmc6ICd7QGZyOm1lc3NhZ2Vfd2l0aF90b2tlbn0gV2Ugc3BlYWsgZnJlbmNoIHRvbyEnLFxuICogIGFwcCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB7XG4gKiBcdFx0bmFtZTogJ01hZ2ljQXBwJ1xuICogXHR9XG4gKiB9O1xuICogYGBgXG4gKi9cbmNvbnN0IHBhcnNlID0gZnVuY3Rpb24gcGFyc2VyKHN0cjogc3RyaW5nKSB7XG5cdGNvbnN0IG91dCA9IHN0clxuXHRcdC5yZXBsYWNlKC8oW1xcclxcblwiJ10pL2csICdcXFxcJDEnKVxuXHRcdC5yZXBsYWNlKFxuXHRcdFx0VE9LRU5fUkVHLFxuXHRcdFx0ZnVuY3Rpb24gc3RyaW5nQ2h1bmtSZXBsYWNlcihfZm91bmQsIGlzU3ViLCBsYW5nLCBwYXRoKSB7XG5cdFx0XHRcdGxldCBsLCB4O1xuXHRcdFx0XHRpZiAoaXNTdWIpIHtcblx0XHRcdFx0XHRsID0gbGFuZyA/ICdcIicgKyBsYW5nICsgJ1wiJyA6ICdsJztcblx0XHRcdFx0XHR4ID0gYF8oZFtcIiR7cGF0aH1cIl0gfHwgXCIke3BhdGh9XCIsIGQsIDAsICR7bH0pYDtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHR4ID0gJ2QuJyArIHBhdGg7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRyZXR1cm4gJ1wiKycgKyB4ICsgJytcIic7XG5cdFx0XHR9XG5cdFx0KTtcblxuXHRyZXR1cm4gbmV3IEZ1bmN0aW9uKFxuXHRcdCdfJyxcblx0XHQnZCcsXG5cdFx0J2wnLFxuXHRcdGByZXR1cm4gW1wiJHtvdXR9XCJdO2AucmVwbGFjZSgvXFxzP35cXHM/L2csICdcIixcIicpXG5cdCk7XG59O1xuY29uc3QgZ2V0S2V5ID0gZnVuY3Rpb24gZ2V0S2V5KGtleTogc3RyaW5nLCBsYW5nRGF0YTogYW55KSB7XG5cdGNvbnN0IHBhcnRzID0gKGtleSB8fCAnJykuc3BsaXQoJy4nKTtcblx0bGV0IG1lc3NhZ2UgPSBsYW5nRGF0YTtcblxuXHRmb3IgKGxldCBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKSB7XG5cdFx0aWYgKG1lc3NhZ2UgPT09IHVuZGVmaW5lZCB8fCBtZXNzYWdlID09PSBudWxsKSB7XG5cdFx0XHRyZXR1cm4gdW5kZWZpbmVkO1xuXHRcdH1cblxuXHRcdG1lc3NhZ2UgPSBtZXNzYWdlW3BhcnRzW2ldXSB8fCB1bmRlZmluZWQ7XG5cdH1cblxuXHRyZXR1cm4gbWVzc2FnZTtcbn07XG5cbmNvbnN0IF90bXAgPSBuZXcgTWFwKCksXG5cdHRyYW5zbGF0ZSA9IGZ1bmN0aW9uIHRyYW5zbGF0ZShcblx0XHRrZXk6IHN0cmluZyxcblx0XHRkYXRhOiBPSTE4bkRhdGEsXG5cdFx0cGx1cmFsaXplOiBPSTE4blBsdXJhbGl6ZSA9IDAsXG5cdFx0bGFuZzogc3RyaW5nXG5cdCk6IHN0cmluZyB7XG5cdFx0Y29uc3QgaWQgPSBgJHtsYW5nfToke2tleX1gO1xuXHRcdGxldCBtZXNzYWdlID0ga2V5LFxuXHRcdFx0Zm9ybWF0LFxuXHRcdFx0Zm47XG5cblx0XHRpZiAoX3RtcC5oYXMoaWQpKSB7XG5cdFx0XHRmbiA9IF90bXAuZ2V0KGlkKTtcblx0XHR9IGVsc2UgaWYgKExBTkdfT0JKRUNUW2xhbmddICYmIChmb3JtYXQgPSBnZXRLZXkoa2V5LCBMQU5HX09CSkVDVFtsYW5nXSkpKSB7XG5cdFx0XHRfdG1wLnNldChpZCwgKGZuID0gcGFyc2UoZm9ybWF0KSkpO1xuXHRcdH1cblxuXHRcdGlmIChmbikge1xuXHRcdFx0Y29uc3QgcGFydHMgPSBmbih0cmFuc2xhdGUsIGRhdGEsIGxhbmcpLFxuXHRcdFx0XHRsZW4gPSBwYXJ0cy5sZW5ndGg7XG5cdFx0XHRsZXQgaW5kZXg7XG5cblx0XHRcdGlmICh0eXBlb2YgcGx1cmFsaXplID09PSAnZnVuY3Rpb24nKSB7XG5cdFx0XHRcdGluZGV4ID0gcGx1cmFsaXplKGRhdGEsIHBhcnRzKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGluZGV4ID0gcGx1cmFsaXplO1xuXHRcdFx0fVxuXG5cdFx0XHRpbmRleCA9IE1hdGgubWF4KE1hdGgubWluKGluZGV4LCBsZW4gLSAxKSwgMCk7XG5cdFx0XHRtZXNzYWdlID0gcGFydHNbaW5kZXhdO1xuXHRcdH1cblxuXHRcdHJldHVybiBtZXNzYWdlO1xuXHR9O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPV2ViSTE4biBleHRlbmRzIE9XZWJFdmVudCB7XG5cdGRlZmF1bHRMYW5nQ29kZSA9ICdlbic7XG5cblx0LyoqXG5cdCAqIFNldHMgZGVmYXVsdCBpMThuIGxhbmcgY29kZS5cblx0ICpcblx0ICogQHBhcmFtIGxhbmcgVGhlIGkxOG4gbGFuZyBjb2RlLlxuXHQgKi9cblx0c2V0RGVmYXVsdExhbmcobGFuZzogc3RyaW5nKTogdGhpcyB7XG5cdFx0aWYgKCFMQU5HX09CSkVDVFtsYW5nXSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFxuXHRcdFx0XHRgW09XZWJMYW5nXSBjYW4ndCBzZXQgZGVmYXVsdCBsYW5ndWFnZSwgdW5kZWZpbmVkIGxhbmd1YWdlIGRhdGEgZm9yOiAke2xhbmd9LmBcblx0XHRcdCk7XG5cdFx0fVxuXG5cdFx0dGhpcy5kZWZhdWx0TGFuZ0NvZGUgPSBsYW5nO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogUmV0dXJucyBpMThuIHRyYW5zbGF0aW9uLlxuXHQgKlxuXHQgKiBAcGFyYW0ga2V5IFRoZSBpMThuIHN0cmluZyBrZXkuXG5cdCAqIEBwYXJhbSBkYXRhIFRoZSBkYXRhIHRvIGluamVjdCBpbiB0cmFuc2xhdGlvbiBwcm9jZXNzLlxuXHQgKiBAcGFyYW0gcGx1cmFsaXplXG5cdCAqIEBwYXJhbSBsYW5nIFRoZSBpMThuIGxhbmcgY29kZSB0byB1c2UuXG5cdCAqL1xuXHR0b0h1bWFuKFxuXHRcdGtleTogT0kxOG4sXG5cdFx0ZGF0YTogT0kxOG5EYXRhID0ge30sXG5cdFx0cGx1cmFsaXplOiBPSTE4blBsdXJhbGl6ZSA9IDAsXG5cdFx0bGFuZzogc3RyaW5nID0gdGhpcy5kZWZhdWx0TGFuZ0NvZGVcblx0KTogc3RyaW5nIHtcblx0XHRpZiAodHlwZW9mIGtleSAhPT0gJ3N0cmluZycpIHtcblx0XHRcdGNvbnN0IG9wdDogT0kxOG5PcHRpb25zID0ga2V5IGFzIGFueTtcblx0XHRcdHJldHVybiB0cmFuc2xhdGUoXG5cdFx0XHRcdG9wdC50ZXh0IHx8ICcnLFxuXHRcdFx0XHRvcHQuZGF0YSB8fCBkYXRhLFxuXHRcdFx0XHRvcHQucGx1cmFsaXplIHx8IHBsdXJhbGl6ZSxcblx0XHRcdFx0b3B0LmxhbmcgfHwgbGFuZ1xuXHRcdFx0KTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdHJhbnNsYXRlKGtleSwgZGF0YSwgcGx1cmFsaXplLCBsYW5nKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBTZXRzIGkxOG4gZm9yIEhUTUxFbGVtZW50XG5cdCAqXG5cdCAqIEBwYXJhbSBlbFxuXHQgKiBAcGFyYW0gb3B0aW9uc1xuXHQgKi9cblx0ZWwoZWw6IEhUTUxFbGVtZW50LCBvcHRpb25zOiBPSTE4bkVsZW1lbnQpOiB2b2lkIHtcblx0XHRpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7XG5cdFx0XHRvcHRpb25zID0geyB0ZXh0OiBvcHRpb25zIH07XG5cdFx0fVxuXG5cdFx0Y29uc3QgeyBub2RlTmFtZSB9ID0gZWwsXG5cdFx0XHRpc0lucHV0ID0gbm9kZU5hbWUgPT09ICdJTlBVVCcgfHwgbm9kZU5hbWUgPT09ICdURVhUQVJFQScsXG5cdFx0XHR7XG5cdFx0XHRcdHRleHQsXG5cdFx0XHRcdHBsYWNlaG9sZGVyLFxuXHRcdFx0XHR0aXRsZSxcblx0XHRcdFx0ZGF0YSA9IHt9LFxuXHRcdFx0XHRsYW5nID0gdGhpcy5kZWZhdWx0TGFuZ0NvZGUsXG5cdFx0XHRcdHBsdXJhbGl6ZSxcblx0XHRcdH0gPSBvcHRpb25zO1xuXHRcdGxldCBzdHI7XG5cblx0XHRpZiAodGV4dCkge1xuXHRcdFx0c3RyID0gdHJhbnNsYXRlKHRleHQsIGRhdGEsIHBsdXJhbGl6ZSwgbGFuZyk7XG5cdFx0XHRpZiAoIWlzSW5wdXQpIHtcblx0XHRcdFx0ZWwuaW5uZXJIVE1MID0gc3RyO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0ZWwuc2V0QXR0cmlidXRlKCd2YWx1ZScsIHN0cik7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0aWYgKGlzSW5wdXQgJiYgcGxhY2Vob2xkZXIpIHtcblx0XHRcdHN0ciA9IHRyYW5zbGF0ZShwbGFjZWhvbGRlciwgZGF0YSwgcGx1cmFsaXplLCBsYW5nKTtcblx0XHRcdGVsLnNldEF0dHJpYnV0ZSgncGxhY2Vob2xkZXInLCBzdHIpO1xuXHRcdH1cblxuXHRcdGlmICh0aXRsZSkge1xuXHRcdFx0c3RyID0gdHJhbnNsYXRlKHRpdGxlLCBkYXRhLCBwbHVyYWxpemUsIGxhbmcpO1xuXHRcdFx0ZWwuc2V0QXR0cmlidXRlKCd0aXRsZScsIHN0cik7XG5cdFx0fVxuXHR9XG5cblx0LyoqXG5cdCAqIFNldHMgdGhlIGkxOG4gbGFuZyBkYXRhLlxuXHQgKlxuXHQgKiBAcGFyYW0gbGFuZyBUaGUgaTE4biBsYW5nIGNvZGVcblx0ICogQHBhcmFtIGRhdGEgVGhlIGkxOG4gbGFuZyBkYXRhLlxuXHQgKi9cblx0c3RhdGljIGxvYWRMYW5nRGF0YShsYW5nOiBzdHJpbmcsIGRhdGE6IE9JMThuRGVmaW5pdGlvbik6IHZvaWQge1xuXHRcdGlmICghaXNTdHJpbmcobGFuZykpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoXG5cdFx0XHRcdCdbT1dlYkkxOG5dIHlvdXIgbGFuZyBuYW1lIHNob3VsZCBiZSBhIHZhbGlkIHN0cmluZy4nXG5cdFx0XHQpO1xuXHRcdH1cblxuXHRcdGlmICghaXNQbGFpbk9iamVjdChkYXRhKSkge1xuXHRcdFx0dGhyb3cgbmV3IFR5cGVFcnJvcihcblx0XHRcdFx0J1tPV2ViSTE4bl0geW91ciBsYW5nIGRhdGEgc2hvdWxkIGJlIGEgdmFsaWQgcGxhaW4gb2JqZWN0Lidcblx0XHRcdCk7XG5cdFx0fVxuXG5cdFx0TEFOR19PQkpFQ1RbbGFuZ10gPSBhc3NpZ24oTEFOR19PQkpFQ1RbbGFuZ10gfHwge30sIGRhdGEpO1xuXHR9XG59XG4iXX0=