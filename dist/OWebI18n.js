import OWebEvent from './OWebEvent';
import { assign, isPlainObject, isString } from './utils';
const LANG_OBJECT = Object.create(null);
// {name} | {@message} | {@app.name} | {@fr:message} | {@fr:app.name}
const TOKEN_REG = /{\s*(@)?(?:([a-z-]{2,}):)?([a-z_][a-z0-9_]*(?:\.[a-z_][a-z0-9_]*)*)\s*}/gi;
/**
 * ```js
 *
 * const samples = {
 *  message                               : 'Hello World!',
 *  message_with_token                    : 'Hello {name}!',
 *  message_with_pluralize                : 'one message ~ two messages ~ {n} messages',
 *  message_with_sub_message              : '{@message_with_token} Welcome to our website.',
 *  message_with_sub_message_deep         : 'App name is: {@app.name}.',
 *  message_with_sub_message_specific_lang: '{@fr:message_with_token} We speak french too!',
 *  app                                   : {
 * 		name: 'MagicApp'
 * 	}
 * };
 * ```
 */
const parse = function parser(str) {
    const out = str
        .replace(/([\r\n"'])/g, '\\$1')
        .replace(TOKEN_REG, function stringChunkReplacer(_found, isSub, lang, path) {
        let l, x;
        if (isSub) {
            l = lang ? '"' + lang + '"' : 'l';
            x = `_(d["${path}"] || "${path}", d, 0, ${l})`;
        }
        else {
            x = 'd.' + path;
        }
        return '"+' + x + '+"';
    });
    return new Function('_', 'd', 'l', `return ["${out}"];`.replace(/\s?~\s?/g, '","'));
};
const getKey = function getKey(key, langData) {
    const parts = (key || '').split('.');
    let message = langData;
    for (let i = 0; i < parts.length; i++) {
        if (message === undefined || message === null) {
            return undefined;
        }
        message = message[parts[i]] || undefined;
    }
    return message;
};
const _tmp = new Map(), translate = function translate(key, data, pluralize = 0, lang) {
    const id = `${lang}:${key}`;
    let message = key, format, fn;
    if (_tmp.has(id)) {
        fn = _tmp.get(id);
    }
    else if (LANG_OBJECT[lang] && (format = getKey(key, LANG_OBJECT[lang]))) {
        _tmp.set(id, (fn = parse(format)));
    }
    if (fn) {
        const parts = fn(translate, data, lang), len = parts.length;
        let index;
        if (typeof pluralize === 'function') {
            index = pluralize(data, parts);
        }
        else {
            index = pluralize;
        }
        index = Math.max(Math.min(index, len - 1), 0);
        message = parts[index];
    }
    return message;
};
export default class OWebI18n extends OWebEvent {
    defaultLangCode = 'en';
    /**
     * Sets default i18n lang code.
     *
     * @deprecated use {@link OWebI18n.setLang}
     *
     * @param lang The i18n lang code.
     */
    setDefaultLang(lang) {
        return this.setLang(lang);
    }
    /**
     * Sets i18n lang code.
     *
     * @param lang The i18n lang code.
     */
    setLang(lang) {
        if (!LANG_OBJECT[lang]) {
            throw new Error(`[OWebLang] can't set default language, undefined language data for: ${lang}.`);
        }
        this.defaultLangCode = lang;
        return this;
    }
    /**
     * Gets current lang.
     *
     * @returns {string}
     */
    getCurrentLang() {
        return this.defaultLangCode;
    }
    /**
     * Gets supported languages.
     *
     * @returns {string[]}
     */
    getSupportedLangs() {
        return Object.keys(LANG_OBJECT);
    }
    /**
     * Returns i18n translation.
     *
     * @param key The i18n string key.
     * @param data The data to inject in translation process.
     * @param pluralize
     * @param lang The i18n lang code to use.
     */
    toHuman(key, data = {}, pluralize = 0, lang = this.defaultLangCode) {
        if (typeof key !== 'string') {
            const opt = key;
            return translate(opt.text || '', opt.data || data, opt.pluralize || pluralize, opt.lang || lang);
        }
        return translate(key, data, pluralize, lang);
    }
    /**
     * Sets i18n for HTMLElement
     *
     * @param el
     * @param options
     */
    el(el, options) {
        if (typeof options === 'string') {
            options = { text: options };
        }
        const { nodeName } = el, isInput = nodeName === 'INPUT' || nodeName === 'TEXTAREA', { text, placeholder, title, data = {}, lang = this.defaultLangCode, pluralize, } = options;
        let str;
        if (text) {
            str = translate(text, data, pluralize, lang);
            if (!isInput) {
                el.innerHTML = str;
            }
            else {
                el.setAttribute('value', str);
            }
        }
        if (isInput && placeholder) {
            str = translate(placeholder, data, pluralize, lang);
            el.setAttribute('placeholder', str);
        }
        if (title) {
            str = translate(title, data, pluralize, lang);
            el.setAttribute('title', str);
        }
    }
    /**
     * Sets the i18n lang data.
     *
     * @param lang The i18n lang code
     * @param data The i18n lang data.
     */
    static loadLangData(lang, data) {
        if (!isString(lang)) {
            throw new TypeError('[OWebI18n] your lang name should be a valid string.');
        }
        if (!isPlainObject(data)) {
            throw new TypeError('[OWebI18n] your lang data should be a valid plain object.');
        }
        LANG_OBJECT[lang] = assign(LANG_OBJECT[lang] || {}, data);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkkxOG4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYkkxOG4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxTQUFTLE1BQU0sYUFBYSxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxNQUFNLEVBQUUsYUFBYSxFQUFFLFFBQVEsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQTJCMUQsTUFBTSxXQUFXLEdBQXVDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDNUUscUVBQXFFO0FBQ3JFLE1BQU0sU0FBUyxHQUNkLDJFQUEyRSxDQUFDO0FBRTdFOzs7Ozs7Ozs7Ozs7Ozs7R0FlRztBQUNILE1BQU0sS0FBSyxHQUFHLFNBQVMsTUFBTSxDQUFDLEdBQVc7SUFDeEMsTUFBTSxHQUFHLEdBQUcsR0FBRztTQUNiLE9BQU8sQ0FBQyxhQUFhLEVBQUUsTUFBTSxDQUFDO1NBQzlCLE9BQU8sQ0FDUCxTQUFTLEVBQ1QsU0FBUyxtQkFBbUIsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxJQUFJO1FBQ3JELElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNULElBQUksS0FBSyxFQUFFO1lBQ1YsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztZQUNsQyxDQUFDLEdBQUcsUUFBUSxJQUFJLFVBQVUsSUFBSSxZQUFZLENBQUMsR0FBRyxDQUFDO1NBQy9DO2FBQU07WUFDTixDQUFDLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQztTQUNoQjtRQUVELE9BQU8sSUFBSSxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDeEIsQ0FBQyxDQUNELENBQUM7SUFFSCxPQUFPLElBQUksUUFBUSxDQUNsQixHQUFHLEVBQ0gsR0FBRyxFQUNILEdBQUcsRUFDSCxZQUFZLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFV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bHVlIH0gZnJvbSAnLi9PV2ViRGF0YVN0b3JlJztcbmltcG9ydCBPV2ViRXZlbnQgZnJvbSAnLi9PV2ViRXZlbnQnO1xuaW1wb3J0IHsgYXNzaWduLCBpc1BsYWluT2JqZWN0LCBpc1N0cmluZyB9IGZyb20gJy4vdXRpbHMnO1xuXG5leHBvcnQgdHlwZSBPSTE4bkRlZmluaXRpb24gPSBSZWNvcmQ8c3RyaW5nLCBPSlNPTlZhbHVlPjtcbmV4cG9ydCB0eXBlIE9JMThuRGF0YSA9IHsgW2tleTogc3RyaW5nXTogYW55IH07XG5leHBvcnQgdHlwZSBPSTE4bk9wdGlvbnMgPSB7XG5cdHRleHQ/OiBzdHJpbmc7XG5cdGxhbmc/OiBzdHJpbmc7XG5cdGRhdGE/OiBPSTE4bkRhdGE7XG5cdHBsdXJhbGl6ZT86IE9JMThuUGx1cmFsaXplO1xufTtcbmV4cG9ydCB0eXBlIE9JMThuID0gT0kxOG5PcHRpb25zIHwgc3RyaW5nO1xuXG5leHBvcnQgdHlwZSBPSTE4bkVsZW1lbnQgPVxuXHR8IHN0cmluZ1xuXHR8IHtcblx0XHRcdHRleHQ/OiBzdHJpbmc7XG5cdFx0XHRwbGFjZWhvbGRlcj86IHN0cmluZztcblx0XHRcdHRpdGxlPzogc3RyaW5nO1xuXHRcdFx0bGFuZz86IHN0cmluZztcblx0XHRcdGRhdGE/OiBPSTE4bkRhdGE7XG5cdFx0XHRwbHVyYWxpemU/OiBPSTE4blBsdXJhbGl6ZTtcblx0ICB9O1xuXG5leHBvcnQgdHlwZSBPSTE4blBsdXJhbGl6ZSA9XG5cdHwgbnVtYmVyXG5cdHwgKChkYXRhOiBPSTE4bkRhdGEsIHBhcnRzOiBzdHJpbmdbXSkgPT4gbnVtYmVyKTtcblxuY29uc3QgTEFOR19PQkpFQ1Q6IHsgW2tleTogc3RyaW5nXTogT0kxOG5EZWZpbml0aW9uIH0gPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuLy8ge25hbWV9IHwge0BtZXNzYWdlfSB8IHtAYXBwLm5hbWV9IHwge0BmcjptZXNzYWdlfSB8IHtAZnI6YXBwLm5hbWV9XG5jb25zdCBUT0tFTl9SRUcgPVxuXHQve1xccyooQCk/KD86KFthLXotXXsyLH0pOik/KFthLXpfXVthLXowLTlfXSooPzpcXC5bYS16X11bYS16MC05X10qKSopXFxzKn0vZ2k7XG5cbi8qKlxuICogYGBganNcbiAqXG4gKiBjb25zdCBzYW1wbGVzID0ge1xuICogIG1lc3NhZ2UgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnSGVsbG8gV29ybGQhJyxcbiAqICBtZXNzYWdlX3dpdGhfdG9rZW4gICAgICAgICAgICAgICAgICAgIDogJ0hlbGxvIHtuYW1lfSEnLFxuICogIG1lc3NhZ2Vfd2l0aF9wbHVyYWxpemUgICAgICAgICAgICAgICAgOiAnb25lIG1lc3NhZ2UgfiB0d28gbWVzc2FnZXMgfiB7bn0gbWVzc2FnZXMnLFxuICogIG1lc3NhZ2Vfd2l0aF9zdWJfbWVzc2FnZSAgICAgICAgICAgICAgOiAne0BtZXNzYWdlX3dpdGhfdG9rZW59IFdlbGNvbWUgdG8gb3VyIHdlYnNpdGUuJyxcbiAqICBtZXNzYWdlX3dpdGhfc3ViX21lc3NhZ2VfZGVlcCAgICAgICAgIDogJ0FwcCBuYW1lIGlzOiB7QGFwcC5uYW1lfS4nLFxuICogIG1lc3NhZ2Vfd2l0aF9zdWJfbWVzc2FnZV9zcGVjaWZpY19sYW5nOiAne0BmcjptZXNzYWdlX3dpdGhfdG9rZW59IFdlIHNwZWFrIGZyZW5jaCB0b28hJyxcbiAqICBhcHAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDoge1xuICogXHRcdG5hbWU6ICdNYWdpY0FwcCdcbiAqIFx0fVxuICogfTtcbiAqIGBgYFxuICovXG5jb25zdCBwYXJzZSA9IGZ1bmN0aW9uIHBhcnNlcihzdHI6IHN0cmluZykge1xuXHRjb25zdCBvdXQgPSBzdHJcblx0XHQucmVwbGFjZSgvKFtcXHJcXG5cIiddKS9nLCAnXFxcXCQxJylcblx0XHQucmVwbGFjZShcblx0XHRcdFRPS0VOX1JFRyxcblx0XHRcdGZ1bmN0aW9uIHN0cmluZ0NodW5rUmVwbGFjZXIoX2ZvdW5kLCBpc1N1YiwgbGFuZywgcGF0aCkge1xuXHRcdFx0XHRsZXQgbCwgeDtcblx0XHRcdFx0aWYgKGlzU3ViKSB7XG5cdFx0XHRcdFx0bCA9IGxhbmcgPyAnXCInICsgbGFuZyArICdcIicgOiAnbCc7XG5cdFx0XHRcdFx0eCA9IGBfKGRbXCIke3BhdGh9XCJdIHx8IFwiJHtwYXRofVwiLCBkLCAwLCAke2x9KWA7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0eCA9ICdkLicgKyBwYXRoO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0cmV0dXJuICdcIisnICsgeCArICcrXCInO1xuXHRcdFx0fVxuXHRcdCk7XG5cblx0cmV0dXJuIG5ldyBGdW5jdGlvbihcblx0XHQnXycsXG5cdFx0J2QnLFxuXHRcdCdsJyxcblx0XHRgcmV0dXJuIFtcIiR7b3V0fVwiXTtgLnJlcGxhY2UoL1xccz9+XFxzPy9nLCAnXCIsXCInKVxuXHQpO1xufTtcbmNvbnN0IGdldEtleSA9IGZ1bmN0aW9uIGdldEtleShrZXk6IHN0cmluZywgbGFuZ0RhdGE6IGFueSkge1xuXHRjb25zdCBwYXJ0cyA9IChrZXkgfHwgJycpLnNwbGl0KCcuJyk7XG5cdGxldCBtZXNzYWdlID0gbGFuZ0RhdGE7XG5cblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykge1xuXHRcdGlmIChtZXNzYWdlID09PSB1bmRlZmluZWQgfHwgbWVzc2FnZSA9PT0gbnVsbCkge1xuXHRcdFx0cmV0dXJuIHVuZGVmaW5lZDtcblx0XHR9XG5cblx0XHRtZXNzYWdlID0gbWVzc2FnZVtwYXJ0c1tpXV0gfHwgdW5kZWZpbmVkO1xuXHR9XG5cblx0cmV0dXJuIG1lc3NhZ2U7XG59O1xuXG5jb25zdCBfdG1wID0gbmV3IE1hcCgpLFxuXHR0cmFuc2xhdGUgPSBmdW5jdGlvbiB0cmFuc2xhdGUoXG5cdFx0a2V5OiBzdHJpbmcsXG5cdFx0ZGF0YTogT0kxOG5EYXRhLFxuXHRcdHBsdXJhbGl6ZTogT0kxOG5QbHVyYWxpemUgPSAwLFxuXHRcdGxhbmc6IHN0cmluZ1xuXHQpOiBzdHJpbmcge1xuXHRcdGNvbnN0IGlkID0gYCR7bGFuZ306JHtrZXl9YDtcblx0XHRsZXQgbWVzc2FnZSA9IGtleSxcblx0XHRcdGZvcm1hdCxcblx0XHRcdGZuO1xuXG5cdFx0aWYgKF90bXAuaGFzKGlkKSkge1xuXHRcdFx0Zm4gPSBfdG1wLmdldChpZCk7XG5cdFx0fSBlbHNlIGlmIChMQU5HX09CSkVDVFtsYW5nXSAmJiAoZm9ybWF0ID0gZ2V0S2V5KGtleSwgTEFOR19PQkpFQ1RbbGFuZ10pKSkge1xuXHRcdFx0X3RtcC5zZXQoaWQsIChmbiA9IHBhcnNlKGZvcm1hdCkpKTtcblx0XHR9XG5cblx0XHRpZiAoZm4pIHtcblx0XHRcdGNvbnN0IHBhcnRzID0gZm4odHJhbnNsYXRlLCBkYXRhLCBsYW5nKSxcblx0XHRcdFx0bGVuID0gcGFydHMubGVuZ3RoO1xuXHRcdFx0bGV0IGluZGV4O1xuXG5cdFx0XHRpZiAodHlwZW9mIHBsdXJhbGl6ZSA9PT0gJ2Z1bmN0aW9uJykge1xuXHRcdFx0XHRpbmRleCA9IHBsdXJhbGl6ZShkYXRhLCBwYXJ0cyk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRpbmRleCA9IHBsdXJhbGl6ZTtcblx0XHRcdH1cblxuXHRcdFx0aW5kZXggPSBNYXRoLm1heChNYXRoLm1pbihpbmRleCwgbGVuIC0gMSksIDApO1xuXHRcdFx0bWVzc2FnZSA9IHBhcnRzW2luZGV4XTtcblx0XHR9XG5cblx0XHRyZXR1cm4gbWVzc2FnZTtcblx0fTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT1dlYkkxOG4gZXh0ZW5kcyBPV2ViRXZlbnQge1xuXHRwcml2YXRlIGRlZmF1bHRMYW5nQ29kZSA9ICdlbic7XG5cblx0LyoqXG5cdCAqIFNldHMgZGVmYXVsdCBpMThuIGxhbmcgY29kZS5cblx0ICpcblx0ICogQGRlcHJlY2F0ZWQgdXNlIHtAbGluayBPV2ViSTE4bi5zZXRMYW5nfVxuXHQgKlxuXHQgKiBAcGFyYW0gbGFuZyBUaGUgaTE4biBsYW5nIGNvZGUuXG5cdCAqL1xuXHRzZXREZWZhdWx0TGFuZyhsYW5nOiBzdHJpbmcpOiB0aGlzIHtcblx0XHRyZXR1cm4gdGhpcy5zZXRMYW5nKGxhbmcpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFNldHMgaTE4biBsYW5nIGNvZGUuXG5cdCAqXG5cdCAqIEBwYXJhbSBsYW5nIFRoZSBpMThuIGxhbmcgY29kZS5cblx0ICovXG5cdHNldExhbmcobGFuZzogc3RyaW5nKTogdGhpcyB7XG5cdFx0aWYgKCFMQU5HX09CSkVDVFtsYW5nXSkge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFxuXHRcdFx0XHRgW09XZWJMYW5nXSBjYW4ndCBzZXQgZGVmYXVsdCBsYW5ndWFnZSwgdW5kZWZpbmVkIGxhbmd1YWdlIGRhdGEgZm9yOiAke2xhbmd9LmBcblx0XHRcdCk7XG5cdFx0fVxuXG5cdFx0dGhpcy5kZWZhdWx0TGFuZ0NvZGUgPSBsYW5nO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHQvKipcblx0ICogR2V0cyBjdXJyZW50IGxhbmcuXG5cdCAqXG5cdCAqIEByZXR1cm5zIHtzdHJpbmd9XG5cdCAqL1xuXHRnZXRDdXJyZW50TGFuZygpIHtcblx0XHRyZXR1cm4gdGhpcy5kZWZhdWx0TGFuZ0NvZGU7XG5cdH1cblxuXHQvKipcblx0ICogR2V0cyBzdXBwb3J0ZWQgbGFuZ3VhZ2VzLlxuXHQgKlxuXHQgKiBAcmV0dXJucyB7c3RyaW5nW119XG5cdCAqL1xuXHRnZXRTdXBwb3J0ZWRMYW5ncygpOiBzdHJpbmdbXSB7XG5cdFx0cmV0dXJuIE9iamVjdC5rZXlzKExBTkdfT0JKRUNUKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIGkxOG4gdHJhbnNsYXRpb24uXG5cdCAqXG5cdCAqIEBwYXJhbSBrZXkgVGhlIGkxOG4gc3RyaW5nIGtleS5cblx0ICogQHBhcmFtIGRhdGEgVGhlIGRhdGEgdG8gaW5qZWN0IGluIHRyYW5zbGF0aW9uIHByb2Nlc3MuXG5cdCAqIEBwYXJhbSBwbHVyYWxpemVcblx0ICogQHBhcmFtIGxhbmcgVGhlIGkxOG4gbGFuZyBjb2RlIHRvIHVzZS5cblx0ICovXG5cdHRvSHVtYW4oXG5cdFx0a2V5OiBPSTE4bixcblx0XHRkYXRhOiBPSTE4bkRhdGEgPSB7fSxcblx0XHRwbHVyYWxpemU6IE9JMThuUGx1cmFsaXplID0gMCxcblx0XHRsYW5nOiBzdHJpbmcgPSB0aGlzLmRlZmF1bHRMYW5nQ29kZVxuXHQpOiBzdHJpbmcge1xuXHRcdGlmICh0eXBlb2Yga2V5ICE9PSAnc3RyaW5nJykge1xuXHRcdFx0Y29uc3Qgb3B0ID0ga2V5IGFzIE9JMThuT3B0aW9ucztcblx0XHRcdHJldHVybiB0cmFuc2xhdGUoXG5cdFx0XHRcdG9wdC50ZXh0IHx8ICcnLFxuXHRcdFx0XHRvcHQuZGF0YSB8fCBkYXRhLFxuXHRcdFx0XHRvcHQucGx1cmFsaXplIHx8IHBsdXJhbGl6ZSxcblx0XHRcdFx0b3B0LmxhbmcgfHwgbGFuZ1xuXHRcdFx0KTtcblx0XHR9XG5cblx0XHRyZXR1cm4gdHJhbnNsYXRlKGtleSwgZGF0YSwgcGx1cmFsaXplLCBsYW5nKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBTZXRzIGkxOG4gZm9yIEhUTUxFbGVtZW50XG5cdCAqXG5cdCAqIEBwYXJhbSBlbFxuXHQgKiBAcGFyYW0gb3B0aW9uc1xuXHQgKi9cblx0ZWwoZWw6IEhUTUxFbGVtZW50LCBvcHRpb25zOiBPSTE4bkVsZW1lbnQpOiB2b2lkIHtcblx0XHRpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7XG5cdFx0XHRvcHRpb25zID0geyB0ZXh0OiBvcHRpb25zIH07XG5cdFx0fVxuXG5cdFx0Y29uc3QgeyBub2RlTmFtZSB9ID0gZWwsXG5cdFx0XHRpc0lucHV0ID0gbm9kZU5hbWUgPT09ICdJTlBVVCcgfHwgbm9kZU5hbWUgPT09ICdURVhUQVJFQScsXG5cdFx0XHR7XG5cdFx0XHRcdHRleHQsXG5cdFx0XHRcdHBsYWNlaG9sZGVyLFxuXHRcdFx0XHR0aXRsZSxcblx0XHRcdFx0ZGF0YSA9IHt9LFxuXHRcdFx0XHRsYW5nID0gdGhpcy5kZWZhdWx0TGFuZ0NvZGUsXG5cdFx0XHRcdHBsdXJhbGl6ZSxcblx0XHRcdH0gPSBvcHRpb25zO1xuXHRcdGxldCBzdHI7XG5cblx0XHRpZiAodGV4dCkge1xuXHRcdFx0c3RyID0gdHJhbnNsYXRlKHRleHQsIGRhdGEsIHBsdXJhbGl6ZSwgbGFuZyk7XG5cdFx0XHRpZiAoIWlzSW5wdXQpIHtcblx0XHRcdFx0ZWwuaW5uZXJIVE1MID0gc3RyO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0ZWwuc2V0QXR0cmlidXRlKCd2YWx1ZScsIHN0cik7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0aWYgKGlzSW5wdXQgJiYgcGxhY2Vob2xkZXIpIHtcblx0XHRcdHN0ciA9IHRyYW5zbGF0ZShwbGFjZWhvbGRlciwgZGF0YSwgcGx1cmFsaXplLCBsYW5nKTtcblx0XHRcdGVsLnNldEF0dHJpYnV0ZSgncGxhY2Vob2xkZXInLCBzdHIpO1xuXHRcdH1cblxuXHRcdGlmICh0aXRsZSkge1xuXHRcdFx0c3RyID0gdHJhbnNsYXRlKHRpdGxlLCBkYXRhLCBwbHVyYWxpemUsIGxhbmcpO1xuXHRcdFx0ZWwuc2V0QXR0cmlidXRlKCd0aXRsZScsIHN0cik7XG5cdFx0fVxuXHR9XG5cblx0LyoqXG5cdCAqIFNldHMgdGhlIGkxOG4gbGFuZyBkYXRhLlxuXHQgKlxuXHQgKiBAcGFyYW0gbGFuZyBUaGUgaTE4biBsYW5nIGNvZGVcblx0ICogQHBhcmFtIGRhdGEgVGhlIGkxOG4gbGFuZyBkYXRhLlxuXHQgKi9cblx0c3RhdGljIGxvYWRMYW5nRGF0YShsYW5nOiBzdHJpbmcsIGRhdGE6IE9JMThuRGVmaW5pdGlvbik6IHZvaWQge1xuXHRcdGlmICghaXNTdHJpbmcobGFuZykpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoXG5cdFx0XHRcdCdbT1dlYkkxOG5dIHlvdXIgbGFuZyBuYW1lIHNob3VsZCBiZSBhIHZhbGlkIHN0cmluZy4nXG5cdFx0XHQpO1xuXHRcdH1cblxuXHRcdGlmICghaXNQbGFpbk9iamVjdChkYXRhKSkge1xuXHRcdFx0dGhyb3cgbmV3IFR5cGVFcnJvcihcblx0XHRcdFx0J1tPV2ViSTE4bl0geW91ciBsYW5nIGRhdGEgc2hvdWxkIGJlIGEgdmFsaWQgcGxhaW4gb2JqZWN0Lidcblx0XHRcdCk7XG5cdFx0fVxuXG5cdFx0TEFOR19PQkpFQ1RbbGFuZ10gPSBhc3NpZ24oTEFOR19PQkpFQ1RbbGFuZ10gfHwge30sIGRhdGEpO1xuXHR9XG59XG4iXX0=