import Utils from "../src/utils/Utils";
import OWebEvent from "../src/OWebEvent";
const LANG_OBJECT = {};
const TOKEN_REG = /{\s*(@)?(?:([a-z-]{2,})\.)?([a-z_][a-z0-9_]*)\s*}/ig; // {name} | {@message} | {@fr.message}
const sample = {
    message: 'Hello World!',
    message_with_token: 'Hello {name}!',
    message_with_pluralize: 'one message ~ two messages ~ {n} messages',
    message_with_sub_message: '{@message_with_token} Welcome to our website.',
    message_with_sub_message_specific_lang: '{@fr.message_with_token} We speak french too!'
};
let parse = function (str) {
    let out = str.replace(/([\r\n"'])/g, "\\$1")
        .replace(TOKEN_REG, function (found, is_sub, lang, path) {
        let l, x;
        if (is_sub) {
            l = lang ? '"' + lang + '"' : 'l';
            x = `_(d["${path}"] || "${path}", d, 0, ${l})`;
        }
        else {
            x = 'd.' + path;
        }
        return '"+' + x + '+"';
    });
    return new Function('_', 'd', 'l', `return ["${out}"];`.replace(/\s?~\s?/g, '","'));
};
let _tmp = new Map, translate = function (key, data, pluralize = 0, lang) {
    let id = `${lang}:${key}`, message = key, format, fn;
    if (_tmp.has(id)) {
        fn = _tmp.get(id);
    }
    else if (LANG_OBJECT[lang] && (format = LANG_OBJECT[lang][key])) {
        _tmp.set(id, fn = parse(format));
    }
    if (fn) {
        let parts = fn(translate, data, lang), len = parts.length, index;
        if (typeof pluralize === 'function') {
            index = pluralize(data, parts);
        }
        else {
            index = pluralize;
        }
        index = Math.max(Math.min(index, len - 1), 0);
        message = parts[index];
    }
    return message;
};
export default class OWebI18n extends OWebEvent {
    constructor() {
        super(...arguments);
        this.defaultLangCode = "en";
    }
    /**
     * Sets default i18n lang code.
     *
     * @param lang The i18n lang code.
     */
    setDefaultLang(lang) {
        if (!LANG_OBJECT[lang]) {
            throw new Error(`[OWebLang] can't set default language, undefined language data for: ${lang}.`);
        }
        this.defaultLangCode = lang;
        return this;
    }
    /**
     * Returns i18n translation.
     *
     * @param key The i18n string key.
     * @param data The data to inject in translation process.
     * @param pluralize
     * @param lang The i18n lang code to use.
     */
    toHuman(key, data = {}, pluralize = 0, lang = this.defaultLangCode) {
        return translate(key, data, pluralize, lang);
    }
    /**
     * Sets i18n for HTMLElement
     *
     * @param el
     * @param options
     */
    el(el, options) {
        if (typeof options === 'string') {
            options = { text: options };
        }
        const { nodeName } = el, isInput = (nodeName === 'INPUT' || nodeName === 'TEXTAREA'), { text, placeholder, title, data = {}, lang = this.defaultLangCode, pluralize } = options;
        let str;
        if (text) {
            str = translate(text, data, pluralize, lang);
            if (!isInput) {
                el.innerHTML = str;
            }
            else {
                el.setAttribute("value", str);
            }
        }
        if (isInput && placeholder) {
            str = translate(placeholder, data, pluralize, lang);
            el.setAttribute('placeholder', str);
        }
        if (title) {
            str = translate(title, data, pluralize, lang);
            el.setAttribute('title', str);
        }
    }
    /**
     * Sets the i18n lang data.
     *
     * @param lang The i18n lang code
     * @param data The i18n lang data.
     */
    static loadLangData(lang, data) {
        if (!Utils.isString(lang)) {
            throw new TypeError("[OWebI18n] your lang name should be a valid string.");
        }
        if (!Utils.isPlainObject(data)) {
            throw new TypeError("[OWebI18n] your lang data should be a valid plain object.");
        }
        LANG_OBJECT[lang] = Utils.assign(LANG_OBJECT[lang] || {}, data);
        return this;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT1dlYkkxOG4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvT1dlYkkxOG4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLE1BQU0sb0JBQW9CLENBQUM7QUFDdkMsT0FBTyxTQUFTLE1BQU0sa0JBQWtCLENBQUM7QUFjekMsTUFBTSxXQUFXLEdBQXlDLEVBQUUsQ0FBQztBQUM3RCxNQUFNLFNBQVMsR0FBRyxxREFBcUQsQ0FBQyxDQUFDLHNDQUFzQztBQUUvRyxNQUFNLE1BQU0sR0FBRztJQUNkLE9BQU8sRUFBRSxjQUFjO0lBQ3ZCLGtCQUFrQixFQUFFLGVBQWU7SUFDbkMsc0JBQXNCLEVBQUUsMkNBQTJDO0lBQ25FLHdCQUF3QixFQUFFLCtDQUErQztJQUN6RSxzQ0FBc0MsRUFBRSwrQ0FBK0M7Q0FDdkYsQ0FBQztBQUVGLElBQUksS0FBSyxHQUFHLFVBQVUsR0FBVztJQUVoQyxJQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxNQUFNLENBQUM7U0FDMUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxVQUFVLEtBQUssRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUk7UUFDdEQsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ1QsSUFBSSxNQUFNLEVBQUU7WUFDWCxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO1lBQ2xDLENBQUMsR0FBRyxRQUFTLElBQUssVUFBVyxJQUFLLFlBQWEsQ0FBRSxHQUFHLENBQUM7U0FDckQ7YUFBTTtZQUNOLENBQUMsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDO1NBQ2hCO1FBRUQsT0FBTyxJQUFJLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQztJQUN4QixDQUFDLENBQUMsQ0FBQztJQUVKLE9BQU8sSUFBSSxRQUFRLENBQUMsR0FBRyxFQUFFLEdBQUcs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QUksQ0FBQyxDQUFDO1FBRXBFLE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztDQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFV0aWxzIGZyb20gXCIuLi9zcmMvdXRpbHMvVXRpbHNcIjtcbmltcG9ydCBPV2ViRXZlbnQgZnJvbSBcIi4uL3NyYy9PV2ViRXZlbnRcIjtcblxuZXhwb3J0IHR5cGUgdEkxOG5EZWZpbml0aW9uID0geyBbIGtleTogc3RyaW5nIF06IGFueSB9O1xuZXhwb3J0IHR5cGUgdEkxOG5EYXRhID0geyBbIGtleTogc3RyaW5nIF06IGFueSB9O1xuZXhwb3J0IHR5cGUgdEkxOG5PcHRpb25zID0ge1xuXHR0ZXh0Pzogc3RyaW5nLFxuXHRwbGFjZWhvbGRlcj86IHN0cmluZyxcblx0dGl0bGU/OiBzdHJpbmcsXG5cdGxhbmc/OiBzdHJpbmcsXG5cdGRhdGE/OiB0STE4bkRhdGEsXG5cdHBsdXJhbGl6ZT86IHRJMThuUGx1cmFsaXplXG59O1xuZXhwb3J0IHR5cGUgdEkxOG5QbHVyYWxpemUgPSBudW1iZXIgfCAoKGRhdGE6IHRJMThuRGF0YSwgcGFydHM6IHN0cmluZ1tdKSA9PiBudW1iZXIpO1xuXG5jb25zdCBMQU5HX09CSkVDVDogeyBbIGtleTogc3RyaW5nIF06IHRJMThuRGVmaW5pdGlvbiB9ID0ge307XG5jb25zdCBUT0tFTl9SRUcgPSAve1xccyooQCk/KD86KFthLXotXXsyLH0pXFwuKT8oW2Etel9dW2EtejAtOV9dKilcXHMqfS9pZzsgLy8ge25hbWV9IHwge0BtZXNzYWdlfSB8IHtAZnIubWVzc2FnZX1cblxuY29uc3Qgc2FtcGxlID0ge1xuXHRtZXNzYWdlOiAnSGVsbG8gV29ybGQhJyxcblx0bWVzc2FnZV93aXRoX3Rva2VuOiAnSGVsbG8ge25hbWV9IScsXG5cdG1lc3NhZ2Vfd2l0aF9wbHVyYWxpemU6ICdvbmUgbWVzc2FnZSB+IHR3byBtZXNzYWdlcyB+IHtufSBtZXNzYWdlcycsXG5cdG1lc3NhZ2Vfd2l0aF9zdWJfbWVzc2FnZTogJ3tAbWVzc2FnZV93aXRoX3Rva2VufSBXZWxjb21lIHRvIG91ciB3ZWJzaXRlLicsXG5cdG1lc3NhZ2Vfd2l0aF9zdWJfbWVzc2FnZV9zcGVjaWZpY19sYW5nOiAne0Bmci5tZXNzYWdlX3dpdGhfdG9rZW59IFdlIHNwZWFrIGZyZW5jaCB0b28hJ1xufTtcblxubGV0IHBhcnNlID0gZnVuY3Rpb24gKHN0cjogc3RyaW5nKSB7XG5cblx0bGV0IG91dCA9IHN0ci5yZXBsYWNlKC8oW1xcclxcblwiJ10pL2csIFwiXFxcXCQxXCIpXG5cdFx0LnJlcGxhY2UoVE9LRU5fUkVHLCBmdW5jdGlvbiAoZm91bmQsIGlzX3N1YiwgbGFuZywgcGF0aCkge1xuXHRcdFx0bGV0IGwsIHg7XG5cdFx0XHRpZiAoaXNfc3ViKSB7XG5cdFx0XHRcdGwgPSBsYW5nID8gJ1wiJyArIGxhbmcgKyAnXCInIDogJ2wnO1xuXHRcdFx0XHR4ID0gYF8oZFtcIiR7IHBhdGggfVwiXSB8fCBcIiR7IHBhdGggfVwiLCBkLCAwLCAkeyBsIH0pYDtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHggPSAnZC4nICsgcGF0aDtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuICdcIisnICsgeCArICcrXCInO1xuXHRcdH0pO1xuXG5cdHJldHVybiBuZXcgRnVuY3Rpb24oJ18nLCAnZCcsICdsJywgYHJldHVybiBbXCIkeyBvdXQgfVwiXTtgLnJlcGxhY2UoL1xccz9+XFxzPy9nLCAnXCIsXCInKSk7XG59O1xuXG5sZXQgX3RtcCA9IG5ldyBNYXAsXG5cdHRyYW5zbGF0ZSA9IGZ1bmN0aW9uIChrZXk6IHN0cmluZywgZGF0YTogdEkxOG5EYXRhLCBwbHVyYWxpemU6IHRJMThuUGx1cmFsaXplID0gMCwgbGFuZzogc3RyaW5nKTogc3RyaW5nIHtcblx0XHRsZXQgaWQgPSBgJHsgbGFuZyB9OiR7IGtleSB9YCxcblx0XHRcdG1lc3NhZ2UgPSBrZXksXG5cdFx0XHRmb3JtYXQsXG5cdFx0XHRmbjtcblxuXHRcdGlmIChfdG1wLmhhcyhpZCkpIHtcblx0XHRcdGZuID0gX3RtcC5nZXQoaWQpO1xuXHRcdH0gZWxzZSBpZiAoTEFOR19PQkpFQ1RbIGxhbmcgXSAmJiAoZm9ybWF0ID0gTEFOR19PQkpFQ1RbIGxhbmcgXVsga2V5IF0pKSB7XG5cdFx0XHRfdG1wLnNldChpZCwgZm4gPSBwYXJzZShmb3JtYXQpKTtcblx0XHR9XG5cblx0XHRpZiAoZm4pIHtcblx0XHRcdGxldCBwYXJ0cyA9IGZuKHRyYW5zbGF0ZSwgZGF0YSwgbGFuZyksXG5cdFx0XHRcdGxlbiA9IHBhcnRzLmxlbmd0aCwgaW5kZXg7XG5cblx0XHRcdGlmICh0eXBlb2YgcGx1cmFsaXplID09PSAnZnVuY3Rpb24nKSB7XG5cdFx0XHRcdGluZGV4ID0gcGx1cmFsaXplKGRhdGEsIHBhcnRzKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGluZGV4ID0gcGx1cmFsaXplO1xuXHRcdFx0fVxuXG5cdFx0XHRpbmRleCA9IE1hdGgubWF4KE1hdGgubWluKGluZGV4LCBsZW4gLSAxKSwgMCk7XG5cdFx0XHRtZXNzYWdlID0gcGFydHNbIGluZGV4IF07XG5cdFx0fVxuXG5cdFx0cmV0dXJuIG1lc3NhZ2U7XG5cdH07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9XZWJJMThuIGV4dGVuZHMgT1dlYkV2ZW50IHtcblx0ZGVmYXVsdExhbmdDb2RlOiBzdHJpbmcgPSBcImVuXCI7XG5cblx0LyoqXG5cdCAqIFNldHMgZGVmYXVsdCBpMThuIGxhbmcgY29kZS5cblx0ICpcblx0ICogQHBhcmFtIGxhbmcgVGhlIGkxOG4gbGFuZyBjb2RlLlxuXHQgKi9cblx0c2V0RGVmYXVsdExhbmcobGFuZzogc3RyaW5nKSB7XG5cblx0XHRpZiAoIUxBTkdfT0JKRUNUWyBsYW5nIF0pIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihgW09XZWJMYW5nXSBjYW4ndCBzZXQgZGVmYXVsdCBsYW5ndWFnZSwgdW5kZWZpbmVkIGxhbmd1YWdlIGRhdGEgZm9yOiAkeyBsYW5nIH0uYClcblx0XHR9XG5cblx0XHR0aGlzLmRlZmF1bHRMYW5nQ29kZSA9IGxhbmc7XG5cblx0XHRyZXR1cm4gdGhpcztcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIGkxOG4gdHJhbnNsYXRpb24uXG5cdCAqXG5cdCAqIEBwYXJhbSBrZXkgVGhlIGkxOG4gc3RyaW5nIGtleS5cblx0ICogQHBhcmFtIGRhdGEgVGhlIGRhdGEgdG8gaW5qZWN0IGluIHRyYW5zbGF0aW9uIHByb2Nlc3MuXG5cdCAqIEBwYXJhbSBwbHVyYWxpemVcblx0ICogQHBhcmFtIGxhbmcgVGhlIGkxOG4gbGFuZyBjb2RlIHRvIHVzZS5cblx0ICovXG5cdHRvSHVtYW4oa2V5OiBzdHJpbmcsIGRhdGE6IHRJMThuRGF0YSA9IHt9LCBwbHVyYWxpemU6IHRJMThuUGx1cmFsaXplID0gMCwgbGFuZzogc3RyaW5nID0gdGhpcy5kZWZhdWx0TGFuZ0NvZGUpOiBzdHJpbmcge1xuXHRcdHJldHVybiB0cmFuc2xhdGUoa2V5LCBkYXRhLCBwbHVyYWxpemUsIGxhbmcpO1xuXHR9XG5cblx0LyoqXG5cdCAqIFNldHMgaTE4biBmb3IgSFRNTEVsZW1lbnRcblx0ICpcblx0ICogQHBhcmFtIGVsXG5cdCAqIEBwYXJhbSBvcHRpb25zXG5cdCAqL1xuXHRlbChlbDogSFRNTEVsZW1lbnQsIG9wdGlvbnM6IHRJMThuT3B0aW9ucyB8IHN0cmluZykge1xuXG5cdFx0aWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJykge1xuXHRcdFx0b3B0aW9ucyA9IHsgdGV4dDogb3B0aW9ucyB9O1xuXHRcdH1cblxuXHRcdGNvbnN0IHsgbm9kZU5hbWUgfSA9IGVsLFxuXHRcdFx0aXNJbnB1dCA9IChub2RlTmFtZSA9PT0gJ0lOUFVUJyB8fCBub2RlTmFtZSA9PT0gJ1RFWFRBUkVBJyksXG5cdFx0XHR7IHRleHQsIHBsYWNlaG9sZGVyLCB0aXRsZSwgZGF0YSA9IHt9LCBsYW5nID0gdGhpcy5kZWZhdWx0TGFuZ0NvZGUsIHBsdXJhbGl6ZSB9ID0gb3B0aW9ucztcblx0XHRsZXQgc3RyO1xuXG5cdFx0aWYgKHRleHQpIHtcblx0XHRcdHN0ciA9IHRyYW5zbGF0ZSh0ZXh0LCBkYXRhLCBwbHVyYWxpemUsIGxhbmcpO1xuXHRcdFx0aWYgKCFpc0lucHV0KSB7XG5cdFx0XHRcdGVsLmlubmVySFRNTCA9IHN0cjtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGVsLnNldEF0dHJpYnV0ZShcInZhbHVlXCIsIHN0cik7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0aWYgKGlzSW5wdXQgJiYgcGxhY2Vob2xkZXIpIHtcblx0XHRcdHN0ciA9IHRyYW5zbGF0ZShwbGFjZWhvbGRlciwgZGF0YSwgcGx1cmFsaXplLCBsYW5nKTtcblx0XHRcdGVsLnNldEF0dHJpYnV0ZSgncGxhY2Vob2xkZXInLCBzdHIpO1xuXHRcdH1cblxuXHRcdGlmICh0aXRsZSkge1xuXHRcdFx0c3RyID0gdHJhbnNsYXRlKHRpdGxlLCBkYXRhLCBwbHVyYWxpemUsIGxhbmcpO1xuXHRcdFx0ZWwuc2V0QXR0cmlidXRlKCd0aXRsZScsIHN0cik7XG5cdFx0fVxuXHR9XG5cblx0LyoqXG5cdCAqIFNldHMgdGhlIGkxOG4gbGFuZyBkYXRhLlxuXHQgKlxuXHQgKiBAcGFyYW0gbGFuZyBUaGUgaTE4biBsYW5nIGNvZGVcblx0ICogQHBhcmFtIGRhdGEgVGhlIGkxOG4gbGFuZyBkYXRhLlxuXHQgKi9cblx0c3RhdGljIGxvYWRMYW5nRGF0YShsYW5nOiBzdHJpbmcsIGRhdGE6IHRJMThuRGVmaW5pdGlvbikge1xuXG5cdFx0aWYgKCFVdGlscy5pc1N0cmluZyhsYW5nKSkge1xuXHRcdFx0dGhyb3cgbmV3IFR5cGVFcnJvcihcIltPV2ViSTE4bl0geW91ciBsYW5nIG5hbWUgc2hvdWxkIGJlIGEgdmFsaWQgc3RyaW5nLlwiKTtcblx0XHR9XG5cblx0XHRpZiAoIVV0aWxzLmlzUGxhaW5PYmplY3QoZGF0YSkpIHtcblx0XHRcdHRocm93IG5ldyBUeXBlRXJyb3IoXCJbT1dlYkkxOG5dIHlvdXIgbGFuZyBkYXRhIHNob3VsZCBiZSBhIHZhbGlkIHBsYWluIG9iamVjdC5cIik7XG5cdFx0fVxuXG5cdFx0TEFOR19PQkpFQ1RbIGxhbmcgXSA9IFV0aWxzLmFzc2lnbihMQU5HX09CSkVDVFsgbGFuZyBdIHx8IHt9LCBkYXRhKTtcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG59XG4iXX0=